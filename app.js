const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["memory-CkG79_WJ.js","Simfile-DjFoTeyG.js","assets/Simfile-Bi8zDpmu.css","downloader-Bn5BGIXb.js","FileSystemWritableFileStream-D05uA35V.js","web-streams-ponyfill-BfVhaP7e.js","NodeFileHandler-BDo-fICb.js","Noteskin-CJHqFqNN.js","HoldBody-DwovWILe.js","Noteskin-BEdgk8lC.js","Noteskin-CDGYbrQq.js","AnimatedSprite-DPy_i0lu.js","Noteskin-B-yBWlEi.js","Noteskin-DCgCcrWp.js","Noteskin-DaQM8iCT.js","Noteskin-DX8LI-Fr.js","Noteskin-DJlT-N5N.js","Noteskin-xp7YX-RZ.js","Noteskin-CaUIteaG.js","Noteskin-Cx66M9Hr.js","Noteskin-BFi-3IfC.js","Noteskin-Bxv7npX8.js","Noteskin-CiTbvy-T.js","Noteskin-DwXD4suP.js","Noteskin-DhuklZgS.js"])))=>i.map(i=>d[i]);
import{M as od,a as ld,b as cd,T as xe,C as de,B as Fs,c as B,g as oa,d as vi,O as b,I as be,e as Te,F as fe,f as vt,h as hi,i as Js,j as Oe,k as _t,G as yt,t as Xe,p as Yn,r as he,W as ce,E as ie,l as Ze,D as gi,m as ud,n as Po,A as Mt,o as dd,q as Tn,s as Nc,S as Hc,u as Ro,v as zc,w as ja,x as $t,y as Ti,z as Vc,H as hd,J as xn,K as $a,L as Aa,N as ka,P as ei,Q as Mn,R as si,U as Oo,V as Ni,X as Hi,Y as Jt,Z as ge,_ as ye,$ as me,a0 as fd,a1 as Uc,a2 as Kn,a3 as Is,a4 as cr,a5 as yn,a6 as mi,a7 as xi,a8 as eo,a9 as Xn,aa as pd,ab as Wc,ac as Ia,ad as No,ae as md,af as Fn,ag as Ho,ah as zo,ai as Vo,aj as gd,ak as Gc,al as bd,am as Uo,an as yd,ao as wd,ap as vd,aq as ur,ar as xd}from"./Simfile-DjFoTeyG.js";class Ed extends od{constructor(e=100,t=100,n=10,a=10){super(),this.segWidth=n,this.segHeight=a,this.width=e,this.height=t,this.build()}build(){const e=this.segWidth*this.segHeight,t=[],n=[],a=[],r=this.segWidth-1,s=this.segHeight-1,o=this.width/r,l=this.height/s;for(let f=0;f<e;f++){const c=f%this.segWidth,d=f/this.segWidth|0;t.push(c*o,d*l),n.push(c/r,d/s)}const u=r*s;for(let f=0;f<u;f++){const c=f%r,d=f/r|0,h=d*this.segWidth+c,p=d*this.segWidth+c+1,m=(d+1)*this.segWidth+c,g=(d+1)*this.segWidth+c+1;a.push(h,p,m,p,g,m)}this.buffers[0].data=new Float32Array(t),this.buffers[1].data=new Float32Array(n),this.indexBuffer.data=new Uint16Array(a),this.buffers[0].update(),this.buffers[1].update(),this.indexBuffer.update()}}class Cd extends ld{constructor(e,t,n){const a=new Ed(e.width,e.height,t,n),r=new cd(xe.WHITE);super(a,r),this.texture=e,this.autoResize=!0}textureUpdated(){this._textureID=this.shader.texture._updateID;const e=this.geometry,{width:t,height:n}=this.shader.texture;this.autoResize&&(e.width!==t||e.height!==n)&&(e.width=this.shader.texture.width,e.height=this.shader.texture.height,e.build())}set texture(e){this.shader.texture!==e&&(this.shader.texture=e,this._textureID=-1,e.baseTexture.valid?this.textureUpdated():e.once("update",this.textureUpdated,this))}get texture(){return this.shader.texture}_render(e){this._textureID!==this.shader.texture._updateID&&this.textureUpdated(),super._render(e)}destroy(e){this.shader.texture.off("update",this.textureUpdated,this),super.destroy(e)}}const ha=10;class qc extends Cd{constructor(e,t,n,a,r){super(xe.WHITE,4,4),this._origWidth=e.orig.width,this._origHeight=e.orig.height,this._width=this._origWidth,this._height=this._origHeight,this._leftWidth=t??e.defaultBorders?.left??ha,this._rightWidth=a??e.defaultBorders?.right??ha,this._topHeight=n??e.defaultBorders?.top??ha,this._bottomHeight=r??e.defaultBorders?.bottom??ha,this.texture=e}textureUpdated(){this._textureID=this.shader.texture._updateID,this._refresh()}get vertices(){return this.geometry.getBuffer("aVertexPosition").data}set vertices(e){this.geometry.getBuffer("aVertexPosition").data=e}updateHorizontalVertices(){const e=this.vertices,t=this._getMinScale();e[9]=e[11]=e[13]=e[15]=this._topHeight*t,e[17]=e[19]=e[21]=e[23]=this._height-this._bottomHeight*t,e[25]=e[27]=e[29]=e[31]=this._height}updateVerticalVertices(){const e=this.vertices,t=this._getMinScale();e[2]=e[10]=e[18]=e[26]=this._leftWidth*t,e[4]=e[12]=e[20]=e[28]=this._width-this._rightWidth*t,e[6]=e[14]=e[22]=e[30]=this._width}_getMinScale(){const e=this._leftWidth+this._rightWidth,t=this._width>e?1:this._width/e,n=this._topHeight+this._bottomHeight,a=this._height>n?1:this._height/n;return Math.min(t,a)}get width(){return this._width}set width(e){this._width=e,this._refresh()}get height(){return this._height}set height(e){this._height=e,this._refresh()}get leftWidth(){return this._leftWidth}set leftWidth(e){this._leftWidth=e,this._refresh()}get rightWidth(){return this._rightWidth}set rightWidth(e){this._rightWidth=e,this._refresh()}get topHeight(){return this._topHeight}set topHeight(e){this._topHeight=e,this._refresh()}get bottomHeight(){return this._bottomHeight}set bottomHeight(e){this._bottomHeight=e,this._refresh()}_refresh(){const e=this.texture,t=this.geometry.buffers[1].data;this._origWidth=e.orig.width,this._origHeight=e.orig.height;const n=1/this._origWidth,a=1/this._origHeight;t[0]=t[8]=t[16]=t[24]=0,t[1]=t[3]=t[5]=t[7]=0,t[6]=t[14]=t[22]=t[30]=1,t[25]=t[27]=t[29]=t[31]=1,t[2]=t[10]=t[18]=t[26]=n*this._leftWidth,t[4]=t[12]=t[20]=t[28]=1-n*this._rightWidth,t[9]=t[11]=t[13]=t[15]=a*this._topHeight,t[17]=t[19]=t[21]=t[23]=1-a*this._bottomHeight,this.updateHorizontalVertices(),this.updateVerticalVertices(),this.geometry.buffers[0].update(),this.geometry.buffers[1].update()}}class Ya extends de{constructor(e=1500,t,n=16384,a=!1){super();const r=16384;n>r&&(n=r),this._properties=[!1,!0,!1,!1,!1],this._maxSize=e,this._batchSize=n,this._buffers=null,this._bufferUpdateIDs=[],this._updateID=0,this.interactiveChildren=!1,this.blendMode=Fs.NORMAL,this.autoResize=a,this.roundPixels=!0,this.baseTexture=null,this.setProperties(t),this._tintColor=new B(0),this.tintRgb=new Float32Array(3),this.tint=16777215}setProperties(e){e&&(this._properties[0]="vertices"in e||"scale"in e?!!e.vertices||!!e.scale:this._properties[0],this._properties[1]="position"in e?!!e.position:this._properties[1],this._properties[2]="rotation"in e?!!e.rotation:this._properties[2],this._properties[3]="uvs"in e?!!e.uvs:this._properties[3],this._properties[4]="tint"in e||"alpha"in e?!!e.tint||!!e.alpha:this._properties[4])}updateTransform(){this.displayObjectUpdateTransform()}get tint(){return this._tintColor.value}set tint(e){this._tintColor.setValue(e),this._tintColor.toRgbArray(this.tintRgb)}render(e){!this.visible||this.worldAlpha<=0||!this.children.length||!this.renderable||(this.baseTexture||(this.baseTexture=this.children[0]._texture.baseTexture,this.baseTexture.valid||this.baseTexture.once("update",()=>this.onChildrenChange(0))),e.batch.setObjectRenderer(e.plugins.particle),e.plugins.particle.render(this))}onChildrenChange(e){const t=Math.floor(e/this._batchSize);for(;this._bufferUpdateIDs.length<t;)this._bufferUpdateIDs.push(0);this._bufferUpdateIDs[t]=++this._updateID}dispose(){if(this._buffers){for(let e=0;e<this._buffers.length;++e)this._buffers[e].destroy();this._buffers=null}}destroy(e){super.destroy(e),this.dispose(),this._properties=null,this._buffers=null,this._bufferUpdateIDs=null}}var fa={exports:{}},dr,Wo;function Ka(){if(Wo)return dr;Wo=1;const i="2.0.0",e=256,t=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,a=e-6;return dr={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:a,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:i,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},dr}var hr,Go;function Xa(){if(Go)return hr;Go=1;var i={};return hr=typeof process=="object"&&i&&i.NODE_DEBUG&&/\bsemver\b/i.test(i.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{},hr}var qo;function la(){return qo||(qo=1,function(i,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:a}=Ka(),r=Xa();e=i.exports={};const s=e.re=[],o=e.safeRe=[],l=e.src=[],u=e.t={};let f=0;const c="[a-zA-Z0-9-]",d=[["\\s",1],["\\d",a],[c,n]],h=m=>{for(const[g,y]of d)m=m.split(`${g}*`).join(`${g}{0,${y}}`).split(`${g}+`).join(`${g}{1,${y}}`);return m},p=(m,g,y)=>{const x=h(g),w=f++;r(m,w,g),u[m]=w,l[w]=g,s[w]=new RegExp(g,y?"g":void 0),o[w]=new RegExp(x,y?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${c}*`),p("MAINVERSION",`(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${l[u.NUMERICIDENTIFIER]}|${l[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${l[u.NUMERICIDENTIFIERLOOSE]}|${l[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${l[u.PRERELEASEIDENTIFIER]}(?:\\.${l[u.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${l[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[u.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${c}+`),p("BUILD",`(?:\\+(${l[u.BUILDIDENTIFIER]}(?:\\.${l[u.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${l[u.MAINVERSION]}${l[u.PRERELEASE]}?${l[u.BUILD]}?`),p("FULL",`^${l[u.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${l[u.MAINVERSIONLOOSE]}${l[u.PRERELEASELOOSE]}?${l[u.BUILD]}?`),p("LOOSE",`^${l[u.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${l[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${l[u.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:${l[u.PRERELEASE]})?${l[u.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:${l[u.PRERELEASELOOSE]})?${l[u.BUILD]}?)?)?`),p("XRANGE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),p("COERCE",`${l[u.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",l[u.COERCEPLAIN]+`(?:${l[u.PRERELEASE]})?(?:${l[u.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",l[u.COERCE],!0),p("COERCERTLFULL",l[u.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${l[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",p("TILDE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${l[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",p("CARET",`^${l[u.LONECARET]}${l[u.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${l[u.LONECARET]}${l[u.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${l[u.GTLT]}\\s*(${l[u.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]}|${l[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${l[u.XRANGEPLAIN]})\\s+-\\s+(${l[u.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${l[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[u.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(fa,fa.exports)),fa.exports}var fr,jo;function to(){if(jo)return fr;jo=1;const i=Object.freeze({loose:!0}),e=Object.freeze({});return fr=n=>n?typeof n!="object"?i:n:e,fr}var pr,$o;function jc(){if($o)return pr;$o=1;const i=/^[0-9]+$/,e=(n,a)=>{const r=i.test(n),s=i.test(a);return r&&s&&(n=+n,a=+a),n===a?0:r&&!s?-1:s&&!r?1:n<a?-1:1};return pr={compareIdentifiers:e,rcompareIdentifiers:(n,a)=>e(a,n)},pr}var mr,Yo;function kt(){if(Yo)return mr;Yo=1;const i=Xa(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:t}=Ka(),{safeRe:n,t:a}=la(),r=to(),{compareIdentifiers:s}=jc();class o{constructor(u,f){if(f=r(f),u instanceof o){if(u.loose===!!f.loose&&u.includePrerelease===!!f.includePrerelease)return u;u=u.version}else if(typeof u!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof u}".`);if(u.length>e)throw new TypeError(`version is longer than ${e} characters`);i("SemVer",u,f),this.options=f,this.loose=!!f.loose,this.includePrerelease=!!f.includePrerelease;const c=u.trim().match(f.loose?n[a.LOOSE]:n[a.FULL]);if(!c)throw new TypeError(`Invalid Version: ${u}`);if(this.raw=u,this.major=+c[1],this.minor=+c[2],this.patch=+c[3],this.major>t||this.major<0)throw new TypeError("Invalid major version");if(this.minor>t||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>t||this.patch<0)throw new TypeError("Invalid patch version");c[4]?this.prerelease=c[4].split(".").map(d=>{if(/^[0-9]+$/.test(d)){const h=+d;if(h>=0&&h<t)return h}return d}):this.prerelease=[],this.build=c[5]?c[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(u){if(i("SemVer.compare",this.version,this.options,u),!(u instanceof o)){if(typeof u=="string"&&u===this.version)return 0;u=new o(u,this.options)}return u.version===this.version?0:this.compareMain(u)||this.comparePre(u)}compareMain(u){return u instanceof o||(u=new o(u,this.options)),s(this.major,u.major)||s(this.minor,u.minor)||s(this.patch,u.patch)}comparePre(u){if(u instanceof o||(u=new o(u,this.options)),this.prerelease.length&&!u.prerelease.length)return-1;if(!this.prerelease.length&&u.prerelease.length)return 1;if(!this.prerelease.length&&!u.prerelease.length)return 0;let f=0;do{const c=this.prerelease[f],d=u.prerelease[f];if(i("prerelease compare",f,c,d),c===void 0&&d===void 0)return 0;if(d===void 0)return 1;if(c===void 0)return-1;if(c===d)continue;return s(c,d)}while(++f)}compareBuild(u){u instanceof o||(u=new o(u,this.options));let f=0;do{const c=this.build[f],d=u.build[f];if(i("build compare",f,c,d),c===void 0&&d===void 0)return 0;if(d===void 0)return 1;if(c===void 0)return-1;if(c===d)continue;return s(c,d)}while(++f)}inc(u,f,c){switch(u){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",f,c);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",f,c);break;case"prepatch":this.prerelease.length=0,this.inc("patch",f,c),this.inc("pre",f,c);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",f,c),this.inc("pre",f,c);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const d=Number(c)?1:0;if(!f&&c===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[d];else{let h=this.prerelease.length;for(;--h>=0;)typeof this.prerelease[h]=="number"&&(this.prerelease[h]++,h=-2);if(h===-1){if(f===this.prerelease.join(".")&&c===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(d)}}if(f){let h=[f,d];c===!1&&(h=[f]),s(this.prerelease[0],f)===0?isNaN(this.prerelease[1])&&(this.prerelease=h):this.prerelease=h}break}default:throw new Error(`invalid increment argument: ${u}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return mr=o,mr}var gr,Ko;function kn(){if(Ko)return gr;Ko=1;const i=kt();return gr=(t,n,a=!1)=>{if(t instanceof i)return t;try{return new i(t,n)}catch(r){if(!a)return null;throw r}},gr}var br,Xo;function _d(){if(Xo)return br;Xo=1;const i=kn();return br=(t,n)=>{const a=i(t,n);return a?a.version:null},br}var yr,Zo;function Ad(){if(Zo)return yr;Zo=1;const i=kn();return yr=(t,n)=>{const a=i(t.trim().replace(/^[=v]+/,""),n);return a?a.version:null},yr}var wr,Qo;function kd(){if(Qo)return wr;Qo=1;const i=kt();return wr=(t,n,a,r,s)=>{typeof a=="string"&&(s=r,r=a,a=void 0);try{return new i(t instanceof i?t.version:t,a).inc(n,r,s).version}catch{return null}},wr}var vr,Jo;function Sd(){if(Jo)return vr;Jo=1;const i=kn();return vr=(t,n)=>{const a=i(t,null,!0),r=i(n,null,!0),s=a.compare(r);if(s===0)return null;const o=s>0,l=o?a:r,u=o?r:a,f=!!l.prerelease.length;if(!!u.prerelease.length&&!f)return!u.patch&&!u.minor?"major":l.patch?"patch":l.minor?"minor":"major";const d=f?"pre":"";return a.major!==r.major?d+"major":a.minor!==r.minor?d+"minor":a.patch!==r.patch?d+"patch":"prerelease"},vr}var xr,el;function Td(){if(el)return xr;el=1;const i=kt();return xr=(t,n)=>new i(t,n).major,xr}var Er,tl;function Md(){if(tl)return Er;tl=1;const i=kt();return Er=(t,n)=>new i(t,n).minor,Er}var Cr,il;function Ld(){if(il)return Cr;il=1;const i=kt();return Cr=(t,n)=>new i(t,n).patch,Cr}var _r,nl;function Dd(){if(nl)return _r;nl=1;const i=kn();return _r=(t,n)=>{const a=i(t,n);return a&&a.prerelease.length?a.prerelease:null},_r}var Ar,al;function ni(){if(al)return Ar;al=1;const i=kt();return Ar=(t,n,a)=>new i(t,a).compare(new i(n,a)),Ar}var kr,rl;function Bd(){if(rl)return kr;rl=1;const i=ni();return kr=(t,n,a)=>i(n,t,a),kr}var Sr,sl;function Fd(){if(sl)return Sr;sl=1;const i=ni();return Sr=(t,n)=>i(t,n,!0),Sr}var Tr,ol;function io(){if(ol)return Tr;ol=1;const i=kt();return Tr=(t,n,a)=>{const r=new i(t,a),s=new i(n,a);return r.compare(s)||r.compareBuild(s)},Tr}var Mr,ll;function Id(){if(ll)return Mr;ll=1;const i=io();return Mr=(t,n)=>t.sort((a,r)=>i(a,r,n)),Mr}var Lr,cl;function Pd(){if(cl)return Lr;cl=1;const i=io();return Lr=(t,n)=>t.sort((a,r)=>i(r,a,n)),Lr}var Dr,ul;function Za(){if(ul)return Dr;ul=1;const i=ni();return Dr=(t,n,a)=>i(t,n,a)>0,Dr}var Br,dl;function no(){if(dl)return Br;dl=1;const i=ni();return Br=(t,n,a)=>i(t,n,a)<0,Br}var Fr,hl;function $c(){if(hl)return Fr;hl=1;const i=ni();return Fr=(t,n,a)=>i(t,n,a)===0,Fr}var Ir,fl;function Yc(){if(fl)return Ir;fl=1;const i=ni();return Ir=(t,n,a)=>i(t,n,a)!==0,Ir}var Pr,pl;function ao(){if(pl)return Pr;pl=1;const i=ni();return Pr=(t,n,a)=>i(t,n,a)>=0,Pr}var Rr,ml;function ro(){if(ml)return Rr;ml=1;const i=ni();return Rr=(t,n,a)=>i(t,n,a)<=0,Rr}var Or,gl;function Kc(){if(gl)return Or;gl=1;const i=$c(),e=Yc(),t=Za(),n=ao(),a=no(),r=ro();return Or=(o,l,u,f)=>{switch(l){case"===":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o===u;case"!==":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o!==u;case"":case"=":case"==":return i(o,u,f);case"!=":return e(o,u,f);case">":return t(o,u,f);case">=":return n(o,u,f);case"<":return a(o,u,f);case"<=":return r(o,u,f);default:throw new TypeError(`Invalid operator: ${l}`)}},Or}var Nr,bl;function Rd(){if(bl)return Nr;bl=1;const i=kt(),e=kn(),{safeRe:t,t:n}=la();return Nr=(r,s)=>{if(r instanceof i)return r;if(typeof r=="number"&&(r=String(r)),typeof r!="string")return null;s=s||{};let o=null;if(!s.rtl)o=r.match(s.includePrerelease?t[n.COERCEFULL]:t[n.COERCE]);else{const h=s.includePrerelease?t[n.COERCERTLFULL]:t[n.COERCERTL];let p;for(;(p=h.exec(r))&&(!o||o.index+o[0].length!==r.length);)(!o||p.index+p[0].length!==o.index+o[0].length)&&(o=p),h.lastIndex=p.index+p[1].length+p[2].length;h.lastIndex=-1}if(o===null)return null;const l=o[2],u=o[3]||"0",f=o[4]||"0",c=s.includePrerelease&&o[5]?`-${o[5]}`:"",d=s.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${l}.${u}.${f}${c}${d}`,s)},Nr}var Hr,yl;function Od(){if(yl)return Hr;yl=1;class i{constructor(){this.max=1e3,this.map=new Map}get(t){const n=this.map.get(t);if(n!==void 0)return this.map.delete(t),this.map.set(t,n),n}delete(t){return this.map.delete(t)}set(t,n){if(!this.delete(t)&&n!==void 0){if(this.map.size>=this.max){const r=this.map.keys().next().value;this.delete(r)}this.map.set(t,n)}return this}}return Hr=i,Hr}var zr,wl;function ai(){if(wl)return zr;wl=1;const i=/\s+/g;class e{constructor(S,$){if($=a($),S instanceof e)return S.loose===!!$.loose&&S.includePrerelease===!!$.includePrerelease?S:new e(S.raw,$);if(S instanceof r)return this.raw=S.value,this.set=[[S]],this.formatted=void 0,this;if(this.options=$,this.loose=!!$.loose,this.includePrerelease=!!$.includePrerelease,this.raw=S.trim().replace(i," "),this.set=this.raw.split("||").map(L=>this.parseRange(L.trim())).filter(L=>L.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const L=this.set[0];if(this.set=this.set.filter(G=>!m(G[0])),this.set.length===0)this.set=[L];else if(this.set.length>1){for(const G of this.set)if(G.length===1&&g(G[0])){this.set=[G];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let S=0;S<this.set.length;S++){S>0&&(this.formatted+="||");const $=this.set[S];for(let L=0;L<$.length;L++)L>0&&(this.formatted+=" "),this.formatted+=$[L].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(S){const L=((this.options.includePrerelease&&h)|(this.options.loose&&p))+":"+S,G=n.get(L);if(G)return G;const V=this.options.loose,J=V?l[u.HYPHENRANGELOOSE]:l[u.HYPHENRANGE];S=S.replace(J,M(this.options.includePrerelease)),s("hyphen replace",S),S=S.replace(l[u.COMPARATORTRIM],f),s("comparator trim",S),S=S.replace(l[u.TILDETRIM],c),s("tilde trim",S),S=S.replace(l[u.CARETTRIM],d),s("caret trim",S);let N=S.split(" ").map(ee=>x(ee,this.options)).join(" ").split(/\s+/).map(ee=>re(ee,this.options));V&&(N=N.filter(ee=>(s("loose invalid filter",ee,this.options),!!ee.match(l[u.COMPARATORLOOSE])))),s("range list",N);const P=new Map,ae=N.map(ee=>new r(ee,this.options));for(const ee of ae){if(m(ee))return[ee];P.set(ee.value,ee)}P.size>1&&P.has("")&&P.delete("");const ne=[...P.values()];return n.set(L,ne),ne}intersects(S,$){if(!(S instanceof e))throw new TypeError("a Range is required");return this.set.some(L=>y(L,$)&&S.set.some(G=>y(G,$)&&L.every(V=>G.every(J=>V.intersects(J,$)))))}test(S){if(!S)return!1;if(typeof S=="string")try{S=new o(S,this.options)}catch{return!1}for(let $=0;$<this.set.length;$++)if(R(this.set[$],S,this.options))return!0;return!1}}zr=e;const t=Od(),n=new t,a=to(),r=Qa(),s=Xa(),o=kt(),{safeRe:l,t:u,comparatorTrimReplace:f,tildeTrimReplace:c,caretTrimReplace:d}=la(),{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:p}=Ka(),m=v=>v.value==="<0.0.0-0",g=v=>v.value==="",y=(v,S)=>{let $=!0;const L=v.slice();let G=L.pop();for(;$&&L.length;)$=L.every(V=>G.intersects(V,S)),G=L.pop();return $},x=(v,S)=>(s("comp",v,S),v=F(v,S),s("caret",v),v=C(v,S),s("tildes",v),v=O(v,S),s("xrange",v),v=Y(v,S),s("stars",v),v),w=v=>!v||v.toLowerCase()==="x"||v==="*",C=(v,S)=>v.trim().split(/\s+/).map($=>_($,S)).join(" "),_=(v,S)=>{const $=S.loose?l[u.TILDELOOSE]:l[u.TILDE];return v.replace($,(L,G,V,J,N)=>{s("tilde",v,L,G,V,J,N);let P;return w(G)?P="":w(V)?P=`>=${G}.0.0 <${+G+1}.0.0-0`:w(J)?P=`>=${G}.${V}.0 <${G}.${+V+1}.0-0`:N?(s("replaceTilde pr",N),P=`>=${G}.${V}.${J}-${N} <${G}.${+V+1}.0-0`):P=`>=${G}.${V}.${J} <${G}.${+V+1}.0-0`,s("tilde return",P),P})},F=(v,S)=>v.trim().split(/\s+/).map($=>D($,S)).join(" "),D=(v,S)=>{s("caret",v,S);const $=S.loose?l[u.CARETLOOSE]:l[u.CARET],L=S.includePrerelease?"-0":"";return v.replace($,(G,V,J,N,P)=>{s("caret",v,G,V,J,N,P);let ae;return w(V)?ae="":w(J)?ae=`>=${V}.0.0${L} <${+V+1}.0.0-0`:w(N)?V==="0"?ae=`>=${V}.${J}.0${L} <${V}.${+J+1}.0-0`:ae=`>=${V}.${J}.0${L} <${+V+1}.0.0-0`:P?(s("replaceCaret pr",P),V==="0"?J==="0"?ae=`>=${V}.${J}.${N}-${P} <${V}.${J}.${+N+1}-0`:ae=`>=${V}.${J}.${N}-${P} <${V}.${+J+1}.0-0`:ae=`>=${V}.${J}.${N}-${P} <${+V+1}.0.0-0`):(s("no pr"),V==="0"?J==="0"?ae=`>=${V}.${J}.${N}${L} <${V}.${J}.${+N+1}-0`:ae=`>=${V}.${J}.${N}${L} <${V}.${+J+1}.0-0`:ae=`>=${V}.${J}.${N} <${+V+1}.0.0-0`),s("caret return",ae),ae})},O=(v,S)=>(s("replaceXRanges",v,S),v.split(/\s+/).map($=>H($,S)).join(" ")),H=(v,S)=>{v=v.trim();const $=S.loose?l[u.XRANGELOOSE]:l[u.XRANGE];return v.replace($,(L,G,V,J,N,P)=>{s("xRange",v,L,G,V,J,N,P);const ae=w(V),ne=ae||w(J),ee=ne||w(N),Me=ee;return G==="="&&Me&&(G=""),P=S.includePrerelease?"-0":"",ae?G===">"||G==="<"?L="<0.0.0-0":L="*":G&&Me?(ne&&(J=0),N=0,G===">"?(G=">=",ne?(V=+V+1,J=0,N=0):(J=+J+1,N=0)):G==="<="&&(G="<",ne?V=+V+1:J=+J+1),G==="<"&&(P="-0"),L=`${G+V}.${J}.${N}${P}`):ne?L=`>=${V}.0.0${P} <${+V+1}.0.0-0`:ee&&(L=`>=${V}.${J}.0${P} <${V}.${+J+1}.0-0`),s("xRange return",L),L})},Y=(v,S)=>(s("replaceStars",v,S),v.trim().replace(l[u.STAR],"")),re=(v,S)=>(s("replaceGTE0",v,S),v.trim().replace(l[S.includePrerelease?u.GTE0PRE:u.GTE0],"")),M=v=>(S,$,L,G,V,J,N,P,ae,ne,ee,Me)=>(w(L)?$="":w(G)?$=`>=${L}.0.0${v?"-0":""}`:w(V)?$=`>=${L}.${G}.0${v?"-0":""}`:J?$=`>=${$}`:$=`>=${$}${v?"-0":""}`,w(ae)?P="":w(ne)?P=`<${+ae+1}.0.0-0`:w(ee)?P=`<${ae}.${+ne+1}.0-0`:Me?P=`<=${ae}.${ne}.${ee}-${Me}`:v?P=`<${ae}.${ne}.${+ee+1}-0`:P=`<=${P}`,`${$} ${P}`.trim()),R=(v,S,$)=>{for(let L=0;L<v.length;L++)if(!v[L].test(S))return!1;if(S.prerelease.length&&!$.includePrerelease){for(let L=0;L<v.length;L++)if(s(v[L].semver),v[L].semver!==r.ANY&&v[L].semver.prerelease.length>0){const G=v[L].semver;if(G.major===S.major&&G.minor===S.minor&&G.patch===S.patch)return!0}return!1}return!0};return zr}var Vr,vl;function Qa(){if(vl)return Vr;vl=1;const i=Symbol("SemVer ANY");class e{static get ANY(){return i}constructor(f,c){if(c=t(c),f instanceof e){if(f.loose===!!c.loose)return f;f=f.value}f=f.trim().split(/\s+/).join(" "),s("comparator",f,c),this.options=c,this.loose=!!c.loose,this.parse(f),this.semver===i?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(f){const c=this.options.loose?n[a.COMPARATORLOOSE]:n[a.COMPARATOR],d=f.match(c);if(!d)throw new TypeError(`Invalid comparator: ${f}`);this.operator=d[1]!==void 0?d[1]:"",this.operator==="="&&(this.operator=""),d[2]?this.semver=new o(d[2],this.options.loose):this.semver=i}toString(){return this.value}test(f){if(s("Comparator.test",f,this.options.loose),this.semver===i||f===i)return!0;if(typeof f=="string")try{f=new o(f,this.options)}catch{return!1}return r(f,this.operator,this.semver,this.options)}intersects(f,c){if(!(f instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new l(f.value,c).test(this.value):f.operator===""?f.value===""?!0:new l(this.value,c).test(f.semver):(c=t(c),c.includePrerelease&&(this.value==="<0.0.0-0"||f.value==="<0.0.0-0")||!c.includePrerelease&&(this.value.startsWith("<0.0.0")||f.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&f.operator.startsWith(">")||this.operator.startsWith("<")&&f.operator.startsWith("<")||this.semver.version===f.semver.version&&this.operator.includes("=")&&f.operator.includes("=")||r(this.semver,"<",f.semver,c)&&this.operator.startsWith(">")&&f.operator.startsWith("<")||r(this.semver,">",f.semver,c)&&this.operator.startsWith("<")&&f.operator.startsWith(">")))}}Vr=e;const t=to(),{safeRe:n,t:a}=la(),r=Kc(),s=Xa(),o=kt(),l=ai();return Vr}var Ur,xl;function Ja(){if(xl)return Ur;xl=1;const i=ai();return Ur=(t,n,a)=>{try{n=new i(n,a)}catch{return!1}return n.test(t)},Ur}var Wr,El;function Nd(){if(El)return Wr;El=1;const i=ai();return Wr=(t,n)=>new i(t,n).set.map(a=>a.map(r=>r.value).join(" ").trim().split(" ")),Wr}var Gr,Cl;function Hd(){if(Cl)return Gr;Cl=1;const i=kt(),e=ai();return Gr=(n,a,r)=>{let s=null,o=null,l=null;try{l=new e(a,r)}catch{return null}return n.forEach(u=>{l.test(u)&&(!s||o.compare(u)===-1)&&(s=u,o=new i(s,r))}),s},Gr}var qr,_l;function zd(){if(_l)return qr;_l=1;const i=kt(),e=ai();return qr=(n,a,r)=>{let s=null,o=null,l=null;try{l=new e(a,r)}catch{return null}return n.forEach(u=>{l.test(u)&&(!s||o.compare(u)===1)&&(s=u,o=new i(s,r))}),s},qr}var jr,Al;function Vd(){if(Al)return jr;Al=1;const i=kt(),e=ai(),t=Za();return jr=(a,r)=>{a=new e(a,r);let s=new i("0.0.0");if(a.test(s)||(s=new i("0.0.0-0"),a.test(s)))return s;s=null;for(let o=0;o<a.set.length;++o){const l=a.set[o];let u=null;l.forEach(f=>{const c=new i(f.semver.version);switch(f.operator){case">":c.prerelease.length===0?c.patch++:c.prerelease.push(0),c.raw=c.format();case"":case">=":(!u||t(c,u))&&(u=c);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${f.operator}`)}}),u&&(!s||t(s,u))&&(s=u)}return s&&a.test(s)?s:null},jr}var $r,kl;function Ud(){if(kl)return $r;kl=1;const i=ai();return $r=(t,n)=>{try{return new i(t,n).range||"*"}catch{return null}},$r}var Yr,Sl;function so(){if(Sl)return Yr;Sl=1;const i=kt(),e=Qa(),{ANY:t}=e,n=ai(),a=Ja(),r=Za(),s=no(),o=ro(),l=ao();return Yr=(f,c,d,h)=>{f=new i(f,h),c=new n(c,h);let p,m,g,y,x;switch(d){case">":p=r,m=o,g=s,y=">",x=">=";break;case"<":p=s,m=l,g=r,y="<",x="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(a(f,c,h))return!1;for(let w=0;w<c.set.length;++w){const C=c.set[w];let _=null,F=null;if(C.forEach(D=>{D.semver===t&&(D=new e(">=0.0.0")),_=_||D,F=F||D,p(D.semver,_.semver,h)?_=D:g(D.semver,F.semver,h)&&(F=D)}),_.operator===y||_.operator===x||(!F.operator||F.operator===y)&&m(f,F.semver))return!1;if(F.operator===x&&g(f,F.semver))return!1}return!0},Yr}var Kr,Tl;function Wd(){if(Tl)return Kr;Tl=1;const i=so();return Kr=(t,n,a)=>i(t,n,">",a),Kr}var Xr,Ml;function Gd(){if(Ml)return Xr;Ml=1;const i=so();return Xr=(t,n,a)=>i(t,n,"<",a),Xr}var Zr,Ll;function qd(){if(Ll)return Zr;Ll=1;const i=ai();return Zr=(t,n,a)=>(t=new i(t,a),n=new i(n,a),t.intersects(n,a)),Zr}var Qr,Dl;function jd(){if(Dl)return Qr;Dl=1;const i=Ja(),e=ni();return Qr=(t,n,a)=>{const r=[];let s=null,o=null;const l=t.sort((d,h)=>e(d,h,a));for(const d of l)i(d,n,a)?(o=d,s||(s=d)):(o&&r.push([s,o]),o=null,s=null);s&&r.push([s,null]);const u=[];for(const[d,h]of r)d===h?u.push(d):!h&&d===l[0]?u.push("*"):h?d===l[0]?u.push(`<=${h}`):u.push(`${d} - ${h}`):u.push(`>=${d}`);const f=u.join(" || "),c=typeof n.raw=="string"?n.raw:String(n);return f.length<c.length?f:n},Qr}var Jr,Bl;function $d(){if(Bl)return Jr;Bl=1;const i=ai(),e=Qa(),{ANY:t}=e,n=Ja(),a=ni(),r=(c,d,h={})=>{if(c===d)return!0;c=new i(c,h),d=new i(d,h);let p=!1;e:for(const m of c.set){for(const g of d.set){const y=l(m,g,h);if(p=p||y!==null,y)continue e}if(p)return!1}return!0},s=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],l=(c,d,h)=>{if(c===d)return!0;if(c.length===1&&c[0].semver===t){if(d.length===1&&d[0].semver===t)return!0;h.includePrerelease?c=s:c=o}if(d.length===1&&d[0].semver===t){if(h.includePrerelease)return!0;d=o}const p=new Set;let m,g;for(const O of c)O.operator===">"||O.operator===">="?m=u(m,O,h):O.operator==="<"||O.operator==="<="?g=f(g,O,h):p.add(O.semver);if(p.size>1)return null;let y;if(m&&g){if(y=a(m.semver,g.semver,h),y>0)return null;if(y===0&&(m.operator!==">="||g.operator!=="<="))return null}for(const O of p){if(m&&!n(O,String(m),h)||g&&!n(O,String(g),h))return null;for(const H of d)if(!n(O,String(H),h))return!1;return!0}let x,w,C,_,F=g&&!h.includePrerelease&&g.semver.prerelease.length?g.semver:!1,D=m&&!h.includePrerelease&&m.semver.prerelease.length?m.semver:!1;F&&F.prerelease.length===1&&g.operator==="<"&&F.prerelease[0]===0&&(F=!1);for(const O of d){if(_=_||O.operator===">"||O.operator===">=",C=C||O.operator==="<"||O.operator==="<=",m){if(D&&O.semver.prerelease&&O.semver.prerelease.length&&O.semver.major===D.major&&O.semver.minor===D.minor&&O.semver.patch===D.patch&&(D=!1),O.operator===">"||O.operator===">="){if(x=u(m,O,h),x===O&&x!==m)return!1}else if(m.operator===">="&&!n(m.semver,String(O),h))return!1}if(g){if(F&&O.semver.prerelease&&O.semver.prerelease.length&&O.semver.major===F.major&&O.semver.minor===F.minor&&O.semver.patch===F.patch&&(F=!1),O.operator==="<"||O.operator==="<="){if(w=f(g,O,h),w===O&&w!==g)return!1}else if(g.operator==="<="&&!n(g.semver,String(O),h))return!1}if(!O.operator&&(g||m)&&y!==0)return!1}return!(m&&C&&!g&&y!==0||g&&_&&!m&&y!==0||D||F)},u=(c,d,h)=>{if(!c)return d;const p=a(c.semver,d.semver,h);return p>0?c:p<0||d.operator===">"&&c.operator===">="?d:c},f=(c,d,h)=>{if(!c)return d;const p=a(c.semver,d.semver,h);return p<0?c:p>0||d.operator==="<"&&c.operator==="<="?d:c};return Jr=r,Jr}var es,Fl;function Yd(){if(Fl)return es;Fl=1;const i=la(),e=Ka(),t=kt(),n=jc(),a=kn(),r=_d(),s=Ad(),o=kd(),l=Sd(),u=Td(),f=Md(),c=Ld(),d=Dd(),h=ni(),p=Bd(),m=Fd(),g=io(),y=Id(),x=Pd(),w=Za(),C=no(),_=$c(),F=Yc(),D=ao(),O=ro(),H=Kc(),Y=Rd(),re=Qa(),M=ai(),R=Ja(),v=Nd(),S=Hd(),$=zd(),L=Vd(),G=Ud(),V=so(),J=Wd(),N=Gd(),P=qd(),ae=jd(),ne=$d();return es={parse:a,valid:r,clean:s,inc:o,diff:l,major:u,minor:f,patch:c,prerelease:d,compare:h,rcompare:p,compareLoose:m,compareBuild:g,sort:y,rsort:x,gt:w,lt:C,eq:_,neq:F,gte:D,lte:O,cmp:H,coerce:Y,Comparator:re,Range:M,satisfies:R,toComparators:v,maxSatisfying:S,minSatisfying:$,minVersion:L,validRange:G,outside:V,gtr:J,ltr:N,intersects:P,simplifyRange:ae,subset:ne,SemVer:t,re:i.re,src:i.src,tokens:i.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},es}var Kd=Yd();const Il=oa(Kd),Xd="modulepreload",Zd=function(i){return"/smeditor/"+i},Pl={},We=function(e,t,n){let a=Promise.resolve();if(t&&t.length>0){let s=function(u){return Promise.all(u.map(f=>Promise.resolve(f).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),l=o?.nonce||o?.getAttribute("nonce");a=s(t.map(u=>{if(u=Zd(u),u in Pl)return;Pl[u]=!0;const f=u.endsWith(".css"),c=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${c}`))return;const d=document.createElement("link");if(d.rel=f?"stylesheet":Xd,f||(d.as="script"),d.crossOrigin="",d.href=u,l&&d.setAttribute("nonce",l),document.head.appendChild(d),f)return new Promise((h,p)=>{d.addEventListener("load",h),d.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${u}`)))})}))}function r(s){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=s,window.dispatchEvent(o),!o.defaultPrevented)throw s}return a.then(s=>{for(const o of s||[])o.status==="rejected"&&r(o.reason);return e().catch(r)})};function Qd(i={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:n,onRegistered:a,onRegisteredSW:r,onRegisterError:s}=i;let o,l;const u=async(c=!0)=>{await l};async function f(){if("serviceWorker"in navigator){if(o=await We(async()=>{const{Workbox:c}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:c}},[]).then(({Workbox:c})=>new c("/smeditor/sw.js",{scope:"/smeditor/",type:"classic"})).catch(c=>{s?.(c)}),!o)return;o.addEventListener("activated",c=>{(c.isUpdate||c.isExternal)&&window.location.reload()}),o.addEventListener("installed",c=>{c.isUpdate||n?.()}),o.register({immediate:e}).then(c=>{r?r("/smeditor/sw.js",c):a?.(c)}).catch(c=>{s?.(c)})}}return l=f(),u}var ts={exports:{}},Rl;function Jd(){return Rl||(Rl=1,function(i){(function(){function e(A,I,te){return A.call.apply(A.bind,arguments)}function t(A,I,te){if(!A)throw Error();if(2<arguments.length){var Z=Array.prototype.slice.call(arguments,2);return function(){var se=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(se,Z),A.apply(I,se)}}return function(){return A.apply(I,arguments)}}function n(A,I,te){return n=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?e:t,n.apply(null,arguments)}var a=Date.now||function(){return+new Date};function r(A,I){this.a=A,this.o=I||A,this.c=this.o.document}var s=!!window.FontFace;function o(A,I,te,Z){if(I=A.c.createElement(I),te)for(var se in te)te.hasOwnProperty(se)&&(se=="style"?I.style.cssText=te[se]:I.setAttribute(se,te[se]));return Z&&I.appendChild(A.c.createTextNode(Z)),I}function l(A,I,te){A=A.c.getElementsByTagName(I)[0],A||(A=document.documentElement),A.insertBefore(te,A.lastChild)}function u(A){A.parentNode&&A.parentNode.removeChild(A)}function f(A,I,te){I=I||[],te=te||[];for(var Z=A.className.split(/\s+/),se=0;se<I.length;se+=1){for(var pe=!1,Ee=0;Ee<Z.length;Ee+=1)if(I[se]===Z[Ee]){pe=!0;break}pe||Z.push(I[se])}for(I=[],se=0;se<Z.length;se+=1){for(pe=!1,Ee=0;Ee<te.length;Ee+=1)if(Z[se]===te[Ee]){pe=!0;break}pe||I.push(Z[se])}A.className=I.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function c(A,I){for(var te=A.className.split(/\s+/),Z=0,se=te.length;Z<se;Z++)if(te[Z]==I)return!0;return!1}function d(A){return A.o.location.hostname||A.a.location.hostname}function h(A,I,te){function Z(){Re&&se&&pe&&(Re(Ee),Re=null)}I=o(A,"link",{rel:"stylesheet",href:I,media:"all"});var se=!1,pe=!0,Ee=null,Re=te||null;s?(I.onload=function(){se=!0,Z()},I.onerror=function(){se=!0,Ee=Error("Stylesheet failed to load"),Z()}):setTimeout(function(){se=!0,Z()},0),l(A,"head",I)}function p(A,I,te,Z){var se=A.c.getElementsByTagName("head")[0];if(se){var pe=o(A,"script",{src:I}),Ee=!1;return pe.onload=pe.onreadystatechange=function(){Ee||this.readyState&&this.readyState!="loaded"&&this.readyState!="complete"||(Ee=!0,te&&te(null),pe.onload=pe.onreadystatechange=null,pe.parentNode.tagName=="HEAD"&&se.removeChild(pe))},se.appendChild(pe),setTimeout(function(){Ee||(Ee=!0,te&&te(Error("Script load timeout")))},Z||5e3),pe}return null}function m(){this.a=0,this.c=null}function g(A){return A.a++,function(){A.a--,x(A)}}function y(A,I){A.c=I,x(A)}function x(A){A.a==0&&A.c&&(A.c(),A.c=null)}function w(A){this.a=A||"-"}w.prototype.c=function(A){for(var I=[],te=0;te<arguments.length;te++)I.push(arguments[te].replace(/[\W_]+/g,"").toLowerCase());return I.join(this.a)};function C(A,I){this.c=A,this.f=4,this.a="n";var te=(I||"n4").match(/^([nio])([1-9])$/i);te&&(this.a=te[1],this.f=parseInt(te[2],10))}function _(A){return O(A)+" "+(A.f+"00")+" 300px "+F(A.c)}function F(A){var I=[];A=A.split(/,\s*/);for(var te=0;te<A.length;te++){var Z=A[te].replace(/['"]/g,"");Z.indexOf(" ")!=-1||/^\d/.test(Z)?I.push("'"+Z+"'"):I.push(Z)}return I.join(",")}function D(A){return A.a+A.f}function O(A){var I="normal";return A.a==="o"?I="oblique":A.a==="i"&&(I="italic"),I}function H(A){var I=4,te="n",Z=null;return A&&((Z=A.match(/(normal|oblique|italic)/i))&&Z[1]&&(te=Z[1].substr(0,1).toLowerCase()),(Z=A.match(/([1-9]00|normal|bold)/i))&&Z[1]&&(/bold/i.test(Z[1])?I=7:/[1-9]00/.test(Z[1])&&(I=parseInt(Z[1].substr(0,1),10)))),te+I}function Y(A,I){this.c=A,this.f=A.o.document.documentElement,this.h=I,this.a=new w("-"),this.j=I.events!==!1,this.g=I.classes!==!1}function re(A){A.g&&f(A.f,[A.a.c("wf","loading")]),R(A,"loading")}function M(A){if(A.g){var I=c(A.f,A.a.c("wf","active")),te=[],Z=[A.a.c("wf","loading")];I||te.push(A.a.c("wf","inactive")),f(A.f,te,Z)}R(A,"inactive")}function R(A,I,te){A.j&&A.h[I]&&(te?A.h[I](te.c,D(te)):A.h[I]())}function v(){this.c={}}function S(A,I,te){var Z=[],se;for(se in I)if(I.hasOwnProperty(se)){var pe=A.c[se];pe&&Z.push(pe(I[se],te))}return Z}function $(A,I){this.c=A,this.f=I,this.a=o(this.c,"span",{"aria-hidden":"true"},this.f)}function L(A){l(A.c,"body",A.a)}function G(A){return"display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+F(A.c)+";"+("font-style:"+O(A)+";font-weight:"+(A.f+"00")+";")}function V(A,I,te,Z,se,pe){this.g=A,this.j=I,this.a=Z,this.c=te,this.f=se||3e3,this.h=pe||void 0}V.prototype.start=function(){var A=this.c.o.document,I=this,te=a(),Z=new Promise(function(Ee,Re){function He(){a()-te>=I.f?Re():A.fonts.load(_(I.a),I.h).then(function(Je){1<=Je.length?Ee():setTimeout(He,25)},function(){Re()})}He()}),se=null,pe=new Promise(function(Ee,Re){se=setTimeout(Re,I.f)});Promise.race([pe,Z]).then(function(){se&&(clearTimeout(se),se=null),I.g(I.a)},function(){I.j(I.a)})};function J(A,I,te,Z,se,pe,Ee){this.v=A,this.B=I,this.c=te,this.a=Z,this.s=Ee||"BESbswy",this.f={},this.w=se||3e3,this.u=pe||null,this.m=this.j=this.h=this.g=null,this.g=new $(this.c,this.s),this.h=new $(this.c,this.s),this.j=new $(this.c,this.s),this.m=new $(this.c,this.s),A=new C(this.a.c+",serif",D(this.a)),A=G(A),this.g.a.style.cssText=A,A=new C(this.a.c+",sans-serif",D(this.a)),A=G(A),this.h.a.style.cssText=A,A=new C("serif",D(this.a)),A=G(A),this.j.a.style.cssText=A,A=new C("sans-serif",D(this.a)),A=G(A),this.m.a.style.cssText=A,L(this.g),L(this.h),L(this.j),L(this.m)}var N={D:"serif",C:"sans-serif"},P=null;function ae(){if(P===null){var A=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);P=!!A&&(536>parseInt(A[1],10)||parseInt(A[1],10)===536&&11>=parseInt(A[2],10))}return P}J.prototype.start=function(){this.f.serif=this.j.a.offsetWidth,this.f["sans-serif"]=this.m.a.offsetWidth,this.A=a(),ee(this)};function ne(A,I,te){for(var Z in N)if(N.hasOwnProperty(Z)&&I===A.f[N[Z]]&&te===A.f[N[Z]])return!0;return!1}function ee(A){var I=A.g.a.offsetWidth,te=A.h.a.offsetWidth,Z;(Z=I===A.f.serif&&te===A.f["sans-serif"])||(Z=ae()&&ne(A,I,te)),Z?a()-A.A>=A.w?ae()&&ne(A,I,te)&&(A.u===null||A.u.hasOwnProperty(A.a.c))?Ne(A,A.v):Ne(A,A.B):Me(A):Ne(A,A.v)}function Me(A){setTimeout(n(function(){ee(this)},A),50)}function Ne(A,I){setTimeout(n(function(){u(this.g.a),u(this.h.a),u(this.j.a),u(this.m.a),I(this.a)},A),0)}function _e(A,I,te){this.c=A,this.a=I,this.f=0,this.m=this.j=!1,this.s=te}var ve=null;_e.prototype.g=function(A){var I=this.a;I.g&&f(I.f,[I.a.c("wf",A.c,D(A).toString(),"active")],[I.a.c("wf",A.c,D(A).toString(),"loading"),I.a.c("wf",A.c,D(A).toString(),"inactive")]),R(I,"fontactive",A),this.m=!0,Le(this)},_e.prototype.h=function(A){var I=this.a;if(I.g){var te=c(I.f,I.a.c("wf",A.c,D(A).toString(),"active")),Z=[],se=[I.a.c("wf",A.c,D(A).toString(),"loading")];te||Z.push(I.a.c("wf",A.c,D(A).toString(),"inactive")),f(I.f,Z,se)}R(I,"fontinactive",A),Le(this)};function Le(A){--A.f==0&&A.j&&(A.m?(A=A.a,A.g&&f(A.f,[A.a.c("wf","active")],[A.a.c("wf","loading"),A.a.c("wf","inactive")]),R(A,"active")):M(A.a))}function Be(A){this.j=A,this.a=new v,this.h=0,this.f=this.g=!0}Be.prototype.load=function(A){this.c=new r(this.j,A.context||this.j),this.g=A.events!==!1,this.f=A.classes!==!1,ot(this,new Y(this.c,A),A)};function st(A,I,te,Z,se){var pe=--A.h==0;(A.f||A.g)&&setTimeout(function(){var Ee=se||null,Re=Z||null||{};if(te.length===0&&pe)M(I.a);else{I.f+=te.length,pe&&(I.j=pe);var He,Je=[];for(He=0;He<te.length;He++){var qe=te[He],ut=Re[qe.c],Zt=I.a,rn=qe;if(Zt.g&&f(Zt.f,[Zt.a.c("wf",rn.c,D(rn).toString(),"loading")]),R(Zt,"fontloading",rn),Zt=null,ve===null)if(window.FontFace){var rn=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),sd=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);ve=rn?42<parseInt(rn[1],10):!sd}else ve=!1;ve?Zt=new V(n(I.g,I),n(I.h,I),I.c,qe,I.s,ut):Zt=new J(n(I.g,I),n(I.h,I),I.c,qe,I.s,Ee,ut),Je.push(Zt)}for(He=0;He<Je.length;He++)Je[He].start()}},0)}function ot(A,I,te){var se=[],Z=te.timeout;re(I);var se=S(A.a,te,A.c),pe=new _e(A.c,I,Z);for(A.h=se.length,I=0,te=se.length;I<te;I++)se[I].load(function(Ee,Re,He){st(A,pe,Ee,Re,He)})}function E(A,I){this.c=A,this.a=I}E.prototype.load=function(A){function I(){if(pe["__mti_fntLst"+Z]){var Ee=pe["__mti_fntLst"+Z](),Re=[],He;if(Ee)for(var Je=0;Je<Ee.length;Je++){var qe=Ee[Je].fontfamily;Ee[Je].fontStyle!=null&&Ee[Je].fontWeight!=null?(He=Ee[Je].fontStyle+Ee[Je].fontWeight,Re.push(new C(qe,He))):Re.push(new C(qe))}A(Re)}else setTimeout(function(){I()},50)}var te=this,Z=te.a.projectId,se=te.a.version;if(Z){var pe=te.c.o;p(this.c,(te.a.api||"https://fast.fonts.net/jsapi")+"/"+Z+".js"+(se?"?v="+se:""),function(Ee){Ee?A([]):(pe["__MonotypeConfiguration__"+Z]=function(){return te.a},I())}).id="__MonotypeAPIScript__"+Z}else A([])};function X(A,I){this.c=A,this.a=I}X.prototype.load=function(A){var I,te,Z=this.a.urls||[],se=this.a.families||[],pe=this.a.testStrings||{},Ee=new m;for(I=0,te=Z.length;I<te;I++)h(this.c,Z[I],g(Ee));var Re=[];for(I=0,te=se.length;I<te;I++)if(Z=se[I].split(":"),Z[1])for(var He=Z[1].split(","),Je=0;Je<He.length;Je+=1)Re.push(new C(Z[0],He[Je]));else Re.push(new C(Z[0]));y(Ee,function(){A(Re,pe)})};function q(A,I){A?this.c=A:this.c=T,this.a=[],this.f=[],this.g=I||""}var T="https://fonts.googleapis.com/css";function k(A,I){for(var te=I.length,Z=0;Z<te;Z++){var se=I[Z].split(":");se.length==3&&A.f.push(se.pop());var pe="";se.length==2&&se[1]!=""&&(pe=":"),A.a.push(se.join(pe))}}function z(A){if(A.a.length==0)throw Error("No fonts to load!");if(A.c.indexOf("kit=")!=-1)return A.c;for(var I=A.a.length,te=[],Z=0;Z<I;Z++)te.push(A.a[Z].replace(/ /g,"+"));return I=A.c+"?family="+te.join("%7C"),0<A.f.length&&(I+="&subset="+A.f.join(",")),0<A.g.length&&(I+="&text="+encodeURIComponent(A.g)),I}function j(A){this.f=A,this.a=[],this.c={}}var Q={latin:"BESbswy","latin-ext":"çöüğş",cyrillic:"йяЖ",greek:"αβΣ",khmer:"កខគ",Hanuman:"កខគ"},U={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},oe={i:"i",italic:"i",n:"n",normal:"n"},ue=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;function le(A){for(var I=A.f.length,te=0;te<I;te++){var Z=A.f[te].split(":"),se=Z[0].replace(/\+/g," "),pe=["n4"];if(2<=Z.length){var Ee,Re=Z[1];if(Ee=[],Re)for(var Re=Re.split(","),He=Re.length,Je=0;Je<He;Je++){var qe;if(qe=Re[Je],qe.match(/^[\w-]+$/)){var ut=ue.exec(qe.toLowerCase());if(ut==null)qe="";else{if(qe=ut[2],qe=qe==null||qe==""?"n":oe[qe],ut=ut[1],ut==null||ut=="")ut="4";else var Zt=U[ut],ut=Zt||(isNaN(ut)?"4":ut.substr(0,1));qe=[qe,ut].join("")}}else qe="";qe&&Ee.push(qe)}0<Ee.length&&(pe=Ee),Z.length==3&&(Z=Z[2],Ee=[],Z=Z?Z.split(","):Ee,0<Z.length&&(Z=Q[Z[0]])&&(A.c[se]=Z))}for(A.c[se]||(Z=Q[se])&&(A.c[se]=Z),Z=0;Z<pe.length;Z+=1)A.a.push(new C(se,pe[Z]))}}function we(A,I){this.c=A,this.a=I}var Ge={Arimo:!0,Cousine:!0,Tinos:!0};we.prototype.load=function(A){var I=new m,te=this.c,Z=new q(this.a.api,this.a.text),se=this.a.families;k(Z,se);var pe=new j(se);le(pe),h(te,z(Z),g(I)),y(I,function(){A(pe.a,pe.c,Ge)})};function De(A,I){this.c=A,this.a=I}De.prototype.load=function(A){var I=this.a.id,te=this.c.o;I?p(this.c,(this.a.api||"https://use.typekit.net")+"/"+I+".js",function(Z){if(Z)A([]);else if(te.Typekit&&te.Typekit.config&&te.Typekit.config.fn){Z=te.Typekit.config.fn;for(var se=[],pe=0;pe<Z.length;pe+=2)for(var Ee=Z[pe],Re=Z[pe+1],He=0;He<Re.length;He++)se.push(new C(Ee,Re[He]));try{te.Typekit.load({events:!1,classes:!1,async:!0})}catch{}A(se)}},2e3):A([])};function Ct(A,I){this.c=A,this.f=I,this.a=[]}Ct.prototype.load=function(A){var I=this.f.id,te=this.c.o,Z=this;I?(te.__webfontfontdeckmodule__||(te.__webfontfontdeckmodule__={}),te.__webfontfontdeckmodule__[I]=function(se,pe){for(var Ee=0,Re=pe.fonts.length;Ee<Re;++Ee){var He=pe.fonts[Ee];Z.a.push(new C(He.name,H("font-weight:"+He.weight+";font-style:"+He.style)))}A(Z.a)},p(this.c,(this.f.api||"https://f.fontdeck.com/s/css/js/")+d(this.c)+"/"+I+".js",function(se){se&&A([])})):A([])};var St=new Be(window);St.a.c.custom=function(A,I){return new X(I,A)},St.a.c.fontdeck=function(A,I){return new Ct(I,A)},St.a.c.monotype=function(A,I){return new E(I,A)},St.a.c.typekit=function(A,I){return new De(I,A)},St.a.c.google=function(A,I){return new we(I,A)};var Dt={load:n(St.load,St)};i.exports?i.exports=Dt:(window.WebFont=Dt,window.WebFontConfig&&St.load(window.WebFontConfig))})()}(ts)),ts.exports}var eh=Jd();const th=oa(eh),mn={INVALID:["seeking position failed.","InvalidStateError"],GONE:["A requested file or directory could not be found at the time an operation was processed.","NotFoundError"],MISMATCH:["The path supplied exists, but was not an entry of requested type.","TypeMismatchError"],MOD_ERR:["The object can not be modified in this way.","InvalidModificationError"],SYNTAX:i=>[`Failed to execute 'write' on 'UnderlyingSinkBase': Invalid params passed. ${i}`,"SyntaxError"],DISALLOWED:["The request is not allowed by the user agent or the platform in the current context.","NotAllowedError"]},ih=i=>typeof i=="object"&&typeof i.type<"u";async function nh(i){var e,t,n;const{FolderHandle:a,FileHandle:r}=await We(async()=>{const{FolderHandle:u,FileHandle:f}=await import("./memory-CkG79_WJ.js");return{FolderHandle:u,FileHandle:f}},__vite__mapDeps([0,1,2])),{FileSystemDirectoryHandle:s}=await We(async()=>{const{FileSystemDirectoryHandle:u}=await Promise.resolve().then(()=>X0);return{FileSystemDirectoryHandle:u}},void 0),o=(t=(e=i[0].webkitRelativePath)===null||e===void 0?void 0:e.split("/",1)[0])!==null&&t!==void 0?t:"",l=new a(o,!1);for(let u=0;u<i.length;u++){const f=i[u],c=!((n=f.webkitRelativePath)===null||n===void 0)&&n.length?f.webkitRelativePath.split("/"):["",f.name];c.shift();const d=c.pop(),h=c.reduce((p,m)=>(p._entries[m]||(p._entries[m]=new a(m,!1)),p._entries[m]),l);h._entries[d]=new r(f.name,f,!1)}return new s(l)}async function ah(i){const{FileHandle:e}=await We(async()=>{const{FileHandle:a}=await import("./memory-CkG79_WJ.js");return{FileHandle:a}},__vite__mapDeps([0,1,2])),{FileSystemFileHandle:t}=await We(async()=>{const{FileSystemFileHandle:a}=await Promise.resolve().then(()=>Wu);return{FileSystemFileHandle:a}},void 0);return Array.from(i).map(a=>new t(new e(a.name,a,!1)))}const Xc=Object.freeze(Object.defineProperty({__proto__:null,errors:mn,isChunkObject:ih,makeDirHandleFromFileList:nh,makeFileHandlesFromFileList:ah},Symbol.toStringTag,{value:"Module"}));var is={};/*! howler.js v2.2.4 | (c) 2013-2020, James Simpson of GoldFire Studios | MIT License | howlerjs.com */var Ol;function rh(){return Ol||(Ol=1,function(i){(function(){var e=function(){this.init()};e.prototype={init:function(){var c=this||t;return c._counter=1e3,c._html5AudioPool=[],c.html5PoolSize=10,c._codecs={},c._howls=[],c._muted=!1,c._volume=1,c._canPlayEvent="canplaythrough",c._navigator=typeof window<"u"&&window.navigator?window.navigator:null,c.masterGain=null,c.noAudio=!1,c.usingWebAudio=!0,c.autoSuspend=!0,c.ctx=null,c.autoUnlock=!0,c._setup(),c},volume:function(c){var d=this||t;if(c=parseFloat(c),d.ctx||f(),c!==void 0&&c>=0&&c<=1){if(d._volume=c,d._muted)return d;d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c,t.ctx.currentTime);for(var h=0;h<d._howls.length;h++)if(!d._howls[h]._webAudio)for(var p=d._howls[h]._getSoundIds(),m=0;m<p.length;m++){var g=d._howls[h]._soundById(p[m]);g&&g._node&&(g._node.volume=g._volume*c)}return d}return d._volume},mute:function(c){var d=this||t;d.ctx||f(),d._muted=c,d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c?0:d._volume,t.ctx.currentTime);for(var h=0;h<d._howls.length;h++)if(!d._howls[h]._webAudio)for(var p=d._howls[h]._getSoundIds(),m=0;m<p.length;m++){var g=d._howls[h]._soundById(p[m]);g&&g._node&&(g._node.muted=!!c||g._muted)}return d},stop:function(){for(var c=this||t,d=0;d<c._howls.length;d++)c._howls[d].stop();return c},unload:function(){for(var c=this||t,d=c._howls.length-1;d>=0;d--)c._howls[d].unload();return c.usingWebAudio&&c.ctx&&c.ctx.close!==void 0&&(c.ctx.close(),c.ctx=null,f()),c},codecs:function(c){return(this||t)._codecs[c.replace(/^x-/,"")]},_setup:function(){var c=this||t;if(c.state=c.ctx&&c.ctx.state||"suspended",c._autoSuspend(),!c.usingWebAudio)if(typeof Audio<"u")try{var d=new Audio;d.oncanplaythrough===void 0&&(c._canPlayEvent="canplay")}catch{c.noAudio=!0}else c.noAudio=!0;try{var d=new Audio;d.muted&&(c.noAudio=!0)}catch{}return c.noAudio||c._setupCodecs(),c},_setupCodecs:function(){var c=this||t,d=null;try{d=typeof Audio<"u"?new Audio:null}catch{return c}if(!d||typeof d.canPlayType!="function")return c;var h=d.canPlayType("audio/mpeg;").replace(/^no$/,""),p=c._navigator?c._navigator.userAgent:"",m=p.match(/OPR\/(\d+)/g),g=m&&parseInt(m[0].split("/")[1],10)<33,y=p.indexOf("Safari")!==-1&&p.indexOf("Chrome")===-1,x=p.match(/Version\/(.*?) /),w=y&&x&&parseInt(x[1],10)<15;return c._codecs={mp3:!(g||!h&&!d.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!h,opus:!!d.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(d.canPlayType('audio/wav; codecs="1"')||d.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!d.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!d.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(d.canPlayType("audio/x-m4a;")||d.canPlayType("audio/m4a;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(d.canPlayType("audio/x-m4b;")||d.canPlayType("audio/m4b;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(d.canPlayType("audio/x-mp4;")||d.canPlayType("audio/mp4;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!(w||!d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!(w||!d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!d.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(d.canPlayType("audio/x-flac;")||d.canPlayType("audio/flac;")).replace(/^no$/,"")},c},_unlockAudio:function(){var c=this||t;if(!c._audioUnlocked&&c.ctx){c._audioUnlocked=!1,c.autoUnlock=!1,c._mobileUnloaded||c.ctx.sampleRate===44100||(c._mobileUnloaded=!0,c.unload()),c._scratchBuffer=c.ctx.createBuffer(1,1,22050);var d=function(h){for(;c._html5AudioPool.length<c.html5PoolSize;)try{var p=new Audio;p._unlocked=!0,c._releaseHtml5Audio(p)}catch{c.noAudio=!0;break}for(var m=0;m<c._howls.length;m++)if(!c._howls[m]._webAudio)for(var g=c._howls[m]._getSoundIds(),y=0;y<g.length;y++){var x=c._howls[m]._soundById(g[y]);x&&x._node&&!x._node._unlocked&&(x._node._unlocked=!0,x._node.load())}c._autoResume();var w=c.ctx.createBufferSource();w.buffer=c._scratchBuffer,w.connect(c.ctx.destination),w.start===void 0?w.noteOn(0):w.start(0),typeof c.ctx.resume=="function"&&c.ctx.resume(),w.onended=function(){w.disconnect(0),c._audioUnlocked=!0,document.removeEventListener("touchstart",d,!0),document.removeEventListener("touchend",d,!0),document.removeEventListener("click",d,!0),document.removeEventListener("keydown",d,!0);for(var C=0;C<c._howls.length;C++)c._howls[C]._emit("unlock")}};return document.addEventListener("touchstart",d,!0),document.addEventListener("touchend",d,!0),document.addEventListener("click",d,!0),document.addEventListener("keydown",d,!0),c}},_obtainHtml5Audio:function(){var c=this||t;if(c._html5AudioPool.length)return c._html5AudioPool.pop();var d=new Audio().play();return d&&typeof Promise<"u"&&(d instanceof Promise||typeof d.then=="function")&&d.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(c){var d=this||t;return c._unlocked&&d._html5AudioPool.push(c),d},_autoSuspend:function(){var c=this;if(c.autoSuspend&&c.ctx&&c.ctx.suspend!==void 0&&t.usingWebAudio){for(var d=0;d<c._howls.length;d++)if(c._howls[d]._webAudio){for(var h=0;h<c._howls[d]._sounds.length;h++)if(!c._howls[d]._sounds[h]._paused)return c}return c._suspendTimer&&clearTimeout(c._suspendTimer),c._suspendTimer=setTimeout(function(){if(c.autoSuspend){c._suspendTimer=null,c.state="suspending";var p=function(){c.state="suspended",c._resumeAfterSuspend&&(delete c._resumeAfterSuspend,c._autoResume())};c.ctx.suspend().then(p,p)}},3e4),c}},_autoResume:function(){var c=this;if(c.ctx&&c.ctx.resume!==void 0&&t.usingWebAudio)return c.state==="running"&&c.ctx.state!=="interrupted"&&c._suspendTimer?(clearTimeout(c._suspendTimer),c._suspendTimer=null):c.state==="suspended"||c.state==="running"&&c.ctx.state==="interrupted"?(c.ctx.resume().then(function(){c.state="running";for(var d=0;d<c._howls.length;d++)c._howls[d]._emit("resume")}),c._suspendTimer&&(clearTimeout(c._suspendTimer),c._suspendTimer=null)):c.state==="suspending"&&(c._resumeAfterSuspend=!0),c}};var t=new e,n=function(c){var d=this;if(!c.src||c.src.length===0)return void console.error("An array of source files must be passed with any new Howl.");d.init(c)};n.prototype={init:function(c){var d=this;return t.ctx||f(),d._autoplay=c.autoplay||!1,d._format=typeof c.format!="string"?c.format:[c.format],d._html5=c.html5||!1,d._muted=c.mute||!1,d._loop=c.loop||!1,d._pool=c.pool||5,d._preload=typeof c.preload!="boolean"&&c.preload!=="metadata"||c.preload,d._rate=c.rate||1,d._sprite=c.sprite||{},d._src=typeof c.src!="string"?c.src:[c.src],d._volume=c.volume!==void 0?c.volume:1,d._xhr={method:c.xhr&&c.xhr.method?c.xhr.method:"GET",headers:c.xhr&&c.xhr.headers?c.xhr.headers:null,withCredentials:!(!c.xhr||!c.xhr.withCredentials)&&c.xhr.withCredentials},d._duration=0,d._state="unloaded",d._sounds=[],d._endTimers={},d._queue=[],d._playLock=!1,d._onend=c.onend?[{fn:c.onend}]:[],d._onfade=c.onfade?[{fn:c.onfade}]:[],d._onload=c.onload?[{fn:c.onload}]:[],d._onloaderror=c.onloaderror?[{fn:c.onloaderror}]:[],d._onplayerror=c.onplayerror?[{fn:c.onplayerror}]:[],d._onpause=c.onpause?[{fn:c.onpause}]:[],d._onplay=c.onplay?[{fn:c.onplay}]:[],d._onstop=c.onstop?[{fn:c.onstop}]:[],d._onmute=c.onmute?[{fn:c.onmute}]:[],d._onvolume=c.onvolume?[{fn:c.onvolume}]:[],d._onrate=c.onrate?[{fn:c.onrate}]:[],d._onseek=c.onseek?[{fn:c.onseek}]:[],d._onunlock=c.onunlock?[{fn:c.onunlock}]:[],d._onresume=[],d._webAudio=t.usingWebAudio&&!d._html5,t.ctx!==void 0&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(d),d._autoplay&&d._queue.push({event:"play",action:function(){d.play()}}),d._preload&&d._preload!=="none"&&d.load(),d},load:function(){var c=this,d=null;if(t.noAudio)return void c._emit("loaderror",null,"No audio support.");typeof c._src=="string"&&(c._src=[c._src]);for(var h=0;h<c._src.length;h++){var p,m;if(c._format&&c._format[h])p=c._format[h];else{if(typeof(m=c._src[h])!="string"){c._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}p=/^data:audio\/([^;,]+);/i.exec(m),p||(p=/\.([^.]+)$/.exec(m.split("?",1)[0])),p&&(p=p[1].toLowerCase())}if(p||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),p&&t.codecs(p)){d=c._src[h];break}}return d?(c._src=d,c._state="loading",window.location.protocol==="https:"&&d.slice(0,5)==="http:"&&(c._html5=!0,c._webAudio=!1),new a(c),c._webAudio&&s(c),c):void c._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(c,d){var h=this,p=null;if(typeof c=="number")p=c,c=null;else{if(typeof c=="string"&&h._state==="loaded"&&!h._sprite[c])return null;if(c===void 0&&(c="__default",!h._playLock)){for(var m=0,g=0;g<h._sounds.length;g++)h._sounds[g]._paused&&!h._sounds[g]._ended&&(m++,p=h._sounds[g]._id);m===1?c=null:p=null}}var y=p?h._soundById(p):h._inactiveSound();if(!y)return null;if(p&&!c&&(c=y._sprite||"__default"),h._state!=="loaded"){y._sprite=c,y._ended=!1;var x=y._id;return h._queue.push({event:"play",action:function(){h.play(x)}}),x}if(p&&!y._paused)return d||h._loadQueue("play"),y._id;h._webAudio&&t._autoResume();var w=Math.max(0,y._seek>0?y._seek:h._sprite[c][0]/1e3),C=Math.max(0,(h._sprite[c][0]+h._sprite[c][1])/1e3-w),_=1e3*C/Math.abs(y._rate),F=h._sprite[c][0]/1e3,D=(h._sprite[c][0]+h._sprite[c][1])/1e3;y._sprite=c,y._ended=!1;var O=function(){y._paused=!1,y._seek=w,y._start=F,y._stop=D,y._loop=!(!y._loop&&!h._sprite[c][2])};if(w>=D)return void h._ended(y);var H=y._node;if(h._webAudio){var Y=function(){h._playLock=!1,O(),h._refreshBuffer(y);var v=y._muted||h._muted?0:y._volume;H.gain.setValueAtTime(v,t.ctx.currentTime),y._playStart=t.ctx.currentTime,H.bufferSource.start===void 0?y._loop?H.bufferSource.noteGrainOn(0,w,86400):H.bufferSource.noteGrainOn(0,w,C):y._loop?H.bufferSource.start(0,w,86400):H.bufferSource.start(0,w,C),_!==1/0&&(h._endTimers[y._id]=setTimeout(h._ended.bind(h,y),_)),d||setTimeout(function(){h._emit("play",y._id),h._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?Y():(h._playLock=!0,h.once("resume",Y),h._clearTimer(y._id))}else{var re=function(){H.currentTime=w,H.muted=y._muted||h._muted||t._muted||H.muted,H.volume=y._volume*t.volume(),H.playbackRate=y._rate;try{var v=H.play();if(v&&typeof Promise<"u"&&(v instanceof Promise||typeof v.then=="function")?(h._playLock=!0,O(),v.then(function(){h._playLock=!1,H._unlocked=!0,d?h._loadQueue():h._emit("play",y._id)}).catch(function(){h._playLock=!1,h._emit("playerror",y._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),y._ended=!0,y._paused=!0})):d||(h._playLock=!1,O(),h._emit("play",y._id)),H.playbackRate=y._rate,H.paused)return void h._emit("playerror",y._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");c!=="__default"||y._loop?h._endTimers[y._id]=setTimeout(h._ended.bind(h,y),_):(h._endTimers[y._id]=function(){h._ended(y),H.removeEventListener("ended",h._endTimers[y._id],!1)},H.addEventListener("ended",h._endTimers[y._id],!1))}catch(S){h._emit("playerror",y._id,S)}};H.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(H.src=h._src,H.load());var M=window&&window.ejecta||!H.readyState&&t._navigator.isCocoonJS;if(H.readyState>=3||M)re();else{h._playLock=!0,h._state="loading";var R=function(){h._state="loaded",re(),H.removeEventListener(t._canPlayEvent,R,!1)};H.addEventListener(t._canPlayEvent,R,!1),h._clearTimer(y._id)}}return y._id},pause:function(c){var d=this;if(d._state!=="loaded"||d._playLock)return d._queue.push({event:"pause",action:function(){d.pause(c)}}),d;for(var h=d._getSoundIds(c),p=0;p<h.length;p++){d._clearTimer(h[p]);var m=d._soundById(h[p]);if(m&&!m._paused&&(m._seek=d.seek(h[p]),m._rateSeek=0,m._paused=!0,d._stopFade(h[p]),m._node))if(d._webAudio){if(!m._node.bufferSource)continue;m._node.bufferSource.stop===void 0?m._node.bufferSource.noteOff(0):m._node.bufferSource.stop(0),d._cleanBuffer(m._node)}else isNaN(m._node.duration)&&m._node.duration!==1/0||m._node.pause();arguments[1]||d._emit("pause",m?m._id:null)}return d},stop:function(c,d){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"stop",action:function(){h.stop(c)}}),h;for(var p=h._getSoundIds(c),m=0;m<p.length;m++){h._clearTimer(p[m]);var g=h._soundById(p[m]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,h._stopFade(p[m]),g._node&&(h._webAudio?g._node.bufferSource&&(g._node.bufferSource.stop===void 0?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),h._cleanBuffer(g._node)):isNaN(g._node.duration)&&g._node.duration!==1/0||(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&h._clearSound(g._node))),d||h._emit("stop",g._id))}return h},mute:function(c,d){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"mute",action:function(){h.mute(c,d)}}),h;if(d===void 0){if(typeof c!="boolean")return h._muted;h._muted=c}for(var p=h._getSoundIds(d),m=0;m<p.length;m++){var g=h._soundById(p[m]);g&&(g._muted=c,g._interval&&h._stopFade(g._id),h._webAudio&&g._node?g._node.gain.setValueAtTime(c?0:g._volume,t.ctx.currentTime):g._node&&(g._node.muted=!!t._muted||c),h._emit("mute",g._id))}return h},volume:function(){var c,d,h=this,p=arguments;if(p.length===0)return h._volume;p.length===1||p.length===2&&p[1]===void 0?h._getSoundIds().indexOf(p[0])>=0?d=parseInt(p[0],10):c=parseFloat(p[0]):p.length>=2&&(c=parseFloat(p[0]),d=parseInt(p[1],10));var m;if(!(c!==void 0&&c>=0&&c<=1))return m=d?h._soundById(d):h._sounds[0],m?m._volume:0;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"volume",action:function(){h.volume.apply(h,p)}}),h;d===void 0&&(h._volume=c),d=h._getSoundIds(d);for(var g=0;g<d.length;g++)(m=h._soundById(d[g]))&&(m._volume=c,p[2]||h._stopFade(d[g]),h._webAudio&&m._node&&!m._muted?m._node.gain.setValueAtTime(c,t.ctx.currentTime):m._node&&!m._muted&&(m._node.volume=c*t.volume()),h._emit("volume",m._id));return h},fade:function(c,d,h,p){var m=this;if(m._state!=="loaded"||m._playLock)return m._queue.push({event:"fade",action:function(){m.fade(c,d,h,p)}}),m;c=Math.min(Math.max(0,parseFloat(c)),1),d=Math.min(Math.max(0,parseFloat(d)),1),h=parseFloat(h),m.volume(c,p);for(var g=m._getSoundIds(p),y=0;y<g.length;y++){var x=m._soundById(g[y]);if(x){if(p||m._stopFade(g[y]),m._webAudio&&!x._muted){var w=t.ctx.currentTime,C=w+h/1e3;x._volume=c,x._node.gain.setValueAtTime(c,w),x._node.gain.linearRampToValueAtTime(d,C)}m._startFadeInterval(x,c,d,h,g[y],p===void 0)}}return m},_startFadeInterval:function(c,d,h,p,m,g){var y=this,x=d,w=h-d,C=Math.abs(w/.01),_=Math.max(4,C>0?p/C:p),F=Date.now();c._fadeTo=h,c._interval=setInterval(function(){var D=(Date.now()-F)/p;F=Date.now(),x+=w*D,x=Math.round(100*x)/100,x=w<0?Math.max(h,x):Math.min(h,x),y._webAudio?c._volume=x:y.volume(x,c._id,!0),g&&(y._volume=x),(h<d&&x<=h||h>d&&x>=h)&&(clearInterval(c._interval),c._interval=null,c._fadeTo=null,y.volume(h,c._id),y._emit("fade",c._id))},_)},_stopFade:function(c){var d=this,h=d._soundById(c);return h&&h._interval&&(d._webAudio&&h._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(h._interval),h._interval=null,d.volume(h._fadeTo,c),h._fadeTo=null,d._emit("fade",c)),d},loop:function(){var c,d,h,p=this,m=arguments;if(m.length===0)return p._loop;if(m.length===1){if(typeof m[0]!="boolean")return!!(h=p._soundById(parseInt(m[0],10)))&&h._loop;c=m[0],p._loop=c}else m.length===2&&(c=m[0],d=parseInt(m[1],10));for(var g=p._getSoundIds(d),y=0;y<g.length;y++)(h=p._soundById(g[y]))&&(h._loop=c,p._webAudio&&h._node&&h._node.bufferSource&&(h._node.bufferSource.loop=c,c&&(h._node.bufferSource.loopStart=h._start||0,h._node.bufferSource.loopEnd=h._stop,p.playing(g[y])&&(p.pause(g[y],!0),p.play(g[y],!0)))));return p},rate:function(){var c,d,h=this,p=arguments;if(p.length===0)d=h._sounds[0]._id;else if(p.length===1){var m=h._getSoundIds(),g=m.indexOf(p[0]);g>=0?d=parseInt(p[0],10):c=parseFloat(p[0])}else p.length===2&&(c=parseFloat(p[0]),d=parseInt(p[1],10));var y;if(typeof c!="number")return y=h._soundById(d),y?y._rate:h._rate;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"rate",action:function(){h.rate.apply(h,p)}}),h;d===void 0&&(h._rate=c),d=h._getSoundIds(d);for(var x=0;x<d.length;x++)if(y=h._soundById(d[x])){h.playing(d[x])&&(y._rateSeek=h.seek(d[x]),y._playStart=h._webAudio?t.ctx.currentTime:y._playStart),y._rate=c,h._webAudio&&y._node&&y._node.bufferSource?y._node.bufferSource.playbackRate.setValueAtTime(c,t.ctx.currentTime):y._node&&(y._node.playbackRate=c);var w=h.seek(d[x]),C=(h._sprite[y._sprite][0]+h._sprite[y._sprite][1])/1e3-w,_=1e3*C/Math.abs(y._rate);!h._endTimers[d[x]]&&y._paused||(h._clearTimer(d[x]),h._endTimers[d[x]]=setTimeout(h._ended.bind(h,y),_)),h._emit("rate",y._id)}return h},seek:function(){var c,d,h=this,p=arguments;if(p.length===0)h._sounds.length&&(d=h._sounds[0]._id);else if(p.length===1){var m=h._getSoundIds(),g=m.indexOf(p[0]);g>=0?d=parseInt(p[0],10):h._sounds.length&&(d=h._sounds[0]._id,c=parseFloat(p[0]))}else p.length===2&&(c=parseFloat(p[0]),d=parseInt(p[1],10));if(d===void 0)return 0;if(typeof c=="number"&&(h._state!=="loaded"||h._playLock))return h._queue.push({event:"seek",action:function(){h.seek.apply(h,p)}}),h;var y=h._soundById(d);if(y){if(!(typeof c=="number"&&c>=0)){if(h._webAudio){var x=h.playing(d)?t.ctx.currentTime-y._playStart:0,w=y._rateSeek?y._rateSeek-y._seek:0;return y._seek+(w+x*Math.abs(y._rate))}return y._node.currentTime}var C=h.playing(d);C&&h.pause(d,!0),y._seek=c,y._ended=!1,h._clearTimer(d),h._webAudio||!y._node||isNaN(y._node.duration)||(y._node.currentTime=c);var _=function(){C&&h.play(d,!0),h._emit("seek",d)};if(C&&!h._webAudio){var F=function(){h._playLock?setTimeout(F,0):_()};setTimeout(F,0)}else _()}return h},playing:function(c){var d=this;if(typeof c=="number"){var h=d._soundById(c);return!!h&&!h._paused}for(var p=0;p<d._sounds.length;p++)if(!d._sounds[p]._paused)return!0;return!1},duration:function(c){var d=this,h=d._duration,p=d._soundById(c);return p&&(h=d._sprite[p._sprite][1]/1e3),h},state:function(){return this._state},unload:function(){for(var c=this,d=c._sounds,h=0;h<d.length;h++)d[h]._paused||c.stop(d[h]._id),c._webAudio||(c._clearSound(d[h]._node),d[h]._node.removeEventListener("error",d[h]._errorFn,!1),d[h]._node.removeEventListener(t._canPlayEvent,d[h]._loadFn,!1),d[h]._node.removeEventListener("ended",d[h]._endFn,!1),t._releaseHtml5Audio(d[h]._node)),delete d[h]._node,c._clearTimer(d[h]._id);var p=t._howls.indexOf(c);p>=0&&t._howls.splice(p,1);var m=!0;for(h=0;h<t._howls.length;h++)if(t._howls[h]._src===c._src||c._src.indexOf(t._howls[h]._src)>=0){m=!1;break}return r&&m&&delete r[c._src],t.noAudio=!1,c._state="unloaded",c._sounds=[],c=null,null},on:function(c,d,h,p){var m=this,g=m["_on"+c];return typeof d=="function"&&g.push(p?{id:h,fn:d,once:p}:{id:h,fn:d}),m},off:function(c,d,h){var p=this,m=p["_on"+c],g=0;if(typeof d=="number"&&(h=d,d=null),d||h)for(g=0;g<m.length;g++){var y=h===m[g].id;if(d===m[g].fn&&y||!d&&y){m.splice(g,1);break}}else if(c)p["_on"+c]=[];else{var x=Object.keys(p);for(g=0;g<x.length;g++)x[g].indexOf("_on")===0&&Array.isArray(p[x[g]])&&(p[x[g]]=[])}return p},once:function(c,d,h){var p=this;return p.on(c,d,h,1),p},_emit:function(c,d,h){for(var p=this,m=p["_on"+c],g=m.length-1;g>=0;g--)m[g].id&&m[g].id!==d&&c!=="load"||(setTimeout(function(y){y.call(this,d,h)}.bind(p,m[g].fn),0),m[g].once&&p.off(c,m[g].fn,m[g].id));return p._loadQueue(c),p},_loadQueue:function(c){var d=this;if(d._queue.length>0){var h=d._queue[0];h.event===c&&(d._queue.shift(),d._loadQueue()),c||h.action()}return d},_ended:function(c){var d=this,h=c._sprite;if(!d._webAudio&&c._node&&!c._node.paused&&!c._node.ended&&c._node.currentTime<c._stop)return setTimeout(d._ended.bind(d,c),100),d;var p=!(!c._loop&&!d._sprite[h][2]);if(d._emit("end",c._id),!d._webAudio&&p&&d.stop(c._id,!0).play(c._id),d._webAudio&&p){d._emit("play",c._id),c._seek=c._start||0,c._rateSeek=0,c._playStart=t.ctx.currentTime;var m=1e3*(c._stop-c._start)/Math.abs(c._rate);d._endTimers[c._id]=setTimeout(d._ended.bind(d,c),m)}return d._webAudio&&!p&&(c._paused=!0,c._ended=!0,c._seek=c._start||0,c._rateSeek=0,d._clearTimer(c._id),d._cleanBuffer(c._node),t._autoSuspend()),d._webAudio||p||d.stop(c._id,!0),d},_clearTimer:function(c){var d=this;if(d._endTimers[c]){if(typeof d._endTimers[c]!="function")clearTimeout(d._endTimers[c]);else{var h=d._soundById(c);h&&h._node&&h._node.removeEventListener("ended",d._endTimers[c],!1)}delete d._endTimers[c]}return d},_soundById:function(c){for(var d=this,h=0;h<d._sounds.length;h++)if(c===d._sounds[h]._id)return d._sounds[h];return null},_inactiveSound:function(){var c=this;c._drain();for(var d=0;d<c._sounds.length;d++)if(c._sounds[d]._ended)return c._sounds[d].reset();return new a(c)},_drain:function(){var c=this,d=c._pool,h=0,p=0;if(!(c._sounds.length<d)){for(p=0;p<c._sounds.length;p++)c._sounds[p]._ended&&h++;for(p=c._sounds.length-1;p>=0;p--){if(h<=d)return;c._sounds[p]._ended&&(c._webAudio&&c._sounds[p]._node&&c._sounds[p]._node.disconnect(0),c._sounds.splice(p,1),h--)}}},_getSoundIds:function(c){var d=this;if(c===void 0){for(var h=[],p=0;p<d._sounds.length;p++)h.push(d._sounds[p]._id);return h}return[c]},_refreshBuffer:function(c){var d=this;return c._node.bufferSource=t.ctx.createBufferSource(),c._node.bufferSource.buffer=r[d._src],c._panner?c._node.bufferSource.connect(c._panner):c._node.bufferSource.connect(c._node),c._node.bufferSource.loop=c._loop,c._loop&&(c._node.bufferSource.loopStart=c._start||0,c._node.bufferSource.loopEnd=c._stop||0),c._node.bufferSource.playbackRate.setValueAtTime(c._rate,t.ctx.currentTime),d},_cleanBuffer:function(c){var d=this,h=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!c.bufferSource)return d;if(t._scratchBuffer&&c.bufferSource&&(c.bufferSource.onended=null,c.bufferSource.disconnect(0),h))try{c.bufferSource.buffer=t._scratchBuffer}catch{}return c.bufferSource=null,d},_clearSound:function(c){/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent)||(c.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var a=function(c){this._parent=c,this.init()};a.prototype={init:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++t._counter,d._sounds.push(c),c.create(),c},create:function(){var c=this,d=c._parent,h=t._muted||c._muted||c._parent._muted?0:c._volume;return d._webAudio?(c._node=t.ctx.createGain===void 0?t.ctx.createGainNode():t.ctx.createGain(),c._node.gain.setValueAtTime(h,t.ctx.currentTime),c._node.paused=!0,c._node.connect(t.masterGain)):t.noAudio||(c._node=t._obtainHtml5Audio(),c._errorFn=c._errorListener.bind(c),c._node.addEventListener("error",c._errorFn,!1),c._loadFn=c._loadListener.bind(c),c._node.addEventListener(t._canPlayEvent,c._loadFn,!1),c._endFn=c._endListener.bind(c),c._node.addEventListener("ended",c._endFn,!1),c._node.src=d._src,c._node.preload=d._preload===!0?"auto":d._preload,c._node.volume=h*t.volume(),c._node.load()),c},reset:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._rateSeek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++t._counter,c},_errorListener:function(){var c=this;c._parent._emit("loaderror",c._id,c._node.error?c._node.error.code:0),c._node.removeEventListener("error",c._errorFn,!1)},_loadListener:function(){var c=this,d=c._parent;d._duration=Math.ceil(10*c._node.duration)/10,Object.keys(d._sprite).length===0&&(d._sprite={__default:[0,1e3*d._duration]}),d._state!=="loaded"&&(d._state="loaded",d._emit("load"),d._loadQueue()),c._node.removeEventListener(t._canPlayEvent,c._loadFn,!1)},_endListener:function(){var c=this,d=c._parent;d._duration===1/0&&(d._duration=Math.ceil(10*c._node.duration)/10,d._sprite.__default[1]===1/0&&(d._sprite.__default[1]=1e3*d._duration),d._ended(c)),c._node.removeEventListener("ended",c._endFn,!1)}};var r={},s=function(c){var d=c._src;if(r[d])return c._duration=r[d].duration,void u(c);if(/^data:[^;]+;base64,/.test(d)){for(var h=atob(d.split(",")[1]),p=new Uint8Array(h.length),m=0;m<h.length;++m)p[m]=h.charCodeAt(m);l(p.buffer,c)}else{var g=new XMLHttpRequest;g.open(c._xhr.method,d,!0),g.withCredentials=c._xhr.withCredentials,g.responseType="arraybuffer",c._xhr.headers&&Object.keys(c._xhr.headers).forEach(function(y){g.setRequestHeader(y,c._xhr.headers[y])}),g.onload=function(){var y=(g.status+"")[0];if(y!=="0"&&y!=="2"&&y!=="3")return void c._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");l(g.response,c)},g.onerror=function(){c._webAudio&&(c._html5=!0,c._webAudio=!1,c._sounds=[],delete r[d],c.load())},o(g)}},o=function(c){try{c.send()}catch{c.onerror()}},l=function(c,d){var h=function(){d._emit("loaderror",null,"Decoding audio data failed.")},p=function(m){m&&d._sounds.length>0?(r[d._src]=m,u(d,m)):h()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(c).then(p).catch(h):t.ctx.decodeAudioData(c,p,h)},u=function(c,d){d&&!c._duration&&(c._duration=d.duration),Object.keys(c._sprite).length===0&&(c._sprite={__default:[0,1e3*c._duration]}),c._state!=="loaded"&&(c._state="loaded",c._emit("load"),c._loadQueue())},f=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var c=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),d=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),h=d?parseInt(d[1],10):null;if(c&&h&&h<9){var p=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!p&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=t.ctx.createGain===void 0?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};i.Howler=t,i.Howl=n,typeof vi<"u"?(vi.HowlerGlobal=e,vi.Howler=t,vi.Howl=n,vi.Sound=a):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=n,window.Sound=a)})()}(is)),is}var Ps=rh();const sh="data:audio/wav;base64,UklGRkYEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAATElTVBoAAABJTkZPSVNGVA0AAABMYXZmNjAuMy4xMDAAAGRhdGEABAAAAIDfjHvG/eK+8VP5Bvyg/v3+Dv8O/1v+8P59B0sXqgoxBa4BQgEEAIMATAAyAE4AnwA8APf/oH+tf3J/6F74LWgXiQpfBbABbAGy/+b/4f+X/w+AAIAKjAzF7uIk8Ln4efsB/jf+Of66/kv+Ev84/6sBbf+eAMn/IADgACQA3gBXABMBrP9/ACIAvgraEnAIfwVbAdYCxf5zAVr/iQBb/6cAMP9KAKtP4H9VaPUyfhjgC0EFigNcAL4AqP/qABoA5wAc/T7yE/iK/CX94v+A/a3+4P7n/eX+cv0b/w7/v/4AgGK2Qdso7ub2vfsQ/ef96/6b/u//+/1UANb9sIAAgJq/3N4+8MX37PtP/fD+Hf5S/zf+c/80/f3DWsiL5Cby0fm5/OT9IQAG/y0A1P6S/1z/jP//f/9/un+oY5kwqheUC5oFXAGAAFv/WwDN/xQBRf9mgACAWoT+weri4/BI+aH7Xv+l/Zr/Nf3k/xT9/3/1ff9/OkPbIUEPXQiVBN4AiQDT//YA0/8JAA2AAICvgIWfetA55xX0Mfmz/Az+w/5H/4r+Zf8r/015Q1d6KlgVZwkkBqUBigHH/q4A6/7WACL/qgBtHDFPaCbnE/sIigQNAloBpf8qALn/aP9vAMj+mABm5FLnpvMc+iz99f51/wH/zP4c/wcAjf+X/zD/+CAbf51Znio6FNwI5AS5AdUAnf8g/93/yv6lAJH/R4AAgDetL9ZL7LH1VPum/Lr+JP+Y/5z+0v4b/pP+AdF63vruUPj4+7r9nP6Y/Qz/Bv5Q/3P+jf+i/ln8K+1/9y769f1I/RQAxP4RABT+5/8x/mH/ff6k//hB7n/0U6opvRPDCUkEOgF5ASD/PwBI/4cAsP9iAEgHfg1JBb4DCwGVAJz/iQCX/30Awf8LAND/HADc/xLy0+8l+K/7/v06/+b+Bf/W/sH+x/7U/tv+k/4A/yoVChNQCeEDSgLoAEEABQA9ABUABADR/xUAx/8WAHvQ7dWg6v/1wfpZ/eb9OP/6/h7/7f76/sz+zf7X/tkgHR0mDiMHGwP+AC4A9v8xAAoAQgDi/ywA9v9aABMAIAGa/+b/+v8TALT/5v8gAPT/8f8OAC4ANAAFAA3pyuQE8+D5Rf3y/Rr/5f7H/rP+g/7t/q7+Iv/Q/oAALQB9AAcAJQAJAPv/2v/O/yAAWgAbAFkBSAP+ATMCCgIGAY0AKwAzADEAMABIABMAHAC4/17/x/4J//T+Uv9b/6b/wP/Y//D/3v8QAPz/7v8GAEAAFQA4ACoAEwAIAAIABwD9//L/CAADAAkADgAWABMAGwAPAA0ACwAQAAgABQAJAAoAAwD///b/9f/y/+n/9//2//f//f/9/w==",Zc="/smeditor/assets/metronome_high-C7Kf-JE0.wav",Qc="/smeditor/assets/metronome_low-BSgffp0_.wav",oh="/smeditor/assets/mine-Dy-Y9L9c.wav",er=[".aac",".mid",".midi",".mp3",".oga",".ogg",".opus",".wav",".webm",".weba",".flac",".aiff"],qi=[".bmp",".gif",".jpeg",".jpg",".png",".tif",".tiff",".webp"];class ct{windowManager;minimizeElement;closeElement;closed=!1;options;windowElement;viewElement;constructor(e){this.options=e;const t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div");t.appendChild(a),t.appendChild(n),t.style.width=e.width/16+"rem",t.style.left=window.innerWidth/2-e.width/2*b.general.uiScale+"px",e.height&&(t.style.top=window.innerHeight/2-e.height/2*b.general.uiScale+"px"),t.classList.add("window"),e.win_id&&(t.dataset.win_id=e.win_id),n.classList.add("view"),e.height&&(n.style.height=e.height/16+"rem"),n.style.width=e.width/16+"rem",a.classList.add("navbar"),e.title!==""&&a.appendChild(r);const s=be.getIcon("MINIMIZE",15),o=be.getIcon("CLOSE_WINDOW",15);s.classList.add("unselectable"),s.draggable=!1,s.onclick=()=>{n.style.height!="0px"?n.style.height="0px":n.style.height=e.height+"px",this.clampPosition()},o.classList.add("unselectable"),o.draggable=!1,o.onclick=()=>this.closeWindow(),a.appendChild(s),a.appendChild(o),this.minimizeElement=s,this.closeElement=o,e.disableClose&&(s.style.display="none",o.style.display="none"),r.innerText=e.title,r.classList.add("title"),t.addEventListener("mousedown",()=>this.focus()),e.blocking&&(window.addEventListener("mousedown",this.block,!0),document.getElementById("blocker").style.display="block",t.dataset.blocking="block"),r.addEventListener("mousedown",()=>{window.addEventListener("mousemove",this.handleDrag),window.addEventListener("mouseup",()=>window.removeEventListener("mousemove",this.handleDrag))}),this.focus(),t.classList.add("focused"),this.windowElement=t,this.viewElement=n}addToManager(e){this.windowManager=e,e.view.appendChild(this.windowElement),this.focus()}onClose(){}closeWindow(){this.windowManager&&(this.closed=!0,this.onClose(),this.windowManager.removeWindow(this),this.windowElement.classList.add("exiting"),window.removeEventListener("mousedown",this.block,!0),this.options.blocking&&this.windowManager.windows.filter(e=>e.options.blocking).length==0&&(document.getElementById("blocker").style.display="none"),setTimeout(()=>this.windowManager.view.removeChild(this.windowElement),40))}focus(){if(this.windowManager==null)return;this.windowManager.unfocusAll(),this.windowElement.classList.add("focused");const e=Array.from(this.windowManager.view.children).map(t=>t).filter(t=>t!=this.windowElement);e.sort((t,n)=>parseInt(t.style.zIndex)-parseInt(n.style.zIndex)),e.push(this.windowElement);for(let t=0;t<e.length;t++)e[t].style.zIndex=((e[t].dataset.blocking?10001:0)+t).toString()}unfocus(){this.windowManager!=null&&this.windowElement.classList.remove("focused")}center(){const e=this.windowElement.getBoundingClientRect();this.windowElement.style.left=window.innerWidth/2-e.width/2*b.general.uiScale+"px",this.windowElement.style.top=window.innerHeight/2-e.height/2*b.general.uiScale+"px",this.clampPosition()}block=e=>{!e.target||this.windowElement.contains(e.target)||(e.stopImmediatePropagation(),e.preventDefault())};handleDrag=e=>{const t=parseInt(this.windowElement.style.left.slice(0,-2))+e.movementX,n=parseInt(this.windowElement.style.top.slice(0,-2))+e.movementY;this.windowElement.style.left=t+"px",this.windowElement.style.top=n+"px",this.clampPosition()};clampPosition(){if(this.windowManager==null)return;const e=parseInt(this.windowElement.style.left.slice(0,-2)),t=parseInt(this.windowElement.style.top.slice(0,-2)),n=this.windowManager.app.view.getBoundingClientRect();this.windowElement.style.left=Te(e,n.left,n.width-this.windowElement.clientWidth+n.left)+"px",this.windowElement.style.top=Te(t,n.top,n.height-this.windowElement.clientHeight+n.top)+"px"}move(e,t){this.windowElement.style.left=e+"px",this.windowElement.style.top=t+"px"}setDisableClose(e){e?(this.minimizeElement.style.display="none",this.closeElement.style.display="none"):(this.minimizeElement.style.display="",this.closeElement.style.display="")}setBlocking(e){e?(this.windowElement.dataset.blocking="block",document.getElementById("blocker").style.display="block",window.addEventListener("mousedown",this.block,!0)):(this.windowElement.dataset.blocking="",document.getElementById("blocker").style.display="none",window.removeEventListener("mousedown",this.block,!0)),this.focus()}}class lh extends ct{app;constructor(e){super({title:"About",width:300,height:170,win_id:"about"}),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("about-container");const n=document.createElement("div");n.classList.add("logo-container");const a=document.createElement("img");a.src="/smeditor/assets/icon/logo.png";const r=document.createElement("div");r.innerText="SMEditor";const s=document.createElement("div");s.style.textAlign="center",s.innerText="Open source online web tool to view and edit StepMania charts (.sm/.ssc files). Maintained by tillvit";const o=document.createElement("div");if(o.style.fontSize="0.875rem",o.style.color="var(--text-color-secondary)",o.innerText=`Core v${window.app.VERSION}`,window.nw){const l=nw.require("nw.gui");o.innerText+=` | App v${l.App.manifest.version}`}t.appendChild(n),n.appendChild(a),n.appendChild(r),t.appendChild(s),t.appendChild(o),e.appendChild(t),this.viewElement.appendChild(e)}}const Nl={videoHeight:{label:"Video Height",input:{type:"dropdown",items:["360p","480p","720p","1080p"],advanced:!0,transformers:{serialize:i=>`${i}p`,deserialize:i=>parseInt(i.slice(0,-1))}}},fps:{label:"FPS",input:{type:"dropdown",items:[24,30,60],advanced:!1}},bitrate:{label:"Bitrate",input:{type:"display-slider",transformers:{serialize:i=>Math.log(i),deserialize:i=>Math.round(Math.exp(i)/1e3)*1e3,display:i=>Math.round(Math.exp(i)/1e3)+" kbps"},min:Math.log(1e6),max:Math.log(2e7),step:1e-5,displayWidth:80,width:80}},aspectRatio:{label:"Aspect Ratio",input:{type:"dropdown",items:["4 / 3","16 / 9","16 / 10"],advanced:!0,transformers:{serialize:i=>{const e={"4 / 3":1.3333333333333333,"16 / 9":1.7777777777777777,"16 / 10":1.6};return Object.keys(e).find(t=>{if(Math.abs(e[t]-i)<1e-4)return!0})},deserialize:i=>({"4 / 3":1.3333333333333333,"16 / 9":1.7777777777777777,"16 / 10":1.6})[i]}}}},ch={hideBarlines:{label:"Hide edit GUI",input:{type:"checkbox"}},playbackRate:{label:"Playback Rate",input:{type:"number",min:10,max:300,step:10,precision:3,minPrecision:0,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},assistTick:{label:"Assist Tick",input:{type:"checkbox"}},metronome:{label:"Metronome",input:{type:"checkbox"}}};var oo=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)},K=(i,e,t)=>(oo(i,e,"read from private field"),t?t.call(i):e.get(i)),Ie=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},wt=(i,e,t,n)=>(oo(i,e,"write to private field"),e.set(i,t),t),tt=(i,e,t)=>(oo(i,e,"access private method"),t),Ve=new Uint8Array(8),Ci=new DataView(Ve.buffer),Gt=i=>[(i%256+256)%256],Ye=i=>(Ci.setUint16(0,i,!1),[Ve[0],Ve[1]]),uh=i=>(Ci.setInt16(0,i,!1),[Ve[0],Ve[1]]),Jc=i=>(Ci.setUint32(0,i,!1),[Ve[1],Ve[2],Ve[3]]),ke=i=>(Ci.setUint32(0,i,!1),[Ve[0],Ve[1],Ve[2],Ve[3]]),dh=i=>(Ci.setUint32(0,Math.floor(i/2**32),!1),Ci.setUint32(4,i,!1),[Ve[0],Ve[1],Ve[2],Ve[3],Ve[4],Ve[5],Ve[6],Ve[7]]),lo=i=>(Ci.setInt16(0,2**8*i,!1),[Ve[0],Ve[1]]),di=i=>(Ci.setInt32(0,2**16*i,!1),[Ve[0],Ve[1],Ve[2],Ve[3]]),ns=i=>(Ci.setInt32(0,2**30*i,!1),[Ve[0],Ve[1],Ve[2],Ve[3]]),ui=(i,e=!1)=>{let t=Array(i.length).fill(null).map((n,a)=>i.charCodeAt(a));return e&&t.push(0),t},tn=i=>i&&i[i.length-1],Zn=(i,e,t=!0)=>{let n=i*e;return t?Math.round(n):n},eu=i=>{let e=i*(Math.PI/180),t=Math.cos(e),n=Math.sin(e);return[t,n,0,-n,t,0,0,0,1]},hh=eu(0),tu=i=>[di(i[0]),di(i[1]),ns(i[2]),di(i[3]),di(i[4]),ns(i[5]),di(i[6]),di(i[7]),ns(i[8])],zn=i=>!i||typeof i!="object"?i:Array.isArray(i)?i.map(zn):Object.fromEntries(Object.entries(i).map(([e,t])=>[e,zn(t)])),xt=(i,e,t)=>({type:i,contents:e&&new Uint8Array(e.flat(10)),children:t}),Et=(i,e,t,n,a)=>xt(i,[Gt(e),Jc(t),n??[]],a),fh=i=>i?xt("ftyp",[ui("isom"),ke(0),ui("iso4"),ui("hvc1")]):xt("ftyp",[ui("isom"),ke(0),ui("isom"),ui("avc1"),ui("mp41")]),Hl=i=>({type:"mdat",largeSize:i}),ph=i=>({type:"free",size:i}),as=(i,e)=>xt("moov",null,[mh(e,i),...i.map(t=>gh(t,e))]),mh=(i,e)=>{let t=Zn(Math.max(0,...e.filter(a=>a.samples.length>0).map(a=>tn(a.samples).timestamp+tn(a.samples).duration)),Ns),n=Math.max(...e.map(a=>a.id))+1;return Et("mvhd",0,0,[ke(i),ke(i),ke(Ns),ke(t),di(1),lo(1),Array(10).fill(0),tu(hh),Array(24).fill(0),ke(n)])},gh=(i,e)=>xt("trak",null,[bh(i,e),yh(i,e)]),bh=(i,e)=>{let t=tn(i.samples),n=Zn(t?t.timestamp+t.duration:0,Ns);return Et("tkhd",0,3,[ke(e),ke(e),ke(i.id),ke(0),ke(n),Array(8).fill(0),Ye(0),Ye(0),lo(i.info.type==="audio"?1:0),Ye(0),tu(eu(i.info.type==="video"?i.info.rotation:0)),di(i.info.type==="video"?i.info.width:0),di(i.info.type==="video"?i.info.height:0)])},yh=(i,e)=>xt("mdia",null,[wh(i,e),vh(i.info.type==="video"?"vide":"soun"),xh(i)]),wh=(i,e)=>{let t=tn(i.samples),n=Zn(t?t.timestamp+t.duration:0,i.timescale);return Et("mdhd",0,0,[ke(e),ke(e),ke(i.timescale),ke(n),Ye(21956),Ye(0)])},vh=i=>Et("hdlr",0,0,[ui("mhlr"),ui(i),ke(0),ke(0),ke(0),ui("mp4-muxer-hdlr")]),xh=i=>xt("minf",null,[i.info.type==="video"?Eh():Ch(),_h(),Sh(i)]),Eh=()=>Et("vmhd",0,1,[Ye(0),Ye(0),Ye(0),Ye(0)]),Ch=()=>Et("smhd",0,0,[Ye(0),Ye(0)]),_h=()=>xt("dinf",null,[Ah()]),Ah=()=>Et("dref",0,0,[ke(1)],[kh()]),kh=()=>Et("url ",0,1),Sh=i=>xt("stbl",null,[Th(i),Oh(i),Nh(i),Hh(i),zh(i),Vh(i)]),Th=i=>Et("stsd",0,0,[ke(1)],[i.info.type==="video"?Mh(Uh[i.info.codec],i):Ih(Gh[i.info.codec],i)]),Mh=(i,e)=>xt(i,[Array(6).fill(0),Ye(1),Ye(0),Ye(0),Array(12).fill(0),Ye(e.info.width),Ye(e.info.height),ke(4718592),ke(4718592),ke(0),Ye(1),Array(32).fill(0),Ye(24),uh(65535)],[Wh[e.info.codec](e)]),Lh=i=>i.codecPrivate&&xt("avcC",[...i.codecPrivate]),Dh=i=>i.codecPrivate&&xt("hvcC",[...i.codecPrivate]),Bh=i=>i.codecPrivate&&xt("vpcC",[...i.codecPrivate]),Fh=i=>i.codecPrivate&&xt("av1C",[...i.codecPrivate]),Ih=(i,e)=>xt(i,[Array(6).fill(0),Ye(1),Ye(0),Ye(0),ke(0),Ye(e.info.numberOfChannels),Ye(16),Ye(0),Ye(0),di(e.info.sampleRate)],[qh[e.info.codec](e)]),Ph=i=>Et("esds",0,0,[ke(58753152),Gt(32+i.codecPrivate.byteLength),Ye(1),Gt(0),ke(75530368),Gt(18+i.codecPrivate.byteLength),Gt(64),Gt(21),Jc(0),ke(130071),ke(130071),ke(92307584),Gt(i.codecPrivate.byteLength),...i.codecPrivate,ke(109084800),Gt(1),Gt(2)]),Rh=i=>xt("dOps",[Gt(0),Gt(i.info.numberOfChannels),Ye(3840),ke(i.info.sampleRate),lo(0),Gt(0)]),Oh=i=>Et("stts",0,0,[ke(i.timeToSampleTable.length),i.timeToSampleTable.map(e=>[ke(e.sampleCount),ke(e.sampleDelta)])]),Nh=i=>{if(i.samples.every(t=>t.type==="key"))return null;let e=[...i.samples.entries()].filter(([,t])=>t.type==="key");return Et("stss",0,0,[ke(e.length),e.map(([t])=>ke(t+1))])},Hh=i=>Et("stsc",0,0,[ke(i.compactlyCodedChunkTable.length),i.compactlyCodedChunkTable.map(e=>[ke(e.firstChunk),ke(e.samplesPerChunk),ke(1)])]),zh=i=>Et("stsz",0,0,[ke(0),ke(i.samples.length),i.samples.map(e=>ke(e.size))]),Vh=i=>i.finalizedChunks.length>0&&tn(i.finalizedChunks).offset>=2**32?Et("co64",0,0,[ke(i.finalizedChunks.length),i.finalizedChunks.map(e=>dh(e.offset))]):Et("stco",0,0,[ke(i.finalizedChunks.length),i.finalizedChunks.map(e=>ke(e.offset))]),Uh={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},Wh={avc:Lh,hevc:Dh,vp9:Bh,av1:Fh},Gh={aac:"mp4a",opus:"Opus"},qh={aac:Ph,opus:Rh},iu=class{constructor(){this.buffer=null}},nu=class{constructor(i,e,t){this.onData=i,this.onDone=e,this.options=t}},jh=class{constructor(i,e){this.stream=i,this.options=e}},ji,hn,co=class{constructor(){this.pos=0,Ie(this,ji,new Uint8Array(8)),Ie(this,hn,new DataView(K(this,ji).buffer)),this.offsets=new WeakMap}seek(i){this.pos=i}writeU32(i){K(this,hn).setUint32(0,i,!1),this.write(K(this,ji).subarray(0,4))}writeU64(i){K(this,hn).setUint32(0,Math.floor(i/2**32),!1),K(this,hn).setUint32(4,i,!1),this.write(K(this,ji).subarray(0,8))}writeAscii(i){for(let e=0;e<i.length;e++)K(this,hn).setUint8(e%8,i.charCodeAt(e)),e%8===7&&this.write(K(this,ji));i.length%8!==0&&this.write(K(this,ji).subarray(0,i.length%8))}writeBox(i){if(this.offsets.set(i,this.pos),i.contents&&!i.children)this.writeBoxHeader(i,i.size??i.contents.byteLength+8),this.write(i.contents);else{let e=this.pos;if(this.writeBoxHeader(i,0),i.contents&&this.write(i.contents),i.children)for(let a of i.children)a&&this.writeBox(a);let t=this.pos,n=i.size??t-e;this.seek(e),this.writeBoxHeader(i,n),this.seek(t)}}writeBoxHeader(i,e){this.writeU32(i.largeSize?1:e),this.writeAscii(i.type),i.largeSize&&this.writeU64(e)}measureBoxHeader(i){return 8+(i.largeSize?8:0)}patchBox(i){let e=this.pos;this.seek(this.offsets.get(i)),this.writeBox(i),this.seek(e)}measureBox(i){if(i.contents&&!i.children)return this.measureBoxHeader(i)+i.contents.byteLength;{let e=this.measureBoxHeader(i);if(i.contents&&(e+=i.contents.byteLength),i.children)for(let t of i.children)t&&(e+=this.measureBox(t));return e}}};ji=new WeakMap;hn=new WeakMap;var Sa,Qi,Qn,In,Ta,Rs,$h=class extends co{constructor(i){super(),Ie(this,Ta),Ie(this,Sa,void 0),Ie(this,Qi,new ArrayBuffer(2**16)),Ie(this,Qn,new Uint8Array(K(this,Qi))),Ie(this,In,0),wt(this,Sa,i)}write(i){tt(this,Ta,Rs).call(this,this.pos+i.byteLength),K(this,Qn).set(i,this.pos),this.pos+=i.byteLength,wt(this,In,Math.max(K(this,In),this.pos))}finalize(){tt(this,Ta,Rs).call(this,this.pos),K(this,Sa).buffer=K(this,Qi).slice(0,Math.max(K(this,In),this.pos))}};Sa=new WeakMap;Qi=new WeakMap;Qn=new WeakMap;In=new WeakMap;Ta=new WeakSet;Rs=function(i){let e=K(this,Qi).byteLength;for(;e<i;)e*=2;if(e===K(this,Qi).byteLength)return;let t=new ArrayBuffer(e),n=new Uint8Array(t);n.set(K(this,Qn),0),wt(this,Qi,t),wt(this,Qn,n)};var Pn,$i,au=class extends co{constructor(i){super(),Ie(this,Pn,void 0),Ie(this,$i,[]),wt(this,Pn,i)}write(i){K(this,$i).push({data:i.slice(),start:this.pos}),this.pos+=i.byteLength}flush(){if(K(this,$i).length===0)return;let i=[],e=[...K(this,$i)].sort((t,n)=>t.start-n.start);i.push({start:e[0].start,size:e[0].data.byteLength});for(let t=1;t<e.length;t++){let n=i[i.length-1],a=e[t];a.start<=n.start+n.size?n.size=Math.max(n.size,a.start+a.data.byteLength-n.start):i.push({start:a.start,size:a.data.byteLength})}for(let t of i){t.data=new Uint8Array(t.size);for(let n of K(this,$i))t.start<=n.start&&n.start<t.start+t.size&&t.data.set(n.data,n.start-t.start);K(this,Pn).onData(t.data,t.start)}K(this,$i).length=0}finalize(){K(this,Pn).onDone?.()}};Pn=new WeakMap;$i=new WeakMap;var Yh=2**24,Kh=2,Vn,ti,Pt,Pa,Os,uo,ru,ho,su,Un,Ra,ou=class extends co{constructor(i){if(super(),Ie(this,Pa),Ie(this,uo),Ie(this,ho),Ie(this,Un),Ie(this,Vn,void 0),Ie(this,ti,void 0),Ie(this,Pt,[]),wt(this,Vn,i),wt(this,ti,i.options?.chunkSize??Yh),!Number.isInteger(K(this,ti))||K(this,ti)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(i){tt(this,Pa,Os).call(this,i,this.pos),tt(this,Un,Ra).call(this),this.pos+=i.byteLength}finalize(){tt(this,Un,Ra).call(this,!0),K(this,Vn).onDone?.()}};Vn=new WeakMap;ti=new WeakMap;Pt=new WeakMap;Pa=new WeakSet;Os=function(i,e){let t=K(this,Pt).findIndex(o=>o.start<=e&&e<o.start+K(this,ti));t===-1&&(t=tt(this,ho,su).call(this,e));let n=K(this,Pt)[t],a=e-n.start,r=i.subarray(0,Math.min(K(this,ti)-a,i.byteLength));n.data.set(r,a);let s={start:a,end:a+r.byteLength};if(tt(this,uo,ru).call(this,n,s),n.written[0].start===0&&n.written[0].end===K(this,ti)&&(n.shouldFlush=!0),K(this,Pt).length>Kh){for(let o=0;o<K(this,Pt).length-1;o++)K(this,Pt)[o].shouldFlush=!0;tt(this,Un,Ra).call(this)}r.byteLength<i.byteLength&&tt(this,Pa,Os).call(this,i.subarray(r.byteLength),e+r.byteLength)};uo=new WeakSet;ru=function(i,e){let t=0,n=i.written.length-1,a=-1;for(;t<=n;){let r=Math.floor(t+(n-t+1)/2);i.written[r].start<=e.start?(t=r+1,a=r):n=r-1}for(i.written.splice(a+1,0,e),(a===-1||i.written[a].end<e.start)&&a++;a<i.written.length-1&&i.written[a].end>=i.written[a+1].start;)i.written[a].end=Math.max(i.written[a].end,i.written[a+1].end),i.written.splice(a+1,1)};ho=new WeakSet;su=function(i){let t={start:Math.floor(i/K(this,ti))*K(this,ti),data:new Uint8Array(K(this,ti)),written:[],shouldFlush:!1};return K(this,Pt).push(t),K(this,Pt).sort((n,a)=>n.start-a.start),K(this,Pt).indexOf(t)};Un=new WeakSet;Ra=function(i=!1){for(let e=0;e<K(this,Pt).length;e++){let t=K(this,Pt)[e];if(!(!t.shouldFlush&&!i)){for(let n of t.written)K(this,Vn).onData(t.data.subarray(n.start,n.end),t.start+n.start);K(this,Pt).splice(e--,1)}}};var Xh=class extends ou{constructor(i){super(new nu((e,t)=>i.stream.write({type:"write",data:e,position:t}),void 0,{chunkSize:i.options?.chunkSize}))}},Ns=1e3,Zh=["avc","hevc","vp9","av1"],Qh=["aac","opus"],Jh=2082844800,ef=.5,tf=["strict","offset"],Pe,Ue,Oa,Ft,Mi,Li,Rn,Wn,Gn,Hs,lu,zs,cu,fo,uu,Vs,du,po,hu,Ma,Us,mo,fu,qn,Na,Jn,tr,La,Ws,nf=class{constructor(i){if(Ie(this,Hs),Ie(this,zs),Ie(this,fo),Ie(this,Vs),Ie(this,po),Ie(this,Ma),Ie(this,mo),Ie(this,qn),Ie(this,Jn),Ie(this,La),Ie(this,Pe,void 0),Ie(this,Ue,void 0),Ie(this,Oa,void 0),Ie(this,Ft,void 0),Ie(this,Mi,null),Ie(this,Li,null),Ie(this,Rn,Math.floor(Date.now()/1e3)+Jh),Ie(this,Wn,[]),Ie(this,Gn,!1),tt(this,Hs,lu).call(this,i),i.video=zn(i.video),i.audio=zn(i.audio),i.fastStart=zn(i.fastStart),this.target=i.target,wt(this,Pe,{firstTimestampBehavior:"strict",...i}),i.target instanceof iu)wt(this,Ue,new $h(i.target));else if(i.target instanceof nu)wt(this,Ue,i.target.options?.chunked?new ou(i.target):new au(i.target));else if(i.target instanceof jh)wt(this,Ue,new Xh(i.target));else throw new Error(`Invalid target: ${i.target}`);tt(this,zs,cu).call(this),tt(this,Vs,du).call(this)}addVideoChunk(i,e,t){let n=new Uint8Array(i.byteLength);i.copyTo(n),this.addVideoChunkRaw(n,i.type,t??i.timestamp,i.duration,e)}addVideoChunkRaw(i,e,t,n,a){if(tt(this,La,Ws).call(this),!K(this,Pe).video)throw new Error("No video track declared.");if(typeof K(this,Pe).fastStart=="object"&&K(this,Mi).samples.length===K(this,Pe).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${K(this,Pe).fastStart.expectedVideoChunks}).`);tt(this,Ma,Us).call(this,K(this,Mi),i,e,t,n,a)}addAudioChunk(i,e,t){let n=new Uint8Array(i.byteLength);i.copyTo(n),this.addAudioChunkRaw(n,i.type,t??i.timestamp,i.duration,e)}addAudioChunkRaw(i,e,t,n,a){if(tt(this,La,Ws).call(this),!K(this,Pe).audio)throw new Error("No audio track declared.");if(typeof K(this,Pe).fastStart=="object"&&K(this,Li).samples.length===K(this,Pe).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${K(this,Pe).fastStart.expectedAudioChunks}).`);tt(this,Ma,Us).call(this,K(this,Li),i,e,t,n,a)}finalize(){if(K(this,Gn))throw new Error("Cannot finalize a muxer more than once.");K(this,Mi)&&tt(this,qn,Na).call(this,K(this,Mi)),K(this,Li)&&tt(this,qn,Na).call(this,K(this,Li));let i=[K(this,Mi),K(this,Li)].filter(Boolean);if(K(this,Pe).fastStart==="in-memory"){let e;for(let n=0;n<2;n++){let a=as(i,K(this,Rn)),r=K(this,Ue).measureBox(a);e=K(this,Ue).measureBox(K(this,Ft));let s=K(this,Ue).pos+r+e;for(let o of K(this,Wn)){o.offset=s;for(let l of o.sampleData)s+=l.byteLength,e+=l.byteLength}if(s<2**32)break;e>=2**32&&(K(this,Ft).largeSize=!0)}let t=as(i,K(this,Rn));K(this,Ue).writeBox(t),K(this,Ft).size=e,K(this,Ue).writeBox(K(this,Ft));for(let n of K(this,Wn)){for(let a of n.sampleData)K(this,Ue).write(a);n.sampleData=null}}else{let e=K(this,Ue).offsets.get(K(this,Ft)),t=K(this,Ue).pos-e;K(this,Ft).size=t,K(this,Ft).largeSize=t>=2**32,K(this,Ue).patchBox(K(this,Ft));let n=as(i,K(this,Rn));if(typeof K(this,Pe).fastStart=="object"){K(this,Ue).seek(K(this,Oa)),K(this,Ue).writeBox(n);let a=e-K(this,Ue).pos;K(this,Ue).writeBox(ph(a))}else K(this,Ue).writeBox(n)}tt(this,Jn,tr).call(this),K(this,Ue).finalize(),wt(this,Gn,!0)}};Pe=new WeakMap;Ue=new WeakMap;Oa=new WeakMap;Ft=new WeakMap;Mi=new WeakMap;Li=new WeakMap;Rn=new WeakMap;Wn=new WeakMap;Gn=new WeakMap;Hs=new WeakSet;lu=function(i){if(i.video){if(!Zh.includes(i.video.codec))throw new Error(`Unsupported video codec: ${i.video.codec}`);if(i.video.rotation!==void 0&&![0,90,180,270].includes(i.video.rotation))throw new Error(`Invalid video rotation: ${i.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(i.audio&&!Qh.includes(i.audio.codec))throw new Error(`Unsupported audio codec: ${i.audio.codec}`);if(i.firstTimestampBehavior&&!tf.includes(i.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${i.firstTimestampBehavior}`);if(typeof i.fastStart=="object"){if(i.video&&i.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(i.audio&&i.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory"].includes(i.fastStart))throw new Error("'fastStart' option must be false, 'in-memory' or an object.")};zs=new WeakSet;cu=function(){let i=K(this,Pe).video?.codec==="hevc";if(K(this,Ue).writeBox(fh(i)),wt(this,Oa,K(this,Ue).pos),K(this,Pe).fastStart==="in-memory")wt(this,Ft,Hl(!1));else{if(typeof K(this,Pe).fastStart=="object"){let e=tt(this,fo,uu).call(this);K(this,Ue).seek(K(this,Ue).pos+e)}wt(this,Ft,Hl(!0)),K(this,Ue).writeBox(K(this,Ft))}tt(this,Jn,tr).call(this)};fo=new WeakSet;uu=function(){if(typeof K(this,Pe).fastStart!="object")return;let i=0,e=[K(this,Pe).fastStart.expectedVideoChunks,K(this,Pe).fastStart.expectedAudioChunks];for(let t of e)t&&(i+=8*Math.ceil(2/3*t),i+=4*t,i+=12*Math.ceil(2/3*t),i+=4*t,i+=8*t);return i+=4096,i};Vs=new WeakSet;du=function(){if(K(this,Pe).video&&wt(this,Mi,{id:1,info:{type:"video",codec:K(this,Pe).video.codec,width:K(this,Pe).video.width,height:K(this,Pe).video.height,rotation:K(this,Pe).video.rotation??0},timescale:720,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),K(this,Pe).audio){let i=tt(this,po,hu).call(this,2,K(this,Pe).audio.sampleRate,K(this,Pe).audio.numberOfChannels);wt(this,Li,{id:K(this,Pe).video?2:1,info:{type:"audio",codec:K(this,Pe).audio.codec,numberOfChannels:K(this,Pe).audio.numberOfChannels,sampleRate:K(this,Pe).audio.sampleRate},timescale:K(this,Pe).audio.sampleRate,codecPrivate:i,samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}};po=new WeakSet;hu=function(i,e,t){let a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(e),r=t,s="";s+=i.toString(2).padStart(5,"0"),s+=a.toString(2).padStart(4,"0"),a===15&&(s+=e.toString(2).padStart(24,"0")),s+=r.toString(2).padStart(4,"0");let o=Math.ceil(s.length/8)*8;s=s.padEnd(o,"0");let l=new Uint8Array(s.length/8);for(let u=0;u<s.length;u+=8)l[u/8]=parseInt(s.slice(u,u+8),2);return l};Ma=new WeakSet;Us=function(i,e,t,n,a,r){let s=n/1e6,o=a/1e6;if(i.firstTimestamp===void 0&&(i.firstTimestamp=s),s=tt(this,mo,fu).call(this,s,i),i.lastTimestamp=s,(!i.currentChunk||s-i.currentChunk.startTimestamp>=ef)&&(i.currentChunk&&tt(this,qn,Na).call(this,i),i.currentChunk={startTimestamp:s,sampleData:[],sampleCount:0}),i.currentChunk.sampleData.push(e),i.currentChunk.sampleCount++,r?.decoderConfig?.description&&(i.codecPrivate=new Uint8Array(r.decoderConfig.description)),i.samples.push({timestamp:s,duration:o,size:e.byteLength,type:t}),i.lastTimescaleUnits!==null){let l=Zn(s,i.timescale,!1),u=Math.round(l-i.lastTimescaleUnits);i.lastTimescaleUnits+=u;let f=tn(i.timeToSampleTable);f.sampleCount===1?(f.sampleDelta=u,f.sampleCount++):f.sampleDelta===u?f.sampleCount++:(f.sampleCount--,i.timeToSampleTable.push({sampleCount:2,sampleDelta:u}))}else i.lastTimescaleUnits=0,i.timeToSampleTable.push({sampleCount:1,sampleDelta:Zn(o,i.timescale)})};mo=new WeakSet;fu=function(i,e){if(K(this,Pe).firstTimestampBehavior==="strict"&&e.lastTimestamp===-1&&i!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${i}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(K(this,Pe).firstTimestampBehavior==="offset"&&(i-=e.firstTimestamp),i<e.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${e.lastTimestamp*1e6} to ${i*1e6}).`);return i};qn=new WeakSet;Na=function(i){if(i.currentChunk){if((i.compactlyCodedChunkTable.length===0||tn(i.compactlyCodedChunkTable).samplesPerChunk!==i.currentChunk.sampleCount)&&i.compactlyCodedChunkTable.push({firstChunk:i.finalizedChunks.length+1,samplesPerChunk:i.currentChunk.sampleCount}),i.finalizedChunks.push(i.currentChunk),K(this,Wn).push(i.currentChunk),K(this,Pe).fastStart==="in-memory"){i.currentChunk.offset=0;return}i.currentChunk.offset=K(this,Ue).pos;for(let e of i.currentChunk.sampleData)K(this,Ue).write(e);i.currentChunk.sampleData=null,tt(this,Jn,tr).call(this)}};Jn=new WeakSet;tr=function(){K(this,Ue)instanceof au&&K(this,Ue).flush()};La=new WeakSet;Ws=function(){if(K(this,Gn))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};class af{app;options;encoder;ac;muxer;recording=!1;renderInterval;cachedBarlines;_currentFrame=0;blob;totalFrames;constructor(e,t){this.options={aspectRatio:4/3,videoHeight:1080,fps:60,bitrate:4e7,playbackRate:1,assistTick:!1,metronome:!1,hideBarlines:!1,startTime:0,endTime:10,...t},this.app=e,this.muxer=new nf({target:new iu,video:{codec:"avc",width:Math.round(this.options.videoHeight*this.options.aspectRatio/2)*2,height:this.options.videoHeight},audio:{codec:"aac",numberOfChannels:this.app.chartManager.chartAudio.getBuffer().numberOfChannels,sampleRate:this.app.chartManager.chartAudio.getSampleRate()},fastStart:"in-memory"}),this.encoder=new VideoEncoder({output:(n,a)=>void this.muxer.addVideoChunk(n,a),error:n=>{throw n}}),this.encoder.configure({codec:"avc1.420028",width:Math.round(this.options.videoHeight*this.options.aspectRatio/2)*2,height:this.options.videoHeight,bitrate:this.options.bitrate,hardwareAcceleration:"prefer-hardware",framerate:this.options.fps}),this.ac=new AudioEncoder({output:(n,a)=>void this.muxer.addAudioChunk(n,a),error:n=>{throw n}}),this.ac.configure({codec:"mp4a.40.2",bitrate:192e3,numberOfChannels:this.app.chartManager.chartAudio.getBuffer().numberOfChannels,sampleRate:this.app.chartManager.chartAudio.getSampleRate()}),this.totalFrames=Math.ceil((this.options.endTime-this.options.startTime)*this.options.fps),this.cachedBarlines=fe.barlines}async renderBufferWithModifications(e,t){const n=new OfflineAudioContext(e.numberOfChannels,Math.ceil(e.duration*t.sampleRate/t.rate),t.sampleRate),a=n.createGain();a.gain.setValueAtTime(t.volume,0);const r=n.createBufferSource();r.buffer=e,r.playbackRate.setValueAtTime(t.rate,0),r.connect(a),a.connect(n.destination),r.start();const s=await n.startRendering();return r.stop(),s}async createAssistSounds(e,t,n,a){const r=new AudioBuffer({length:Math.ceil((t-e)*n/a),sampleRate:n,numberOfChannels:2}),s=this.app.chartManager.loadedChart,o=s.getBeatFromSeconds(e),l=s.getBeatFromSeconds(t),u=s.getNotedataInRange(o,l);if(this.options.assistTick){let f=this.app.chartManager.assistTick.getBuffer();f=await this.renderBufferWithModifications(f,{volume:b.audio.soundEffectVolume*b.audio.masterVolume,sampleRate:n,rate:1});let c=-1;for(const d of u)if(d.beat!=c&&(c=d.beat,s.gameType.gameLogic.shouldAssistTick(d))){const h=Math.floor((d.second-e)*n/a);for(let p=0;p<r.numberOfChannels;p++){const m=r.getChannelData(p);for(let g=0;g<f.length&&!(h+g>=m.length);g++)m[h+g]+=f.getChannelData(p%f.numberOfChannels)[g]}}}if(this.options.metronome){let f=this.app.chartManager.me_high.getBuffer();f=await this.renderBufferWithModifications(f,{volume:b.audio.soundEffectVolume*b.audio.masterVolume,sampleRate:n,rate:1});let c=this.app.chartManager.me_low.getBuffer();c=await this.renderBufferWithModifications(c,{volume:b.audio.soundEffectVolume*b.audio.masterVolume,sampleRate:n,rate:1});let d=null;for(const[h,p]of s.timingData.getMeasureBeats(o,l)){const m=s.timingData.getSecondsFromBeat(h);if(d!==null&&m==d)continue;d=m;const g=p?f:c,y=Math.floor((m-e)*n/a);for(let x=0;x<r.numberOfChannels;x++){const w=r.getChannelData(x);for(let C=0;C<g.length&&!(y+C>=w.length);C++)w[y+C]+=g.getChannelData(x%g.numberOfChannels)[C]}}}return r}async start(){console.time("capture");const e=this.app.chartManager.loadedChart;document.body.classList.remove("animated"),this.app.chartManager.setMode(W.View),fe.barlines=!this.options.hideBarlines,this.app.capturing=!0,this.app.chartManager.chartAudio.isPlaying()&&this.app.chartManager.playPause(),this.options.endTime===void 0&&(this.options.endTime=this.app.chartManager.loadedChart?.getLastSecond()??this.app.chartManager.chartAudio.getBuffer().length/this.app.chartManager.chartAudio.getBuffer().sampleRate),this._currentFrame=0,this.app.onResize(this.options.videoHeight*this.options.aspectRatio,this.options.videoHeight),this.app.view.style.width=window.innerWidth+"px",this.app.view.style.height=window.innerHeight+"px",vt.shared.stop();let t=this.app.chartManager.chartAudio.getBuffer();const n=Math.floor(this.options.startTime*t.sampleRate),a=Math.ceil(this.options.endTime*t.sampleRate),r=a-n,s=new AudioBuffer({length:r,sampleRate:t.sampleRate,numberOfChannels:t.numberOfChannels});for(let f=0;f<t.numberOfChannels;f++){const c=t.getChannelData(f);s.copyToChannel(c.subarray(Math.max(0,n),a),f,Math.max(0,-n))}t=await this.renderBufferWithModifications(s,{volume:b.audio.songVolume*b.audio.masterVolume,sampleRate:s.sampleRate,rate:this.options.playbackRate});let o=0;o=hi(e.getNotedata(),this.options.startTime,f=>f.second)+1,o>=1&&this.options.startTime<=e.getNotedata()[o-1].second&&o--;let l=[];const u=await this.createAssistSounds(this.options.startTime,this.options.endTime,t.sampleRate,this.options.playbackRate);return new Promise(f=>{this.recording=!0,this.renderInterval=setInterval(()=>{if(this.recording&&this.encoder.encodeQueueSize<300){const c=this._currentFrame/this.options.fps*this.options.playbackRate+this.options.startTime;if(c>this.options.endTime){f(this.stop());return}this.app.chartManager.time=c;const d=e.getNotedata();for(;o<d.length&&c>d[o].second;){const C=d[o];e.gameType.gameLogic.shouldAssistTick(C)&&(this.app.chartManager.chartView.doJudgement(C,0,Js),Oe(C)&&(C.type=="Hold"?this.app.chartManager.chartView.getNotefield().activateHold(C.col):C.type=="Roll"&&this.app.chartManager.chartView.getNotefield().activateRoll(C.col),l.push(C))),o++}l=l.filter(C=>this.app.chartManager.beat<C.beat+C.hold?!0:(C.type=="Hold"&&this.app.chartManager.chartView.getNotefield().releaseHold(C.col),C.type=="Roll"&&this.app.chartManager.chartView.getNotefield().releaseRoll(C.col),this.app.chartManager.chartView.doJudgement(C,null,_t.getCollection(b.play.timingCollection).getHeldJudgement(C)),!1)),vt.shared.update(vt.shared.lastTime+1e3/this.options.fps),this.app.renderer.render(this.app.stage);const h=new VideoFrame(this.app.view,{timestamp:this._currentFrame/this.options.fps*1e6}),p=(c-this.options.startTime)/this.options.playbackRate,m=Math.floor(p*t.sampleRate),g=Math.ceil((p+1/this.options.fps)*t.sampleRate),y=g-m,x=new Float32Array(y*t.numberOfChannels);for(let C=0;C<t.numberOfChannels;C++){const _=t.getChannelData(C);if(x.set(_.subarray(m,g),C*y),this.options.metronome||this.options.assistTick){const F=u.getChannelData(C);for(let D=m;D<g&&!(D>=F.length);D++)x[C*y+D-m]+=F[D]}}const w=new AudioData({data:x,format:"f32-planar",numberOfChannels:t.numberOfChannels,numberOfFrames:y,sampleRate:t.sampleRate,timestamp:this._currentFrame/this.options.fps*1e6});this._currentFrame+=1,this.encoder.encode(h),this.ac.encode(w),w.close(),this.options.updateCallback?.({currentRenderFrame:this._currentFrame,currentEncodeQueue:this.encoder.encodeQueueSize,totalFrames:this.totalFrames,currentVideoFrame:h}),h.close()}},10)})}async stop(){clearInterval(this.renderInterval),vt.shared.start(),this.app.chartManager.setMode(W.Edit),this.app.updateSize(),this.recording=!1,this.app.capturing=!1,fe.barlines=this.cachedBarlines;const e=setInterval(()=>{this.options.updateCallback?.({currentRenderFrame:this.totalFrames,currentEncodeQueue:this.encoder.encodeQueueSize,totalFrames:this.totalFrames,currentVideoFrame:null})},100);await this.encoder?.flush(),await this.ac?.flush(),this.muxer.finalize(),clearInterval(e);const{buffer:t}=this.muxer.target,n=new Blob([t],{type:"video/mp4"});this.blob=n;const a=URL.createObjectURL(n);return b.general.smoothAnimations&&document.body.classList.add("animated"),console.timeEnd("capture"),this.options.onFinish?.(a),a}get currentRenderFrame(){return this._currentFrame}get currentEncodeQueue(){return this.encoder.encodeQueueSize}get size(){return this.blob?this.blob.size:0}}const Bi={"dance-single":[{label:"Left",keys:["Left","A"]},{label:"Down",keys:["Down","S"]},{label:"Up",keys:["Up","W"]},{label:"Right",keys:["Right","D"]}],"dance-double":[{label:"P1 Left",keys:["Left"]},{label:"P1 Down",keys:["Down"]},{label:"P1 Up",keys:["Up"]},{label:"P1 Right",keys:["Right"]},{label:"P2 Left",keys:["A"]},{label:"P2 Down",keys:["S"]},{label:"P2 Up",keys:["W"]},{label:"P2 Right",keys:["D"]}],"dance-couple":[{label:"P1 Left",keys:["Left"]},{label:"P1 Down",keys:["Down"]},{label:"P1 Up",keys:["Up"]},{label:"P1 Right",keys:["Right"]},{label:"P2 Left",keys:["A"]},{label:"P2 Down",keys:["S"]},{label:"P2 Up",keys:["W"]},{label:"P2 Right",keys:["D"]}],"dance-solo":[{label:"Left",keys:["Left","A"]},{label:"UpLeft",keys:["Q"]},{label:"Down",keys:["Down","S"]},{label:"Up",keys:["Up","W"]},{label:"UpRight",keys:["E"]},{label:"Right",keys:["Right","D"]}],"dance-solodouble":[{label:"P1 Left",keys:["A"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Down",keys:["S"]},{label:"P1 Up",keys:["W"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 Right",keys:["D"]},{label:"P2 Left",keys:["J"]},{label:"P2 UpLeft",keys:["U"]},{label:"P2 Down",keys:["K"]},{label:"P2 Up",keys:["I"]},{label:"P2 UpRight",keys:["O"]},{label:"P2 Right",keys:["L"]}],"dance-threepanel":[{label:"UpLeft",keys:["Left","Q"]},{label:"Down",keys:["Down","S"]},{label:"UpRight",keys:["Right","E"]}],"dance-threedouble":[{label:"P1 UpLeft",keys:["Left"]},{label:"P1 Down",keys:["Down"]},{label:"P1 UpRight",keys:["Right"]},{label:"P2 UpLeft",keys:["Q"]},{label:"P2 Down",keys:["S"]},{label:"P2 UpRight",keys:["E"]}],"pump-single":[{label:"DownLeft",keys:["Z"]},{label:"UpLeft",keys:["Q"]},{label:"Center",keys:["S"]},{label:"UpRight",keys:["E"]},{label:"DownRight",keys:["C"]}],"pump-double":[{label:"P1 DownLeft",keys:["Z"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]},{label:"P2 UpRight",keys:["Y"]},{label:"P2 DownRight",keys:["N"]}],"pump-versus":[{label:"P1 DownLeft",keys:["Z"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]},{label:"P2 UpRight",keys:["Y"]},{label:"P2 DownRight",keys:["N"]}],"pump-couple":[{label:"P1 DownLeft",keys:["Z"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]},{label:"P2 UpRight",keys:["Y"]},{label:"P2 DownRight",keys:["N"]}],"pump-halfdouble":[{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]}]};class Ae{static app;static userKeybinds=new Map;static userGameplayKeybinds=new Map;static enabled=!0;static load(e){this.app=e;try{this.loadKeybinds()}catch(t){console.error("Failed to load user keybinds!"),console.error(t.stack),this.userKeybinds.clear(),this.userGameplayKeybinds.clear()}window.addEventListener("keydown",t=>this.checkKey(t,"keydown")),window.addEventListener("keyup",t=>this.checkKey(t,"keyup"))}static checkKey(e,t){if(!this.enabled||e.target.classList.contains("inlineEdit")||e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLInputElement||e.target instanceof HTMLButtonElement||["Meta","Control","Shift","Alt"].includes(e.key))return;const n=[];for(let s=0;s<Ga.length;s++)e[Ga[s]]&&n.push(Ba[s]);const a=Ae.getKeyNameFromEvent(e);if((this.app.chartManager.getMode()==W.Play||this.app.chartManager.getMode()==W.Record)&&this.app.chartManager.loadedChart?.gameType&&!e.repeat){const s=Bi[this.app.chartManager.loadedChart?.gameType.id]??[],o=this.userGameplayKeybinds.get(this.app.chartManager.loadedChart?.gameType.id)??[],l=Object.values(s).findIndex((u,f)=>(o[f]??u.keys).some(c=>a==c));if(l!=-1){if(e.preventDefault(),this.app.windowManager.getFocusedWindow()?.options?.win_id=="keybind_options"||this.app.windowManager.isBlocked())return;this.app.chartManager[t=="keydown"?"judgeCol":"judgeColUp"](l);return}}const r=Object.keys($e).filter(s=>!["cut","copy","paste","pasteReplace"].includes(s)).filter(s=>{for(const o of this.getCombosForKeybind(s))if(this.compareModifiers(o.mods,n)&&o.key==a)return!0;return!1}).map(s=>$e[s]);if(r.length>0){if(r.every(s=>s.preventDefault!=!1)&&e.preventDefault(),this.app.windowManager.getFocusedWindow()?.options?.win_id=="keybind_options"||this.app.windowManager.isBlocked())return;for(const s of r){let o=s.disabled;if(o instanceof Function&&(o=o(this.app)),!o&&!(s.disableRepeat&&e.repeat)){t=="keydown"?s.callback(this.app):s.callbackKeyUp?.(this.app);return}}}}static getKeyNameFromEvent(e){if(e.which>=65&&e.which<=90)return String.fromCharCode(e.which).toUpperCase();let t=e.code;return t.startsWith("Digit")&&(t=t.slice(5)),t.startsWith("Key")&&(t=t.slice(3)),t in kc&&(t=kc[t]),t}static getKeybindString(e){return this.getCombosForKeybind(e).map(t=>this.getComboString(t)).join(" / ")}static getComboString(e){const t=Ba.filter(n=>e.mods.includes(n)).map(n=>Sm[n]).join("");return t+(t!=""?" ":"")+(Qu[e.key]??e.key)}static getCombosForKeybind(e){return e in $e?this.userKeybinds.get(e)??$e[e].combos:(console.log("Couldn't find keybind with id "+e),[])}static getKeysForGameType(e){const t=yt.getGameType(e);return t?new Array(t.numCols).fill(null).map((n,a)=>this.userGameplayKeybinds.get(e)?.[a]??Bi[e]?.[a].keys??[]):(console.log("Couldn't find game type with id "+e),[])}static compareModifiers(e,t){if(e.length!=t.length)return!1;for(const n of Ba)if((e.includes(n)?1:0)+(t.includes(n)?1:0)==1)return!1;return!0}static compareCombos(e,t){return e.key==t.key&&this.compareModifiers(e.mods,t.mods)}static loadKeybinds(){const e=localStorage.getItem("keybinds");if(e){const n=JSON.parse(e);if(typeof n!="object")return console.error("Couldn't load keybinds from storage");for(const[a,r]of Object.entries(n)){if(!(a in $e)){console.warn("Couldn't load keybind "+a+": key doesn't exist");continue}Array.isArray(r)||console.warn("Couldn't load keybind "+a+": value is not an array"),this.userKeybinds.set(a,r.filter(s=>typeof s.key!="string"||!Array.isArray(s.mods)?(console.warn("Couldn't load keycombo for keybind "+a+": "+JSON.stringify(s)),!1):!0))}}const t=localStorage.getItem("keybindsGP");if(t){const n=JSON.parse(t);if(typeof n!="object")return console.error("Couldn't load gameplay keybinds from storage");for(const[a,r]of Object.entries(n)){if(!yt.getGameType(a)){console.warn("Couldn't load gameplay keybinds for gameType "+a+": gameType doesn't exist");continue}Array.isArray(r)||console.warn("Couldn't load gameplay keybind "+a+": value is not an array"),this.userGameplayKeybinds.set(a,r.map((s,o)=>!Array.isArray(s)&&s!==null?(console.warn("Couldn't load gameplay keys for type "+a+" col "+o+": "+JSON.stringify(s)),null):s))}}}static clearSave(){localStorage.removeItem("keybinds"),localStorage.removeItem("keybindsGP")}static setKeybind(e,t){this.userKeybinds.has(e)||this.userKeybinds.set(e,[...$e[e].combos]),this.userKeybinds.get(e)?.push(t),this.checkIsDefault(e),this.saveKeybinds()}static removeKeybind(e,t){this.userKeybinds.has(e)||this.userKeybinds.set(e,[...$e[e].combos]),this.userKeybinds.set(e,this.userKeybinds.get(e).filter(n=>!this.compareCombos(n,t))),this.checkIsDefault(e),this.saveKeybinds()}static revertKeybind(e){this.userKeybinds.delete(e),this.saveKeybinds()}static revertGameplayKeybind(e,t){this.userGameplayKeybinds.has(e)&&(this.userGameplayKeybinds.get(e)[t]=null,this.userGameplayKeybinds.get(e).every(n=>n===null)&&this.userGameplayKeybinds.delete(e)),this.saveKeybinds()}static setGameplayKeybind(e,t,n){this.userGameplayKeybinds.has(e)||this.userGameplayKeybinds.set(e,new Array(yt.getGameType(e).numCols).fill(null)),this.userGameplayKeybinds.get(e)[t]==null&&(this.userGameplayKeybinds.get(e)[t]=[...Bi[e]?.[t].keys??[]]),this.userGameplayKeybinds.get(e)[t].push(n),this.checkIsDefaultGameplay(e,t),this.saveKeybinds()}static removeGameplayKeybind(e,t,n){this.userGameplayKeybinds.has(e)||this.userGameplayKeybinds.set(e,new Array(yt.getGameType(e).numCols).fill(null)),this.userGameplayKeybinds.get(e)[t]==null&&(this.userGameplayKeybinds.get(e)[t]=[...Bi[e]?.[t].keys??[]]),this.userGameplayKeybinds.get(e)[t]=this.userGameplayKeybinds.get(e)[t].filter(a=>a!=n),this.checkIsDefaultGameplay(e,t),this.saveKeybinds()}static checkIsDefault(e){if(!this.userKeybinds.has(e))return!0;const t=this.userKeybinds.get(e),n=[...$e[e].combos];return t.length!=n.length?!1:t.map(a=>this.getComboString(a)).sort().join("∆")==n.map(a=>this.getComboString(a)).sort().join("∆")?(this.userKeybinds.delete(e),!0):!1}static checkIsDefaultGameplay(e,t){if(!this.userGameplayKeybinds.has(e)||this.userGameplayKeybinds.get(e)[t]===null)return!0;const n=this.userGameplayKeybinds.get(e)[t],a=[...Bi[e]?.[t].keys??[]];return n.length!=a.length?!1:n.sort().join("∆")==a.sort().join("∆")?(this.userGameplayKeybinds.get(e)[t]=null,this.userGameplayKeybinds.get(e).every(r=>r===null)&&this.userGameplayKeybinds.delete(e),!0):!1}static saveKeybinds(){const e={};for(const[n,a]of this.userKeybinds.entries())e[n]=a;localStorage.setItem("keybinds",JSON.stringify(e));const t={};for(const[n,a]of this.userGameplayKeybinds.entries())t[n]=a;localStorage.setItem("keybindsGP",JSON.stringify(t))}static getKeybindTooltip(e){return this.getCombosForKeybind(e).map(n=>{let a=this.getComboString(n);return a==""?"":(a=a.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"),"<button class='pref-keybind-combo'>"+a+"</button>")}).join("")}static evaluateTaggedTooltip(e,t){t=t.map(a=>a.startsWith("\\")?a.slice(1):this.getKeybindTooltip(a));const n=[];for(let a=0;a<t.length;a++)n.push(e[a]),n.push(t[a]);return n.push(e[t.length]),"<div style='display: flex; align-items: center; gap: 0.375rem'>"+n.join("")+"</div>"}static createKeybindTooltip(e){return(t,...n)=>{Xe(e,{allowHTML:!0,onShow:a=>{a.setContent(this.evaluateTaggedTooltip(t,n))}})}}static disableKeybinds(){this.enabled=!1}static enableKeybinds(){this.enabled=!0}}class ht{view;input;options;lastVal="";constructor(e,t){this.view=e,this.view.classList.add("spinner"),this.options={value:0,precision:3,step:null,minPrecision:null,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,...t},this.view.onfocus=()=>{n.focus()};const n=document.createElement("input");n.classList.add("spinner-input"),n.type="text",n.autocomplete="off",n.spellcheck=!1,n.onblur=()=>{if(n.value===this.lastVal)return;if(n.value===""){this.options.onchange?.(void 0);return}const o=Yn(n.value);if(o===null){n.value=this.lastVal;return}const l=he(Te(o,this.options.min,this.options.max),this.options.precision);n.value=this.formatValue(l),this.options.onchange?.(l)},n.onkeydown=o=>{o.key=="Enter"&&n.blur(),o.key=="Escape"&&(n.value=this.lastVal,n.blur())},n.onfocus=()=>{this.lastVal=n.value},this.input=n,this.value=this.options.value,e.appendChild(n);const a=document.createElement("div");a.classList.add("spinner-btns"),e.appendChild(a);const r=document.createElement("button");r.classList.add("spinner-up"),r.appendChild(be.getIcon("CHEVRON",10)),r.tabIndex=-1,r.onclick=o=>{let l=this.options.step??b.general.spinnerStep;if(o.getModifierState("Shift")&&(l/=10),parseFloat(n.value)+l>this.options.max){n.value=this.formatValue(this.options.max),this.options.onchange?.(this.options.max);return}n.value=this.formatValue(parseFloat(n.value)+l),this.options.onchange?.(parseFloat(n.value))},a.appendChild(r);const s=document.createElement("button");s.classList.add("spinner-down"),s.appendChild(be.getIcon("CHEVRON",10)),s.tabIndex=-1,s.onclick=o=>{let l=this.options.step??b.general.spinnerStep;if(o.getModifierState("Shift")&&(l/=10),parseFloat(n.value)-l<this.options.min){n.value=this.formatValue(this.options.min),this.options.onchange?.(this.options.min);return}n.value=this.formatValue(parseFloat(n.value)-l),this.options.onchange?.(parseFloat(n.value))},a.appendChild(s)}static create(e){return new ht(document.createElement("div"),e)}formatValue(e){const t=e.toString().split(".")[1]?.length??0;return this.options.minPrecision!==null&&this.options.minPrecision>=t?he(e,this.options.minPrecision).toFixed(this.options.minPrecision):this.options.minPrecision!==null&&this.options.precision>=t?e.toString():he(e,this.options.precision).toFixed(this.options.precision)}get value(){return parseFloat(this.input.value)}set value(e){parseFloat(this.input.value)!=he(e,this.options.precision)&&(this.input.value=this.formatValue(e))}get step(){return this.options.step}set step(e){this.options.step=e}get min(){return this.options.min}set min(e){this.options.min=e}get max(){return this.options.max}set max(e){this.options.max=e}get precision(){return this.options.precision}set precision(e){this.options.precision=e}get minPrecision(){return this.options.minPrecision}set minPrecision(e){this.options.minPrecision=e}get onchange(){return this.options.onchange}set onchange(e){this.options.onchange=e}get disabled(){return this.input.disabled}set disabled(e){this.input.disabled=e}}const zl=["accent-color","editor-bg","widget-bg","editable-overlay-hover","editable-overlay-active","text-color","text-color-secondary","text-color-detail","text-color-disabled","primary-bg","primary-border","primary-bg-active","primary-bg-hover","secondary-bg","secondary-border","secondary-bg-active","secondary-bg-hover","tooltip-bg","input-bg","input-bg-active","input-bg-hover","input-border","navbar-bg","navbar-bg-inactive","window-bg","window-border"],rf=["primary-bg","secondary-bg","text-color","accent-color","widget-bg","editor-bg","editable-overlay-active","input-bg","window-bg"],sf=[{name:"primary-bg",ids:[{id:"primary-bg",label:"base"},{id:"primary-bg-active",label:"active"},{id:"primary-bg-hover",label:"hover"},{id:"primary-border",label:"border"}]},{name:"secondary-bg",ids:[{id:"secondary-bg",label:"base"},{id:"secondary-bg-active",label:"active"},{id:"secondary-bg-hover",label:"hover"},{id:"secondary-border",label:"border"}]},{name:"text-color",ids:[{id:"text-color",label:"primary"},{id:"text-color-secondary",label:"secondary"},{id:"text-color-detail",label:"detail"},{id:"text-color-disabled",label:"disabled"}]},{name:"other",ids:[{id:"accent-color",label:"accent-color"},{id:"widget-bg",label:"widget-bg"},{id:"tooltip-bg",label:"tooltip-bg"},{id:"editor-bg",label:"editor-bg"}]},{name:"editable-overlay",ids:[{id:"editable-overlay-hover",label:"hover"},{id:"editable-overlay-active",label:"active"}]},{name:"input",ids:[{id:"input-bg",label:"background"},{id:"input-bg-active",label:"active"},{id:"input-bg-hover",label:"hover"},{id:"input-border",label:"border"}]},{name:"window",ids:[{id:"window-bg",label:"background"},{id:"window-border",label:"border"}]},{name:"window-navbar",ids:[{id:"navbar-bg",label:"active"},{id:"navbar-bg-inactive",label:"inactive"}]}],Vl={"accent-color":"Color used for focus input rings, confirm buttons","text-color":"Base text color","text-color-secondary":"Secondary text color, used for text in recent files, menubar keybinds","text-color-detail":"Detail text color, used for text in timing event boxes","text-color-disabled":"Used for texts relating to empty/disabled things (ex. no files in directory picker)","primary-bg":"Primary background, used for menubar, context/dropdown menus","primary-border":"","primary-bg-active":"","primary-bg-hover":"","navbar-bg":"Window navbar background","navbar-bg-inactive":"","window-bg":"Window background","window-border":"","secondary-bg":"Secondary background, used for subareas in menus","secondary-border":"","secondary-bg-active":"","secondary-bg-hover":"","editable-overlay-hover":"Overlay on top of editable items (status widget buttons, playback option toggles, textareas)","editable-overlay-active":"","input-bg":"Background color for input","input-bg-active":"","input-bg-hover":"","input-border":"","widget-bg":"Widget background","tooltip-bg":"Color of these tooltips","editor-bg":"Editor background"},rs={"primary-bg":{"primary-border":function(i){return this.lighten(i,10).setAlpha(187/255)},"primary-bg-active":function(i){return this.lighten(i,10)},"primary-bg-hover":function(i){return this.lighten(i,30)},"widget-bg":function(i){return this.add(i,-50).setAlpha(136/255)},"window-bg":function(i){return this.lighten(i,-10)},"text-color":function(i){return this.average(i)>.5?new B("#000"):new B("#fff")},"input-bg":function(i){return this.average(i)<.5?new B("#000"):new B("#fff")},"input-border":function(i){return this.average(i)>.5?this.add(i,-30).setAlpha(119/255):this.add(i,30).setAlpha(119/255)},"tooltip-bg":function(i){return this.lighten(i,-10).setAlpha(238/255)},"secondary-bg":function(i){return this.lighten(i,-20)},"editor-bg":function(i){return this.lighten(i,-60)}},"window-bg":{"navbar-bg":function(i){return new B(i)}},"secondary-bg":{"secondary-border":function(i){return this.lighten(i,10).setAlpha(187/255)},"secondary-bg-active":function(i){return this.lighten(i,50)},"secondary-bg-hover":function(i){return this.lighten(i,30)}},"navbar-bg":{"navbar-bg-inactive":function(i){return this.lighten(i,-33)}},"text-color":{"text-color-secondary":function(i){return new B(i).setAlpha(119/255)},"text-color-detail":function(i){return new B(i).setAlpha(68/255)},"text-color-disabled":function(i){return new B(i).setAlpha(136/255)}},"input-bg":{"input-border":function(i){return this.lighten(i,10).setAlpha(187/255)},"input-bg-active":function(i){return this.lighten(i,50)},"input-bg-hover":function(i){return this.lighten(i,30)}}},Yi={default:{"accent-color":new B("rgb(23, 131, 208)"),"text-color":new B("#fff"),"text-color-secondary":new B("#888"),"text-color-detail":new B("#757a89"),"text-color-disabled":new B("#888"),"primary-bg":new B("#555"),"primary-border":new B("#444"),"primary-bg-active":new B("#575757"),"primary-bg-hover":new B("#666"),"navbar-bg":new B("#3d3d3d"),"navbar-bg-inactive":new B("#626262"),"window-bg":new B("#3d3d3d"),"window-border":new B("#00000000"),"secondary-bg":new B("#373737"),"secondary-border":new B("#333"),"secondary-bg-active":new B("#555"),"secondary-bg-hover":new B("#454545"),"editable-overlay-hover":new B("rgb(255, 255, 255, 0.1)"),"editable-overlay-active":new B("rgb(255, 255, 255, 0.2)"),"input-bg":new B("rgba(35, 35, 35, 0.309)"),"input-bg-active":new B("rgba(50, 50, 50, 0.309)"),"input-bg-hover":new B("rgba(79, 79, 79, 0.309)"),"input-border":new B("rgba(0, 0, 0, 0.3)"),"widget-bg":new B("rgba(0, 0, 0, 0.5)"),"tooltip-bg":new B("rgba(20, 20, 20, 0.95)"),"editor-bg":new B("#18191c")},dusk:{"accent-color":new B("#b34e97ff"),"text-color":new B("#ffffffff"),"text-color-secondary":new B("#ffffff77"),"text-color-detail":new B("#ffffff44"),"text-color-disabled":new B("#ffffff88"),"primary-bg":new B("#1b0131ff"),"primary-border":new B("#1e0136bb"),"primary-bg-active":new B("#2f0057ff"),"primary-bg-hover":new B("#230140ff"),"navbar-bg":new B("#18012cff"),"navbar-bg-inactive":new B("#10011dff"),"window-bg":new B("#18012cff"),"window-border":new B("#00000000"),"secondary-bg":new B("#160127ff"),"secondary-border":new B("#18012bbb"),"secondary-bg-active":new B("#310a52ff"),"secondary-bg-hover":new B("#25033fff"),"editable-overlay-hover":new B("#e79dff1a"),"editable-overlay-active":new B("#e79dff33"),"input-bg":new B("#000000ff"),"input-bg-active":new B("#000000ff"),"input-bg-hover":new B("#000000ff"),"input-border":new B("#391f4f77"),"widget-bg":new B("#00000088"),"tooltip-bg":new B("#18012cee"),"editor-bg":new B("#0b0014ff")},nord:{"accent-color":new B("#1783d0ff"),"text-color":new B("#d9dee8ff"),"text-color-secondary":new B("#d9dee878"),"text-color-detail":new B("#d9dee845"),"text-color-disabled":new B("#d9dee887"),"primary-bg":new B("#2e3440ff"),"primary-border":new B("#323946ba"),"primary-bg-active":new B("#636d83ff"),"primary-bg-hover":new B("#485061ff"),"navbar-bg":new B("#292e39ff"),"navbar-bg-inactive":new B("#2f333cff"),"window-bg":new B("#292e39ff"),"window-border":new B("#00000000"),"secondary-bg":new B("#242933ff"),"secondary-border":new B("#272d38ba"),"secondary-bg-active":new B("#444d5fff"),"secondary-bg-hover":new B("#3f4755ff"),"editable-overlay-hover":new B("#ffffff1a"),"editable-overlay-active":new B("#ffffff33"),"input-bg":new B("#1212124f"),"input-bg-active":new B("#141414ff"),"input-bg-hover":new B("#171717ff"),"input-border":new B("#121212ff"),"widget-bg":new B("#00020e87"),"tooltip-bg":new B("#292e39ed"),"editor-bg":new B("#18191cff")},light:{"accent-color":new B("#ff594cff"),"text-color":new B("#000000ff"),"text-color-secondary":new B("#00000078"),"text-color-detail":new B("#00000045"),"text-color-disabled":new B("#00000087"),"primary-bg":new B("#ffffffff"),"primary-border":new B("#b5b5b5ff"),"primary-bg-active":new B("#ebebebff"),"primary-bg-hover":new B("#ffd4d1ff"),"navbar-bg":new B("#edededff"),"navbar-bg-inactive":new B("#d1d1d1ff"),"window-bg":new B("#edededff"),"window-border":new B("#00000000"),"secondary-bg":new B("#d9d9d9ff"),"secondary-border":new B("#c7c7c7ff"),"secondary-bg-active":new B("#f0f0f0ff"),"secondary-bg-hover":new B("#e3e3e3ff"),"editable-overlay-hover":new B("#ff594c3d"),"editable-overlay-active":new B("#ff594c73"),"input-bg":new B("#ebebebff"),"input-bg-active":new B("#e0e0e0ff"),"input-bg-hover":new B("#ffffffff"),"input-border":new B("#9e9e9eff"),"widget-bg":new B("#f7f7f7e5"),"tooltip-bg":new B("#ffffffff"),"editor-bg":new B("#cfcfcfff")},rust:{"accent-color":new B("#b37100ff"),"text-color":new B("#ffd7bdf2"),"text-color-secondary":new B("#ffd7bd78"),"text-color-detail":new B("#ffd7bd45"),"text-color-disabled":new B("#ffd7bd87"),"primary-bg":new B("#3c2e2aff"),"primary-border":new B("#42332eff"),"primary-bg-active":new B("#68524bff"),"primary-bg-hover":new B("#4e3c37ff"),"navbar-bg":new B("#362926ff"),"navbar-bg-inactive":new B("#241b19ff"),"window-bg":new B("#58413cff"),"window-border":new B("#00000000"),"secondary-bg":new B("#40302ba1"),"secondary-border":new B("#46352fff"),"secondary-bg-active":new B("#614a42ff"),"secondary-bg-hover":new B("#533e38ff"),"editable-overlay-hover":new B("#fff8e01a"),"editable-overlay-active":new B("#fff8e033"),"input-bg":new B("#231515ff"),"input-bg-active":new B("#271717ff"),"input-bg-hover":new B("#2e1b1bff"),"input-border":new B("#4b413fff"),"widget-bg":new B("#311e1cdd"),"tooltip-bg":new B("#362926ff"),"editor-bg":new B("#181211ff")},tron:{"accent-color":new B("#00ccffff"),"text-color":new B("#ffffffff"),"text-color-secondary":new B("#ffffffe4"),"text-color-detail":new B("#ffffff5b"),"text-color-disabled":new B("#ffffff88"),"primary-bg":new B("#000000ff"),"primary-border":new B("#ff7b00c9"),"primary-bg-active":new B("#00e1ff98"),"primary-bg-hover":new B("#ff751a5a"),"navbar-bg":new B("#000000ff"),"navbar-bg-inactive":new B("#000000ff"),"window-bg":new B("#000000ff"),"window-border":new B("#ff880085"),"secondary-bg":new B("#121212ff"),"secondary-border":new B("#ff8800aa"),"secondary-bg-active":new B("#00e1ffa3"),"secondary-bg-hover":new B("#ff7e145a"),"editable-overlay-hover":new B("#ffffff1a"),"editable-overlay-active":new B("#ffffff33"),"input-bg":new B("#000000ff"),"input-bg-active":new B("#000000ff"),"input-bg-hover":new B("#000000ff"),"input-border":new B("#1e1e1eff"),"widget-bg":new B("#000000ad"),"tooltip-bg":new B("#000000ff"),"editor-bg":new B("#000000ff")},gilded:{"accent-color":new B("#ffc014ff"),"text-color":new B("#e6e6e6ff"),"text-color-secondary":new B("#ffffff6b"),"text-color-detail":new B("#e6e6e645"),"text-color-disabled":new B("#e6e6e687"),"primary-bg":new B("#232325ff"),"primary-border":new B("#272729ff"),"primary-bg-active":new B("#ffc0145b"),"primary-bg-hover":new B("#ffc01421"),"navbar-bg":new B("#202021ff"),"navbar-bg-inactive":new B("#151516ff"),"window-bg":new B("#202021ff"),"window-border":new B("#00000000"),"secondary-bg":new B("#1c1c1eff"),"secondary-border":new B("#1f1f21ff"),"secondary-bg-active":new B("#1f1f21ff"),"secondary-bg-hover":new B("#242427ff"),"editable-overlay-hover":new B("#ffffff1a"),"editable-overlay-active":new B("#ffffff33"),"input-bg":new B("#0d0d0dff"),"input-bg-active":new B("#0e0e0eff"),"input-bg-hover":new B("#111111ff"),"input-border":new B("#0e0e0eff"),"widget-bg":new B("#171717db"),"tooltip-bg":new B("#202021ff"),"editor-bg":new B("#0e0e0fff")}};class Fe{static _themes=Yi;static _userThemes={};static _initialized=!1;static style;static currentTheme;static initialize(){this._createThemeStyle(),this._loadUserThemes(),this._initialized=!0}static _createThemeStyle(){const e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e),this.style=e}static _loadUserThemes(){let e={};try{e=JSON.parse(localStorage.getItem("themes")??"{}")}catch{console.warn("Error loading user themes")}const t={};for(const[n,a]of Object.entries(e))t[n]=this.validateTheme(a);this._userThemes=t}static _saveUserThemes(){const e=Object.fromEntries(Object.entries(this._userThemes).map(([t,n])=>[t,this.convertThemeToString(n)]));localStorage.setItem("themes",JSON.stringify(e))}static validateTheme(e){const t={...Yi.default};if(typeof e!="object")return t;for(const n of zl)if(e[n]!==void 0)try{t[n]=new B(e[n])}catch{console.warn(`Invalid color ${e[n]} for ${n}`)}return t}static getThemes(){return{...this._themes,...this._userThemes}}static getBuiltinThemes(){return this._themes}static getUserThemes(){return this._userThemes}static loadTheme(e){this._initialized||this.initialize();let t=this.getThemes()[e];t||(ce.createFormatted("Error loading theme: Invalid theme id","error"),t=Yi.default),b.general.theme=e,this._applyTheme(t)}static _applyTheme(e){const t=`body{${zl.map(n=>`--${n}: ${(e[n]??Yi.default[n]).toHexa()};`).join("")}}`;this.style.innerHTML=t,this.currentTheme={...e},ie.emit("themeChanged")}static loadThemeFromColors(e){this._applyTheme(this.validateTheme(e))}static getCurrentTheme(){return this.currentTheme}static convertThemeToString(e){return Object.fromEntries(Object.entries(e).map(([t,n])=>[t,n.toHexa()]))}static exportCurrentTheme(e){return e={code:!1,spaces:!1,...e},e.code?JSON.stringify(Object.fromEntries(Object.entries(this.currentTheme).map(([t,n])=>[t,`^new Color('${n.toHexa()}')^`])),null,e.spaces?2:0).replaceAll('"^',"").replaceAll('^"',""):JSON.stringify(this.convertThemeToString(this.currentTheme),null,e.spaces?2:0)}static createUserTheme(e,t){this.getThemes()[e]===void 0&&(t?this._userThemes[e]={...t}:this._userThemes[e]={...Yi.default},this._saveUserThemes())}static setUserTheme(e,t){this._userThemes[e]!==void 0&&(this._userThemes[e]={...t},this._saveUserThemes())}static deleteUserTheme(e){this._userThemes[e]!==void 0&&(delete this._userThemes[e],this.loadTheme("default"),this._saveUserThemes())}static renameUserTheme(e,t){this._userThemes[e]!==void 0&&this.getThemes()[t]===void 0&&(this._userThemes[t]=this._userThemes[e],delete this._userThemes[e],this._saveUserThemes())}static parseThemeText(e){let t;try{t=JSON.parse(e)}catch{return null}return this.validateTheme(t)}static getColor(e){return this.currentTheme?.[e]??Yi.default[e]}}function go(i,e,t){return(i<<16)+(e<<8)+t}function bo(i,e){let t=i>>16,n=i>>8&255,a=i&255;return t=Te(Math.round(t*e),0,255),n=Te(Math.round(n*e),0,255),a=Te(Math.round(a*e),0,255),go(t,n,a)}function of(i,e){let t=i>>16,n=i>>8&255,a=i&255;return t=Te(Math.round(t+e),0,255),n=Te(Math.round(n+e),0,255),a=Te(Math.round(a+e),0,255),go(t,n,a)}function Gs(i){return(i.red+i.green+i.blue)/3}function En(i,e,t){const[n,a,r]=i.match(/\w\w/g).map(d=>parseInt(d,16)),[s,o,l]=e.match(/\w\w/g).map(d=>parseInt(d,16)),u=Math.round(n+(s-n)*t).toString(16).padStart(2,"0"),f=Math.round(a+(o-a)*t).toString(16).padStart(2,"0"),c=Math.round(r+(l-r)*t).toString(16).padStart(2,"0");return"#"+u+f+c}function It(i,e,t){const n=Ze(i.red,e.red,t),a=Ze(i.green,e.green,t),r=Ze(i.blue,e.blue,t),s=Ze(i.alpha,e.alpha,t);return new B([n,a,r,s])}const jn=new Map;ie.on("themeChanged",()=>{for(const[i,e]of jn.entries()){const t=Fe.getColor(i);e.forEach(n=>{n.destroyed||(n.tint=t.toNumber(),n.alpha=t.alpha)}),jn.set(i,e.filter(n=>!n.destroyed))}});function ze(i,e){jn.has(e)||jn.set(e,[]),jn.get(e).push(i);const t=Fe.getColor(e);i.tint=t.toNumber(),i.alpha=t.alpha}function ss(i){const{r:e,g:t,b:n,a}=i.toRgba(),r=Math.max(e,t,n),s=Math.min(e,t,n);let o=0,l=0;const u=(r+s)/2;if(r==s)o=l=0;else{const f=r-s;switch(l=u>.5?f/(2-r-s):f/(r+s),r){case e:o=(t-n)/f+(t<n?6:0);break;case t:o=(n-e)/f+2;break;case n:o=(e-t)/f+4;break}o/=6}return[o,l,u,a]}function pa(i){const{r:e,g:t,b:n,a}=i.toRgba(),r=Math.max(e,t,n),s=Math.min(e,t,n);let o=0,l=0;const u=r,f=r-s;if(l=r==0?0:f/r,r==s)o=0;else{switch(r){case e:o=(t-n)/f+(t<n?6:0);break;case t:o=(n-e)/f+2;break;case n:o=(e-t)/f+4;break}o/=6}return[o,l,u,a]}function ea(i,e){try{return new B(i)}catch{return new B("black")}}class pu extends HTMLDivElement{colorElement;set color(e){this.colorElement.style.background=e.toHexa()}}function os(){const i=document.createElement("div");i.classList.add("color-picker-transparent"),Object.setPrototypeOf(i,pu.prototype);const e=document.createElement("div");return e.style.width="100%",e.style.height="100%",i.colorElement=e,i.appendChild(e),i}class gn extends HTMLDivElement{inputs;opts;getValue;onupdate;static create(e){const t=document.createElement("div");Object.setPrototypeOf(t,gn.prototype),t.opts=e.inputs,t.inputs={},t.getValue=e.getValue.bind(t),t.onupdate=e.onupdate,t.classList.add("color-format");const n=document.createElement("div");n.classList.add("color-format-label"),n.innerText=e.label;const a=document.createElement("div");return a.classList.add("color-format-inputs"),Object.entries(e.inputs).forEach(([r,s])=>{const o=document.createElement("input");o.type="text";let l="";o.onfocus=()=>{l=o.value},o.onkeydown=u=>{u.key=="Enter"&&(o.blur(),u.preventDefault()),u.key=="Escape"&&(o.value=l,o.blur(),u.stopImmediatePropagation())},o.oninput=()=>{s.isValid(o.value)!==null&&t.onupdate?.(t.getValue())},o.onblur=()=>{const u=s.isValid(o.value);u===null?o.value=l:o.value=u,t.onupdate?.(t.getValue())},t.inputs[r]=o,a.appendChild(o)}),t.replaceChildren(n,a),t}setValue(e){Object.entries(this.inputs).forEach(([t,n])=>{document.activeElement!=n&&(n.value=this.opts[t].setValue(e))})}}const Nt=(i,e,t)=>n=>{t!==void 0&&n.endsWith(t)&&(n=n.slice(0,n.length-t.length));let a;try{a=parseInt(n)}catch{return null}return Te(a,i,e)+""},Ht=(i,e,t,n)=>{let a;n!==void 0&&i.endsWith(n)&&(i=i.slice(0,i.length-n.length));try{a=parseInt(i)}catch{return e}return Te(a,e,t)};class ir extends pu{_value;_hue=0;_sat=0;_val=0;_alp=1;popup;matrix;matrixDot;matrixDragging=!1;hueDragging=!1;hueThumb;alphaDragging=!1;alphaBg;alphaThumb;previewNew;formats=[];onColorChange;static create(e){const t=os();return Object.setPrototypeOf(t,ir.prototype),t.value=ea(e.value),t.classList.add("color-picker"),t.formats=[],e.height!==void 0&&(t.style.height=e.height/16+"rem"),e.width!==void 0&&(t.style.width=e.width/16+"rem"),t.addEventListener("click",()=>{t.createPopup()}),t}updatePreview(){this.color=this._value}get value(){return this._value}set value(e){this._value=e;const t=pa(this._value);this._hue=t[0],this._sat=t[1],this._val=t[2],this._alp=t[3],this.updatePreview(),this.updatePopup()}get hue(){return this._hue}set hue(e){this._hue=e,this.updateColor()}get sat(){return this._sat}set sat(e){this._sat=e,this.updateColor()}get val(){return this._val}set val(e){this._val=e,this.updateColor()}get alpha(){return this._alp}set alpha(e){this._alp=e,this.updateColor()}updateColor(){this._value=new B({h:this._hue*360,s:this._sat*100,v:this._val*100,a:this._alp}),this.updatePreview(),this.updatePopup()}createPopup(){if(this.popup){this.closePopup();return}const e=document.createElement("div");e.classList.add("color-picker-popup");const t=document.createElement("div");t.classList.add("color-picker-area");const[n,a]=this.createMatrix();this.matrix=n,this.matrixDot=a,a.style.background="#f00";const[r,s]=this.createSlider({ondrag:()=>this.hueDragging=!0,offdrag:()=>this.hueDragging=!1,change:_=>{this.hue=_,this.onColorChange?.(this._value)}});this.hueThumb=s,r.style.background="linear-gradient(to right, red 0%, #ff0 17%, lime 33%, cyan 50%, blue 66%, #f0f 83%, red 100%)";const[o,l]=this.createSlider({ondrag:()=>this.alphaDragging=!0,offdrag:()=>this.alphaDragging=!1,change:_=>{this.alpha=_,this.onColorChange?.(this._value)}});this.alphaThumb=l,o.classList.add("color-picker-transparent");const u=document.createElement("div");u.classList.add("color-slider"),o.appendChild(u),this.alphaBg=u,t.replaceChildren(n,r,o);const f=document.createElement("div");f.classList.add("color-picker-area");const c=gn.create({label:"HEX",inputs:{hex:{setValue:_=>_.alpha!=1?_.toHexa():_.toHex(),isValid:_=>{const F=/#?([0-9a-fA-F]+)/.exec(_);return F&&[3,4,6,8].includes(F[1].length)?(_[0]!="#"&&(_="#"+_),_):null}}},getValue(){let _=this.inputs.hex.value;return _[0]!="#"&&(_="#"+_),new B(_)},onupdate:_=>{this.value=_,this.onColorChange?.(this._value)}});this.formats.push(c),f.appendChild(c);const d=gn.create({label:"RGBA",inputs:{r:{setValue:_=>Math.round(_.red*255).toString(),isValid:Nt(0,255)},g:{setValue:_=>Math.round(_.green*255).toString(),isValid:Nt(0,255)},b:{setValue:_=>Math.round(_.blue*255).toString(),isValid:Nt(0,255)},a:{setValue:_=>Math.round(_.alpha*100)+"%",isValid:Nt(0,100,"%")}},getValue(){return new B({r:Ht(this.inputs.r.value,0,255),g:Ht(this.inputs.g.value,0,255),b:Ht(this.inputs.b.value,0,255),a:Ht(this.inputs.a.value,0,100,"%")/100})},onupdate:_=>{this.value=_,this.onColorChange?.(this._value)}});this.formats.push(d),f.appendChild(d);const h=gn.create({label:"HSVA",inputs:{h:{setValue:_=>Math.round(pa(_)[0]*360)+"º",isValid:Nt(0,360,"º")},s:{setValue:_=>Math.round(pa(_)[1]*100)+"%",isValid:Nt(0,100,"%")},v:{setValue:_=>Math.round(pa(_)[2]*100)+"%",isValid:Nt(0,100,"%")},a:{setValue:_=>Math.round(_.alpha*100)+"%",isValid:Nt(0,100,"%")}},getValue(){return new B({h:Ht(this.inputs.h.value,0,360,"º"),s:Ht(this.inputs.s.value,0,100,"%"),v:Ht(this.inputs.v.value,0,100,"%"),a:Ht(this.inputs.a.value,0,100,"%")/100})},onupdate:_=>{this.value=_,this.onColorChange?.(this._value)}});this.formats.push(h),f.appendChild(h);const p=gn.create({label:"HSLA",inputs:{h:{setValue:_=>Math.round(ss(_)[0]*360)+"º",isValid:Nt(0,360,"º")},s:{setValue:_=>Math.round(ss(_)[1]*100)+"%",isValid:Nt(0,100,"%")},l:{setValue:_=>Math.round(ss(_)[2]*100)+"%",isValid:Nt(0,100,"%")},a:{setValue:_=>Math.round(_.alpha*100)+"%",isValid:Nt(0,100,"%")}},getValue(){return new B({h:Ht(this.inputs.h.value,0,360,"º"),s:Ht(this.inputs.s.value,0,100,"%"),l:Ht(this.inputs.l.value,0,100,"%"),a:Ht(this.inputs.a.value,0,100,"%")/100})},onupdate:_=>{this.value=_,this.onColorChange?.(this._value)}});this.formats.push(p),f.appendChild(p);const m=document.createElement("div");m.classList.add("color-picker-preview");const g=os(),y=os();y.color=this._value,g.color=this._value,m.replaceChildren(g,y),this.previewNew=g,f.appendChild(m),e.replaceChildren(t,f),this.popup=e,this.updatePopup();const x=this._value,w=_=>{_.key=="Escape"&&(_.stopImmediatePropagation(),window.removeEventListener("keydown",w),window.removeEventListener("mousedown",C),this.closePopup(),this.value=x,this.onColorChange?.(this._value))},C=_=>{e.contains(_.target)||(window.removeEventListener("keydown",w),window.removeEventListener("mousedown",C),this.closePopup())};window.addEventListener("keydown",w),window.addEventListener("mousedown",C),document.getElementById("popups").appendChild(e),setTimeout(()=>this.movePosition())}updatePopup(){if(!this.popup)return;this.matrix.style.backgroundColor=`hsl(${this._hue*360} 100% 50%)`,this.matrixDot.style.backgroundColor=this._value.toHex(),this.matrixDragging||(this.matrixDot.style.left=this._sat*200/16+"rem",this.matrixDot.style.top=(1-this._val)*200/16+"rem"),this.hueDragging||(this.hueThumb.style.left=this._hue*200/16+"rem");const e=`rgba(${this._value.red*255}, ${this._value.green*255}, ${this._value.blue*255}`;this.alphaBg.style.background=`linear-gradient(to right, ${e}, 0 ), ${e}, 1))`,this.alphaDragging||(this.alphaThumb.style.left=this._alp*200/16+"rem"),this.formats.forEach(t=>t.setValue(this._value)),this.previewNew.color=this._value}closePopup(){const e=this.popup;this.popup=void 0,e&&(e.classList.add("exiting"),setTimeout(()=>{e.remove()},500))}createMatrix(){const e=document.createElement("div");e.classList.add("color-matrix"),e.style.backgroundColor="#ff0000";const t=document.createElement("div");t.classList.add("color-matrix-x");const n=document.createElement("div");n.classList.add("color-matrix-y");const a=document.createElement("div");a.classList.add("color-matrix-dot"),e.appendChild(a),e.replaceChildren(t,n,a),e.onmousedown=o=>{window.addEventListener("mousemove",r),window.addEventListener("mouseup",s),r(o),this.matrixDragging=!0};const r=o=>{const l=e.getBoundingClientRect(),u=Te((o.clientX-l.left)/l.width,0,1),f=Te((o.clientY-l.top)/l.height,0,1);a.style.left=u*l.width+"px",a.style.top=f*l.height+"px",this._sat=u,this.val=1-f,this.onColorChange?.(this._value)},s=()=>{window.removeEventListener("mousemove",r),window.removeEventListener("mouseup",s),this.matrixDragging=!1};return[e,a]}createSlider(e){const t=document.createElement("div");t.classList.add("color-slider");const n=document.createElement("div");n.classList.add("color-slider-thumb"),t.appendChild(n),t.onmousedown=s=>{window.addEventListener("mousemove",a),window.addEventListener("mouseup",r),a(s),e.ondrag?.(),this.onColorChange?.(this._value)};const a=s=>{const o=t.getBoundingClientRect(),l=Te((s.clientX-o.left)/o.width,0,1);n.style.left=l*o.width+"px",e.change(l)},r=()=>{window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",r),e.offdrag?.()};return[t,n]}movePosition(){const e=this.getBoundingClientRect(),t=e.left+e.width/2-this.popup.clientWidth/2,n=e.top+e.height+10,a=15,r=window.innerWidth-this.popup.clientWidth-15;this.popup.style.left=`${Te(t,a,r)}px`,this.popup.style.top=`${n}px`,n+this.popup.clientHeight>window.innerHeight-15&&(this.popup.style.transformOrigin="bottom center",this.popup.style.top=`${e.top-this.popup.clientHeight-10}px`)}isActive(){return this.popup!==void 0}}class Fi{view;slider;text;options;constructor(e,t){this.view=e,this.options=t,this.view.classList.add("slider");const n=document.createElement("input");n.classList.add("slider-input"),n.type="range",n.min=t.min.toString(),n.max=t.max.toString(),n.step=t.step.toString(),n.value=(t.value??(t.min+t.max)/2).toString(),n.oninput=()=>{a.innerText=this.formatValue(parseFloat(n.value))+"",this.options.onChange?.(parseFloat(n.value))},t.width!==void 0&&(n.style.width=t.width/16+"rem"),this.slider=n,e.appendChild(n);const a=document.createElement("div");a.innerText=this.formatValue(parseFloat(n.value))+"",a.style.width=`${(this.options.displayWidth??32)/16}rem`,this.text=a,e.appendChild(a)}get value(){return parseFloat(this.slider.value)}setValue(e){this.slider.value=e+"",this.text.innerText=this.formatValue(parseFloat(this.slider.value))+""}static create(e){return new Fi(document.createElement("div"),e)}formatValue(e){return this.options.transformer?this.options.transformer(e):this.options.precision===void 0?he(e,3).toString():he(e,this.options.precision).toFixed(this.options.precision)}}function mu(i,e,t){switch(e.type){case"checkbox":{const n=document.createElement("input"),a=e.onChange;return n.type="checkbox",n.checked=t,n.onblur=null,n.onchange=()=>{a?.(i,n.checked)},n.classList.add("pref-input","right"),n.onkeydown=r=>{r.key=="Enter"&&n.blur()},n}case"dropdown":if(e.advanced){const n=e.transformers.deserialize,a=e.transformers.serialize,r=e.onChange,s=gi.create(e.items,a(t));return s.onChange(o=>{r?.(i,n(o))}),s.view}else{const n=e.onChange,a=gi.create(e.items,t);return a.onChange(r=>{n?.(i,r)}),a.view}case"number":{const n=e.transformers?.deserialize??(o=>o),a=e.transformers?.serialize??(o=>o),r=e.onChange,s=ht.create({value:a(t),...e,onchange:o=>{if(!o){s.value=a(o);return}r?.(i,n(o))}});return s.view}case"slider":{const n=e.transformers?.deserialize??(c=>c),a=e.transformers?.serialize??(c=>c),r=e.onChange,s=document.createElement("div");s.style.display="flex",s.style.alignItems="center";const o=document.createElement("input");o.type="range",o.min=e.min?.toString()??"",o.max=e.max?.toString()??"",o.step=e.step?.toString()??"1",o.value=a(t).toString();const l=document.createElement("input");l.type="text",l.value=(Math.round(a(t)*1e3)/1e3).toString();const u=e.hardMin??e.min??-Number.MAX_VALUE,f=e.hardMax??e.max??Number.MAX_VALUE;return l.onblur=()=>{let c=Yn(l.value);if(c===null){l.value=(Math.round(a(t)*1e3)/1e3).toString();return}c=Te(c,u,f),l.value=he(c,3).toString(),l.blur(),l.value==""&&(l.value=a(c).toString()),o.value=c.toString(),r?.(i,n(c))},o.oninput=()=>{const c=parseFloat(o.value);l.value=he(c,3).toString(),r?.(i,n(c))},l.style.width="3rem",l.onkeydown=c=>{c.key=="Enter"&&l.blur()},s.appendChild(o),s.appendChild(l),s}case"display-slider":{const n=e.transformers?.deserialize??(l=>l),a=e.transformers?.serialize??(l=>l),r=e.transformers?.display??(l=>l),s=e.onChange;return Fi.create({...e,value:a(t),transformer:l=>r(l),onChange:l=>{s?.(i,n(l))}}).view}case"text":{const n=e.onChange,a=document.createElement("input");return a.type="text",a.value=t.toString(),a.onblur=()=>{n?.(i,a.value)},a.onkeydown=r=>{r.key=="Enter"&&a.blur()},a}case"color":{const n=e.onChange,a=ir.create({value:t});return a.onColorChange=r=>{n?.(i,r.toHexa())},a}}}class lf extends ct{app;captureOptions={aspectRatio:4/3,videoHeight:720,fps:60,bitrate:4e6,playbackRate:1,assistTick:!1,metronome:!1,hideBarlines:!1};startBeat=0;endBeat=1;presetDropdown;exportButton;optionsView;captureView;captureCanvas;videoContainer;progressLabel;progressBar;currentCapture;videoURL;stopButton;returnButton;downloadButton;estimateInterval;regionHandler;constructor(e){super({title:"Export Recording",width:600,height:400,disableClose:!1,win_id:"capture",blocking:!1}),this.app=e,this.app.chartManager.startRegion!==void 0&&this.app.chartManager.endRegion!==void 0?(this.startBeat=this.app.chartManager.startRegion,this.endBeat=this.app.chartManager.endRegion):(this.startBeat=0,this.endBeat=this.app.chartManager.loadedChart.getLastBeat()),this.initView()}onClose(){ie.off("regionChanged",this.regionHandler),this.currentCapture&&this.currentCapture.stop()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");if(e.classList.add("padding"),this.initOptionsView(),this.initCaptureView(),e.replaceChildren(this.optionsView,this.captureView),!VideoEncoder||!AudioEncoder){const t=document.createElement("div");t.classList.add("capture-error");const n=document.createElement("h3");n.innerText="Your browser doesn't seem to support web encoding.";const a=document.createElement("p");a.innerText="Please try a different browser or use the desktop app.",t.replaceChildren(n,a),this.optionsView.style.filter="blur(10px)",this.optionsView.style.pointerEvents="none",e.appendChild(t),this.exportButton.disabled=!0}this.viewElement.appendChild(e)}initOptionsView(){const e=document.createElement("div");e.classList.add("capture-options-container");const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="row",t.style.gap="2rem",t.style.alignItems="flex-start";const n=document.createElement("div");n.classList.add("capture-options");const a=document.createElement("div");a.classList.add("capture-options-label"),a.innerText="Record Range";const{item:r,update:s}=this.buildBeatSecondInput("Start",m=>{this.startBeat=m,this.startBeat>this.endBeat&&(this.startBeat=this.endBeat,s(this.startBeat)),this.updateSizeEstimate()}),{item:o,update:l}=this.buildBeatSecondInput("End",m=>{this.endBeat=m,this.endBeat<this.startBeat&&(this.endBeat=this.startBeat,l(this.endBeat)),this.updateSizeEstimate()});s(this.startBeat),l(this.endBeat);const u=(m,g)=>{this.startBeat=m,this.endBeat=g,s(m),l(g)};this.regionHandler=u.bind(this),ie.on("regionChanged",this.regionHandler),n.replaceChildren(a,r,o);let f=this.buildOptions("Video Options",Nl);const c=this.buildOptions("View Options",ch),d=document.createElement("div");d.classList.add("pref-item");const h=document.createElement("div");h.classList.add("pref-item-label","label"),h.innerText="Quality Preset",this.presetDropdown=gi.create(["Minimal","Low","Medium","High"],"Medium"),this.presetDropdown.onChange(m=>{const g=()=>{const y=this.buildOptions("Video Options",Nl);y.firstElementChild?.insertAdjacentElement("afterend",d),f.replaceWith(y),f=y,this.updateSizeEstimate()};switch(m){case"Minimal":this.captureOptions={...this.captureOptions,videoHeight:360,fps:24,bitrate:1e6},g();break;case"Low":this.captureOptions={...this.captureOptions,videoHeight:480,fps:30,bitrate:25e5},g();break;case"Medium":this.captureOptions={...this.captureOptions,videoHeight:720,fps:60,bitrate:4e6},g();break;case"High":this.captureOptions={...this.captureOptions,videoHeight:1080,fps:60,bitrate:8e6},g();break}}),f.firstElementChild?.insertAdjacentElement("afterend",d),d.replaceChildren(h,this.presetDropdown.view),t.replaceChildren(f,c);const p=document.createElement("button");p.innerText="Export Recording",p.classList.add("confirm"),p.onclick=async()=>{this.startCapture()},this.exportButton=p,e.replaceChildren(n,t,p),this.optionsView=e,this.updateSizeEstimate()}initCaptureView(){const e=document.createElement("div");e.classList.add("capture-view");const t=document.createElement("div");t.classList.add("capture-video-container");const n=document.createElement("canvas");n.width=560,n.height=320,n.style.width="35rem",n.style.height="20rem",n.style.filter="brightness(0.6) saturate(0.5)",t.appendChild(n);const a=document.createElement("div");a.classList.add("capture-video-overlay");const r=document.createElement("div");r.innerText="Rendering...",r.style.textAlign="center",this.progressLabel=r,a.appendChild(r);const s=document.createElement("div");s.classList.add("capture-progress-bar"),this.progressBar=s,a.appendChild(s),t.appendChild(a);const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="row",o.style.gap="1rem",o.style.justifyContent="center",o.style.marginTop="1rem";const l=document.createElement("button");l.innerText="Stop exporting",l.classList.add("delete"),l.style.flex="1",l.onclick=()=>{this.currentCapture&&(this.currentCapture.stop(),l.disabled=!0)},this.stopButton=l;const u=document.createElement("button");u.innerText="Export another video",u.style.flex="1",u.onclick=()=>{this.captureView.style.display="none",this.optionsView.style.display="",this.videoContainer.childNodes.forEach(c=>{c.style.display="",c instanceof HTMLVideoElement&&(URL.revokeObjectURL(c.src),c.pause(),c.remove())})},u.style.display="none",this.returnButton=u;const f=document.createElement("button");f.innerText="Download video",f.style.flex="1",f.classList.add("confirm"),f.onclick=()=>{if(this.videoURL){const c=document.createElement("a");c.href=this.videoURL;const d=new Date;c.download=`SME-${d.toISOString().slice(0,10)}-${d.toTimeString().slice(0,8).replaceAll(":","-")}.mp4`,c.click()}},f.style.display="none",this.downloadButton=f,o.replaceChildren(l,u,f),e.replaceChildren(t,o),this.captureCanvas=n,this.videoContainer=t,this.captureView=e,e.style.display="none"}startCapture(){Ae.disableKeybinds(),this.stopButton.disabled=!1,this.stopButton.style.display="",this.returnButton.style.display="none",this.downloadButton.style.display="none",this.setDisableClose(!0),this.setBlocking(!0);const e=this.captureCanvas.getContext("2d"),t=[];let n=-1,a=0;this.estimateInterval=setInterval(()=>{if(!this.currentCapture)return;const r=this.currentCapture.currentRenderFrame-this.currentCapture.currentEncodeQueue;t.push(r-a),a=r,t.length>20&&t.shift();const o=t.reduce((u,f)=>u+f,0)/t.length,l=this.currentCapture.totalFrames-r;n=Math.round(l/o)},1e3),this.captureView.style.display="",this.optionsView.style.display="none";try{const r=new af(this.app,{...this.captureOptions,startTime:this.app.chartManager.loadedChart.getSecondsFromBeat(this.startBeat)-1,endTime:this.app.chartManager.loadedChart.getSecondsFromBeat(this.endBeat)+1,updateCallback:s=>{const o=(s.currentRenderFrame-s.currentEncodeQueue)/s.totalFrames;this.progressBar.style.background=`linear-gradient(90deg, var(--accent-color) 0 ${o*100}%, var(--input-bg) ${o*100}% 100%)`;const l=s.currentRenderFrame==s.totalFrames?"Encoding":"Rendering";this.progressLabel.innerText=`${l}...`,n>=0&&l==="Rendering"&&(this.progressLabel.innerText+=` (est. ${ud(n)})`),!(!e||!s.currentVideoFrame)&&(e.clearRect(0,0,this.captureCanvas.width,this.captureCanvas.height),createImageBitmap(s.currentVideoFrame).then(u=>{const f=u.height/this.captureCanvas.height,c=u.width/f,d=(this.captureCanvas.width-c)/2;e.drawImage(u,0,0,u.width,u.height,d,0,c,this.captureCanvas.height)}))},onFinish:s=>{this.stopCapture(s)}});this.currentCapture=r,r.start().catch(s=>{console.error("Error starting capture:",s),this.stopCapture("")})}catch(r){console.error("Error starting capture:",r),this.stopCapture("")}}stopCapture(e){if(this.setDisableClose(!1),this.setBlocking(!1),Ae.enableKeybinds(),this.videoURL=e,this.stopButton.style.display="none",this.returnButton.style.display="",e!=""?(this.downloadButton.style.display="",this.downloadButton.innerText=`Download video (${Po(this.currentCapture.size)})`):this.progressLabel.innerText="Failed to export video! Check console for details.",clearInterval(this.estimateInterval),this.currentCapture=void 0,this.closed||e=="")return;const t=document.createElement("video");t.src=e,t.controls=!0,t.style.height="20rem",this.videoContainer.childNodes.forEach(n=>{n.style.display="none"}),this.videoContainer.appendChild(t)}buildBeatSecondInput(e,t){const n=document.createElement("div");n.classList.add("pref-item");const a=document.createElement("div");a.classList.add("pref-item-label","label"),a.innerText=e,n.appendChild(a);const r=document.createElement("div"),s=document.createElement("div");s.appendChild(document.createTextNode("Beat: "));const o=document.createElement("div");o.appendChild(document.createTextNode("Second: ")),s.style.display="flex",o.style.display="flex",s.style.gap="0.85rem",o.style.gap="0.85rem",s.style.flexDirection="row",o.style.flexDirection="row",r.style.display="flex",r.style.flexDirection="row",r.style.gap="1.5rem";const l=c=>{const d=this.app.chartManager.loadedChart.getSecondsFromBeat(c);f.value=d,u.value=c},u=ht.create({value:0,onchange:c=>{c!==void 0&&(l(c),t(c))}}),f=ht.create({value:0,onchange:c=>{c!==void 0&&(l(this.app.chartManager.loadedChart.getBeatFromSeconds(c)),t(this.app.chartManager.loadedChart.getBeatFromSeconds(c)))}});return r.replaceChildren(s,o),s.appendChild(u.view),o.appendChild(f.view),n.appendChild(r),{item:n,update:l}}updateSizeEstimate(){const e=this.captureOptions.bitrate,t=this.app.chartManager.loadedChart.getSecondsFromBeat(this.endBeat)-this.app.chartManager.loadedChart.getSecondsFromBeat(this.startBeat)+2,n=Math.round(e*t/8);this.exportButton.innerText=`Export Recording (Est. ${Po(n)})`}buildOptions(e,t){const n=document.createElement("div");n.classList.add("capture-options");const a=document.createElement("div");return a.classList.add("capture-options-label"),a.innerText=e,n.appendChild(a),Object.entries(t).forEach(([r,s])=>{const o=document.createElement("div");o.classList.add("pref-item");const l=document.createElement("div");l.classList.add("pref-item-label","label"),l.innerText=s.label,o.appendChild(l);const u=mu(this.app,{...s.input,onChange:(f,c)=>{Object.assign(this.captureOptions,{[r]:c}),["videoHeight","fps","bitrate"].includes(r)&&this.presetDropdown.setSelected("Custom"),this.updateSizeEstimate()}},this.captureOptions[r]);o.appendChild(u),n.appendChild(o)}),n}}const Ul={};function cf(i){let e=Ul[i];if(e)return e;e=Ul[i]=[];for(let t=0;t<128;t++){const n=String.fromCharCode(t);e.push(n)}for(let t=0;t<i.length;t++){const n=i.charCodeAt(t);e[n]="%"+("0"+n.toString(16).toUpperCase()).slice(-2)}return e}function Cn(i,e){typeof e!="string"&&(e=Cn.defaultChars);const t=cf(e);return i.replace(/(%[a-f0-9]{2})+/gi,function(n){let a="";for(let r=0,s=n.length;r<s;r+=3){const o=parseInt(n.slice(r+1,r+3),16);if(o<128){a+=t[o];continue}if((o&224)===192&&r+3<s){const l=parseInt(n.slice(r+4,r+6),16);if((l&192)===128){const u=o<<6&1984|l&63;u<128?a+="��":a+=String.fromCharCode(u),r+=3;continue}}if((o&240)===224&&r+6<s){const l=parseInt(n.slice(r+4,r+6),16),u=parseInt(n.slice(r+7,r+9),16);if((l&192)===128&&(u&192)===128){const f=o<<12&61440|l<<6&4032|u&63;f<2048||f>=55296&&f<=57343?a+="���":a+=String.fromCharCode(f),r+=6;continue}}if((o&248)===240&&r+9<s){const l=parseInt(n.slice(r+4,r+6),16),u=parseInt(n.slice(r+7,r+9),16),f=parseInt(n.slice(r+10,r+12),16);if((l&192)===128&&(u&192)===128&&(f&192)===128){let c=o<<18&1835008|l<<12&258048|u<<6&4032|f&63;c<65536||c>1114111?a+="����":(c-=65536,a+=String.fromCharCode(55296+(c>>10),56320+(c&1023))),r+=9;continue}}a+="�"}return a})}Cn.defaultChars=";/?:@&=+$,#";Cn.componentChars="";const Wl={};function uf(i){let e=Wl[i];if(e)return e;e=Wl[i]=[];for(let t=0;t<128;t++){const n=String.fromCharCode(t);/^[0-9a-z]$/i.test(n)?e.push(n):e.push("%"+("0"+t.toString(16).toUpperCase()).slice(-2))}for(let t=0;t<i.length;t++)e[i.charCodeAt(t)]=i[t];return e}function ca(i,e,t){typeof e!="string"&&(t=e,e=ca.defaultChars),typeof t>"u"&&(t=!0);const n=uf(e);let a="";for(let r=0,s=i.length;r<s;r++){const o=i.charCodeAt(r);if(t&&o===37&&r+2<s&&/^[0-9a-f]{2}$/i.test(i.slice(r+1,r+3))){a+=i.slice(r,r+3),r+=2;continue}if(o<128){a+=n[o];continue}if(o>=55296&&o<=57343){if(o>=55296&&o<=56319&&r+1<s){const l=i.charCodeAt(r+1);if(l>=56320&&l<=57343){a+=encodeURIComponent(i[r]+i[r+1]),r++;continue}}a+="%EF%BF%BD";continue}a+=encodeURIComponent(i[r])}return a}ca.defaultChars=";/?:@&=+$,-_.!~*'()#";ca.componentChars="-_.!~*'()";function yo(i){let e="";return e+=i.protocol||"",e+=i.slashes?"//":"",e+=i.auth?i.auth+"@":"",i.hostname&&i.hostname.indexOf(":")!==-1?e+="["+i.hostname+"]":e+=i.hostname||"",e+=i.port?":"+i.port:"",e+=i.pathname||"",e+=i.search||"",e+=i.hash||"",e}function Ha(){this.protocol=null,this.slashes=null,this.auth=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.pathname=null}const df=/^([a-z0-9.+-]+:)/i,hf=/:[0-9]*$/,ff=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,pf=["<",">",'"',"`"," ","\r",`
`,"	"],mf=["{","}","|","\\","^","`"].concat(pf),gf=["'"].concat(mf),Gl=["%","/","?",";","#"].concat(gf),ql=["/","?","#"],bf=255,jl=/^[+a-z0-9A-Z_-]{0,63}$/,yf=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,$l={javascript:!0,"javascript:":!0},Yl={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function wo(i,e){if(i&&i instanceof Ha)return i;const t=new Ha;return t.parse(i,e),t}Ha.prototype.parse=function(i,e){let t,n,a,r=i;if(r=r.trim(),!e&&i.split("#").length===1){const u=ff.exec(r);if(u)return this.pathname=u[1],u[2]&&(this.search=u[2]),this}let s=df.exec(r);if(s&&(s=s[0],t=s.toLowerCase(),this.protocol=s,r=r.substr(s.length)),(e||s||r.match(/^\/\/[^@\/]+@[^@\/]+/))&&(a=r.substr(0,2)==="//",a&&!(s&&$l[s])&&(r=r.substr(2),this.slashes=!0)),!$l[s]&&(a||s&&!Yl[s])){let u=-1;for(let p=0;p<ql.length;p++)n=r.indexOf(ql[p]),n!==-1&&(u===-1||n<u)&&(u=n);let f,c;u===-1?c=r.lastIndexOf("@"):c=r.lastIndexOf("@",u),c!==-1&&(f=r.slice(0,c),r=r.slice(c+1),this.auth=f),u=-1;for(let p=0;p<Gl.length;p++)n=r.indexOf(Gl[p]),n!==-1&&(u===-1||n<u)&&(u=n);u===-1&&(u=r.length),r[u-1]===":"&&u--;const d=r.slice(0,u);r=r.slice(u),this.parseHost(d),this.hostname=this.hostname||"";const h=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!h){const p=this.hostname.split(/\./);for(let m=0,g=p.length;m<g;m++){const y=p[m];if(y&&!y.match(jl)){let x="";for(let w=0,C=y.length;w<C;w++)y.charCodeAt(w)>127?x+="x":x+=y[w];if(!x.match(jl)){const w=p.slice(0,m),C=p.slice(m+1),_=y.match(yf);_&&(w.push(_[1]),C.unshift(_[2])),C.length&&(r=C.join(".")+r),this.hostname=w.join(".");break}}}}this.hostname.length>bf&&(this.hostname=""),h&&(this.hostname=this.hostname.substr(1,this.hostname.length-2))}const o=r.indexOf("#");o!==-1&&(this.hash=r.substr(o),r=r.slice(0,o));const l=r.indexOf("?");return l!==-1&&(this.search=r.substr(l),r=r.slice(0,l)),r&&(this.pathname=r),Yl[t]&&this.hostname&&!this.pathname&&(this.pathname=""),this};Ha.prototype.parseHost=function(i){let e=hf.exec(i);e&&(e=e[0],e!==":"&&(this.port=e.substr(1)),i=i.substr(0,i.length-e.length)),i&&(this.hostname=i)};const wf=Object.freeze(Object.defineProperty({__proto__:null,decode:Cn,encode:ca,format:yo,parse:wo},Symbol.toStringTag,{value:"Module"})),gu=/[\0-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,bu=/[\0-\x1F\x7F-\x9F]/,vf=/[\xAD\u0600-\u0605\u061C\u06DD\u070F\u0890\u0891\u08E2\u180E\u200B-\u200F\u202A-\u202E\u2060-\u2064\u2066-\u206F\uFEFF\uFFF9-\uFFFB]|\uD804[\uDCBD\uDCCD]|\uD80D[\uDC30-\uDC3F]|\uD82F[\uDCA0-\uDCA3]|\uD834[\uDD73-\uDD7A]|\uDB40[\uDC01\uDC20-\uDC7F]/,vo=/[!-#%-\*,-\/:;\?@\[-\]_\{\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061D-\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1B7D\u1B7E\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52-\u2E5D\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59\uDF86-\uDF89]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDEB9\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2\uDF00-\uDF09]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDF43-\uDF4F\uDFFF]|\uD809[\uDC70-\uDC74]|\uD80B[\uDFF1\uDFF2]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]/,yu=/[\$\+<->\^`\|~\xA2-\xA6\xA8\xA9\xAC\xAE-\xB1\xB4\xB8\xD7\xF7\u02C2-\u02C5\u02D2-\u02DF\u02E5-\u02EB\u02ED\u02EF-\u02FF\u0375\u0384\u0385\u03F6\u0482\u058D-\u058F\u0606-\u0608\u060B\u060E\u060F\u06DE\u06E9\u06FD\u06FE\u07F6\u07FE\u07FF\u0888\u09F2\u09F3\u09FA\u09FB\u0AF1\u0B70\u0BF3-\u0BFA\u0C7F\u0D4F\u0D79\u0E3F\u0F01-\u0F03\u0F13\u0F15-\u0F17\u0F1A-\u0F1F\u0F34\u0F36\u0F38\u0FBE-\u0FC5\u0FC7-\u0FCC\u0FCE\u0FCF\u0FD5-\u0FD8\u109E\u109F\u1390-\u1399\u166D\u17DB\u1940\u19DE-\u19FF\u1B61-\u1B6A\u1B74-\u1B7C\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u2044\u2052\u207A-\u207C\u208A-\u208C\u20A0-\u20C0\u2100\u2101\u2103-\u2106\u2108\u2109\u2114\u2116-\u2118\u211E-\u2123\u2125\u2127\u2129\u212E\u213A\u213B\u2140-\u2144\u214A-\u214D\u214F\u218A\u218B\u2190-\u2307\u230C-\u2328\u232B-\u2426\u2440-\u244A\u249C-\u24E9\u2500-\u2767\u2794-\u27C4\u27C7-\u27E5\u27F0-\u2982\u2999-\u29D7\u29DC-\u29FB\u29FE-\u2B73\u2B76-\u2B95\u2B97-\u2BFF\u2CE5-\u2CEA\u2E50\u2E51\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFF\u3004\u3012\u3013\u3020\u3036\u3037\u303E\u303F\u309B\u309C\u3190\u3191\u3196-\u319F\u31C0-\u31E3\u31EF\u3200-\u321E\u322A-\u3247\u3250\u3260-\u327F\u328A-\u32B0\u32C0-\u33FF\u4DC0-\u4DFF\uA490-\uA4C6\uA700-\uA716\uA720\uA721\uA789\uA78A\uA828-\uA82B\uA836-\uA839\uAA77-\uAA79\uAB5B\uAB6A\uAB6B\uFB29\uFBB2-\uFBC2\uFD40-\uFD4F\uFDCF\uFDFC-\uFDFF\uFE62\uFE64-\uFE66\uFE69\uFF04\uFF0B\uFF1C-\uFF1E\uFF3E\uFF40\uFF5C\uFF5E\uFFE0-\uFFE6\uFFE8-\uFFEE\uFFFC\uFFFD]|\uD800[\uDD37-\uDD3F\uDD79-\uDD89\uDD8C-\uDD8E\uDD90-\uDD9C\uDDA0\uDDD0-\uDDFC]|\uD802[\uDC77\uDC78\uDEC8]|\uD805\uDF3F|\uD807[\uDFD5-\uDFF1]|\uD81A[\uDF3C-\uDF3F\uDF45]|\uD82F\uDC9C|\uD833[\uDF50-\uDFC3]|\uD834[\uDC00-\uDCF5\uDD00-\uDD26\uDD29-\uDD64\uDD6A-\uDD6C\uDD83\uDD84\uDD8C-\uDDA9\uDDAE-\uDDEA\uDE00-\uDE41\uDE45\uDF00-\uDF56]|\uD835[\uDEC1\uDEDB\uDEFB\uDF15\uDF35\uDF4F\uDF6F\uDF89\uDFA9\uDFC3]|\uD836[\uDC00-\uDDFF\uDE37-\uDE3A\uDE6D-\uDE74\uDE76-\uDE83\uDE85\uDE86]|\uD838[\uDD4F\uDEFF]|\uD83B[\uDCAC\uDCB0\uDD2E\uDEF0\uDEF1]|\uD83C[\uDC00-\uDC2B\uDC30-\uDC93\uDCA0-\uDCAE\uDCB1-\uDCBF\uDCC1-\uDCCF\uDCD1-\uDCF5\uDD0D-\uDDAD\uDDE6-\uDE02\uDE10-\uDE3B\uDE40-\uDE48\uDE50\uDE51\uDE60-\uDE65\uDF00-\uDFFF]|\uD83D[\uDC00-\uDED7\uDEDC-\uDEEC\uDEF0-\uDEFC\uDF00-\uDF76\uDF7B-\uDFD9\uDFE0-\uDFEB\uDFF0]|\uD83E[\uDC00-\uDC0B\uDC10-\uDC47\uDC50-\uDC59\uDC60-\uDC87\uDC90-\uDCAD\uDCB0\uDCB1\uDD00-\uDE53\uDE60-\uDE6D\uDE70-\uDE7C\uDE80-\uDE88\uDE90-\uDEBD\uDEBF-\uDEC5\uDECE-\uDEDB\uDEE0-\uDEE8\uDEF0-\uDEF8\uDF00-\uDF92\uDF94-\uDFCA]/,wu=/[ \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000]/,xf=Object.freeze(Object.defineProperty({__proto__:null,Any:gu,Cc:bu,Cf:vf,P:vo,S:yu,Z:wu},Symbol.toStringTag,{value:"Module"})),Ef=new Uint16Array('ᵁ<Õıʊҝջאٵ۞ޢߖࠏ੊ઑඡ๭༉༦჊ረዡᐕᒝᓃᓟᔥ\0\0\0\0\0\0ᕫᛍᦍᰒᷝ὾⁠↰⊍⏀⏻⑂⠤⤒ⴈ⹈⿎〖㊺㘹㞬㣾㨨㩱㫠㬮ࠀEMabcfglmnoprstu\\bfms¦³¹ÈÏlig耻Æ䃆P耻&䀦cute耻Á䃁reve;䄂Āiyx}rc耻Â䃂;䐐r;쀀𝔄rave耻À䃀pha;䎑acr;䄀d;橓Āgp¡on;䄄f;쀀𝔸plyFunction;恡ing耻Å䃅Ācs¾Ãr;쀀𝒜ign;扔ilde耻Ã䃃ml耻Ä䃄ЀaceforsuåûþėĜĢħĪĀcrêòkslash;或Ŷöø;櫧ed;挆y;䐑ƀcrtąċĔause;戵noullis;愬a;䎒r;쀀𝔅pf;쀀𝔹eve;䋘còēmpeq;扎܀HOacdefhilorsuōőŖƀƞƢƵƷƺǜȕɳɸɾcy;䐧PY耻©䂩ƀcpyŝŢźute;䄆Ā;iŧŨ拒talDifferentialD;慅leys;愭ȀaeioƉƎƔƘron;䄌dil耻Ç䃇rc;䄈nint;戰ot;䄊ĀdnƧƭilla;䂸terDot;䂷òſi;䎧rcleȀDMPTǇǋǑǖot;抙inus;抖lus;投imes;抗oĀcsǢǸkwiseContourIntegral;戲eCurlyĀDQȃȏoubleQuote;思uote;怙ȀlnpuȞȨɇɕonĀ;eȥȦ户;橴ƀgitȯȶȺruent;扡nt;戯ourIntegral;戮ĀfrɌɎ;愂oduct;成nterClockwiseContourIntegral;戳oss;樯cr;쀀𝒞pĀ;Cʄʅ拓ap;才րDJSZacefiosʠʬʰʴʸˋ˗ˡ˦̳ҍĀ;oŹʥtrahd;椑cy;䐂cy;䐅cy;䐏ƀgrsʿ˄ˇger;怡r;憡hv;櫤Āayː˕ron;䄎;䐔lĀ;t˝˞戇a;䎔r;쀀𝔇Āaf˫̧Ācm˰̢riticalȀADGT̖̜̀̆cute;䂴oŴ̋̍;䋙bleAcute;䋝rave;䁠ilde;䋜ond;拄ferentialD;慆Ѱ̽\0\0\0͔͂\0Ѕf;쀀𝔻ƀ;DE͈͉͍䂨ot;惜qual;扐blèCDLRUVͣͲ΂ϏϢϸontourIntegraìȹoɴ͹\0\0ͻ»͉nArrow;懓Āeo·ΤftƀARTΐΖΡrrow;懐ightArrow;懔eåˊngĀLRΫτeftĀARγιrrow;柸ightArrow;柺ightArrow;柹ightĀATϘϞrrow;懒ee;抨pɁϩ\0\0ϯrrow;懑ownArrow;懕erticalBar;戥ǹABLRTaВЪаўѿͼrrowƀ;BUНОТ憓ar;椓pArrow;懵reve;䌑eft˒к\0ц\0ѐightVector;楐eeVector;楞ectorĀ;Bљњ憽ar;楖ightǔѧ\0ѱeeVector;楟ectorĀ;BѺѻ懁ar;楗eeĀ;A҆҇护rrow;憧ĀctҒҗr;쀀𝒟rok;䄐ࠀNTacdfglmopqstuxҽӀӄӋӞӢӧӮӵԡԯԶՒ՝ՠեG;䅊H耻Ð䃐cute耻É䃉ƀaiyӒӗӜron;䄚rc耻Ê䃊;䐭ot;䄖r;쀀𝔈rave耻È䃈ement;戈ĀapӺӾcr;䄒tyɓԆ\0\0ԒmallSquare;旻erySmallSquare;斫ĀgpԦԪon;䄘f;쀀𝔼silon;䎕uĀaiԼՉlĀ;TՂՃ橵ilde;扂librium;懌Āci՗՚r;愰m;橳a;䎗ml耻Ë䃋Āipժկsts;戃onentialE;慇ʀcfiosօֈ֍ֲ׌y;䐤r;쀀𝔉lledɓ֗\0\0֣mallSquare;旼erySmallSquare;斪Ͱֺ\0ֿ\0\0ׄf;쀀𝔽All;戀riertrf;愱cò׋؀JTabcdfgorstר׬ׯ׺؀ؒؖ؛؝أ٬ٲcy;䐃耻>䀾mmaĀ;d׷׸䎓;䏜reve;䄞ƀeiy؇،ؐdil;䄢rc;䄜;䐓ot;䄠r;쀀𝔊;拙pf;쀀𝔾eater̀EFGLSTصلَٖٛ٦qualĀ;Lؾؿ扥ess;招ullEqual;执reater;檢ess;扷lantEqual;橾ilde;扳cr;쀀𝒢;扫ЀAacfiosuڅڋږڛڞڪھۊRDcy;䐪Āctڐڔek;䋇;䁞irc;䄤r;愌lbertSpace;愋ǰگ\0ڲf;愍izontalLine;攀Āctۃۅòکrok;䄦mpńېۘownHumðįqual;扏܀EJOacdfgmnostuۺ۾܃܇܎ܚܞܡܨ݄ݸދޏޕcy;䐕lig;䄲cy;䐁cute耻Í䃍Āiyܓܘrc耻Î䃎;䐘ot;䄰r;愑rave耻Ì䃌ƀ;apܠܯܿĀcgܴܷr;䄪inaryI;慈lieóϝǴ݉\0ݢĀ;eݍݎ戬Āgrݓݘral;戫section;拂isibleĀCTݬݲomma;恣imes;恢ƀgptݿރވon;䄮f;쀀𝕀a;䎙cr;愐ilde;䄨ǫޚ\0ޞcy;䐆l耻Ï䃏ʀcfosuެ޷޼߂ߐĀiyޱ޵rc;䄴;䐙r;쀀𝔍pf;쀀𝕁ǣ߇\0ߌr;쀀𝒥rcy;䐈kcy;䐄΀HJacfosߤߨ߽߬߱ࠂࠈcy;䐥cy;䐌ppa;䎚Āey߶߻dil;䄶;䐚r;쀀𝔎pf;쀀𝕂cr;쀀𝒦րJTaceflmostࠥࠩࠬࡐࡣ঳সে্਷ੇcy;䐉耻<䀼ʀcmnpr࠷࠼ࡁࡄࡍute;䄹bda;䎛g;柪lacetrf;愒r;憞ƀaeyࡗ࡜ࡡron;䄽dil;䄻;䐛Āfsࡨ॰tԀACDFRTUVarࡾࢩࢱࣦ࣠ࣼयज़ΐ४Ānrࢃ࢏gleBracket;柨rowƀ;BR࢙࢚࢞憐ar;懤ightArrow;懆eiling;挈oǵࢷ\0ࣃbleBracket;柦nǔࣈ\0࣒eeVector;楡ectorĀ;Bࣛࣜ懃ar;楙loor;挊ightĀAV࣯ࣵrrow;憔ector;楎Āerँगeƀ;AVउऊऐ抣rrow;憤ector;楚iangleƀ;BEतथऩ抲ar;槏qual;抴pƀDTVषूौownVector;楑eeVector;楠ectorĀ;Bॖॗ憿ar;楘ectorĀ;B॥०憼ar;楒ightáΜs̀EFGLSTॾঋকঝঢভqualGreater;拚ullEqual;扦reater;扶ess;檡lantEqual;橽ilde;扲r;쀀𝔏Ā;eঽা拘ftarrow;懚idot;䄿ƀnpw৔ਖਛgȀLRlr৞৷ਂਐeftĀAR০৬rrow;柵ightArrow;柷ightArrow;柶eftĀarγਊightáοightáϊf;쀀𝕃erĀLRਢਬeftArrow;憙ightArrow;憘ƀchtਾੀੂòࡌ;憰rok;䅁;扪Ѐacefiosuਗ਼੝੠੷੼અઋ઎p;椅y;䐜Ādl੥੯iumSpace;恟lintrf;愳r;쀀𝔐nusPlus;戓pf;쀀𝕄cò੶;䎜ҀJacefostuણધભીଔଙඑ඗ඞcy;䐊cute;䅃ƀaey઴હાron;䅇dil;䅅;䐝ƀgswે૰଎ativeƀMTV૓૟૨ediumSpace;怋hiĀcn૦૘ë૙eryThiî૙tedĀGL૸ଆreaterGreateòٳessLesóੈLine;䀊r;쀀𝔑ȀBnptଢନଷ଺reak;恠BreakingSpace;䂠f;愕ڀ;CDEGHLNPRSTV୕ୖ୪୼஡௫ఄ౞಄ದ೘ൡඅ櫬Āou୛୤ngruent;扢pCap;扭oubleVerticalBar;戦ƀlqxஃஊ஛ement;戉ualĀ;Tஒஓ扠ilde;쀀≂̸ists;戄reater΀;EFGLSTஶஷ஽௉௓௘௥扯qual;扱ullEqual;쀀≧̸reater;쀀≫̸ess;批lantEqual;쀀⩾̸ilde;扵umpń௲௽ownHump;쀀≎̸qual;쀀≏̸eĀfsఊధtTriangleƀ;BEచఛడ拪ar;쀀⧏̸qual;括s̀;EGLSTవశ఼ౄోౘ扮qual;扰reater;扸ess;쀀≪̸lantEqual;쀀⩽̸ilde;扴estedĀGL౨౹reaterGreater;쀀⪢̸essLess;쀀⪡̸recedesƀ;ESಒಓಛ技qual;쀀⪯̸lantEqual;拠ĀeiಫಹverseElement;戌ghtTriangleƀ;BEೋೌ೒拫ar;쀀⧐̸qual;拭ĀquೝഌuareSuĀbp೨೹setĀ;E೰ೳ쀀⊏̸qual;拢ersetĀ;Eഃആ쀀⊐̸qual;拣ƀbcpഓതൎsetĀ;Eഛഞ쀀⊂⃒qual;抈ceedsȀ;ESTലള഻െ抁qual;쀀⪰̸lantEqual;拡ilde;쀀≿̸ersetĀ;E൘൛쀀⊃⃒qual;抉ildeȀ;EFT൮൯൵ൿ扁qual;扄ullEqual;扇ilde;扉erticalBar;戤cr;쀀𝒩ilde耻Ñ䃑;䎝܀Eacdfgmoprstuvලෂ෉෕ෛ෠෧෼ขภยา฿ไlig;䅒cute耻Ó䃓Āiy෎ීrc耻Ô䃔;䐞blac;䅐r;쀀𝔒rave耻Ò䃒ƀaei෮ෲ෶cr;䅌ga;䎩cron;䎟pf;쀀𝕆enCurlyĀDQฎบoubleQuote;怜uote;怘;橔Āclวฬr;쀀𝒪ash耻Ø䃘iŬื฼de耻Õ䃕es;樷ml耻Ö䃖erĀBP๋๠Āar๐๓r;怾acĀek๚๜;揞et;掴arenthesis;揜Ҁacfhilors๿ງຊຏຒດຝະ໼rtialD;戂y;䐟r;쀀𝔓i;䎦;䎠usMinus;䂱Āipຢອncareplanåڝf;愙Ȁ;eio຺ູ໠໤檻cedesȀ;EST່້໏໚扺qual;檯lantEqual;扼ilde;找me;怳Ādp໩໮uct;戏ortionĀ;aȥ໹l;戝Āci༁༆r;쀀𝒫;䎨ȀUfos༑༖༛༟OT耻"䀢r;쀀𝔔pf;愚cr;쀀𝒬؀BEacefhiorsu༾གྷཇའཱིྦྷྪྭ႖ႩႴႾarr;椐G耻®䂮ƀcnrཎནབute;䅔g;柫rĀ;tཛྷཝ憠l;椖ƀaeyཧཬཱron;䅘dil;䅖;䐠Ā;vླྀཹ愜erseĀEUྂྙĀlq྇ྎement;戋uilibrium;懋pEquilibrium;楯r»ཹo;䎡ghtЀACDFTUVa࿁࿫࿳ဢဨၛႇϘĀnr࿆࿒gleBracket;柩rowƀ;BL࿜࿝࿡憒ar;懥eftArrow;懄eiling;按oǵ࿹\0စbleBracket;柧nǔည\0နeeVector;楝ectorĀ;Bဝသ懂ar;楕loor;挋Āerိ၃eƀ;AVဵံြ抢rrow;憦ector;楛iangleƀ;BEၐၑၕ抳ar;槐qual;抵pƀDTVၣၮၸownVector;楏eeVector;楜ectorĀ;Bႂႃ憾ar;楔ectorĀ;B႑႒懀ar;楓Āpuႛ႞f;愝ndImplies;楰ightarrow;懛ĀchႹႼr;愛;憱leDelayed;槴ڀHOacfhimoqstuფჱჷჽᄙᄞᅑᅖᅡᅧᆵᆻᆿĀCcჩხHcy;䐩y;䐨FTcy;䐬cute;䅚ʀ;aeiyᄈᄉᄎᄓᄗ檼ron;䅠dil;䅞rc;䅜;䐡r;쀀𝔖ortȀDLRUᄪᄴᄾᅉownArrow»ОeftArrow»࢚ightArrow»࿝pArrow;憑gma;䎣allCircle;战pf;쀀𝕊ɲᅭ\0\0ᅰt;戚areȀ;ISUᅻᅼᆉᆯ斡ntersection;抓uĀbpᆏᆞsetĀ;Eᆗᆘ抏qual;抑ersetĀ;Eᆨᆩ抐qual;抒nion;抔cr;쀀𝒮ar;拆ȀbcmpᇈᇛሉላĀ;sᇍᇎ拐etĀ;Eᇍᇕqual;抆ĀchᇠህeedsȀ;ESTᇭᇮᇴᇿ扻qual;檰lantEqual;扽ilde;承Tháྌ;我ƀ;esሒሓሣ拑rsetĀ;Eሜም抃qual;抇et»ሓրHRSacfhiorsሾቄ቉ቕ቞ቱቶኟዂወዑORN耻Þ䃞ADE;愢ĀHc቎ቒcy;䐋y;䐦Ābuቚቜ;䀉;䎤ƀaeyብቪቯron;䅤dil;䅢;䐢r;쀀𝔗Āeiቻ኉ǲኀ\0ኇefore;戴a;䎘Ācn኎ኘkSpace;쀀  Space;怉ldeȀ;EFTካኬኲኼ戼qual;扃ullEqual;扅ilde;扈pf;쀀𝕋ipleDot;惛Āctዖዛr;쀀𝒯rok;䅦ૡዷጎጚጦ\0ጬጱ\0\0\0\0\0ጸጽ፷ᎅ\0᏿ᐄᐊᐐĀcrዻጁute耻Ú䃚rĀ;oጇገ憟cir;楉rǣጓ\0጖y;䐎ve;䅬Āiyጞጣrc耻Û䃛;䐣blac;䅰r;쀀𝔘rave耻Ù䃙acr;䅪Ādiፁ፩erĀBPፈ፝Āarፍፐr;䁟acĀekፗፙ;揟et;掵arenthesis;揝onĀ;P፰፱拃lus;抎Āgp፻፿on;䅲f;쀀𝕌ЀADETadps᎕ᎮᎸᏄϨᏒᏗᏳrrowƀ;BDᅐᎠᎤar;椒ownArrow;懅ownArrow;憕quilibrium;楮eeĀ;AᏋᏌ报rrow;憥ownáϳerĀLRᏞᏨeftArrow;憖ightArrow;憗iĀ;lᏹᏺ䏒on;䎥ing;䅮cr;쀀𝒰ilde;䅨ml耻Ü䃜ҀDbcdefosvᐧᐬᐰᐳᐾᒅᒊᒐᒖash;披ar;櫫y;䐒ashĀ;lᐻᐼ抩;櫦Āerᑃᑅ;拁ƀbtyᑌᑐᑺar;怖Ā;iᑏᑕcalȀBLSTᑡᑥᑪᑴar;戣ine;䁼eparator;杘ilde;所ThinSpace;怊r;쀀𝔙pf;쀀𝕍cr;쀀𝒱dash;抪ʀcefosᒧᒬᒱᒶᒼirc;䅴dge;拀r;쀀𝔚pf;쀀𝕎cr;쀀𝒲Ȁfiosᓋᓐᓒᓘr;쀀𝔛;䎞pf;쀀𝕏cr;쀀𝒳ҀAIUacfosuᓱᓵᓹᓽᔄᔏᔔᔚᔠcy;䐯cy;䐇cy;䐮cute耻Ý䃝Āiyᔉᔍrc;䅶;䐫r;쀀𝔜pf;쀀𝕐cr;쀀𝒴ml;䅸ЀHacdefosᔵᔹᔿᕋᕏᕝᕠᕤcy;䐖cute;䅹Āayᕄᕉron;䅽;䐗ot;䅻ǲᕔ\0ᕛoWidtè૙a;䎖r;愨pf;愤cr;쀀𝒵௡ᖃᖊᖐ\0ᖰᖶᖿ\0\0\0\0ᗆᗛᗫᙟ᙭\0ᚕ᚛ᚲᚹ\0ᚾcute耻á䃡reve;䄃̀;Ediuyᖜᖝᖡᖣᖨᖭ戾;쀀∾̳;房rc耻â䃢te肻´̆;䐰lig耻æ䃦Ā;r²ᖺ;쀀𝔞rave耻à䃠ĀepᗊᗖĀfpᗏᗔsym;愵èᗓha;䎱ĀapᗟcĀclᗤᗧr;䄁g;樿ɤᗰ\0\0ᘊʀ;adsvᗺᗻᗿᘁᘇ戧nd;橕;橜lope;橘;橚΀;elmrszᘘᘙᘛᘞᘿᙏᙙ戠;榤e»ᘙsdĀ;aᘥᘦ戡ѡᘰᘲᘴᘶᘸᘺᘼᘾ;榨;榩;榪;榫;榬;榭;榮;榯tĀ;vᙅᙆ戟bĀ;dᙌᙍ抾;榝Āptᙔᙗh;戢»¹arr;捼Āgpᙣᙧon;䄅f;쀀𝕒΀;Eaeiop዁ᙻᙽᚂᚄᚇᚊ;橰cir;橯;扊d;手s;䀧roxĀ;e዁ᚒñᚃing耻å䃥ƀctyᚡᚦᚨr;쀀𝒶;䀪mpĀ;e዁ᚯñʈilde耻ã䃣ml耻ä䃤Āciᛂᛈoninôɲnt;樑ࠀNabcdefiklnoprsu᛭ᛱᜰ᜼ᝃᝈ᝸᝽០៦ᠹᡐᜍ᤽᥈ᥰot;櫭Ācrᛶ᜞kȀcepsᜀᜅᜍᜓong;扌psilon;䏶rime;怵imĀ;e᜚᜛戽q;拍Ŷᜢᜦee;抽edĀ;gᜬᜭ挅e»ᜭrkĀ;t፜᜷brk;掶Āoyᜁᝁ;䐱quo;怞ʀcmprtᝓ᝛ᝡᝤᝨausĀ;eĊĉptyv;榰séᜌnoõēƀahwᝯ᝱ᝳ;䎲;愶een;扬r;쀀𝔟g΀costuvwឍឝឳេ៕៛៞ƀaiuបពរðݠrc;旯p»፱ƀdptឤឨឭot;樀lus;樁imes;樂ɱឹ\0\0ើcup;樆ar;昅riangleĀdu៍្own;施p;斳plus;樄eåᑄåᒭarow;植ƀako៭ᠦᠵĀcn៲ᠣkƀlst៺֫᠂ozenge;槫riangleȀ;dlr᠒᠓᠘᠝斴own;斾eft;旂ight;斸k;搣Ʊᠫ\0ᠳƲᠯ\0ᠱ;斒;斑4;斓ck;斈ĀeoᠾᡍĀ;qᡃᡆ쀀=⃥uiv;쀀≡⃥t;挐Ȁptwxᡙᡞᡧᡬf;쀀𝕓Ā;tᏋᡣom»Ꮜtie;拈؀DHUVbdhmptuvᢅᢖᢪᢻᣗᣛᣬ᣿ᤅᤊᤐᤡȀLRlrᢎᢐᢒᢔ;敗;敔;敖;敓ʀ;DUduᢡᢢᢤᢦᢨ敐;敦;敩;敤;敧ȀLRlrᢳᢵᢷᢹ;敝;敚;敜;教΀;HLRhlrᣊᣋᣍᣏᣑᣓᣕ救;敬;散;敠;敫;敢;敟ox;槉ȀLRlrᣤᣦᣨᣪ;敕;敒;攐;攌ʀ;DUduڽ᣷᣹᣻᣽;敥;敨;攬;攴inus;抟lus;択imes;抠ȀLRlrᤙᤛᤝ᤟;敛;敘;攘;攔΀;HLRhlrᤰᤱᤳᤵᤷ᤻᤹攂;敪;敡;敞;攼;攤;攜Āevģ᥂bar耻¦䂦Ȁceioᥑᥖᥚᥠr;쀀𝒷mi;恏mĀ;e᜚᜜lƀ;bhᥨᥩᥫ䁜;槅sub;柈Ŭᥴ᥾lĀ;e᥹᥺怢t»᥺pƀ;Eeįᦅᦇ;檮Ā;qۜۛೡᦧ\0᧨ᨑᨕᨲ\0ᨷᩐ\0\0᪴\0\0᫁\0\0ᬡᬮ᭍᭒\0᯽\0ᰌƀcpr᦭ᦲ᧝ute;䄇̀;abcdsᦿᧀᧄ᧊᧕᧙戩nd;橄rcup;橉Āau᧏᧒p;橋p;橇ot;橀;쀀∩︀Āeo᧢᧥t;恁îړȀaeiu᧰᧻ᨁᨅǰ᧵\0᧸s;橍on;䄍dil耻ç䃧rc;䄉psĀ;sᨌᨍ橌m;橐ot;䄋ƀdmnᨛᨠᨦil肻¸ƭptyv;榲t脀¢;eᨭᨮ䂢räƲr;쀀𝔠ƀceiᨽᩀᩍy;䑇ckĀ;mᩇᩈ朓ark»ᩈ;䏇r΀;Ecefms᩟᩠ᩢᩫ᪤᪪᪮旋;槃ƀ;elᩩᩪᩭ䋆q;扗eɡᩴ\0\0᪈rrowĀlr᩼᪁eft;憺ight;憻ʀRSacd᪒᪔᪖᪚᪟»ཇ;擈st;抛irc;抚ash;抝nint;樐id;櫯cir;槂ubsĀ;u᪻᪼晣it»᪼ˬ᫇᫔᫺\0ᬊonĀ;eᫍᫎ䀺Ā;qÇÆɭ᫙\0\0᫢aĀ;t᫞᫟䀬;䁀ƀ;fl᫨᫩᫫戁îᅠeĀmx᫱᫶ent»᫩eóɍǧ᫾\0ᬇĀ;dኻᬂot;橭nôɆƀfryᬐᬔᬗ;쀀𝕔oäɔ脀©;sŕᬝr;愗Āaoᬥᬩrr;憵ss;朗Ācuᬲᬷr;쀀𝒸Ābpᬼ᭄Ā;eᭁᭂ櫏;櫑Ā;eᭉᭊ櫐;櫒dot;拯΀delprvw᭠᭬᭷ᮂᮬᯔ᯹arrĀlr᭨᭪;椸;椵ɰ᭲\0\0᭵r;拞c;拟arrĀ;p᭿ᮀ憶;椽̀;bcdosᮏᮐᮖᮡᮥᮨ截rcap;橈Āauᮛᮞp;橆p;橊ot;抍r;橅;쀀∪︀Ȁalrv᮵ᮿᯞᯣrrĀ;mᮼᮽ憷;椼yƀevwᯇᯔᯘqɰᯎ\0\0ᯒreã᭳uã᭵ee;拎edge;拏en耻¤䂤earrowĀlrᯮ᯳eft»ᮀight»ᮽeäᯝĀciᰁᰇoninôǷnt;戱lcty;挭ঀAHabcdefhijlorstuwz᰸᰻᰿ᱝᱩᱵᲊᲞᲬᲷ᳻᳿ᴍᵻᶑᶫᶻ᷆᷍rò΁ar;楥Ȁglrs᱈ᱍ᱒᱔ger;怠eth;愸òᄳhĀ;vᱚᱛ怐»ऊūᱡᱧarow;椏aã̕Āayᱮᱳron;䄏;䐴ƀ;ao̲ᱼᲄĀgrʿᲁr;懊tseq;橷ƀglmᲑᲔᲘ耻°䂰ta;䎴ptyv;榱ĀirᲣᲨsht;楿;쀀𝔡arĀlrᲳᲵ»ࣜ»သʀaegsv᳂͸᳖᳜᳠mƀ;oș᳊᳔ndĀ;ș᳑uit;晦amma;䏝in;拲ƀ;io᳧᳨᳸䃷de脀÷;o᳧ᳰntimes;拇nø᳷cy;䑒cɯᴆ\0\0ᴊrn;挞op;挍ʀlptuwᴘᴝᴢᵉᵕlar;䀤f;쀀𝕕ʀ;emps̋ᴭᴷᴽᵂqĀ;d͒ᴳot;扑inus;戸lus;戔quare;抡blebarwedgåúnƀadhᄮᵝᵧownarrowóᲃarpoonĀlrᵲᵶefôᲴighôᲶŢᵿᶅkaro÷གɯᶊ\0\0ᶎrn;挟op;挌ƀcotᶘᶣᶦĀryᶝᶡ;쀀𝒹;䑕l;槶rok;䄑Ādrᶰᶴot;拱iĀ;fᶺ᠖斿Āah᷀᷃ròЩaòྦangle;榦Āci᷒ᷕy;䑟grarr;柿ऀDacdefglmnopqrstuxḁḉḙḸոḼṉṡṾấắẽỡἪἷὄ὎὚ĀDoḆᴴoôᲉĀcsḎḔute耻é䃩ter;橮ȀaioyḢḧḱḶron;䄛rĀ;cḭḮ扖耻ê䃪lon;払;䑍ot;䄗ĀDrṁṅot;扒;쀀𝔢ƀ;rsṐṑṗ檚ave耻è䃨Ā;dṜṝ檖ot;檘Ȁ;ilsṪṫṲṴ檙nters;揧;愓Ā;dṹṺ檕ot;檗ƀapsẅẉẗcr;䄓tyƀ;svẒẓẕ戅et»ẓpĀ1;ẝẤĳạả;怄;怅怃ĀgsẪẬ;䅋p;怂ĀgpẴẸon;䄙f;쀀𝕖ƀalsỄỎỒrĀ;sỊị拕l;槣us;橱iƀ;lvỚớở䎵on»ớ;䏵ȀcsuvỪỳἋἣĀioữḱrc»Ḯɩỹ\0\0ỻíՈantĀglἂἆtr»ṝess»Ṻƀaeiἒ἖Ἒls;䀽st;扟vĀ;DȵἠD;橸parsl;槥ĀDaἯἳot;打rr;楱ƀcdiἾὁỸr;愯oô͒ĀahὉὋ;䎷耻ð䃰Āmrὓὗl耻ë䃫o;悬ƀcipὡὤὧl;䀡sôծĀeoὬὴctatioîՙnentialåչৡᾒ\0ᾞ\0ᾡᾧ\0\0ῆῌ\0ΐ\0ῦῪ \0 ⁚llingdotseñṄy;䑄male;晀ƀilrᾭᾳ῁lig;耀ﬃɩᾹ\0\0᾽g;耀ﬀig;耀ﬄ;쀀𝔣lig;耀ﬁlig;쀀fjƀaltῙ῜ῡt;晭ig;耀ﬂns;斱of;䆒ǰ΅\0ῳf;쀀𝕗ĀakֿῷĀ;vῼ´拔;櫙artint;樍Āao‌⁕Ācs‑⁒α‚‰‸⁅⁈\0⁐β•‥‧‪‬\0‮耻½䂽;慓耻¼䂼;慕;慙;慛Ƴ‴\0‶;慔;慖ʴ‾⁁\0\0⁃耻¾䂾;慗;慜5;慘ƶ⁌\0⁎;慚;慝8;慞l;恄wn;挢cr;쀀𝒻ࢀEabcdefgijlnorstv₂₉₟₥₰₴⃰⃵⃺⃿℃ℒℸ̗ℾ⅒↞Ā;lٍ₇;檌ƀcmpₐₕ₝ute;䇵maĀ;dₜ᳚䎳;檆reve;䄟Āiy₪₮rc;䄝;䐳ot;䄡Ȁ;lqsؾق₽⃉ƀ;qsؾٌ⃄lanô٥Ȁ;cdl٥⃒⃥⃕c;檩otĀ;o⃜⃝檀Ā;l⃢⃣檂;檄Ā;e⃪⃭쀀⋛︀s;檔r;쀀𝔤Ā;gٳ؛mel;愷cy;䑓Ȁ;Eajٚℌℎℐ;檒;檥;檤ȀEaesℛℝ℩ℴ;扩pĀ;p℣ℤ檊rox»ℤĀ;q℮ℯ檈Ā;q℮ℛim;拧pf;쀀𝕘Āci⅃ⅆr;愊mƀ;el٫ⅎ⅐;檎;檐茀>;cdlqr׮ⅠⅪⅮⅳⅹĀciⅥⅧ;檧r;橺ot;拗Par;榕uest;橼ʀadelsↄⅪ←ٖ↛ǰ↉\0↎proø₞r;楸qĀlqؿ↖lesó₈ií٫Āen↣↭rtneqq;쀀≩︀Å↪ԀAabcefkosy⇄⇇⇱⇵⇺∘∝∯≨≽ròΠȀilmr⇐⇔⇗⇛rsðᒄf»․ilôکĀdr⇠⇤cy;䑊ƀ;cwࣴ⇫⇯ir;楈;憭ar;意irc;䄥ƀalr∁∎∓rtsĀ;u∉∊晥it»∊lip;怦con;抹r;쀀𝔥sĀew∣∩arow;椥arow;椦ʀamopr∺∾≃≞≣rr;懿tht;戻kĀlr≉≓eftarrow;憩ightarrow;憪f;쀀𝕙bar;怕ƀclt≯≴≸r;쀀𝒽asè⇴rok;䄧Ābp⊂⊇ull;恃hen»ᱛૡ⊣\0⊪\0⊸⋅⋎\0⋕⋳\0\0⋸⌢⍧⍢⍿\0⎆⎪⎴cute耻í䃭ƀ;iyݱ⊰⊵rc耻î䃮;䐸Ācx⊼⊿y;䐵cl耻¡䂡ĀfrΟ⋉;쀀𝔦rave耻ì䃬Ȁ;inoܾ⋝⋩⋮Āin⋢⋦nt;樌t;戭fin;槜ta;愩lig;䄳ƀaop⋾⌚⌝ƀcgt⌅⌈⌗r;䄫ƀelpܟ⌏⌓inåގarôܠh;䄱f;抷ed;䆵ʀ;cfotӴ⌬⌱⌽⍁are;愅inĀ;t⌸⌹戞ie;槝doô⌙ʀ;celpݗ⍌⍐⍛⍡al;抺Āgr⍕⍙eróᕣã⍍arhk;樗rod;樼Ȁcgpt⍯⍲⍶⍻y;䑑on;䄯f;쀀𝕚a;䎹uest耻¿䂿Āci⎊⎏r;쀀𝒾nʀ;EdsvӴ⎛⎝⎡ӳ;拹ot;拵Ā;v⎦⎧拴;拳Ā;iݷ⎮lde;䄩ǫ⎸\0⎼cy;䑖l耻ï䃯̀cfmosu⏌⏗⏜⏡⏧⏵Āiy⏑⏕rc;䄵;䐹r;쀀𝔧ath;䈷pf;쀀𝕛ǣ⏬\0⏱r;쀀𝒿rcy;䑘kcy;䑔Ѐacfghjos␋␖␢␧␭␱␵␻ppaĀ;v␓␔䎺;䏰Āey␛␠dil;䄷;䐺r;쀀𝔨reen;䄸cy;䑅cy;䑜pf;쀀𝕜cr;쀀𝓀஀ABEHabcdefghjlmnoprstuv⑰⒁⒆⒍⒑┎┽╚▀♎♞♥♹♽⚚⚲⛘❝❨➋⟀⠁⠒ƀart⑷⑺⑼rò৆òΕail;椛arr;椎Ā;gঔ⒋;檋ar;楢ॣ⒥\0⒪\0⒱\0\0\0\0\0⒵Ⓔ\0ⓆⓈⓍ\0⓹ute;䄺mptyv;榴raîࡌbda;䎻gƀ;dlࢎⓁⓃ;榑åࢎ;檅uo耻«䂫rЀ;bfhlpst࢙ⓞⓦⓩ⓫⓮⓱⓵Ā;f࢝ⓣs;椟s;椝ë≒p;憫l;椹im;楳l;憢ƀ;ae⓿─┄檫il;椙Ā;s┉┊檭;쀀⪭︀ƀabr┕┙┝rr;椌rk;杲Āak┢┬cĀek┨┪;䁻;䁛Āes┱┳;榋lĀdu┹┻;榏;榍Ȁaeuy╆╋╖╘ron;䄾Ādi═╔il;䄼ìࢰâ┩;䐻Ȁcqrs╣╦╭╽a;椶uoĀ;rนᝆĀdu╲╷har;楧shar;楋h;憲ʀ;fgqs▋▌উ◳◿扤tʀahlrt▘▤▷◂◨rrowĀ;t࢙□aé⓶arpoonĀdu▯▴own»њp»०eftarrows;懇ightƀahs◍◖◞rrowĀ;sࣴࢧarpoonó྘quigarro÷⇰hreetimes;拋ƀ;qs▋ও◺lanôবʀ;cdgsব☊☍☝☨c;檨otĀ;o☔☕橿Ā;r☚☛檁;檃Ā;e☢☥쀀⋚︀s;檓ʀadegs☳☹☽♉♋pproøⓆot;拖qĀgq♃♅ôউgtò⒌ôছiíলƀilr♕࣡♚sht;楼;쀀𝔩Ā;Eজ♣;檑š♩♶rĀdu▲♮Ā;l॥♳;楪lk;斄cy;䑙ʀ;achtੈ⚈⚋⚑⚖rò◁orneòᴈard;楫ri;旺Āio⚟⚤dot;䅀ustĀ;a⚬⚭掰che»⚭ȀEaes⚻⚽⛉⛔;扨pĀ;p⛃⛄檉rox»⛄Ā;q⛎⛏檇Ā;q⛎⚻im;拦Ѐabnoptwz⛩⛴⛷✚✯❁❇❐Ānr⛮⛱g;柬r;懽rëࣁgƀlmr⛿✍✔eftĀar০✇ightá৲apsto;柼ightá৽parrowĀlr✥✩efô⓭ight;憬ƀafl✶✹✽r;榅;쀀𝕝us;樭imes;樴š❋❏st;戗áፎƀ;ef❗❘᠀旊nge»❘arĀ;l❤❥䀨t;榓ʀachmt❳❶❼➅➇ròࢨorneòᶌarĀ;d྘➃;業;怎ri;抿̀achiqt➘➝ੀ➢➮➻quo;怹r;쀀𝓁mƀ;egল➪➬;檍;檏Ābu┪➳oĀ;rฟ➹;怚rok;䅂萀<;cdhilqrࠫ⟒☹⟜⟠⟥⟪⟰Āci⟗⟙;檦r;橹reå◲mes;拉arr;楶uest;橻ĀPi⟵⟹ar;榖ƀ;ef⠀भ᠛旃rĀdu⠇⠍shar;楊har;楦Āen⠗⠡rtneqq;쀀≨︀Å⠞܀Dacdefhilnopsu⡀⡅⢂⢎⢓⢠⢥⢨⣚⣢⣤ઃ⣳⤂Dot;戺Ȁclpr⡎⡒⡣⡽r耻¯䂯Āet⡗⡙;時Ā;e⡞⡟朠se»⡟Ā;sျ⡨toȀ;dluျ⡳⡷⡻owîҌefôएðᏑker;斮Āoy⢇⢌mma;権;䐼ash;怔asuredangle»ᘦr;쀀𝔪o;愧ƀcdn⢯⢴⣉ro耻µ䂵Ȁ;acdᑤ⢽⣀⣄sôᚧir;櫰ot肻·Ƶusƀ;bd⣒ᤃ⣓戒Ā;uᴼ⣘;横ţ⣞⣡p;櫛ò−ðઁĀdp⣩⣮els;抧f;쀀𝕞Āct⣸⣽r;쀀𝓂pos»ᖝƀ;lm⤉⤊⤍䎼timap;抸ఀGLRVabcdefghijlmoprstuvw⥂⥓⥾⦉⦘⧚⧩⨕⨚⩘⩝⪃⪕⪤⪨⬄⬇⭄⭿⮮ⰴⱧⱼ⳩Āgt⥇⥋;쀀⋙̸Ā;v⥐௏쀀≫⃒ƀelt⥚⥲⥶ftĀar⥡⥧rrow;懍ightarrow;懎;쀀⋘̸Ā;v⥻ే쀀≪⃒ightarrow;懏ĀDd⦎⦓ash;抯ash;抮ʀbcnpt⦣⦧⦬⦱⧌la»˞ute;䅄g;쀀∠⃒ʀ;Eiop඄⦼⧀⧅⧈;쀀⩰̸d;쀀≋̸s;䅉roø඄urĀ;a⧓⧔普lĀ;s⧓ସǳ⧟\0⧣p肻 ଷmpĀ;e௹ఀʀaeouy⧴⧾⨃⨐⨓ǰ⧹\0⧻;橃on;䅈dil;䅆ngĀ;dൾ⨊ot;쀀⩭̸p;橂;䐽ash;怓΀;Aadqsxஒ⨩⨭⨻⩁⩅⩐rr;懗rĀhr⨳⨶k;椤Ā;oᏲᏰot;쀀≐̸uiöୣĀei⩊⩎ar;椨í஘istĀ;s஠டr;쀀𝔫ȀEest௅⩦⩹⩼ƀ;qs஼⩭௡ƀ;qs஼௅⩴lanô௢ií௪Ā;rஶ⪁»ஷƀAap⪊⪍⪑rò⥱rr;憮ar;櫲ƀ;svྍ⪜ྌĀ;d⪡⪢拼;拺cy;䑚΀AEadest⪷⪺⪾⫂⫅⫶⫹rò⥦;쀀≦̸rr;憚r;急Ȁ;fqs఻⫎⫣⫯tĀar⫔⫙rro÷⫁ightarro÷⪐ƀ;qs఻⪺⫪lanôౕĀ;sౕ⫴»శiíౝĀ;rవ⫾iĀ;eచథiäඐĀpt⬌⬑f;쀀𝕟膀¬;in⬙⬚⬶䂬nȀ;Edvஉ⬤⬨⬮;쀀⋹̸ot;쀀⋵̸ǡஉ⬳⬵;拷;拶iĀ;vಸ⬼ǡಸ⭁⭃;拾;拽ƀaor⭋⭣⭩rȀ;ast୻⭕⭚⭟lleì୻l;쀀⫽⃥;쀀∂̸lint;樔ƀ;ceಒ⭰⭳uåಥĀ;cಘ⭸Ā;eಒ⭽ñಘȀAait⮈⮋⮝⮧rò⦈rrƀ;cw⮔⮕⮙憛;쀀⤳̸;쀀↝̸ghtarrow»⮕riĀ;eೋೖ΀chimpqu⮽⯍⯙⬄୸⯤⯯Ȁ;cerല⯆ഷ⯉uå൅;쀀𝓃ortɭ⬅\0\0⯖ará⭖mĀ;e൮⯟Ā;q൴൳suĀbp⯫⯭å೸åഋƀbcp⯶ⰑⰙȀ;Ees⯿ⰀഢⰄ抄;쀀⫅̸etĀ;eഛⰋqĀ;qണⰀcĀ;eലⰗñസȀ;EesⰢⰣൟⰧ抅;쀀⫆̸etĀ;e൘ⰮqĀ;qൠⰣȀgilrⰽⰿⱅⱇìௗlde耻ñ䃱çృiangleĀlrⱒⱜeftĀ;eచⱚñదightĀ;eೋⱥñ೗Ā;mⱬⱭ䎽ƀ;esⱴⱵⱹ䀣ro;愖p;怇ҀDHadgilrsⲏⲔⲙⲞⲣⲰⲶⳓⳣash;抭arr;椄p;쀀≍⃒ash;抬ĀetⲨⲬ;쀀≥⃒;쀀>⃒nfin;槞ƀAetⲽⳁⳅrr;椂;쀀≤⃒Ā;rⳊⳍ쀀<⃒ie;쀀⊴⃒ĀAtⳘⳜrr;椃rie;쀀⊵⃒im;쀀∼⃒ƀAan⳰⳴ⴂrr;懖rĀhr⳺⳽k;椣Ā;oᏧᏥear;椧ቓ᪕\0\0\0\0\0\0\0\0\0\0\0\0\0ⴭ\0ⴸⵈⵠⵥ⵲ⶄᬇ\0\0ⶍⶫ\0ⷈⷎ\0ⷜ⸙⸫⸾⹃Ācsⴱ᪗ute耻ó䃳ĀiyⴼⵅrĀ;c᪞ⵂ耻ô䃴;䐾ʀabios᪠ⵒⵗǈⵚlac;䅑v;樸old;榼lig;䅓Ācr⵩⵭ir;榿;쀀𝔬ͯ⵹\0\0⵼\0ⶂn;䋛ave耻ò䃲;槁Ābmⶈ෴ar;榵Ȁacitⶕ⶘ⶥⶨrò᪀Āir⶝ⶠr;榾oss;榻nå๒;槀ƀaeiⶱⶵⶹcr;䅍ga;䏉ƀcdnⷀⷅǍron;䎿;榶pf;쀀𝕠ƀaelⷔ⷗ǒr;榷rp;榹΀;adiosvⷪⷫⷮ⸈⸍⸐⸖戨rò᪆Ȁ;efmⷷⷸ⸂⸅橝rĀ;oⷾⷿ愴f»ⷿ耻ª䂪耻º䂺gof;抶r;橖lope;橗;橛ƀclo⸟⸡⸧ò⸁ash耻ø䃸l;折iŬⸯ⸴de耻õ䃵esĀ;aǛ⸺s;樶ml耻ö䃶bar;挽ૡ⹞\0⹽\0⺀⺝\0⺢⺹\0\0⻋ຜ\0⼓\0\0⼫⾼\0⿈rȀ;astЃ⹧⹲຅脀¶;l⹭⹮䂶leìЃɩ⹸\0\0⹻m;櫳;櫽y;䐿rʀcimpt⺋⺏⺓ᡥ⺗nt;䀥od;䀮il;怰enk;怱r;쀀𝔭ƀimo⺨⺰⺴Ā;v⺭⺮䏆;䏕maô੶ne;明ƀ;tv⺿⻀⻈䏀chfork»´;䏖Āau⻏⻟nĀck⻕⻝kĀ;h⇴⻛;愎ö⇴sҀ;abcdemst⻳⻴ᤈ⻹⻽⼄⼆⼊⼎䀫cir;樣ir;樢Āouᵀ⼂;樥;橲n肻±ຝim;樦wo;樧ƀipu⼙⼠⼥ntint;樕f;쀀𝕡nd耻£䂣Ԁ;Eaceinosu່⼿⽁⽄⽇⾁⾉⾒⽾⾶;檳p;檷uå໙Ā;c໎⽌̀;acens່⽙⽟⽦⽨⽾pproø⽃urlyeñ໙ñ໎ƀaes⽯⽶⽺pprox;檹qq;檵im;拨iíໟmeĀ;s⾈ຮ怲ƀEas⽸⾐⽺ð⽵ƀdfp໬⾙⾯ƀals⾠⾥⾪lar;挮ine;挒urf;挓Ā;t໻⾴ï໻rel;抰Āci⿀⿅r;쀀𝓅;䏈ncsp;怈̀fiopsu⿚⋢⿟⿥⿫⿱r;쀀𝔮pf;쀀𝕢rime;恗cr;쀀𝓆ƀaeo⿸〉〓tĀei⿾々rnionóڰnt;樖stĀ;e【】䀿ñἙô༔઀ABHabcdefhilmnoprstux぀けさすムㄎㄫㅇㅢㅲㆎ㈆㈕㈤㈩㉘㉮㉲㊐㊰㊷ƀartぇおがròႳòϝail;検aròᱥar;楤΀cdenqrtとふへみわゔヌĀeuねぱ;쀀∽̱te;䅕iãᅮmptyv;榳gȀ;del࿑らるろ;榒;榥å࿑uo耻»䂻rր;abcfhlpstw࿜ガクシスゼゾダッデナp;極Ā;f࿠ゴs;椠;椳s;椞ë≝ð✮l;楅im;楴l;憣;憝Āaiパフil;椚oĀ;nホボ戶aló༞ƀabrョリヮrò៥rk;杳ĀakンヽcĀekヹ・;䁽;䁝Āes㄂㄄;榌lĀduㄊㄌ;榎;榐Ȁaeuyㄗㄜㄧㄩron;䅙Ādiㄡㄥil;䅗ì࿲âヺ;䑀Ȁclqsㄴㄷㄽㅄa;椷dhar;楩uoĀ;rȎȍh;憳ƀacgㅎㅟངlȀ;ipsླྀㅘㅛႜnåႻarôྩt;断ƀilrㅩဣㅮsht;楽;쀀𝔯ĀaoㅷㆆrĀduㅽㅿ»ѻĀ;l႑ㆄ;楬Ā;vㆋㆌ䏁;䏱ƀgns㆕ㇹㇼht̀ahlrstㆤㆰ㇂㇘㇤㇮rrowĀ;t࿜ㆭaéトarpoonĀduㆻㆿowîㅾp»႒eftĀah㇊㇐rrowó࿪arpoonóՑightarrows;應quigarro÷ニhreetimes;拌g;䋚ingdotseñἲƀahm㈍㈐㈓rò࿪aòՑ;怏oustĀ;a㈞㈟掱che»㈟mid;櫮Ȁabpt㈲㈽㉀㉒Ānr㈷㈺g;柭r;懾rëဃƀafl㉇㉊㉎r;榆;쀀𝕣us;樮imes;樵Āap㉝㉧rĀ;g㉣㉤䀩t;榔olint;樒arò㇣Ȁachq㉻㊀Ⴜ㊅quo;怺r;쀀𝓇Ābu・㊊oĀ;rȔȓƀhir㊗㊛㊠reåㇸmes;拊iȀ;efl㊪ၙᠡ㊫方tri;槎luhar;楨;愞ൡ㋕㋛㋟㌬㌸㍱\0㍺㎤\0\0㏬㏰\0㐨㑈㑚㒭㒱㓊㓱\0㘖\0\0㘳cute;䅛quï➺Ԁ;Eaceinpsyᇭ㋳㋵㋿㌂㌋㌏㌟㌦㌩;檴ǰ㋺\0㋼;檸on;䅡uåᇾĀ;dᇳ㌇il;䅟rc;䅝ƀEas㌖㌘㌛;檶p;檺im;择olint;樓iíሄ;䑁otƀ;be㌴ᵇ㌵担;橦΀Aacmstx㍆㍊㍗㍛㍞㍣㍭rr;懘rĀhr㍐㍒ë∨Ā;oਸ਼਴t耻§䂧i;䀻war;椩mĀin㍩ðnuóñt;朶rĀ;o㍶⁕쀀𝔰Ȁacoy㎂㎆㎑㎠rp;景Āhy㎋㎏cy;䑉;䑈rtɭ㎙\0\0㎜iäᑤaraì⹯耻­䂭Āgm㎨㎴maƀ;fv㎱㎲㎲䏃;䏂Ѐ;deglnprካ㏅㏉㏎㏖㏞㏡㏦ot;橪Ā;q኱ኰĀ;E㏓㏔檞;檠Ā;E㏛㏜檝;檟e;扆lus;樤arr;楲aròᄽȀaeit㏸㐈㐏㐗Āls㏽㐄lsetmé㍪hp;樳parsl;槤Ādlᑣ㐔e;挣Ā;e㐜㐝檪Ā;s㐢㐣檬;쀀⪬︀ƀflp㐮㐳㑂tcy;䑌Ā;b㐸㐹䀯Ā;a㐾㐿槄r;挿f;쀀𝕤aĀdr㑍ЂesĀ;u㑔㑕晠it»㑕ƀcsu㑠㑹㒟Āau㑥㑯pĀ;sᆈ㑫;쀀⊓︀pĀ;sᆴ㑵;쀀⊔︀uĀbp㑿㒏ƀ;esᆗᆜ㒆etĀ;eᆗ㒍ñᆝƀ;esᆨᆭ㒖etĀ;eᆨ㒝ñᆮƀ;afᅻ㒦ְrť㒫ֱ»ᅼaròᅈȀcemt㒹㒾㓂㓅r;쀀𝓈tmîñiì㐕aræᆾĀar㓎㓕rĀ;f㓔ឿ昆Āan㓚㓭ightĀep㓣㓪psiloîỠhé⺯s»⡒ʀbcmnp㓻㕞ሉ㖋㖎Ҁ;Edemnprs㔎㔏㔑㔕㔞㔣㔬㔱㔶抂;櫅ot;檽Ā;dᇚ㔚ot;櫃ult;櫁ĀEe㔨㔪;櫋;把lus;檿arr;楹ƀeiu㔽㕒㕕tƀ;en㔎㕅㕋qĀ;qᇚ㔏eqĀ;q㔫㔨m;櫇Ābp㕚㕜;櫕;櫓c̀;acensᇭ㕬㕲㕹㕻㌦pproø㋺urlyeñᇾñᇳƀaes㖂㖈㌛pproø㌚qñ㌗g;晪ڀ123;Edehlmnps㖩㖬㖯ሜ㖲㖴㗀㗉㗕㗚㗟㗨㗭耻¹䂹耻²䂲耻³䂳;櫆Āos㖹㖼t;檾ub;櫘Ā;dሢ㗅ot;櫄sĀou㗏㗒l;柉b;櫗arr;楻ult;櫂ĀEe㗤㗦;櫌;抋lus;櫀ƀeiu㗴㘉㘌tƀ;enሜ㗼㘂qĀ;qሢ㖲eqĀ;q㗧㗤m;櫈Ābp㘑㘓;櫔;櫖ƀAan㘜㘠㘭rr;懙rĀhr㘦㘨ë∮Ā;oਫ਩war;椪lig耻ß䃟௡㙑㙝㙠ዎ㙳㙹\0㙾㛂\0\0\0\0\0㛛㜃\0㜉㝬\0\0\0㞇ɲ㙖\0\0㙛get;挖;䏄rë๟ƀaey㙦㙫㙰ron;䅥dil;䅣;䑂lrec;挕r;쀀𝔱Ȁeiko㚆㚝㚵㚼ǲ㚋\0㚑eĀ4fኄኁaƀ;sv㚘㚙㚛䎸ym;䏑Ācn㚢㚲kĀas㚨㚮pproø዁im»ኬsðኞĀas㚺㚮ð዁rn耻þ䃾Ǭ̟㛆⋧es膀×;bd㛏㛐㛘䃗Ā;aᤏ㛕r;樱;樰ƀeps㛡㛣㜀á⩍Ȁ;bcf҆㛬㛰㛴ot;挶ir;櫱Ā;o㛹㛼쀀𝕥rk;櫚á㍢rime;怴ƀaip㜏㜒㝤dåቈ΀adempst㜡㝍㝀㝑㝗㝜㝟ngleʀ;dlqr㜰㜱㜶㝀㝂斵own»ᶻeftĀ;e⠀㜾ñम;扜ightĀ;e㊪㝋ñၚot;旬inus;樺lus;樹b;槍ime;樻ezium;揢ƀcht㝲㝽㞁Āry㝷㝻;쀀𝓉;䑆cy;䑛rok;䅧Āio㞋㞎xô᝷headĀlr㞗㞠eftarro÷ࡏightarrow»ཝऀAHabcdfghlmoprstuw㟐㟓㟗㟤㟰㟼㠎㠜㠣㠴㡑㡝㡫㢩㣌㣒㣪㣶ròϭar;楣Ācr㟜㟢ute耻ú䃺òᅐrǣ㟪\0㟭y;䑞ve;䅭Āiy㟵㟺rc耻û䃻;䑃ƀabh㠃㠆㠋ròᎭlac;䅱aòᏃĀir㠓㠘sht;楾;쀀𝔲rave耻ù䃹š㠧㠱rĀlr㠬㠮»ॗ»ႃlk;斀Āct㠹㡍ɯ㠿\0\0㡊rnĀ;e㡅㡆挜r»㡆op;挏ri;旸Āal㡖㡚cr;䅫肻¨͉Āgp㡢㡦on;䅳f;쀀𝕦̀adhlsuᅋ㡸㡽፲㢑㢠ownáᎳarpoonĀlr㢈㢌efô㠭ighô㠯iƀ;hl㢙㢚㢜䏅»ᏺon»㢚parrows;懈ƀcit㢰㣄㣈ɯ㢶\0\0㣁rnĀ;e㢼㢽挝r»㢽op;挎ng;䅯ri;旹cr;쀀𝓊ƀdir㣙㣝㣢ot;拰lde;䅩iĀ;f㜰㣨»᠓Āam㣯㣲rò㢨l耻ü䃼angle;榧ހABDacdeflnoprsz㤜㤟㤩㤭㦵㦸㦽㧟㧤㧨㧳㧹㧽㨁㨠ròϷarĀ;v㤦㤧櫨;櫩asèϡĀnr㤲㤷grt;榜΀eknprst㓣㥆㥋㥒㥝㥤㦖appá␕othinçẖƀhir㓫⻈㥙opô⾵Ā;hᎷ㥢ïㆍĀiu㥩㥭gmá㎳Ābp㥲㦄setneqĀ;q㥽㦀쀀⊊︀;쀀⫋︀setneqĀ;q㦏㦒쀀⊋︀;쀀⫌︀Āhr㦛㦟etá㚜iangleĀlr㦪㦯eft»थight»ၑy;䐲ash»ံƀelr㧄㧒㧗ƀ;beⷪ㧋㧏ar;抻q;扚lip;拮Ābt㧜ᑨaòᑩr;쀀𝔳tré㦮suĀbp㧯㧱»ജ»൙pf;쀀𝕧roð໻tré㦴Ācu㨆㨋r;쀀𝓋Ābp㨐㨘nĀEe㦀㨖»㥾nĀEe㦒㨞»㦐igzag;榚΀cefoprs㨶㨻㩖㩛㩔㩡㩪irc;䅵Ādi㩀㩑Ābg㩅㩉ar;機eĀ;qᗺ㩏;扙erp;愘r;쀀𝔴pf;쀀𝕨Ā;eᑹ㩦atèᑹcr;쀀𝓌ૣណ㪇\0㪋\0㪐㪛\0\0㪝㪨㪫㪯\0\0㫃㫎\0㫘ៜ៟tré៑r;쀀𝔵ĀAa㪔㪗ròσrò৶;䎾ĀAa㪡㪤ròθrò৫að✓is;拻ƀdptឤ㪵㪾Āfl㪺ឩ;쀀𝕩imåឲĀAa㫇㫊ròώròਁĀcq㫒ីr;쀀𝓍Āpt៖㫜ré។Ѐacefiosu㫰㫽㬈㬌㬑㬕㬛㬡cĀuy㫶㫻te耻ý䃽;䑏Āiy㬂㬆rc;䅷;䑋n耻¥䂥r;쀀𝔶cy;䑗pf;쀀𝕪cr;쀀𝓎Ācm㬦㬩y;䑎l耻ÿ䃿Ԁacdefhiosw㭂㭈㭔㭘㭤㭩㭭㭴㭺㮀cute;䅺Āay㭍㭒ron;䅾;䐷ot;䅼Āet㭝㭡træᕟa;䎶r;쀀𝔷cy;䐶grarr;懝pf;쀀𝕫cr;쀀𝓏Ājn㮅㮇;怍j;怌'.split("").map(i=>i.charCodeAt(0))),Cf=new Uint16Array("Ȁaglq	\x1Bɭ\0\0p;䀦os;䀧t;䀾t;䀼uot;䀢".split("").map(i=>i.charCodeAt(0)));var ls;const _f=new Map([[0,65533],[128,8364],[130,8218],[131,402],[132,8222],[133,8230],[134,8224],[135,8225],[136,710],[137,8240],[138,352],[139,8249],[140,338],[142,381],[145,8216],[146,8217],[147,8220],[148,8221],[149,8226],[150,8211],[151,8212],[152,732],[153,8482],[154,353],[155,8250],[156,339],[158,382],[159,376]]),Af=(ls=String.fromCodePoint)!==null&&ls!==void 0?ls:function(i){let e="";return i>65535&&(i-=65536,e+=String.fromCharCode(i>>>10&1023|55296),i=56320|i&1023),e+=String.fromCharCode(i),e};function kf(i){var e;return i>=55296&&i<=57343||i>1114111?65533:(e=_f.get(i))!==null&&e!==void 0?e:i}var gt;(function(i){i[i.NUM=35]="NUM",i[i.SEMI=59]="SEMI",i[i.EQUALS=61]="EQUALS",i[i.ZERO=48]="ZERO",i[i.NINE=57]="NINE",i[i.LOWER_A=97]="LOWER_A",i[i.LOWER_F=102]="LOWER_F",i[i.LOWER_X=120]="LOWER_X",i[i.LOWER_Z=122]="LOWER_Z",i[i.UPPER_A=65]="UPPER_A",i[i.UPPER_F=70]="UPPER_F",i[i.UPPER_Z=90]="UPPER_Z"})(gt||(gt={}));const Sf=32;var Oi;(function(i){i[i.VALUE_LENGTH=49152]="VALUE_LENGTH",i[i.BRANCH_LENGTH=16256]="BRANCH_LENGTH",i[i.JUMP_TABLE=127]="JUMP_TABLE"})(Oi||(Oi={}));function qs(i){return i>=gt.ZERO&&i<=gt.NINE}function Tf(i){return i>=gt.UPPER_A&&i<=gt.UPPER_F||i>=gt.LOWER_A&&i<=gt.LOWER_F}function Mf(i){return i>=gt.UPPER_A&&i<=gt.UPPER_Z||i>=gt.LOWER_A&&i<=gt.LOWER_Z||qs(i)}function Lf(i){return i===gt.EQUALS||Mf(i)}var mt;(function(i){i[i.EntityStart=0]="EntityStart",i[i.NumericStart=1]="NumericStart",i[i.NumericDecimal=2]="NumericDecimal",i[i.NumericHex=3]="NumericHex",i[i.NamedEntity=4]="NamedEntity"})(mt||(mt={}));var Ii;(function(i){i[i.Legacy=0]="Legacy",i[i.Strict=1]="Strict",i[i.Attribute=2]="Attribute"})(Ii||(Ii={}));class Df{constructor(e,t,n){this.decodeTree=e,this.emitCodePoint=t,this.errors=n,this.state=mt.EntityStart,this.consumed=1,this.result=0,this.treeIndex=0,this.excess=1,this.decodeMode=Ii.Strict}startEntity(e){this.decodeMode=e,this.state=mt.EntityStart,this.result=0,this.treeIndex=0,this.excess=1,this.consumed=1}write(e,t){switch(this.state){case mt.EntityStart:return e.charCodeAt(t)===gt.NUM?(this.state=mt.NumericStart,this.consumed+=1,this.stateNumericStart(e,t+1)):(this.state=mt.NamedEntity,this.stateNamedEntity(e,t));case mt.NumericStart:return this.stateNumericStart(e,t);case mt.NumericDecimal:return this.stateNumericDecimal(e,t);case mt.NumericHex:return this.stateNumericHex(e,t);case mt.NamedEntity:return this.stateNamedEntity(e,t)}}stateNumericStart(e,t){return t>=e.length?-1:(e.charCodeAt(t)|Sf)===gt.LOWER_X?(this.state=mt.NumericHex,this.consumed+=1,this.stateNumericHex(e,t+1)):(this.state=mt.NumericDecimal,this.stateNumericDecimal(e,t))}addToNumericResult(e,t,n,a){if(t!==n){const r=n-t;this.result=this.result*Math.pow(a,r)+parseInt(e.substr(t,r),a),this.consumed+=r}}stateNumericHex(e,t){const n=t;for(;t<e.length;){const a=e.charCodeAt(t);if(qs(a)||Tf(a))t+=1;else return this.addToNumericResult(e,n,t,16),this.emitNumericEntity(a,3)}return this.addToNumericResult(e,n,t,16),-1}stateNumericDecimal(e,t){const n=t;for(;t<e.length;){const a=e.charCodeAt(t);if(qs(a))t+=1;else return this.addToNumericResult(e,n,t,10),this.emitNumericEntity(a,2)}return this.addToNumericResult(e,n,t,10),-1}emitNumericEntity(e,t){var n;if(this.consumed<=t)return(n=this.errors)===null||n===void 0||n.absenceOfDigitsInNumericCharacterReference(this.consumed),0;if(e===gt.SEMI)this.consumed+=1;else if(this.decodeMode===Ii.Strict)return 0;return this.emitCodePoint(kf(this.result),this.consumed),this.errors&&(e!==gt.SEMI&&this.errors.missingSemicolonAfterCharacterReference(),this.errors.validateNumericCharacterReference(this.result)),this.consumed}stateNamedEntity(e,t){const{decodeTree:n}=this;let a=n[this.treeIndex],r=(a&Oi.VALUE_LENGTH)>>14;for(;t<e.length;t++,this.excess++){const s=e.charCodeAt(t);if(this.treeIndex=Bf(n,a,this.treeIndex+Math.max(1,r),s),this.treeIndex<0)return this.result===0||this.decodeMode===Ii.Attribute&&(r===0||Lf(s))?0:this.emitNotTerminatedNamedEntity();if(a=n[this.treeIndex],r=(a&Oi.VALUE_LENGTH)>>14,r!==0){if(s===gt.SEMI)return this.emitNamedEntityData(this.treeIndex,r,this.consumed+this.excess);this.decodeMode!==Ii.Strict&&(this.result=this.treeIndex,this.consumed+=this.excess,this.excess=0)}}return-1}emitNotTerminatedNamedEntity(){var e;const{result:t,decodeTree:n}=this,a=(n[t]&Oi.VALUE_LENGTH)>>14;return this.emitNamedEntityData(t,a,this.consumed),(e=this.errors)===null||e===void 0||e.missingSemicolonAfterCharacterReference(),this.consumed}emitNamedEntityData(e,t,n){const{decodeTree:a}=this;return this.emitCodePoint(t===1?a[e]&~Oi.VALUE_LENGTH:a[e+1],n),t===3&&this.emitCodePoint(a[e+2],n),n}end(){var e;switch(this.state){case mt.NamedEntity:return this.result!==0&&(this.decodeMode!==Ii.Attribute||this.result===this.treeIndex)?this.emitNotTerminatedNamedEntity():0;case mt.NumericDecimal:return this.emitNumericEntity(0,2);case mt.NumericHex:return this.emitNumericEntity(0,3);case mt.NumericStart:return(e=this.errors)===null||e===void 0||e.absenceOfDigitsInNumericCharacterReference(this.consumed),0;case mt.EntityStart:return 0}}}function vu(i){let e="";const t=new Df(i,n=>e+=Af(n));return function(a,r){let s=0,o=0;for(;(o=a.indexOf("&",o))>=0;){e+=a.slice(s,o),t.startEntity(r);const u=t.write(a,o+1);if(u<0){s=o+t.end();break}s=o+u,o=u===0?s+1:s}const l=e+a.slice(s);return e="",l}}function Bf(i,e,t,n){const a=(e&Oi.BRANCH_LENGTH)>>7,r=e&Oi.JUMP_TABLE;if(a===0)return r!==0&&n===r?t:-1;if(r){const l=n-r;return l<0||l>=a?-1:i[t+l]-1}let s=t,o=s+a-1;for(;s<=o;){const l=s+o>>>1,u=i[l];if(u<n)s=l+1;else if(u>n)o=l-1;else return i[l+a]}return-1}const Ff=vu(Ef);vu(Cf);function xu(i,e=Ii.Legacy){return Ff(i,e)}function If(i){return Object.prototype.toString.call(i)}function xo(i){return If(i)==="[object String]"}const Pf=Object.prototype.hasOwnProperty;function Rf(i,e){return Pf.call(i,e)}function nr(i){return Array.prototype.slice.call(arguments,1).forEach(function(t){if(t){if(typeof t!="object")throw new TypeError(t+"must be object");Object.keys(t).forEach(function(n){i[n]=t[n]})}}),i}function Eu(i,e,t){return[].concat(i.slice(0,e),t,i.slice(e+1))}function Eo(i){return!(i>=55296&&i<=57343||i>=64976&&i<=65007||(i&65535)===65535||(i&65535)===65534||i>=0&&i<=8||i===11||i>=14&&i<=31||i>=127&&i<=159||i>1114111)}function za(i){if(i>65535){i-=65536;const e=55296+(i>>10),t=56320+(i&1023);return String.fromCharCode(e,t)}return String.fromCharCode(i)}const Cu=/\\([!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~])/g,Of=/&([a-z#][a-z0-9]{1,31});/gi,Nf=new RegExp(Cu.source+"|"+Of.source,"gi"),Hf=/^#((?:x[a-f0-9]{1,8}|[0-9]{1,8}))$/i;function zf(i,e){if(e.charCodeAt(0)===35&&Hf.test(e)){const n=e[1].toLowerCase()==="x"?parseInt(e.slice(2),16):parseInt(e.slice(1),10);return Eo(n)?za(n):i}const t=xu(i);return t!==i?t:i}function Vf(i){return i.indexOf("\\")<0?i:i.replace(Cu,"$1")}function _n(i){return i.indexOf("\\")<0&&i.indexOf("&")<0?i:i.replace(Nf,function(e,t,n){return t||zf(e,n)})}const Uf=/[&<>"]/,Wf=/[&<>"]/g,Gf={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};function qf(i){return Gf[i]}function zi(i){return Uf.test(i)?i.replace(Wf,qf):i}const jf=/[.?*+^$[\]\\(){}|-]/g;function $f(i){return i.replace(jf,"\\$&")}function Qe(i){switch(i){case 9:case 32:return!0}return!1}function ta(i){if(i>=8192&&i<=8202)return!0;switch(i){case 9:case 10:case 11:case 12:case 13:case 32:case 160:case 5760:case 8239:case 8287:case 12288:return!0}return!1}function ia(i){return vo.test(i)||yu.test(i)}function na(i){switch(i){case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 58:case 59:case 60:case 61:case 62:case 63:case 64:case 91:case 92:case 93:case 94:case 95:case 96:case 123:case 124:case 125:case 126:return!0;default:return!1}}function ar(i){return i=i.trim().replace(/\s+/g," "),"ẞ".toLowerCase()==="Ṿ"&&(i=i.replace(/ẞ/g,"ß")),i.toLowerCase().toUpperCase()}const Yf={mdurl:wf,ucmicro:xf},Kf=Object.freeze(Object.defineProperty({__proto__:null,arrayReplaceAt:Eu,assign:nr,escapeHtml:zi,escapeRE:$f,fromCodePoint:za,has:Rf,isMdAsciiPunct:na,isPunctChar:ia,isSpace:Qe,isString:xo,isValidEntityCode:Eo,isWhiteSpace:ta,lib:Yf,normalizeReference:ar,unescapeAll:_n,unescapeMd:Vf},Symbol.toStringTag,{value:"Module"}));function Xf(i,e,t){let n,a,r,s;const o=i.posMax,l=i.pos;for(i.pos=e+1,n=1;i.pos<o;){if(r=i.src.charCodeAt(i.pos),r===93&&(n--,n===0)){a=!0;break}if(s=i.pos,i.md.inline.skipToken(i),r===91){if(s===i.pos-1)n++;else if(t)return i.pos=l,-1}}let u=-1;return a&&(u=i.pos),i.pos=l,u}function Zf(i,e,t){let n,a=e;const r={ok:!1,pos:0,str:""};if(i.charCodeAt(a)===60){for(a++;a<t;){if(n=i.charCodeAt(a),n===10||n===60)return r;if(n===62)return r.pos=a+1,r.str=_n(i.slice(e+1,a)),r.ok=!0,r;if(n===92&&a+1<t){a+=2;continue}a++}return r}let s=0;for(;a<t&&(n=i.charCodeAt(a),!(n===32||n<32||n===127));){if(n===92&&a+1<t){if(i.charCodeAt(a+1)===32)break;a+=2;continue}if(n===40&&(s++,s>32))return r;if(n===41){if(s===0)break;s--}a++}return e===a||s!==0||(r.str=_n(i.slice(e,a)),r.pos=a,r.ok=!0),r}function Qf(i,e,t,n){let a,r=e;const s={ok:!1,can_continue:!1,pos:0,str:"",marker:0};if(n)s.str=n.str,s.marker=n.marker;else{if(r>=t)return s;let o=i.charCodeAt(r);if(o!==34&&o!==39&&o!==40)return s;e++,r++,o===40&&(o=41),s.marker=o}for(;r<t;){if(a=i.charCodeAt(r),a===s.marker)return s.pos=r+1,s.str+=_n(i.slice(e,r)),s.ok=!0,s;if(a===40&&s.marker===41)return s;a===92&&r+1<t&&r++,r++}return s.can_continue=!0,s.str+=_n(i.slice(e,r)),s}const Jf=Object.freeze(Object.defineProperty({__proto__:null,parseLinkDestination:Zf,parseLinkLabel:Xf,parseLinkTitle:Qf},Symbol.toStringTag,{value:"Module"})),bi={};bi.code_inline=function(i,e,t,n,a){const r=i[e];return"<code"+a.renderAttrs(r)+">"+zi(r.content)+"</code>"};bi.code_block=function(i,e,t,n,a){const r=i[e];return"<pre"+a.renderAttrs(r)+"><code>"+zi(i[e].content)+`</code></pre>
`};bi.fence=function(i,e,t,n,a){const r=i[e],s=r.info?_n(r.info).trim():"";let o="",l="";if(s){const f=s.split(/(\s+)/g);o=f[0],l=f.slice(2).join("")}let u;if(t.highlight?u=t.highlight(r.content,o,l)||zi(r.content):u=zi(r.content),u.indexOf("<pre")===0)return u+`
`;if(s){const f=r.attrIndex("class"),c=r.attrs?r.attrs.slice():[];f<0?c.push(["class",t.langPrefix+o]):(c[f]=c[f].slice(),c[f][1]+=" "+t.langPrefix+o);const d={attrs:c};return`<pre><code${a.renderAttrs(d)}>${u}</code></pre>
`}return`<pre><code${a.renderAttrs(r)}>${u}</code></pre>
`};bi.image=function(i,e,t,n,a){const r=i[e];return r.attrs[r.attrIndex("alt")][1]=a.renderInlineAsText(r.children,t,n),a.renderToken(i,e,t)};bi.hardbreak=function(i,e,t){return t.xhtmlOut?`<br />
`:`<br>
`};bi.softbreak=function(i,e,t){return t.breaks?t.xhtmlOut?`<br />
`:`<br>
`:`
`};bi.text=function(i,e){return zi(i[e].content)};bi.html_block=function(i,e){return i[e].content};bi.html_inline=function(i,e){return i[e].content};function Sn(){this.rules=nr({},bi)}Sn.prototype.renderAttrs=function(e){let t,n,a;if(!e.attrs)return"";for(a="",t=0,n=e.attrs.length;t<n;t++)a+=" "+zi(e.attrs[t][0])+'="'+zi(e.attrs[t][1])+'"';return a};Sn.prototype.renderToken=function(e,t,n){const a=e[t];let r="";if(a.hidden)return"";a.block&&a.nesting!==-1&&t&&e[t-1].hidden&&(r+=`
`),r+=(a.nesting===-1?"</":"<")+a.tag,r+=this.renderAttrs(a),a.nesting===0&&n.xhtmlOut&&(r+=" /");let s=!1;if(a.block&&(s=!0,a.nesting===1&&t+1<e.length)){const o=e[t+1];(o.type==="inline"||o.hidden||o.nesting===-1&&o.tag===a.tag)&&(s=!1)}return r+=s?`>
`:">",r};Sn.prototype.renderInline=function(i,e,t){let n="";const a=this.rules;for(let r=0,s=i.length;r<s;r++){const o=i[r].type;typeof a[o]<"u"?n+=a[o](i,r,e,t,this):n+=this.renderToken(i,r,e)}return n};Sn.prototype.renderInlineAsText=function(i,e,t){let n="";for(let a=0,r=i.length;a<r;a++)switch(i[a].type){case"text":n+=i[a].content;break;case"image":n+=this.renderInlineAsText(i[a].children,e,t);break;case"html_inline":case"html_block":n+=i[a].content;break;case"softbreak":case"hardbreak":n+=`
`;break}return n};Sn.prototype.render=function(i,e,t){let n="";const a=this.rules;for(let r=0,s=i.length;r<s;r++){const o=i[r].type;o==="inline"?n+=this.renderInline(i[r].children,e,t):typeof a[o]<"u"?n+=a[o](i,r,e,t,this):n+=this.renderToken(i,r,e,t)}return n};function Lt(){this.__rules__=[],this.__cache__=null}Lt.prototype.__find__=function(i){for(let e=0;e<this.__rules__.length;e++)if(this.__rules__[e].name===i)return e;return-1};Lt.prototype.__compile__=function(){const i=this,e=[""];i.__rules__.forEach(function(t){t.enabled&&t.alt.forEach(function(n){e.indexOf(n)<0&&e.push(n)})}),i.__cache__={},e.forEach(function(t){i.__cache__[t]=[],i.__rules__.forEach(function(n){n.enabled&&(t&&n.alt.indexOf(t)<0||i.__cache__[t].push(n.fn))})})};Lt.prototype.at=function(i,e,t){const n=this.__find__(i),a=t||{};if(n===-1)throw new Error("Parser rule not found: "+i);this.__rules__[n].fn=e,this.__rules__[n].alt=a.alt||[],this.__cache__=null};Lt.prototype.before=function(i,e,t,n){const a=this.__find__(i),r=n||{};if(a===-1)throw new Error("Parser rule not found: "+i);this.__rules__.splice(a,0,{name:e,enabled:!0,fn:t,alt:r.alt||[]}),this.__cache__=null};Lt.prototype.after=function(i,e,t,n){const a=this.__find__(i),r=n||{};if(a===-1)throw new Error("Parser rule not found: "+i);this.__rules__.splice(a+1,0,{name:e,enabled:!0,fn:t,alt:r.alt||[]}),this.__cache__=null};Lt.prototype.push=function(i,e,t){const n=t||{};this.__rules__.push({name:i,enabled:!0,fn:e,alt:n.alt||[]}),this.__cache__=null};Lt.prototype.enable=function(i,e){Array.isArray(i)||(i=[i]);const t=[];return i.forEach(function(n){const a=this.__find__(n);if(a<0){if(e)return;throw new Error("Rules manager: invalid rule name "+n)}this.__rules__[a].enabled=!0,t.push(n)},this),this.__cache__=null,t};Lt.prototype.enableOnly=function(i,e){Array.isArray(i)||(i=[i]),this.__rules__.forEach(function(t){t.enabled=!1}),this.enable(i,e)};Lt.prototype.disable=function(i,e){Array.isArray(i)||(i=[i]);const t=[];return i.forEach(function(n){const a=this.__find__(n);if(a<0){if(e)return;throw new Error("Rules manager: invalid rule name "+n)}this.__rules__[a].enabled=!1,t.push(n)},this),this.__cache__=null,t};Lt.prototype.getRules=function(i){return this.__cache__===null&&this.__compile__(),this.__cache__[i]||[]};function ri(i,e,t){this.type=i,this.tag=e,this.attrs=null,this.map=null,this.nesting=t,this.level=0,this.children=null,this.content="",this.markup="",this.info="",this.meta=null,this.block=!1,this.hidden=!1}ri.prototype.attrIndex=function(e){if(!this.attrs)return-1;const t=this.attrs;for(let n=0,a=t.length;n<a;n++)if(t[n][0]===e)return n;return-1};ri.prototype.attrPush=function(e){this.attrs?this.attrs.push(e):this.attrs=[e]};ri.prototype.attrSet=function(e,t){const n=this.attrIndex(e),a=[e,t];n<0?this.attrPush(a):this.attrs[n]=a};ri.prototype.attrGet=function(e){const t=this.attrIndex(e);let n=null;return t>=0&&(n=this.attrs[t][1]),n};ri.prototype.attrJoin=function(e,t){const n=this.attrIndex(e);n<0?this.attrPush([e,t]):this.attrs[n][1]=this.attrs[n][1]+" "+t};function _u(i,e,t){this.src=i,this.env=t,this.tokens=[],this.inlineMode=!1,this.md=e}_u.prototype.Token=ri;const ep=/\r\n?|\n/g,tp=/\0/g;function ip(i){let e;e=i.src.replace(ep,`
`),e=e.replace(tp,"�"),i.src=e}function np(i){let e;i.inlineMode?(e=new i.Token("inline","",0),e.content=i.src,e.map=[0,1],e.children=[],i.tokens.push(e)):i.md.block.parse(i.src,i.md,i.env,i.tokens)}function ap(i){const e=i.tokens;for(let t=0,n=e.length;t<n;t++){const a=e[t];a.type==="inline"&&i.md.inline.parse(a.content,i.md,i.env,a.children)}}function rp(i){return/^<a[>\s]/i.test(i)}function sp(i){return/^<\/a\s*>/i.test(i)}function op(i){const e=i.tokens;if(i.md.options.linkify)for(let t=0,n=e.length;t<n;t++){if(e[t].type!=="inline"||!i.md.linkify.pretest(e[t].content))continue;let a=e[t].children,r=0;for(let s=a.length-1;s>=0;s--){const o=a[s];if(o.type==="link_close"){for(s--;a[s].level!==o.level&&a[s].type!=="link_open";)s--;continue}if(o.type==="html_inline"&&(rp(o.content)&&r>0&&r--,sp(o.content)&&r++),!(r>0)&&o.type==="text"&&i.md.linkify.test(o.content)){const l=o.content;let u=i.md.linkify.match(l);const f=[];let c=o.level,d=0;u.length>0&&u[0].index===0&&s>0&&a[s-1].type==="text_special"&&(u=u.slice(1));for(let h=0;h<u.length;h++){const p=u[h].url,m=i.md.normalizeLink(p);if(!i.md.validateLink(m))continue;let g=u[h].text;u[h].schema?u[h].schema==="mailto:"&&!/^mailto:/i.test(g)?g=i.md.normalizeLinkText("mailto:"+g).replace(/^mailto:/,""):g=i.md.normalizeLinkText(g):g=i.md.normalizeLinkText("http://"+g).replace(/^http:\/\//,"");const y=u[h].index;if(y>d){const _=new i.Token("text","",0);_.content=l.slice(d,y),_.level=c,f.push(_)}const x=new i.Token("link_open","a",1);x.attrs=[["href",m]],x.level=c++,x.markup="linkify",x.info="auto",f.push(x);const w=new i.Token("text","",0);w.content=g,w.level=c,f.push(w);const C=new i.Token("link_close","a",-1);C.level=--c,C.markup="linkify",C.info="auto",f.push(C),d=u[h].lastIndex}if(d<l.length){const h=new i.Token("text","",0);h.content=l.slice(d),h.level=c,f.push(h)}e[t].children=a=Eu(a,s,f)}}}}const Au=/\+-|\.\.|\?\?\?\?|!!!!|,,|--/,lp=/\((c|tm|r)\)/i,cp=/\((c|tm|r)\)/ig,up={c:"©",r:"®",tm:"™"};function dp(i,e){return up[e.toLowerCase()]}function hp(i){let e=0;for(let t=i.length-1;t>=0;t--){const n=i[t];n.type==="text"&&!e&&(n.content=n.content.replace(cp,dp)),n.type==="link_open"&&n.info==="auto"&&e--,n.type==="link_close"&&n.info==="auto"&&e++}}function fp(i){let e=0;for(let t=i.length-1;t>=0;t--){const n=i[t];n.type==="text"&&!e&&Au.test(n.content)&&(n.content=n.content.replace(/\+-/g,"±").replace(/\.{2,}/g,"…").replace(/([?!])…/g,"$1..").replace(/([?!]){4,}/g,"$1$1$1").replace(/,{2,}/g,",").replace(/(^|[^-])---(?=[^-]|$)/mg,"$1—").replace(/(^|\s)--(?=\s|$)/mg,"$1–").replace(/(^|[^-\s])--(?=[^-\s]|$)/mg,"$1–")),n.type==="link_open"&&n.info==="auto"&&e--,n.type==="link_close"&&n.info==="auto"&&e++}}function pp(i){let e;if(i.md.options.typographer)for(e=i.tokens.length-1;e>=0;e--)i.tokens[e].type==="inline"&&(lp.test(i.tokens[e].content)&&hp(i.tokens[e].children),Au.test(i.tokens[e].content)&&fp(i.tokens[e].children))}const mp=/['"]/,Kl=/['"]/g,Xl="’";function ma(i,e,t){return i.slice(0,e)+t+i.slice(e+1)}function gp(i,e){let t;const n=[];for(let a=0;a<i.length;a++){const r=i[a],s=i[a].level;for(t=n.length-1;t>=0&&!(n[t].level<=s);t--);if(n.length=t+1,r.type!=="text")continue;let o=r.content,l=0,u=o.length;e:for(;l<u;){Kl.lastIndex=l;const f=Kl.exec(o);if(!f)break;let c=!0,d=!0;l=f.index+1;const h=f[0]==="'";let p=32;if(f.index-1>=0)p=o.charCodeAt(f.index-1);else for(t=a-1;t>=0&&!(i[t].type==="softbreak"||i[t].type==="hardbreak");t--)if(i[t].content){p=i[t].content.charCodeAt(i[t].content.length-1);break}let m=32;if(l<u)m=o.charCodeAt(l);else for(t=a+1;t<i.length&&!(i[t].type==="softbreak"||i[t].type==="hardbreak");t++)if(i[t].content){m=i[t].content.charCodeAt(0);break}const g=na(p)||ia(String.fromCharCode(p)),y=na(m)||ia(String.fromCharCode(m)),x=ta(p),w=ta(m);if(w?c=!1:y&&(x||g||(c=!1)),x?d=!1:g&&(w||y||(d=!1)),m===34&&f[0]==='"'&&p>=48&&p<=57&&(d=c=!1),c&&d&&(c=g,d=y),!c&&!d){h&&(r.content=ma(r.content,f.index,Xl));continue}if(d)for(t=n.length-1;t>=0;t--){let C=n[t];if(n[t].level<s)break;if(C.single===h&&n[t].level===s){C=n[t];let _,F;h?(_=e.md.options.quotes[2],F=e.md.options.quotes[3]):(_=e.md.options.quotes[0],F=e.md.options.quotes[1]),r.content=ma(r.content,f.index,F),i[C.token].content=ma(i[C.token].content,C.pos,_),l+=F.length-1,C.token===a&&(l+=_.length-1),o=r.content,u=o.length,n.length=t;continue e}}c?n.push({token:a,pos:f.index,single:h,level:s}):d&&h&&(r.content=ma(r.content,f.index,Xl))}}}function bp(i){if(i.md.options.typographer)for(let e=i.tokens.length-1;e>=0;e--)i.tokens[e].type!=="inline"||!mp.test(i.tokens[e].content)||gp(i.tokens[e].children,i)}function yp(i){let e,t;const n=i.tokens,a=n.length;for(let r=0;r<a;r++){if(n[r].type!=="inline")continue;const s=n[r].children,o=s.length;for(e=0;e<o;e++)s[e].type==="text_special"&&(s[e].type="text");for(e=t=0;e<o;e++)s[e].type==="text"&&e+1<o&&s[e+1].type==="text"?s[e+1].content=s[e].content+s[e+1].content:(e!==t&&(s[t]=s[e]),t++);e!==t&&(s.length=t)}}const cs=[["normalize",ip],["block",np],["inline",ap],["linkify",op],["replacements",pp],["smartquotes",bp],["text_join",yp]];function Co(){this.ruler=new Lt;for(let i=0;i<cs.length;i++)this.ruler.push(cs[i][0],cs[i][1])}Co.prototype.process=function(i){const e=this.ruler.getRules("");for(let t=0,n=e.length;t<n;t++)e[t](i)};Co.prototype.State=_u;function yi(i,e,t,n){this.src=i,this.md=e,this.env=t,this.tokens=n,this.bMarks=[],this.eMarks=[],this.tShift=[],this.sCount=[],this.bsCount=[],this.blkIndent=0,this.line=0,this.lineMax=0,this.tight=!1,this.ddIndent=-1,this.listIndent=-1,this.parentType="root",this.level=0;const a=this.src;for(let r=0,s=0,o=0,l=0,u=a.length,f=!1;s<u;s++){const c=a.charCodeAt(s);if(!f)if(Qe(c)){o++,c===9?l+=4-l%4:l++;continue}else f=!0;(c===10||s===u-1)&&(c!==10&&s++,this.bMarks.push(r),this.eMarks.push(s),this.tShift.push(o),this.sCount.push(l),this.bsCount.push(0),f=!1,o=0,l=0,r=s+1)}this.bMarks.push(a.length),this.eMarks.push(a.length),this.tShift.push(0),this.sCount.push(0),this.bsCount.push(0),this.lineMax=this.bMarks.length-1}yi.prototype.push=function(i,e,t){const n=new ri(i,e,t);return n.block=!0,t<0&&this.level--,n.level=this.level,t>0&&this.level++,this.tokens.push(n),n};yi.prototype.isEmpty=function(e){return this.bMarks[e]+this.tShift[e]>=this.eMarks[e]};yi.prototype.skipEmptyLines=function(e){for(let t=this.lineMax;e<t&&!(this.bMarks[e]+this.tShift[e]<this.eMarks[e]);e++);return e};yi.prototype.skipSpaces=function(e){for(let t=this.src.length;e<t;e++){const n=this.src.charCodeAt(e);if(!Qe(n))break}return e};yi.prototype.skipSpacesBack=function(e,t){if(e<=t)return e;for(;e>t;)if(!Qe(this.src.charCodeAt(--e)))return e+1;return e};yi.prototype.skipChars=function(e,t){for(let n=this.src.length;e<n&&this.src.charCodeAt(e)===t;e++);return e};yi.prototype.skipCharsBack=function(e,t,n){if(e<=n)return e;for(;e>n;)if(t!==this.src.charCodeAt(--e))return e+1;return e};yi.prototype.getLines=function(e,t,n,a){if(e>=t)return"";const r=new Array(t-e);for(let s=0,o=e;o<t;o++,s++){let l=0;const u=this.bMarks[o];let f=u,c;for(o+1<t||a?c=this.eMarks[o]+1:c=this.eMarks[o];f<c&&l<n;){const d=this.src.charCodeAt(f);if(Qe(d))d===9?l+=4-(l+this.bsCount[o])%4:l++;else if(f-u<this.tShift[o])l++;else break;f++}l>n?r[s]=new Array(l-n+1).join(" ")+this.src.slice(f,c):r[s]=this.src.slice(f,c)}return r.join("")};yi.prototype.Token=ri;const wp=65536;function us(i,e){const t=i.bMarks[e]+i.tShift[e],n=i.eMarks[e];return i.src.slice(t,n)}function Zl(i){const e=[],t=i.length;let n=0,a=i.charCodeAt(n),r=!1,s=0,o="";for(;n<t;)a===124&&(r?(o+=i.substring(s,n-1),s=n):(e.push(o+i.substring(s,n)),o="",s=n+1)),r=a===92,n++,a=i.charCodeAt(n);return e.push(o+i.substring(s)),e}function vp(i,e,t,n){if(e+2>t)return!1;let a=e+1;if(i.sCount[a]<i.blkIndent||i.sCount[a]-i.blkIndent>=4)return!1;let r=i.bMarks[a]+i.tShift[a];if(r>=i.eMarks[a])return!1;const s=i.src.charCodeAt(r++);if(s!==124&&s!==45&&s!==58||r>=i.eMarks[a])return!1;const o=i.src.charCodeAt(r++);if(o!==124&&o!==45&&o!==58&&!Qe(o)||s===45&&Qe(o))return!1;for(;r<i.eMarks[a];){const C=i.src.charCodeAt(r);if(C!==124&&C!==45&&C!==58&&!Qe(C))return!1;r++}let l=us(i,e+1),u=l.split("|");const f=[];for(let C=0;C<u.length;C++){const _=u[C].trim();if(!_){if(C===0||C===u.length-1)continue;return!1}if(!/^:?-+:?$/.test(_))return!1;_.charCodeAt(_.length-1)===58?f.push(_.charCodeAt(0)===58?"center":"right"):_.charCodeAt(0)===58?f.push("left"):f.push("")}if(l=us(i,e).trim(),l.indexOf("|")===-1||i.sCount[e]-i.blkIndent>=4)return!1;u=Zl(l),u.length&&u[0]===""&&u.shift(),u.length&&u[u.length-1]===""&&u.pop();const c=u.length;if(c===0||c!==f.length)return!1;if(n)return!0;const d=i.parentType;i.parentType="table";const h=i.md.block.ruler.getRules("blockquote"),p=i.push("table_open","table",1),m=[e,0];p.map=m;const g=i.push("thead_open","thead",1);g.map=[e,e+1];const y=i.push("tr_open","tr",1);y.map=[e,e+1];for(let C=0;C<u.length;C++){const _=i.push("th_open","th",1);f[C]&&(_.attrs=[["style","text-align:"+f[C]]]);const F=i.push("inline","",0);F.content=u[C].trim(),F.children=[],i.push("th_close","th",-1)}i.push("tr_close","tr",-1),i.push("thead_close","thead",-1);let x,w=0;for(a=e+2;a<t&&!(i.sCount[a]<i.blkIndent);a++){let C=!1;for(let F=0,D=h.length;F<D;F++)if(h[F](i,a,t,!0)){C=!0;break}if(C||(l=us(i,a).trim(),!l)||i.sCount[a]-i.blkIndent>=4||(u=Zl(l),u.length&&u[0]===""&&u.shift(),u.length&&u[u.length-1]===""&&u.pop(),w+=c-u.length,w>wp))break;if(a===e+2){const F=i.push("tbody_open","tbody",1);F.map=x=[e+2,0]}const _=i.push("tr_open","tr",1);_.map=[a,a+1];for(let F=0;F<c;F++){const D=i.push("td_open","td",1);f[F]&&(D.attrs=[["style","text-align:"+f[F]]]);const O=i.push("inline","",0);O.content=u[F]?u[F].trim():"",O.children=[],i.push("td_close","td",-1)}i.push("tr_close","tr",-1)}return x&&(i.push("tbody_close","tbody",-1),x[1]=a),i.push("table_close","table",-1),m[1]=a,i.parentType=d,i.line=a,!0}function xp(i,e,t){if(i.sCount[e]-i.blkIndent<4)return!1;let n=e+1,a=n;for(;n<t;){if(i.isEmpty(n)){n++;continue}if(i.sCount[n]-i.blkIndent>=4){n++,a=n;continue}break}i.line=a;const r=i.push("code_block","code",0);return r.content=i.getLines(e,a,4+i.blkIndent,!1)+`
`,r.map=[e,i.line],!0}function Ep(i,e,t,n){let a=i.bMarks[e]+i.tShift[e],r=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4||a+3>r)return!1;const s=i.src.charCodeAt(a);if(s!==126&&s!==96)return!1;let o=a;a=i.skipChars(a,s);let l=a-o;if(l<3)return!1;const u=i.src.slice(o,a),f=i.src.slice(a,r);if(s===96&&f.indexOf(String.fromCharCode(s))>=0)return!1;if(n)return!0;let c=e,d=!1;for(;c++,!(c>=t||(a=o=i.bMarks[c]+i.tShift[c],r=i.eMarks[c],a<r&&i.sCount[c]<i.blkIndent));)if(i.src.charCodeAt(a)===s&&!(i.sCount[c]-i.blkIndent>=4)&&(a=i.skipChars(a,s),!(a-o<l)&&(a=i.skipSpaces(a),!(a<r)))){d=!0;break}l=i.sCount[e],i.line=c+(d?1:0);const h=i.push("fence","code",0);return h.info=f,h.content=i.getLines(e+1,c,l,!0),h.markup=u,h.map=[e,i.line],!0}function Cp(i,e,t,n){let a=i.bMarks[e]+i.tShift[e],r=i.eMarks[e];const s=i.lineMax;if(i.sCount[e]-i.blkIndent>=4||i.src.charCodeAt(a)!==62)return!1;if(n)return!0;const o=[],l=[],u=[],f=[],c=i.md.block.ruler.getRules("blockquote"),d=i.parentType;i.parentType="blockquote";let h=!1,p;for(p=e;p<t;p++){const w=i.sCount[p]<i.blkIndent;if(a=i.bMarks[p]+i.tShift[p],r=i.eMarks[p],a>=r)break;if(i.src.charCodeAt(a++)===62&&!w){let _=i.sCount[p]+1,F,D;i.src.charCodeAt(a)===32?(a++,_++,D=!1,F=!0):i.src.charCodeAt(a)===9?(F=!0,(i.bsCount[p]+_)%4===3?(a++,_++,D=!1):D=!0):F=!1;let O=_;for(o.push(i.bMarks[p]),i.bMarks[p]=a;a<r;){const H=i.src.charCodeAt(a);if(Qe(H))H===9?O+=4-(O+i.bsCount[p]+(D?1:0))%4:O++;else break;a++}h=a>=r,l.push(i.bsCount[p]),i.bsCount[p]=i.sCount[p]+1+(F?1:0),u.push(i.sCount[p]),i.sCount[p]=O-_,f.push(i.tShift[p]),i.tShift[p]=a-i.bMarks[p];continue}if(h)break;let C=!1;for(let _=0,F=c.length;_<F;_++)if(c[_](i,p,t,!0)){C=!0;break}if(C){i.lineMax=p,i.blkIndent!==0&&(o.push(i.bMarks[p]),l.push(i.bsCount[p]),f.push(i.tShift[p]),u.push(i.sCount[p]),i.sCount[p]-=i.blkIndent);break}o.push(i.bMarks[p]),l.push(i.bsCount[p]),f.push(i.tShift[p]),u.push(i.sCount[p]),i.sCount[p]=-1}const m=i.blkIndent;i.blkIndent=0;const g=i.push("blockquote_open","blockquote",1);g.markup=">";const y=[e,0];g.map=y,i.md.block.tokenize(i,e,p);const x=i.push("blockquote_close","blockquote",-1);x.markup=">",i.lineMax=s,i.parentType=d,y[1]=i.line;for(let w=0;w<f.length;w++)i.bMarks[w+e]=o[w],i.tShift[w+e]=f[w],i.sCount[w+e]=u[w],i.bsCount[w+e]=l[w];return i.blkIndent=m,!0}function _p(i,e,t,n){const a=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4)return!1;let r=i.bMarks[e]+i.tShift[e];const s=i.src.charCodeAt(r++);if(s!==42&&s!==45&&s!==95)return!1;let o=1;for(;r<a;){const u=i.src.charCodeAt(r++);if(u!==s&&!Qe(u))return!1;u===s&&o++}if(o<3)return!1;if(n)return!0;i.line=e+1;const l=i.push("hr","hr",0);return l.map=[e,i.line],l.markup=Array(o+1).join(String.fromCharCode(s)),!0}function Ql(i,e){const t=i.eMarks[e];let n=i.bMarks[e]+i.tShift[e];const a=i.src.charCodeAt(n++);if(a!==42&&a!==45&&a!==43)return-1;if(n<t){const r=i.src.charCodeAt(n);if(!Qe(r))return-1}return n}function Jl(i,e){const t=i.bMarks[e]+i.tShift[e],n=i.eMarks[e];let a=t;if(a+1>=n)return-1;let r=i.src.charCodeAt(a++);if(r<48||r>57)return-1;for(;;){if(a>=n)return-1;if(r=i.src.charCodeAt(a++),r>=48&&r<=57){if(a-t>=10)return-1;continue}if(r===41||r===46)break;return-1}return a<n&&(r=i.src.charCodeAt(a),!Qe(r))?-1:a}function Ap(i,e){const t=i.level+2;for(let n=e+2,a=i.tokens.length-2;n<a;n++)i.tokens[n].level===t&&i.tokens[n].type==="paragraph_open"&&(i.tokens[n+2].hidden=!0,i.tokens[n].hidden=!0,n+=2)}function kp(i,e,t,n){let a,r,s,o,l=e,u=!0;if(i.sCount[l]-i.blkIndent>=4||i.listIndent>=0&&i.sCount[l]-i.listIndent>=4&&i.sCount[l]<i.blkIndent)return!1;let f=!1;n&&i.parentType==="paragraph"&&i.sCount[l]>=i.blkIndent&&(f=!0);let c,d,h;if((h=Jl(i,l))>=0){if(c=!0,s=i.bMarks[l]+i.tShift[l],d=Number(i.src.slice(s,h-1)),f&&d!==1)return!1}else if((h=Ql(i,l))>=0)c=!1;else return!1;if(f&&i.skipSpaces(h)>=i.eMarks[l])return!1;if(n)return!0;const p=i.src.charCodeAt(h-1),m=i.tokens.length;c?(o=i.push("ordered_list_open","ol",1),d!==1&&(o.attrs=[["start",d]])):o=i.push("bullet_list_open","ul",1);const g=[l,0];o.map=g,o.markup=String.fromCharCode(p);let y=!1;const x=i.md.block.ruler.getRules("list"),w=i.parentType;for(i.parentType="list";l<t;){r=h,a=i.eMarks[l];const C=i.sCount[l]+h-(i.bMarks[l]+i.tShift[l]);let _=C;for(;r<a;){const S=i.src.charCodeAt(r);if(S===9)_+=4-(_+i.bsCount[l])%4;else if(S===32)_++;else break;r++}const F=r;let D;F>=a?D=1:D=_-C,D>4&&(D=1);const O=C+D;o=i.push("list_item_open","li",1),o.markup=String.fromCharCode(p);const H=[l,0];o.map=H,c&&(o.info=i.src.slice(s,h-1));const Y=i.tight,re=i.tShift[l],M=i.sCount[l],R=i.listIndent;if(i.listIndent=i.blkIndent,i.blkIndent=O,i.tight=!0,i.tShift[l]=F-i.bMarks[l],i.sCount[l]=_,F>=a&&i.isEmpty(l+1)?i.line=Math.min(i.line+2,t):i.md.block.tokenize(i,l,t,!0),(!i.tight||y)&&(u=!1),y=i.line-l>1&&i.isEmpty(i.line-1),i.blkIndent=i.listIndent,i.listIndent=R,i.tShift[l]=re,i.sCount[l]=M,i.tight=Y,o=i.push("list_item_close","li",-1),o.markup=String.fromCharCode(p),l=i.line,H[1]=l,l>=t||i.sCount[l]<i.blkIndent||i.sCount[l]-i.blkIndent>=4)break;let v=!1;for(let S=0,$=x.length;S<$;S++)if(x[S](i,l,t,!0)){v=!0;break}if(v)break;if(c){if(h=Jl(i,l),h<0)break;s=i.bMarks[l]+i.tShift[l]}else if(h=Ql(i,l),h<0)break;if(p!==i.src.charCodeAt(h-1))break}return c?o=i.push("ordered_list_close","ol",-1):o=i.push("bullet_list_close","ul",-1),o.markup=String.fromCharCode(p),g[1]=l,i.line=l,i.parentType=w,u&&Ap(i,m),!0}function Sp(i,e,t,n){let a=i.bMarks[e]+i.tShift[e],r=i.eMarks[e],s=e+1;if(i.sCount[e]-i.blkIndent>=4||i.src.charCodeAt(a)!==91)return!1;function o(x){const w=i.lineMax;if(x>=w||i.isEmpty(x))return null;let C=!1;if(i.sCount[x]-i.blkIndent>3&&(C=!0),i.sCount[x]<0&&(C=!0),!C){const D=i.md.block.ruler.getRules("reference"),O=i.parentType;i.parentType="reference";let H=!1;for(let Y=0,re=D.length;Y<re;Y++)if(D[Y](i,x,w,!0)){H=!0;break}if(i.parentType=O,H)return null}const _=i.bMarks[x]+i.tShift[x],F=i.eMarks[x];return i.src.slice(_,F+1)}let l=i.src.slice(a,r+1);r=l.length;let u=-1;for(a=1;a<r;a++){const x=l.charCodeAt(a);if(x===91)return!1;if(x===93){u=a;break}else if(x===10){const w=o(s);w!==null&&(l+=w,r=l.length,s++)}else if(x===92&&(a++,a<r&&l.charCodeAt(a)===10)){const w=o(s);w!==null&&(l+=w,r=l.length,s++)}}if(u<0||l.charCodeAt(u+1)!==58)return!1;for(a=u+2;a<r;a++){const x=l.charCodeAt(a);if(x===10){const w=o(s);w!==null&&(l+=w,r=l.length,s++)}else if(!Qe(x))break}const f=i.md.helpers.parseLinkDestination(l,a,r);if(!f.ok)return!1;const c=i.md.normalizeLink(f.str);if(!i.md.validateLink(c))return!1;a=f.pos;const d=a,h=s,p=a;for(;a<r;a++){const x=l.charCodeAt(a);if(x===10){const w=o(s);w!==null&&(l+=w,r=l.length,s++)}else if(!Qe(x))break}let m=i.md.helpers.parseLinkTitle(l,a,r);for(;m.can_continue;){const x=o(s);if(x===null)break;l+=x,a=r,r=l.length,s++,m=i.md.helpers.parseLinkTitle(l,a,r,m)}let g;for(a<r&&p!==a&&m.ok?(g=m.str,a=m.pos):(g="",a=d,s=h);a<r;){const x=l.charCodeAt(a);if(!Qe(x))break;a++}if(a<r&&l.charCodeAt(a)!==10&&g)for(g="",a=d,s=h;a<r;){const x=l.charCodeAt(a);if(!Qe(x))break;a++}if(a<r&&l.charCodeAt(a)!==10)return!1;const y=ar(l.slice(1,u));return y?(n||(typeof i.env.references>"u"&&(i.env.references={}),typeof i.env.references[y]>"u"&&(i.env.references[y]={title:g,href:c}),i.line=s),!0):!1}const Tp=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],Mp="[a-zA-Z_:][a-zA-Z0-9:._-]*",Lp="[^\"'=<>`\\x00-\\x20]+",Dp="'[^']*'",Bp='"[^"]*"',Fp="(?:"+Lp+"|"+Dp+"|"+Bp+")",Ip="(?:\\s+"+Mp+"(?:\\s*=\\s*"+Fp+")?)",ku="<[A-Za-z][A-Za-z0-9\\-]*"+Ip+"*\\s*\\/?>",Su="<\\/[A-Za-z][A-Za-z0-9\\-]*\\s*>",Pp="<!---?>|<!--(?:[^-]|-[^-]|--[^>])*-->",Rp="<[?][\\s\\S]*?[?]>",Op="<![A-Za-z][^>]*>",Np="<!\\[CDATA\\[[\\s\\S]*?\\]\\]>",Hp=new RegExp("^(?:"+ku+"|"+Su+"|"+Pp+"|"+Rp+"|"+Op+"|"+Np+")"),zp=new RegExp("^(?:"+ku+"|"+Su+")"),sn=[[/^<(script|pre|style|textarea)(?=(\s|>|$))/i,/<\/(script|pre|style|textarea)>/i,!0],[/^<!--/,/-->/,!0],[/^<\?/,/\?>/,!0],[/^<![A-Z]/,/>/,!0],[/^<!\[CDATA\[/,/\]\]>/,!0],[new RegExp("^</?("+Tp.join("|")+")(?=(\\s|/?>|$))","i"),/^$/,!0],[new RegExp(zp.source+"\\s*$"),/^$/,!1]];function Vp(i,e,t,n){let a=i.bMarks[e]+i.tShift[e],r=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4||!i.md.options.html||i.src.charCodeAt(a)!==60)return!1;let s=i.src.slice(a,r),o=0;for(;o<sn.length&&!sn[o][0].test(s);o++);if(o===sn.length)return!1;if(n)return sn[o][2];let l=e+1;if(!sn[o][1].test(s)){for(;l<t&&!(i.sCount[l]<i.blkIndent);l++)if(a=i.bMarks[l]+i.tShift[l],r=i.eMarks[l],s=i.src.slice(a,r),sn[o][1].test(s)){s.length!==0&&l++;break}}i.line=l;const u=i.push("html_block","",0);return u.map=[e,l],u.content=i.getLines(e,l,i.blkIndent,!0),!0}function Up(i,e,t,n){let a=i.bMarks[e]+i.tShift[e],r=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4)return!1;let s=i.src.charCodeAt(a);if(s!==35||a>=r)return!1;let o=1;for(s=i.src.charCodeAt(++a);s===35&&a<r&&o<=6;)o++,s=i.src.charCodeAt(++a);if(o>6||a<r&&!Qe(s))return!1;if(n)return!0;r=i.skipSpacesBack(r,a);const l=i.skipCharsBack(r,35,a);l>a&&Qe(i.src.charCodeAt(l-1))&&(r=l),i.line=e+1;const u=i.push("heading_open","h"+String(o),1);u.markup="########".slice(0,o),u.map=[e,i.line];const f=i.push("inline","",0);f.content=i.src.slice(a,r).trim(),f.map=[e,i.line],f.children=[];const c=i.push("heading_close","h"+String(o),-1);return c.markup="########".slice(0,o),!0}function Wp(i,e,t){const n=i.md.block.ruler.getRules("paragraph");if(i.sCount[e]-i.blkIndent>=4)return!1;const a=i.parentType;i.parentType="paragraph";let r=0,s,o=e+1;for(;o<t&&!i.isEmpty(o);o++){if(i.sCount[o]-i.blkIndent>3)continue;if(i.sCount[o]>=i.blkIndent){let h=i.bMarks[o]+i.tShift[o];const p=i.eMarks[o];if(h<p&&(s=i.src.charCodeAt(h),(s===45||s===61)&&(h=i.skipChars(h,s),h=i.skipSpaces(h),h>=p))){r=s===61?1:2;break}}if(i.sCount[o]<0)continue;let d=!1;for(let h=0,p=n.length;h<p;h++)if(n[h](i,o,t,!0)){d=!0;break}if(d)break}if(!r)return!1;const l=i.getLines(e,o,i.blkIndent,!1).trim();i.line=o+1;const u=i.push("heading_open","h"+String(r),1);u.markup=String.fromCharCode(s),u.map=[e,i.line];const f=i.push("inline","",0);f.content=l,f.map=[e,i.line-1],f.children=[];const c=i.push("heading_close","h"+String(r),-1);return c.markup=String.fromCharCode(s),i.parentType=a,!0}function Gp(i,e,t){const n=i.md.block.ruler.getRules("paragraph"),a=i.parentType;let r=e+1;for(i.parentType="paragraph";r<t&&!i.isEmpty(r);r++){if(i.sCount[r]-i.blkIndent>3||i.sCount[r]<0)continue;let u=!1;for(let f=0,c=n.length;f<c;f++)if(n[f](i,r,t,!0)){u=!0;break}if(u)break}const s=i.getLines(e,r,i.blkIndent,!1).trim();i.line=r;const o=i.push("paragraph_open","p",1);o.map=[e,i.line];const l=i.push("inline","",0);return l.content=s,l.map=[e,i.line],l.children=[],i.push("paragraph_close","p",-1),i.parentType=a,!0}const ga=[["table",vp,["paragraph","reference"]],["code",xp],["fence",Ep,["paragraph","reference","blockquote","list"]],["blockquote",Cp,["paragraph","reference","blockquote","list"]],["hr",_p,["paragraph","reference","blockquote","list"]],["list",kp,["paragraph","reference","blockquote"]],["reference",Sp],["html_block",Vp,["paragraph","reference","blockquote"]],["heading",Up,["paragraph","reference","blockquote"]],["lheading",Wp],["paragraph",Gp]];function rr(){this.ruler=new Lt;for(let i=0;i<ga.length;i++)this.ruler.push(ga[i][0],ga[i][1],{alt:(ga[i][2]||[]).slice()})}rr.prototype.tokenize=function(i,e,t){const n=this.ruler.getRules(""),a=n.length,r=i.md.options.maxNesting;let s=e,o=!1;for(;s<t&&(i.line=s=i.skipEmptyLines(s),!(s>=t||i.sCount[s]<i.blkIndent));){if(i.level>=r){i.line=t;break}const l=i.line;let u=!1;for(let f=0;f<a;f++)if(u=n[f](i,s,t,!1),u){if(l>=i.line)throw new Error("block rule didn't increment state.line");break}if(!u)throw new Error("none of the block rules matched");i.tight=!o,i.isEmpty(i.line-1)&&(o=!0),s=i.line,s<t&&i.isEmpty(s)&&(o=!0,s++,i.line=s)}};rr.prototype.parse=function(i,e,t,n){if(!i)return;const a=new this.State(i,e,t,n);this.tokenize(a,a.line,a.lineMax)};rr.prototype.State=yi;function ua(i,e,t,n){this.src=i,this.env=t,this.md=e,this.tokens=n,this.tokens_meta=Array(n.length),this.pos=0,this.posMax=this.src.length,this.level=0,this.pending="",this.pendingLevel=0,this.cache={},this.delimiters=[],this._prev_delimiters=[],this.backticks={},this.backticksScanned=!1,this.linkLevel=0}ua.prototype.pushPending=function(){const i=new ri("text","",0);return i.content=this.pending,i.level=this.pendingLevel,this.tokens.push(i),this.pending="",i};ua.prototype.push=function(i,e,t){this.pending&&this.pushPending();const n=new ri(i,e,t);let a=null;return t<0&&(this.level--,this.delimiters=this._prev_delimiters.pop()),n.level=this.level,t>0&&(this.level++,this._prev_delimiters.push(this.delimiters),this.delimiters=[],a={delimiters:this.delimiters}),this.pendingLevel=this.level,this.tokens.push(n),this.tokens_meta.push(a),n};ua.prototype.scanDelims=function(i,e){const t=this.posMax,n=this.src.charCodeAt(i),a=i>0?this.src.charCodeAt(i-1):32;let r=i;for(;r<t&&this.src.charCodeAt(r)===n;)r++;const s=r-i,o=r<t?this.src.charCodeAt(r):32,l=na(a)||ia(String.fromCharCode(a)),u=na(o)||ia(String.fromCharCode(o)),f=ta(a),c=ta(o),d=!c&&(!u||f||l),h=!f&&(!l||c||u);return{can_open:d&&(e||!h||l),can_close:h&&(e||!d||u),length:s}};ua.prototype.Token=ri;function qp(i){switch(i){case 10:case 33:case 35:case 36:case 37:case 38:case 42:case 43:case 45:case 58:case 60:case 61:case 62:case 64:case 91:case 92:case 93:case 94:case 95:case 96:case 123:case 125:case 126:return!0;default:return!1}}function jp(i,e){let t=i.pos;for(;t<i.posMax&&!qp(i.src.charCodeAt(t));)t++;return t===i.pos?!1:(e||(i.pending+=i.src.slice(i.pos,t)),i.pos=t,!0)}const $p=/(?:^|[^a-z0-9.+-])([a-z][a-z0-9.+-]*)$/i;function Yp(i,e){if(!i.md.options.linkify||i.linkLevel>0)return!1;const t=i.pos,n=i.posMax;if(t+3>n||i.src.charCodeAt(t)!==58||i.src.charCodeAt(t+1)!==47||i.src.charCodeAt(t+2)!==47)return!1;const a=i.pending.match($p);if(!a)return!1;const r=a[1],s=i.md.linkify.matchAtStart(i.src.slice(t-r.length));if(!s)return!1;let o=s.url;if(o.length<=r.length)return!1;o=o.replace(/\*+$/,"");const l=i.md.normalizeLink(o);if(!i.md.validateLink(l))return!1;if(!e){i.pending=i.pending.slice(0,-r.length);const u=i.push("link_open","a",1);u.attrs=[["href",l]],u.markup="linkify",u.info="auto";const f=i.push("text","",0);f.content=i.md.normalizeLinkText(o);const c=i.push("link_close","a",-1);c.markup="linkify",c.info="auto"}return i.pos+=o.length-r.length,!0}function Kp(i,e){let t=i.pos;if(i.src.charCodeAt(t)!==10)return!1;const n=i.pending.length-1,a=i.posMax;if(!e)if(n>=0&&i.pending.charCodeAt(n)===32)if(n>=1&&i.pending.charCodeAt(n-1)===32){let r=n-1;for(;r>=1&&i.pending.charCodeAt(r-1)===32;)r--;i.pending=i.pending.slice(0,r),i.push("hardbreak","br",0)}else i.pending=i.pending.slice(0,-1),i.push("softbreak","br",0);else i.push("softbreak","br",0);for(t++;t<a&&Qe(i.src.charCodeAt(t));)t++;return i.pos=t,!0}const _o=[];for(let i=0;i<256;i++)_o.push(0);"\\!\"#$%&'()*+,./:;<=>?@[]^_`{|}~-".split("").forEach(function(i){_o[i.charCodeAt(0)]=1});function Xp(i,e){let t=i.pos;const n=i.posMax;if(i.src.charCodeAt(t)!==92||(t++,t>=n))return!1;let a=i.src.charCodeAt(t);if(a===10){for(e||i.push("hardbreak","br",0),t++;t<n&&(a=i.src.charCodeAt(t),!!Qe(a));)t++;return i.pos=t,!0}let r=i.src[t];if(a>=55296&&a<=56319&&t+1<n){const o=i.src.charCodeAt(t+1);o>=56320&&o<=57343&&(r+=i.src[t+1],t++)}const s="\\"+r;if(!e){const o=i.push("text_special","",0);a<256&&_o[a]!==0?o.content=r:o.content=s,o.markup=s,o.info="escape"}return i.pos=t+1,!0}function Zp(i,e){let t=i.pos;if(i.src.charCodeAt(t)!==96)return!1;const a=t;t++;const r=i.posMax;for(;t<r&&i.src.charCodeAt(t)===96;)t++;const s=i.src.slice(a,t),o=s.length;if(i.backticksScanned&&(i.backticks[o]||0)<=a)return e||(i.pending+=s),i.pos+=o,!0;let l=t,u;for(;(u=i.src.indexOf("`",l))!==-1;){for(l=u+1;l<r&&i.src.charCodeAt(l)===96;)l++;const f=l-u;if(f===o){if(!e){const c=i.push("code_inline","code",0);c.markup=s,c.content=i.src.slice(t,u).replace(/\n/g," ").replace(/^ (.+) $/,"$1")}return i.pos=l,!0}i.backticks[f]=u}return i.backticksScanned=!0,e||(i.pending+=s),i.pos+=o,!0}function Qp(i,e){const t=i.pos,n=i.src.charCodeAt(t);if(e||n!==126)return!1;const a=i.scanDelims(i.pos,!0);let r=a.length;const s=String.fromCharCode(n);if(r<2)return!1;let o;r%2&&(o=i.push("text","",0),o.content=s,r--);for(let l=0;l<r;l+=2)o=i.push("text","",0),o.content=s+s,i.delimiters.push({marker:n,length:0,token:i.tokens.length-1,end:-1,open:a.can_open,close:a.can_close});return i.pos+=a.length,!0}function ec(i,e){let t;const n=[],a=e.length;for(let r=0;r<a;r++){const s=e[r];if(s.marker!==126||s.end===-1)continue;const o=e[s.end];t=i.tokens[s.token],t.type="s_open",t.tag="s",t.nesting=1,t.markup="~~",t.content="",t=i.tokens[o.token],t.type="s_close",t.tag="s",t.nesting=-1,t.markup="~~",t.content="",i.tokens[o.token-1].type==="text"&&i.tokens[o.token-1].content==="~"&&n.push(o.token-1)}for(;n.length;){const r=n.pop();let s=r+1;for(;s<i.tokens.length&&i.tokens[s].type==="s_close";)s++;s--,r!==s&&(t=i.tokens[s],i.tokens[s]=i.tokens[r],i.tokens[r]=t)}}function Jp(i){const e=i.tokens_meta,t=i.tokens_meta.length;ec(i,i.delimiters);for(let n=0;n<t;n++)e[n]&&e[n].delimiters&&ec(i,e[n].delimiters)}const Tu={tokenize:Qp,postProcess:Jp};function e0(i,e){const t=i.pos,n=i.src.charCodeAt(t);if(e||n!==95&&n!==42)return!1;const a=i.scanDelims(i.pos,n===42);for(let r=0;r<a.length;r++){const s=i.push("text","",0);s.content=String.fromCharCode(n),i.delimiters.push({marker:n,length:a.length,token:i.tokens.length-1,end:-1,open:a.can_open,close:a.can_close})}return i.pos+=a.length,!0}function tc(i,e){const t=e.length;for(let n=t-1;n>=0;n--){const a=e[n];if(a.marker!==95&&a.marker!==42||a.end===-1)continue;const r=e[a.end],s=n>0&&e[n-1].end===a.end+1&&e[n-1].marker===a.marker&&e[n-1].token===a.token-1&&e[a.end+1].token===r.token+1,o=String.fromCharCode(a.marker),l=i.tokens[a.token];l.type=s?"strong_open":"em_open",l.tag=s?"strong":"em",l.nesting=1,l.markup=s?o+o:o,l.content="";const u=i.tokens[r.token];u.type=s?"strong_close":"em_close",u.tag=s?"strong":"em",u.nesting=-1,u.markup=s?o+o:o,u.content="",s&&(i.tokens[e[n-1].token].content="",i.tokens[e[a.end+1].token].content="",n--)}}function t0(i){const e=i.tokens_meta,t=i.tokens_meta.length;tc(i,i.delimiters);for(let n=0;n<t;n++)e[n]&&e[n].delimiters&&tc(i,e[n].delimiters)}const Mu={tokenize:e0,postProcess:t0};function i0(i,e){let t,n,a,r,s="",o="",l=i.pos,u=!0;if(i.src.charCodeAt(i.pos)!==91)return!1;const f=i.pos,c=i.posMax,d=i.pos+1,h=i.md.helpers.parseLinkLabel(i,i.pos,!0);if(h<0)return!1;let p=h+1;if(p<c&&i.src.charCodeAt(p)===40){for(u=!1,p++;p<c&&(t=i.src.charCodeAt(p),!(!Qe(t)&&t!==10));p++);if(p>=c)return!1;if(l=p,a=i.md.helpers.parseLinkDestination(i.src,p,i.posMax),a.ok){for(s=i.md.normalizeLink(a.str),i.md.validateLink(s)?p=a.pos:s="",l=p;p<c&&(t=i.src.charCodeAt(p),!(!Qe(t)&&t!==10));p++);if(a=i.md.helpers.parseLinkTitle(i.src,p,i.posMax),p<c&&l!==p&&a.ok)for(o=a.str,p=a.pos;p<c&&(t=i.src.charCodeAt(p),!(!Qe(t)&&t!==10));p++);}(p>=c||i.src.charCodeAt(p)!==41)&&(u=!0),p++}if(u){if(typeof i.env.references>"u")return!1;if(p<c&&i.src.charCodeAt(p)===91?(l=p+1,p=i.md.helpers.parseLinkLabel(i,p),p>=0?n=i.src.slice(l,p++):p=h+1):p=h+1,n||(n=i.src.slice(d,h)),r=i.env.references[ar(n)],!r)return i.pos=f,!1;s=r.href,o=r.title}if(!e){i.pos=d,i.posMax=h;const m=i.push("link_open","a",1),g=[["href",s]];m.attrs=g,o&&g.push(["title",o]),i.linkLevel++,i.md.inline.tokenize(i),i.linkLevel--,i.push("link_close","a",-1)}return i.pos=p,i.posMax=c,!0}function n0(i,e){let t,n,a,r,s,o,l,u,f="";const c=i.pos,d=i.posMax;if(i.src.charCodeAt(i.pos)!==33||i.src.charCodeAt(i.pos+1)!==91)return!1;const h=i.pos+2,p=i.md.helpers.parseLinkLabel(i,i.pos+1,!1);if(p<0)return!1;if(r=p+1,r<d&&i.src.charCodeAt(r)===40){for(r++;r<d&&(t=i.src.charCodeAt(r),!(!Qe(t)&&t!==10));r++);if(r>=d)return!1;for(u=r,o=i.md.helpers.parseLinkDestination(i.src,r,i.posMax),o.ok&&(f=i.md.normalizeLink(o.str),i.md.validateLink(f)?r=o.pos:f=""),u=r;r<d&&(t=i.src.charCodeAt(r),!(!Qe(t)&&t!==10));r++);if(o=i.md.helpers.parseLinkTitle(i.src,r,i.posMax),r<d&&u!==r&&o.ok)for(l=o.str,r=o.pos;r<d&&(t=i.src.charCodeAt(r),!(!Qe(t)&&t!==10));r++);else l="";if(r>=d||i.src.charCodeAt(r)!==41)return i.pos=c,!1;r++}else{if(typeof i.env.references>"u")return!1;if(r<d&&i.src.charCodeAt(r)===91?(u=r+1,r=i.md.helpers.parseLinkLabel(i,r),r>=0?a=i.src.slice(u,r++):r=p+1):r=p+1,a||(a=i.src.slice(h,p)),s=i.env.references[ar(a)],!s)return i.pos=c,!1;f=s.href,l=s.title}if(!e){n=i.src.slice(h,p);const m=[];i.md.inline.parse(n,i.md,i.env,m);const g=i.push("image","img",0),y=[["src",f],["alt",""]];g.attrs=y,g.children=m,g.content=n,l&&y.push(["title",l])}return i.pos=r,i.posMax=d,!0}const a0=/^([a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)$/,r0=/^([a-zA-Z][a-zA-Z0-9+.-]{1,31}):([^<>\x00-\x20]*)$/;function s0(i,e){let t=i.pos;if(i.src.charCodeAt(t)!==60)return!1;const n=i.pos,a=i.posMax;for(;;){if(++t>=a)return!1;const s=i.src.charCodeAt(t);if(s===60)return!1;if(s===62)break}const r=i.src.slice(n+1,t);if(r0.test(r)){const s=i.md.normalizeLink(r);if(!i.md.validateLink(s))return!1;if(!e){const o=i.push("link_open","a",1);o.attrs=[["href",s]],o.markup="autolink",o.info="auto";const l=i.push("text","",0);l.content=i.md.normalizeLinkText(r);const u=i.push("link_close","a",-1);u.markup="autolink",u.info="auto"}return i.pos+=r.length+2,!0}if(a0.test(r)){const s=i.md.normalizeLink("mailto:"+r);if(!i.md.validateLink(s))return!1;if(!e){const o=i.push("link_open","a",1);o.attrs=[["href",s]],o.markup="autolink",o.info="auto";const l=i.push("text","",0);l.content=i.md.normalizeLinkText(r);const u=i.push("link_close","a",-1);u.markup="autolink",u.info="auto"}return i.pos+=r.length+2,!0}return!1}function o0(i){return/^<a[>\s]/i.test(i)}function l0(i){return/^<\/a\s*>/i.test(i)}function c0(i){const e=i|32;return e>=97&&e<=122}function u0(i,e){if(!i.md.options.html)return!1;const t=i.posMax,n=i.pos;if(i.src.charCodeAt(n)!==60||n+2>=t)return!1;const a=i.src.charCodeAt(n+1);if(a!==33&&a!==63&&a!==47&&!c0(a))return!1;const r=i.src.slice(n).match(Hp);if(!r)return!1;if(!e){const s=i.push("html_inline","",0);s.content=r[0],o0(s.content)&&i.linkLevel++,l0(s.content)&&i.linkLevel--}return i.pos+=r[0].length,!0}const d0=/^&#((?:x[a-f0-9]{1,6}|[0-9]{1,7}));/i,h0=/^&([a-z][a-z0-9]{1,31});/i;function f0(i,e){const t=i.pos,n=i.posMax;if(i.src.charCodeAt(t)!==38||t+1>=n)return!1;if(i.src.charCodeAt(t+1)===35){const r=i.src.slice(t).match(d0);if(r){if(!e){const s=r[1][0].toLowerCase()==="x"?parseInt(r[1].slice(1),16):parseInt(r[1],10),o=i.push("text_special","",0);o.content=Eo(s)?za(s):za(65533),o.markup=r[0],o.info="entity"}return i.pos+=r[0].length,!0}}else{const r=i.src.slice(t).match(h0);if(r){const s=xu(r[0]);if(s!==r[0]){if(!e){const o=i.push("text_special","",0);o.content=s,o.markup=r[0],o.info="entity"}return i.pos+=r[0].length,!0}}}return!1}function ic(i){const e={},t=i.length;if(!t)return;let n=0,a=-2;const r=[];for(let s=0;s<t;s++){const o=i[s];if(r.push(0),(i[n].marker!==o.marker||a!==o.token-1)&&(n=s),a=o.token,o.length=o.length||0,!o.close)continue;e.hasOwnProperty(o.marker)||(e[o.marker]=[-1,-1,-1,-1,-1,-1]);const l=e[o.marker][(o.open?3:0)+o.length%3];let u=n-r[n]-1,f=u;for(;u>l;u-=r[u]+1){const c=i[u];if(c.marker===o.marker&&c.open&&c.end<0){let d=!1;if((c.close||o.open)&&(c.length+o.length)%3===0&&(c.length%3!==0||o.length%3!==0)&&(d=!0),!d){const h=u>0&&!i[u-1].open?r[u-1]+1:0;r[s]=s-u+h,r[u]=h,o.open=!1,c.end=s,c.close=!1,f=-1,a=-2;break}}}f!==-1&&(e[o.marker][(o.open?3:0)+(o.length||0)%3]=f)}}function p0(i){const e=i.tokens_meta,t=i.tokens_meta.length;ic(i.delimiters);for(let n=0;n<t;n++)e[n]&&e[n].delimiters&&ic(e[n].delimiters)}function m0(i){let e,t,n=0;const a=i.tokens,r=i.tokens.length;for(e=t=0;e<r;e++)a[e].nesting<0&&n--,a[e].level=n,a[e].nesting>0&&n++,a[e].type==="text"&&e+1<r&&a[e+1].type==="text"?a[e+1].content=a[e].content+a[e+1].content:(e!==t&&(a[t]=a[e]),t++);e!==t&&(a.length=t)}const ds=[["text",jp],["linkify",Yp],["newline",Kp],["escape",Xp],["backticks",Zp],["strikethrough",Tu.tokenize],["emphasis",Mu.tokenize],["link",i0],["image",n0],["autolink",s0],["html_inline",u0],["entity",f0]],hs=[["balance_pairs",p0],["strikethrough",Tu.postProcess],["emphasis",Mu.postProcess],["fragments_join",m0]];function da(){this.ruler=new Lt;for(let i=0;i<ds.length;i++)this.ruler.push(ds[i][0],ds[i][1]);this.ruler2=new Lt;for(let i=0;i<hs.length;i++)this.ruler2.push(hs[i][0],hs[i][1])}da.prototype.skipToken=function(i){const e=i.pos,t=this.ruler.getRules(""),n=t.length,a=i.md.options.maxNesting,r=i.cache;if(typeof r[e]<"u"){i.pos=r[e];return}let s=!1;if(i.level<a){for(let o=0;o<n;o++)if(i.level++,s=t[o](i,!0),i.level--,s){if(e>=i.pos)throw new Error("inline rule didn't increment state.pos");break}}else i.pos=i.posMax;s||i.pos++,r[e]=i.pos};da.prototype.tokenize=function(i){const e=this.ruler.getRules(""),t=e.length,n=i.posMax,a=i.md.options.maxNesting;for(;i.pos<n;){const r=i.pos;let s=!1;if(i.level<a){for(let o=0;o<t;o++)if(s=e[o](i,!1),s){if(r>=i.pos)throw new Error("inline rule didn't increment state.pos");break}}if(s){if(i.pos>=n)break;continue}i.pending+=i.src[i.pos++]}i.pending&&i.pushPending()};da.prototype.parse=function(i,e,t,n){const a=new this.State(i,e,t,n);this.tokenize(a);const r=this.ruler2.getRules(""),s=r.length;for(let o=0;o<s;o++)r[o](a)};da.prototype.State=ua;function g0(i){const e={};i=i||{},e.src_Any=gu.source,e.src_Cc=bu.source,e.src_Z=wu.source,e.src_P=vo.source,e.src_ZPCc=[e.src_Z,e.src_P,e.src_Cc].join("|"),e.src_ZCc=[e.src_Z,e.src_Cc].join("|");const t="[><｜]";return e.src_pseudo_letter="(?:(?!"+t+"|"+e.src_ZPCc+")"+e.src_Any+")",e.src_ip4="(?:(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)",e.src_auth="(?:(?:(?!"+e.src_ZCc+"|[@/\\[\\]()]).)+@)?",e.src_port="(?::(?:6(?:[0-4]\\d{3}|5(?:[0-4]\\d{2}|5(?:[0-2]\\d|3[0-5])))|[1-5]?\\d{1,4}))?",e.src_host_terminator="(?=$|"+t+"|"+e.src_ZPCc+")(?!"+(i["---"]?"-(?!--)|":"-|")+"_|:\\d|\\.-|\\.(?!$|"+e.src_ZPCc+"))",e.src_path="(?:[/?#](?:(?!"+e.src_ZCc+"|"+t+`|[()[\\]{}.,"'?!\\-;]).|\\[(?:(?!`+e.src_ZCc+"|\\]).)*\\]|\\((?:(?!"+e.src_ZCc+"|[)]).)*\\)|\\{(?:(?!"+e.src_ZCc+'|[}]).)*\\}|\\"(?:(?!'+e.src_ZCc+`|["]).)+\\"|\\'(?:(?!`+e.src_ZCc+"|[']).)+\\'|\\'(?="+e.src_pseudo_letter+"|[-])|\\.{2,}[a-zA-Z0-9%/&]|\\.(?!"+e.src_ZCc+"|[.]|$)|"+(i["---"]?"\\-(?!--(?:[^-]|$))(?:-*)|":"\\-+|")+",(?!"+e.src_ZCc+"|$)|;(?!"+e.src_ZCc+"|$)|\\!+(?!"+e.src_ZCc+"|[!]|$)|\\?(?!"+e.src_ZCc+"|[?]|$))+|\\/)?",e.src_email_name='[\\-;:&=\\+\\$,\\.a-zA-Z0-9_][\\-;:&=\\+\\$,\\"\\.a-zA-Z0-9_]*',e.src_xn="xn--[a-z0-9\\-]{1,59}",e.src_domain_root="(?:"+e.src_xn+"|"+e.src_pseudo_letter+"{1,63})",e.src_domain="(?:"+e.src_xn+"|(?:"+e.src_pseudo_letter+")|(?:"+e.src_pseudo_letter+"(?:-|"+e.src_pseudo_letter+"){0,61}"+e.src_pseudo_letter+"))",e.src_host="(?:(?:(?:(?:"+e.src_domain+")\\.)*"+e.src_domain+"))",e.tpl_host_fuzzy="(?:"+e.src_ip4+"|(?:(?:(?:"+e.src_domain+")\\.)+(?:%TLDS%)))",e.tpl_host_no_ip_fuzzy="(?:(?:(?:"+e.src_domain+")\\.)+(?:%TLDS%))",e.src_host_strict=e.src_host+e.src_host_terminator,e.tpl_host_fuzzy_strict=e.tpl_host_fuzzy+e.src_host_terminator,e.src_host_port_strict=e.src_host+e.src_port+e.src_host_terminator,e.tpl_host_port_fuzzy_strict=e.tpl_host_fuzzy+e.src_port+e.src_host_terminator,e.tpl_host_port_no_ip_fuzzy_strict=e.tpl_host_no_ip_fuzzy+e.src_port+e.src_host_terminator,e.tpl_host_fuzzy_test="localhost|www\\.|\\.\\d{1,3}\\.|(?:\\.(?:%TLDS%)(?:"+e.src_ZPCc+"|>|$))",e.tpl_email_fuzzy="(^|"+t+'|"|\\(|'+e.src_ZCc+")("+e.src_email_name+"@"+e.tpl_host_fuzzy_strict+")",e.tpl_link_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+e.src_ZPCc+"))((?![$+<=>^`|｜])"+e.tpl_host_port_fuzzy_strict+e.src_path+")",e.tpl_link_no_ip_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+e.src_ZPCc+"))((?![$+<=>^`|｜])"+e.tpl_host_port_no_ip_fuzzy_strict+e.src_path+")",e}function js(i){return Array.prototype.slice.call(arguments,1).forEach(function(t){t&&Object.keys(t).forEach(function(n){i[n]=t[n]})}),i}function sr(i){return Object.prototype.toString.call(i)}function b0(i){return sr(i)==="[object String]"}function y0(i){return sr(i)==="[object Object]"}function w0(i){return sr(i)==="[object RegExp]"}function nc(i){return sr(i)==="[object Function]"}function v0(i){return i.replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}const Lu={fuzzyLink:!0,fuzzyEmail:!0,fuzzyIP:!1};function x0(i){return Object.keys(i||{}).reduce(function(e,t){return e||Lu.hasOwnProperty(t)},!1)}const E0={"http:":{validate:function(i,e,t){const n=i.slice(e);return t.re.http||(t.re.http=new RegExp("^\\/\\/"+t.re.src_auth+t.re.src_host_port_strict+t.re.src_path,"i")),t.re.http.test(n)?n.match(t.re.http)[0].length:0}},"https:":"http:","ftp:":"http:","//":{validate:function(i,e,t){const n=i.slice(e);return t.re.no_http||(t.re.no_http=new RegExp("^"+t.re.src_auth+"(?:localhost|(?:(?:"+t.re.src_domain+")\\.)+"+t.re.src_domain_root+")"+t.re.src_port+t.re.src_host_terminator+t.re.src_path,"i")),t.re.no_http.test(n)?e>=3&&i[e-3]===":"||e>=3&&i[e-3]==="/"?0:n.match(t.re.no_http)[0].length:0}},"mailto:":{validate:function(i,e,t){const n=i.slice(e);return t.re.mailto||(t.re.mailto=new RegExp("^"+t.re.src_email_name+"@"+t.re.src_host_strict,"i")),t.re.mailto.test(n)?n.match(t.re.mailto)[0].length:0}}},C0="a[cdefgilmnoqrstuwxz]|b[abdefghijmnorstvwyz]|c[acdfghiklmnoruvwxyz]|d[ejkmoz]|e[cegrstu]|f[ijkmor]|g[abdefghilmnpqrstuwy]|h[kmnrtu]|i[delmnoqrst]|j[emop]|k[eghimnprwyz]|l[abcikrstuvy]|m[acdeghklmnopqrstuvwxyz]|n[acefgilopruz]|om|p[aefghklmnrstwy]|qa|r[eosuw]|s[abcdeghijklmnortuvxyz]|t[cdfghjklmnortvwz]|u[agksyz]|v[aceginu]|w[fs]|y[et]|z[amw]",_0="biz|com|edu|gov|net|org|pro|web|xxx|aero|asia|coop|info|museum|name|shop|рф".split("|");function A0(i){i.__index__=-1,i.__text_cache__=""}function k0(i){return function(e,t){const n=e.slice(t);return i.test(n)?n.match(i)[0].length:0}}function ac(){return function(i,e){e.normalize(i)}}function Va(i){const e=i.re=g0(i.__opts__),t=i.__tlds__.slice();i.onCompile(),i.__tlds_replaced__||t.push(C0),t.push(e.src_xn),e.src_tlds=t.join("|");function n(o){return o.replace("%TLDS%",e.src_tlds)}e.email_fuzzy=RegExp(n(e.tpl_email_fuzzy),"i"),e.link_fuzzy=RegExp(n(e.tpl_link_fuzzy),"i"),e.link_no_ip_fuzzy=RegExp(n(e.tpl_link_no_ip_fuzzy),"i"),e.host_fuzzy_test=RegExp(n(e.tpl_host_fuzzy_test),"i");const a=[];i.__compiled__={};function r(o,l){throw new Error('(LinkifyIt) Invalid schema "'+o+'": '+l)}Object.keys(i.__schemas__).forEach(function(o){const l=i.__schemas__[o];if(l===null)return;const u={validate:null,link:null};if(i.__compiled__[o]=u,y0(l)){w0(l.validate)?u.validate=k0(l.validate):nc(l.validate)?u.validate=l.validate:r(o,l),nc(l.normalize)?u.normalize=l.normalize:l.normalize?r(o,l):u.normalize=ac();return}if(b0(l)){a.push(o);return}r(o,l)}),a.forEach(function(o){i.__compiled__[i.__schemas__[o]]&&(i.__compiled__[o].validate=i.__compiled__[i.__schemas__[o]].validate,i.__compiled__[o].normalize=i.__compiled__[i.__schemas__[o]].normalize)}),i.__compiled__[""]={validate:null,normalize:ac()};const s=Object.keys(i.__compiled__).filter(function(o){return o.length>0&&i.__compiled__[o]}).map(v0).join("|");i.re.schema_test=RegExp("(^|(?!_)(?:[><｜]|"+e.src_ZPCc+"))("+s+")","i"),i.re.schema_search=RegExp("(^|(?!_)(?:[><｜]|"+e.src_ZPCc+"))("+s+")","ig"),i.re.schema_at_start=RegExp("^"+i.re.schema_search.source,"i"),i.re.pretest=RegExp("("+i.re.schema_test.source+")|("+i.re.host_fuzzy_test.source+")|@","i"),A0(i)}function S0(i,e){const t=i.__index__,n=i.__last_index__,a=i.__text_cache__.slice(t,n);this.schema=i.__schema__.toLowerCase(),this.index=t+e,this.lastIndex=n+e,this.raw=a,this.text=a,this.url=a}function $s(i,e){const t=new S0(i,e);return i.__compiled__[t.schema].normalize(t,i),t}function Rt(i,e){if(!(this instanceof Rt))return new Rt(i,e);e||x0(i)&&(e=i,i={}),this.__opts__=js({},Lu,e),this.__index__=-1,this.__last_index__=-1,this.__schema__="",this.__text_cache__="",this.__schemas__=js({},E0,i),this.__compiled__={},this.__tlds__=_0,this.__tlds_replaced__=!1,this.re={},Va(this)}Rt.prototype.add=function(e,t){return this.__schemas__[e]=t,Va(this),this};Rt.prototype.set=function(e){return this.__opts__=js(this.__opts__,e),this};Rt.prototype.test=function(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return!1;let t,n,a,r,s,o,l,u,f;if(this.re.schema_test.test(e)){for(l=this.re.schema_search,l.lastIndex=0;(t=l.exec(e))!==null;)if(r=this.testSchemaAt(e,t[2],l.lastIndex),r){this.__schema__=t[2],this.__index__=t.index+t[1].length,this.__last_index__=t.index+t[0].length+r;break}}return this.__opts__.fuzzyLink&&this.__compiled__["http:"]&&(u=e.search(this.re.host_fuzzy_test),u>=0&&(this.__index__<0||u<this.__index__)&&(n=e.match(this.__opts__.fuzzyIP?this.re.link_fuzzy:this.re.link_no_ip_fuzzy))!==null&&(s=n.index+n[1].length,(this.__index__<0||s<this.__index__)&&(this.__schema__="",this.__index__=s,this.__last_index__=n.index+n[0].length))),this.__opts__.fuzzyEmail&&this.__compiled__["mailto:"]&&(f=e.indexOf("@"),f>=0&&(a=e.match(this.re.email_fuzzy))!==null&&(s=a.index+a[1].length,o=a.index+a[0].length,(this.__index__<0||s<this.__index__||s===this.__index__&&o>this.__last_index__)&&(this.__schema__="mailto:",this.__index__=s,this.__last_index__=o))),this.__index__>=0};Rt.prototype.pretest=function(e){return this.re.pretest.test(e)};Rt.prototype.testSchemaAt=function(e,t,n){return this.__compiled__[t.toLowerCase()]?this.__compiled__[t.toLowerCase()].validate(e,n,this):0};Rt.prototype.match=function(e){const t=[];let n=0;this.__index__>=0&&this.__text_cache__===e&&(t.push($s(this,n)),n=this.__last_index__);let a=n?e.slice(n):e;for(;this.test(a);)t.push($s(this,n)),a=a.slice(this.__last_index__),n+=this.__last_index__;return t.length?t:null};Rt.prototype.matchAtStart=function(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return null;const t=this.re.schema_at_start.exec(e);if(!t)return null;const n=this.testSchemaAt(e,t[2],t[0].length);return n?(this.__schema__=t[2],this.__index__=t.index+t[1].length,this.__last_index__=t.index+t[0].length+n,$s(this,0)):null};Rt.prototype.tlds=function(e,t){return e=Array.isArray(e)?e:[e],t?(this.__tlds__=this.__tlds__.concat(e).sort().filter(function(n,a,r){return n!==r[a-1]}).reverse(),Va(this),this):(this.__tlds__=e.slice(),this.__tlds_replaced__=!0,Va(this),this)};Rt.prototype.normalize=function(e){e.schema||(e.url="http://"+e.url),e.schema==="mailto:"&&!/^mailto:/i.test(e.url)&&(e.url="mailto:"+e.url)};Rt.prototype.onCompile=function(){};const wn=2147483647,fi=36,Ao=1,aa=26,T0=38,M0=700,Du=72,Bu=128,Fu="-",L0=/^xn--/,D0=/[^\0-\x7F]/,B0=/[\x2E\u3002\uFF0E\uFF61]/g,F0={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},fs=fi-Ao,pi=Math.floor,ps=String.fromCharCode;function Di(i){throw new RangeError(F0[i])}function I0(i,e){const t=[];let n=i.length;for(;n--;)t[n]=e(i[n]);return t}function Iu(i,e){const t=i.split("@");let n="";t.length>1&&(n=t[0]+"@",i=t[1]),i=i.replace(B0,".");const a=i.split("."),r=I0(a,e).join(".");return n+r}function Pu(i){const e=[];let t=0;const n=i.length;for(;t<n;){const a=i.charCodeAt(t++);if(a>=55296&&a<=56319&&t<n){const r=i.charCodeAt(t++);(r&64512)==56320?e.push(((a&1023)<<10)+(r&1023)+65536):(e.push(a),t--)}else e.push(a)}return e}const P0=i=>String.fromCodePoint(...i),R0=function(i){return i>=48&&i<58?26+(i-48):i>=65&&i<91?i-65:i>=97&&i<123?i-97:fi},rc=function(i,e){return i+22+75*(i<26)-((e!=0)<<5)},Ru=function(i,e,t){let n=0;for(i=t?pi(i/M0):i>>1,i+=pi(i/e);i>fs*aa>>1;n+=fi)i=pi(i/fs);return pi(n+(fs+1)*i/(i+T0))},Ou=function(i){const e=[],t=i.length;let n=0,a=Bu,r=Du,s=i.lastIndexOf(Fu);s<0&&(s=0);for(let o=0;o<s;++o)i.charCodeAt(o)>=128&&Di("not-basic"),e.push(i.charCodeAt(o));for(let o=s>0?s+1:0;o<t;){const l=n;for(let f=1,c=fi;;c+=fi){o>=t&&Di("invalid-input");const d=R0(i.charCodeAt(o++));d>=fi&&Di("invalid-input"),d>pi((wn-n)/f)&&Di("overflow"),n+=d*f;const h=c<=r?Ao:c>=r+aa?aa:c-r;if(d<h)break;const p=fi-h;f>pi(wn/p)&&Di("overflow"),f*=p}const u=e.length+1;r=Ru(n-l,u,l==0),pi(n/u)>wn-a&&Di("overflow"),a+=pi(n/u),n%=u,e.splice(n++,0,a)}return String.fromCodePoint(...e)},Nu=function(i){const e=[];i=Pu(i);const t=i.length;let n=Bu,a=0,r=Du;for(const l of i)l<128&&e.push(ps(l));const s=e.length;let o=s;for(s&&e.push(Fu);o<t;){let l=wn;for(const f of i)f>=n&&f<l&&(l=f);const u=o+1;l-n>pi((wn-a)/u)&&Di("overflow"),a+=(l-n)*u,n=l;for(const f of i)if(f<n&&++a>wn&&Di("overflow"),f===n){let c=a;for(let d=fi;;d+=fi){const h=d<=r?Ao:d>=r+aa?aa:d-r;if(c<h)break;const p=c-h,m=fi-h;e.push(ps(rc(h+p%m,0))),c=pi(p/m)}e.push(ps(rc(c,0))),r=Ru(a,u,o===s),a=0,++o}++a,++n}return e.join("")},O0=function(i){return Iu(i,function(e){return L0.test(e)?Ou(e.slice(4).toLowerCase()):e})},N0=function(i){return Iu(i,function(e){return D0.test(e)?"xn--"+Nu(e):e})},Hu={version:"2.3.1",ucs2:{decode:Pu,encode:P0},decode:Ou,encode:Nu,toASCII:N0,toUnicode:O0},H0={options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:100},components:{core:{},block:{},inline:{}}},z0={options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["normalize","block","inline","text_join"]},block:{rules:["paragraph"]},inline:{rules:["text"],rules2:["balance_pairs","fragments_join"]}}},V0={options:{html:!0,xhtmlOut:!0,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["normalize","block","inline","text_join"]},block:{rules:["blockquote","code","fence","heading","hr","html_block","lheading","list","reference","paragraph"]},inline:{rules:["autolink","backticks","emphasis","entity","escape","html_inline","image","link","newline","text"],rules2:["balance_pairs","emphasis","fragments_join"]}}},U0={default:H0,zero:z0,commonmark:V0},W0=/^(vbscript|javascript|file|data):/,G0=/^data:image\/(gif|png|jpeg|webp);/;function q0(i){const e=i.trim().toLowerCase();return W0.test(e)?G0.test(e):!0}const zu=["http:","https:","mailto:"];function j0(i){const e=wo(i,!0);if(e.hostname&&(!e.protocol||zu.indexOf(e.protocol)>=0))try{e.hostname=Hu.toASCII(e.hostname)}catch{}return ca(yo(e))}function $0(i){const e=wo(i,!0);if(e.hostname&&(!e.protocol||zu.indexOf(e.protocol)>=0))try{e.hostname=Hu.toUnicode(e.hostname)}catch{}return Cn(yo(e),Cn.defaultChars+"%")}function Xt(i,e){if(!(this instanceof Xt))return new Xt(i,e);e||xo(i)||(e=i||{},i="default"),this.inline=new da,this.block=new rr,this.core=new Co,this.renderer=new Sn,this.linkify=new Rt,this.validateLink=q0,this.normalizeLink=j0,this.normalizeLinkText=$0,this.utils=Kf,this.helpers=nr({},Jf),this.options={},this.configure(i),e&&this.set(e)}Xt.prototype.set=function(i){return nr(this.options,i),this};Xt.prototype.configure=function(i){const e=this;if(xo(i)){const t=i;if(i=U0[t],!i)throw new Error('Wrong `markdown-it` preset "'+t+'", check name')}if(!i)throw new Error("Wrong `markdown-it` preset, can't be empty");return i.options&&e.set(i.options),i.components&&Object.keys(i.components).forEach(function(t){i.components[t].rules&&e[t].ruler.enableOnly(i.components[t].rules),i.components[t].rules2&&e[t].ruler2.enableOnly(i.components[t].rules2)}),this};Xt.prototype.enable=function(i,e){let t=[];Array.isArray(i)||(i=[i]),["core","block","inline"].forEach(function(a){t=t.concat(this[a].ruler.enable(i,!0))},this),t=t.concat(this.inline.ruler2.enable(i,!0));const n=i.filter(function(a){return t.indexOf(a)<0});if(n.length&&!e)throw new Error("MarkdownIt. Failed to enable unknown rule(s): "+n);return this};Xt.prototype.disable=function(i,e){let t=[];Array.isArray(i)||(i=[i]),["core","block","inline"].forEach(function(a){t=t.concat(this[a].ruler.disable(i,!0))},this),t=t.concat(this.inline.ruler2.disable(i,!0));const n=i.filter(function(a){return t.indexOf(a)<0});if(n.length&&!e)throw new Error("MarkdownIt. Failed to disable unknown rule(s): "+n);return this};Xt.prototype.use=function(i){const e=[this].concat(Array.prototype.slice.call(arguments,1));return i.apply(i,e),this};Xt.prototype.parse=function(i,e){if(typeof i!="string")throw new Error("Input data should be a String");const t=new this.core.State(i,this,e);return this.core.process(t),t.tokens};Xt.prototype.render=function(i,e){return e=e||{},this.renderer.render(this.parse(i,e),this.options,e)};Xt.prototype.parseInline=function(i,e){const t=new this.core.State(i,this,e);return t.inlineMode=!0,this.core.process(t),t.tokens};Xt.prototype.renderInline=function(i,e){return e=e||{},this.renderer.render(this.parseInline(i,e),this.options,e)};class Vu extends ct{app;constructor(e){super({title:"Changelog",width:600,height:500,win_id:"changelog"}),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=Xt(),n=t.renderer.rules.link_open||function(o,l,u,f,c){return c.renderToken(o,l,u)};t.renderer.rules.link_open=function(o,l,u,f,c){return o[l].attrSet("target","_blank"),n(o,l,u,f,c)};const a=document.createElement("div");a.classList.add("markdown-container"),fetch("/smeditor/assets/app/changelog.json").then(o=>o.json()).then(o=>{a.innerHTML=o.map(l=>`# ${l.version}
---
`+l.changelog).map(l=>`<div>${t.render(l)}</div>`).join("")}),e.appendChild(a);const r=document.createElement("div");r.classList.add("menu-options"),r.style.justifyContent="flex-end";const s=document.createElement("button");s.innerText="Close",s.onclick=()=>{this.closeWindow()},s.classList.add("confirm"),r.append(s),e.appendChild(r),this.viewElement.appendChild(e)}}const sc=globalThis.showDirectoryPicker;async function Y0(i={}){if(sc&&!i._preferPolyfill)return sc(i);const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.style.position="fixed",e.style.top="-100000px",e.style.left="-100000px",document.body.appendChild(e);const{makeDirHandleFromFileList:t}=await We(async()=>{const{makeDirHandleFromFileList:n}=await Promise.resolve().then(()=>Xc);return{makeDirHandleFromFileList:n}},void 0);return new Promise((n,a)=>{e.addEventListener("change",()=>{t(e.files).then(n).catch(a),document.body.removeChild(e)}),e.click()})}const oc=globalThis.showOpenFilePicker;async function Uu(i={}){if(oc&&!i._preferPolyfill)return oc(i);const e=document.createElement("input");e.type="file",e.multiple=!!i.multiple,e.accept=(i.accepts||[]).map(n=>[...(n.extensions||[]).map(a=>"."+a),...n.mimeTypes||[]]).flat().join(","),e.style.position="fixed",e.style.top="-100000px",e.style.left="-100000px",document.body.appendChild(e);const{makeFileHandlesFromFileList:t}=await We(async()=>{const{makeFileHandlesFromFileList:n}=await Promise.resolve().then(()=>Xc);return{makeFileHandlesFromFileList:n}},void 0);return new Promise((n,a)=>{e.addEventListener("change",()=>{t(e.files).then(n).catch(a),document.body.removeChild(e)}),e.click()})}const lc=globalThis.showSaveFilePicker;async function K0(i={}){if(lc&&!i._preferPolyfill)return lc(i);const{FileSystemFileHandle:e}=await We(async()=>{const{FileSystemFileHandle:n}=await Promise.resolve().then(()=>Wu);return{FileSystemFileHandle:n}},void 0),{FileHandle:t}=await We(async()=>{const{FileHandle:n}=await import("./downloader-Bn5BGIXb.js");return{FileHandle:n}},__vite__mapDeps([3,1,2]));return new e(new t(i.suggestedName))}const on=Symbol("adapter");let ko=class{constructor(e){this.kind=e.kind,this.name=e.name,this[on]=e}get isFile(){return this.kind==="file"}get isDirectory(){return this.kind==="directory"}async queryPermission(e={mode:"read"}){const t=this[on];if(t.queryPermission)return t.queryPermission(e);if(e.mode==="read")return"granted";if(e.mode==="readwrite")return t.writable?"granted":"denied";throw new TypeError(`Mode ${e.mode} must be 'read' or 'readwrite'`)}async requestPermission(e={mode:"read"}){const t=this[on];if(t.requestPermission)return t.requestPermission(e);if(e.mode==="read")return"granted";if(e.mode==="readwrite")return t.writable?"granted":"denied";throw new TypeError(`Mode ${e.mode} must be 'read' or 'readwrite'`)}async isSameEntry(e){return this===e?!0:this.kind!==e.kind||!e[on]?!1:await this[on].isSameEntry(e[on])}};Object.defineProperty(ko.prototype,Symbol.toStringTag,{value:"FileSystemHandle",writable:!1,enumerable:!1,configurable:!0});const ms=Symbol("adapter");let ra=class extends ko{constructor(e){super(e),this.kind="file",this[ms]=e}async createWritable(e={}){const{FileSystemWritableFileStream:t}=await We(async()=>{const{FileSystemWritableFileStream:n}=await import("./FileSystemWritableFileStream-D05uA35V.js");return{FileSystemWritableFileStream:n}},__vite__mapDeps([4,5]));return new t(await this[ms].createWritable(e))}async getFile(){return this[ms].getFile()}};Object.defineProperty(ra.prototype,Symbol.toStringTag,{value:"FileSystemFileHandle",writable:!1,enumerable:!1,configurable:!0});Object.defineProperties(ra.prototype,{createWritable:{enumerable:!0},getFile:{enumerable:!0}});const Wu=Object.freeze(Object.defineProperty({__proto__:null,FileSystemFileHandle:ra},Symbol.toStringTag,{value:"Module"})),ln=Symbol("adapter");class nn extends ko{constructor(e){super(e),this.kind="directory",this[ln]=e}async getDirectoryHandle(e,t={}){if(e==="")throw new TypeError("Name can't be an empty string.");if(e==="."||e===".."||e.includes("/"))throw new TypeError("Name contains invalid characters.");return new nn(await this[ln].getDirectoryHandle(e,t))}getDirectory(e,t={}){return this.getDirectoryHandle(e,t)}async*entries(){for await(const[e,t]of this[ln].entries())yield[t.name,t.kind==="file"?new ra(t):new nn(t)]}async*getEntries(){return this.entries()}async*keys(){for await(const[e]of this[ln].entries())yield e}async*values(){for await(const[e,t]of this.entries())yield t}async getFileHandle(e,t={}){if(e==="")throw new TypeError("Name can't be an empty string.");if(e==="."||e===".."||e.includes("/"))throw new TypeError("Name contains invalid characters.");return t.create=!!t.create,new ra(await this[ln].getFileHandle(e,t))}getFile(e,t={}){return this.getFileHandle(e,t)}async removeEntry(e,t={}){if(e==="")throw new TypeError("Name can't be an empty string.");if(e==="."||e===".."||e.includes("/"))throw new TypeError("Name contains invalid characters.");return t.recursive=!!t.recursive,this[ln].removeEntry(e,t)}async resolve(e){if(await e.isSameEntry(this))return[];const t=[{handle:this,path:[]}];for(;t.length;){let{handle:n,path:a}=t.pop();for await(const r of n.values()){if(await r.isSameEntry(e))return[...a,r.name];r.kind==="directory"&&t.push({handle:r,path:[...a,r.name]})}}return null}[Symbol.asyncIterator](){return this.entries()}}Object.defineProperty(nn.prototype,Symbol.toStringTag,{value:"FileSystemDirectoryHandle",writable:!1,enumerable:!1,configurable:!0});Object.defineProperties(nn.prototype,{getDirectoryHandle:{enumerable:!0},entries:{enumerable:!0},getFileHandle:{enumerable:!0},removeEntry:{enumerable:!0}});const X0=Object.freeze(Object.defineProperty({__proto__:null,FileSystemDirectoryHandle:nn},Symbol.toStringTag,{value:"Module"}));async function cc(i,e={}){var t,n,a,r;if(!i){if(!(!((t=globalThis.navigator)===null||t===void 0)&&t.storage)&&((n=globalThis.location)===null||n===void 0?void 0:n.protocol)==="http:")throw new Error("Native getDirectory not supported in HTTP context. Please use HTTPS instead or provide an adapter.");if(!(!((r=(a=globalThis.navigator)===null||a===void 0?void 0:a.storage)===null||r===void 0)&&r.getDirectory))throw new Error("Native StorageManager.getDirectory() is not supported in current environment. Please provide an adapter instead.");return globalThis.navigator.storage.getDirectory()}const s=await i,o=typeof s=="function"?await s(e):await s.default(e);return new nn(o)}var gs,bs;const Z0={adapter:{native:typeof((bs=(gs=globalThis.navigator)===null||gs===void 0?void 0:gs.storage)===null||bs===void 0?void 0:bs.getDirectory)=="function"}},uc=i=>typeof i=="object"&&i!=null&&i.nodeType===1,dc=(i,e)=>(!e||i!=="hidden")&&i!=="visible"&&i!=="clip",ys=(i,e)=>{if(i.clientHeight<i.scrollHeight||i.clientWidth<i.scrollWidth){const t=getComputedStyle(i,null);return dc(t.overflowY,e)||dc(t.overflowX,e)||(n=>{const a=(r=>{if(!r.ownerDocument||!r.ownerDocument.defaultView)return null;try{return r.ownerDocument.defaultView.frameElement}catch{return null}})(n);return!!a&&(a.clientHeight<n.scrollHeight||a.clientWidth<n.scrollWidth)})(i)}return!1},ba=(i,e,t,n,a,r,s,o)=>r<i&&s>e||r>i&&s<e?0:r<=i&&o<=t||s>=e&&o>=t?r-i-n:s>e&&o<t||r<i&&o>t?s-e+a:0,Q0=i=>{const e=i.parentElement;return e??(i.getRootNode().host||null)},hc=(i,e)=>{var t,n,a,r;if(typeof document>"u")return[];const{scrollMode:s,block:o,inline:l,boundary:u,skipOverflowHiddenElements:f}=e,c=typeof u=="function"?u:$=>$!==u;if(!uc(i))throw new TypeError("Invalid target");const d=document.scrollingElement||document.documentElement,h=[];let p=i;for(;uc(p)&&c(p);){if(p=Q0(p),p===d){h.push(p);break}p!=null&&p===document.body&&ys(p)&&!ys(document.documentElement)||p!=null&&ys(p,f)&&h.push(p)}const m=(n=(t=window.visualViewport)==null?void 0:t.width)!=null?n:innerWidth,g=(r=(a=window.visualViewport)==null?void 0:a.height)!=null?r:innerHeight,{scrollX:y,scrollY:x}=window,{height:w,width:C,top:_,right:F,bottom:D,left:O}=i.getBoundingClientRect(),{top:H,right:Y,bottom:re,left:M}=($=>{const L=window.getComputedStyle($);return{top:parseFloat(L.scrollMarginTop)||0,right:parseFloat(L.scrollMarginRight)||0,bottom:parseFloat(L.scrollMarginBottom)||0,left:parseFloat(L.scrollMarginLeft)||0}})(i);let R=o==="start"||o==="nearest"?_-H:o==="end"?D+re:_+w/2-H+re,v=l==="center"?O+C/2-M+Y:l==="end"?F+Y:O-M;const S=[];for(let $=0;$<h.length;$++){const L=h[$],{height:G,width:V,top:J,right:N,bottom:P,left:ae}=L.getBoundingClientRect();if(s==="if-needed"&&_>=0&&O>=0&&D<=g&&F<=m&&_>=J&&D<=P&&O>=ae&&F<=N)return S;const ne=getComputedStyle(L),ee=parseInt(ne.borderLeftWidth,10),Me=parseInt(ne.borderTopWidth,10),Ne=parseInt(ne.borderRightWidth,10),_e=parseInt(ne.borderBottomWidth,10);let ve=0,Le=0;const Be="offsetWidth"in L?L.offsetWidth-L.clientWidth-ee-Ne:0,st="offsetHeight"in L?L.offsetHeight-L.clientHeight-Me-_e:0,ot="offsetWidth"in L?L.offsetWidth===0?0:V/L.offsetWidth:0,E="offsetHeight"in L?L.offsetHeight===0?0:G/L.offsetHeight:0;if(d===L)ve=o==="start"?R:o==="end"?R-g:o==="nearest"?ba(x,x+g,g,Me,_e,x+R,x+R+w,w):R-g/2,Le=l==="start"?v:l==="center"?v-m/2:l==="end"?v-m:ba(y,y+m,m,ee,Ne,y+v,y+v+C,C),ve=Math.max(0,ve+x),Le=Math.max(0,Le+y);else{ve=o==="start"?R-J-Me:o==="end"?R-P+_e+st:o==="nearest"?ba(J,P,G,Me,_e+st,R,R+w,w):R-(J+G/2)+st/2,Le=l==="start"?v-ae-ee:l==="center"?v-(ae+V/2)+Be/2:l==="end"?v-N+Ne+Be:ba(ae,N,V,ee,Ne+Be,v,v+C,C);const{scrollLeft:X,scrollTop:q}=L;ve=E===0?0:Math.max(0,Math.min(q+ve/E,L.scrollHeight-G/E+st)),Le=ot===0?0:Math.max(0,Math.min(X+Le/ot,L.scrollWidth-V/ot+Be)),R+=q-ve,v+=X-Le}S.push({el:L,top:ve,left:Le})}return S},J0=i=>i===!1?{block:"end",inline:"nearest"}:(e=>e===Object(e)&&Object.keys(e).length!==0)(i)?i:{block:"start",inline:"nearest"};function $n(i,e){if(!i.isConnected||!(a=>{let r=a;for(;r&&r.parentNode;){if(r.parentNode===document)return!0;r=r.parentNode instanceof ShadowRoot?r.parentNode.host:r.parentNode}return!1})(i))return;const t=(a=>{const r=window.getComputedStyle(a);return{top:parseFloat(r.scrollMarginTop)||0,right:parseFloat(r.scrollMarginRight)||0,bottom:parseFloat(r.scrollMarginBottom)||0,left:parseFloat(r.scrollMarginLeft)||0}})(i);if((a=>typeof a=="object"&&typeof a.behavior=="function")(e))return e.behavior(hc(i,e));const n=typeof e=="boolean"||e==null?void 0:e.behavior;for(const{el:a,top:r,left:s}of hc(i,J0(e))){const o=r-t.top+t.bottom,l=s-t.left+t.right;a.scroll({top:o,left:l,behavior:n})}}function Tt(i,e){if(window.nw)return nw.require("path").basename(i,e);let t=So(i)[2];return e&&t.slice(-1*e.length)===e&&(t=t.slice(0,t.length-e.length)),t}function at(i){if(window.nw)return nw.require("path").dirname(i);const e=So(i),t=e[0];let n=e[1];return!t&&!n?"":(n&&(n=n.slice(0,n.length-1)),t+n)}function At(i){return window.nw?nw.require("path").extname(i):So(i)[3]}const em=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^/]+?|)(\.[^./]*|))(?:[/]*)$/;function So(i){return em.exec(i).slice(1)}const{GONE:Gu}=mn;FileSystemFileHandle;class To{_path;kind="file";name;isFile=!0;isDirectory=!1;constructor(e){this._path=e,this.name=new URL(e).pathname.split("/").pop()??""}async getFile(){return fetch(this._path).then(e=>e.blob()).then(e=>new File([e],this.name)).catch(()=>{throw new DOMException(...Gu)})}async createWritable(){throw Error("Cannot call createWriteable from a URLFileHandle")}async isSameEntry(e){return FileSystemHandle instanceof To?e._path==this._path:!1}async queryPermission(){return"granted"}async requestPermission(){return"granted"}}class tm{async handleDropEvent(e,t){throw Error("Cannot call handleDropEvent from a URLFileHandler")}async getDirectoryHandle(e,t,n){throw Error("Cannot call getDirectoryHandle from a URLFileHandler")}async hasFile(e){return fetch(e).then(t=>t.ok).catch(()=>!1)}async getFileHandle(e,t){try{if(!await this.hasFile(e))throw new DOMException(...Gu);return new To(e)}catch(n){console.error("Failed to get file "+e+": "+n);return}}async getFileHandleRelativeTo(e,t){const n=new URL(e);At(n.pathname)!=""&&(n.pathname=n.pathname.split("/").slice(0,-1).join("/")),n.pathname+="/"+t;try{return this.getFileHandle(n.toString())}catch(a){console.error("Failed to get relative file "+n+": "+a);return}}async getDirectoryFiles(e){throw Error("Cannot call getDirectoryFiles from a URLFileHandler")}async getDirectoryFolders(e){throw Error("Cannot call getDirectoryFolders from a URLFileHandler")}async writeFile(e,t){throw Error("Cannot save to a URL file!")}async removeFile(e){throw Error("Cannot remove a URL file!")}getRelativePath(e,t){throw Error("Cannot call getRelativePath from a URLFileHandler")}resolvePath(){throw Error("Cannot call resolvePath from a URLFileHandler")}}function ya(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ws={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/var fc;function im(){return fc||(fc=1,function(i,e){(function(t){i.exports=t()})(function(){return function t(n,a,r){function s(u,f){if(!a[u]){if(!n[u]){var c=typeof ya=="function"&&ya;if(!f&&c)return c(u,!0);if(o)return o(u,!0);var d=new Error("Cannot find module '"+u+"'");throw d.code="MODULE_NOT_FOUND",d}var h=a[u]={exports:{}};n[u][0].call(h.exports,function(p){var m=n[u][1][p];return s(m||p)},h,h.exports,t,n,a,r)}return a[u].exports}for(var o=typeof ya=="function"&&ya,l=0;l<r.length;l++)s(r[l]);return s}({1:[function(t,n,a){var r=t("./utils"),s=t("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.encode=function(l){for(var u,f,c,d,h,p,m,g=[],y=0,x=l.length,w=x,C=r.getTypeOf(l)!=="string";y<l.length;)w=x-y,c=C?(u=l[y++],f=y<x?l[y++]:0,y<x?l[y++]:0):(u=l.charCodeAt(y++),f=y<x?l.charCodeAt(y++):0,y<x?l.charCodeAt(y++):0),d=u>>2,h=(3&u)<<4|f>>4,p=1<w?(15&f)<<2|c>>6:64,m=2<w?63&c:64,g.push(o.charAt(d)+o.charAt(h)+o.charAt(p)+o.charAt(m));return g.join("")},a.decode=function(l){var u,f,c,d,h,p,m=0,g=0,y="data:";if(l.substr(0,y.length)===y)throw new Error("Invalid base64 input, it looks like a data url.");var x,w=3*(l=l.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(l.charAt(l.length-1)===o.charAt(64)&&w--,l.charAt(l.length-2)===o.charAt(64)&&w--,w%1!=0)throw new Error("Invalid base64 input, bad content length.");for(x=s.uint8array?new Uint8Array(0|w):new Array(0|w);m<l.length;)u=o.indexOf(l.charAt(m++))<<2|(d=o.indexOf(l.charAt(m++)))>>4,f=(15&d)<<4|(h=o.indexOf(l.charAt(m++)))>>2,c=(3&h)<<6|(p=o.indexOf(l.charAt(m++))),x[g++]=u,h!==64&&(x[g++]=f),p!==64&&(x[g++]=c);return x}},{"./support":30,"./utils":32}],2:[function(t,n,a){var r=t("./external"),s=t("./stream/DataWorker"),o=t("./stream/Crc32Probe"),l=t("./stream/DataLengthProbe");function u(f,c,d,h,p){this.compressedSize=f,this.uncompressedSize=c,this.crc32=d,this.compression=h,this.compressedContent=p}u.prototype={getContentWorker:function(){var f=new s(r.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new l("data_length")),c=this;return f.on("end",function(){if(this.streamInfo.data_length!==c.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),f},getCompressedWorker:function(){return new s(r.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},u.createWorkerFrom=function(f,c,d){return f.pipe(new o).pipe(new l("uncompressedSize")).pipe(c.compressWorker(d)).pipe(new l("compressedSize")).withStreamInfo("compression",c)},n.exports=u},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,n,a){var r=t("./stream/GenericWorker");a.STORE={magic:"\0\0",compressWorker:function(){return new r("STORE compression")},uncompressWorker:function(){return new r("STORE decompression")}},a.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,n,a){var r=t("./utils"),s=function(){for(var o,l=[],u=0;u<256;u++){o=u;for(var f=0;f<8;f++)o=1&o?3988292384^o>>>1:o>>>1;l[u]=o}return l}();n.exports=function(o,l){return o!==void 0&&o.length?r.getTypeOf(o)!=="string"?function(u,f,c,d){var h=s,p=d+c;u^=-1;for(var m=d;m<p;m++)u=u>>>8^h[255&(u^f[m])];return-1^u}(0|l,o,o.length,0):function(u,f,c,d){var h=s,p=d+c;u^=-1;for(var m=d;m<p;m++)u=u>>>8^h[255&(u^f.charCodeAt(m))];return-1^u}(0|l,o,o.length,0):0}},{"./utils":32}],5:[function(t,n,a){a.base64=!1,a.binary=!1,a.dir=!1,a.createFolders=!0,a.date=null,a.compression=null,a.compressionOptions=null,a.comment=null,a.unixPermissions=null,a.dosPermissions=null},{}],6:[function(t,n,a){var r=null;r=typeof Promise<"u"?Promise:t("lie"),n.exports={Promise:r}},{lie:37}],7:[function(t,n,a){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",s=t("pako"),o=t("./utils"),l=t("./stream/GenericWorker"),u=r?"uint8array":"array";function f(c,d){l.call(this,"FlateWorker/"+c),this._pako=null,this._pakoAction=c,this._pakoOptions=d,this.meta={}}a.magic="\b\0",o.inherits(f,l),f.prototype.processChunk=function(c){this.meta=c.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(u,c.data),!1)},f.prototype.flush=function(){l.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},f.prototype.cleanUp=function(){l.prototype.cleanUp.call(this),this._pako=null},f.prototype._createPako=function(){this._pako=new s[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var c=this;this._pako.onData=function(d){c.push({data:d,meta:c.meta})}},a.compressWorker=function(c){return new f("Deflate",c)},a.uncompressWorker=function(){return new f("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,n,a){function r(h,p){var m,g="";for(m=0;m<p;m++)g+=String.fromCharCode(255&h),h>>>=8;return g}function s(h,p,m,g,y,x){var w,C,_=h.file,F=h.compression,D=x!==u.utf8encode,O=o.transformTo("string",x(_.name)),H=o.transformTo("string",u.utf8encode(_.name)),Y=_.comment,re=o.transformTo("string",x(Y)),M=o.transformTo("string",u.utf8encode(Y)),R=H.length!==_.name.length,v=M.length!==Y.length,S="",$="",L="",G=_.dir,V=_.date,J={crc32:0,compressedSize:0,uncompressedSize:0};p&&!m||(J.crc32=h.crc32,J.compressedSize=h.compressedSize,J.uncompressedSize=h.uncompressedSize);var N=0;p&&(N|=8),D||!R&&!v||(N|=2048);var P=0,ae=0;G&&(P|=16),y==="UNIX"?(ae=798,P|=function(ee,Me){var Ne=ee;return ee||(Ne=Me?16893:33204),(65535&Ne)<<16}(_.unixPermissions,G)):(ae=20,P|=function(ee){return 63&(ee||0)}(_.dosPermissions)),w=V.getUTCHours(),w<<=6,w|=V.getUTCMinutes(),w<<=5,w|=V.getUTCSeconds()/2,C=V.getUTCFullYear()-1980,C<<=4,C|=V.getUTCMonth()+1,C<<=5,C|=V.getUTCDate(),R&&($=r(1,1)+r(f(O),4)+H,S+="up"+r($.length,2)+$),v&&(L=r(1,1)+r(f(re),4)+M,S+="uc"+r(L.length,2)+L);var ne="";return ne+=`
\0`,ne+=r(N,2),ne+=F.magic,ne+=r(w,2),ne+=r(C,2),ne+=r(J.crc32,4),ne+=r(J.compressedSize,4),ne+=r(J.uncompressedSize,4),ne+=r(O.length,2),ne+=r(S.length,2),{fileRecord:c.LOCAL_FILE_HEADER+ne+O+S,dirRecord:c.CENTRAL_FILE_HEADER+r(ae,2)+ne+r(re.length,2)+"\0\0\0\0"+r(P,4)+r(g,4)+O+S+re}}var o=t("../utils"),l=t("../stream/GenericWorker"),u=t("../utf8"),f=t("../crc32"),c=t("../signature");function d(h,p,m,g){l.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=p,this.zipPlatform=m,this.encodeFileName=g,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(d,l),d.prototype.push=function(h){var p=h.meta.percent||0,m=this.entriesCount,g=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,l.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:m?(p+100*(m-g-1))/m:100}}))},d.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var p=this.streamFiles&&!h.file.dir;if(p){var m=s(h,p,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},d.prototype.closedSource=function(h){this.accumulate=!1;var p=this.streamFiles&&!h.file.dir,m=s(h,p,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),p)this.push({data:function(g){return c.DATA_DESCRIPTOR+r(g.crc32,4)+r(g.compressedSize,4)+r(g.uncompressedSize,4)}(h),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},d.prototype.flush=function(){for(var h=this.bytesWritten,p=0;p<this.dirRecords.length;p++)this.push({data:this.dirRecords[p],meta:{percent:100}});var m=this.bytesWritten-h,g=function(y,x,w,C,_){var F=o.transformTo("string",_(C));return c.CENTRAL_DIRECTORY_END+"\0\0\0\0"+r(y,2)+r(y,2)+r(x,4)+r(w,4)+r(F.length,2)+F}(this.dirRecords.length,m,h,this.zipComment,this.encodeFileName);this.push({data:g,meta:{percent:100}})},d.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},d.prototype.registerPrevious=function(h){this._sources.push(h);var p=this;return h.on("data",function(m){p.processChunk(m)}),h.on("end",function(){p.closedSource(p.previous.streamInfo),p._sources.length?p.prepareNextSource():p.end()}),h.on("error",function(m){p.error(m)}),this},d.prototype.resume=function(){return!!l.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},d.prototype.error=function(h){var p=this._sources;if(!l.prototype.error.call(this,h))return!1;for(var m=0;m<p.length;m++)try{p[m].error(h)}catch{}return!0},d.prototype.lock=function(){l.prototype.lock.call(this);for(var h=this._sources,p=0;p<h.length;p++)h[p].lock()},n.exports=d},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,n,a){var r=t("../compressions"),s=t("./ZipFileWorker");a.generateWorker=function(o,l,u){var f=new s(l.streamFiles,u,l.platform,l.encodeFileName),c=0;try{o.forEach(function(d,h){c++;var p=function(x,w){var C=x||w,_=r[C];if(!_)throw new Error(C+" is not a valid compression method !");return _}(h.options.compression,l.compression),m=h.options.compressionOptions||l.compressionOptions||{},g=h.dir,y=h.date;h._compressWorker(p,m).withStreamInfo("file",{name:d,dir:g,date:y,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(f)}),f.entriesCount=c}catch(d){f.error(d)}return f}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,n,a){function r(){if(!(this instanceof r))return new r;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var s=new r;for(var o in this)typeof this[o]!="function"&&(s[o]=this[o]);return s}}(r.prototype=t("./object")).loadAsync=t("./load"),r.support=t("./support"),r.defaults=t("./defaults"),r.version="3.10.1",r.loadAsync=function(s,o){return new r().loadAsync(s,o)},r.external=t("./external"),n.exports=r},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,n,a){var r=t("./utils"),s=t("./external"),o=t("./utf8"),l=t("./zipEntries"),u=t("./stream/Crc32Probe"),f=t("./nodejsUtils");function c(d){return new s.Promise(function(h,p){var m=d.decompressed.getContentWorker().pipe(new u);m.on("error",function(g){p(g)}).on("end",function(){m.streamInfo.crc32!==d.decompressed.crc32?p(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}n.exports=function(d,h){var p=this;return h=r.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),f.isNode&&f.isStream(d)?s.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):r.prepareContent("the loaded zip file",d,!0,h.optimizedBinaryString,h.base64).then(function(m){var g=new l(h);return g.load(m),g}).then(function(m){var g=[s.Promise.resolve(m)],y=m.files;if(h.checkCRC32)for(var x=0;x<y.length;x++)g.push(c(y[x]));return s.Promise.all(g)}).then(function(m){for(var g=m.shift(),y=g.files,x=0;x<y.length;x++){var w=y[x],C=w.fileNameStr,_=r.resolve(w.fileNameStr);p.file(_,w.decompressed,{binary:!0,optimizedBinaryString:!0,date:w.date,dir:w.dir,comment:w.fileCommentStr.length?w.fileCommentStr:null,unixPermissions:w.unixPermissions,dosPermissions:w.dosPermissions,createFolders:h.createFolders}),w.dir||(p.file(_).unsafeOriginalName=C)}return g.zipComment.length&&(p.comment=g.zipComment),p})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,n,a){var r=t("../utils"),s=t("../stream/GenericWorker");function o(l,u){s.call(this,"Nodejs stream input adapter for "+l),this._upstreamEnded=!1,this._bindStream(u)}r.inherits(o,s),o.prototype._bindStream=function(l){var u=this;(this._stream=l).pause(),l.on("data",function(f){u.push({data:f,meta:{percent:0}})}).on("error",function(f){u.isPaused?this.generatedError=f:u.error(f)}).on("end",function(){u.isPaused?u._upstreamEnded=!0:u.end()})},o.prototype.pause=function(){return!!s.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},n.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,n,a){var r=t("readable-stream").Readable;function s(o,l,u){r.call(this,l),this._helper=o;var f=this;o.on("data",function(c,d){f.push(c)||f._helper.pause(),u&&u(d)}).on("error",function(c){f.emit("error",c)}).on("end",function(){f.push(null)})}t("../utils").inherits(s,r),s.prototype._read=function(){this._helper.resume()},n.exports=s},{"../utils":32,"readable-stream":16}],14:[function(t,n,a){n.exports={isNode:typeof Buffer<"u",newBufferFrom:function(r,s){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(r,s);if(typeof r=="number")throw new Error('The "data" argument must not be a number');return new Buffer(r,s)},allocBuffer:function(r){if(Buffer.alloc)return Buffer.alloc(r);var s=new Buffer(r);return s.fill(0),s},isBuffer:function(r){return Buffer.isBuffer(r)},isStream:function(r){return r&&typeof r.on=="function"&&typeof r.pause=="function"&&typeof r.resume=="function"}}},{}],15:[function(t,n,a){function r(_,F,D){var O,H=o.getTypeOf(F),Y=o.extend(D||{},f);Y.date=Y.date||new Date,Y.compression!==null&&(Y.compression=Y.compression.toUpperCase()),typeof Y.unixPermissions=="string"&&(Y.unixPermissions=parseInt(Y.unixPermissions,8)),Y.unixPermissions&&16384&Y.unixPermissions&&(Y.dir=!0),Y.dosPermissions&&16&Y.dosPermissions&&(Y.dir=!0),Y.dir&&(_=y(_)),Y.createFolders&&(O=g(_))&&x.call(this,O,!0);var re=H==="string"&&Y.binary===!1&&Y.base64===!1;D&&D.binary!==void 0||(Y.binary=!re),(F instanceof c&&F.uncompressedSize===0||Y.dir||!F||F.length===0)&&(Y.base64=!1,Y.binary=!0,F="",Y.compression="STORE",H="string");var M=null;M=F instanceof c||F instanceof l?F:p.isNode&&p.isStream(F)?new m(_,F):o.prepareContent(_,F,Y.binary,Y.optimizedBinaryString,Y.base64);var R=new d(_,M,Y);this.files[_]=R}var s=t("./utf8"),o=t("./utils"),l=t("./stream/GenericWorker"),u=t("./stream/StreamHelper"),f=t("./defaults"),c=t("./compressedObject"),d=t("./zipObject"),h=t("./generate"),p=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),g=function(_){_.slice(-1)==="/"&&(_=_.substring(0,_.length-1));var F=_.lastIndexOf("/");return 0<F?_.substring(0,F):""},y=function(_){return _.slice(-1)!=="/"&&(_+="/"),_},x=function(_,F){return F=F!==void 0?F:f.createFolders,_=y(_),this.files[_]||r.call(this,_,null,{dir:!0,createFolders:F}),this.files[_]};function w(_){return Object.prototype.toString.call(_)==="[object RegExp]"}var C={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(_){var F,D,O;for(F in this.files)O=this.files[F],(D=F.slice(this.root.length,F.length))&&F.slice(0,this.root.length)===this.root&&_(D,O)},filter:function(_){var F=[];return this.forEach(function(D,O){_(D,O)&&F.push(O)}),F},file:function(_,F,D){if(arguments.length!==1)return _=this.root+_,r.call(this,_,F,D),this;if(w(_)){var O=_;return this.filter(function(Y,re){return!re.dir&&O.test(Y)})}var H=this.files[this.root+_];return H&&!H.dir?H:null},folder:function(_){if(!_)return this;if(w(_))return this.filter(function(H,Y){return Y.dir&&_.test(H)});var F=this.root+_,D=x.call(this,F),O=this.clone();return O.root=D.name,O},remove:function(_){_=this.root+_;var F=this.files[_];if(F||(_.slice(-1)!=="/"&&(_+="/"),F=this.files[_]),F&&!F.dir)delete this.files[_];else for(var D=this.filter(function(H,Y){return Y.name.slice(0,_.length)===_}),O=0;O<D.length;O++)delete this.files[D[O].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(_){var F,D={};try{if((D=o.extend(_||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:s.utf8encode})).type=D.type.toLowerCase(),D.compression=D.compression.toUpperCase(),D.type==="binarystring"&&(D.type="string"),!D.type)throw new Error("No output type specified.");o.checkSupport(D.type),D.platform!=="darwin"&&D.platform!=="freebsd"&&D.platform!=="linux"&&D.platform!=="sunos"||(D.platform="UNIX"),D.platform==="win32"&&(D.platform="DOS");var O=D.comment||this.comment||"";F=h.generateWorker(this,D,O)}catch(H){(F=new l("error")).error(H)}return new u(F,D.type||"string",D.mimeType)},generateAsync:function(_,F){return this.generateInternalStream(_).accumulate(F)},generateNodeStream:function(_,F){return(_=_||{}).type||(_.type="nodebuffer"),this.generateInternalStream(_).toNodejsStream(F)}};n.exports=C},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,n,a){n.exports=t("stream")},{stream:void 0}],17:[function(t,n,a){var r=t("./DataReader");function s(o){r.call(this,o);for(var l=0;l<this.data.length;l++)o[l]=255&o[l]}t("../utils").inherits(s,r),s.prototype.byteAt=function(o){return this.data[this.zero+o]},s.prototype.lastIndexOfSignature=function(o){for(var l=o.charCodeAt(0),u=o.charCodeAt(1),f=o.charCodeAt(2),c=o.charCodeAt(3),d=this.length-4;0<=d;--d)if(this.data[d]===l&&this.data[d+1]===u&&this.data[d+2]===f&&this.data[d+3]===c)return d-this.zero;return-1},s.prototype.readAndCheckSignature=function(o){var l=o.charCodeAt(0),u=o.charCodeAt(1),f=o.charCodeAt(2),c=o.charCodeAt(3),d=this.readData(4);return l===d[0]&&u===d[1]&&f===d[2]&&c===d[3]},s.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./DataReader":18}],18:[function(t,n,a){var r=t("../utils");function s(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}s.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var l,u=0;for(this.checkOffset(o),l=this.index+o-1;l>=this.index;l--)u=(u<<8)+this.byteAt(l);return this.index+=o,u},readString:function(o){return r.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},n.exports=s},{"../utils":32}],19:[function(t,n,a){var r=t("./Uint8ArrayReader");function s(o){r.call(this,o)}t("../utils").inherits(s,r),s.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,n,a){var r=t("./DataReader");function s(o){r.call(this,o)}t("../utils").inherits(s,r),s.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},s.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},s.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},s.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./DataReader":18}],21:[function(t,n,a){var r=t("./ArrayReader");function s(o){r.call(this,o)}t("../utils").inherits(s,r),s.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var l=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./ArrayReader":17}],22:[function(t,n,a){var r=t("../utils"),s=t("../support"),o=t("./ArrayReader"),l=t("./StringReader"),u=t("./NodeBufferReader"),f=t("./Uint8ArrayReader");n.exports=function(c){var d=r.getTypeOf(c);return r.checkSupport(d),d!=="string"||s.uint8array?d==="nodebuffer"?new u(c):s.uint8array?new f(r.transformTo("uint8array",c)):new o(r.transformTo("array",c)):new l(c)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,n,a){a.LOCAL_FILE_HEADER="PK",a.CENTRAL_FILE_HEADER="PK",a.CENTRAL_DIRECTORY_END="PK",a.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",a.ZIP64_CENTRAL_DIRECTORY_END="PK",a.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,n,a){var r=t("./GenericWorker"),s=t("../utils");function o(l){r.call(this,"ConvertWorker to "+l),this.destType=l}s.inherits(o,r),o.prototype.processChunk=function(l){this.push({data:s.transformTo(this.destType,l.data),meta:l.meta})},n.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(t,n,a){var r=t("./GenericWorker"),s=t("../crc32");function o(){r.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(o,r),o.prototype.processChunk=function(l){this.streamInfo.crc32=s(l.data,this.streamInfo.crc32||0),this.push(l)},n.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,n,a){var r=t("../utils"),s=t("./GenericWorker");function o(l){s.call(this,"DataLengthProbe for "+l),this.propName=l,this.withStreamInfo(l,0)}r.inherits(o,s),o.prototype.processChunk=function(l){if(l){var u=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=u+l.data.length}s.prototype.processChunk.call(this,l)},n.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(t,n,a){var r=t("../utils"),s=t("./GenericWorker");function o(l){s.call(this,"DataWorker");var u=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,l.then(function(f){u.dataIsReady=!0,u.data=f,u.max=f&&f.length||0,u.type=r.getTypeOf(f),u.isPaused||u._tickAndRepeat()},function(f){u.error(f)})}r.inherits(o,s),o.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,r.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(r.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var l=null,u=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":l=this.data.substring(this.index,u);break;case"uint8array":l=this.data.subarray(this.index,u);break;case"array":case"nodebuffer":l=this.data.slice(this.index,u)}return this.index=u,this.push({data:l,meta:{percent:this.max?this.index/this.max*100:0}})},n.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(t,n,a){function r(s){this.name=s||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}r.prototype={push:function(s){this.emit("data",s)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(s){this.emit("error",s)}return!0},error:function(s){return!this.isFinished&&(this.isPaused?this.generatedError=s:(this.isFinished=!0,this.emit("error",s),this.previous&&this.previous.error(s),this.cleanUp()),!0)},on:function(s,o){return this._listeners[s].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(s,o){if(this._listeners[s])for(var l=0;l<this._listeners[s].length;l++)this._listeners[s][l].call(this,o)},pipe:function(s){return s.registerPrevious(this)},registerPrevious:function(s){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=s.streamInfo,this.mergeStreamInfo(),this.previous=s;var o=this;return s.on("data",function(l){o.processChunk(l)}),s.on("end",function(){o.end()}),s.on("error",function(l){o.error(l)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var s=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),s=!0),this.previous&&this.previous.resume(),!s},flush:function(){},processChunk:function(s){this.push(s)},withStreamInfo:function(s,o){return this.extraStreamInfo[s]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var s in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,s)&&(this.streamInfo[s]=this.extraStreamInfo[s])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var s="Worker "+this.name;return this.previous?this.previous+" -> "+s:s}},n.exports=r},{}],29:[function(t,n,a){var r=t("../utils"),s=t("./ConvertWorker"),o=t("./GenericWorker"),l=t("../base64"),u=t("../support"),f=t("../external"),c=null;if(u.nodestream)try{c=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function d(p,m){return new f.Promise(function(g,y){var x=[],w=p._internalType,C=p._outputType,_=p._mimeType;p.on("data",function(F,D){x.push(F),m&&m(D)}).on("error",function(F){x=[],y(F)}).on("end",function(){try{var F=function(D,O,H){switch(D){case"blob":return r.newBlob(r.transformTo("arraybuffer",O),H);case"base64":return l.encode(O);default:return r.transformTo(D,O)}}(C,function(D,O){var H,Y=0,re=null,M=0;for(H=0;H<O.length;H++)M+=O[H].length;switch(D){case"string":return O.join("");case"array":return Array.prototype.concat.apply([],O);case"uint8array":for(re=new Uint8Array(M),H=0;H<O.length;H++)re.set(O[H],Y),Y+=O[H].length;return re;case"nodebuffer":return Buffer.concat(O);default:throw new Error("concat : unsupported type '"+D+"'")}}(w,x),_);g(F)}catch(D){y(D)}x=[]}).resume()})}function h(p,m,g){var y=m;switch(m){case"blob":case"arraybuffer":y="uint8array";break;case"base64":y="string"}try{this._internalType=y,this._outputType=m,this._mimeType=g,r.checkSupport(y),this._worker=p.pipe(new s(y)),p.lock()}catch(x){this._worker=new o("error"),this._worker.error(x)}}h.prototype={accumulate:function(p){return d(this,p)},on:function(p,m){var g=this;return p==="data"?this._worker.on(p,function(y){m.call(g,y.data,y.meta)}):this._worker.on(p,function(){r.delay(m,arguments,g)}),this},resume:function(){return r.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(p){if(r.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new c(this,{objectMode:this._outputType!=="nodebuffer"},p)}},n.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,n,a){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",a.nodebuffer=typeof Buffer<"u",a.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")a.blob=!1;else{var r=new ArrayBuffer(0);try{a.blob=new Blob([r],{type:"application/zip"}).size===0}catch{try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);s.append(r),a.blob=s.getBlob("application/zip").size===0}catch{a.blob=!1}}}try{a.nodestream=!!t("readable-stream").Readable}catch{a.nodestream=!1}},{"readable-stream":16}],31:[function(t,n,a){for(var r=t("./utils"),s=t("./support"),o=t("./nodejsUtils"),l=t("./stream/GenericWorker"),u=new Array(256),f=0;f<256;f++)u[f]=252<=f?6:248<=f?5:240<=f?4:224<=f?3:192<=f?2:1;u[254]=u[254]=1;function c(){l.call(this,"utf-8 decode"),this.leftOver=null}function d(){l.call(this,"utf-8 encode")}a.utf8encode=function(h){return s.nodebuffer?o.newBufferFrom(h,"utf-8"):function(p){var m,g,y,x,w,C=p.length,_=0;for(x=0;x<C;x++)(64512&(g=p.charCodeAt(x)))==55296&&x+1<C&&(64512&(y=p.charCodeAt(x+1)))==56320&&(g=65536+(g-55296<<10)+(y-56320),x++),_+=g<128?1:g<2048?2:g<65536?3:4;for(m=s.uint8array?new Uint8Array(_):new Array(_),x=w=0;w<_;x++)(64512&(g=p.charCodeAt(x)))==55296&&x+1<C&&(64512&(y=p.charCodeAt(x+1)))==56320&&(g=65536+(g-55296<<10)+(y-56320),x++),g<128?m[w++]=g:(g<2048?m[w++]=192|g>>>6:(g<65536?m[w++]=224|g>>>12:(m[w++]=240|g>>>18,m[w++]=128|g>>>12&63),m[w++]=128|g>>>6&63),m[w++]=128|63&g);return m}(h)},a.utf8decode=function(h){return s.nodebuffer?r.transformTo("nodebuffer",h).toString("utf-8"):function(p){var m,g,y,x,w=p.length,C=new Array(2*w);for(m=g=0;m<w;)if((y=p[m++])<128)C[g++]=y;else if(4<(x=u[y]))C[g++]=65533,m+=x-1;else{for(y&=x===2?31:x===3?15:7;1<x&&m<w;)y=y<<6|63&p[m++],x--;1<x?C[g++]=65533:y<65536?C[g++]=y:(y-=65536,C[g++]=55296|y>>10&1023,C[g++]=56320|1023&y)}return C.length!==g&&(C.subarray?C=C.subarray(0,g):C.length=g),r.applyFromCharCode(C)}(h=r.transformTo(s.uint8array?"uint8array":"array",h))},r.inherits(c,l),c.prototype.processChunk=function(h){var p=r.transformTo(s.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(s.uint8array){var m=p;(p=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),p.set(m,this.leftOver.length)}else p=this.leftOver.concat(p);this.leftOver=null}var g=function(x,w){var C;for((w=w||x.length)>x.length&&(w=x.length),C=w-1;0<=C&&(192&x[C])==128;)C--;return C<0||C===0?w:C+u[x[C]]>w?C:w}(p),y=p;g!==p.length&&(s.uint8array?(y=p.subarray(0,g),this.leftOver=p.subarray(g,p.length)):(y=p.slice(0,g),this.leftOver=p.slice(g,p.length))),this.push({data:a.utf8decode(y),meta:h.meta})},c.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=c,r.inherits(d,l),d.prototype.processChunk=function(h){this.push({data:a.utf8encode(h.data),meta:h.meta})},a.Utf8EncodeWorker=d},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,n,a){var r=t("./support"),s=t("./base64"),o=t("./nodejsUtils"),l=t("./external");function u(m){return m}function f(m,g){for(var y=0;y<m.length;++y)g[y]=255&m.charCodeAt(y);return g}t("setimmediate"),a.newBlob=function(m,g){a.checkSupport("blob");try{return new Blob([m],{type:g})}catch{try{var y=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return y.append(m),y.getBlob(g)}catch{throw new Error("Bug : can't construct the Blob.")}}};var c={stringifyByChunk:function(m,g,y){var x=[],w=0,C=m.length;if(C<=y)return String.fromCharCode.apply(null,m);for(;w<C;)g==="array"||g==="nodebuffer"?x.push(String.fromCharCode.apply(null,m.slice(w,Math.min(w+y,C)))):x.push(String.fromCharCode.apply(null,m.subarray(w,Math.min(w+y,C)))),w+=y;return x.join("")},stringifyByChar:function(m){for(var g="",y=0;y<m.length;y++)g+=String.fromCharCode(m[y]);return g},applyCanBeUsed:{uint8array:function(){try{return r.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return r.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}}()}};function d(m){var g=65536,y=a.getTypeOf(m),x=!0;if(y==="uint8array"?x=c.applyCanBeUsed.uint8array:y==="nodebuffer"&&(x=c.applyCanBeUsed.nodebuffer),x)for(;1<g;)try{return c.stringifyByChunk(m,y,g)}catch{g=Math.floor(g/2)}return c.stringifyByChar(m)}function h(m,g){for(var y=0;y<m.length;y++)g[y]=m[y];return g}a.applyFromCharCode=d;var p={};p.string={string:u,array:function(m){return f(m,new Array(m.length))},arraybuffer:function(m){return p.string.uint8array(m).buffer},uint8array:function(m){return f(m,new Uint8Array(m.length))},nodebuffer:function(m){return f(m,o.allocBuffer(m.length))}},p.array={string:d,array:u,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(m)}},p.arraybuffer={string:function(m){return d(new Uint8Array(m))},array:function(m){return h(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:u,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(new Uint8Array(m))}},p.uint8array={string:d,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:u,nodebuffer:function(m){return o.newBufferFrom(m)}},p.nodebuffer={string:d,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return p.nodebuffer.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:u},a.transformTo=function(m,g){if(g=g||"",!m)return g;a.checkSupport(m);var y=a.getTypeOf(g);return p[y][m](g)},a.resolve=function(m){for(var g=m.split("/"),y=[],x=0;x<g.length;x++){var w=g[x];w==="."||w===""&&x!==0&&x!==g.length-1||(w===".."?y.pop():y.push(w))}return y.join("/")},a.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":r.nodebuffer&&o.isBuffer(m)?"nodebuffer":r.uint8array&&m instanceof Uint8Array?"uint8array":r.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(m){if(!r[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(m){var g,y,x="";for(y=0;y<(m||"").length;y++)x+="\\x"+((g=m.charCodeAt(y))<16?"0":"")+g.toString(16).toUpperCase();return x},a.delay=function(m,g,y){setImmediate(function(){m.apply(y||null,g||[])})},a.inherits=function(m,g){function y(){}y.prototype=g.prototype,m.prototype=new y},a.extend=function(){var m,g,y={};for(m=0;m<arguments.length;m++)for(g in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],g)&&y[g]===void 0&&(y[g]=arguments[m][g]);return y},a.prepareContent=function(m,g,y,x,w){return l.Promise.resolve(g).then(function(C){return r.blob&&(C instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(C))!==-1)&&typeof FileReader<"u"?new l.Promise(function(_,F){var D=new FileReader;D.onload=function(O){_(O.target.result)},D.onerror=function(O){F(O.target.error)},D.readAsArrayBuffer(C)}):C}).then(function(C){var _=a.getTypeOf(C);return _?(_==="arraybuffer"?C=a.transformTo("uint8array",C):_==="string"&&(w?C=s.decode(C):y&&x!==!0&&(C=function(F){return f(F,r.uint8array?new Uint8Array(F.length):new Array(F.length))}(C))),C):l.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,n,a){var r=t("./reader/readerFor"),s=t("./utils"),o=t("./signature"),l=t("./zipEntry"),u=t("./support");function f(c){this.files=[],this.loadOptions=c}f.prototype={checkSignature:function(c){if(!this.reader.readAndCheckSignature(c)){this.reader.index-=4;var d=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+s.pretty(d)+", expected "+s.pretty(c)+")")}},isSignature:function(c,d){var h=this.reader.index;this.reader.setIndex(c);var p=this.reader.readString(4)===d;return this.reader.setIndex(h),p},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var c=this.reader.readData(this.zipCommentLength),d=u.uint8array?"uint8array":"array",h=s.transformTo(d,c);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var c,d,h,p=this.zip64EndOfCentralSize-44;0<p;)c=this.reader.readInt(2),d=this.reader.readInt(4),h=this.reader.readData(d),this.zip64ExtensibleData[c]={id:c,length:d,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var c,d;for(c=0;c<this.files.length;c++)d=this.files[c],this.reader.setIndex(d.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),d.readLocalPart(this.reader),d.handleUTF8(),d.processAttributes()},readCentralDir:function(){var c;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(c=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(c);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var c=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(c<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(c);var d=c;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===s.MAX_VALUE_16BITS||this.diskWithCentralDirStart===s.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===s.MAX_VALUE_16BITS||this.centralDirRecords===s.MAX_VALUE_16BITS||this.centralDirSize===s.MAX_VALUE_32BITS||this.centralDirOffset===s.MAX_VALUE_32BITS){if(this.zip64=!0,(c=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(c),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var p=d-h;if(0<p)this.isSignature(d,o.CENTRAL_FILE_HEADER)||(this.reader.zero=p);else if(p<0)throw new Error("Corrupted zip: missing "+Math.abs(p)+" bytes.")},prepareReader:function(c){this.reader=r(c)},load:function(c){this.prepareReader(c),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},n.exports=f},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,n,a){var r=t("./reader/readerFor"),s=t("./utils"),o=t("./compressedObject"),l=t("./crc32"),u=t("./utf8"),f=t("./compressions"),c=t("./support");function d(h,p){this.options=h,this.loadOptions=p}d.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var p,m;if(h.skip(22),this.fileNameLength=h.readInt(2),m=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((p=function(g){for(var y in f)if(Object.prototype.hasOwnProperty.call(f,y)&&f[y].magic===g)return f[y];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+s.pretty(this.compressionMethod)+" unknown (inner file : "+s.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,p,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var p=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(p),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=r(this.extraFields[1].value);this.uncompressedSize===s.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===s.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===s.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===s.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var p,m,g,y=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<y;)p=h.readInt(2),m=h.readInt(2),g=h.readData(m),this.extraFields[p]={id:p,length:m,value:g};h.setIndex(y)},handleUTF8:function(){var h=c.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=u.utf8decode(this.fileName),this.fileCommentStr=u.utf8decode(this.fileComment);else{var p=this.findExtraFieldUnicodePath();if(p!==null)this.fileNameStr=p;else{var m=s.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var g=this.findExtraFieldUnicodeComment();if(g!==null)this.fileCommentStr=g;else{var y=s.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(y)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var p=r(h.value);return p.readInt(1)!==1||l(this.fileName)!==p.readInt(4)?null:u.utf8decode(p.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var p=r(h.value);return p.readInt(1)!==1||l(this.fileComment)!==p.readInt(4)?null:u.utf8decode(p.readData(h.length-5))}return null}},n.exports=d},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,n,a){function r(p,m,g){this.name=p,this.dir=g.dir,this.date=g.date,this.comment=g.comment,this.unixPermissions=g.unixPermissions,this.dosPermissions=g.dosPermissions,this._data=m,this._dataBinary=g.binary,this.options={compression:g.compression,compressionOptions:g.compressionOptions}}var s=t("./stream/StreamHelper"),o=t("./stream/DataWorker"),l=t("./utf8"),u=t("./compressedObject"),f=t("./stream/GenericWorker");r.prototype={internalStream:function(p){var m=null,g="string";try{if(!p)throw new Error("No output type specified.");var y=(g=p.toLowerCase())==="string"||g==="text";g!=="binarystring"&&g!=="text"||(g="string"),m=this._decompressWorker();var x=!this._dataBinary;x&&!y&&(m=m.pipe(new l.Utf8EncodeWorker)),!x&&y&&(m=m.pipe(new l.Utf8DecodeWorker))}catch(w){(m=new f("error")).error(w)}return new s(m,g,"")},async:function(p,m){return this.internalStream(p).accumulate(m)},nodeStream:function(p,m){return this.internalStream(p||"nodebuffer").toNodejsStream(m)},_compressWorker:function(p,m){if(this._data instanceof u&&this._data.compression.magic===p.magic)return this._data.getCompressedWorker();var g=this._decompressWorker();return this._dataBinary||(g=g.pipe(new l.Utf8EncodeWorker)),u.createWorkerFrom(g,p,m)},_decompressWorker:function(){return this._data instanceof u?this._data.getContentWorker():this._data instanceof f?this._data:new o(this._data)}};for(var c=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],d=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<c.length;h++)r.prototype[c[h]]=d;n.exports=r},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,n,a){(function(r){var s,o,l=r.MutationObserver||r.WebKitMutationObserver;if(l){var u=0,f=new l(p),c=r.document.createTextNode("");f.observe(c,{characterData:!0}),s=function(){c.data=u=++u%2}}else if(r.setImmediate||r.MessageChannel===void 0)s="document"in r&&"onreadystatechange"in r.document.createElement("script")?function(){var m=r.document.createElement("script");m.onreadystatechange=function(){p(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},r.document.documentElement.appendChild(m)}:function(){setTimeout(p,0)};else{var d=new r.MessageChannel;d.port1.onmessage=p,s=function(){d.port2.postMessage(0)}}var h=[];function p(){var m,g;o=!0;for(var y=h.length;y;){for(g=h,h=[],m=-1;++m<y;)g[m]();y=h.length}o=!1}n.exports=function(m){h.push(m)!==1||o||s()}}).call(this,typeof vi<"u"?vi:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,n,a){var r=t("immediate");function s(){}var o={},l=["REJECTED"],u=["FULFILLED"],f=["PENDING"];function c(y){if(typeof y!="function")throw new TypeError("resolver must be a function");this.state=f,this.queue=[],this.outcome=void 0,y!==s&&m(this,y)}function d(y,x,w){this.promise=y,typeof x=="function"&&(this.onFulfilled=x,this.callFulfilled=this.otherCallFulfilled),typeof w=="function"&&(this.onRejected=w,this.callRejected=this.otherCallRejected)}function h(y,x,w){r(function(){var C;try{C=x(w)}catch(_){return o.reject(y,_)}C===y?o.reject(y,new TypeError("Cannot resolve promise with itself")):o.resolve(y,C)})}function p(y){var x=y&&y.then;if(y&&(typeof y=="object"||typeof y=="function")&&typeof x=="function")return function(){x.apply(y,arguments)}}function m(y,x){var w=!1;function C(D){w||(w=!0,o.reject(y,D))}function _(D){w||(w=!0,o.resolve(y,D))}var F=g(function(){x(_,C)});F.status==="error"&&C(F.value)}function g(y,x){var w={};try{w.value=y(x),w.status="success"}catch(C){w.status="error",w.value=C}return w}(n.exports=c).prototype.finally=function(y){if(typeof y!="function")return this;var x=this.constructor;return this.then(function(w){return x.resolve(y()).then(function(){return w})},function(w){return x.resolve(y()).then(function(){throw w})})},c.prototype.catch=function(y){return this.then(null,y)},c.prototype.then=function(y,x){if(typeof y!="function"&&this.state===u||typeof x!="function"&&this.state===l)return this;var w=new this.constructor(s);return this.state!==f?h(w,this.state===u?y:x,this.outcome):this.queue.push(new d(w,y,x)),w},d.prototype.callFulfilled=function(y){o.resolve(this.promise,y)},d.prototype.otherCallFulfilled=function(y){h(this.promise,this.onFulfilled,y)},d.prototype.callRejected=function(y){o.reject(this.promise,y)},d.prototype.otherCallRejected=function(y){h(this.promise,this.onRejected,y)},o.resolve=function(y,x){var w=g(p,x);if(w.status==="error")return o.reject(y,w.value);var C=w.value;if(C)m(y,C);else{y.state=u,y.outcome=x;for(var _=-1,F=y.queue.length;++_<F;)y.queue[_].callFulfilled(x)}return y},o.reject=function(y,x){y.state=l,y.outcome=x;for(var w=-1,C=y.queue.length;++w<C;)y.queue[w].callRejected(x);return y},c.resolve=function(y){return y instanceof this?y:o.resolve(new this(s),y)},c.reject=function(y){var x=new this(s);return o.reject(x,y)},c.all=function(y){var x=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=y.length,C=!1;if(!w)return this.resolve([]);for(var _=new Array(w),F=0,D=-1,O=new this(s);++D<w;)H(y[D],D);return O;function H(Y,re){x.resolve(Y).then(function(M){_[re]=M,++F!==w||C||(C=!0,o.resolve(O,_))},function(M){C||(C=!0,o.reject(O,M))})}},c.race=function(y){var x=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=y.length,C=!1;if(!w)return this.resolve([]);for(var _=-1,F=new this(s);++_<w;)D=y[_],x.resolve(D).then(function(O){C||(C=!0,o.resolve(F,O))},function(O){C||(C=!0,o.reject(F,O))});var D;return F}},{immediate:36}],38:[function(t,n,a){var r={};(0,t("./lib/utils/common").assign)(r,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),n.exports=r},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,n,a){var r=t("./zlib/deflate"),s=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/messages"),u=t("./zlib/zstream"),f=Object.prototype.toString,c=0,d=-1,h=0,p=8;function m(y){if(!(this instanceof m))return new m(y);this.options=s.assign({level:d,method:p,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},y||{});var x=this.options;x.raw&&0<x.windowBits?x.windowBits=-x.windowBits:x.gzip&&0<x.windowBits&&x.windowBits<16&&(x.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var w=r.deflateInit2(this.strm,x.level,x.method,x.windowBits,x.memLevel,x.strategy);if(w!==c)throw new Error(l[w]);if(x.header&&r.deflateSetHeader(this.strm,x.header),x.dictionary){var C;if(C=typeof x.dictionary=="string"?o.string2buf(x.dictionary):f.call(x.dictionary)==="[object ArrayBuffer]"?new Uint8Array(x.dictionary):x.dictionary,(w=r.deflateSetDictionary(this.strm,C))!==c)throw new Error(l[w]);this._dict_set=!0}}function g(y,x){var w=new m(x);if(w.push(y,!0),w.err)throw w.msg||l[w.err];return w.result}m.prototype.push=function(y,x){var w,C,_=this.strm,F=this.options.chunkSize;if(this.ended)return!1;C=x===~~x?x:x===!0?4:0,typeof y=="string"?_.input=o.string2buf(y):f.call(y)==="[object ArrayBuffer]"?_.input=new Uint8Array(y):_.input=y,_.next_in=0,_.avail_in=_.input.length;do{if(_.avail_out===0&&(_.output=new s.Buf8(F),_.next_out=0,_.avail_out=F),(w=r.deflate(_,C))!==1&&w!==c)return this.onEnd(w),!(this.ended=!0);_.avail_out!==0&&(_.avail_in!==0||C!==4&&C!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(s.shrinkBuf(_.output,_.next_out))):this.onData(s.shrinkBuf(_.output,_.next_out)))}while((0<_.avail_in||_.avail_out===0)&&w!==1);return C===4?(w=r.deflateEnd(this.strm),this.onEnd(w),this.ended=!0,w===c):C!==2||(this.onEnd(c),!(_.avail_out=0))},m.prototype.onData=function(y){this.chunks.push(y)},m.prototype.onEnd=function(y){y===c&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=y,this.msg=this.strm.msg},a.Deflate=m,a.deflate=g,a.deflateRaw=function(y,x){return(x=x||{}).raw=!0,g(y,x)},a.gzip=function(y,x){return(x=x||{}).gzip=!0,g(y,x)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,n,a){var r=t("./zlib/inflate"),s=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/constants"),u=t("./zlib/messages"),f=t("./zlib/zstream"),c=t("./zlib/gzheader"),d=Object.prototype.toString;function h(m){if(!(this instanceof h))return new h(m);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},m||{});var g=this.options;g.raw&&0<=g.windowBits&&g.windowBits<16&&(g.windowBits=-g.windowBits,g.windowBits===0&&(g.windowBits=-15)),!(0<=g.windowBits&&g.windowBits<16)||m&&m.windowBits||(g.windowBits+=32),15<g.windowBits&&g.windowBits<48&&(15&g.windowBits)==0&&(g.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new f,this.strm.avail_out=0;var y=r.inflateInit2(this.strm,g.windowBits);if(y!==l.Z_OK)throw new Error(u[y]);this.header=new c,r.inflateGetHeader(this.strm,this.header)}function p(m,g){var y=new h(g);if(y.push(m,!0),y.err)throw y.msg||u[y.err];return y.result}h.prototype.push=function(m,g){var y,x,w,C,_,F,D=this.strm,O=this.options.chunkSize,H=this.options.dictionary,Y=!1;if(this.ended)return!1;x=g===~~g?g:g===!0?l.Z_FINISH:l.Z_NO_FLUSH,typeof m=="string"?D.input=o.binstring2buf(m):d.call(m)==="[object ArrayBuffer]"?D.input=new Uint8Array(m):D.input=m,D.next_in=0,D.avail_in=D.input.length;do{if(D.avail_out===0&&(D.output=new s.Buf8(O),D.next_out=0,D.avail_out=O),(y=r.inflate(D,l.Z_NO_FLUSH))===l.Z_NEED_DICT&&H&&(F=typeof H=="string"?o.string2buf(H):d.call(H)==="[object ArrayBuffer]"?new Uint8Array(H):H,y=r.inflateSetDictionary(this.strm,F)),y===l.Z_BUF_ERROR&&Y===!0&&(y=l.Z_OK,Y=!1),y!==l.Z_STREAM_END&&y!==l.Z_OK)return this.onEnd(y),!(this.ended=!0);D.next_out&&(D.avail_out!==0&&y!==l.Z_STREAM_END&&(D.avail_in!==0||x!==l.Z_FINISH&&x!==l.Z_SYNC_FLUSH)||(this.options.to==="string"?(w=o.utf8border(D.output,D.next_out),C=D.next_out-w,_=o.buf2string(D.output,w),D.next_out=C,D.avail_out=O-C,C&&s.arraySet(D.output,D.output,w,C,0),this.onData(_)):this.onData(s.shrinkBuf(D.output,D.next_out)))),D.avail_in===0&&D.avail_out===0&&(Y=!0)}while((0<D.avail_in||D.avail_out===0)&&y!==l.Z_STREAM_END);return y===l.Z_STREAM_END&&(x=l.Z_FINISH),x===l.Z_FINISH?(y=r.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===l.Z_OK):x!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),!(D.avail_out=0))},h.prototype.onData=function(m){this.chunks.push(m)},h.prototype.onEnd=function(m){m===l.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},a.Inflate=h,a.inflate=p,a.inflateRaw=function(m,g){return(g=g||{}).raw=!0,p(m,g)},a.ungzip=p},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,n,a){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";a.assign=function(l){for(var u=Array.prototype.slice.call(arguments,1);u.length;){var f=u.shift();if(f){if(typeof f!="object")throw new TypeError(f+"must be non-object");for(var c in f)f.hasOwnProperty(c)&&(l[c]=f[c])}}return l},a.shrinkBuf=function(l,u){return l.length===u?l:l.subarray?l.subarray(0,u):(l.length=u,l)};var s={arraySet:function(l,u,f,c,d){if(u.subarray&&l.subarray)l.set(u.subarray(f,f+c),d);else for(var h=0;h<c;h++)l[d+h]=u[f+h]},flattenChunks:function(l){var u,f,c,d,h,p;for(u=c=0,f=l.length;u<f;u++)c+=l[u].length;for(p=new Uint8Array(c),u=d=0,f=l.length;u<f;u++)h=l[u],p.set(h,d),d+=h.length;return p}},o={arraySet:function(l,u,f,c,d){for(var h=0;h<c;h++)l[d+h]=u[f+h]},flattenChunks:function(l){return[].concat.apply([],l)}};a.setTyped=function(l){l?(a.Buf8=Uint8Array,a.Buf16=Uint16Array,a.Buf32=Int32Array,a.assign(a,s)):(a.Buf8=Array,a.Buf16=Array,a.Buf32=Array,a.assign(a,o))},a.setTyped(r)},{}],42:[function(t,n,a){var r=t("./common"),s=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{s=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var l=new r.Buf8(256),u=0;u<256;u++)l[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;function f(c,d){if(d<65537&&(c.subarray&&o||!c.subarray&&s))return String.fromCharCode.apply(null,r.shrinkBuf(c,d));for(var h="",p=0;p<d;p++)h+=String.fromCharCode(c[p]);return h}l[254]=l[254]=1,a.string2buf=function(c){var d,h,p,m,g,y=c.length,x=0;for(m=0;m<y;m++)(64512&(h=c.charCodeAt(m)))==55296&&m+1<y&&(64512&(p=c.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(p-56320),m++),x+=h<128?1:h<2048?2:h<65536?3:4;for(d=new r.Buf8(x),m=g=0;g<x;m++)(64512&(h=c.charCodeAt(m)))==55296&&m+1<y&&(64512&(p=c.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(p-56320),m++),h<128?d[g++]=h:(h<2048?d[g++]=192|h>>>6:(h<65536?d[g++]=224|h>>>12:(d[g++]=240|h>>>18,d[g++]=128|h>>>12&63),d[g++]=128|h>>>6&63),d[g++]=128|63&h);return d},a.buf2binstring=function(c){return f(c,c.length)},a.binstring2buf=function(c){for(var d=new r.Buf8(c.length),h=0,p=d.length;h<p;h++)d[h]=c.charCodeAt(h);return d},a.buf2string=function(c,d){var h,p,m,g,y=d||c.length,x=new Array(2*y);for(h=p=0;h<y;)if((m=c[h++])<128)x[p++]=m;else if(4<(g=l[m]))x[p++]=65533,h+=g-1;else{for(m&=g===2?31:g===3?15:7;1<g&&h<y;)m=m<<6|63&c[h++],g--;1<g?x[p++]=65533:m<65536?x[p++]=m:(m-=65536,x[p++]=55296|m>>10&1023,x[p++]=56320|1023&m)}return f(x,p)},a.utf8border=function(c,d){var h;for((d=d||c.length)>c.length&&(d=c.length),h=d-1;0<=h&&(192&c[h])==128;)h--;return h<0||h===0?d:h+l[c[h]]>d?h:d}},{"./common":41}],43:[function(t,n,a){n.exports=function(r,s,o,l){for(var u=65535&r|0,f=r>>>16&65535|0,c=0;o!==0;){for(o-=c=2e3<o?2e3:o;f=f+(u=u+s[l++]|0)|0,--c;);u%=65521,f%=65521}return u|f<<16|0}},{}],44:[function(t,n,a){n.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,n,a){var r=function(){for(var s,o=[],l=0;l<256;l++){s=l;for(var u=0;u<8;u++)s=1&s?3988292384^s>>>1:s>>>1;o[l]=s}return o}();n.exports=function(s,o,l,u){var f=r,c=u+l;s^=-1;for(var d=u;d<c;d++)s=s>>>8^f[255&(s^o[d])];return-1^s}},{}],46:[function(t,n,a){var r,s=t("../utils/common"),o=t("./trees"),l=t("./adler32"),u=t("./crc32"),f=t("./messages"),c=0,d=4,h=0,p=-2,m=-1,g=4,y=2,x=8,w=9,C=286,_=30,F=19,D=2*C+1,O=15,H=3,Y=258,re=Y+H+1,M=42,R=113,v=1,S=2,$=3,L=4;function G(E,X){return E.msg=f[X],X}function V(E){return(E<<1)-(4<E?9:0)}function J(E){for(var X=E.length;0<=--X;)E[X]=0}function N(E){var X=E.state,q=X.pending;q>E.avail_out&&(q=E.avail_out),q!==0&&(s.arraySet(E.output,X.pending_buf,X.pending_out,q,E.next_out),E.next_out+=q,X.pending_out+=q,E.total_out+=q,E.avail_out-=q,X.pending-=q,X.pending===0&&(X.pending_out=0))}function P(E,X){o._tr_flush_block(E,0<=E.block_start?E.block_start:-1,E.strstart-E.block_start,X),E.block_start=E.strstart,N(E.strm)}function ae(E,X){E.pending_buf[E.pending++]=X}function ne(E,X){E.pending_buf[E.pending++]=X>>>8&255,E.pending_buf[E.pending++]=255&X}function ee(E,X){var q,T,k=E.max_chain_length,z=E.strstart,j=E.prev_length,Q=E.nice_match,U=E.strstart>E.w_size-re?E.strstart-(E.w_size-re):0,oe=E.window,ue=E.w_mask,le=E.prev,we=E.strstart+Y,Ge=oe[z+j-1],De=oe[z+j];E.prev_length>=E.good_match&&(k>>=2),Q>E.lookahead&&(Q=E.lookahead);do if(oe[(q=X)+j]===De&&oe[q+j-1]===Ge&&oe[q]===oe[z]&&oe[++q]===oe[z+1]){z+=2,q++;do;while(oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&z<we);if(T=Y-(we-z),z=we-Y,j<T){if(E.match_start=X,Q<=(j=T))break;Ge=oe[z+j-1],De=oe[z+j]}}while((X=le[X&ue])>U&&--k!=0);return j<=E.lookahead?j:E.lookahead}function Me(E){var X,q,T,k,z,j,Q,U,oe,ue,le=E.w_size;do{if(k=E.window_size-E.lookahead-E.strstart,E.strstart>=le+(le-re)){for(s.arraySet(E.window,E.window,le,le,0),E.match_start-=le,E.strstart-=le,E.block_start-=le,X=q=E.hash_size;T=E.head[--X],E.head[X]=le<=T?T-le:0,--q;);for(X=q=le;T=E.prev[--X],E.prev[X]=le<=T?T-le:0,--q;);k+=le}if(E.strm.avail_in===0)break;if(j=E.strm,Q=E.window,U=E.strstart+E.lookahead,oe=k,ue=void 0,ue=j.avail_in,oe<ue&&(ue=oe),q=ue===0?0:(j.avail_in-=ue,s.arraySet(Q,j.input,j.next_in,ue,U),j.state.wrap===1?j.adler=l(j.adler,Q,ue,U):j.state.wrap===2&&(j.adler=u(j.adler,Q,ue,U)),j.next_in+=ue,j.total_in+=ue,ue),E.lookahead+=q,E.lookahead+E.insert>=H)for(z=E.strstart-E.insert,E.ins_h=E.window[z],E.ins_h=(E.ins_h<<E.hash_shift^E.window[z+1])&E.hash_mask;E.insert&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[z+H-1])&E.hash_mask,E.prev[z&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=z,z++,E.insert--,!(E.lookahead+E.insert<H)););}while(E.lookahead<re&&E.strm.avail_in!==0)}function Ne(E,X){for(var q,T;;){if(E.lookahead<re){if(Me(E),E.lookahead<re&&X===c)return v;if(E.lookahead===0)break}if(q=0,E.lookahead>=H&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+H-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart),q!==0&&E.strstart-q<=E.w_size-re&&(E.match_length=ee(E,q)),E.match_length>=H)if(T=o._tr_tally(E,E.strstart-E.match_start,E.match_length-H),E.lookahead-=E.match_length,E.match_length<=E.max_lazy_match&&E.lookahead>=H){for(E.match_length--;E.strstart++,E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+H-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart,--E.match_length!=0;);E.strstart++}else E.strstart+=E.match_length,E.match_length=0,E.ins_h=E.window[E.strstart],E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+1])&E.hash_mask;else T=o._tr_tally(E,0,E.window[E.strstart]),E.lookahead--,E.strstart++;if(T&&(P(E,!1),E.strm.avail_out===0))return v}return E.insert=E.strstart<H-1?E.strstart:H-1,X===d?(P(E,!0),E.strm.avail_out===0?$:L):E.last_lit&&(P(E,!1),E.strm.avail_out===0)?v:S}function _e(E,X){for(var q,T,k;;){if(E.lookahead<re){if(Me(E),E.lookahead<re&&X===c)return v;if(E.lookahead===0)break}if(q=0,E.lookahead>=H&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+H-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart),E.prev_length=E.match_length,E.prev_match=E.match_start,E.match_length=H-1,q!==0&&E.prev_length<E.max_lazy_match&&E.strstart-q<=E.w_size-re&&(E.match_length=ee(E,q),E.match_length<=5&&(E.strategy===1||E.match_length===H&&4096<E.strstart-E.match_start)&&(E.match_length=H-1)),E.prev_length>=H&&E.match_length<=E.prev_length){for(k=E.strstart+E.lookahead-H,T=o._tr_tally(E,E.strstart-1-E.prev_match,E.prev_length-H),E.lookahead-=E.prev_length-1,E.prev_length-=2;++E.strstart<=k&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+H-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart),--E.prev_length!=0;);if(E.match_available=0,E.match_length=H-1,E.strstart++,T&&(P(E,!1),E.strm.avail_out===0))return v}else if(E.match_available){if((T=o._tr_tally(E,0,E.window[E.strstart-1]))&&P(E,!1),E.strstart++,E.lookahead--,E.strm.avail_out===0)return v}else E.match_available=1,E.strstart++,E.lookahead--}return E.match_available&&(T=o._tr_tally(E,0,E.window[E.strstart-1]),E.match_available=0),E.insert=E.strstart<H-1?E.strstart:H-1,X===d?(P(E,!0),E.strm.avail_out===0?$:L):E.last_lit&&(P(E,!1),E.strm.avail_out===0)?v:S}function ve(E,X,q,T,k){this.good_length=E,this.max_lazy=X,this.nice_length=q,this.max_chain=T,this.func=k}function Le(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=x,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(2*D),this.dyn_dtree=new s.Buf16(2*(2*_+1)),this.bl_tree=new s.Buf16(2*(2*F+1)),J(this.dyn_ltree),J(this.dyn_dtree),J(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(O+1),this.heap=new s.Buf16(2*C+1),J(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(2*C+1),J(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Be(E){var X;return E&&E.state?(E.total_in=E.total_out=0,E.data_type=y,(X=E.state).pending=0,X.pending_out=0,X.wrap<0&&(X.wrap=-X.wrap),X.status=X.wrap?M:R,E.adler=X.wrap===2?0:1,X.last_flush=c,o._tr_init(X),h):G(E,p)}function st(E){var X=Be(E);return X===h&&function(q){q.window_size=2*q.w_size,J(q.head),q.max_lazy_match=r[q.level].max_lazy,q.good_match=r[q.level].good_length,q.nice_match=r[q.level].nice_length,q.max_chain_length=r[q.level].max_chain,q.strstart=0,q.block_start=0,q.lookahead=0,q.insert=0,q.match_length=q.prev_length=H-1,q.match_available=0,q.ins_h=0}(E.state),X}function ot(E,X,q,T,k,z){if(!E)return p;var j=1;if(X===m&&(X=6),T<0?(j=0,T=-T):15<T&&(j=2,T-=16),k<1||w<k||q!==x||T<8||15<T||X<0||9<X||z<0||g<z)return G(E,p);T===8&&(T=9);var Q=new Le;return(E.state=Q).strm=E,Q.wrap=j,Q.gzhead=null,Q.w_bits=T,Q.w_size=1<<Q.w_bits,Q.w_mask=Q.w_size-1,Q.hash_bits=k+7,Q.hash_size=1<<Q.hash_bits,Q.hash_mask=Q.hash_size-1,Q.hash_shift=~~((Q.hash_bits+H-1)/H),Q.window=new s.Buf8(2*Q.w_size),Q.head=new s.Buf16(Q.hash_size),Q.prev=new s.Buf16(Q.w_size),Q.lit_bufsize=1<<k+6,Q.pending_buf_size=4*Q.lit_bufsize,Q.pending_buf=new s.Buf8(Q.pending_buf_size),Q.d_buf=1*Q.lit_bufsize,Q.l_buf=3*Q.lit_bufsize,Q.level=X,Q.strategy=z,Q.method=q,st(E)}r=[new ve(0,0,0,0,function(E,X){var q=65535;for(q>E.pending_buf_size-5&&(q=E.pending_buf_size-5);;){if(E.lookahead<=1){if(Me(E),E.lookahead===0&&X===c)return v;if(E.lookahead===0)break}E.strstart+=E.lookahead,E.lookahead=0;var T=E.block_start+q;if((E.strstart===0||E.strstart>=T)&&(E.lookahead=E.strstart-T,E.strstart=T,P(E,!1),E.strm.avail_out===0)||E.strstart-E.block_start>=E.w_size-re&&(P(E,!1),E.strm.avail_out===0))return v}return E.insert=0,X===d?(P(E,!0),E.strm.avail_out===0?$:L):(E.strstart>E.block_start&&(P(E,!1),E.strm.avail_out),v)}),new ve(4,4,8,4,Ne),new ve(4,5,16,8,Ne),new ve(4,6,32,32,Ne),new ve(4,4,16,16,_e),new ve(8,16,32,32,_e),new ve(8,16,128,128,_e),new ve(8,32,128,256,_e),new ve(32,128,258,1024,_e),new ve(32,258,258,4096,_e)],a.deflateInit=function(E,X){return ot(E,X,x,15,8,0)},a.deflateInit2=ot,a.deflateReset=st,a.deflateResetKeep=Be,a.deflateSetHeader=function(E,X){return E&&E.state?E.state.wrap!==2?p:(E.state.gzhead=X,h):p},a.deflate=function(E,X){var q,T,k,z;if(!E||!E.state||5<X||X<0)return E?G(E,p):p;if(T=E.state,!E.output||!E.input&&E.avail_in!==0||T.status===666&&X!==d)return G(E,E.avail_out===0?-5:p);if(T.strm=E,q=T.last_flush,T.last_flush=X,T.status===M)if(T.wrap===2)E.adler=0,ae(T,31),ae(T,139),ae(T,8),T.gzhead?(ae(T,(T.gzhead.text?1:0)+(T.gzhead.hcrc?2:0)+(T.gzhead.extra?4:0)+(T.gzhead.name?8:0)+(T.gzhead.comment?16:0)),ae(T,255&T.gzhead.time),ae(T,T.gzhead.time>>8&255),ae(T,T.gzhead.time>>16&255),ae(T,T.gzhead.time>>24&255),ae(T,T.level===9?2:2<=T.strategy||T.level<2?4:0),ae(T,255&T.gzhead.os),T.gzhead.extra&&T.gzhead.extra.length&&(ae(T,255&T.gzhead.extra.length),ae(T,T.gzhead.extra.length>>8&255)),T.gzhead.hcrc&&(E.adler=u(E.adler,T.pending_buf,T.pending,0)),T.gzindex=0,T.status=69):(ae(T,0),ae(T,0),ae(T,0),ae(T,0),ae(T,0),ae(T,T.level===9?2:2<=T.strategy||T.level<2?4:0),ae(T,3),T.status=R);else{var j=x+(T.w_bits-8<<4)<<8;j|=(2<=T.strategy||T.level<2?0:T.level<6?1:T.level===6?2:3)<<6,T.strstart!==0&&(j|=32),j+=31-j%31,T.status=R,ne(T,j),T.strstart!==0&&(ne(T,E.adler>>>16),ne(T,65535&E.adler)),E.adler=1}if(T.status===69)if(T.gzhead.extra){for(k=T.pending;T.gzindex<(65535&T.gzhead.extra.length)&&(T.pending!==T.pending_buf_size||(T.gzhead.hcrc&&T.pending>k&&(E.adler=u(E.adler,T.pending_buf,T.pending-k,k)),N(E),k=T.pending,T.pending!==T.pending_buf_size));)ae(T,255&T.gzhead.extra[T.gzindex]),T.gzindex++;T.gzhead.hcrc&&T.pending>k&&(E.adler=u(E.adler,T.pending_buf,T.pending-k,k)),T.gzindex===T.gzhead.extra.length&&(T.gzindex=0,T.status=73)}else T.status=73;if(T.status===73)if(T.gzhead.name){k=T.pending;do{if(T.pending===T.pending_buf_size&&(T.gzhead.hcrc&&T.pending>k&&(E.adler=u(E.adler,T.pending_buf,T.pending-k,k)),N(E),k=T.pending,T.pending===T.pending_buf_size)){z=1;break}z=T.gzindex<T.gzhead.name.length?255&T.gzhead.name.charCodeAt(T.gzindex++):0,ae(T,z)}while(z!==0);T.gzhead.hcrc&&T.pending>k&&(E.adler=u(E.adler,T.pending_buf,T.pending-k,k)),z===0&&(T.gzindex=0,T.status=91)}else T.status=91;if(T.status===91)if(T.gzhead.comment){k=T.pending;do{if(T.pending===T.pending_buf_size&&(T.gzhead.hcrc&&T.pending>k&&(E.adler=u(E.adler,T.pending_buf,T.pending-k,k)),N(E),k=T.pending,T.pending===T.pending_buf_size)){z=1;break}z=T.gzindex<T.gzhead.comment.length?255&T.gzhead.comment.charCodeAt(T.gzindex++):0,ae(T,z)}while(z!==0);T.gzhead.hcrc&&T.pending>k&&(E.adler=u(E.adler,T.pending_buf,T.pending-k,k)),z===0&&(T.status=103)}else T.status=103;if(T.status===103&&(T.gzhead.hcrc?(T.pending+2>T.pending_buf_size&&N(E),T.pending+2<=T.pending_buf_size&&(ae(T,255&E.adler),ae(T,E.adler>>8&255),E.adler=0,T.status=R)):T.status=R),T.pending!==0){if(N(E),E.avail_out===0)return T.last_flush=-1,h}else if(E.avail_in===0&&V(X)<=V(q)&&X!==d)return G(E,-5);if(T.status===666&&E.avail_in!==0)return G(E,-5);if(E.avail_in!==0||T.lookahead!==0||X!==c&&T.status!==666){var Q=T.strategy===2?function(U,oe){for(var ue;;){if(U.lookahead===0&&(Me(U),U.lookahead===0)){if(oe===c)return v;break}if(U.match_length=0,ue=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++,ue&&(P(U,!1),U.strm.avail_out===0))return v}return U.insert=0,oe===d?(P(U,!0),U.strm.avail_out===0?$:L):U.last_lit&&(P(U,!1),U.strm.avail_out===0)?v:S}(T,X):T.strategy===3?function(U,oe){for(var ue,le,we,Ge,De=U.window;;){if(U.lookahead<=Y){if(Me(U),U.lookahead<=Y&&oe===c)return v;if(U.lookahead===0)break}if(U.match_length=0,U.lookahead>=H&&0<U.strstart&&(le=De[we=U.strstart-1])===De[++we]&&le===De[++we]&&le===De[++we]){Ge=U.strstart+Y;do;while(le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&we<Ge);U.match_length=Y-(Ge-we),U.match_length>U.lookahead&&(U.match_length=U.lookahead)}if(U.match_length>=H?(ue=o._tr_tally(U,1,U.match_length-H),U.lookahead-=U.match_length,U.strstart+=U.match_length,U.match_length=0):(ue=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++),ue&&(P(U,!1),U.strm.avail_out===0))return v}return U.insert=0,oe===d?(P(U,!0),U.strm.avail_out===0?$:L):U.last_lit&&(P(U,!1),U.strm.avail_out===0)?v:S}(T,X):r[T.level].func(T,X);if(Q!==$&&Q!==L||(T.status=666),Q===v||Q===$)return E.avail_out===0&&(T.last_flush=-1),h;if(Q===S&&(X===1?o._tr_align(T):X!==5&&(o._tr_stored_block(T,0,0,!1),X===3&&(J(T.head),T.lookahead===0&&(T.strstart=0,T.block_start=0,T.insert=0))),N(E),E.avail_out===0))return T.last_flush=-1,h}return X!==d?h:T.wrap<=0?1:(T.wrap===2?(ae(T,255&E.adler),ae(T,E.adler>>8&255),ae(T,E.adler>>16&255),ae(T,E.adler>>24&255),ae(T,255&E.total_in),ae(T,E.total_in>>8&255),ae(T,E.total_in>>16&255),ae(T,E.total_in>>24&255)):(ne(T,E.adler>>>16),ne(T,65535&E.adler)),N(E),0<T.wrap&&(T.wrap=-T.wrap),T.pending!==0?h:1)},a.deflateEnd=function(E){var X;return E&&E.state?(X=E.state.status)!==M&&X!==69&&X!==73&&X!==91&&X!==103&&X!==R&&X!==666?G(E,p):(E.state=null,X===R?G(E,-3):h):p},a.deflateSetDictionary=function(E,X){var q,T,k,z,j,Q,U,oe,ue=X.length;if(!E||!E.state||(z=(q=E.state).wrap)===2||z===1&&q.status!==M||q.lookahead)return p;for(z===1&&(E.adler=l(E.adler,X,ue,0)),q.wrap=0,ue>=q.w_size&&(z===0&&(J(q.head),q.strstart=0,q.block_start=0,q.insert=0),oe=new s.Buf8(q.w_size),s.arraySet(oe,X,ue-q.w_size,q.w_size,0),X=oe,ue=q.w_size),j=E.avail_in,Q=E.next_in,U=E.input,E.avail_in=ue,E.next_in=0,E.input=X,Me(q);q.lookahead>=H;){for(T=q.strstart,k=q.lookahead-(H-1);q.ins_h=(q.ins_h<<q.hash_shift^q.window[T+H-1])&q.hash_mask,q.prev[T&q.w_mask]=q.head[q.ins_h],q.head[q.ins_h]=T,T++,--k;);q.strstart=T,q.lookahead=H-1,Me(q)}return q.strstart+=q.lookahead,q.block_start=q.strstart,q.insert=q.lookahead,q.lookahead=0,q.match_length=q.prev_length=H-1,q.match_available=0,E.next_in=Q,E.input=U,E.avail_in=j,q.wrap=z,h},a.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,n,a){n.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,n,a){n.exports=function(r,s){var o,l,u,f,c,d,h,p,m,g,y,x,w,C,_,F,D,O,H,Y,re,M,R,v,S;o=r.state,l=r.next_in,v=r.input,u=l+(r.avail_in-5),f=r.next_out,S=r.output,c=f-(s-r.avail_out),d=f+(r.avail_out-257),h=o.dmax,p=o.wsize,m=o.whave,g=o.wnext,y=o.window,x=o.hold,w=o.bits,C=o.lencode,_=o.distcode,F=(1<<o.lenbits)-1,D=(1<<o.distbits)-1;e:do{w<15&&(x+=v[l++]<<w,w+=8,x+=v[l++]<<w,w+=8),O=C[x&F];t:for(;;){if(x>>>=H=O>>>24,w-=H,(H=O>>>16&255)===0)S[f++]=65535&O;else{if(!(16&H)){if((64&H)==0){O=C[(65535&O)+(x&(1<<H)-1)];continue t}if(32&H){o.mode=12;break e}r.msg="invalid literal/length code",o.mode=30;break e}Y=65535&O,(H&=15)&&(w<H&&(x+=v[l++]<<w,w+=8),Y+=x&(1<<H)-1,x>>>=H,w-=H),w<15&&(x+=v[l++]<<w,w+=8,x+=v[l++]<<w,w+=8),O=_[x&D];i:for(;;){if(x>>>=H=O>>>24,w-=H,!(16&(H=O>>>16&255))){if((64&H)==0){O=_[(65535&O)+(x&(1<<H)-1)];continue i}r.msg="invalid distance code",o.mode=30;break e}if(re=65535&O,w<(H&=15)&&(x+=v[l++]<<w,(w+=8)<H&&(x+=v[l++]<<w,w+=8)),h<(re+=x&(1<<H)-1)){r.msg="invalid distance too far back",o.mode=30;break e}if(x>>>=H,w-=H,(H=f-c)<re){if(m<(H=re-H)&&o.sane){r.msg="invalid distance too far back",o.mode=30;break e}if(R=y,(M=0)===g){if(M+=p-H,H<Y){for(Y-=H;S[f++]=y[M++],--H;);M=f-re,R=S}}else if(g<H){if(M+=p+g-H,(H-=g)<Y){for(Y-=H;S[f++]=y[M++],--H;);if(M=0,g<Y){for(Y-=H=g;S[f++]=y[M++],--H;);M=f-re,R=S}}}else if(M+=g-H,H<Y){for(Y-=H;S[f++]=y[M++],--H;);M=f-re,R=S}for(;2<Y;)S[f++]=R[M++],S[f++]=R[M++],S[f++]=R[M++],Y-=3;Y&&(S[f++]=R[M++],1<Y&&(S[f++]=R[M++]))}else{for(M=f-re;S[f++]=S[M++],S[f++]=S[M++],S[f++]=S[M++],2<(Y-=3););Y&&(S[f++]=S[M++],1<Y&&(S[f++]=S[M++]))}break}}break}}while(l<u&&f<d);l-=Y=w>>3,x&=(1<<(w-=Y<<3))-1,r.next_in=l,r.next_out=f,r.avail_in=l<u?u-l+5:5-(l-u),r.avail_out=f<d?d-f+257:257-(f-d),o.hold=x,o.bits=w}},{}],49:[function(t,n,a){var r=t("../utils/common"),s=t("./adler32"),o=t("./crc32"),l=t("./inffast"),u=t("./inftrees"),f=1,c=2,d=0,h=-2,p=1,m=852,g=592;function y(M){return(M>>>24&255)+(M>>>8&65280)+((65280&M)<<8)+((255&M)<<24)}function x(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function w(M){var R;return M&&M.state?(R=M.state,M.total_in=M.total_out=R.total=0,M.msg="",R.wrap&&(M.adler=1&R.wrap),R.mode=p,R.last=0,R.havedict=0,R.dmax=32768,R.head=null,R.hold=0,R.bits=0,R.lencode=R.lendyn=new r.Buf32(m),R.distcode=R.distdyn=new r.Buf32(g),R.sane=1,R.back=-1,d):h}function C(M){var R;return M&&M.state?((R=M.state).wsize=0,R.whave=0,R.wnext=0,w(M)):h}function _(M,R){var v,S;return M&&M.state?(S=M.state,R<0?(v=0,R=-R):(v=1+(R>>4),R<48&&(R&=15)),R&&(R<8||15<R)?h:(S.window!==null&&S.wbits!==R&&(S.window=null),S.wrap=v,S.wbits=R,C(M))):h}function F(M,R){var v,S;return M?(S=new x,(M.state=S).window=null,(v=_(M,R))!==d&&(M.state=null),v):h}var D,O,H=!0;function Y(M){if(H){var R;for(D=new r.Buf32(512),O=new r.Buf32(32),R=0;R<144;)M.lens[R++]=8;for(;R<256;)M.lens[R++]=9;for(;R<280;)M.lens[R++]=7;for(;R<288;)M.lens[R++]=8;for(u(f,M.lens,0,288,D,0,M.work,{bits:9}),R=0;R<32;)M.lens[R++]=5;u(c,M.lens,0,32,O,0,M.work,{bits:5}),H=!1}M.lencode=D,M.lenbits=9,M.distcode=O,M.distbits=5}function re(M,R,v,S){var $,L=M.state;return L.window===null&&(L.wsize=1<<L.wbits,L.wnext=0,L.whave=0,L.window=new r.Buf8(L.wsize)),S>=L.wsize?(r.arraySet(L.window,R,v-L.wsize,L.wsize,0),L.wnext=0,L.whave=L.wsize):(S<($=L.wsize-L.wnext)&&($=S),r.arraySet(L.window,R,v-S,$,L.wnext),(S-=$)?(r.arraySet(L.window,R,v-S,S,0),L.wnext=S,L.whave=L.wsize):(L.wnext+=$,L.wnext===L.wsize&&(L.wnext=0),L.whave<L.wsize&&(L.whave+=$))),0}a.inflateReset=C,a.inflateReset2=_,a.inflateResetKeep=w,a.inflateInit=function(M){return F(M,15)},a.inflateInit2=F,a.inflate=function(M,R){var v,S,$,L,G,V,J,N,P,ae,ne,ee,Me,Ne,_e,ve,Le,Be,st,ot,E,X,q,T,k=0,z=new r.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!M||!M.state||!M.output||!M.input&&M.avail_in!==0)return h;(v=M.state).mode===12&&(v.mode=13),G=M.next_out,$=M.output,J=M.avail_out,L=M.next_in,S=M.input,V=M.avail_in,N=v.hold,P=v.bits,ae=V,ne=J,X=d;e:for(;;)switch(v.mode){case p:if(v.wrap===0){v.mode=13;break}for(;P<16;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(2&v.wrap&&N===35615){z[v.check=0]=255&N,z[1]=N>>>8&255,v.check=o(v.check,z,2,0),P=N=0,v.mode=2;break}if(v.flags=0,v.head&&(v.head.done=!1),!(1&v.wrap)||(((255&N)<<8)+(N>>8))%31){M.msg="incorrect header check",v.mode=30;break}if((15&N)!=8){M.msg="unknown compression method",v.mode=30;break}if(P-=4,E=8+(15&(N>>>=4)),v.wbits===0)v.wbits=E;else if(E>v.wbits){M.msg="invalid window size",v.mode=30;break}v.dmax=1<<E,M.adler=v.check=1,v.mode=512&N?10:12,P=N=0;break;case 2:for(;P<16;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(v.flags=N,(255&v.flags)!=8){M.msg="unknown compression method",v.mode=30;break}if(57344&v.flags){M.msg="unknown header flags set",v.mode=30;break}v.head&&(v.head.text=N>>8&1),512&v.flags&&(z[0]=255&N,z[1]=N>>>8&255,v.check=o(v.check,z,2,0)),P=N=0,v.mode=3;case 3:for(;P<32;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}v.head&&(v.head.time=N),512&v.flags&&(z[0]=255&N,z[1]=N>>>8&255,z[2]=N>>>16&255,z[3]=N>>>24&255,v.check=o(v.check,z,4,0)),P=N=0,v.mode=4;case 4:for(;P<16;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}v.head&&(v.head.xflags=255&N,v.head.os=N>>8),512&v.flags&&(z[0]=255&N,z[1]=N>>>8&255,v.check=o(v.check,z,2,0)),P=N=0,v.mode=5;case 5:if(1024&v.flags){for(;P<16;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}v.length=N,v.head&&(v.head.extra_len=N),512&v.flags&&(z[0]=255&N,z[1]=N>>>8&255,v.check=o(v.check,z,2,0)),P=N=0}else v.head&&(v.head.extra=null);v.mode=6;case 6:if(1024&v.flags&&(V<(ee=v.length)&&(ee=V),ee&&(v.head&&(E=v.head.extra_len-v.length,v.head.extra||(v.head.extra=new Array(v.head.extra_len)),r.arraySet(v.head.extra,S,L,ee,E)),512&v.flags&&(v.check=o(v.check,S,ee,L)),V-=ee,L+=ee,v.length-=ee),v.length))break e;v.length=0,v.mode=7;case 7:if(2048&v.flags){if(V===0)break e;for(ee=0;E=S[L+ee++],v.head&&E&&v.length<65536&&(v.head.name+=String.fromCharCode(E)),E&&ee<V;);if(512&v.flags&&(v.check=o(v.check,S,ee,L)),V-=ee,L+=ee,E)break e}else v.head&&(v.head.name=null);v.length=0,v.mode=8;case 8:if(4096&v.flags){if(V===0)break e;for(ee=0;E=S[L+ee++],v.head&&E&&v.length<65536&&(v.head.comment+=String.fromCharCode(E)),E&&ee<V;);if(512&v.flags&&(v.check=o(v.check,S,ee,L)),V-=ee,L+=ee,E)break e}else v.head&&(v.head.comment=null);v.mode=9;case 9:if(512&v.flags){for(;P<16;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(N!==(65535&v.check)){M.msg="header crc mismatch",v.mode=30;break}P=N=0}v.head&&(v.head.hcrc=v.flags>>9&1,v.head.done=!0),M.adler=v.check=0,v.mode=12;break;case 10:for(;P<32;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}M.adler=v.check=y(N),P=N=0,v.mode=11;case 11:if(v.havedict===0)return M.next_out=G,M.avail_out=J,M.next_in=L,M.avail_in=V,v.hold=N,v.bits=P,2;M.adler=v.check=1,v.mode=12;case 12:if(R===5||R===6)break e;case 13:if(v.last){N>>>=7&P,P-=7&P,v.mode=27;break}for(;P<3;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}switch(v.last=1&N,P-=1,3&(N>>>=1)){case 0:v.mode=14;break;case 1:if(Y(v),v.mode=20,R!==6)break;N>>>=2,P-=2;break e;case 2:v.mode=17;break;case 3:M.msg="invalid block type",v.mode=30}N>>>=2,P-=2;break;case 14:for(N>>>=7&P,P-=7&P;P<32;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if((65535&N)!=(N>>>16^65535)){M.msg="invalid stored block lengths",v.mode=30;break}if(v.length=65535&N,P=N=0,v.mode=15,R===6)break e;case 15:v.mode=16;case 16:if(ee=v.length){if(V<ee&&(ee=V),J<ee&&(ee=J),ee===0)break e;r.arraySet($,S,L,ee,G),V-=ee,L+=ee,J-=ee,G+=ee,v.length-=ee;break}v.mode=12;break;case 17:for(;P<14;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(v.nlen=257+(31&N),N>>>=5,P-=5,v.ndist=1+(31&N),N>>>=5,P-=5,v.ncode=4+(15&N),N>>>=4,P-=4,286<v.nlen||30<v.ndist){M.msg="too many length or distance symbols",v.mode=30;break}v.have=0,v.mode=18;case 18:for(;v.have<v.ncode;){for(;P<3;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}v.lens[j[v.have++]]=7&N,N>>>=3,P-=3}for(;v.have<19;)v.lens[j[v.have++]]=0;if(v.lencode=v.lendyn,v.lenbits=7,q={bits:v.lenbits},X=u(0,v.lens,0,19,v.lencode,0,v.work,q),v.lenbits=q.bits,X){M.msg="invalid code lengths set",v.mode=30;break}v.have=0,v.mode=19;case 19:for(;v.have<v.nlen+v.ndist;){for(;ve=(k=v.lencode[N&(1<<v.lenbits)-1])>>>16&255,Le=65535&k,!((_e=k>>>24)<=P);){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(Le<16)N>>>=_e,P-=_e,v.lens[v.have++]=Le;else{if(Le===16){for(T=_e+2;P<T;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(N>>>=_e,P-=_e,v.have===0){M.msg="invalid bit length repeat",v.mode=30;break}E=v.lens[v.have-1],ee=3+(3&N),N>>>=2,P-=2}else if(Le===17){for(T=_e+3;P<T;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}P-=_e,E=0,ee=3+(7&(N>>>=_e)),N>>>=3,P-=3}else{for(T=_e+7;P<T;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}P-=_e,E=0,ee=11+(127&(N>>>=_e)),N>>>=7,P-=7}if(v.have+ee>v.nlen+v.ndist){M.msg="invalid bit length repeat",v.mode=30;break}for(;ee--;)v.lens[v.have++]=E}}if(v.mode===30)break;if(v.lens[256]===0){M.msg="invalid code -- missing end-of-block",v.mode=30;break}if(v.lenbits=9,q={bits:v.lenbits},X=u(f,v.lens,0,v.nlen,v.lencode,0,v.work,q),v.lenbits=q.bits,X){M.msg="invalid literal/lengths set",v.mode=30;break}if(v.distbits=6,v.distcode=v.distdyn,q={bits:v.distbits},X=u(c,v.lens,v.nlen,v.ndist,v.distcode,0,v.work,q),v.distbits=q.bits,X){M.msg="invalid distances set",v.mode=30;break}if(v.mode=20,R===6)break e;case 20:v.mode=21;case 21:if(6<=V&&258<=J){M.next_out=G,M.avail_out=J,M.next_in=L,M.avail_in=V,v.hold=N,v.bits=P,l(M,ne),G=M.next_out,$=M.output,J=M.avail_out,L=M.next_in,S=M.input,V=M.avail_in,N=v.hold,P=v.bits,v.mode===12&&(v.back=-1);break}for(v.back=0;ve=(k=v.lencode[N&(1<<v.lenbits)-1])>>>16&255,Le=65535&k,!((_e=k>>>24)<=P);){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(ve&&(240&ve)==0){for(Be=_e,st=ve,ot=Le;ve=(k=v.lencode[ot+((N&(1<<Be+st)-1)>>Be)])>>>16&255,Le=65535&k,!(Be+(_e=k>>>24)<=P);){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}N>>>=Be,P-=Be,v.back+=Be}if(N>>>=_e,P-=_e,v.back+=_e,v.length=Le,ve===0){v.mode=26;break}if(32&ve){v.back=-1,v.mode=12;break}if(64&ve){M.msg="invalid literal/length code",v.mode=30;break}v.extra=15&ve,v.mode=22;case 22:if(v.extra){for(T=v.extra;P<T;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}v.length+=N&(1<<v.extra)-1,N>>>=v.extra,P-=v.extra,v.back+=v.extra}v.was=v.length,v.mode=23;case 23:for(;ve=(k=v.distcode[N&(1<<v.distbits)-1])>>>16&255,Le=65535&k,!((_e=k>>>24)<=P);){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if((240&ve)==0){for(Be=_e,st=ve,ot=Le;ve=(k=v.distcode[ot+((N&(1<<Be+st)-1)>>Be)])>>>16&255,Le=65535&k,!(Be+(_e=k>>>24)<=P);){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}N>>>=Be,P-=Be,v.back+=Be}if(N>>>=_e,P-=_e,v.back+=_e,64&ve){M.msg="invalid distance code",v.mode=30;break}v.offset=Le,v.extra=15&ve,v.mode=24;case 24:if(v.extra){for(T=v.extra;P<T;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}v.offset+=N&(1<<v.extra)-1,N>>>=v.extra,P-=v.extra,v.back+=v.extra}if(v.offset>v.dmax){M.msg="invalid distance too far back",v.mode=30;break}v.mode=25;case 25:if(J===0)break e;if(ee=ne-J,v.offset>ee){if((ee=v.offset-ee)>v.whave&&v.sane){M.msg="invalid distance too far back",v.mode=30;break}Me=ee>v.wnext?(ee-=v.wnext,v.wsize-ee):v.wnext-ee,ee>v.length&&(ee=v.length),Ne=v.window}else Ne=$,Me=G-v.offset,ee=v.length;for(J<ee&&(ee=J),J-=ee,v.length-=ee;$[G++]=Ne[Me++],--ee;);v.length===0&&(v.mode=21);break;case 26:if(J===0)break e;$[G++]=v.length,J--,v.mode=21;break;case 27:if(v.wrap){for(;P<32;){if(V===0)break e;V--,N|=S[L++]<<P,P+=8}if(ne-=J,M.total_out+=ne,v.total+=ne,ne&&(M.adler=v.check=v.flags?o(v.check,$,ne,G-ne):s(v.check,$,ne,G-ne)),ne=J,(v.flags?N:y(N))!==v.check){M.msg="incorrect data check",v.mode=30;break}P=N=0}v.mode=28;case 28:if(v.wrap&&v.flags){for(;P<32;){if(V===0)break e;V--,N+=S[L++]<<P,P+=8}if(N!==(4294967295&v.total)){M.msg="incorrect length check",v.mode=30;break}P=N=0}v.mode=29;case 29:X=1;break e;case 30:X=-3;break e;case 31:return-4;case 32:default:return h}return M.next_out=G,M.avail_out=J,M.next_in=L,M.avail_in=V,v.hold=N,v.bits=P,(v.wsize||ne!==M.avail_out&&v.mode<30&&(v.mode<27||R!==4))&&re(M,M.output,M.next_out,ne-M.avail_out)?(v.mode=31,-4):(ae-=M.avail_in,ne-=M.avail_out,M.total_in+=ae,M.total_out+=ne,v.total+=ne,v.wrap&&ne&&(M.adler=v.check=v.flags?o(v.check,$,ne,M.next_out-ne):s(v.check,$,ne,M.next_out-ne)),M.data_type=v.bits+(v.last?64:0)+(v.mode===12?128:0)+(v.mode===20||v.mode===15?256:0),(ae==0&&ne===0||R===4)&&X===d&&(X=-5),X)},a.inflateEnd=function(M){if(!M||!M.state)return h;var R=M.state;return R.window&&(R.window=null),M.state=null,d},a.inflateGetHeader=function(M,R){var v;return M&&M.state?(2&(v=M.state).wrap)==0?h:((v.head=R).done=!1,d):h},a.inflateSetDictionary=function(M,R){var v,S=R.length;return M&&M.state?(v=M.state).wrap!==0&&v.mode!==11?h:v.mode===11&&s(1,R,S,0)!==v.check?-3:re(M,R,S,S)?(v.mode=31,-4):(v.havedict=1,d):h},a.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,n,a){var r=t("../utils/common"),s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],u=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];n.exports=function(f,c,d,h,p,m,g,y){var x,w,C,_,F,D,O,H,Y,re=y.bits,M=0,R=0,v=0,S=0,$=0,L=0,G=0,V=0,J=0,N=0,P=null,ae=0,ne=new r.Buf16(16),ee=new r.Buf16(16),Me=null,Ne=0;for(M=0;M<=15;M++)ne[M]=0;for(R=0;R<h;R++)ne[c[d+R]]++;for($=re,S=15;1<=S&&ne[S]===0;S--);if(S<$&&($=S),S===0)return p[m++]=20971520,p[m++]=20971520,y.bits=1,0;for(v=1;v<S&&ne[v]===0;v++);for($<v&&($=v),M=V=1;M<=15;M++)if(V<<=1,(V-=ne[M])<0)return-1;if(0<V&&(f===0||S!==1))return-1;for(ee[1]=0,M=1;M<15;M++)ee[M+1]=ee[M]+ne[M];for(R=0;R<h;R++)c[d+R]!==0&&(g[ee[c[d+R]]++]=R);if(D=f===0?(P=Me=g,19):f===1?(P=s,ae-=257,Me=o,Ne-=257,256):(P=l,Me=u,-1),M=v,F=m,G=R=N=0,C=-1,_=(J=1<<(L=$))-1,f===1&&852<J||f===2&&592<J)return 1;for(;;){for(O=M-G,Y=g[R]<D?(H=0,g[R]):g[R]>D?(H=Me[Ne+g[R]],P[ae+g[R]]):(H=96,0),x=1<<M-G,v=w=1<<L;p[F+(N>>G)+(w-=x)]=O<<24|H<<16|Y|0,w!==0;);for(x=1<<M-1;N&x;)x>>=1;if(x!==0?(N&=x-1,N+=x):N=0,R++,--ne[M]==0){if(M===S)break;M=c[d+g[R]]}if($<M&&(N&_)!==C){for(G===0&&(G=$),F+=v,V=1<<(L=M-G);L+G<S&&!((V-=ne[L+G])<=0);)L++,V<<=1;if(J+=1<<L,f===1&&852<J||f===2&&592<J)return 1;p[C=N&_]=$<<24|L<<16|F-m|0}}return N!==0&&(p[F+N]=M-G<<24|64<<16|0),y.bits=$,0}},{"../utils/common":41}],51:[function(t,n,a){n.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,n,a){var r=t("../utils/common"),s=0,o=1;function l(k){for(var z=k.length;0<=--z;)k[z]=0}var u=0,f=29,c=256,d=c+1+f,h=30,p=19,m=2*d+1,g=15,y=16,x=7,w=256,C=16,_=17,F=18,D=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],O=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],H=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Y=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],re=new Array(2*(d+2));l(re);var M=new Array(2*h);l(M);var R=new Array(512);l(R);var v=new Array(256);l(v);var S=new Array(f);l(S);var $,L,G,V=new Array(h);function J(k,z,j,Q,U){this.static_tree=k,this.extra_bits=z,this.extra_base=j,this.elems=Q,this.max_length=U,this.has_stree=k&&k.length}function N(k,z){this.dyn_tree=k,this.max_code=0,this.stat_desc=z}function P(k){return k<256?R[k]:R[256+(k>>>7)]}function ae(k,z){k.pending_buf[k.pending++]=255&z,k.pending_buf[k.pending++]=z>>>8&255}function ne(k,z,j){k.bi_valid>y-j?(k.bi_buf|=z<<k.bi_valid&65535,ae(k,k.bi_buf),k.bi_buf=z>>y-k.bi_valid,k.bi_valid+=j-y):(k.bi_buf|=z<<k.bi_valid&65535,k.bi_valid+=j)}function ee(k,z,j){ne(k,j[2*z],j[2*z+1])}function Me(k,z){for(var j=0;j|=1&k,k>>>=1,j<<=1,0<--z;);return j>>>1}function Ne(k,z,j){var Q,U,oe=new Array(g+1),ue=0;for(Q=1;Q<=g;Q++)oe[Q]=ue=ue+j[Q-1]<<1;for(U=0;U<=z;U++){var le=k[2*U+1];le!==0&&(k[2*U]=Me(oe[le]++,le))}}function _e(k){var z;for(z=0;z<d;z++)k.dyn_ltree[2*z]=0;for(z=0;z<h;z++)k.dyn_dtree[2*z]=0;for(z=0;z<p;z++)k.bl_tree[2*z]=0;k.dyn_ltree[2*w]=1,k.opt_len=k.static_len=0,k.last_lit=k.matches=0}function ve(k){8<k.bi_valid?ae(k,k.bi_buf):0<k.bi_valid&&(k.pending_buf[k.pending++]=k.bi_buf),k.bi_buf=0,k.bi_valid=0}function Le(k,z,j,Q){var U=2*z,oe=2*j;return k[U]<k[oe]||k[U]===k[oe]&&Q[z]<=Q[j]}function Be(k,z,j){for(var Q=k.heap[j],U=j<<1;U<=k.heap_len&&(U<k.heap_len&&Le(z,k.heap[U+1],k.heap[U],k.depth)&&U++,!Le(z,Q,k.heap[U],k.depth));)k.heap[j]=k.heap[U],j=U,U<<=1;k.heap[j]=Q}function st(k,z,j){var Q,U,oe,ue,le=0;if(k.last_lit!==0)for(;Q=k.pending_buf[k.d_buf+2*le]<<8|k.pending_buf[k.d_buf+2*le+1],U=k.pending_buf[k.l_buf+le],le++,Q===0?ee(k,U,z):(ee(k,(oe=v[U])+c+1,z),(ue=D[oe])!==0&&ne(k,U-=S[oe],ue),ee(k,oe=P(--Q),j),(ue=O[oe])!==0&&ne(k,Q-=V[oe],ue)),le<k.last_lit;);ee(k,w,z)}function ot(k,z){var j,Q,U,oe=z.dyn_tree,ue=z.stat_desc.static_tree,le=z.stat_desc.has_stree,we=z.stat_desc.elems,Ge=-1;for(k.heap_len=0,k.heap_max=m,j=0;j<we;j++)oe[2*j]!==0?(k.heap[++k.heap_len]=Ge=j,k.depth[j]=0):oe[2*j+1]=0;for(;k.heap_len<2;)oe[2*(U=k.heap[++k.heap_len]=Ge<2?++Ge:0)]=1,k.depth[U]=0,k.opt_len--,le&&(k.static_len-=ue[2*U+1]);for(z.max_code=Ge,j=k.heap_len>>1;1<=j;j--)Be(k,oe,j);for(U=we;j=k.heap[1],k.heap[1]=k.heap[k.heap_len--],Be(k,oe,1),Q=k.heap[1],k.heap[--k.heap_max]=j,k.heap[--k.heap_max]=Q,oe[2*U]=oe[2*j]+oe[2*Q],k.depth[U]=(k.depth[j]>=k.depth[Q]?k.depth[j]:k.depth[Q])+1,oe[2*j+1]=oe[2*Q+1]=U,k.heap[1]=U++,Be(k,oe,1),2<=k.heap_len;);k.heap[--k.heap_max]=k.heap[1],function(De,Ct){var St,Dt,A,I,te,Z,se=Ct.dyn_tree,pe=Ct.max_code,Ee=Ct.stat_desc.static_tree,Re=Ct.stat_desc.has_stree,He=Ct.stat_desc.extra_bits,Je=Ct.stat_desc.extra_base,qe=Ct.stat_desc.max_length,ut=0;for(I=0;I<=g;I++)De.bl_count[I]=0;for(se[2*De.heap[De.heap_max]+1]=0,St=De.heap_max+1;St<m;St++)qe<(I=se[2*se[2*(Dt=De.heap[St])+1]+1]+1)&&(I=qe,ut++),se[2*Dt+1]=I,pe<Dt||(De.bl_count[I]++,te=0,Je<=Dt&&(te=He[Dt-Je]),Z=se[2*Dt],De.opt_len+=Z*(I+te),Re&&(De.static_len+=Z*(Ee[2*Dt+1]+te)));if(ut!==0){do{for(I=qe-1;De.bl_count[I]===0;)I--;De.bl_count[I]--,De.bl_count[I+1]+=2,De.bl_count[qe]--,ut-=2}while(0<ut);for(I=qe;I!==0;I--)for(Dt=De.bl_count[I];Dt!==0;)pe<(A=De.heap[--St])||(se[2*A+1]!==I&&(De.opt_len+=(I-se[2*A+1])*se[2*A],se[2*A+1]=I),Dt--)}}(k,z),Ne(oe,Ge,k.bl_count)}function E(k,z,j){var Q,U,oe=-1,ue=z[1],le=0,we=7,Ge=4;for(ue===0&&(we=138,Ge=3),z[2*(j+1)+1]=65535,Q=0;Q<=j;Q++)U=ue,ue=z[2*(Q+1)+1],++le<we&&U===ue||(le<Ge?k.bl_tree[2*U]+=le:U!==0?(U!==oe&&k.bl_tree[2*U]++,k.bl_tree[2*C]++):le<=10?k.bl_tree[2*_]++:k.bl_tree[2*F]++,oe=U,Ge=(le=0)===ue?(we=138,3):U===ue?(we=6,3):(we=7,4))}function X(k,z,j){var Q,U,oe=-1,ue=z[1],le=0,we=7,Ge=4;for(ue===0&&(we=138,Ge=3),Q=0;Q<=j;Q++)if(U=ue,ue=z[2*(Q+1)+1],!(++le<we&&U===ue)){if(le<Ge)for(;ee(k,U,k.bl_tree),--le!=0;);else U!==0?(U!==oe&&(ee(k,U,k.bl_tree),le--),ee(k,C,k.bl_tree),ne(k,le-3,2)):le<=10?(ee(k,_,k.bl_tree),ne(k,le-3,3)):(ee(k,F,k.bl_tree),ne(k,le-11,7));oe=U,Ge=(le=0)===ue?(we=138,3):U===ue?(we=6,3):(we=7,4)}}l(V);var q=!1;function T(k,z,j,Q){ne(k,(u<<1)+(Q?1:0),3),function(U,oe,ue,le){ve(U),ae(U,ue),ae(U,~ue),r.arraySet(U.pending_buf,U.window,oe,ue,U.pending),U.pending+=ue}(k,z,j)}a._tr_init=function(k){q||(function(){var z,j,Q,U,oe,ue=new Array(g+1);for(U=Q=0;U<f-1;U++)for(S[U]=Q,z=0;z<1<<D[U];z++)v[Q++]=U;for(v[Q-1]=U,U=oe=0;U<16;U++)for(V[U]=oe,z=0;z<1<<O[U];z++)R[oe++]=U;for(oe>>=7;U<h;U++)for(V[U]=oe<<7,z=0;z<1<<O[U]-7;z++)R[256+oe++]=U;for(j=0;j<=g;j++)ue[j]=0;for(z=0;z<=143;)re[2*z+1]=8,z++,ue[8]++;for(;z<=255;)re[2*z+1]=9,z++,ue[9]++;for(;z<=279;)re[2*z+1]=7,z++,ue[7]++;for(;z<=287;)re[2*z+1]=8,z++,ue[8]++;for(Ne(re,d+1,ue),z=0;z<h;z++)M[2*z+1]=5,M[2*z]=Me(z,5);$=new J(re,D,c+1,d,g),L=new J(M,O,0,h,g),G=new J(new Array(0),H,0,p,x)}(),q=!0),k.l_desc=new N(k.dyn_ltree,$),k.d_desc=new N(k.dyn_dtree,L),k.bl_desc=new N(k.bl_tree,G),k.bi_buf=0,k.bi_valid=0,_e(k)},a._tr_stored_block=T,a._tr_flush_block=function(k,z,j,Q){var U,oe,ue=0;0<k.level?(k.strm.data_type===2&&(k.strm.data_type=function(le){var we,Ge=4093624447;for(we=0;we<=31;we++,Ge>>>=1)if(1&Ge&&le.dyn_ltree[2*we]!==0)return s;if(le.dyn_ltree[18]!==0||le.dyn_ltree[20]!==0||le.dyn_ltree[26]!==0)return o;for(we=32;we<c;we++)if(le.dyn_ltree[2*we]!==0)return o;return s}(k)),ot(k,k.l_desc),ot(k,k.d_desc),ue=function(le){var we;for(E(le,le.dyn_ltree,le.l_desc.max_code),E(le,le.dyn_dtree,le.d_desc.max_code),ot(le,le.bl_desc),we=p-1;3<=we&&le.bl_tree[2*Y[we]+1]===0;we--);return le.opt_len+=3*(we+1)+5+5+4,we}(k),U=k.opt_len+3+7>>>3,(oe=k.static_len+3+7>>>3)<=U&&(U=oe)):U=oe=j+5,j+4<=U&&z!==-1?T(k,z,j,Q):k.strategy===4||oe===U?(ne(k,2+(Q?1:0),3),st(k,re,M)):(ne(k,4+(Q?1:0),3),function(le,we,Ge,De){var Ct;for(ne(le,we-257,5),ne(le,Ge-1,5),ne(le,De-4,4),Ct=0;Ct<De;Ct++)ne(le,le.bl_tree[2*Y[Ct]+1],3);X(le,le.dyn_ltree,we-1),X(le,le.dyn_dtree,Ge-1)}(k,k.l_desc.max_code+1,k.d_desc.max_code+1,ue+1),st(k,k.dyn_ltree,k.dyn_dtree)),_e(k),Q&&ve(k)},a._tr_tally=function(k,z,j){return k.pending_buf[k.d_buf+2*k.last_lit]=z>>>8&255,k.pending_buf[k.d_buf+2*k.last_lit+1]=255&z,k.pending_buf[k.l_buf+k.last_lit]=255&j,k.last_lit++,z===0?k.dyn_ltree[2*j]++:(k.matches++,z--,k.dyn_ltree[2*(v[j]+c+1)]++,k.dyn_dtree[2*P(z)]++),k.last_lit===k.lit_bufsize-1},a._tr_align=function(k){ne(k,2,3),ee(k,w,re),function(z){z.bi_valid===16?(ae(z,z.bi_buf),z.bi_buf=0,z.bi_valid=0):8<=z.bi_valid&&(z.pending_buf[z.pending++]=255&z.bi_buf,z.bi_buf>>=8,z.bi_valid-=8)}(k)}},{"../utils/common":41}],53:[function(t,n,a){n.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,n,a){(function(r){(function(s,o){if(!s.setImmediate){var l,u,f,c,d=1,h={},p=!1,m=s.document,g=Object.getPrototypeOf&&Object.getPrototypeOf(s);g=g&&g.setTimeout?g:s,l={}.toString.call(s.process)==="[object process]"?function(C){process.nextTick(function(){x(C)})}:function(){if(s.postMessage&&!s.importScripts){var C=!0,_=s.onmessage;return s.onmessage=function(){C=!1},s.postMessage("","*"),s.onmessage=_,C}}()?(c="setImmediate$"+Math.random()+"$",s.addEventListener?s.addEventListener("message",w,!1):s.attachEvent("onmessage",w),function(C){s.postMessage(c+C,"*")}):s.MessageChannel?((f=new MessageChannel).port1.onmessage=function(C){x(C.data)},function(C){f.port2.postMessage(C)}):m&&"onreadystatechange"in m.createElement("script")?(u=m.documentElement,function(C){var _=m.createElement("script");_.onreadystatechange=function(){x(C),_.onreadystatechange=null,u.removeChild(_),_=null},u.appendChild(_)}):function(C){setTimeout(x,0,C)},g.setImmediate=function(C){typeof C!="function"&&(C=new Function(""+C));for(var _=new Array(arguments.length-1),F=0;F<_.length;F++)_[F]=arguments[F+1];var D={callback:C,args:_};return h[d]=D,l(d),d++},g.clearImmediate=y}function y(C){delete h[C]}function x(C){if(p)setTimeout(x,0,C);else{var _=h[C];if(_){p=!0;try{(function(F){var D=F.callback,O=F.args;switch(O.length){case 0:D();break;case 1:D(O[0]);break;case 2:D(O[0],O[1]);break;case 3:D(O[0],O[1],O[2]);break;default:D.apply(o,O)}})(_)}finally{y(C),p=!1}}}}function w(C){C.source===s&&typeof C.data=="string"&&C.data.indexOf(c)===0&&x(+C.data.slice(c.length))}})(typeof self>"u"?r===void 0?this:r:self)}).call(this,typeof vi<"u"?vi:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})}(ws)),ws.exports}var nm=im();const am=oa(nm);class rm{static worker=new Worker(new URL("/smeditor/assets/SafariFileWorker-C6T6cial.js",import.meta.url),{type:"module"});static workID=0;static map=new Map;static{this.worker.onmessage=e=>{const t=e.data;t.success?this.map.get(t.id)[0]():this.map.get(t.id)[1](t.reason),this.map.delete(t.id)}}static async writeHandle(e,t){const n=this.workID++,a=new Promise((o,l)=>this.map.set(n,[o,l])),r=new TextEncoder,s=typeof t=="string"?r.encode(t).buffer:await t.arrayBuffer();return this.worker.postMessage([n,e,s],[s]),a}}class sm{_root;async getRoot(){return this._root||(Z0.adapter.native?await cc().then(e=>this._root=e):await cc(We(()=>import("./memory-CkG79_WJ.js"),__vite__mapDeps([0,1,2]))).then(e=>this._root=e)),this._root}async uploadHandle(e,t){let n;if(typeof t=="string"){const a=await this.getDirectoryHandle(t,{create:!0});if(!a)return;n=a}else n=t??await this.getRoot();if(e.kind=="file"){const a=await n.getFileHandle(e.name,{create:!0});await this.writeFile(a,await e.getFile())}else{const a=await n.getDirectoryHandle(e.name,{create:!0}),r=[];for await(const s of e.values())r.push(this.uploadHandle(s,a));await Promise.all(r)}}async uploadFiles(e,t){let n;if(typeof t=="string"){const a=await this.getDirectoryHandle(t,{create:!0});if(!a)return;n=a}else n=t??await this.getRoot();if(e.isFile){const a=e;if(a.name==".DS_Store")return;a.file(async r=>{const s=await n.getFileHandle(r.name,{create:!0});await this.writeHandle(s,r)})}else if(e.isDirectory){const a=e.createReader(),r=await n.getDirectoryHandle(e.name,{create:!0});for await(const s of r.values())await r.removeEntry(s.name,{recursive:!0});a.readEntries(async s=>{const o=[];for(let l=0;l<s.length;l++)o.push(this.uploadFiles(s[l],r));await Promise.all(o)})}}async handleDropEvent(e,t){e.stopPropagation(),e.preventDefault();const n=e.dataTransfer.items;if(!t){t="";for(let s=0;s<n.length;s++){const o=n[s].webkitGetAsEntry();if(o?.isFile&&(o.name.endsWith(".sm")||o.name.endsWith(".ssc"))){t="New Song";break}}}const a=[];for(let s=0;s<n.length;s++){const o=n[s].webkitGetAsEntry();o&&a.push(this.uploadFiles(o,t))}let r;return n.length==1&&n[0].webkitGetAsEntry().isDirectory&&(r=n[0].webkitGetAsEntry().name),await Promise.all(a),r}async uploadDir(e,t){let n;if(typeof t=="string"){const r=await this.getDirectoryHandle(t);if(!r)return;n=r}else n=t??await this.getRoot();const a=await n.getDirectoryHandle(e.name,{create:!0});for await(const r of e.values())if(r.kind=="file"){const s=await a.getFileHandle(r.name,{create:!0}),o=await r.getFile();await this.writeHandle(s,o)}else await this.uploadDir(r,a)}async getDirectoryHandle(e,t,n){if(n||=await this.getRoot(),e=this.resolvePath(...e.split("/")),e==""||e==".")return n;const a=e.split("/"),r=a.shift();try{const s=await n.getDirectoryHandle(r,t);return s?a.length==0?s:this.getDirectoryHandle(a.join("/"),t,s):void 0}catch(s){console.error(`Failed to get directory ${e} (${r}): `+s);return}}async hasFile(e){try{return await this.getFileHandle(e)!==void 0}catch{return!1}}async getFileHandle(e,t){try{const n=this.resolvePath(...e.split("/")).split("/"),a=n.pop(),r=await this.getDirectoryHandle(n.join("/"),t);return r?await r.getFileHandle(a,t):void 0}catch(n){console.error("Failed to get file "+e+": "+n);return}}async getFileHandleRelativeTo(e,t){try{return At(e)!=""&&(e=at(e)),this.getFileHandle(this.resolvePath(e,"/",t))}catch(n){console.error("Failed to get relative file "+t+": "+n);return}}async getDirectoryFiles(e){try{let t;if(typeof e=="string"){if(t=await this.getDirectoryHandle(e),!t)return[]}else t=e;const n=[];for await(const a of t.values())a.kind=="file"&&n.push(a);return n}catch(t){return console.error(t),[]}}async getDirectoryFolders(e){try{let t;if(typeof e=="string"){if(t=await this.getDirectoryHandle(e),!t)return[]}else t=e;const n=[];for await(const a of t.values())a.kind=="directory"&&n.push(a);return n}catch(t){return console.error(t),[]}}async writeFile(e,t){let n;if(typeof e=="string"){if(n=await this.getFileHandle(e,{create:!0}),!n){ce.createFormatted("Failed to write to "+e+"!","error");return}}else n=e;await this.writeHandle(n,t)}async removeFile(e,t){try{const n=at(e),a=await this.getDirectoryHandle(n);if(!a)return;await a.removeEntry(Tt(e),t)}catch(n){console.error(n);return}}async removeDirectory(e){return this.removeFile(e,{recursive:!0})}async remove(e){return At(e)==""?this.removeDirectory(e):this.removeFile(e)}resolvePath(...e){let t=e;for(t=t.filter(n=>n!="."&&n!="");t.indexOf("..")>-1;){const n=t.indexOf("..");if(n==0)throw Error("Path "+t.join("/")+" is invalid!");t.splice(n-1,2)}return t.join("/")}async zipDirectory(e,t){const n=t??new am,a=At(e)==""?e:at(e),r=await this.getDirectoryHandle(a);if(r){for(const s of await this.getDirectoryFiles(r))n.file(s.name,await s.getFile());for(const s of await this.getDirectoryFolders(r)){const o=n.folder(s.name);if(!o){console.error("Failed to zip folder "+a+"/"+s.name);continue}await this.zipDirectory(a+"/"+s.name,o)}return n}}async saveDirectory(e){const t=At(e)==""?e:at(e);ce.create("Exporting "+t+".zip");const n=await K0({_preferPolyfill:!1,suggestedName:`${t}.zip`,types:[{accept:{"application/zip":[".zip"]}}],excludeAcceptAllOption:!1}),a=await this.zipDirectory(e);a&&await a.generateAsync({type:"blob"}).then(async r=>{if(!window.showSaveFilePicker){console.log(r);const s=document.createElement("a"),o=URL.createObjectURL(r);document.body.appendChild(s),s.href=o,s.download=t+".zip",s.click(),s.remove(),window.URL.revokeObjectURL(o);return}await this.writeHandle(n,r)})}async renameFile(e,t){if(e!=t)try{const n=await this.getDirectoryHandle(at(e)),a=await this.getDirectoryHandle(at(t),{create:!0}),r=await this.getFileHandle(e);if(!n||!a||!r)return;await this.copyToHandle(a,r,Tt(t)),await n.removeEntry(Tt(e))}catch(n){console.error(n)}}async renameDirectory(e,t){if(!t.startsWith(e))try{const n=await this.getDirectoryHandle(at(e)),a=await this.getDirectoryHandle(at(t),{create:!0}),r=await this.getDirectoryHandle(e);if(!n||!a||!r)return;await this.copyToHandle(a,r,Tt(t)),await n.removeEntry(Tt(e),{recursive:!0})}catch(n){console.error(n)}}async copyToHandle(e,t,n){try{if(t.kind=="directory"){const a=await e.getDirectoryHandle(n??t.name,{create:!0}),r=[];for await(const s of t.values())r.push(this.copyToHandle(a,s));await Promise.all(r)}else{const a=await t.getFile(),r=await e.getFileHandle(n??t.name,{create:!0});await this.writeHandle(r,a)}}catch(a){console.error(a)}}getRelativePath(e,t){const n=e.split("/"),a=t.split("/"),r=Math.min(n.length,a.length);let s=r;for(let l=0;l<r;l++)if(n[l]!==a[l]){s=l;break}if(s==0)return t;let o=[];for(let l=s;l<n.length;l++)o.push("..");return o=o.concat(a.slice(s)),o.join("/")}async writeHandle(e,t){if(e.createWritable){const n=await e.createWritable();await n.write(t),await n.close()}else{const n=await(await this.getRoot()).resolve(e);if(!n)return;await rm.writeHandle(n.join("/"),t)}}}class Ce{static standardHandler;static urlHandler;static async initFileSystem(){this.urlHandler=new tm,this.standardHandler=window.nw?new(await We(async()=>{const{NodeFileHandler:e}=await import("./NodeFileHandler-BDo-fICb.js");return{NodeFileHandler:e}},__vite__mapDeps([6,1,2]))).NodeFileHandler:new sm}static getStandardHandler(){return this.standardHandler}static getHandler(e){return e!==void 0&&e.startsWith("https://")||e?.startsWith("http://")?this.urlHandler:this.standardHandler}static handleDropEvent(e,t){return this.getHandler().handleDropEvent(e,t)}static getDirectoryHandle(e,t){return Ce.getHandler(e).getDirectoryHandle(e,t)}static hasFile(e){return Ce.getHandler(e).hasFile(e)}static getFileHandle(e,t){return Ce.getHandler(e).getFileHandle(e,t)}static getFileHandleRelativeTo(e,t){return Ce.getHandler(e).getFileHandleRelativeTo(e,t)}static getDirectoryFiles(e){return Ce.getHandler(typeof e=="string"?e:void 0).getDirectoryFiles(e)}static getDirectoryFolders(e){return Ce.getHandler(typeof e=="string"?e:void 0).getDirectoryFolders(e)}static writeFile(e,t){return Ce.getHandler(typeof e=="string"?e:void 0).writeFile(e,t)}static removeFile(e){return Ce.getHandler(e).removeFile(e)}static getRelativePath(e,t){return Ce.getHandler().getRelativePath(e,t)}}class or extends ct{app;dirOptions;fileDropPath="";draggedElement;draggedCopy;keyHandler;dropHandler;mouseHandler;dragHandler;constructor(e,t,n){super({title:t.title,width:500,height:400,disableClose:t.disableClose,win_id:"file_selector"+Math.random(),blocking:!0}),this.app=e,this.dirOptions=t,t.accepted_file_types||=[],this.keyHandler=this.handleKeyEvent.bind(this),this.dropHandler=this.handleDropEvent.bind(this),this.mouseHandler=this.handleMouseEvent.bind(this),this.dragHandler=this.handleDragEvent.bind(this),this.initView().then(()=>{n&&this.selectPath(n),t.onload?.()})}async initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("menu-options");const n=document.createElement("div");n.classList.add("menu-left");const a=document.createElement("div");a.classList.add("menu-right"),t.appendChild(n),t.appendChild(a);const r=document.createElement("button");r.innerText="Cancel",r.onclick=()=>{window.removeEventListener("keydown",this.keyHandler,!0),window.removeEventListener("drop",this.dropHandler,!0),this.closeWindow()};const s=document.createElement("button");s.innerText="Select",s.classList.add("confirm"),s.onclick=()=>this.confirmFile(),s.disabled=!0,n.appendChild(r),a.appendChild(s);const o=document.createElement("div");o.classList.add("dir-selector"),o.onclick=y=>{y.target==o&&this.selectElement(void 0)};const l=document.createElement("div");l.classList.add("file-options");const u=document.createElement("button"),f=be.getIcon("ADD_FILE",16);u.appendChild(f),u.appendChild(document.createTextNode("Upload files")),l.appendChild(u),u.onclick=async()=>{const y=this.fileDropPath,x=await Uu({_preferPolyfill:!0,excludeAcceptAllOption:!1,multiple:!0}),C=this.viewElement.querySelector(".info.selected")?.dataset.path??"",_=[];for(const F of x)_.push(Ce.getStandardHandler().uploadHandle(F,C));await Promise.all(_),await this.refreshDirectory(y),this.getAcceptableFile(y).then(F=>this.selectPath(F))};const c=document.createElement("button"),d=be.getIcon("FOLDER",16);c.appendChild(d),c.appendChild(document.createTextNode("Upload folder")),l.appendChild(c),c.onclick=async()=>{const y=this.fileDropPath,x=await Y0({_preferPolyfill:!0}),C=this.viewElement.querySelector(".info.selected")?.dataset.path??"";await Ce.getStandardHandler().uploadHandle(x,C),await this.refreshDirectory(y),this.getAcceptableFile(y==""?x.name:y+"/"+x.name).then(_=>this.selectPath(_))};const h=document.createElement("button");h.classList.add("rename");const p=be.getIcon("EDIT",16);h.appendChild(p),h.appendChild(document.createTextNode("Rename")),h.disabled=!0,h.onclick=()=>{const y=this.viewElement.querySelector(".info.selected");y?.dataset.path&&this.startEditing(y.querySelector("textarea"))},l.appendChild(h);const m=document.createElement("button");m.classList.add("delete");const g=be.getIcon("TRASH",16);m.appendChild(g),m.appendChild(document.createTextNode("Delete")),m.disabled=!0,m.onclick=()=>{const y=this.viewElement.querySelector(".info.selected"),x=y?.dataset.path;if(!x)return;const w=y.parentElement.classList.contains("folder");Ce.getStandardHandler()[w?"removeDirectory":"removeFile"](x).then(()=>{const C=this.getElement(x);C&&(C.parentElement?.remove(),m.disabled=!0,h.disabled=!0)})},l.appendChild(m),e.appendChild(o),e.appendChild(l),e.appendChild(t),this.viewElement.appendChild(e),window.addEventListener("keydown",this.keyHandler,!0),window.addEventListener("drop",this.dropHandler,!0),window.addEventListener("mousemove",this.dragHandler,!0),this.viewElement.addEventListener("dragover",this.mouseHandler),await this.createDiv("").then(y=>o.replaceChildren(...y))}async expand(e){if(!e.parentElement.classList.contains("folder"))return;e.parentElement.classList.remove("collapsed");const t=e.nextSibling;await this.createDiv(e.dataset.path).then(n=>{t.replaceChildren(...n)})}collapse(e){if(!e.parentElement.classList.contains("folder"))return;e.parentElement.classList.add("collapsed"),e.nextSibling.replaceChildren()}selectElement(e){if(this.viewElement.querySelector(".info.selected")?.classList.remove("selected"),!e){this.viewElement.querySelector(".delete").disabled=!0,this.viewElement.querySelector(".rename").disabled=!0;return}e.classList.add("selected"),$n(e,{scrollMode:"if-needed",block:"nearest",inline:"nearest"});const t=this.viewElement.querySelector("button.confirm"),n=e.dataset.path;t.disabled=!0,n&&(t.disabled=!this.acceptableFileType(n),this.viewElement.querySelector(".delete").disabled=!1,this.viewElement.querySelector(".rename").disabled=!1)}async createDiv(e){const t=await Ce.getStandardHandler().getDirectoryFolders(e);let n=await Ce.getStandardHandler().getDirectoryFiles(e);return t.sort((a,r)=>a.name.toLowerCase().localeCompare(r.name.toLowerCase())),n.sort((a,r)=>a.name.toLowerCase().localeCompare(r.name.toLowerCase())),n=n.filter(a=>At(a.name)!=".crswap"),t.map(a=>this.createBaseElement(e,a)).concat(n.map(a=>this.createBaseElement(e,a)))}createBaseElement(e,t){e!=""&&(e+="/");const n=document.createElement("div");n.classList.add("item");const a=document.createElement("div");if(a.classList.add("info"),n.appendChild(a),t.kind=="directory"){const s=be.getIcon("CHEVRON",16);s.classList.add("folder-icon"),a.appendChild(s);const o=document.createElement("div");o.classList.add("children"),n.appendChild(o),n.classList.add("folder"),n.classList.add("collapsed"),a.addEventListener("click",l=>{const u=l.target;u?.classList.contains("options-icon")||u.tagName=="TEXTAREA"&&!u.disabled||(n.classList.contains("collapsed")?this.expand(a):this.collapse(a))})}else{this.acceptableFileType(t.name)||a.classList.add("disabled");const s=be.getIcon(this.getIconId(t.name),16);a.appendChild(s)}a.dataset.path=e+t.name;const r=document.createElement("textarea");return r.rows=1,r.disabled=!0,r.autocomplete="off",r.autocapitalize="off",r.spellcheck=!1,r.innerText=t.name,r.style.pointerEvents="none",r.classList.add("title"),a.appendChild(r),a.addEventListener("click",()=>this.selectElement(a)),a.addEventListener("mousedown",()=>this.startDragging(a)),a.ondblclick=()=>this.confirmFile(),n}confirmFile(){const t=this.viewElement.querySelector(".info.selected")?.dataset.path;t&&this.acceptableFileType(t)&&(this.dirOptions.callback?.(t),window.removeEventListener("keydown",this.keyHandler,!0),window.removeEventListener("drop",this.dropHandler,!0),window.removeEventListener("mousemove",this.dragHandler,!0),this.closeWindow())}acceptableFileType(e){return this.dirOptions.accepted_file_types.length==0||this.dirOptions.accepted_file_types.includes(At(e))}getIconId(e){const t=At(e);return t==""&&!e.startsWith(".")?"FOLDER":qi.includes(t)?"IMAGE_FILE":er.includes(t)?"VOLUME":[".sm",".ssc"].includes(t)?"SM_FILE":"UNKNOWN_FILE"}startEditing(e){const t=e.value,n=!!e.parentElement?.parentElement?.classList.contains("folder"),a=e.parentElement?.dataset.path??"",r=at(a);e.value=a.split("/").at(-1)??"",window.removeEventListener("keydown",this.keyHandler,!0),e.disabled=!1,e.style.pointerEvents="",e.focus(),e.addEventListener("keypress",s=>{s.code=="Enter"&&(s.preventDefault(),s.stopImmediatePropagation(),e.blur())},!0),e.addEventListener("blur",async()=>{if(window.addEventListener("keydown",this.keyHandler,!0),e.disabled=!0,e.style.pointerEvents="none",e.value.startsWith(".")){e.value=t;return}e.value=e.value.replaceAll("/","");const s=r==""?e.value:r+"/"+e.value;s!=a&&(e.parentElement.dataset.path=s,await Ce.getStandardHandler()[n?"renameDirectory":"renameFile"](a,s),this.refreshDirectory(r),e.value.length>32&&(e.value=e.value.slice(0,32)+"..."))})}async refreshDirectory(e){const t=this.viewElement.querySelector(".dir-selector");if(!t)return;let n=t.querySelector("div[data-path='"+this.escapeSelector(e)+"']")?.nextSibling;if(e==""&&(n=t),!n)return;const a=Array.from(n.parentElement.querySelectorAll(".folder:not(.collapsed)")).map(r=>r.children[0].dataset.path);await this.createDiv(e).then(r=>n.replaceChildren(...r)),await Promise.all(a.map(r=>this.expand(t.querySelector("div[data-path='"+this.escapeSelector(r)+"']"))))}getElement(e){const t=this.viewElement.querySelector(".dir-selector");return t?t.querySelector("div[data-path='"+this.escapeSelector(e)+"']"):null}async getAcceptableFile(e){const t=await Ce.getStandardHandler().getDirectoryHandle(e);if(!t)return;const n=[{path:e,handle:t}];for(;n.length>0;){const a=n.shift(),r=a.handle;for await(const s of r.values()){const o=a.path==""?"":a.path+"/";if(s.kind=="directory")n.push({path:o+s.name,handle:s});else if(this.acceptableFileType(s.name))return o+s.name}}}async selectPath(e){if(!e)return;const t=this.viewElement.querySelector(".dir-selector");if(!t)return;const n=e.split("/");n.pop();const a=[];for(;n.length>0;){a.push(n.shift());const s=t.querySelector("div[data-path='"+this.escapeSelector(a.join("/"))+"']");if(!s)return;await this.expand(s)}const r=t.querySelector("div[data-path='"+this.escapeSelector(e)+"']");r&&this.selectElement(r)}handleKeyEvent(e){if(!this.windowElement.classList.contains("focused"))return;const t=this.viewElement.querySelector(".info.selected");if(t==null){if(e.code.startsWith("Arrow")){const n=this.viewElement.querySelector(".info");n&&this.selectElement(n)}return}if(e.code=="ArrowUp"){e.preventDefault(),e.stopImmediatePropagation();const n=t.parentElement;let a=n.previousSibling?.querySelector(".info");a&&!a.parentElement.classList.contains("collapsed")&&a.parentElement.classList.contains("folder")&&(a=a.parentElement.querySelector(".children").lastChild.querySelector(".info")),!a&&n.parentElement.classList.contains("children")&&(a=n.parentElement.parentElement.querySelector(".info")),a&&(this.selectElement(a),$n(a,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}if(e.code=="ArrowDown"){e.preventDefault(),e.stopImmediatePropagation();const n=t.parentElement;let a;n.classList.contains("folder")&&!n.classList.contains("collapsed")&&(a=n.querySelector(".children").children[0].querySelector(".info")),a||(a=t.parentElement.nextSibling?.querySelector(".info")),!a&&n.parentElement.classList.contains("children")&&(a=n.parentElement.parentElement.nextSibling.querySelector(".info")),a&&(this.selectElement(a),$n(a,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}if(e.code=="ArrowLeft"&&(e.preventDefault(),e.stopImmediatePropagation(),this.collapse(t)),e.code=="ArrowRight"&&(e.preventDefault(),e.stopImmediatePropagation(),this.expand(t)),e.code=="Enter"&&(e.preventDefault(),e.stopImmediatePropagation(),t.parentElement?.querySelector(".title")&&this.startEditing(t.parentElement?.querySelector(".title"))),e.code=="Delete"||e.code=="Backspace"){const n=this.viewElement.querySelector(".info.selected"),a=n?.dataset.path;if(!a)return;const r=n.parentElement.classList.contains("folder");Ce.getStandardHandler()[r?"removeDirectory":"removeFile"](a).then(()=>{const s=this.getElement(a);s&&(s.parentElement?.remove(),this.viewElement.querySelector(".delete").disabled=!0,this.viewElement.querySelector(".rename").disabled=!0)})}}startDragging(e){const t=e;t.totalMovementX=0,t.totalMovementY=0,this.draggedElement=t;const n=()=>{this.stopDragging(),window.removeEventListener("mouseup",n)};window.addEventListener("mouseup",n)}handleDragEvent(e){if(this.draggedElement){if(this.draggedElement.totalMovementX+=e.movementX,this.draggedElement.totalMovementY+=e.movementY,!this.draggedCopy)if(Math.abs(this.draggedElement.totalMovementX)+Math.abs(this.draggedElement.totalMovementY)>8){this.viewElement.addEventListener("mousemove",this.mouseHandler),this.draggedCopy=this.draggedElement.parentElement.cloneNode(!0),this.draggedCopy.style.position="fixed";const t=this.draggedElement.getBoundingClientRect();this.draggedCopy.style.top=t.top+this.draggedElement.totalMovementY+"px",this.draggedCopy.style.left=t.left+this.draggedElement.totalMovementX+"px",this.draggedCopy.style.width=t.width+"px",this.draggedCopy.style.boxShadow="3px 3px 3px #222",this.draggedCopy.querySelector(".children")&&this.draggedCopy.removeChild(this.draggedCopy.querySelector(".children")),this.viewElement.appendChild(this.draggedCopy)}else return;this.draggedCopy.style.top=parseFloat(this.draggedCopy.style.top.slice(0,-2))+e.movementY+"px",this.draggedCopy.style.left=parseFloat(this.draggedCopy.style.left.slice(0,-2))+e.movementX+"px"}}async stopDragging(){if(this.draggedCopy){this.draggedCopy.remove(),this.viewElement.removeEventListener("mousemove",this.mouseHandler);const e=this.draggedCopy.classList.contains("folder"),t=this.draggedElement.dataset.path,n=this.fileDropPath==""?Tt(this.draggedElement.dataset.path):this.fileDropPath+"/"+Tt(this.draggedElement.dataset.path);t!=n&&await Ce.getStandardHandler()[e?"renameDirectory":"renameFile"](t,n),await this.refreshDirectory(at(t)),await this.refreshDirectory(at(n)),this.viewElement.querySelector(".outlined")?.classList.remove("outlined"),this.fileDropPath=""}this.draggedCopy=void 0,this.draggedElement=void 0}handleDropEvent(e){e.preventDefault(),e.stopImmediatePropagation(),this.viewElement.querySelector(".outlined")?.classList.remove("outlined"),e.target.closest(".dir-selector")&&Ce.getStandardHandler().handleDropEvent(e,this.fileDropPath).then(async t=>{await this.refreshDirectory(this.fileDropPath),this.getAcceptableFile(t??this.fileDropPath).then(n=>this.selectPath(n)),this.fileDropPath=""})}handleMouseEvent(e){const t=this.viewElement.querySelector(".dir-selector");let n=Array.from(t.querySelectorAll("div.item.folder"));const a=this.viewElement.querySelector(".outlined");n=n.filter(r=>!r.parentElement.closest(".collapsed")),n.reverse(),n.push(t);for(const r of n){const s=r.getBoundingClientRect();if(e.clientX>=s.x&&e.clientX<=s.x+s.width&&e.clientY>=s.y&&e.clientY<=s.y+s.height){a!=r&&a?.classList.remove("outlined");const o=r.querySelector(".info");this.fileDropPath=o?.dataset.path??"",r.classList.contains("dir-selector")&&(this.fileDropPath=""),r.classList.add("outlined");return}}this.viewElement.querySelector(".outlined")?.classList.remove("outlined"),this.fileDropPath=""}escapeSelector(e){return e.replaceAll(/'/g,"\\'")}}function qu(){const i=document.createElement("div");return i.spellcheck=!1,i.contentEditable="true",i.classList.add("inlineEdit"),i.onkeydown=e=>{e.key=="Enter"&&i.blur()},i}function wa(i,e){return{title:i,element:t=>{const n=qu();return n.onblur=()=>{const a=n.innerText,r=t[e];Mt.instance.run({action:()=>{t[e]=a,n.innerText=a},undo:()=>{t[e]=r,n.innerText=r}}),n.scrollLeft=0},n.innerText=t[e],n}}}const om={name:wa("Name","chartName"),credit:wa("Artist","credit"),style:wa("Style","chartStyle"),description:wa("Description","description"),music:{title:"Music File",element:(i,e)=>{const t=document.createElement("div");t.classList.add("flex-row","flex-column-gap","flex-static","hide-buttons");const n=()=>{if(a.innerText==(i.music??e.chartManager.loadedSM.properties.MUSIC??""))return;const u=e.chartManager.chartAudio.isPlaying();if(a.innerText==""||a.innerText==e.chartManager.loadedSM.properties.MUSIC){i.music=void 0,a.innerText=e.chartManager.loadedSM.properties.MUSIC+"",e.chartManager.loadAudio(),u&&e.chartManager.chartAudio.play();return}const f=a.innerText==e.chartManager.loadedSM.properties.MUSIC?void 0:a.innerText,c=i.music;Mt.instance.run({action:()=>{i.music=f,a.innerText=f??e.chartManager.loadedSM.properties.MUSIC??"",e.chartManager.loadAudio(),u&&e.chartManager.chartAudio.play()},undo:()=>{i.music=c,a.innerText=c??e.chartManager.loadedSM.properties.MUSIC??"",e.chartManager.loadAudio(),u&&e.chartManager.chartAudio.play()}})},a=qu();a.style.flex="1",a.onblur=n,a.innerText=i.music??e.chartManager.loadedSM.properties.MUSIC??"";const r=document.createElement("button");r.onclick=()=>{const u=at(e.chartManager.smPath);if(window.nw){const f=document.createElement("input");f.type="file",f.accept="audio/*",f.onchange=()=>{a.innerText=Ce.getRelativePath(u,f.value),n()},f.click()}else e.windowManager.openWindow(new or(e,{title:"Select an audio file...",accepted_file_types:er,disableClose:!0,callback:f=>{a.innerText=Ce.getRelativePath(u,f),n()}},u+"/"+(i.music??e.chartManager.loadedSM.properties.MUSIC??"")))};const s=be.getIcon("FOLDER",12);r.appendChild(s);const o=document.createElement("button");o.onclick=()=>{a.innerText!=(e.chartManager.loadedSM.properties.MUSIC??"")&&(a.innerText=e.chartManager.loadedSM.properties.MUSIC??"",n())};const l=be.getIcon("REVERT",12);return o.appendChild(l),t.appendChild(a),t.appendChild(r),t.appendChild(o),t}}};class vn extends ct{app;buttonOptions;message;detail;resolve;resolved=new Promise(e=>this.resolve=e);constructor(e,t,n,a,r){super({title:t,width:300,disableClose:!0,win_id:"confirm",blocking:!0}),this.app=e,this.message=n,this.detail=r,this.buttonOptions=a,this.initView()}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("confirmation");const e=document.createElement("div");e.classList.add("padding"),e.style.gap="0.3rem";const t=document.createElement("div");if(t.classList.add("label"),t.innerText=this.message,e.appendChild(t),this.detail){const a=document.createElement("div");a.classList.add("secondary"),a.innerText=this.detail,e.appendChild(a)}const n=document.createElement("div");n.classList.add("menu-options"),this.buttonOptions.forEach(a=>{const r=document.createElement("button");r.innerText=a.label,r.onclick=()=>{a.callback?.(),this.resolve?.(a.label),this.closeWindow()},a.type!="default"&&r.classList.add(a.type),n.append(r)}),e.appendChild(n),this.viewElement.appendChild(e),requestAnimationFrame(()=>this.center())}}class ju extends ct{app;gameType;chartList;chartInfo;gameTypeDropdown;currentChart;smLoadHandler=()=>{this.gameTypeDropdown.setItems(yt.getPriority().map(e=>{const t=this.app.chartManager.loadedSM?.charts[e.id]??[];return e.id+" ("+t.length+")"})),this.gameTypeDropdown.setSelected(this.gameType.id+" ("+(this.app.chartManager.loadedSM?.charts[this.gameType.id]??[]).length+") "),this.gameType=this.app.chartManager.loadedChart?.gameType??this.gameType,this.loadCharts()};chartModifiedHandler=()=>{this.app.chartManager.loadedChart==this.currentChart&&this.loadChartDetails(this.app.chartManager.loadedChart)};constructor(e,t){super({title:"Chart List",width:500,height:400,win_id:"chart_list"}),this.app=e,this.gameType=t??e.chartManager.loadedChart?.gameType??yt.getPriority()[0],this.initView(),ie.on("smLoadedAfter",this.smLoadHandler),ie.on("chartModified",this.chartModifiedHandler),ie.on("parityModified",this.chartModifiedHandler)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("chart-view-type-wrapper");const n=document.createElement("div");n.classList.add("chart-view-type-label"),n.innerText="Game Type:",this.gameTypeDropdown=gi.create(yt.getPriority().map(r=>{const s=this.app.chartManager.loadedSM?.charts[r.id]??[];return r.id+" ("+s.length+")"}),this.gameType.id+" ("+(this.app.chartManager.loadedSM?.charts[this.gameType.id]??[]).length+") "),this.gameTypeDropdown.onChange(r=>{this.gameType=yt.getGameType(r.split(" ")[0])??this.gameType,this.loadCharts()}),t.appendChild(n),t.appendChild(this.gameTypeDropdown.view);const a=document.createElement("div");a.classList.add("chart-view-scroller"),e.appendChild(t),e.appendChild(a),this.chartList=document.createElement("div"),this.chartList.classList.add("chart-list"),this.chartInfo=document.createElement("div"),this.chartInfo.classList.add("chart-info"),a.appendChild(this.chartList),a.appendChild(this.chartInfo),this.viewElement.appendChild(e),this.loadCharts()}onClose(){ie.off("smLoadedAfter",this.smLoadHandler),ie.off("chartModified",this.chartModifiedHandler),ie.off("parityModified",this.chartModifiedHandler)}loadCharts(){const e=this.app.chartManager.loadedSM?.charts[this.gameType.id]??[],t=[];this.gameTypeDropdown.setItems(yt.getPriority().map(s=>{const o=this.app.chartManager.loadedSM?.charts[s.id]??[];return s.id+" ("+o.length+")"})),this.gameTypeDropdown.setSelected(this.gameType.id+" ("+(this.app.chartManager.loadedSM?.charts[this.gameType.id]??[]).length+") "),e.forEach(s=>{const o=document.createElement("div");o.classList.add("chart-list-item"),o.chart=s,this.app.chartManager.loadedChart==s&&o.classList.add("selected"),o.onclick=()=>{o.chart!=this.app.chartManager.loadedChart&&(this.app.chartManager.loadChart(o.chart),this.chartList.querySelectorAll(".selected").forEach(d=>d.classList.remove("selected")),o.classList.add("selected"))},o.onmouseenter=()=>{this.loadChartDetails(o.chart)},o.onmouseleave=()=>{this.loadChartDetails()};const l=document.createElement("div");l.innerText=s.meter+"",l.classList.add("title",s.difficulty);const u=document.createElement("div");u.classList.add("chart-list-info");const f=document.createElement("div");f.innerText=s.credit,f.classList.add("title","chart-credit");const c=document.createElement("div");c.innerText=s.getNotedata().length+"",c.classList.add("title","chart-step-count"),u.appendChild(f),u.appendChild(c),o.appendChild(l),o.appendChild(u),t.push(o)});const n=document.createElement("div");n.classList.add("chart-list-item");const a=document.createElement("div");a.innerText="+",a.classList.add("title");const r=document.createElement("div");r.classList.add("chart-list-info"),r.innerText="New Blank Chart",n.appendChild(a),n.appendChild(r),n.onclick=()=>{const s=new dd(this.app.chartManager.loadedSM);s.gameType=this.gameType,this.app.chartManager.loadedSM.addChart(s),this.app.chartManager.loadChart(s),this.loadCharts()},this.chartList.replaceChildren(...t,n),this.loadChartDetails()}loadChartDetails(e){if(e=e??this.app.chartManager.loadedChart,e?.gameType.id!=this.gameType.id){this.chartInfo.replaceChildren();return}if(!e)return;this.currentChart=e;const t=document.createElement("div");t.classList.add("chart-info-scroller");const n=()=>this.app.chartManager.loadedSM.charts[e.gameType.id].sort((y,x)=>Tn.indexOf(y.difficulty)==Tn.indexOf(x.difficulty)?y.meter-x.meter:Tn.indexOf(y.difficulty)-Tn.indexOf(x.difficulty)),a=document.createElement("div");a.classList.add("chart-info-main");const r=gi.create(Tn,e.difficulty);r.view.classList.add("no-border","white"),r.onChange(y=>{const x=e.difficulty;Mt.instance.run({action:()=>{e.difficulty=y,n(),this.loadCharts()},undo:()=>{e.difficulty=x,n(),this.loadCharts()}})});const s=document.createElement("div");s.spellcheck=!1,s.contentEditable="true",s.classList.add("inlineEdit","chart-meter"),s.onkeydown=y=>{y.key=="Enter"&&s.blur()},s.onblur=()=>{let y=Yn(s.innerText);if(y===null){s.innerText=e?.meter+"";return}y=Math.round(Te(1,y,2**31-1));const x=e.meter;Mt.instance.run({action:()=>{e.meter=y,e.meterF=y,n(),this.loadCharts()},undo:()=>{e.meter=x,e.meterF=x,n(),this.loadCharts()}}),s.scrollLeft=0},s.innerText=e.meter+"";const o=document.createElement("div");o.classList.add("chart-properties"),a.appendChild(r.view),a.appendChild(s),Object.values(om).forEach(y=>{const x=document.createElement("div");x.classList.add("label"),x.innerText=y.title;const w=y.element(e,this.app);y.title=="Artist"&&w.addEventListener("blur",()=>this.loadCharts()),o.appendChild(x),o.appendChild(w)});const l=e.stats.noteCounts,u=document.createElement("div");u.classList.add("chart-info-grid-item");const f=document.createElement("div");f.innerText="Peak NPS",f.classList.add("title","chart-info-grid-label");const c=document.createElement("div");c.innerText=e.stats.getMaxNPS().toFixed(2)+"",c.classList.add("title","chart-info-grid-count"),u.appendChild(f),u.appendChild(c);const d=document.createElement("div");d.classList.add("chart-info-grid"),Object.entries(l).forEach(y=>{const x=document.createElement("div");x.classList.add("chart-info-grid-item");const w=document.createElement("div");w.innerText=y[0],w.classList.add("title","chart-info-grid-label");const C=document.createElement("div");C.innerText=y[1]+"",C.classList.add("title","chart-info-grid-count"),x.appendChild(w),x.appendChild(C),d.appendChild(x)});const h=document.createElement("div");if(h.classList.add("chart-info-grid"),h.style.marginTop="1rem",e.stats.parity)for(let y=0;y<e.stats.parity.techCounts.length;y++){const x=document.createElement("div");x.classList.add("chart-info-grid-item");const w=document.createElement("div");w.innerText=Nc[y],w.classList.add("title","chart-info-grid-label");const C=document.createElement("div");C.innerText=(e.stats.parity.techCounts[y]??0)+"",C.classList.add("title","chart-info-grid-count"),x.appendChild(w),x.appendChild(C),h.appendChild(x)}else h.style.display="none";const p=document.createElement("div");p.classList.add("menu-options");const m=document.createElement("button");m.innerText="Duplicate Chart",m.onclick=()=>{const y=Object.assign(Object.create(Object.getPrototypeOf(e)),e);y.setNotedata(e.getNotedata().map(x=>e.computeNote(x))??[]),this.app.chartManager.loadedSM.addChart(y),this.app.chartManager.loadChart(y),this.loadCharts()},p.append(m);const g=document.createElement("button");g.innerText="Delete Chart",g.onclick=()=>{this.app.windowManager.openWindow(new vn(this.app,"Delete chart","Are you sure you want to delete this chart?",[{type:"default",label:"Cancel"},{type:"delete",label:"Delete",callback:()=>{this.app.chartManager.loadedSM.removeChart(e)&&(this.app.chartManager.loadChart(),this.gameType=this.app.chartManager.loadedChart?.gameType??this.gameType,this.loadCharts())}}]))},g.classList.add("delete"),p.append(g),t.addEventListener("wheel",()=>{p.classList.toggle("bottom",t.clientHeight+t.scrollTop<t.scrollHeight-10),t.classList.toggle("top",t.scrollTop>10)},{passive:!0}),requestAnimationFrame(()=>p.classList.toggle("bottom",t.clientHeight+t.scrollTop<t.scrollHeight-10)),t.replaceChildren(a,o,u,d,h),this.chartInfo.replaceChildren(t,p)}}var vs,pc;function lm(){if(pc)return vs;pc=1;var i=4,e=.001,t=1e-7,n=10,a=11,r=1/(a-1),s=typeof Float32Array=="function";function o(m,g){return 1-3*g+3*m}function l(m,g){return 3*g-6*m}function u(m){return 3*m}function f(m,g,y){return((o(g,y)*m+l(g,y))*m+u(g))*m}function c(m,g,y){return 3*o(g,y)*m*m+2*l(g,y)*m+u(g)}function d(m,g,y,x,w){var C,_,F=0;do _=g+(y-g)/2,C=f(_,x,w)-m,C>0?y=_:g=_;while(Math.abs(C)>t&&++F<n);return _}function h(m,g,y,x){for(var w=0;w<i;++w){var C=c(g,y,x);if(C===0)return g;var _=f(g,y,x)-m;g-=_/C}return g}function p(m){return m}return vs=function(g,y,x,w){if(!(0<=g&&g<=1&&0<=x&&x<=1))throw new Error("bezier x values must be in [0, 1] range");if(g===y&&x===w)return p;for(var C=s?new Float32Array(a):new Array(a),_=0;_<a;++_)C[_]=f(_*r,g,x);function F(D){for(var O=0,H=1,Y=a-1;H!==Y&&C[H]<=D;++H)O+=r;--H;var re=(D-C[H])/(C[H+1]-C[H]),M=O+re*r,R=c(M,g,x);return R>=e?h(D,M,g,x):R===0?M:d(D,O,O+r,g,x)}return function(O){return O===0?0:O===1?1:f(F(O),y,w)}},vs}var cm=lm();const pt=oa(cm),um=pt(0,0,1,1);function mc(i,e){const t=e?e.split("."):[];for(;t.length&&i;){const n=t.shift(),a=new RegExp("(.+)\\[([0-9]*)\\]").exec(n);if(a!==null&&a.length==3){const r={arrName:a[1],arrIndex:a[2]};i[r.arrName]!==void 0?i=i[r.arrName][r.arrIndex]:i=void 0;continue}i=i[n]}return i}function dm(i,e,t){const n=e?e.split("."):[];for(;n.length&&i;){const a=n.shift(),r=new RegExp("(.+)\\[([0-9]*)\\]").exec(a);if(r!==null&&r.length==3){const s={arrName:r[1],arrIndex:r[2]};i[s.arrName]!==void 0&&n.length===0&&(i[s.arrName][s.arrIndex]=t);continue}i[a]===void 0&&(i[a]={}),n.length===0&&(i[a]=t),i=i[a]}return i}class rt{static animations=new Map;static _id=0;static{vt.shared.add(e=>{for(const[t,n]of this.animations.entries())n.obj._destroyed?this.stop(t):(n.progress=Math.min(1,n.progress+n.seconds*e),this.updateObject(n.obj,n.animation,n.curve(n.progress)),n.progress>=1&&(n.onend(n.obj),this.stop(t,1)))})}static updateObject(e,t,n){const a=Object.keys(t).sort((o,l)=>parseFloat(o)-parseFloat(l));let r="0";for(let o=a.length-2;o>=0;o--)if(parseFloat(a[o])<=n){r=a[o];break}let s="1";for(let o=1;o<a.length;o++)if(parseFloat(a[o])>n){s=a[o];break}Object.keys(t[0]).forEach(o=>{let l=t[r][o],u=t[s][o];l==="inherit"&&(t[r][o]=mc(e,o),l=t[r][o]),u==="inherit"&&(t[s][o]=mc(e,o),u=t[s][o]);const f=l+(n-parseFloat(r))/(parseFloat(s)-parseFloat(r))*(u-l);dm(e,o,f)})}static stop(e,t=null){e!==void 0&&(t!==null&&this.animations.get(e)?.obj&&!this.animations.get(e).obj.destroyed&&this.updateObject(this.animations.get(e).obj,this.animations.get(e).animation,t),this.animations.delete(e))}static finish(e){e!==void 0&&this.stop(e,1)}static animate(e,t,n,a,r=()=>{},s){return s||=`${++this._id}`,this.animations.set(s,{obj:e,animation:t,seconds:1/(60*n),progress:0,curve:a!==void 0?a:um,onend:r}),this.updateObject(e,t,0),s}}const xs=[{frequency:20,Q:.71},{frequency:75,gain:0},{frequency:100,gain:0,Q:.6},{frequency:250,gain:0,Q:.3},{frequency:1040,gain:0,Q:.41},{frequency:2500,gain:0,Q:.2},{frequency:7500,gain:0},{frequency:2e4,Q:.71}],gc=[{freq:20,label:"20"},{freq:30,label:"30"},{freq:40,label:"40"},{freq:50,label:"50"},{freq:60,label:"60"},{freq:70,label:""},{freq:80,label:"80"},{freq:90,label:""},{freq:100,label:"100"},{freq:200,label:"200"},{freq:300,label:"300"},{freq:400,label:"400"},{freq:500,label:"500"},{freq:600,label:"600"},{freq:700,label:""},{freq:800,label:"800"},{freq:900,label:""},{freq:1e3,label:"1k"},{freq:2e3,label:"2k"},{freq:3e3,label:"3k"},{freq:4e3,label:"4k"},{freq:5e3,label:"5k"},{freq:6e3,label:"6k"},{freq:7e3,label:""},{freq:8e3,label:"8k"},{freq:9e3,label:""},{freq:1e4,label:"10k"},{freq:15e3,label:""},{freq:2e4,label:"20k"}],fn=0,pn=0,Ji=1200,bt=400,Ua=new Array(Ji).fill(0).map((i,e)=>Mo(e)),hm=new Float32Array(Ua);function Wa(i){return Math.log(i/20)/Math.log(1102.5)*Ji}function Mo(i){return Math.pow(1102.5,i/Ji)*20}function Xi(i){return-i*6+bt/2}function bc(i){return-(i-bt/2)/6}class fm extends ct{app;cachedReponse=new Array(Ji).fill(0);onAudioLoad=this.onAudio.bind(this);onThemeChange=this.changeHTMLColors.bind(this);points=[];icons;info;trackedFilter=null;constructor(e){super({title:"Audio Equalizer",width:600,height:245,win_id:"audio-eq"}),this.app=e,this.initView(),this.onAudioLoad(),ie.on("audioLoaded",this.onAudioLoad),ie.on("themeChanged",this.onThemeChange)}destroy(){ie.off("audioLoaded",this.onAudioLoad),ie.off("themeChanged",this.onThemeChange)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("eq-container");const t=document.createElement("div");t.classList.add("icon-container"),this.app.chartManager.chartAudio.getFilters().forEach((w,C)=>{const _=be.getIcon(w.type.toUpperCase(),36,24,Ki[C]);_.classList.add("eq-icon"),_.style.backgroundColor=`${Ki[C]}40`,_.onclick=()=>{this.app.chartManager.chartAudio.getFilter(C).enabled?this.app.chartManager.chartAudio.disableFilter(C):this.app.chartManager.chartAudio.enableFilter(C),this.endTrack(),this.updateIcons()},_.onmouseenter=()=>this.points[C].highlight(),_.onmouseleave=()=>this.points[C].unhighlight(),t.appendChild(_)}),this.icons=t,this.updateIcons();const n=document.createElement("canvas");n.style.width="37.5rem",n.style.height="12.5rem",n.onmousedown=w=>{const C=this.points.filter(_=>_.hitTest(w.offsetX*2/b.general.uiScale,w.offsetY*2/b.general.uiScale)).at(-1);this.endTrack(),C?.mouseDown(w)};const a=document.createElement("div");a.classList.add("eq-info-container");const r=document.createElement("div");r.classList.add("eq-info");const s=document.createElement("div");s.innerText="Type",s.classList.add("eq-info-label");const o=document.createElement("div");o.classList.add("eq-info-value"),r.replaceChildren(s,o);const l=document.createElement("div");l.classList.add("eq-info");const u=document.createElement("div");u.innerText="Frequency",u.classList.add("eq-info-label");const f=document.createElement("div");f.contentEditable="false",f.classList.add("eq-info-value","inlineEdit"),l.replaceChildren(u,f),this.setupInput(f,"frequency",20,22050," Hz");const c=document.createElement("div");c.classList.add("eq-info");const d=document.createElement("div");d.innerText="Gain",d.classList.add("eq-info-label");const h=document.createElement("div");h.contentEditable="false",h.classList.add("eq-info-value","inlineEdit"),c.replaceChildren(d,h),this.setupInput(h,"gain",-24,24," dB",1);const p=document.createElement("div");p.classList.add("eq-info");const m=document.createElement("div");m.innerText="Q",m.classList.add("eq-info-label");const g=document.createElement("div");g.contentEditable="false",g.classList.add("eq-info-value","inlineEdit"),p.replaceChildren(m,g),this.setupInput(g,"Q",1e-4,1e3,"",4);const y=document.createElement("div");y.classList.add("eq-reset","disabled"),y.innerText="Reset",y.onclick=()=>{if(this.trackedFilter==null)for(let w=0;w<xs.length;w++)this.app.chartManager.chartAudio.updateFilter(w,xs[w]),this.app.chartManager.chartAudio.disableFilter(w),this.updateIcons(),this.points[w].refreshPoint();else this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,xs[this.trackedFilter]),this.app.chartManager.chartAudio.disableFilter(this.trackedFilter),this.updateIcons(),this.points[this.trackedFilter].refreshPoint(),this.trackFilter(this.trackedFilter)},a.replaceChildren(r,l,c,p,y),this.info=a,e.replaceChildren(t,n,a),this.viewElement.appendChild(e);const x=this.drawEQ(n);requestAnimationFrame(x),this.changeHTMLColors()}selectText(e){const t=window.getSelection(),n=document.createRange();!t||!n||n.selectNodeContents(e)}setupInput(e,t,n,a,r="",s=0){let o=0;e.onfocus=()=>{o=this.app.chartManager.chartAudio.getFilter(this.trackedFilter)[t].value,e.innerText=he(o,s)+"",this.selectText(e)},e.onkeydown=l=>{if(l.key=="Enter"){e.blur();return}if(l.key=="Tab"){const f=[...e.parentElement.parentElement.children],c=f.indexOf(e.parentElement);for(let d=1;d<f.length;d++){const p=f[(d+c)%f.length].children[1];if(p.contentEditable==="true"){p.focus();break}}return}if(l.key=="Escape"){e.innerText=o+r,this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,{gain:Te(o,n,a)}),this.points[this.trackedFilter].refreshPoint(),this.getResponse(),e.blur();return}setTimeout(()=>{const u=Yn(e.innerText);u!==null&&(this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,{[t]:Te(u,n,a)}),this.points[this.trackedFilter].refreshPoint(),this.getResponse())})},e.onblur=()=>{Yn(e.innerText)===null&&(this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,{[t]:Te(o,n,a)}),this.points[this.trackedFilter].refreshPoint(),this.getResponse()),e.innerText=he(this.app.chartManager.chartAudio.getFilter(this.trackedFilter)[t].value,s)+r}}onAudio(){this.points=this.app.chartManager.chartAudio.getFilters().map((e,t)=>new pm(this,t)),this.getResponse(),this.updateIcons(),this.endTrack()}getResponse(){this.cachedReponse=this.app.chartManager.chartAudio.getFrequencyResponse(Ua)}drawEQ(e){const t=e.getContext("2d");t.canvas.width=1200,t.canvas.height=400;const n=()=>{if(!this.app.chartManager.chartAudio)return;const a=t.createRadialGradient(e.width/2,e.height/2,0,e.width/2,e.height/2,e.width/2);let r,s;const o=Fe.getColor("accent-color");Gs(Fe.getColor("primary-bg"))>.5?(r=new B("white"),s=new B("black")):(r=new B("black"),s=new B("white"));const l=It(o,r,.95);a.addColorStop(0,It(o,r,.9).toHexa()),a.addColorStop(1,l.toHexa()),t.fillStyle=a,t.fillRect(0,0,e.width,e.height),t.fillStyle=It(o,r,.2).toHex(),this.drawFrequencies(t,this.app.chartManager.chartAudio.getFrequencyData()),this.app.chartManager.chartAudio.hasFilters()&&(t.fillStyle=It(o,s,.2).toHex()+"50",this.drawFrequencies(t,this.app.chartManager.chartAudio.getFilteredFrequencyData())),t.fillStyle="rgba(200, 200, 200, 0.5)",this.drawResponse(t),t.fillStyle=It(o,s,.2).toHex()+"80",t.font="22px Assistant",this.drawGrid(t),this.points.forEach(u=>u.draw(t)),e.closest("#windows")&&requestAnimationFrame(n)};return n}drawFrequencies(e,t){for(let n=0;n<Ji;n++){const a=Mo(n)/this.app.chartManager.chartAudio.getSampleRate()*this.app.chartManager.chartAudio.getFFTSize(),r=t[Math.floor(a)]/255;e.fillRect(fn+n,pn+bt-r*bt,1,r*bt)}}drawResponse(e){for(let t=0;t<Ji;t++){const n=Math.log(this.cachedReponse[t])/.115241,a=Xi(n);e.fillRect(t+fn,Math.min(a,bt/2)+pn,1,Math.max(a,bt/2)-Math.min(a,bt/2))}}drawGrid(e){for(const t of gc)e.fillRect(fn+Wa(t.freq),pn,1,bt),e.fillText(t.label,fn+Wa(t.freq)-(t==gc.at(-1)?20:0),pn+bt/2);for(let t=-25;t<=25;t+=5){const n=pn+Xi(t);e.fillRect(0,n,1200,1),t!=0&&e.fillText(t+"",fn,n)}}changeHTMLColors(){let e;const t=Fe.getColor("accent-color");Gs(Fe.getColor("primary-bg"))>.5?e=new B("white"):e=new B("black");const n=It(t,e,.95),a=It(t,e,.5);this.icons.style.backgroundColor=n.toHexa(),this.icons.style.borderImageSource=`linear-gradient(to right, ${n.toHexa()}, ${a.toHexa()}, ${n.toHexa()})`,this.info.style.backgroundColor=n.toHexa(),this.info.style.borderImageSource=`linear-gradient(to right, ${n.toHexa()}, ${a.toHexa()}, ${n.toHexa()})`,this.info.style.color=t.toHexa()}updateIcons(){[...this.icons.children].forEach((e,t)=>{this.app.chartManager.chartAudio.getFilter(t).enabled?e.classList.remove("disabled"):e.classList.add("disabled")}),this.getResponse()}trackFilter(e){this.trackedFilter=e;const t=this.app.chartManager.chartAudio.getFilter(e),[n,a,r,s]=[...this.info.children].map(o=>o.children[1]);n.innerText=t.type,a.innerText=Math.round(t.frequency.value)+" Hz",r.innerText=t.type.endsWith("pass")?"-":he(t.gain.value,1)+" dB",s.innerText=t.type.endsWith("shelf")?"-":he(t.Q.value,2)+"",n.style.color=Ki[e],a.style.color=Ki[e],r.style.color=Ki[e],s.style.color=Ki[e],a.contentEditable="true",r.contentEditable=`${!t.type.endsWith("pass")}`,s.contentEditable=`${!t.type.endsWith("shelf")}`}endTrack(){setTimeout(()=>{this.trackedFilter=null,this.points.forEach(r=>r.unhighlight());const[e,t,n,a]=[...this.info.children].map(r=>r.children[1]);e.innerText="",t.innerText="",n.innerText="",a.innerText="",t.contentEditable="false",n.contentEditable="false",a.contentEditable="false"})}}const va=16,Ki=["#a3001b","#a34f00","#d6d606","#19c402","#02c4ba","#022fc4","#5602c4","#c402b4"];class pm{filterIndex;window;dragging=!1;x=0;y=0;type;response=new Float32Array(Ua.length);_empty=new Float32Array(Ua.length);highlighted=!1;pointSize=.4;constructor(e,t){this.filterIndex=t,this.window=e,this.type=this.window.app.chartManager.chartAudio.getFilter(t).type,this.x=Wa(this.window.app.chartManager.chartAudio.getFilter(t).frequency.value??10),this.getY()}hitTest(e,t){return(e-this.x)*(e-this.x)+(t-this.y)*(t-this.y)<=va*va}canChangeGain(){return this.type=="lowshelf"||this.type=="highshelf"||this.type=="peaking"}canChangeQ(){return!this.type.endsWith("shelf")}getY(){this.type.endsWith("shelf")?this.y=Xi((this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).gain.value??0)/2):this.canChangeGain()?this.y=Xi(this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).gain.value??0):this.y=bt/2}getGain(){if(this.canChangeGain())return this.type.endsWith("shelf")?bc(this.y)*2:bc(this.y)}mouseDown(e){this.calcResponse(),this.dragging=!0,this.highlighted=!0,this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).enabled||(this.window.app.chartManager.chartAudio.enableFilter(this.filterIndex),this.window.updateIcons());const t=this.x,n=this.y,a=e.clientX,r=e.clientY,s=l=>{this.x=(l.clientX-a)*2+t,this.canChangeGain()?this.y=(l.clientY-r)*2+n:this.y=bt/2,this.x=Te(this.x,0,Ji),this.y=Te(this.y,this.type.endsWith("shelf")?bt/4:Xi(24),this.type.endsWith("shelf")?3*bt/4:Xi(-24)),this.window.app.chartManager.chartAudio.updateFilter(this.filterIndex,{frequency:Mo(this.x),gain:this.getGain()}),this.window.getResponse(),this.window.trackFilter(this.filterIndex),this.calcResponse()};this.window.trackFilter(this.filterIndex);const o=()=>{rt.animate(this,{0:{pointSize:"inherit"},1:{pointSize:.3}},.3,pt(.11,.71,.41,.86),()=>{},`eq-point${this.filterIndex}`),this.dragging=!1,window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",o)};rt.animate(this,{0:{pointSize:"inherit"},1:{pointSize:.9}},.3,pt(.11,.71,.41,.86),()=>{},`eq-point${this.filterIndex}`),window.addEventListener("mousemove",s),window.addEventListener("mouseup",o)}calcResponse(){this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).getFrequencyResponse(hm,this.response,this._empty)}draw(e){const t=this.highlighted||this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).enabled?Ki[this.filterIndex]:"#888888";if(e.fillStyle=t+"60",this.dragging)for(let n=0;n<this.response.length;n++){const a=Math.log(this.response[n])/.115241,r=Xi(a);e.fillRect(n+fn,Math.min(r,bt/2)+pn,1,Math.max(r,bt/2)-Math.min(r,bt/2))}e.fillStyle=t+"80",e.beginPath(),e.arc(this.x,this.y,va,0,2*Math.PI),e.closePath(),e.fill(),e.beginPath(),e.arc(this.x,this.y,va*this.pointSize,0,2*Math.PI),e.closePath(),e.fill()}refreshPoint(){this.x=Wa(this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).frequency.value??10),this.getY()}highlight(){this.highlighted=!0}unhighlight(){this.highlighted=!1}}const Es={columnOneBased:{label:"1-indexed column numbers",tooltip:"Start counting column numbers from 0 instead of 1."},lengthAsNumberIndex:{label:"Store length in integer keys",tooltip:'Store the length of holds as the last item in each table, instead of using the "length" key.'},padNumbers:{label:"Pad numbers",tooltip:"Pad decimals with trailing zeros."},minify:{label:"Minify",tooltip:"Remove all newlines and spaces."},notitgNoteTypes:{label:"Use NotITG Note Types",tooltip:'Use NotITG note types. (Tap = 1, Hold = 2, Mine = "M")'}},yc={Tap:"1",Hold:"2",Roll:"4",Mine:'"M"',Lift:'"L"',Fake:'"F"'};class mm extends ct{app;selection;outputDiv;exportOptions={include:{Beat:!0,Second:!1,Column:!0,Type:!0,Quantization:!1,Length:!0},options:{columnOneBased:!1,lengthAsNumberIndex:!1,padNumbers:!1,minify:!1,notitgNoteTypes:!1}};constructor(e,t=[]){super({title:"Export Notedata",width:600,height:400,disableClose:!1,win_id:"export_notedata",blocking:!1}),this.app=e,t.length==0&&(t=this.app.chartManager.loadedChart.getNotedata()),this.selection=t,this.initView(),this.export()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("export-container");const n=document.createElement("div");n.classList.add("export-options");const a=document.createElement("pre");a.classList.add("export-output"),Xe(a,{content:"Click to copy to clipboard"}),Xe(a,{content:"Copied!",trigger:"click",onShow(o){o.setProps({trigger:"mouseenter"})},onHide(o){o.setProps({trigger:"click"})}}),a.addEventListener("click",()=>{navigator.clipboard.writeText(a.innerText)}),this.outputDiv=a;const r=document.createElement("div");r.classList.add("export-section-label"),r.innerText="Include",n.appendChild(r),Object.keys(this.exportOptions.include).forEach(o=>{const l=document.createElement("input");l.type="checkbox",l.id="en-i-"+o,l.checked=this.exportOptions.include[o],l.onchange=()=>{this.exportOptions.include[o]=l.checked,this.export()};const u=document.createElement("label");u.classList.add("export-label"),u.htmlFor=l.id,u.innerText=o;const f=document.createElement("div");f.replaceChildren(l,u),f.classList.add("export-option"),n.appendChild(f)});const s=document.createElement("div");s.classList.add("export-section-label"),s.innerText="Options",n.appendChild(s),Object.keys(this.exportOptions.options).forEach(o=>{const l=document.createElement("input");l.id="en-o-"+o,l.type="checkbox",l.checked=this.exportOptions.options[o],l.onchange=()=>{this.exportOptions.options[o]=l.checked,this.export()};const u=document.createElement("label");u.classList.add("export-label"),u.htmlFor=l.id,u.innerText=Es[o].label;const f=document.createElement("div");f.replaceChildren(l,u),f.classList.add("export-option"),n.appendChild(f),Es[o].tooltip!==void 0&&Xe(f,{content:Es[o].tooltip})}),t.replaceChildren(n,a),e.appendChild(t),this.viewElement.appendChild(e)}export(){let e=`{
`+this.selection.map(t=>{let n="	{";return this.exportOptions.include.Beat&&(n+=this.padNum(t.beat)+","),this.exportOptions.include.Second&&(n+=this.padNum(t.second)+","),this.exportOptions.include.Column&&(this.exportOptions.options.columnOneBased?n+=t.col+1+",":n+=t.col+","),this.exportOptions.include.Type&&(this.exportOptions.options.notitgNoteTypes&&yc[t.type]!==void 0?n+=yc[t.type]+",":n+='"'+t.type+'",'),this.exportOptions.include.Quantization&&(n+=t.quant+","),this.exportOptions.include.Length&&Oe(t)&&(this.exportOptions.options.lengthAsNumberIndex?n+=this.padNum(t.hold)+",":n+="length="+this.padNum(t.hold)+","),n.endsWith(",")&&(n=n.slice(0,-1)),n+="}",this.getNumIncludes()==1&&(n=n.replaceAll("{",""),n=n.replaceAll("}","")),n}).join(`,
`)+`
}`;this.exportOptions.options.minify&&(e=e.replaceAll(/\s/g,"")),this.outputDiv.innerText=e}getNumIncludes(){return Object.values(this.exportOptions.include).map(e=>+e).reduce((e,t)=>e+t,0)}padNum(e){return this.exportOptions.options.padNumbers?(Math.round(e*1e3)/1e3).toFixed(3):Math.round(e*1e3)/1e3}}class An extends ct{app;allowMods;callback;combo={mods:[],key:""};conflictCheck;listener;static active=!1;constructor(e,t,n,a){super({title:"",width:300,height:168,disableClose:!0,win_id:"keyComboSelector",blocking:!0}),this.app=e,this.allowMods=t,this.callback=n,this.conflictCheck=a??(()=>[]),this.initView(),An.active=!0}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("confirmation");const e=document.createElement("div");e.classList.add("padding"),e.style.gap="0.5rem";const t=document.createElement("div");t.classList.add("label"),t.innerText="Input a key combo and select Ok when finished.",e.appendChild(t);const n=document.createElement("input");n.type="text",n.disabled=!0,n.style.fontSize="1.25rem",n.style.height="1.5rem",n.style.flex="0",n.style.textAlign="center",e.appendChild(n);const a=document.createElement("div");a.classList.add("detail"),a.innerText="No conflicts",a.style.flex="1",e.appendChild(a);const r=document.createElement("div");r.classList.add("menu-options");const s=document.createElement("button");s.innerText="Ok",s.onclick=()=>{this.callback(this.combo),this.closeWindow()},s.classList.add("confirm"),s.disabled=!0;const o=document.createElement("button");o.innerText="Cancel",o.onclick=()=>{this.closeWindow()},r.append(o),r.append(s),e.appendChild(r),this.viewElement.appendChild(e),this.listener=l=>{if(["Meta","Control","Shift","Alt","Escape"].includes(l.key))return;if(this.combo.key=Ae.getKeyNameFromEvent(l),this.allowMods){const f=[];for(let c=0;c<Ga.length;c++)l[Ga[c]]&&f.push(Ba[c]);this.combo.mods=f}n.value=Ae.getComboString(this.combo);const u=this.conflictCheck(this.combo);u=="self"?(a.innerText="Combo already binded for this keybind",s.disabled=!0):(s.disabled=!1,u.length>=3?a.innerText=`Conflicts with ${u.length} keybinds`:u.length>=1?a.innerText=`Conflicts with ${u.join(",")}`:a.innerText="No conflicts"),l.preventDefault()},window.addEventListener("keydown",this.listener,!0)}onClose(){window.removeEventListener("keydown",this.listener,!0),An.active=!1}}class gm extends ct{app;observer;conflictMap=this.calculateConflicts();constructor(e){super({title:"Gameplay Keybind Options",width:600,height:400,disableClose:!1,win_id:"gameplay_keybind_options",blocking:!1}),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-container");const n=document.createElement("div");n.classList.add("pref-scrollers");const a=document.createElement("div");a.classList.add("pref-section-scroller");const r=document.createElement("div");r.classList.add("pref-option-scroller"),n.replaceChildren(a,r),this.observer=new IntersectionObserver(s=>{s.forEach(o=>{const l=o.target.dataset.id,u=a.querySelector(`.pref-section[data-id=${l}]`);u&&(o.intersectionRatio>0?u.classList.add("selected"):u.classList.remove("selected"))})},{}),t.replaceChildren(n),a.replaceChildren(...this.createSections()),r.replaceChildren(...this.createOptions()),e.appendChild(t),this.viewElement.appendChild(e)}createSections(){return Object.keys(yt.getTypes()).map(e=>this.createEmptySection(e))}createOptions(){return Object.keys(yt.getTypes()).map(e=>{const t=new Array(yt.getTypes()[e].numCols).fill(null).map((r,s)=>this.createKeybindItem(e,s)),n=document.createElement("div");n.classList.add("pref-group"),n.dataset.id=e;const a=document.createElement("div");return a.classList.add("pref-group-label"),a.innerText=e,n.replaceChildren(a,...t),this.observer.observe(n),n})}createEmptySection(e){const t=document.createElement("div");return t.classList.add("pref-section"),t.dataset.id=e,t.innerText=e,t.onclick=()=>{t.parentElement.parentElement.querySelector(`.pref-group[data-id=${e}]`).scrollIntoView()},t}createKeybindItem(e,t){const n=document.createElement("div");n.classList.add("pref-keybind"),n.dataset.id=e+"-"+t,n.onclick=o=>{o.target.classList.contains("pref-keybind-combo")||n.querySelector(".icon")?.contains(o.target)||this.app.windowManager.openWindow(new An(this.app,!1,l=>{Ae.setGameplayKeybind(e,t,l.key),this.conflictMap=this.calculateConflicts(),n.replaceWith(this.createKeybindItem(e,t))},l=>{const u=this.conflictMap.get(e)?.get(l.key)?.map(f=>Bi[f[0]]?.[f[1]].label??"Column "+f[1])??[];return u.includes(Bi[e]?.[t].label??"Column "+t)?"self":u}))};const a=document.createElement("div");a.classList.add("pref-keybind-label"),a.innerText=Bi[e]?.[t].label??"Column "+t;const r=be.getIcon("REVERT");r.style.width="0.75rem",r.addEventListener("click",()=>{Ae.revertGameplayKeybind(e,t),this.conflictMap=this.calculateConflicts(),n.replaceWith(this.createKeybindItem(e,t))}),r.style.display=Ae.checkIsDefaultGameplay(e,t)?"none":"block";const s=document.createElement("div");return s.classList.add("pref-keybind-combos"),s.replaceChildren(...Ae.getKeysForGameType(e)[t].map(o=>{const l=document.createElement("button");return l.classList.add("pref-keybind-combo"),l.innerText=o,this.conflictMap.get(e).get(o).length>1&&l.classList.add("conflict"),l.onclick=()=>{Ae.removeGameplayKeybind(e,t,o),this.conflictMap=this.calculateConflicts(),n.replaceWith(this.createKeybindItem(e,t))},l})),n.replaceChildren(a,r,s),n}calculateConflicts(){const e=new Map;Object.keys(yt.getTypes()).forEach(t=>{const n=new Map;Ae.getKeysForGameType(t).forEach((a,r)=>{a.forEach((s,o)=>{n.has(s)||n.set(s,[]),n.get(s).push([t,r,o])})}),e.set(t,n)}),[...this.viewElement.querySelectorAll(".pref-keybind-combo.conflict")].forEach(t=>t.classList.remove("conflict"));for(const t of e.values())for(const n of t.values())n.length!=1&&n.forEach(a=>{const r=this.viewElement.querySelector(`.pref-keybind[data-id=${a[0]}-${a[1]}] .pref-keybind-combos`);r?.children[a[2]]&&r.children[a[2]].classList.add("conflict")});return e}onClose(){this.observer?.disconnect()}}class $u{static _model;static async getModel(){return this._model||await this._load(),this._model}static async _load(){this._model=[];const e=localStorage.getItem("recentFiles");if(e){try{const t=JSON.parse(e);if(!Array.isArray(t))return;for(const n of t)typeof n!="object"||Array.isArray(n)||typeof n?.name!="string"||typeof n?.path!="string"||this._model.find(a=>a.path==n.path)||this._model.push({name:n.name,path:n.path})}catch{console.log("Failed to load recent file entries");return}await this.saveEntries()}}static async getRecents(){return await this.getModel()}static async addSM(e,t){const n=await this.getModel(),a=n.findIndex(r=>r.path==e);a!=-1&&n.splice(a,1),n.unshift({name:t.properties.TITLE??"Untitled Song",path:e}),this.saveEntries()}static async limitEntries(){(await this.getModel()).splice(15)}static async saveEntries(){this.limitEntries();const e=await Promise.all(this._model.map(t=>Ce.hasFile(t.path)));this._model=this._model.filter((t,n)=>e[n]),localStorage.setItem("recentFiles",JSON.stringify(this._model))}}const bm=`#TITLE:New Song;
#SUBTITLE:;
#ARTIST:;
#TITLETRANSLIT:;
#SUBTITLETRANSLIT:;
#ARTISTTRANSLIT:;
#GENRE:;
#CREDIT:;
#BANNER:;
#BACKGROUND:;
#LYRICSPATH:;
#CDTITLE:;
#MUSIC:;
#OFFSET:0;
#SAMPLESTART:0.000000;
#SAMPLELENGTH:10.000000;
#SELECTABLE:YES;
#BPMS:0.000000=120.000000;
#STOPS:;
#BGCHANGES:;
#FGCHANGES:;
#KEYSOUNDS:;
#ATTACKS:;
`,Yu=[{title:"Metadata",items:[{title:"Title",propName:"TITLE",input:{type:"string"}},{title:"Subtitle",propName:"SUBTITLE",input:{type:"string"}},{title:"Artist",propName:"ARTIST",input:{type:"string"}},{title:"Credit",propName:"CREDIT",input:{type:"string"}},{title:"Genre",propName:"GENRE",input:{type:"string"}},{title:"Origin",propName:"ORIGIN",input:{type:"string"}}]},{title:"Resources",items:[{title:"Audio Track",propName:"MUSIC",input:{type:"file",typeName:"audio",accept:er,onChange:i=>i.chartManager.loadAudio()}},{title:"Background Image",propName:"BACKGROUND",input:{type:"file",typeName:"image",accept:qi}},{title:"Banner Image",propName:"BANNER",input:{type:"file",typeName:"image",accept:qi}},{title:"CD Title",propName:"CDTITLE",input:{type:"file",typeName:"image",accept:qi}},{title:"CD Image",propName:"CDIMAGE",input:{type:"file",typeName:"image",accept:qi}},{title:"Jacket",propName:"JACKET",input:{type:"file",typeName:"image",accept:qi}},{title:"Disc Image",propName:"DISCIMAGE",input:{type:"file",typeName:"image",accept:qi}}]},{title:"Song",items:[{title:"Song Preview",propName:"SAMPLESTART",input:{type:"custom",create:(i,e,t)=>{const n=()=>{r.value<a.value&&(r.value=a.value);const l=e.properties.SAMPLESTART??"0",u=e.properties.SAMPLELENGTH??"10",f=a.value.toString(),c=(r.value-a.value).toString();t.run({action:()=>{e.properties.SAMPLESTART=f,e.properties.SAMPLELENGTH=c,a.value=parseFloat(f),r.value=parseFloat(f)+parseFloat(c)},undo:()=>{e.properties.SAMPLESTART=l,e.properties.SAMPLELENGTH=u,a.value=parseFloat(l),r.value=parseFloat(l)+parseFloat(u)}})},a=ht.create({value:parseFloat(e.properties.SAMPLESTART??"0"),precision:3,min:0});a.onchange=l=>{if(l===void 0){a.value=parseFloat(e.properties.SAMPLESTART??"0");return}n()};const r=ht.create({value:parseFloat(e.properties.SAMPLESTART??"0")+parseFloat(e.properties.SAMPLELENGTH??"10"),precision:3,min:0});r.onchange=l=>{if(l===void 0){r.value=parseFloat(e.properties.SAMPLESTART??"0")+parseFloat(e.properties.SAMPLELENGTH??"10");return}n()};const s=document.createElement("div"),o=document.createElement("div");return o.innerText="to",s.classList.add("flex-row","flex-column-gap"),s.replaceChildren(a.view,o,r.view),s}}}]}];function Ku(i,e,t,n){switch(n.input.type){case"custom":return n.input.create(i,e,t);case"string":{const a=document.createElement("input");return a.type="text",a.autocomplete="off",a.spellcheck=!1,a.onkeydown=r=>{r.key=="Enter"&&a.blur()},a.onblur=()=>{const r=e.properties[n.propName],s=a.value;t.run({action:()=>{e.properties[n.propName]=s,a.value=s},undo:()=>{e.properties[n.propName]=r,a.value=r??""}})},a.value=e.properties[n.propName]??"",a}case"number":{const a=n.input,r=ht.create({value:parseFloat(e.properties[n.propName]??"15"),...a});return r.onchange=s=>{if(s===void 0){r.value=parseFloat(e.properties[n.propName]??"0");return}const o=e.properties[n.propName],l=s.toString();t.run({action:()=>{e.properties[n.propName]=l,r.value=parseFloat(l)},undo:()=>{e.properties[n.propName]=o,r.value=parseFloat(o??"0")}})},r.view}case"file":{const a=n.input,r=n.input.onChange,s=document.createElement("div");s.classList.add("flex-row","flex-column-gap");const o=document.createElement("input");o.type="text",o.autocomplete="off",o.spellcheck=!1,o.placeholder="click to select a file",o.onclick=c=>{c.preventDefault(),o.blur();const d=at(i.chartManager.smPath);if(window.nw){const h=document.createElement("input");h.type="file",h.accept=a.accept.join(","),h.nwworkingdir=d,h.onchange=()=>{const p=Ce.getRelativePath(d,h.value);f(p)},h.click()}else i.windowManager.openWindow(new or(i,{title:`Select a${a.typeName.match(/^[aieouAIEOU].*/)?"n":""} ${a.typeName} file...`,accepted_file_types:a.accept,disableClose:!0,callback:h=>{const p=Ce.getRelativePath(d,h);f(p)}},e.properties[n.propName]?d+"/"+e.properties[n.propName]:i.chartManager.smPath))},o.value=e.properties[n.propName]??"",s.appendChild(o);const l=document.createElement("button");l.style.height="100%",l.classList.add("delete"),l.disabled=!e.properties[n.propName],l.onclick=()=>{f(void 0),l.disabled=!0};const u=be.getIcon("TRASH",12);l.appendChild(u),s.appendChild(l);const f=c=>{const d=e.properties[n.propName]??"";t.run({action:()=>{e.properties[n.propName]=c,o.value=c??"",l.disabled=o.value==""},undo:()=>{e.properties[n.propName]=d,o.value=d,l.disabled=o.value==""}}),r?.(i)};return s}}}class Xu extends ct{app;sm;history;fileTable={};constructor(e){super({title:"New Song",width:450,height:492,disableClose:!0,win_id:"sm_properties",blocking:!0});const t=new Blob([bm],{type:"text/plain"}),n=new File([t],"song.sm",{type:"text/plain"});this.sm=new Hc(n),this.history=new Mt(e),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("sm-properties");const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("label"),t.innerText="Apply to",Yu.forEach(l=>{const u=document.createElement("div");u.classList.add("sm-container");const f=document.createElement("div");f.classList.add("sm-title"),f.innerText=l.title;const c=document.createElement("div");c.classList.add("property-grid"),l.items.forEach(d=>{const h=document.createElement("div");h.classList.add("label"),h.innerText=d.title,c.appendChild(h),d.input.type=="file"?c.appendChild(this.createFileElement(d.propName,d.input.typeName)):c.appendChild(Ku(this.app,this.sm,this.history,d))}),u.appendChild(f),u.appendChild(c),e.appendChild(u)});const n=document.createElement("div");n.classList.add("menu-options");const a=document.createElement("div");a.classList.add("menu-left");const r=document.createElement("div");r.classList.add("menu-right"),n.appendChild(a),n.appendChild(r);const s=document.createElement("button");s.innerText="Cancel",s.onclick=()=>{this.closeWindow()};const o=document.createElement("button");o.innerText="Create",o.classList.add("confirm"),o.onclick=()=>{this.sm.properties.MUSIC===void 0||this.sm.properties.MUSIC===""?this.app.windowManager.openWindow(new vn(this.app,"No audio file uploaded","Are you sure you want to create a file with no audio?",[{type:"default",label:"No"},{type:"confirm",label:"Yes",callback:()=>{this.createSong(),this.closeWindow()}}])):(this.createSong(),this.closeWindow())},a.appendChild(s),r.appendChild(o),e.appendChild(n),this.viewElement.appendChild(e)}async createSong(){let e=this.sm.properties.TITLE;if(window.nw){const t=nw.require("path"),n=nw.require("process"),a=document.createElement("input");a.type="file",a.nwsaveas=e+".sm",a.onchange=async()=>{const r=t.basename(a.value,t.extname(a.value));e=t.dirname(a.value);const s=t.join(e,r+".sm");await Ce.writeFile(s,this.sm.serialize("sm")),await Promise.all(Object.entries(this.fileTable).map(o=>{const l=t.resolve(t.join(e,o[0])),u=t.resolve(o[1].path);if(!(n.platform=="win32"&&l.toLowerCase()===u.toLowerCase())&&l!==u)return Ce.writeFile(l,o[1])})),await this.app.chartManager.loadSM(s),this.app.windowManager?.getWindowById("select_sm_initial")?.closeWindow()},a.click()}else{if(await Ce.getDirectoryHandle(e)){let t=2;for(;await Ce.getDirectoryHandle(e);)e=`${this.sm.properties.TITLE} ${t++}`}await Ce.writeFile(e+"/song.sm",this.sm.serialize("sm")),await Promise.all(Object.entries(this.fileTable).map(t=>Ce.writeFile(e+`/${t[0]}`,t[1]))),await this.app.chartManager.loadSM(e+"/song.sm"),this.app.windowManager?.getWindowById("select_sm_initial")?.closeWindow()}}createFileElement(e,t){const n=document.createElement("div");n.classList.add("flex-row","flex-column-gap");const a=document.createElement("input");a.type="text",a.autocomplete="off",a.spellcheck=!1,a.placeholder="click to upload a file",a.readOnly=!0,a.onclick=o=>{o.preventDefault(),a.blur();const l=document.createElement("input");l.type="file",l.accept=t=="audio"?"audio/*":"image/*",l.onchange=()=>{const u=l.files?.[0];if(!u)return;this.sm.properties[e]&&this.fileTable[this.sm.properties[e]]&&delete this.fileTable[this.sm.properties[e]];let f=u.name;for(;this.fileTable[u.name]&&(this.fileTable[u.name].size!=u.size||this.fileTable[u.name].type!=u.type);)f="_"+f;this.fileTable[f]=u,a.value=f,this.sm.properties[e]=a.value,r.disabled=!1},l.click()},a.value=this.sm.properties[e]??"",n.appendChild(a);const r=document.createElement("button");r.style.height="100%",r.classList.add("delete"),r.disabled=!0,r.onclick=()=>{this.sm.properties[e]&&this.fileTable[this.sm.properties[e]]&&delete this.fileTable[this.sm.properties[e]],this.sm.properties[e]=void 0,a.value="",r.disabled=!0};const s=be.getIcon("TRASH",12);return r.appendChild(s),n.appendChild(r),n}}class Lo extends ct{app;keyHandler;constructor(e,t=!0){super({title:"Open a Song",width:400,height:320,disableClose:t,win_id:"select_sm_initial"}),this.app=e,this.keyHandler=this.handleKeyEvent.bind(this),window.addEventListener("keydown",this.keyHandler),this.initView(),ie.on("resize",()=>{this.center()})}onClose(){window.removeEventListener("keydown",this.keyHandler)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("open-container"),e.appendChild(t);const n=document.createElement("div");n.classList.add("top-container");const a=document.createElement("div");a.classList.add("separator"),a.style.margin="0.5rem";const r=document.createElement("div");r.classList.add("bottom-container"),t.appendChild(n),t.appendChild(a),t.appendChild(r);const s=document.createElement("button");s.style.display="flex",s.style.flexDirection="column",s.style.padding="0.5rem",s.style.backgroundColor="#414352",s.style.color="white",n.appendChild(s);const o=be.getIcon("UPLOAD",30);s.appendChild(o);const l=document.createElement("div");l.innerText=window.nw?"Open an existing song":"Import a song folder",s.appendChild(l),s.onclick=()=>{if(window.nw){const p=document.createElement("input");p.type="file",p.accept=".sm,.ssc",p.onchange=()=>{this.app.chartManager.loadSM(p.value),this.closeWindow()},p.click()}else this.app.windowManager.openWindow(new or(this.app,{title:"Select an sm/ssc file...",accepted_file_types:[".sm",".ssc"],disableClose:!0,callback:p=>{this.app.chartManager.loadSM(p),this.closeWindow()}}))};const u=document.createElement("button");u.style.display="flex",u.style.flexDirection="column",u.style.padding="0.5rem",u.style.backgroundColor="#506352",u.style.color="white",n.appendChild(u);const f=be.getIcon("PLUS",30);u.appendChild(f);const c=document.createElement("div");c.innerText="New Song",u.appendChild(c),u.onclick=()=>{this.app.windowManager.openWindow(new Xu(this.app))};const d=document.createElement("div");d.innerText="Recently Opened",d.classList.add("title"),r.appendChild(d);const h=document.createElement("div");h.classList.add("recent-selector"),r.appendChild(h),$u.getRecents().then(p=>p.forEach(m=>{const g=document.createElement("div");g.classList.add("recent-item");const y=document.createElement("div");y.classList.add("recent-name"),y.innerText=m.name;const x=document.createElement("div");x.classList.add("recent-path"),x.innerText=m.path,g.appendChild(y),g.appendChild(x),g.onclick=()=>{h.querySelectorAll(".selected").forEach(w=>w.classList.remove("selected")),g.classList.add("selected")},g.ondblclick=()=>{this.app.chartManager.loadSM(m.path),this.closeWindow()},h.appendChild(g)})),this.viewElement.appendChild(e)}handleKeyEvent(e){if(!this.windowElement.classList.contains("focused"))return;const t=this.viewElement.querySelector(".selected");if(t){if(e.code=="ArrowUp"){e.preventDefault(),e.stopImmediatePropagation();const n=t.previousElementSibling;n&&(t.parentElement.querySelectorAll(".selected").forEach(a=>a.classList.remove("selected")),n.classList.add("selected"),$n(n,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}if(e.code=="ArrowDown"){e.preventDefault(),e.stopImmediatePropagation();const n=t.nextElementSibling;n&&(t.parentElement.querySelectorAll(".selected").forEach(a=>a.classList.remove("selected")),n.classList.add("selected"),$n(n,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}}}}const bn={file:{type:"menu",title:"File",options:[{type:"selection",id:"newSong"},{type:"selection",id:"openSong"},{type:"separator"},{type:"selection",id:"previousSong"},{type:"selection",id:"nextSong"},{type:"separator"},{type:"selection",id:"save"},{type:"selection",id:"export"},{type:"separator"},{type:"selection",id:"capture"}]},edit:{type:"menu",title:"Edit",options:[{type:"selection",id:"cut"},{type:"selection",id:"copy"},{type:"selection",id:"paste"},{type:"selection",id:"pasteReplace"},{type:"separator"},{type:"selection",id:"undo"},{type:"selection",id:"redo"},{type:"separator"},{type:"checkbox",id:"mousePlacement",checked:()=>b.chart.mousePlacement}]},view:{type:"menu",title:"View",options:[{type:"dropdown",title:"Cursor",options:[{type:"selection",id:"cursorUp"},{type:"selection",id:"cursorDown"},{type:"separator"},{type:"selection",id:"previousNote"},{type:"selection",id:"nextNote"},{type:"separator"},{type:"selection",id:"previousMeasure"},{type:"selection",id:"nextMeasure"},{type:"separator"},{type:"selection",id:"previousStream"},{type:"selection",id:"nextStream"},{type:"separator"},{type:"selection",id:"jumpChartStart"},{type:"selection",id:"jumpChartEnd"},{type:"separator"},{type:"selection",id:"jumpSongStart"},{type:"selection",id:"jumpSongEnd"},{type:"separator"},{type:"selection",id:"jumpPreviousCandle"},{type:"selection",id:"jumpNextCandle"},{type:"separator"},{type:"selection",id:"jumpPreviousError"},{type:"selection",id:"jumpNextError"}]},{type:"dropdown",title:"Snap",options:[{type:"selection",id:"decreaseSnap"},{type:"selection",id:"increaseSnap"}]},{type:"dropdown",title:"Scroll",options:[{type:"checkbox",id:"XMod",checked:()=>!b.chart.CMod},{type:"checkbox",id:"CMod",checked:()=>b.chart.CMod},{type:"separator"},{type:"selection",id:"increaseScrollSpeed"},{type:"selection",id:"decreaseScrollSpeed"}]},{type:"dropdown",title:"Zoom",options:[{type:"selection",id:"zoomIn"},{type:"selection",id:"zoomOut"},{type:"separator"},{type:"selection",id:"zoomDefault"}]},{type:"separator"},{type:"selection",id:"playMode"},{type:"selection",id:"playModeStart"},{type:"separator"},{type:"selection",id:"recordMode"},{type:"selection",id:"recordModeStart"},{type:"separator"},{type:"checkbox",id:"reverse",checked:()=>b.chart.reverse},{type:"checkbox",id:"hideWarpedArrows",checked:()=>b.chart.hideWarpedArrows},{type:"checkbox",id:"hideFakedArrows",checked:()=>b.chart.hideFakedArrows},{type:"checkbox",id:"doSpeedChanges",checked:()=>b.chart.doSpeedChanges},{type:"separator"},{type:"dropdown",title:"Parity",options:[{type:"checkbox",id:"enableParity",checked:()=>b.chart.parity.enabled},{type:"separator"},{type:"checkbox",id:"showTechNotation",checked:()=>b.chart.parity.showTech},{type:"checkbox",id:"showTechErrors",checked:()=>b.chart.parity.showErrors},{type:"checkbox",id:"showFootHighlights",checked:()=>b.chart.parity.showHighlights},{type:"checkbox",id:"showCandles",checked:()=>b.chart.parity.showCandles},{type:"checkbox",id:"showDancingBot",checked:()=>b.chart.parity.showDancingBot}]}]},chart:{type:"menu",title:"Chart",options:[{type:"selection",id:"openChart"},{type:"separator"},{type:"selection",id:"previousChart"},{type:"selection",id:"nextChart"},{type:"separator"},{type:"selection",id:"songProperties"},{type:"separator"},{type:"selection",id:"timingDataRow"}]},selection:{type:"menu",title:"Selection",options:[{type:"dropdown",title:"Convert",options:[{type:"selection",id:"convertHoldsRolls"},{type:"selection",id:"convertRollsHolds"},{type:"selection",id:"swapHoldsRolls"},{type:"separator"},{type:"selection",id:"convertHoldsTaps"},{type:"selection",id:"convertTapsMines"},{type:"selection",id:"convertTapsLifts"},{type:"selection",id:"convertTapsFakes"}]},{type:"dropdown",title:"Mirror",options:[{type:"selection",id:"mirrorHorizontally"},{type:"selection",id:"mirrorVertically"},{type:"selection",id:"mirrorBoth"}]},{type:"dropdown",title:"Stretch",options:[{type:"selection",id:"expand2to1"},{type:"selection",id:"expand3to2"},{type:"selection",id:"expand4to3"},{type:"separator"},{type:"selection",id:"compress1to2"},{type:"selection",id:"compress2to3"},{type:"selection",id:"compress3to4"}]},{type:"dropdown",title:"Shift",options:[{type:"dropdown",title:"Up",options:[{type:"selection",id:"shiftUp4m"},{type:"selection",id:"shiftUp2m"},{type:"selection",id:"shiftUp1m"},{type:"selection",id:"shiftUp4th"},{type:"selection",id:"shiftUp8th"},{type:"selection",id:"shiftUp12th"},{type:"selection",id:"shiftUp16th"},{type:"selection",id:"shiftUp24th"},{type:"selection",id:"shiftUp32nd"},{type:"selection",id:"shiftUp48th"},{type:"selection",id:"shiftUp64th"},{type:"selection",id:"shiftUp96th"},{type:"selection",id:"shiftUp192nd"}]},{type:"dropdown",title:"Down",options:[{type:"selection",id:"shiftDown4m"},{type:"selection",id:"shiftDown2m"},{type:"selection",id:"shiftDown1m"},{type:"selection",id:"shiftDown4th"},{type:"selection",id:"shiftDown8th"},{type:"selection",id:"shiftDown12th"},{type:"selection",id:"shiftDown16th"},{type:"selection",id:"shiftDown24th"},{type:"selection",id:"shiftDown32nd"},{type:"selection",id:"shiftDown48th"},{type:"selection",id:"shiftDown64th"},{type:"selection",id:"shiftDown96th"},{type:"selection",id:"shiftDown192nd"}]}]},{type:"dropdown",title:"Quantize",options:[{type:"selection",id:"quantize4th"},{type:"selection",id:"quantize8th"},{type:"selection",id:"quantize12th"},{type:"selection",id:"quantize16th"},{type:"selection",id:"quantize24th"},{type:"selection",id:"quantize32nd"},{type:"selection",id:"quantize48th"},{type:"selection",id:"quantize64th"},{type:"selection",id:"quantize96th"}]},{type:"dropdown",title:"Timing",options:[{type:"selection",id:"convertSTOPS"},{type:"selection",id:"convertWARPS"},{type:"selection",id:"convertFAKES"},{type:"selection",id:"convertDELAYS"}]},{type:"dropdown",title:"Parity",options:[{type:"selection",id:"parityNone"},{type:"selection",id:"parityLeft"},{type:"selection",id:"parityRight"}]},{type:"separator"},{type:"selection",id:"setSongPreview"},{type:"separator"},{type:"selection",id:"exportNotedata"},{type:"separator"},{type:"selection",id:"selectBeforeCursor"},{type:"selection",id:"selectAfterCursor"},{type:"selection",id:"selectAll"}]},audio:{type:"menu",title:"Audio",options:[{type:"selection",id:"detectSync"},{type:"separator"},{type:"checkbox",id:"assistTick",checked:()=>b.audio.assistTick&&fe.assist},{type:"checkbox",id:"metronome",checked:()=>b.audio.metronome&&fe.assist},{type:"separator"},{type:"dropdown",title:()=>"Master Volume ("+Math.round(b.audio.masterVolume*100)+"%)",options:[{type:"selection",id:"volumeUp"},{type:"selection",id:"volumeDown"}]},{type:"dropdown",title:()=>"Song Volume ("+Math.round(b.audio.songVolume*100)+"%)",options:[{type:"selection",id:"songVolumeUp"},{type:"selection",id:"songVolumeDown"}]},{type:"dropdown",title:()=>"Effect Volume ("+Math.round(b.audio.soundEffectVolume*100)+"%)",options:[{type:"selection",id:"effectvolumeUp"},{type:"selection",id:"effectvolumeDown"}]},{type:"dropdown",title:()=>"Playback rate ("+Math.round(b.audio.rate*100)+"%)",options:[{type:"selection",id:"rateUp"},{type:"selection",id:"rateDown"},{type:"separator"},{type:"selection",id:"rateDefault"}]},{type:"separator"},{type:"selection",id:"showEq"}]},preferences:{type:"menu",title:"Preferences",options:[{type:"selection",id:"options"},{type:"selection",id:"themes"},{type:"selection",id:"keybinds"},{type:"selection",id:"gameplayKeybinds"},{type:"selection",id:"noteskinWindow"}]},help:{type:"menu",title:"Help",options:[{type:"selection",id:"about"},{type:"selection",id:"openGuide"},{type:"selection",id:"openChangelog"}]}},wc=["cut","copy","paste","pasteReplace"],vc={edit:[{ids:["delete"],after:"redo"},{ids:["toggleEditTiming","toggleAddTiming","previousNoteType","nextNoteType","noteTypeTap","noteTypeMine","noteTypeFake","noteTypeLift","quant4","quant8","quant12","quant16","quant24","quant32","quant48","quant64","quant96","quant192"],after:"mousePlacement"}],view:[{ids:["playback","selectRegion"]}],debug:[{ids:["showFPSCounter","showDebugTimers"]}]};class ci extends ct{static GROUPS;app;observer;searchDropdown;conflictMap=this.calculateConflicts();constructor(e){super({title:"Keybind Options",width:600,height:400,disableClose:!1,win_id:"keybind_options",blocking:!1}),this.app=e,ci.GROUPS||(ci.GROUPS=ci.createGroups()),this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-container");const n=document.createElement("div");n.classList.add("pref-search");const a=document.createElement("input");a.classList.add("pref-search-bar"),a.type="text",a.placeholder="Search for a keybind...",a.oninput=()=>{o.replaceChildren(...this.createSections(a.value)),l.replaceChildren(...this.createOptions(a.value))};const r=gi.create(["Name","Key"],"Name");r.onChange(()=>{o.replaceChildren(...this.createSections(a.value)),l.replaceChildren(...this.createOptions(a.value))}),this.searchDropdown=r,n.replaceChildren(a,r.view);const s=document.createElement("div");s.classList.add("pref-scrollers");const o=document.createElement("div");o.classList.add("pref-section-scroller");const l=document.createElement("div");l.classList.add("pref-option-scroller"),s.replaceChildren(o,l),this.observer=new IntersectionObserver(u=>{u.forEach(f=>{const c=f.target.dataset.id,d=o.querySelector(`.pref-section[data-id=${c}]`);d&&(f.intersectionRatio>0?d.classList.add("selected"):d.classList.remove("selected"))})},{}),t.replaceChildren(n,s),o.replaceChildren(...this.createSections()),l.replaceChildren(...this.createOptions()),e.appendChild(t),this.viewElement.appendChild(e)}createSections(e=""){return Object.keys(ci.GROUPS).filter(t=>ci.GROUPS[t].some(n=>this.filterID(e,n))).map(t=>this.createEmptySection(bn[t]?.title??Ro(t),t))}createOptions(e=""){return Object.keys(ci.GROUPS).filter(t=>ci.GROUPS[t].some(n=>this.filterID(e,n))).map(t=>{const n=ci.GROUPS[t].filter(s=>this.filterID(e,s)).map(s=>this.createKeybindItem(s)),a=document.createElement("div");a.classList.add("pref-group"),a.dataset.id=t;const r=document.createElement("div");return r.classList.add("pref-group-label"),r.innerText=bn[t]?.title??Ro(t),a.replaceChildren(r,...n),this.observer.observe(a),a})}static createGroups(){const e=Object.keys($e),t={};return Object.keys(bn).forEach(n=>{t[n]=this.expandMenubarOptions(bn[n]).map(a=>{const r=e.indexOf(a);return r!=-1&&e.splice(r,1),a}).filter(a=>!wc.includes(a))}),Object.keys(vc).forEach(n=>{t[n]===void 0&&(t[n]=[]),vc[n].forEach(a=>{let r=0;if(a.after){const s=t[n].findIndex(o=>a.after==o)+1;s!=0&&(r=s)}t[n].splice(r,0,...a.ids),a.ids.forEach(s=>{const o=e.indexOf(s);o!=-1&&e.splice(o,1)})})}),wc.forEach(n=>{const a=e.indexOf(n);a!=-1&&e.splice(a,1)}),e.length>0&&(console.warn("Missing keybinds not shown:"),console.warn(e)),t}filterID(e,t){if((this.searchDropdown?.value??"Name")=="Name")return($e[t].bindLabel??$e[t].label).toLowerCase().includes(e.toLowerCase());{const n=Ae.getCombosForKeybind(t);if(n.some(r=>r.key.toLowerCase().includes(e.toLowerCase()))||n.some(r=>(Qu[r.key]??r.key).toLowerCase().includes(e.toLowerCase())))return!0;let a=e.split(" ").map(r=>r.toLowerCase());return n.some(r=>(a.includes("shift")||a.includes("⇧"))&&!r.mods.includes(On.SHIFT)||(a.includes("ctrl")||a.includes("control")||a.includes("⌃"))&&!r.mods.includes(On.CTRL)||(a.includes("meta")||a.includes("cmd")||a.includes("command")||a.includes("⌘"))&&!r.mods.includes(On.META)||(a.includes("alt")||a.includes("⌥"))&&!r.mods.includes(On.ALT)?!1:(a=a.filter(s=>!["shift","ctrl","control","meta","cmd","command","alt","⇧","⌃","⌘","⌥",""].includes(s)),a.length==0||a.length==1&&r.key.toLowerCase().includes(a[0])))}}static expandMenubarOptions(e){switch(e.type){case"menu":case"dropdown":return e.options.map(t=>this.expandMenubarOptions(t)).flat();case"selection":case"checkbox":return[e.id];case"separator":return[]}}createEmptySection(e,t){const n=document.createElement("div");return n.classList.add("pref-section"),n.dataset.id=t,n.innerText=e,n.onclick=()=>{n.parentElement.parentElement.querySelector(`.pref-group[data-id=${t}]`).scrollIntoView()},n}createKeybindItem(e){const t=document.createElement("div");t.classList.add("pref-keybind"),t.dataset.id=e,t.onclick=s=>{s.target.classList.contains("pref-keybind-combo")||t.querySelector(".icon")?.contains(s.target)||this.app.windowManager.openWindow(new An(this.app,!0,o=>{Ae.setKeybind(e,o),this.conflictMap=this.calculateConflicts(),t.replaceWith(this.createKeybindItem(e))},o=>{const l=this.conflictMap.get(Ae.getComboString(o))?.map(u=>u[0]).map(u=>$e[u].bindLabel??$e[u].label)??[];return l.includes(e)?"self":l}))};const n=document.createElement("div");n.classList.add("pref-keybind-label"),n.innerText=$e[e].bindLabel??$e[e].label;const a=be.getIcon("REVERT");a.style.width="0.75rem",a.addEventListener("click",()=>{Ae.revertKeybind(e),this.conflictMap=this.calculateConflicts(),t.replaceWith(this.createKeybindItem(e))}),a.style.display=Ae.checkIsDefault(e)?"none":"block";const r=document.createElement("div");return r.classList.add("pref-keybind-combos"),r.replaceChildren(...Ae.getCombosForKeybind(e).map(s=>{const o=document.createElement("button");return o.classList.add("pref-keybind-combo"),o.innerText=Ae.getComboString(s),this.conflictMap.get(Ae.getComboString(s)).length>1&&o.classList.add("conflict"),o.onclick=()=>{Ae.removeKeybind(e,s),this.conflictMap=this.calculateConflicts(),t.replaceWith(this.createKeybindItem(e))},o})),t.replaceChildren(n,a,r),t}calculateConflicts(){const e=new Map;Object.keys($e).forEach(t=>{Ae.getCombosForKeybind(t).forEach((n,a)=>{const r=Ae.getComboString(n);e.has(r)||e.set(r,[]),e.get(r).push([t,a])})}),[...this.viewElement.querySelectorAll(".pref-keybind-combo.conflict")].forEach(t=>t.classList.remove("conflict"));for(const t of e.values())t.length!=1&&t.forEach(n=>{const a=this.viewElement.querySelector(`.pref-keybind[data-id=${n[0]}] .pref-keybind-combos`);a?.children[n[1]]&&a.children[n[1]].classList.add("conflict")});return e}onClose(){this.observer?.disconnect()}}class it{static noteskins=new Map;static register(e){for(const t of new Set(e.gameTypes))it.noteskins.has(t)||it.noteskins.set(t,new Map),it.noteskins.get(t).set(e.id,e)}static async getNoteskin(e,t){const n=this.noteskins.get(e.id);if(!n||n.size==0)return;const a=n.get(t)??[...n.values()][0];return n.get(t)||ce.createFormatted(`Couldn't find the noteskin ${t}!`,"warn"),await a.load()}static getNoteskinData(e,t){const n=this.noteskins.get(e.id);return!n||n.size==0?void 0:n.get(t)??[...n.values()][0]}static getNoteskins(){return this.noteskins}static getPreviewUrl(e,t){return this.getNoteskinData(e,t).preview}}it.register({id:"default",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-CJHqFqNN.js");return{default:i}},__vite__mapDeps([7,1,2,8]))).default,preview:new URL("/smeditor/assets/preview-OxO8T-xD.png",import.meta.url).href,title:"Scalable",subtitle:"Pete-Lawrence"});it.register({id:"cf-chrome",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-BEdgk8lC.js");return{default:i}},__vite__mapDeps([9,1,2,8]))).default,preview:new URL("/smeditor/assets/preview-Bd1omMHV.png",import.meta.url).href,title:"CF_CHROME",subtitle:"Pete-Lawrence"});it.register({id:"ddr-note",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-CDGYbrQq.js");return{default:i}},__vite__mapDeps([10,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-DdYrG22o.png",import.meta.url).href,title:"DDR-Note",subtitle:"Pete-Lawrence"});it.register({id:"ddr-note-itg",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-B-yBWlEi.js");return{default:i}},__vite__mapDeps([12,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-mEgpRzfG.png",import.meta.url).href,title:"DDR-Note (ITG quants)",subtitle:"Pete-Lawrence"});it.register({id:"ddr-rainbow",gameTypes:["dance-single","dance-double","dance-couple"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-DCgCcrWp.js");return{default:i}},__vite__mapDeps([13,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-CSm_jZ6l.png",import.meta.url).href,title:"DDR-Rainbow",subtitle:"LemmaEOF"});it.register({id:"ddr-rainbow-itg",gameTypes:["dance-single","dance-double","dance-couple"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-DaQM8iCT.js");return{default:i}},__vite__mapDeps([14,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-BIggbhNp.png",import.meta.url).href,title:"DDR-Rainbow (ITG quants)",subtitle:"LemmaEOF"});it.register({id:"metal",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-DX8LI-Fr.js");return{default:i}},__vite__mapDeps([15,1,2,8]))).default,preview:new URL("/smeditor/assets/preview-CGpd3Xps.png",import.meta.url).href,title:"Metal",subtitle:"Pete-Lawrence"});it.register({id:"pastel",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-DJlT-N5N.js");return{default:i}},__vite__mapDeps([16,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-D-gUhvzF.png",import.meta.url).href,title:"Pastel",subtitle:"halcyoniix"});it.register({id:"dividebyzero",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-xp7YX-RZ.js");return{default:i}},__vite__mapDeps([17,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-BveM7vOk.png",import.meta.url).href,title:"DivideByZero",subtitle:"MinaciousGrace"});it.register({id:"subtractbyzero",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-CaUIteaG.js");return{default:i}},__vite__mapDeps([18,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-0QJpt-dz.png",import.meta.url).href,title:"SubtractByZero",subtitle:"qwertyzoro/Vague"});it.register({id:"sm4",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-Cx66M9Hr.js");return{default:i}},__vite__mapDeps([19,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-B57yH2sm.png",import.meta.url).href,title:"SM4",subtitle:"from SM4"});it.register({id:"sm4-bold",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-BFi-3IfC.js");return{default:i}},__vite__mapDeps([20,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-WAGM24LC.png",import.meta.url).href,title:"SM4 Bold",subtitle:"from SM4"});it.register({id:"starlight-vivid",gameTypes:["dance-single","dance-double","dance-couple"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-Bxv7npX8.js");return{default:i}},__vite__mapDeps([21,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-Co7w1-gB.png",import.meta.url).href,title:"SLNEXXT-vivid",subtitle:"from STARLiGHT-NEXXT"});it.register({id:"default",gameTypes:["pump-single","pump-double","pump-couple","pump-versus","pump-halfdouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-CiTbvy-T.js");return{default:i}},__vite__mapDeps([22,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-ChWRgpap.png",import.meta.url).href,title:"Fiesta"});it.register({id:"fourv2",gameTypes:["pump-single","pump-double","pump-couple","pump-versus","pump-halfdouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-DwXD4suP.js");return{default:i}},__vite__mapDeps([23,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-BC8deddd.png",import.meta.url).href,title:"FourV2",subtitle:"Jousway"});it.register({id:"prime",gameTypes:["pump-single","pump-double","pump-couple","pump-versus","pump-halfdouble"],load:async()=>(await We(async()=>{const{default:i}=await import("./Noteskin-DhuklZgS.js");return{default:i}},__vite__mapDeps([24,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-CIFre-Xk.png",import.meta.url).href,title:"Prime"});const ym="/smeditor/assets/preview-CAPSxB0Y.png";class wm extends ct{app;grid;lastGameType=null;constructor(e){super({title:"Noteskin Selection",width:600,height:400,disableClose:!1,win_id:"noteskin-selection",blocking:!1}),this.app=e,this.initView(),this.loadGrid(),ie.on("chartLoaded",()=>{const t=e.chartManager.loadedChart.gameType.id;this.lastGameType!=t&&this.loadGrid()})}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("input");t.classList.add("pref-search-bar"),t.type="text",t.placeholder="Search for a noteskin...",t.oninput=()=>{this.filterGrid(t.value)};const n=document.createElement("div");n.classList.add("noteskin-grid"),this.grid=n,e.replaceChildren(t,n),this.viewElement.appendChild(e)}loadGrid(){if(this.grid.replaceChildren(),!this.app.chartManager.loadedChart)return;const e=this.app.chartManager.loadedChart.gameType;this.lastGameType=e.id;const t=it.getNoteskins().get(e.id);if(t)for(const[n,a]of t.entries()){const r=document.createElement("div"),s=document.createElement("img"),o=document.createElement("div"),l=document.createElement("div"),u=document.createElement("div");r.classList.add("noteskin-cell"),o.classList.add("noteskin-label"),l.classList.add("noteskin-title"),u.classList.add("noteskin-subtitle"),l.innerText=a.title??n,u.innerText=a.subtitle??"",s.src=it.getPreviewUrl(e,n),s.onerror=()=>{s.src=ym},r.replaceChildren(s,o),o.replaceChildren(l,u),this.grid.appendChild(r),n==b.chart.noteskin.name&&(r.classList.add("selected"),setTimeout(()=>{r.scrollIntoView({behavior:b.general.smoothAnimations?"smooth":"instant",block:"center"})})),r.dataset.id=n,r.dataset.title=a.title??"",r.dataset.subtitle=a.subtitle??"",r.onclick=()=>{b.chart.noteskin.name!=n&&(this.app.chartManager.chartView?.swapNoteskin(n),this.removeAllSelections(),r.classList.add("selected"))}}}removeAllSelections(){[...this.grid.querySelectorAll(".selected")].forEach(e=>e.classList.remove("selected"))}filterGrid(e){[...this.grid.children].forEach(t=>{if(!(t instanceof HTMLDivElement))return;const n=t,a=this.containsQuery(e,n.dataset.id)||this.containsQuery(e,n.dataset.title)||this.containsQuery(e,n.dataset.subtitle);n.style.display=a?"":"none"})}containsQuery(e,t){return t?t.toLowerCase().includes(e.trim().toLowerCase()):!1}}class vm extends ct{app;metronomeInterval;startTime;me_high=new Ps.Howl({src:Zc,volume:b.audio.soundEffectVolume});me_low=new Ps.Howl({src:Qc,volume:b.audio.soundEffectVolume});tickLines=[];resultLines=[];previousOffsets=[];keyHandler;constructor(e){super({title:"Offset Adjuster",width:300,height:200,win_id:"offset",blocking:!0}),this.app=e,this.initView(),this.startTime=performance.now();let t=this.startTime+500;this.tickLines.push({time:t+500,beat:0}),this.tickLines.push({time:t+500*2,beat:1}),this.tickLines.push({time:t+500*3,beat:2}),this.tickLines.push({time:t+500*4,beat:3});let n=0;this.metronomeInterval=setInterval(()=>{const a=performance.now();if(a-t>500){for(t=a,(n%4==0?this.me_high:this.me_low).play();this.tickLines[0]?.time+1e3<a;)this.tickLines.shift();this.tickLines.push({time:t+500*4,beat:n+4}),n++}this.resultLines=this.resultLines.filter(r=>a-r.startTime<8e3)},5),this.keyHandler=a=>{if(a.code.startsWith("Digit")||a.code.startsWith("Key")||a.code=="Space"){let r=this.tickLines[0];const s=performance.now();for(const l of this.tickLines)if(s-l.time+b.play.offset*1e3<300){r=l;break}a.preventDefault();const o=s-r.time+b.play.offset*1e3;o>-300&&(this.tickLines.splice(this.tickLines.indexOf(r),1),this.resultLines.push({startTime:performance.now(),offset:o}),this.previousOffsets.push(o),this.previousOffsets.length==16&&(zc(this.previousOffsets)<70&&(b.play.offset-=ja(this.previousOffsets)/1e3),this.previousOffsets=[]))}},window.addEventListener("keydown",this.keyHandler)}initView(){this.viewElement.replaceChildren();const e=document.createElement("canvas");this.viewElement.appendChild(e);const t=this.drawEQ(e);requestAnimationFrame(t)}drawEQ(e){const t=e.getContext("2d");t.canvas.width=250,t.canvas.height=100;const n=()=>{t.fillStyle="rgba(0, 0, 0, 1)",t.fillRect(0,0,e.width,e.height),t.fillStyle="rgb(255, 255, 255)",t.fillRect(e.width/2-1,8,2,e.height-16);const a=performance.now();for(const r of this.resultLines){t.fillStyle="rgba(255, 255, 255, 1)";const s=Math.min(1,4-(a-r.startTime)/2e3);if(r.offset<0&&(t.fillStyle=`rgba(160, ${Ze(160,0,-r.offset/250)}, ${Ze(160,0,-r.offset/250)}, ${s})`),r.offset>0&&(t.fillStyle=`rgba(${Ze(160,0,r.offset/250)}, ${Ze(160,0,r.offset/250)}, 160, ${s})`),t.fillRect(e.width/2-.5+r.offset/4,12,1,e.height-24),a-r.startTime<250){const o=(a-r.startTime)/250;t.globalAlpha=1-o,t.fillRect(e.width/2-.5-o*3+r.offset/4,12-o*10,1+o*6,e.height-24+o*20)}t.globalAlpha=1}for(const r of this.tickLines){const s=r.time-a-b.play.offset*1e3;t.fillStyle="rgba(255, 255, 255, 0.8)",r.beat%4!=0?t.fillRect(e.width/2-1-s/4,12,2,e.height-24):t.fillRect(e.width/2-2-s/4,12,4,e.height-24)}e.closest("#windows")&&requestAnimationFrame(n)};return n}onClose(){clearInterval(this.metronomeInterval),window.removeEventListener("keydown",this.keyHandler)}}class xm extends ct{app;changeHandler=()=>this.initView();constructor(e){super({title:"Song Properties",width:450,height:486,disableClose:!1,win_id:"sm_properties",blocking:!1}),this.app=e,this.initView(),ie.on("smLoaded",this.changeHandler),ie.on("undo",this.changeHandler),ie.on("redo",this.changeHandler)}onClose(){ie.off("smLoaded",this.changeHandler),ie.off("undo",this.changeHandler),ie.off("redo",this.changeHandler)}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("sm-properties");const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("label"),t.innerText="Apply to",Yu.forEach(n=>{const a=document.createElement("div");a.classList.add("sm-container");const r=document.createElement("div");r.classList.add("sm-title"),r.innerText=n.title;const s=document.createElement("div");s.classList.add("property-grid"),n.items.forEach(o=>{const l=document.createElement("div");l.classList.add("label"),l.innerText=o.title,s.appendChild(l),s.appendChild(Ku(this.app,this.app.chartManager.loadedSM,Mt.instance,o))}),a.appendChild(r),a.appendChild(s),e.appendChild(a)}),this.viewElement.appendChild(e)}}var Cs,xc;function Em(){if(xc)return Cs;xc=1,Cs=s;var i=8192,e=65536,t=new ArrayBuffer(e*4),n=new Float64Array(t,e,i),a=new Float64Array(t,e*2,i/2),r=o({Math,Float64Array},null,t);function s(l){if(!l)throw Error("Input data is not provided, pass an array.");var u=l.length;if(u>i)throw Error("Input length is too big, must be under "+i);var f=Math.floor(Math.log(u)/Math.LN2);if(Math.pow(2,f)!==u)throw Error("Invalid array size, must be a power of 2.");return n.set(l),r(u,f),a.subarray(0,u/2)}function o(l,u,f){var c=6.283185307179586,d=l.Math.sqrt,h=l.Math.sin,p=l.Math.cos,m=l.Math.abs,g=l.Math.SQRT1_2,y=l.Math.imul,x=new l.Float64Array(f),w=new l.Float64Array(f),C=8192,_=16384;function F(O,H){O=O|0,H=H|0;var Y=0,re=0,M=0,R=0,v=0,S=0,$=0,L=0,G=0,V=0,J=0,N=0,P=0,ae=0,ne=0,ee=0,Me=0,Ne=0,_e=0,ve=0,Le=0,Be=0,st=0,ot=0,E=0,X=0,q=0,T=0,k=0,z=0,j=0,Q=0;for(Y=O>>>1,M=2/+(O|0),D(O),z=0,Q=4;(z|0)<(O|0);Q=y(Q,4)){for(j=z;(j|0)<(O|0);j=j+Q|0)ve=w[j<<3>>3]-w[j+1<<3>>3],w[j<<3>>3]=w[j<<3>>3]+w[j+1<<3>>3],w[j+1<<3>>3]=ve;z=y(2,Q-1)}for(R=2,$=O>>>1;$=$>>>1;){z=0,R=R<<1,Q=R<<1,v=R>>>2,S=R>>>3;do{if((v|0)!=1)for(j=z;(j|0)<(O|0);j=j+Q|0)N=j,P=N+v|0,ae=P+v|0,ne=ae+v|0,L=w[ae<<3>>3]+w[ne<<3>>3],w[ne<<3>>3]=w[ne<<3>>3]-w[ae<<3>>3],w[ae<<3>>3]=w[N<<3>>3]-L,w[N<<3>>3]=w[N<<3>>3]+L,N=N+S|0,P=P+S|0,ae=ae+S|0,ne=ne+S|0,L=w[ae<<3>>3]+w[ne<<3>>3],G=w[ae<<3>>3]-w[ne<<3>>3],L=-L*g,G=G*g,ve=+w[P<<3>>3],w[ne<<3>>3]=L+ve,w[ae<<3>>3]=L-ve,w[P<<3>>3]=w[N<<3>>3]-G,w[N<<3>>3]=w[N<<3>>3]+G;else for(j=z;(j|0)<(O|0);j=j+Q|0)N=j,P=N+v|0,ae=P+v|0,ne=ae+v|0,L=w[ae<<3>>3]+w[ne<<3>>3],w[ne<<3>>3]=w[ne<<3>>3]-w[ae<<3>>3],w[ae<<3>>3]=w[N<<3>>3]-L,w[N<<3>>3]=w[N<<3>>3]+L;z=(Q<<1)-R|0,Q=Q<<2}while((z|0)<(O|0));for(E=c/+(R|0),re=1;(re|0)<(S|0);re=re+1|0){X=+(re|0)*E,Be=h(X),Le=p(X),st=4*Le*(Le*Le-.75),ot=4*Be*(.75-Be*Be),z=0,Q=R<<1;do{for(j=z;(j|0)<(O|0);j=j+Q|0)N=j+re|0,P=N+v|0,ae=P+v|0,ne=ae+v|0,ee=j+v-re|0,Me=ee+v|0,Ne=Me+v|0,_e=Ne+v|0,G=w[Ne<<3>>3]*Le-w[ae<<3>>3]*Be,L=w[Ne<<3>>3]*Be+w[ae<<3>>3]*Le,J=w[_e<<3>>3]*st-w[ne<<3>>3]*ot,V=w[_e<<3>>3]*ot+w[ne<<3>>3]*st,ve=G-J,G=G+J,J=ve,w[_e<<3>>3]=G+w[Me<<3>>3],w[ae<<3>>3]=G-w[Me<<3>>3],ve=V-L,L=L+V,V=ve,w[ne<<3>>3]=V+w[P<<3>>3],w[Ne<<3>>3]=V-w[P<<3>>3],w[Me<<3>>3]=w[N<<3>>3]-L,w[N<<3>>3]=w[N<<3>>3]+L,w[P<<3>>3]=J+w[ee<<3>>3],w[ee<<3>>3]=w[ee<<3>>3]-J;z=(Q<<1)-R|0,Q=Q<<2}while((z|0)<(O|0))}}for(;Y=Y-1|0;)q=+w[Y<<3>>3],T=+w[O-Y-1<<3>>3],k=M*d(q*q+T*T),x[_+Y<<3>>3]=k;x[_+0<<3>>3]=m(M*w[0])}function D(O){O=O|0;var H=0,Y=0,re=1,M=0,R=0;H=O>>>1,Y=O-1|0,w[0]=x[C+0<<3>>3];do{for(M=M+H|0,w[re<<3>>3]=x[C+M<<3>>3],w[M<<3>>3]=x[C+re<<3>>3],re=re+1|0,R=H<<1;R=R>>1,((M=M^R)&R)==0;);(M|0)>=(re|0)&&(w[re<<3>>3]=x[C+M<<3>>3],w[M<<3>>3]=x[C+re<<3>>3],w[Y-re<<3>>3]=x[C+Y-M<<3>>3],w[Y-M<<3>>3]=x[C+Y-re<<3>>3]),re=re+1|0}while((re|0)<(H|0));w[Y<<3>>3]=x[C+Y<<3>>3]}return F}return Cs}var Cm=Em();const Ec=oa(Cm),zt=800,et=200,_s=3,Ln=125,Dn=250,xa=3,_m=.02,cn=6,As=800,Cc=15,Vt=32768,ks=[{frequency:20,weight:.4006009013520281},{frequency:25,weight:.4258037044922291},{frequency:31.5,weight:.4536690484291709},{frequency:40,weight:.4840856831659204},{frequency:50,weight:.5142710208279764},{frequency:63,weight:.5473453749315819},{frequency:80,weight:.5841121495327103},{frequency:100,weight:.6214074879602299},{frequency:125,weight:.6601749463607856},{frequency:160,weight:.7054673721340388},{frequency:200,weight:.7489234225800412},{frequency:250,weight:.7936507936507937},{frequency:315,weight:.8406893652795292},{frequency:400,weight:.889284126278346},{frequency:500,weight:.9291521486643438},{frequency:630,weight:.9675858732462506},{frequency:800,weight:.9985022466300548},{frequency:1e3,weight:.9997500624843789},{frequency:1250,weight:.9564801530368244},{frequency:1600,weight:.9409550693954364},{frequency:2e3,weight:1.0196278358399185},{frequency:2500,weight:1.0955902492467817},{frequency:3150,weight:1.1232799775344005},{frequency:4e3,weight:1.0914051841746248},{frequency:5e3,weight:.9997500624843789},{frequency:6300,weight:.8727907484180668},{frequency:8e3,weight:.7722007722007722},{frequency:1e4,weight:.7369196757553427},{frequency:12500,weight:.7768498737618955},{frequency:16e3,weight:.7698229407236336},{frequency:2e4,weight:.4311738708634257},{frequency:22550,weight:.2},{frequency:25e3,weight:0}];class Zu extends ct{app;onAudioLoad=this.reset.bind(this);onResize=this.resize.bind(this);windowStep=512;fftSize=1024;tempoFftSize=4096;tempoStep=2;monoAudioData;audioLength=0;sampleRate=44100;tempogram=[];tempogramGroups=[];spectrogram=[];spectrogramDifference=[];noveltyCurve=[];noveltyCurveIsolated=[];spectrogramCanvases=[];lowestFinishedBlock=0;numRenderedBlocks=0;peaks=[];_threshold=.3;spectroHeights=[];spectroWeights=[];placeNotesSelectionButton;toggleButton;resetButton;onsetResults;offsetTableLabel;offsetRows=[];bpmRows=[];covers=[];doAnalysis=!1;lastSecond=0;constructor(e){super({title:"Detect Audio Sync",width:400,height:450,win_id:"detect-sync"}),this.app=e,this.initView(),this.reset(),ie.on("audioLoaded",this.onAudioLoad),ie.on("resize",this.onResize)}onClose(){ie.off("audioLoaded",this.onAudioLoad),ie.off("resize",this.onResize),this.app.chartManager.chartAudio.offLoad(this.onAudioLoad)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("sync-container"),e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center";const t=document.createElement("canvas");t.style.width=`${zt/2/16}rem`,t.style.height=`${et/16}rem`;const n=document.createElement("div");n.classList.add("sync-tab-container");const a=document.createElement("div");a.classList.add("sync-tab-option","active"),a.innerText="Analysis Options";const r=document.createElement("div");r.classList.add("sync-tab-option"),r.innerText="Tempo Results";const s=document.createElement("div");s.classList.add("sync-tab-option"),s.innerText="Onset Results",n.replaceChildren(a,r,s),[...n.children].forEach((m,g)=>{m.onclick=()=>{const y=parseFloat(getComputedStyle(document.body.parentElement).fontSize);l.scrollLeft=370*y/16*g,n.querySelectorAll(".active").forEach(x=>x.classList.remove("active")),m.classList.add("active")}});const o=document.createElement("div");o.classList.add("sync-tab-view");const l=document.createElement("div");l.classList.add("sync-tab-scroller");const u=this.createOptionsView(),f=this.createTempoView(),c=this.createOnsetsView(),d=(m,g)=>{const y=document.createElement("div");return y.classList.add("sync-cover"),y.innerText=m,y.style.left=`${g*370/16}rem`,y};this.covers=[d("Clear analysis results to edit",0),d("Start analysis to view",1),d("Start analysis to view",2)],o.appendChild(l),l.replaceChildren(u,this.covers[0],f,this.covers[1],c,this.covers[2]);const h=document.createElement("div");h.classList.add("sync-bottom-container"),this.resetButton=document.createElement("button"),this.resetButton.classList.add("delete"),this.resetButton.innerText="Clear results",this.resetButton.style.width="7.5rem",this.resetButton.disabled=!0,this.resetButton.onclick=()=>{this.resetButton.disabled=!0,a.click(),this.reset()},this.toggleButton=document.createElement("button"),this.toggleButton.innerText="Start analyzing",this.toggleButton.style.width="12.5rem",this.toggleButton.onclick=()=>{this.doAnalysis||r.click(),this.doAnalysis=!this.doAnalysis,this.toggleButton.innerText=this.doAnalysis?"Stop analyzing":this.hasData()?"Resume analyzing":"Start analyzing",this.resetButton.disabled=this.doAnalysis},h.replaceChildren(this.toggleButton,this.resetButton),e.replaceChildren(t,n,o,h),this.viewElement.appendChild(e);const p=this.windowLoop(t);requestAnimationFrame(p)}resize(){const e=this.viewElement.querySelector(".sync-tab-option.active");if(!e)return;const t=[...e.parentElement.children].indexOf(e);if(t<0)return;const n=parseFloat(getComputedStyle(document.body.parentElement).fontSize);this.viewElement.querySelector(".sync-tab-scroller").scrollLeft=370*n/16*t}createOptionsView(){const e=document.createElement("div");e.style.display="flex",e.style.position="relative",e.style.flexDirection="column",e.style.gap="0.2rem",e.style.height="100%";const t=(u,f,c)=>{const d=document.createElement("div");d.style.display="flex",d.style.flexDirection="row",d.style.justifyContent="space-between",d.style.alignItems="center";const h=document.createElement("div");return h.classList.add("label"),h.innerText=u,d.replaceChildren(h,f),Xe(d,{content:c}),d},n=document.createElement("div");n.innerText="Onsets",n.style.fontWeight="600";const a=Fi.create({min:Math.log2(128),max:Math.log2(8192),step:1,value:Math.log2(this.fftSize),transformer:u=>2**u,onChange:u=>{this.fftSize=2**u,this.windowStep>this.fftSize&&(this.windowStep=this.fftSize,r.setValue(u)),this.reset()}}),r=Fi.create({min:Math.log2(128),max:Math.log2(8192),step:1,value:Math.log2(this.windowStep),transformer:u=>2**u,onChange:u=>{this.windowStep=2**u,this.windowStep>this.fftSize&&(this.windowStep=this.fftSize,r.setValue(Math.log2(this.fftSize))),this.reset()}}),s=document.createElement("div");s.innerText="Tempo",s.style.fontWeight="600",s.style.marginTop="1rem";const o=Fi.create({min:Math.log2(128),max:Math.log2(8192),step:1,value:Math.log2(this.tempoFftSize),transformer:u=>2**u,onChange:u=>{this.tempoStep=2**u,this.tempoStep>this.tempoFftSize&&(this.tempoStep=this.tempoFftSize,l.setValue(u)),this.reset()}}),l=Fi.create({min:Math.log2(1),max:Math.log2(1024),step:1,value:Math.log2(this.tempoStep),transformer:u=>2**u,onChange:u=>{this.tempoStep=2**u,this.tempoStep>this.tempoFftSize&&(this.tempoStep=this.tempoFftSize,l.setValue(Math.log2(this.tempoFftSize))),this.reset()}});return e.replaceChildren(n,t("FFT Size",a.view,"Determines the amount of audio to analyze at every block. Higher values result in more accurate frequencies, while lower values result in more accurate timings. Defaults to 1024."),t("Window Step",r.view,"Determines the number of blocks per second. Lower values result in more time-accurate spectrograms, but may take more time and mess up tempo analysis. Defaults to 512 and must be lower than FFT Size."),s,t("FFT Size",o.view,"Determines the amount of the onset graph to analyze at every block. Higher values result in more accurate tempos, while lower values result in more accurate timings. Defaults to 4096."),t("Window Step",l.view,"Determines the number of blocks per second. Lower values result in more time-accurate tempograms, but may take more time. Defaults to 2 and must be lower than FFT Size.")),e}createTempoView(){const e=document.createElement("div");e.style.display="flex",e.style.position="relative",e.style.gap="0.625m";const t=document.createElement("div");t.style.flex="1";const n=document.createElement("div");n.classList.add("sync-table-label"),n.innerText="Offsets",this.offsetTableLabel=n;const a=document.createElement("table");a.classList.add("sync-table");const r=document.createElement("tr"),s=document.createElement("th");s.innerText="Offset";const o=document.createElement("th");o.innerText="Confidence",r.replaceChildren(s,o),a.appendChild(r),t.replaceChildren(n,a);const l=document.createElement("div");l.style.flex="1";const u=document.createElement("div");u.classList.add("sync-table-label"),u.innerText="Current Tempos";const f=document.createElement("table");f.classList.add("sync-table");const c=document.createElement("tr"),d=document.createElement("th");d.innerText="BPM";const h=document.createElement("th");h.innerText="Confidence",c.replaceChildren(d,h),f.appendChild(c);for(let p=0;p<5;p++){const m=document.createElement("tr");m.classList.add("empty");const g=document.createElement("td");g.innerText="-";const y=document.createElement("td");y.innerText="-",m.replaceChildren(g,y),a.appendChild(m),this.offsetRows.push(m);const x=m.cloneNode(!0);f.appendChild(x),this.bpmRows.push(x),m.onclick=()=>{let w;try{w=parseFloat(g.innerText)}catch{return}const C=this.app.chartManager.loadedChart.timingData;C.hasChartOffset()?C.setOffset(w):C.songTimingData.setOffset(w)},x.onclick=()=>{let w;try{w=parseFloat(x.firstElementChild.innerText)}catch{return}const C=this.app.chartManager.loadedChart.timingData,_=Math.round(this.app.chartManager.beat*48)/48;C.insertColumnEvents([{type:"BPMS",beat:_,value:w}])}}return l.replaceChildren(u,f),e.replaceChildren(t,l),e}createOnsetsView(){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.gap="0.625rem",e.style.justifyContent="center",e.style.alignItems="center",e.style.position="relative";const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.style.width="100%",Xe(t,{content:"Adjust the threshold for a block to be considered an onset (red line)."});const n=document.createElement("div");n.innerText="Onset Threshold";const a=Fi.create({min:0,max:1,step:.01,value:.3,onChange:u=>{this.threshold=u}}),r=document.createElement("div");r.style.color="#888888",r.style.fontStyle="italic",r.style.fontSize="0.75rem",r.style.marginBottom="1rem",r.style.marginTop="-0.375rem",r.innerText="Found 0 onsets",this.onsetResults=r,t.replaceChildren(n,a.view);const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.width="100%";const o=document.createElement("button");o.innerText="Place onsets as notes",o.onclick=()=>this.placeOnsets();const l=document.createElement("button");return l.innerText="Place onsets as notes in selection",l.disabled=!0,l.onclick=()=>this.placeOnsets(!0),this.placeNotesSelectionButton=l,s.replaceChildren(o,l),e.replaceChildren(t,r,s),e}async reset(){this._threshold=.3,this.doAnalysis=!1,this.toggleButton.disabled=!1,this.toggleButton.style.background="",this.toggleButton.innerText="Start analyzing",this.app.chartManager.chartAudio.onLoad(this.onAudioLoad),await this.getMonoAudioData(),this.sampleRate=this.app.chartManager.chartAudio.getSampleRate(),this.spectroHeights=new Array(this.fftSize).fill(0).map((t,n)=>{const a=n/(this.fftSize/2)*this.sampleRate/2,r=(n+1)/(this.fftSize/2)*this.sampleRate/2,s=et-Te(Math.log(a/20)/Math.log(this.sampleRate/40)*et,0,et),o=et-Te(Math.log(r/20)/Math.log(this.sampleRate/40)*et,0,et);return{y:o,height:s-o}}),this.spectroWeights=new Array(this.fftSize).fill(0).map((t,n)=>{const a=n/(this.fftSize/2)*this.sampleRate/2,r=ks.findIndex(l=>l.frequency>a);if(r<1)return 0;const s=ks[r-1],o=ks[r];return Ze(s.weight,o.weight,$t(Math.log(1+s.frequency),Math.log(1+o.frequency),Math.log(1+a)))});const e=Math.max(1,Math.ceil(this.audioLength/this.windowStep));this.spectrogramCanvases=[];for(let t=0;t<Math.ceil(e/Vt);t++){const n=new OffscreenCanvas(Math.min(Vt,e-t*Vt),et*2);this.spectrogramCanvases.push(n)}this.spectrogram=[],this.lowestFinishedBlock=0,this.numRenderedBlocks=0,this.spectrogramDifference=[],this.noveltyCurve=[],this.noveltyCurveIsolated=[],this.peaks=[],this.tempogram=[],this.tempogramGroups=[],this.offsetTableLabel.innerText="Offsets",this.offsetRows.forEach(t=>{t.firstChild.innerText="-",t.lastChild.innerText="-",t.classList.add("empty")}),this.bpmRows.forEach(t=>{t.firstChild.innerText="-",t.lastChild.innerText="-",t.classList.add("empty")})}hasData(){return this.numRenderedBlocks>0}windowLoop(e){const t=e.getContext("2d");t.canvas.width=zt,t.canvas.height=et*2,t.imageSmoothingEnabled=!1;const n=()=>{if(this.placeNotesSelectionButton.disabled=this.app.chartManager.startRegion===void 0||this.app.chartManager.endRegion===void 0||this.app.chartManager.startRegion==this.app.chartManager.endRegion,this.covers[0].classList.toggle("active",this.hasData()),this.covers[1].classList.toggle("active",!this.hasData()),this.covers[2].classList.toggle("active",!this.hasData()),!this.app.chartManager.chartAudio)return;const a=Math.ceil(this.audioLength/this.windowStep);if(this.monoAudioData!==void 0&&this.doAnalysis){const d=performance.now();for(;performance.now()-d<Cc;){if(this.lowestFinishedBlock>=a){this.tempogram.length==0&&(this.toggleButton.disabled=!0,this.calcTempogram());break}this.spectrogram[this.lowestFinishedBlock]===void 0&&(this.renderBlock(this.lowestFinishedBlock),this.calcDifference(this.lowestFinishedBlock),this.calcIsolatedNovelty(this.lowestFinishedBlock),this.numRenderedBlocks++),this.lowestFinishedBlock++}this.lowestFinishedBlock<a&&(this.toggleButton.style.background=`linear-gradient(90deg, var(--accent-color) 0 ${this.lowestFinishedBlock/a*100}%, var(--input-bg) ${this.lowestFinishedBlock/a*100}% 100%)`,this.toggleButton.innerText=`Stop analyzing (${he(this.lowestFinishedBlock/a*100,1)}%)`)}t.clearRect(0,0,e.width,e.height);const r=b.chart.speed/40,s=this.app.chartManager.time*this.sampleRate/this.windowStep-zt*.2/r,o=this.app.chartManager.time*this.sampleRate/this.windowStep+zt*.8/r;for(let d=Math.floor(s/Vt);d<=Math.floor(o/Vt);d++){const h=this.spectrogramCanvases[d];h&&t.drawImage(h,this.app.chartManager.time*this.sampleRate/this.windowStep-zt*.2/r-Vt*d,0,zt/r,et*2,0,0,zt,et*2)}t.globalCompositeOperation="source-atop";let l;Gs(Fe.getColor("primary-bg"))>.5?l=new B("white"):l=new B("black"),t.fillStyle=It(Fe.getColor("accent-color"),l,.1).toHexa(),t.fillRect(0,0,e.width,e.height),t.globalCompositeOperation="destination-over",t.fillStyle=It(Fe.getColor("accent-color"),l,.9).toHexa(),t.fillRect(0,0,e.width,e.height),t.globalCompositeOperation="source-over";const u=s*this.windowStep/this.sampleRate,f=o*this.windowStep/this.sampleRate;if(this.app.chartManager.loadedChart){const d=this.app.chartManager.loadedChart.getBeatFromSeconds(u),h=this.app.chartManager.loadedChart.getBeatFromSeconds(Math.min(f,this.app.chartManager.chartAudio.getSongLength()));t.fillStyle="rgba(255, 255, 255, 0.2)";for(const[p,m]of this.app.chartManager.loadedChart.timingData.getMeasureBeats(d,h)){const g=this.app.chartManager.loadedChart.getSecondsFromBeat(p);t.fillRect($t(u,f,g)*zt-(m?2:1),0,m?5:3,et*1.5)}}t.fillStyle="rgba(255, 0, 0, 0.3)";for(let d=Math.floor(s);d<=Math.ceil(o);d++)this.peaks[d]&&t.fillRect($t(s,o,d)*zt-.5,0,2,et*1.5);t.fillStyle="rgba(50, 255, 20, 0.3)",t.fillRect(zt*.2-1,0,3,et*2),t.fillStyle="rgba(255, 0, 255, 0.5)",t.fillRect(0,et*1.5-this._threshold*et*.5,zt,1);const c=Math.round(this.app.chartManager.time*this.sampleRate/this.windowStep/this.tempoStep);if(t.fillStyle=Fe.getColor("accent-color").toHex(),t.textAlign="right",t.textBaseline="top",t.font="22px Assistant",t.fillText(`${this.numRenderedBlocks}/${a} blocks rendered`,zt-10,10),t.textAlign="right",t.textBaseline="middle",this.tempogramGroups[c]){const d=[];for(const h of this.tempogramGroups[c]){let p=0,m=0,g=0;for(let y=c-xa;y<=c+xa;y++){if(this.tempogramGroups[y]===void 0)continue;const x=this.tempogramGroups[y].find(w=>w.center<h.center+cn&&w.center>h.center-cn);x!==void 0&&(p+=x.groups[0].value,m+=x.avg,g++)}p/=g,m/=g,d.push({bpm:m,weight:h.groups[0].value,smoothedWeight:p})}d.sort((h,p)=>p.smoothedWeight-h.smoothedWeight);for(const h of d)h.weight<.01||(t.font=`${18+h.weight*300}px Assistant`,t.globalAlpha=Math.min(1,h.weight*100),t.fillText(he(h.bpm,0)+"",200,Ze(et*2,et*1.5,$t(Ln,Dn,h.bpm))));if(this.lastSecond!=this.app.chartManager.time){this.lastSecond=this.app.chartManager.time;const h=d.slice(0,5).reduce((p,m)=>p+m.smoothedWeight,0);for(let p=0;p<5;p++){const m=this.bpmRows[p],g=d[p]?.bpm,y=d[p]?.weight;m.classList.toggle("empty",g===void 0),m.firstChild.innerText=g===void 0?"-":Math.round(g).toString(),m.lastChild.innerText=y===void 0?"-":Math.round(y/h*100)+"%"}}}t.globalAlpha=1,t.font="22px Assistant",t.textAlign="left",t.textBaseline="top",t.fillText("Spectrogram",10,10),t.fillText("Onsets",10,et+10),t.fillText("Tempogram",10,et*1.5+10),e.closest("#windows")&&requestAnimationFrame(n)};return n}renderBlock(e){if(!this.monoAudioData)return;const t=new Float32Array(this.fftSize);t.set(this.monoAudioData.subarray(Math.max(0,e*this.windowStep-this.fftSize/2),e*this.windowStep+this.fftSize/2),-Math.min(0,e*this.windowStep-this.fftSize/2));for(let a=0;a<t.length;a++)t[a]*=.5*(1-Math.cos(Math.PI*2*(a/this.fftSize)));const n=Ec(t).slice(0);for(let a=0;a<n.length;a++)n[a]=Math.log(1+1*n[a]);this.storeResponse(e,n)}calcDifference(e){const t=this.spectrogram[e].slice(0),n=this.spectrogram[e-1]?.slice(0)??new Float64Array(this.fftSize);for(let a=0;a<t.length;a++)t[a]=Math.max(0,t[a]-n[a])*this.spectroWeights[a];this.storeDifferenceResponse(e,t)}storeResponse(e,t){this.spectrogram[e]=t;const n=this.spectrogramCanvases[Math.floor(e/Vt)].getContext("2d");n.fillStyle="white",t.forEach((a,r)=>{const s=this.spectroHeights[r],o=Te(a*2e3,0,255);n.globalAlpha=o/255,n.fillRect(e%Vt,s.y,1,s.height)}),n.globalAlpha=1}storeDifferenceResponse(e,t){this.spectrogramDifference[e]=t;const n=t.reduce((a,r)=>a+r,0);this.noveltyCurve[e]=n}calcIsolatedNovelty(e){for(let t=e-_s;t<=e;t++){if(t<0)continue;let n=0,a=0;for(let r=t-_s;r<=t+_s;r++)this.noveltyCurve[r]!==void 0&&(n+=this.noveltyCurve[r],a++);n/=a,this.storeIsolatedNovelty(t,Math.max(0,this.noveltyCurve[t]-n))}}storeIsolatedNovelty(e,t){this.noveltyCurveIsolated[e]=Math.log(1+t),Math.log(1+t)>this._threshold&&Math.log(1+t)>(this.noveltyCurveIsolated[e-1]??0)?(this.peaks[e-1]&&(this.peaks[e-1]=!1),this.peaks[e]=!0,this.onsetResults.innerText=`Found ${this.peaks.filter(r=>r).length} onsets`):this.peaks[e]=!1;const n=this.spectrogramCanvases[Math.floor(e/Vt)].getContext("2d"),a=Math.min(1,Math.log(1+t))*et*.5;n.fillStyle="white",n.fillRect(e%Vt,et*1.5-a,1,a)}async getMonoAudioData(){const e=this.app.chartManager.chartAudio;if(!e)return;const t=e.getBuffer(),n=new OfflineAudioContext(t.numberOfChannels,t.length,t.sampleRate),a=n.createBufferSource();a.buffer=t;const r=n.createChannelMerger(t.numberOfChannels);a.connect(r),r.connect(n.destination),a.start(),await n.startRendering().then(s=>{this.monoAudioData=s.getChannelData(0),this.audioLength=this.monoAudioData.length}).catch(()=>{ce.createFormatted("Failed to load audio: audio rendering failed","error")})}get threshold(){return this._threshold}set threshold(e){this._threshold=e,this.peaks=this.noveltyCurveIsolated.map((t,n)=>t>this._threshold&&(this.noveltyCurveIsolated[n-1]??0)<this._threshold),this.onsetResults.innerText=`Found ${this.peaks.filter(t=>t).length} onsets`}calculateOffset(){const e=new Map;let t=0,n=0,a=0;for(let u=0;u<this.tempogramGroups.length;u++){const c=this.tempogramGroups[u].filter(d=>d.groups[0].value>=_m);if(c.length!=0&&(n=u,c.forEach(d=>{let h=0,p=0;for(let g=u-xa;g<=u+xa;g++){if(this.tempogramGroups[g]===void 0)continue;const y=this.tempogramGroups[g].find(x=>x.center<d.center+cn&&x.center>d.center-cn);y!==void 0&&(p+=y.avg,h++)}const m=Math.round(p/h);e.has(m)||e.set(m,0),e.set(m,e.get(m)+1),e.get(m)>t&&(t=e.get(m),a=m)}),t>50))break}if(a==0)return;const r=60/a*(this.sampleRate/this.windowStep),s=new Array(As).fill(0).map((u,f)=>{const c=f%r/r;let d=0,h=0;for(let p=1;p<=4;p++)h+=Math.max(1-Math.abs(Math.round(c*p)/p-c)*12,0)*1/p,d+=1/p;return h/d}),o=[];for(let u=n;u<n+r;u++){const f=this.noveltyCurveIsolated.slice(u,u+As).map((c,d)=>s[d]*c).reduce((c,d)=>c+d,0);o.push({block:u,offset:-(u*this.windowStep/this.sampleRate)%(60/a),response:f,curve:this.noveltyCurveIsolated.slice(u,u+As).map((c,d)=>s[d]*c)})}o.sort((u,f)=>f.response-u.response);const l=o.slice(0,5).reduce((u,f)=>u+f.response,0);this.offsetTableLabel.innerText=`Offsets (first BPM: ${a})`;for(let u=0;u<Math.min(o.length,5);u++){const f=this.offsetRows[u];f.classList.remove("empty"),f.firstChild.innerText=he(o[u].offset,3).toString(),f.lastChild.innerText=Math.round(o[u].response/l*100)+"%"}}placeOnsets(e=!1){const t=this.peaks.map((n,a)=>{if(!n)return null;let r=this.app.chartManager.loadedChart.getBeatFromSeconds(a*this.windowStep/this.sampleRate);return r=Math.round(r*48)/48,r<0?null:{type:"Tap",beat:r,col:0}}).filter(n=>n!==null).filter(n=>e?n.beat>this.app.chartManager.startRegion&&n.beat<this.app.chartManager.endRegion:!0);this.app.chartManager.insertNotes(t)}calcTempogram(){let e=0;for(let s=0;s<this.noveltyCurveIsolated.length;s++)this.noveltyCurveIsolated[s]>e&&(e=this.noveltyCurveIsolated[s]);const t=new Float32Array(this.noveltyCurveIsolated.length);for(let s=0;s<this.noveltyCurveIsolated.length;s++)t[s]=this.noveltyCurveIsolated[s]/e;const n=Math.ceil(t.length/this.tempoStep);let a=performance.now();const r=s=>{const o=new Float32Array(this.tempoFftSize);o.set(t.subarray(Math.max(0,s*this.tempoStep-this.tempoFftSize/2),s*this.tempoStep+this.tempoFftSize/2),-Math.min(0,s*this.tempoStep-this.tempoFftSize/2));for(let u=0;u<o.length;u++)o[u]*=.5*(1-Math.cos(Math.PI*2*(u/this.tempoFftSize)));const l=Ec(o).slice(0);for(let u=0;u<l.length;u++)l[u]=Math.log(1+1*l[u]);this.storeTempogram(s,l),s<n?performance.now()-a<Cc?r(++s):(a=performance.now(),this.toggleButton.style.background=`linear-gradient(90deg, var(--accent-color) 0 ${s/n*100}%, var(--input-bg) ${s/n*100}% 100%)`,this.toggleButton.innerText=`Finding tempo (${he(s/n*100,1)}%)`,setTimeout(()=>r(++s),1)):(this.calculateOffset(),this.spectrogram=[],this.noveltyCurve=[],this.tempogram=[],this.monoAudioData=void 0,this.toggleButton.innerText="Finished analyzing",this.resetButton.disabled=!1,this.doAnalysis=!1,this.toggleButton.style.background="var(--accent-color)")};r(0)}storeTempogram(e,t){const n=new Map,a=[];t.forEach((s,o)=>{let l=this.sampleRate*60/(this.windowStep*this.tempoFftSize)*o;if(!(l>Dn*4||l<Ln/4)){for(;l>Dn&&l!=1/0;)l/=2;for(;l<Ln&&l!=0;)l*=2;n.has(he(l,3))||n.set(he(l,3),0),n.set(he(l,3),n.get(he(l,3))+s)}}),this.tempogram[e]=[...n.entries()].map(([s,o])=>({bpm:s,value:o})).sort((s,o)=>o.value-s.value).filter(s=>s.value!=0);for(let s=0;s<Math.min(this.tempogram[e].length,10);s++){const o=this.tempogram[e][s],l=a.find(u=>u.center<o.bpm+cn&&u.center>o.bpm-cn);if(l===void 0){a.push({center:o.bpm,groups:[o]});continue}l.groups.push(o)}this.tempogramGroups[e]=a.map(s=>({...s,avg:s.groups.reduce((o,l)=>o+l.bpm*l.value,0)/s.groups.reduce((o,l)=>o+l.value,0)}));const r=this.spectrogramCanvases[Math.floor(e*this.tempoStep/Vt)].getContext("2d");r.fillStyle="white",this.tempogram[e].forEach(s=>{const o=Te(s.value*8e3,0,255);r.globalAlpha=o/255,r.fillRect(e*this.tempoStep%Vt,Ze(et*2,et*1.5,$t(Ln,Dn,s.bpm)),1*this.tempoStep,et*.5/(Dn-Ln))})}}class Ys extends ct{app;grid;actions={};constructor(e){super({title:"Themes",width:600,height:400,disableClose:!1,win_id:"theme-selection",blocking:!1}),this.app=e,this.initView(),this.loadGrid()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-search");const n=document.createElement("input");n.classList.add("pref-search-bar"),n.type="text",n.placeholder="Search for a theme...",n.oninput=()=>{this.filterGrid(n.value)},t.appendChild(n);const a=document.createElement("div");a.classList.add("theme-grid"),this.grid=a;const r=this.createOptionTray();e.replaceChildren(t,a,r),this.viewElement.appendChild(e)}createOptionTray(){const e=document.createElement("div");e.classList.add("theme-tray");const t=document.createElement("button");t.appendChild(be.getIcon("PLUS",16)),t.appendChild(document.createTextNode("New")),t.onclick=()=>{const l=this.getNonConflictingName("new-theme");Fe.createUserTheme(l),Fe.loadTheme(l),this.loadGrid()},this.actions.add=t,e.appendChild(t);const n=document.createElement("button");n.appendChild(be.getIcon("COPY",16)),n.appendChild(document.createTextNode("Duplicate")),n.onclick=()=>{const l=this.getNonConflictingName(b.general.theme);Fe.createUserTheme(l,Fe.getCurrentTheme()),Fe.loadTheme(l),this.loadGrid()},n.disabled=!0,this.actions.copy=n,e.appendChild(n);const a=document.createElement("button");a.classList.add("confirm"),a.appendChild(be.getIcon("EDIT",16)),a.appendChild(document.createTextNode("Edit")),a.onclick=()=>{this.closeWindow(),this.app.windowManager.openWindow(new sa(this.app))},a.disabled=!0,this.actions.edit=a,e.appendChild(a);const r=document.createElement("button");r.classList.add("delete"),r.appendChild(be.getIcon("TRASH",16)),r.appendChild(document.createTextNode("Delete")),r.onclick=()=>{this.app.windowManager.openWindow(new vn(this.app,"Delete theme","Are you sure you want to delete this theme?",[{type:"default",label:"Cancel"},{type:"delete",label:"Delete",callback:()=>{Fe.deleteUserTheme(b.general.theme),this.loadGrid()}}]))},r.disabled=!0,this.actions.del=r,e.appendChild(r);const s=document.createElement("button");s.appendChild(be.getIcon("UPLOAD",16)),s.appendChild(document.createTextNode("Import")),s.onclick=async()=>{(await Uu({_preferPolyfill:!1,excludeAcceptAllOption:!1,multiple:!0,accepts:[{extensions:["txt"]}]})).forEach(u=>{u.getFile().then(f=>f.text()).then(f=>{const c=Fe.parseThemeText(f);let d=Tt(u.name,".txt");if(!c){ce.createFormatted("Failed to load theme "+d,"error");return}d=this.getNonConflictingName(d),Fe.createUserTheme(d,c),this.loadGrid()})})},this.actions.imp=s,e.appendChild(s);const o=document.createElement("button");return o.appendChild(be.getIcon("DOWNLOAD",16)),o.appendChild(document.createTextNode("Export")),o.onclick=()=>{const l=Fe.exportCurrentTheme({spaces:!0}),u=new File([l],b.general.theme+".txt",{type:"text/plain"}),f=document.createElement("a"),c=URL.createObjectURL(u);f.href=c,f.download=u.name,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(c)},this.actions.exp=o,o.disabled=!0,e.appendChild(o),e}loadGrid(){this.grid.replaceChildren();const e=Fe.getThemes();if(e)for(const[t,n]of Object.entries(e)){let a=t;const r=Yi[t]!==void 0,s=document.createElement("div"),o=document.createElement("div");if(o.classList.add("inlineEdit"),r)o.style.fontWeight="bold";else{o.contentEditable="true";let u=t;o.onfocus=()=>{u=o.innerText},o.onkeydown=f=>{f.key=="Enter"&&(o.blur(),f.preventDefault()),f.key=="Escape"&&(o.innerText=u,o.blur(),f.stopImmediatePropagation())},o.onblur=()=>{if(o.innerText==u)return;const f=this.getNonConflictingName(o.innerText);Fe.renameUserTheme(u,f),Fe.loadTheme(f),o.innerText=f,a=f,s.dataset.id=f}}const l=document.createElement("div");l.classList.add("theme-preview-grid");for(const u of rf){const f=document.createElement("div");f.style.backgroundColor=n[u].toHex(),l.appendChild(f)}o.innerText=t,s.classList.add("theme-cell"),o.classList.add("theme-title"),s.replaceChildren(o,l),this.grid.appendChild(s),t==b.general.theme&&(s.classList.add("selected"),setTimeout(()=>{s.scrollIntoView({behavior:b.general.smoothAnimations?"smooth":"instant",block:"center"})}),this.actions.edit.disabled=r,this.actions.del.disabled=r,this.actions.copy.disabled=!1,this.actions.exp.disabled=!1),s.dataset.id=t,s.onclick=()=>{b.general.theme!=a&&(Fe.loadTheme(a),this.removeAllSelections(),s.classList.add("selected"),this.actions.edit.disabled=r,this.actions.del.disabled=r,this.actions.copy.disabled=!1,this.actions.exp.disabled=!1)}}}removeAllSelections(){[...this.grid.querySelectorAll(".selected")].forEach(e=>e.classList.remove("selected"))}filterGrid(e){[...this.grid.children].forEach(t=>{if(!(t instanceof HTMLDivElement))return;const n=t,a=this.containsQuery(e,n.dataset.id);n.style.display=a?"":"none"})}containsQuery(e,t){return t?t.toLowerCase().includes(e.trim().toLowerCase()):!1}getNonConflictingName(e){const t=Fe.getThemes();if(t[e]==null)return e;let n=2;const a=/([^]+)-(\d+)$/.exec(e);a&&(e=a[1],n=parseInt(a[2]));let r=`${e}-${n}`;for(;t[r]!==void 0;)r=`${e}-${n}`,n++;return r}}class sa extends ct{app;pickers={};handlers=[];linkBlacklist=new Set;static isOpen=!1;constructor(e){super({title:"Theme Color Editor",width:500,height:400,win_id:"theme-editor",disableClose:!0}),this.app=e,this.initView(),sa.isOpen=!0}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("theme-color-grid"),sf.forEach(l=>{t.appendChild(this.createGroup(l))});const n=document.createElement("div");n.classList.add("menu-options");const a=document.createElement("div");a.classList.add("menu-left");const r=document.createElement("div");r.classList.add("menu-right"),n.appendChild(a),n.appendChild(r);const s=document.createElement("button");s.innerText="Cancel",s.onclick=()=>{this.closeWindow(),Fe.loadTheme(b.general.theme),this.app.windowManager.openWindow(new Ys(this.app))},a.appendChild(s);const o=document.createElement("button");o.innerText="Save",o.classList.add("confirm"),o.onclick=()=>{Fe.setUserTheme(b.general.theme,Fe.getCurrentTheme()),Fe.loadTheme(b.general.theme),this.app.windowManager.openWindow(new Ys(this.app)),this.closeWindow()},r.appendChild(o),e.replaceChildren(t,n),this.viewElement.appendChild(e)}createGroup(e){const t=document.createElement("div");t.classList.add("theme-group");const n=document.createElement("div");n.classList.add("theme-group-label"),n.innerText=e.name;const a=document.createElement("div");return a.classList.add("theme-picker-grid"),e.ids.forEach(r=>{a.appendChild(this.createPicker(r))}),t.replaceChildren(n,a),t}createPicker(e){const t=()=>{const f=new B(Fe.getCurrentTheme()[e.id]);o.innerText=f.toHex()+" | "+Math.round(f.alpha*100)+"%",!l.isActive()&&(l.value=f)},n=f=>{const c=Fe.getCurrentTheme();c[e.id]=f,Fe._applyTheme(this.updateLinks(e.id,c))},a=document.createElement("div");a.classList.add("theme-color-cell"),Vl[e.id]!=""&&Xe(a,{content:Vl[e.id]});const r=rs[e.id];r&&(a.onmouseover=()=>{Object.keys(r).forEach(f=>{this.linkBlacklist.has(f)||this.pickers[f].classList.add("linked")})},a.onmouseout=()=>{Object.keys(r).forEach(f=>{this.pickers[f].classList.remove("linked")})});const s=document.createElement("div");s.innerText=e.label;const o=document.createElement("div");o.classList.add("theme-color-detail");const l=ir.create({value:"white",width:30,height:30});l.onColorChange=n,a.replaceChildren(s,o,l);const u=this.getLink(e.id);if(u!==null){const f=document.createElement("div");f.classList.add("ico-checkbox");const c=be.getIcon("LINK",16),d=be.getIcon("LINK_BROKEN",16);let h=!0;const p=()=>{h?this.linkBlacklist.delete(e.id):this.linkBlacklist.add(e.id),c.style.display=h?"":"none",d.style.display=h?"none":""};f.onclick=()=>{h=!h,p()},Xe(f,{onShow(g){g.setContent(h?`Linked to ${u}`:"Unlinked")}}),Xe(f,{trigger:"click",onShow(g){g.setContent(h?`Linked to ${u}`:"Unlinked")}}),p(),f.replaceChildren(c,d),a.appendChild(f);const m=g=>{h&&(h=!1,p()),n(g)};l.onColorChange=m}return t(),ie.on("themeChanged",t),this.handlers.push(t),this.pickers[e.id]=a,a}getLink(e){for(const[t,n]of Object.entries(rs))if(e in n)return t;return null}average(e){return(e.red+e.green+e.blue)/3}lighten(e,t){return new B(bo(new B(e).toNumber(),1+t/100))}add(e,t){return new B(of(new B(e).toNumber(),t))}updateLinks(e,t){const n=new Set,a=[e];for(;a.length!=0;){const r=a.shift(),s=rs[r];if(s)for(const[o,l]of Object.entries(s))this.linkBlacklist.has(o)||n.has(o)||(t[o]=l.bind(this)(t[r]),a.push(o),n.add(o))}return t}onClose(){sa.isOpen=!1}}const Da={precision:Vc,minPrecision:Ti,value:0};function un(i){return{create:function(e){const t=ht.create({...Da,value:0,min:i=="WARPS"?0:-Number.MAX_VALUE,onchange:n=>{const a=e.chartManager.loadedChart.timingData,r=Math.round(e.chartManager.beat*48)/48;if(n==null){a.deleteColumnEvents([{type:i,beat:r}]);return}a.insertColumnEvents([{type:i,beat:r,value:n}])}});return this.data=[t],t.view},update:function(e,t){const n=this.data[0];if(document.activeElement==n.input)return;n.value=e.getOffset();const a=e.getEventAtBeat(i,t);let r=a?.value??0;hd.getColumnType(i)=="instant"&&(!a||Math.abs(a.beat-t)>1/48)&&(r=0),n.value=r}}}const _c={offset:{title:"Offset",element:{create:function(i){const e=ht.create({...Da,step:b.general.spinnerStep/100,onchange:t=>{const n=i.chartManager.loadedChart.timingData;t!=null&&(n.hasChartOffset()?n.setOffset(t):n.songTimingData.setOffset(t))}});return this.data.push(e),e.view},update:function(i){const e=this.data[0];document.activeElement!=e.input&&(e.value=i.getOffset())}}},bpm:{title:"BPM",element:un("BPMS")},stop:{title:"Stop",element:un("STOPS")},delay:{title:"Delay",element:un("DELAYS")},warp:{title:"Warp",element:un("WARPS")},timeSig:{title:"Time Sig.",element:{create:function(i){const e=document.createElement("div");e.classList.add("flex-column-gap");const t=ht.create({value:4,step:1,precision:0,min:1,onchange:a=>{const r=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(a==null){r.deleteColumnEvents([{type:"TIMESIGNATURES",beat:s}]);return}a<1||r.insertColumnEvents([{type:"TIMESIGNATURES",beat:s,upper:a,lower:n.value}])}}),n=ht.create({value:4,step:1,precision:0,min:1,onchange:a=>{const r=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(a==null){r.deleteColumnEvents([{type:"TIMESIGNATURES",beat:s}]);return}a<1||r.insertColumnEvents([{type:"TIMESIGNATURES",beat:s,upper:t.value,lower:a}])}});return e.appendChild(t.view),e.appendChild(n.view),this.data=[t,n],e},update:function(i,e){const t=this.data[0],n=this.data[1],a=i.getEventAtBeat("TIMESIGNATURES",e),r=a?.upper??4,s=a?.lower??4;document.activeElement!=t.input&&(t.value=Math.round(r)),document.activeElement!=n.input&&(n.value=Math.round(s))}}},tick:{title:"Tickcount",element:{create:function(i){const e=ht.create({value:4,step:1,precision:0,min:0,onchange:t=>{const n=i.chartManager.loadedChart.timingData,a=Math.round(i.chartManager.beat*48)/48;if(t==null){n.deleteColumnEvents([{type:"TICKCOUNTS",beat:a}]);return}t<0||n.insertColumnEvents([{type:"TICKCOUNTS",beat:a,value:t}])}});return this.data=[e],e.view},update:function(i,e){const t=this.data[0];if(document.activeElement==t.input)return;const n=i.getEventAtBeat("TICKCOUNTS",e)?.value??4;t.value=Math.round(n)}}},combo:{title:"Combo",element:{create:function(i){const e=document.createElement("div");e.classList.add("flex-column-gap");const t=ht.create({value:1,step:1,precision:0,min:0,onchange:a=>{const r=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(a==null){r.deleteColumnEvents([{type:"COMBOS",beat:s}]);return}a<0||r.insertColumnEvents([{type:"COMBOS",beat:s,hitMult:a,missMult:n.value}])}}),n=ht.create({value:1,step:1,precision:0,min:0,onchange:a=>{const r=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(a==null){n.value=i.chartManager.loadedChart?.timingData.getEventAtBeat("COMBOS",s)?.missMult??1;return}a<0||r.insertColumnEvents([{type:"COMBOS",beat:s,hitMult:t.value,missMult:a}])}});return e.appendChild(t.view),e.appendChild(n.view),this.data=[t,n],e},update:function(i,e){const t=this.data[0],n=this.data[1],a=i.getEventAtBeat("COMBOS",e),r=a?.hitMult??1,s=a?.missMult??1;document.activeElement!=t.input&&(t.value=Math.round(r)),document.activeElement!=n.input&&(n.value=Math.round(s))}}},speed:{title:"Speed",element:{create:function(i){const e=document.createElement("div");e.classList.add("flex-column-gap");const t=()=>{const s=i.chartManager.loadedChart.timingData,o=Math.round(i.chartManager.beat*48)/48;s.insertColumnEvents([{type:"SPEEDS",beat:o,value:n.value,delay:a.value,unit:r.value=="Beats"?"B":"T"}])},n=ht.create({...Da,value:1,step:.1,onchange:s=>{const o=i.chartManager.loadedChart.timingData,l=Math.round(i.chartManager.beat*48)/48;if(s==null){o.deleteColumnEvents([{type:"SPEEDS",beat:l}]);return}t()}}),a=ht.create({...Da,value:1,step:.1,min:0,onchange:s=>{s==null||s<0||t()}}),r=gi.create(["Beats","Time"],"Beats");return r.onChange(t),e.appendChild(n.view),e.appendChild(a.view),e.appendChild(r.view),this.data=[n,a,r],e},update:function(i,e){const t=this.data[0],n=this.data[1],a=this.data[2],r=i.getEventAtBeat("SPEEDS",e),s=r?.value??1,o=r?.delay??0,l=r?.unit=="B"?"Beats":"Time";document.activeElement!=t.input&&(t.value=s),document.activeElement!=n.input&&(n.value=o);const u=r&&Math.abs(r.beat-e)<1/48;n.disabled=!u,a.value!=l&&a.setSelected(l),a.disabled=!u}}},scroll:{title:"Scroll",element:un("SCROLLS")},fake:{title:"Fake",element:un("FAKES")},label:{title:"Label",element:{create:function(i){const e=document.createElement("input");return e.type="text",e.autocomplete="off",e.spellcheck=!1,e.onkeydown=t=>{t.key=="Enter"&&e.blur()},e.onblur=()=>{const t=i.chartManager.loadedChart.timingData,n=Math.round(i.chartManager.beat*48)/48;if(e.value==""){t.deleteColumnEvents([{type:"LABELS",beat:n}]);return}t.insertColumnEvents([{type:"LABELS",beat:n,value:e.value}])},this.data=[e],e},update:function(i,e){const t=this.data[0];if(document.activeElement==t)return;const a=i.getEventAtBeat("LABELS",e)?.value??"";t.value!=a&&(t.value=a)}}}};class Am extends ct{app;lastBeat;interval;changeHandler=()=>this.setData();data={};constructor(e){super({title:"Edit Timing Data",width:300,height:340,disableClose:!1,win_id:"timing_data",blocking:!1}),this.app=e,this.lastBeat=Math.round(this.app.chartManager.beat*1e3)/1e3,this.initView(),this.interval=setInterval(()=>{Math.round(this.app.chartManager.beat*1e3)/1e3!=this.lastBeat&&(this.lastBeat=Math.round(this.app.chartManager.beat*1e3)/1e3,this.setData())},17),ie.on("timingModified",this.changeHandler),ie.on("chartLoaded",this.changeHandler)}onClose(){ie.off("timingModified",this.changeHandler),clearInterval(this.interval)}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("timing-data");const e=document.createElement("div");e.classList.add("padding"),Object.values(_c).forEach(t=>{const n=document.createElement("div");n.classList.add("label"),n.innerText=t.title,this.data[t.title]={data:[]};const a=t.element.create.bind(this.data[t.title])(this.app);e.appendChild(n),e.appendChild(a)}),this.viewElement.appendChild(e),this.setData()}setData(){this.app.chartManager.loadedChart&&Object.values(_c).forEach(e=>{e.element.update.bind(this.data[e.title])(this.app.chartManager.loadedChart.timingData,this.lastBeat)})}}const Ac=[{type:"group",id:"app",label:"App",disable:()=>window.nw===void 0,children:[{type:"subgroup",children:[{type:"item",label:"Window Width",id:"app.width",input:{type:"number",step:50,min:300,precision:0,onChange:(i,e)=>{const t=nw.Window.get();t.isFullscreen||(t.width=e)}}},{type:"item",label:"Window Height",id:"app.height",input:{type:"number",step:50,min:300,precision:0,onChange:(i,e)=>{const t=nw.Window.get();t.isFullscreen||(t.height=e)}}}]},{type:"subgroup",children:[{type:"item",label:"Fullscreen",id:"app.fullscreen",input:{type:"checkbox",onChange:(i,e)=>{const t=nw.Window.get();e?nw.Window.get().enterFullscreen():(t.hide(),nw.Window.get().leaveFullscreen(),t.show())}}}]}]},{type:"group",id:"general",label:"General",children:[{type:"subgroup",children:[{type:"item",label:"UI Scale",id:"general.uiScale",input:{type:"number",min:30,step:10,precision:0,max:200,transformers:{serialize:i=>i*100,deserialize:i=>i/100},onChange:(i,e)=>{document.body.parentElement.style.fontSize=e*100+"%"}}},{type:"item",label:"Smooth Animations",id:"general.smoothAnimations",input:{type:"checkbox",onChange:(i,e)=>{e?document.body.classList.add("animated"):document.body.classList.remove("animated")}}}]},{type:"subgroup",children:[{type:"item",label:"Auto-load SSC files",id:"general.loadSSC",input:{type:"dropdown",items:["Prompt","Always","Never"],advanced:!1},tooltip:"Automatically select .ssc files instead of .sm files when available."},{type:"item",label:"Autosave interval",id:"general.autosaveInterval",input:{type:"slider",min:30,step:5,max:600,hardMin:15,hardMax:2**31-1},tooltip:"Interval in seconds between autosaves"},{type:"item",label:"Warn before exit",id:"general.warnBeforeExit",input:{type:"checkbox"},tooltip:"Warn before exiting the editor if you have unsaved changes."}]},{type:"subgroup",children:[{type:"item",label:"Spinner step",id:"general.spinnerStep",input:{type:"slider",min:0,step:.1,max:5,hardMin:0,hardMax:2**31-1},tooltip:"The default increment for all number spinners."}]}]},{type:"group",id:"editing",label:"Editing",children:[{type:"subgroup",label:"Note Placement",children:[{type:"subgroup",children:[{type:"item",label:"Enable mouse placement",id:"chart.mousePlacement",input:{type:"checkbox"}},{type:"item",label:"Directional hold placement behavior",id:"chart.defaultHoldPlacement",input:{type:"checkbox"},tooltip:"Changes the hold placement behavior. By default, holds can only be extended in one direction when placed. Turn this off to mimic the behavior of AV/Stepmania."},{type:"item",label:"Force snap notes",id:"chart.forceSnapNotes",input:{type:"checkbox"},tooltip:"Placing a note when not on a snap will force the note to be placed on the next snap. Useful for placing notes when playing."}]}]},{type:"subgroup",label:"Parity",children:[{type:"item",label:"Enabled",id:"chart.parity.enabled",input:{type:"checkbox"}},{type:"item",label:"Show note highlights",id:"chart.parity.showHighlights",input:{type:"checkbox"}},{type:"item",label:"Show tech notation",id:"chart.parity.showTech",input:{type:"checkbox"}},{type:"item",label:"Highlight candles",id:"chart.parity.showCandles",input:{type:"checkbox"}},{type:"item",label:"Show tech errors",id:"chart.parity.showErrors",input:{type:"checkbox"}},{type:"item",label:"Show dancing bot",id:"chart.parity.showDancingBot",input:{type:"checkbox"}}]}]},{type:"group",id:"view",label:"View",children:[{type:"subgroup",children:[{type:"item",label:"Zoom",id:"chart.zoom",input:{type:"slider",min:50,step:1,max:200,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},{type:"item",label:"Reverse playfield",id:"chart.reverse",input:{type:"checkbox"}}]},{type:"subgroup",children:[{type:"item",label:"Allow receptor dragging",id:"chart.allowReceptorDrag",input:{type:"checkbox"},tooltip:"Allows the receptors to be dragged to move the playfield."},{type:"item",label:"X position",id:"chart.receptorXPos",input:{type:"slider",min:-400,max:400,hardMin:-2147483647,hardMax:2**31-1}},{type:"item",label:"Y position",id:"chart.receptorYPos",input:{type:"slider",min:-400,max:0,hardMin:-2147483647,hardMax:2**31-1}}]},{type:"subgroup",children:[{type:"item",label:"Draw length",id:"chart.maxDrawBeats",input:{type:"slider",min:0,max:30,hardMax:2**31-1},tooltip:"Maximum number of beats to draw notes. Increasing this works well for songs with high bpm but can affect performance. Only applies to XMod."},{type:"item",label:"Draw length past receptors",id:"chart.maxDrawBeatsBack",input:{type:"slider",min:0,max:30,hardMax:2**31-1},tooltip:"Maximum number of beats to draw notes past the receptors. Increasing this can affect performance. Only applies to XMod."}]},{type:"subgroup",children:[{type:"item",label:"Draw noteflashes",id:"chart.drawNoteFlash",input:{type:"checkbox"}},{type:"item",label:"Draw note icons",id:"chart.drawIcons",input:{type:"checkbox"},tooltip:"Draw indicators above notes that some noteskins may not differentiate, like Fakes and Lifts."}]},{type:"subgroup",label:"Scrolling",children:[{type:"item",label:"Scroll sensitivity",id:"chart.scroll.scrollSensitivity",input:{type:"slider",min:0,step:1,max:200,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}},tooltip:"Adjust the scroll sensitivity when scrolling through the chart."},{type:"item",label:"Snap every scroll",id:"chart.scroll.scrollSnapEveryScroll",input:{type:"checkbox"},tooltip:"Whether each scroll movement corresponds to moving one snap unit when scrolling. Turning this on will have the same behavior as ArrowVortex. Recommended on for those using a mouse, off for those using trackpad."},{type:"item",label:"Invert scroll direction",id:"chart.scroll.invertScroll",input:{type:"checkbox"}},{type:"item",label:"Invert zoom in/out",id:"chart.scroll.invertZoomScroll",input:{type:"checkbox"},tooltip:"Inverts the zoom in/out control when scrolling."},{type:"item",label:"Invert scroll direction when in reverse",id:"chart.scroll.invertReverseScroll",input:{type:"checkbox"}}]},{type:"subgroup",label:"Waveform",children:[{type:"item",label:"Draw waveform",id:"chart.waveform.enabled",input:{type:"checkbox"}},{type:"subgroup",children:[{type:"item",label:"Color",id:"chart.waveform.color",input:{type:"color"}}]},{type:"subgroup",children:[{type:"item",label:"Draw filtered waveform",id:"chart.waveform.allowFilter",input:{type:"checkbox"}},{type:"item",label:"Filtered color",id:"chart.waveform.filteredColor",input:{type:"color"}}]},{type:"item",label:"Line height",id:"chart.waveform.lineHeight",input:{type:"slider",min:1,max:3,step:.1,hardMax:100},tooltip:"The height of each line of the waveform. Increasing this can help performance."},{type:"item",label:"Antialiasing",id:"chart.waveform.antialiasing",input:{type:"checkbox"}},{type:"item",label:"Allow speed changes",id:"chart.waveform.speedChanges",input:{type:"checkbox"},tooltip:"Allows the waveform to be affected by SPEEDS and SCROLLS."}]}]},{type:"group",id:"timelines",label:"Timelines",children:[{type:"item",label:"Follow current position",id:"chart.layoutFollowPosition",input:{type:"checkbox"},tooltip:"Change whether layouts show the entire song or range around the cursor."},{type:"subgroup",label:"Notes",children:[{type:"item",label:"Enabled",id:"chart.noteLayout.enabled",input:{type:"checkbox"}}]},{type:"subgroup",label:"Player Direction",children:[{type:"item",label:"Enabled",id:"chart.facingLayout.enabled",input:{type:"checkbox"}}]},{type:"subgroup",label:"Density",children:[{type:"item",label:"Enabled",id:"chart.npsGraph.enabled",input:{type:"checkbox"}},{type:"subgroup",children:[{type:"item",label:"Start Color",id:"chart.npsGraph.color1",input:{type:"color"}},{type:"item",label:"End Color",id:"chart.npsGraph.color2",input:{type:"color"}}]}]}]},{type:"group",id:"audio",label:"Audio",children:[{type:"subgroup",children:[{type:"item",label:"Master volume",id:"audio.masterVolume",input:{type:"slider",min:0,step:1,max:100,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},{type:"item",label:"Song volume",id:"audio.songVolume",input:{type:"slider",min:0,step:1,max:100,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},{type:"item",label:"Sound effect volume",id:"audio.soundEffectVolume",input:{type:"slider",min:0,step:1,max:100,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}}]},{type:"subgroup",children:[{type:"item",label:"Enable assist tick",id:"audio.assistTick",input:{type:"checkbox"},tooltip:"Plays a sound when a note passes the receptors"},{type:"item",label:"Enable metronome",id:"audio.metronome",input:{type:"checkbox"}}]},{type:"subgroup",children:[{type:"item",label:"Allow filters to affect audio",id:"audio.allowFilter",input:{type:"checkbox",onChange:i=>{i.chartManager.chartAudio.reload()}}}]}]},{type:"group",id:"play",label:"Playtesting",children:[{type:"subgroup",label:"Calibration",children:[{type:"item",label:"Global offset",id:"play.offset",input:{type:"slider",min:-1,step:.001,max:1,hardMin:-2147483647,hardMax:2**31-1},tooltip:"Offset in seconds when playing a chart. Set to positive if you are hitting early and negative if you are hitting late."},{type:"item",label:"Sound effect offset",id:"play.effectOffset",input:{type:"slider",min:-1,step:.001,max:1,hardMin:-2147483647,hardMax:2**31-1},tooltip:"Offset in seconds when playing sound effects like assist tick and metronome."},{type:"item",label:"Visual offset",id:"play.visualOffset",input:{type:"slider",min:-1,step:.001,max:1,hardMin:-2147483647,hardMax:2**31-1},tooltip:"Offset in seconds when displaying notes."}]},{type:"subgroup",children:[{type:"item",label:"Judgement tilt",id:"play.judgementTilt",input:{type:"checkbox"},tooltip:"Tilts the judgement text left if you are hitting early and right if you are hitting late."},{type:"item",label:"Hide edit GUI during play",id:"play.hideBarlines",input:{type:"checkbox"}}]},{type:"subgroup",label:"Timing windows",children:[{type:"item",id:"play.timingCollection",label:"Timing window collection",input:{type:"dropdown",advanced:!1,get items(){return Object.keys(_t.getCollections())},onChange(i,e){const t=i.chartManager.loadedChart?.gameType.id;if(t)for(const n of Object.keys(b.play.defaultTimingCollections))t.startsWith(n)&&(b.play.defaultTimingCollections[n]=e)}}},{type:"item",id:"play.timingWindowScale",label:"Timing window scale",input:{type:"slider",min:0,step:.001,max:2,hardMax:2**31-1},tooltip:"Scales all timing windows by the given amount."},{type:"item",id:"play.timingWindowAdd",label:"Timing window add",input:{type:"slider",min:0,step:.001,max:1,hardMax:2**31-1},tooltip:"Adds this value (in seconds) to all timing windows."}]}]},{type:"group",id:"performance",label:"Performance",children:[{type:"item",label:"Antialiasing",id:"performance.antialiasing",input:{type:"checkbox"}},{type:"item",label:"Resolution",id:"performance.resolution",input:{type:"slider",min:1,step:1,max:4,hardMin:0,hardMax:2**31-1},tooltip:"Requires a reload."}]},{type:"group",id:"debug",label:"Debug",children:[{type:"item",label:"Show FPS",id:"debug.showFPS",input:{type:"checkbox"}},{type:"item",label:"Show rendering timers",id:"debug.showTimers",input:{type:"checkbox"}},{type:"item",label:"Show noteskin errors",id:"debug.showNoteskinErrors",input:{type:"checkbox"}},{type:"item",label:"Show scrolls/speeds debug visual",id:"debug.showScroll",input:{type:"checkbox"}},{type:"subgroup",label:"Parity",children:[{type:"item",label:"Show parity graph",id:"debug.parity.showGraph",input:{type:"checkbox"}},{type:"item",label:"Show debug stats",id:"debug.parity.showDebug",input:{type:"checkbox"}},{type:"item",label:"Limit graph nodes",tooltip:"Limits the number of nodes in each row of the parity graph to 8.",id:"debug.parity.limitGraph",input:{type:"checkbox"}}]}]}];class km extends ct{app;observer;sectionContainer;constructor(e){super({title:"Options",width:600,height:400,disableClose:!1,win_id:"user_options",blocking:!1}),this.app=e,this.initView(),ie.on("resize",()=>{this.center()})}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-container");const n=document.createElement("div");n.classList.add("pref-search");const a=document.createElement("input");a.classList.add("pref-search-bar"),a.type="text",a.placeholder="Search for an option...",a.oninput=()=>{s.replaceChildren(),o.replaceChildren(...this.createOptions(this.filterOptions(a.value)))},n.appendChild(a);const r=document.createElement("div");r.classList.add("pref-scrollers");const s=document.createElement("div");s.classList.add("pref-section-scroller"),this.sectionContainer=s;const o=document.createElement("div");o.classList.add("pref-option-scroller"),r.replaceChildren(s,o),this.observer=new IntersectionObserver(l=>{l.forEach(u=>{const f=u.target.dataset.id,c=s.querySelector(`.pref-section[data-id=${f}]`);c&&(u.intersectionRatio>0?c.classList.add("selected"):c.classList.remove("selected"))})},{}),t.replaceChildren(n,r),s.replaceChildren(),o.replaceChildren(...this.createOptions(Ac)),e.appendChild(t),this.viewElement.appendChild(e)}createOptions(e){return e.filter(t=>!t.disable?.(this.app)).map(t=>{const n=this.makeOption(t);return t.type=="group"&&(this.observer.observe(n),this.sectionContainer?.appendChild(this.createEmptyGroup(t))),n})}makeOption(e){const t=document.createElement("div");t.classList.add("pref-"+e.type),(e.type=="group"||e.type=="item")&&(t.dataset.id=e.id);const n=document.createElement("div");n.classList.add(`pref-${e.type}-label`,"label"),e.label!==void 0&&(n.innerText=e.label,t.appendChild(n));const a=be.getIcon("REVERT",12);if(e.type=="item"&&(a.addEventListener("click",()=>{b.applyOption([e.id,b.getDefaultOption(e.id)]);const r=e.input.onChange;r?.(this.app,b.getDefaultOption(e.id)),t.replaceWith(this.makeOption(e))}),a.style.display=b.getDefaultOption(e.id)===b.getOption(e.id)?"none":"block",t.appendChild(a)),e.type=="item"){if(n.innerText=e.label,!e.input)return t;const r=b.getOption(e.id),s={...e.input},o=s.onChange;s.onChange=(u,f)=>{b.applyOption([e.id,f]),a.style.display=b.getDefaultOption(e.id)===b.getOption(e.id)?"none":"block",o?.(u,f)};const l=mu(this.app,s,r);e.input.type=="checkbox"&&l.classList.add("pref-input","right"),e.input.type=="dropdown"&&l.classList.add("pref-input","dropdown-right"),l.classList.add("pref-item-input"),t.appendChild(l)}else{const r=document.createElement("div");r.classList.add("pref-children"),t.appendChild(r),r.replaceChildren(...this.createOptions(e.children))}return e.type=="item"&&e.tooltip!==void 0&&Xe(t,{content:e.tooltip}),t}filterOptions(e,t=Ac){const n=[];return t.forEach(a=>{if(a.label&&a.label.toLowerCase().includes(e.toLowerCase())){n.push(a);return}if(a.type=="group"||a.type=="subgroup"){const r=this.filterOptions(e,a.children);r.length!=0&&n.push({...a,children:r})}}),n}createEmptyGroup(e){const t=document.createElement("div");return t.classList.add("pref-section"),t.dataset.id=e.id,t.innerText=e.label,t.onclick=()=>{t.parentElement.parentElement.querySelector(`.pref-group[data-id=${e.id}]`).scrollIntoView()},t}onClose(){this.observer?.disconnect()}}var On=(i=>(i.SHIFT="Shift",i.CTRL="Ctrl",i.ALT="Alt",i.META="Command",i))(On||{});const nt=ei?"Command":"Ctrl",Sm={Shift:ei?"⇧":"Shift",Ctrl:ei?"⌃":"Ctrl",Alt:ei?"⌥":"Alt",Command:"⌘"},kc={ArrowLeft:"Left",ArrowUp:"Up",ArrowRight:"Right",ArrowDown:"Down",BracketLeft:"[",BracketRight:"]",Semicolon:";",Quote:"'",Backslash:"\\",Slash:"/",Period:".",Comma:",",Backquote:"`",Minus:"-",Equal:"+"},Qu={Home:ei?"fn Left":"Home",End:ei?"fn Right":"End",PageUp:ei?"fn Up":"PageUp",PageDown:ei?"fn Down":"PageDown"},Ga=["ctrlKey","altKey","shiftKey","metaKey"],Ba=["Ctrl","Alt","Shift","Command"],$e={playback:{label:"Play/Pause",combos:[{key:"Space",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.playPause()},decreaseSnap:{label:"Decrease snap",combos:[{key:"Left",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.previousSnap()},increaseSnap:{label:"Increase snap",combos:[{key:"Right",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.nextSnap()},cursorUp:{label:"Move cursor up",combos:[{key:"Up",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>{b.chart.scroll.invertReverseScroll&&b.chart.reverse?i.chartManager.snapToNextTick():i.chartManager.snapToPreviousTick()}},cursorDown:{label:"Move cursor down",combos:[{key:"Down",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>{b.chart.scroll.invertReverseScroll&&b.chart.reverse?i.chartManager.snapToPreviousTick():i.chartManager.snapToNextTick()}},increaseScrollSpeed:{label:"Increase scroll speed",combos:[{key:"Up",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView,callback:()=>b.chart.speed=Math.max(10,b.chart.speed*Math.pow(1.01,30))},decreaseScrollSpeed:{label:"Decrease scroll speed",combos:[{key:"Down",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView,callback:()=>b.chart.speed=Math.max(10,b.chart.speed*Math.pow(1.01,-30))},zoomIn:{label:"Zoom in",combos:[{key:"+",mods:[nt]}],disabled:i=>!i.chartManager.chartView,callback:()=>{b.chart.zoom+=.1,ce.create("Zoom: "+Math.round(b.chart.zoom*100)+"%")}},zoomOut:{label:"Zoom out",combos:[{key:"-",mods:[nt]}],disabled:i=>!i.chartManager.chartView,callback:()=>{b.chart.zoom=Math.max(.1,b.chart.zoom-.1),ce.create("Zoom: "+Math.round(b.chart.zoom*100)+"%")}},zoomDefault:{label:"Reset zoom",combos:[{key:"0",mods:[nt]}],disabled:i=>!i.chartManager.chartView,callback:()=>{b.chart.zoom=1,ce.create("Zoom: "+Math.round(b.chart.zoom*100)+"%")}},newSong:{label:"New song...",bindLabel:"New song",combos:[{key:"N",mods:[nt]}],disabled:i=>!i.chartManager.loadedSM||!fe.openWindows,callback:i=>{i.windowManager.openWindow(new Xu(i))}},openSong:{label:"Open song...",bindLabel:"Open song",combos:[{key:"O",mods:[nt]}],disabled:i=>!i.chartManager.loadedSM||!fe.openWindows,callback:i=>{if(window.nw){const e=document.createElement("input");e.type="file",e.accept=".sm,.ssc",e.onchange=()=>i.chartManager.loadSM(e.value),e.click()}else i.windowManager.openWindow(new Lo(i,!1))}},songProperties:{label:"Song properties...",bindLabel:"Open song properties",combos:[{key:"O",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedSM||!fe.openWindows,callback:i=>i.windowManager.openWindow(new xm(i))},save:{label:"Save...",bindLabel:"Save",combos:[{key:"S",mods:[nt]}],disabled:i=>!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>i.chartManager.save()},export:{label:"Save and export current song",combos:[{key:"E",mods:[nt]}],disabled:i=>!!window.nw||!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>{i.chartManager.save(),Ce.getStandardHandler().saveDirectory(i.chartManager.smPath)}},exportNotedata:{label:"Export to notedata...",bindLabel:"Export to notedata",combos:[{key:"E",mods:[nt,"Shift"]}],disabled:i=>!i.chartManager.loadedSM||!fe.openWindows,callback:i=>i.windowManager.openWindow(new mm(i,i.chartManager.selection.notes))},capture:{label:"Export video...",combos:[],disabled:i=>!i.chartManager.loadedSM||!fe.openWindows,callback:i=>{i.windowManager.openWindow(new lf(i))}},previousSong:{label:"Previous song in pack",combos:[{key:"F5",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>{const e=Ce.getStandardHandler();if(!e)return;const t=e.resolvePath(at(i.chartManager.smPath),"..");async function n(){const a=await e.getDirectoryFolders(t);a.sort((s,o)=>s.name.localeCompare(o.name));let r=a.findIndex(s=>s.name==Tt(at(i.chartManager.smPath)));if(r==-1){ce.createFormatted("An error occured while finding the song pack!","error"),console.error(`Couldn't find the current song idx in parent folder! Path: ${Tt(at(i.chartManager.smPath))}, Folders`,a);return}for(r--;r>=0;){const s=a[r],o=await e.getDirectoryFiles(s),l=o.find(u=>u.name.endsWith(".ssc"))??o.find(u=>u.name.endsWith(".sm"));if(l){const u=e.resolvePath(t,s.name,l.name);ce.create(`Loading ${s.name}/${l.name}`),i.chartManager.loadSM(u);return}r--}ce.create("No previous song in pack")}try{n()}catch(a){ce.createFormatted("No songs found!","error"),console.error(a)}}},nextSong:{label:"Next song in pack",combos:[{key:"F6",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>{const e=Ce.getStandardHandler();if(!e)return;const t=e.resolvePath(at(i.chartManager.smPath),"..");async function n(){const a=await e.getDirectoryFolders(t);a.sort((s,o)=>s.name.localeCompare(o.name));let r=a.findIndex(s=>s.name==Tt(at(i.chartManager.smPath)));if(r==-1){ce.createFormatted("An error occured while finding the song pack!","error"),console.error(`Couldn't find the current song idx in parent folder! Path: ${Tt(at(i.chartManager.smPath))}, Folders`,a);return}for(r++;r<a.length;){const s=a[r],o=await e.getDirectoryFiles(s),l=o.find(u=>u.name.endsWith(".ssc"))??o.find(u=>u.name.endsWith(".sm"));if(l){const u=e.resolvePath(t,s.name,l.name);ce.create(`Loading ${s.name}/${l.name}`),i.chartManager.loadSM(u);return}r++}ce.create("No next song in pack")}try{n()}catch(a){ce.createFormatted("No songs found!","error"),console.error(a)}}},openChart:{label:"Chart list",bindLabel:"Open chart list",combos:[{key:"O",mods:[nt,"Shift"]}],disabled:i=>!i.chartManager.loadedSM||!fe.openWindows,callback:i=>i.windowManager.openWindow(new ju(i))},timingDataRow:{label:"Edit timing data at row",combos:[{key:"T",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView||!fe.openWindows,callback:i=>i.windowManager.openWindow(new Am(i))},selectRegion:{label:"Select region",combos:[{key:"Tab",mods:[]}],disabled:i=>!i.chartManager.loadedChart&&i.chartManager.getMode()!=W.Edit,callback:i=>i.chartManager.selectRegion()},volumeUp:{label:"Increase master volume",combos:[{key:"Up",mods:["Alt"]}],disabled:!1,callback:()=>{b.audio.masterVolume=Math.min(b.audio.masterVolume+.05,1),ce.create("Master volume: "+Math.round(b.audio.masterVolume*100)+"%")}},volumeDown:{label:"Decrease master volume",combos:[{key:"Down",mods:["Alt"]}],disabled:!1,callback:()=>{b.audio.masterVolume=Math.max(b.audio.masterVolume-.05,0),ce.create("Master volume: "+Math.round(b.audio.masterVolume*100)+"%")}},songVolumeUp:{label:"Increase song volume",combos:[{key:"Up",mods:["Shift","Alt"]}],disabled:!1,callback:()=>{b.audio.songVolume=Math.min(b.audio.songVolume+.05,1),ce.create("Song volume: "+Math.round(b.audio.songVolume*100)+"%")}},songVolumeDown:{label:"Decrease song volume",combos:[{key:"Down",mods:["Shift","Alt"]}],disabled:!1,callback:()=>{b.audio.songVolume=Math.max(b.audio.songVolume-.05,0),ce.create("Song volume: "+Math.round(b.audio.songVolume*100)+"%")}},effectvolumeUp:{label:"Increase tick/metronome volume",combos:[{key:"Up",mods:["Shift",nt,"Alt"]}],disabled:!1,callback:()=>{b.audio.soundEffectVolume=Math.min(b.audio.soundEffectVolume+.05,1),ce.create("Effect volume: "+Math.round(b.audio.soundEffectVolume*100)+"%")}},effectvolumeDown:{label:"Decrease tick/metronome volume",combos:[{key:"Down",mods:["Shift",nt,"Alt"]}],disabled:!1,callback:()=>{b.audio.soundEffectVolume=Math.max(b.audio.soundEffectVolume-.05,0),ce.create("Effect Volume: "+Math.round(b.audio.soundEffectVolume*100)+"%")}},rateUp:{label:"Increase playback rate",combos:[{key:"Right",mods:["Shift"]}],disabled:i=>i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:()=>{b.audio.rate+=.05,ce.create("Playback Rate: "+Math.round(b.audio.rate*100)+"%")}},rateDown:{label:"Decrease playback rate",combos:[{key:"Left",mods:["Shift"]}],disabled:i=>i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:()=>{b.audio.rate=Math.max(b.audio.rate-.05,.1),ce.create("Playback Rate: "+Math.round(b.audio.rate*100)+"%")}},rateDefault:{label:"Reset playback rate",combos:[],disabled:!1,callback:()=>{b.audio.rate=1,ce.create("Playback Rate: "+Math.round(b.audio.rate)+"%")}},previousStream:{label:"Previous stream",combos:[{key:"Up",mods:[nt]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>{const e=[];for(const n of i.chartManager.loadedChart.stats.streams)e.at(-1)==n.startBeat&&e.pop(),e.push(n.startBeat),e.push(n.endBeat);const t=ka(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},nextStream:{label:"Next stream",combos:[{key:"Down",mods:[nt]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>{const e=[];for(const n of i.chartManager.loadedChart.stats.streams)e.at(-1)==n.startBeat&&e.pop(),e.push(n.startBeat),e.push(n.endBeat);const t=Aa(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},previousMeasure:{label:"Previous measure",combos:[{key:"PageUp",mods:[]},{key:";",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>{const e=i.chartManager.beat;if(b.chart.scroll.invertReverseScroll&&b.chart.reverse){const t=i.chartManager.loadedChart.timingData.getMeasureLength(e);i.chartManager.snapToNearestTick(Math.max(0,e+t))}else{const t=i.chartManager.loadedChart.timingData.getMeasureLength(e-.001);i.chartManager.snapToNearestTick(Math.max(0,e-t))}}},nextMeasure:{label:"Next measure",combos:[{key:"PageDown",mods:[]},{key:"'",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>{const e=i.chartManager.beat;if(b.chart.scroll.invertReverseScroll&&b.chart.reverse){const t=i.chartManager.loadedChart.timingData.getMeasureLength(e-.001);i.chartManager.snapToNearestTick(Math.max(0,e-t))}else{const t=i.chartManager.loadedChart.timingData.getMeasureLength(e);i.chartManager.snapToNearestTick(Math.max(0,e+t))}}},previousNote:{label:"Previous note",combos:[{key:",",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.previousNote()},nextNote:{label:"Next note",combos:[{key:".",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.nextNote()},jumpChartStart:{label:"Jump to first note",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.firstNote()},jumpChartEnd:{label:"Jump to last note",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.lastNote()},jumpSongStart:{label:"Jump to song start",combos:[{key:"Home",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.beat=Math.max(0,i.chartManager.loadedChart.getBeatFromSeconds(0))},jumpSongEnd:{label:"Jump to song end",combos:[{key:"End",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.beat=i.chartManager.loadedChart.getBeatFromSeconds(i.chartManager.chartAudio.getSongLength())},jumpPreviousCandle:{label:"Jump to previous candle",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.stats.parity,t=e.candles.keys().map(a=>e.rowTimestamps[a].beat).toArray().sort((a,r)=>a-r),n=ka(t,i.chartManager.beat);n!==null&&(i.chartManager.beat=n)}},jumpNextCandle:{label:"Jump to next candle",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.stats.parity,t=e.candles.keys().map(a=>e.rowTimestamps[a].beat).toArray().sort((a,r)=>a-r),n=Aa(t,i.chartManager.beat);n!==null&&(i.chartManager.beat=n)}},jumpPreviousError:{label:"Jump to previous error",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.getTechErrors().map(n=>n.beat),t=ka(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},jumpNextError:{label:"Jump to next error",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.getTechErrors().map(n=>n.beat),t=Aa(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},assistTick:{label:"Assist tick",combos:[{key:"F7",mods:[]}],disabled:()=>!fe.assist,callback:()=>{b.audio.assistTick=!b.audio.assistTick,ce.create("Assist Tick: "+(b.audio.assistTick?"on":"off"))}},metronome:{label:"Metronome",combos:[{key:"F7",mods:["Alt"]}],disabled:()=>!fe.assist,callback:()=>{b.audio.metronome=!b.audio.metronome,ce.create("Metronome: "+(b.audio.metronome?"on":"off"))}},XMod:{label:"XMod (Beat-based)",combos:[{key:"X",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.CMod=!1,ce.create("Switched to XMod")}},CMod:{label:"CMod (Time-based)",combos:[{key:"C",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.CMod=!0,ce.create("Switched to CMod")}},reverse:{label:"Reverse playfield",combos:[],disabled:!1,callback:()=>{b.chart.reverse=!b.chart.reverse,ce.create("Reverse Playfield: "+(b.chart.reverse?"on":"off"))}},hideWarpedArrows:{label:"Hide warped notes (CMod only)",combos:[{key:"W",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.hideWarpedArrows=!b.chart.hideWarpedArrows,ce.create("Hide Warped Arrows: "+(b.chart.hideWarpedArrows?"on":"off"))}},hideFakedArrows:{label:"Hide faked notes (CMod only)",combos:[{key:"F",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.hideFakedArrows=!b.chart.hideFakedArrows,ce.create("Hide Faked Arrows: "+(b.chart.hideFakedArrows?"on":"off"))}},doSpeedChanges:{label:"Do speed changes (XMod only)",combos:[{key:"S",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.doSpeedChanges=!b.chart.doSpeedChanges,ce.create("Speed Changes: "+(b.chart.doSpeedChanges?"on":"off"))}},showEq:{label:"Equalizer",combos:[{key:"E",mods:["Shift"]}],disabled:i=>!i.chartManager.chartAudio||!fe.openWindows,callback:i=>i.windowManager.openWindow(new fm(i))},detectSync:{label:"Detect audio sync",combos:[{key:"L",mods:["Shift"]}],disabled:i=>!i.chartManager.chartAudio||!fe.openWindows,callback:i=>i.windowManager.openWindow(new Zu(i))},previousNoteType:{label:"Previous note type",combos:[{key:"N",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.previousNoteType()},nextNoteType:{label:"Next note type",combos:[{key:"M",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.Record,callback:i=>i.chartManager.nextNoteType()},undo:{label:"Undo",combos:[{key:"Z",mods:[nt]}],disabled:i=>!i.actionHistory.canUndo()||i.chartManager.getMode()!=W.Edit,callback:i=>i.actionHistory.undo()},redo:{label:"Redo",combos:[{key:"Y",mods:[nt]},{key:"Z",mods:[nt,"Shift"]}],disabled:i=>!i.actionHistory.canRedo()||i.chartManager.getMode()!=W.Edit,callback:i=>i.actionHistory.redo()},mousePlacement:{label:"Enable Mouse Note Placement",combos:[{key:"M",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.mousePlacement=!b.chart.mousePlacement,ce.create("Mouse Note Placement: "+(b.chart.mousePlacement?"on":"off"))}},playMode:{label:"Enter/Exit Play Mode",combos:[{key:"P",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Record||!fe.playMode,callback:i=>i.chartManager.setMode(W.Play)},recordMode:{label:"Enter/Exit Record Mode",combos:[{key:"R",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.View||!fe.recordMode,callback:i=>i.chartManager.setMode(W.Record)},playModeStart:{label:"Play from start",combos:[{key:"P",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Record||!fe.playMode,callback:i=>{i.chartManager.beat=0,i.chartManager.setMode(W.Play)}},recordModeStart:{label:"Record from start",combos:[{key:"R",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==W.Play||i.chartManager.getMode()==W.View||!fe.recordMode,callback:i=>i.chartManager.setMode(W.Record)},options:{label:"Options...",bindLabel:"Edit options",combos:[{key:",",mods:[nt]}],disabled:()=>!fe.openWindows||!fe.openWindows,callback:i=>{i.windowManager.openWindow(new km(i))}},keybinds:{label:"Keybinds...",bindLabel:"Edit keybinds",combos:[],disabled:()=>!fe.openWindows||!fe.openWindows,callback:i=>{i.windowManager.openWindow(new ci(i))}},gameplayKeybinds:{label:"Gameplay keybinds...",bindLabel:"Edit gameplay keybinds",combos:[],disabled:()=>!fe.openWindows||!fe.openWindows,callback:i=>{i.windowManager.openWindow(new gm(i))}},themes:{label:"Themes...",bindLabel:"Edit themes",combos:[],disabled:()=>!fe.openWindows||!fe.openWindows||sa.isOpen,callback:i=>{i.windowManager.openWindow(new Ys(i))}},convertHoldsRolls:{label:"Holds to rolls",bindLabel:"Convert holds to rolls",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Hold"&&(e.type="Roll"),e))}},convertRollsHolds:{label:"Rolls to holds",bindLabel:"Convert rolls to holds",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Roll"&&(e.type="Hold"),e))}},swapHoldsRolls:{label:"Swap holds and rolls",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Hold"?e.type="Roll":e.type=="Roll"&&(e.type="Hold"),e))}},convertHoldsTaps:{label:"Holds/rolls to taps",bindLabel:"Convert holds/rolls to taps",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>((e.type=="Hold"||e.type=="Roll")&&(e.type="Tap"),e))}},convertTapsMines:{label:"Taps to mines",bindLabel:"Convert taps to mines",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Tap"&&(e.type="Mine"),e))}},convertTapsLifts:{label:"Taps to lifts",bindLabel:"Convert taps to lifts",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Tap"&&(e.type="Lift"),e))}},convertTapsFakes:{label:"Taps to fakes",bindLabel:"Convert taps to fakes",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Tap"&&(e.type="Fake"),e))}},mirrorHorizontally:{label:"Horizontally",bindLabel:"Mirror horizontally",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.col=i.chartManager.loadedChart.gameType.flipColumns.horizontal[e.col],e))}},mirrorVertically:{label:"Vertically",bindLabel:"Mirror vertically",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.col=i.chartManager.loadedChart.gameType.flipColumns.vertical[e.col],e))}},mirrorBoth:{label:"Both",bindLabel:"Mirror both",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.col=i.chartManager.loadedChart.gameType.flipColumns.horizontal[e.col],e.col=i.chartManager.loadedChart.gameType.flipColumns.vertical[e.col],e))}},selectBeforeCursor:{label:"Select before cursor",combos:[{key:"Home",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedChart,callback:i=>{i.chartManager.editTimingMode==Se.Off?i.chartManager.setNoteSelection(i.chartManager.loadedChart.getNotedata().filter(e=>e.beat<i.chartManager.beat)):i.chartManager.setEventSelection(i.chartManager.loadedChart.timingData.getTimingData().filter(e=>e.beat<i.chartManager.beat))}},selectAfterCursor:{label:"Select after cursor",combos:[{key:"End",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedChart,callback:i=>{i.chartManager.editTimingMode==Se.Off?i.chartManager.setNoteSelection(i.chartManager.loadedChart.getNotedata().filter(e=>e.beat>i.chartManager.beat)):i.chartManager.setEventSelection(i.chartManager.loadedChart.timingData.getTimingData().filter(e=>e.beat>i.chartManager.beat))}},selectAll:{label:"Select all",combos:[{key:"A",mods:[nt]}],disabled:i=>!i.chartManager.loadedChart,callback:i=>{i.chartManager.editTimingMode==Se.Off?i.chartManager.setNoteSelection(i.chartManager.loadedChart.getNotedata()):i.chartManager.setEventSelection(i.chartManager.loadedChart.timingData.getTimingData())}},expand2to1:{label:"Expand 2:1 (8th to 4th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=W.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*2+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=2,t.hold=Math.round(t.hold*48)/48),t))}},expand3to2:{label:"Expand 3:2 (12th to 8th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=W.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*1.5+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=1.5,t.hold=Math.round(t.hold*48)/48),t))}},expand4to3:{label:"Expand 4:3 (16th to 2th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=W.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*4/3+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=4/3,t.hold=Math.round(t.hold*48)/48),t))}},compress1to2:{label:"Compress 1:2 (4th to 8th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=W.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)/2+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold/=2,t.hold=Math.round(t.hold*48)/48),t))}},compress2to3:{label:"Compress 2:3 (8th to 12th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=W.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)/1.5+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold/=1.5,t.hold=Math.round(t.hold*48)/48),t))}},compress3to4:{label:"Compress 3:4 (12th to 16th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=W.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*.75+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=.75,t.hold=Math.round(t.hold*48)/48),t))}},delete:{label:"Delete",combos:[{key:"Backspace",mods:[]},{key:"Delete",mods:[]}],disabled:i=>i.chartManager.getMode()!=W.Edit||i.chartManager.selection.notes.length==0&&i.chartManager.eventSelection.timingEvents.length==0,callback:i=>{i.chartManager.deleteSelection(),i.chartManager.deleteEventSelection()}},paste:{label:"Paste",combos:[{mods:[nt],key:"V"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:async i=>{const e=await navigator.clipboard.readText();i.chartManager.paste(e)}},pasteReplace:{label:"Clear and paste",combos:[{mods:[nt,"Shift"],key:"V"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:async i=>{const e=await navigator.clipboard.readText();i.chartManager.paste(e,!0)}},copy:{label:"Copy",combos:[{mods:[nt],key:"C"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit||!i.chartManager.hasSelection(),callback:async i=>{const e=i.chartManager.copy();e&&await navigator.clipboard.writeText(e)}},cut:{label:"Cut",combos:[{mods:[nt],key:"X"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit||!i.chartManager.hasSelection(),callback:async i=>{const e=i.chartManager.copy();e&&await navigator.clipboard.writeText(e),i.chartManager.deleteSelection()}},adjustOffset:{label:"Adjust offset",combos:[],disabled:()=>!fe.openWindows,callback:i=>i.windowManager.openWindow(new vm(i))},setSongPreview:{label:"Set as song preview",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit||!i.chartManager.hasRange(),callback:i=>{const e=i.chartManager.loadedChart,t=i.chartManager.loadedSM.properties.SAMPLESTART??"0",n=i.chartManager.loadedSM.properties.SAMPLELENGTH??"10";let a="",r="";if(i.chartManager.startRegion!==void 0&&i.chartManager.endRegion!==void 0){const s=e.getSecondsFromBeat(i.chartManager.startRegion),o=e.getSecondsFromBeat(i.chartManager.endRegion);a=he(s,3).toString(),r=he(o-s,3).toString()}else{const o=(i.chartManager.selection.notes.length>0?i.chartManager.selection.notes:i.chartManager.eventSelection.timingEvents).map(f=>f.beat),l=e.getSecondsFromBeat(xn(o)),u=e.getSecondsFromBeat($a(o));a=he(l,3).toString(),r=he(u-l,3).toString()}Mt.instance.run({action:s=>{s.chartManager.loadedSM.properties.SAMPLESTART=a,s.chartManager.loadedSM.properties.SAMPLELENGTH=r},undo:()=>{i.chartManager.loadedSM.properties.SAMPLESTART=t,i.chartManager.loadedSM.properties.SAMPLELENGTH=n}})}},showDebugTimers:{label:"Toggle Debug Timers",combos:[{key:"F3",mods:["Shift"]}],disabled:!1,callback:()=>{b.debug.showTimers=!b.debug.showTimers}},showFPSCounter:{label:"Toggle FPS Counter",combos:[{key:"F3",mods:[]}],disabled:!1,callback:()=>{b.debug.showFPS=!b.debug.showFPS}},noteTypeTap:{label:"Switch to Taps",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.setEditingNoteType("Tap")}},noteTypeLift:{label:"Switch to Lifts",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.setEditingNoteType("Lift")}},noteTypeMine:{label:"Switch to Mines",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.setEditingNoteType("Mine")}},noteTypeFake:{label:"Switch to Fakes",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.setEditingNoteType("Fake")}},openGuide:{label:"Open Help Guide",combos:[],disabled:!1,callback:()=>{window.open("/smeditor/guide/")}},openChangelog:{label:"Open Changelog",combos:[],disabled:()=>!fe.openWindows,callback:i=>{i.windowManager.openWindow(new Vu(i))}},noteskinWindow:{label:"Noteskins...",bindLabel:"Open Noteskin Window",combos:[{mods:["Shift"],key:"N"}],disabled:i=>!i.chartManager.chartView||!fe.openWindows,callback:i=>i.windowManager.openWindow(new wm(i))},previousChart:{label:"Previous chart",combos:[{key:"F5",mods:[]}],disabled:i=>!i.chartManager.chartView,callback:i=>{if(!i.chartManager.loadedSM?.charts||!i.chartManager.loadedChart)return;const e=i.chartManager.loadedSM?.charts[i.chartManager.loadedChart.gameType.id],t=e.indexOf(i.chartManager.loadedChart);e[t-1]?i.chartManager.loadChart(e[t-1]):ce.create("No previous chart")}},nextChart:{label:"Next chart",combos:[{key:"F6",mods:[]}],disabled:i=>!i.chartManager.chartView,callback:i=>{if(!i.chartManager.loadedSM?.charts||!i.chartManager.loadedChart)return;const e=i.chartManager.loadedSM?.charts[i.chartManager.loadedChart.gameType.id],t=e.indexOf(i.chartManager.loadedChart);e[t+1]?i.chartManager.loadChart(e[t+1]):ce.create("No next chart")}},toggleEditTiming:{label:"Toggle Edit Timing",combos:[{key:"T",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.editTimingMode!=Se.Off?i.chartManager.editTimingMode=Se.Off:i.chartManager.editTimingMode=Se.Edit}},toggleAddTiming:{label:"Toggle Add Timing",combos:[{key:"T",mods:["Alt"]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=W.Edit,callback:i=>{i.chartManager.editTimingMode!=Se.Add?i.chartManager.editTimingMode=Se.Add:i.chartManager.editTimingMode=Se.Edit}},about:{label:"About",combos:[],disabled:()=>!fe.openWindows,callback:i=>{i.windowManager.openWindow(new lh(i))}},enableParity:{label:"Enable parity checking",combos:[{key:"E",mods:[]}],disabled:!1,callback:()=>{b.chart.parity.enabled=!b.chart.parity.enabled,ce.create("Parity Checking: "+(b.chart.parity.enabled?"on":"off"))}},showTechErrors:{label:"Show tech errors",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showErrors=!b.chart.parity.showErrors,ce.create("Tech Errors: "+(b.chart.parity.showErrors?"on":"off"))}},showFootHighlights:{label:"Show foot highlights",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showHighlights=!b.chart.parity.showHighlights,ce.create("Foot Highlights: "+(b.chart.parity.showHighlights?"on":"off"))}},showDancingBot:{label:"Show dancing bot",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showDancingBot=!b.chart.parity.showDancingBot,ce.create("Dancing Bot: "+(b.chart.parity.showDancingBot?"on":"off"))}},showTechNotation:{label:"Show tech notation",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showTech=!b.chart.parity.showTech,ce.create("Tech Notation: "+(b.chart.parity.showTech?"on":"off"))}},showCandles:{label:"Show candles",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showCandles=!b.chart.parity.showCandles,ce.create("Candles: "+(b.chart.parity.showCandles?"on":"off"))}}};for(const i of[4,2,1])$e[`shiftUp${i}m`]={label:`${i} measure`+(i==1,""),bindLabel:`Shift up by ${i} measure`+(i==1,""),combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>{const t=e.chartManager.selection.notes[0].beat,n=e.chartManager.loadedChart.timingData.getMeasureLength(t);e.chartManager.modifySelection(a=>(a.beat-=n*i,a),!0)}},$e[`shiftDown${i}m`]={label:`${i} measure`+(i==1,""),bindLabel:`Shift down by ${i} measure`+(i==1,""),combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>{const t=e.chartManager.selection.notes[0].beat,n=e.chartManager.loadedChart.timingData.getMeasureLength(t);e.chartManager.modifySelection(a=>(a.beat+=n*i,a),!0)}};for(let i=0;i<Mn.length;i++)$e["quant"+Oo[i]]={label:`Switch to ${si[i]}s`,combos:[],disabled:e=>!e.chartManager.chartView,callback:()=>{b.chart.snap=Mn[i]}},$e[`shiftUp${si[i]}`]={label:`${si[i]}`,bindLabel:`Shift up by ${si[i]}`,combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>e.chartManager.modifySelection(t=>(t.beat-=Mn[i],t),!0)},$e[`shiftDown${si[i]}`]={label:`${si[i]}`,bindLabel:`Shift down by ${si[i]}`,combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>e.chartManager.modifySelection(t=>(t.beat+=Mn[i],t),!0)},i!=Mn.length-1&&($e["quantize"+si[i]]={label:`${si[i]}s`,bindLabel:`Quantize to ${si[i]}s`,combos:[],disabled:e=>e.chartManager.selection.notes.length==0||e.chartManager.getMode()!=W.Edit,callback:e=>{e.chartManager.modifySelection(t=>(t.beat=e.chartManager.getClosestTick(t.beat,Oo[i]),t.beat=Math.round(t.beat*48)/48,t))}});for(const i of["STOPS","DELAYS"])$e[`convert${i}`]={label:`Convert to ${i[0]}${i.slice(1).toLowerCase()}`,combos:[],disabled:e=>!e.chartManager.chartView||e.chartManager.getMode()!=W.Edit||!e.chartManager.hasRange(),callback:e=>{const t=e.chartManager.loadedChart;let n=0,a=0;if(e.chartManager.startRegion!==void 0&&e.chartManager.endRegion!==void 0){const r=t.getSecondsFromBeat(e.chartManager.startRegion),s=t.getSecondsFromBeat(e.chartManager.endRegion);n=e.chartManager.startRegion,a=s-r}else{const s=(e.chartManager.selection.notes.length>0?e.chartManager.selection.notes:e.chartManager.eventSelection.timingEvents).map(u=>u.beat),o=t.getSecondsFromBeat(xn(s)),l=t.getSecondsFromBeat($a(s));n=xn(s),a=l-o}e.chartManager.loadedChart.timingData.insertColumnEvents([{type:i,beat:n,value:a}])}};for(const i of["WARPS","FAKES"])$e[`convert${i}`]={label:`Convert to ${i[0]}${i.slice(1).toLowerCase()}`,combos:[],disabled:e=>!e.chartManager.chartView||e.chartManager.getMode()!=W.Edit||!e.chartManager.hasRange(),callback:e=>{let t=0,n=0;if(e.chartManager.startRegion!==void 0&&e.chartManager.endRegion!==void 0)t=e.chartManager.startRegion,n=e.chartManager.endRegion-e.chartManager.startRegion;else{const r=(e.chartManager.selection.notes.length>0?e.chartManager.selection.notes:e.chartManager.eventSelection.timingEvents).map(s=>s.beat);t=xn(r),n=$a(r)-xn(r)}e.chartManager.loadedChart.timingData.insertColumnEvents([{type:i,beat:t,value:n}])}};for(const i of["None","Left","Right"])$e[`parity${i}`]={label:`Mark as ${i}`,combos:[],disabled:e=>!e.chartManager.chartView||e.chartManager.getMode()!=W.Edit||!e.chartManager.hasNoteSelection(),callback:e=>{const t=e.chartManager.selection.notes.filter(s=>s.type!="Mine"&&s.type!="Fake"&&!s.fake&&!s.warped);let n=Number.MAX_VALUE,a=-Number.MAX_VALUE;t.forEach(s=>{s.beat<n&&(n=s.beat),Ni(s)>a&&(a=Ni(s))});const r=[];Mt.instance.run({action:s=>{t.forEach(o=>{o.parity||(o.parity={}),r.push(o.parity.override),o.parity.override=i=="None"?void 0:i}),s.chartManager.loadedChart.recalculateStats(n,a),ie.emit("chartModified")},undo:()=>{t.forEach((s,o)=>{s.parity||(s.parity={}),s.parity.override=r[o]}),e.chartManager.loadedChart.recalculateStats(n,a),ie.emit("chartModified")},redo:()=>{t.forEach(s=>{s.parity||(s.parity={}),s.parity.override=i=="None"?void 0:i}),e.chartManager.loadedChart.recalculateStats(n,a),ie.emit("chartModified")}})}};class Do{static popup;static build(e){const t=document.createElement("div");t.classList.add("update-popup");const n=document.createElement("div");n.classList.add("title"),n.innerText=e.title;const a=document.createElement("div");a.classList.add("desc"),a.innerText=e.desc;const r=document.createElement("div");if(r.classList.add("update-options"),t.replaceChildren(n,a),e.options.length>0){for(const s of e.options){const o=document.createElement("button");o.innerText=s.label,o.onclick=()=>{s.callback?.(this)},o.classList.add(s.type),r.appendChild(o)}t.appendChild(r)}this.popup=t,document.getElementById("popups")?.appendChild(this.popup)}static close(){this.popup&&(this.popup.classList.add("exiting"),this.popup.style.pointerEvents="none",setTimeout(()=>this.popup.remove(),300))}}class Ju extends Do{static open(e,t){super.build({title:`A new version of the desktop app is available! (${e})`,desc:"Click here to download the new version.",options:[{label:"Close",type:"default",callback:()=>this.close()},{label:"Download",type:"confirm",callback:()=>{localStorage.setItem("downloadedVersion",e),nw.require("nw.gui").Shell.openExternal(t),this.close()}}]})}}class ed extends Do{static open(e){super.build({title:"A new version of the app is available!",desc:"Refresh the page to get the new version.",options:[{label:"Close",type:"default",callback:()=>this.close()},{label:"Refresh",type:"confirm",callback:()=>{e(),window.location.reload()}}]})}}class Tm extends Do{static open(){super.build({title:"SMEditor was loaded offline!",desc:"You can now use SMEditor without an internet connection.",options:[]}),setTimeout(()=>this.close(),5e3)}}class lt extends qc{static graphics=new Hi;static textures={default:Jt.create({width:50,height:50}),noBorder:Jt.create({width:50,height:50}),onlyBorder:Jt.create({width:50,height:50})};static init(e){this.textures.default=Jt.create({width:50,height:50,resolution:e.resolution}),this.textures.noBorder=Jt.create({width:50,height:50,resolution:e.resolution}),this.textures.onlyBorder=Jt.create({width:50,height:50,resolution:e.resolution}),this.graphics.beginFill(16777215,1),this.graphics.lineStyle(1,0),this.graphics.drawRoundedRect(0,0,50,50,5),this.graphics.endFill(),e.render(this.graphics,{renderTexture:this.textures.default}),this.graphics.clear(),this.graphics.beginFill(16777215,1),this.graphics.lineStyle(0,16777215),this.graphics.drawRoundedRect(0,0,50,50,5),this.graphics.endFill(),e.render(this.graphics,{renderTexture:this.textures.noBorder}),this.graphics.clear(),this.graphics.beginFill(16777215,0),this.graphics.lineStyle(2,16777215),this.graphics.drawRoundedRect(0,0,50,50,5),this.graphics.endFill(),e.render(this.graphics,{renderTexture:this.textures.onlyBorder})}constructor(e){super(lt.textures[e??"default"],5,5,5,5)}}const Nn=[];function Sc(){return Nn.length}function Mm(){for(Nn.push(Date.now());Nn.length>0&&Nn[0]<Date.now()-1e3;)Nn.shift()}const Hn=[];function Tc(){return Hn.length}function Lm(){for(Hn.push(Date.now());Hn.length>0&&Hn[0]<Date.now()-1e3;)Hn.shift()}class an extends de{manager;constructor(e){super(),this.manager=e}startPlay(){}endPlay(){}}const Qt=50;class en extends an{static instance;frameTimeGraph=new Bn({width:300,height:Qt,color:1525027,min:0,unit:"ms",label:"Draw",precision:1,sublabel:()=>Sc()+" FPS"});drawUpdateTimeGraph=new Bn({width:300,height:Qt,color:6034982,min:0,unit:"ms",label:"DrawUpdate",precision:1});updateTimeGraph=new Bn({width:300,height:Qt,color:1516101,min:0,unit:"ms",label:"Update",precision:1,sublabel:()=>Tc()+" TPS"});memoryTimeGraph=new Bn({width:300,height:Qt,color:6626406,min:0,formatter:e=>Math.round(e/1048576)+" MB",label:"Memory"});cpuGraph=new Bn({width:300,height:Qt,color:5190685,min:0,label:"CPU"});graphs=new de;fpsCounter=new de;fpsBg=new lt("noBorder");fpsText=new ge("",{fontName:"Main",fontSize:12});lastFrameTime=0;properties=new Map;constructor(e){super(e),this.drawUpdateTimeGraph.y+=Qt+5,this.updateTimeGraph.y+=(Qt+5)*2,this.memoryTimeGraph.y+=(Qt+5)*3,this.cpuGraph.y+=(Qt+5)*4,en.instance=this,this.fpsText.x=5,this.fpsBg.y=-5,ze(this.fpsBg,"widget-bg"),ze(this.fpsText,"text-color"),this.graphs.addChild(this.frameTimeGraph,this.drawUpdateTimeGraph,this.updateTimeGraph),performance.memory&&this.graphs.addChild(this.memoryTimeGraph),this.fpsCounter.addChild(this.fpsBg,this.fpsText),this.graphs.visible=b.debug.showTimers,this.fpsCounter.visible=b.debug.showFPS,this.addChild(this.graphs,this.fpsCounter)}update(){this.x=-this.manager.app.STAGE_WIDTH/2+20,this.y=-this.manager.app.STAGE_HEIGHT/2+20,this.graphs.children.forEach(e=>e.update()),this.graphs.visible=b.debug.showTimers,this.fpsCounter.visible=b.debug.showFPS,this.fpsText.text=`${Sc()} FPS
${Tc()} TPS
${this.lastFrameTime.toFixed(2)} ms
`,b.debug.showDebugVariables&&this.properties.forEach((e,t)=>{this.fpsText.text+=`${t}: ${e}
`}),this.fpsBg.width=this.fpsText.width+10,this.fpsBg.height=this.fpsText.height+10,b.debug.showTimers?(this.fpsBg.y=(Qt+5)*this.graphs.children.length-5,this.fpsText.y=(Qt+5)*this.graphs.children.length):(this.fpsBg.y=-5,this.fpsText.y=0)}addMemoryTimeValue(e){this.memoryTimeGraph.addValue(e)}addFrameTimeValue(e){this.lastFrameTime=e,this.frameTimeGraph.addValue(e)}addUpdateTimeValue(e){this.updateTimeGraph.addValue(e)}addDrawUpdateTimeValue(e){this.drawUpdateTimeGraph.addValue(e)}setProperty(e,t){this.properties.set(e,t)}clearProperty(e){this.properties.delete(e)}clearProperties(){this.properties.clear()}}class Bn extends de{graphWidth;graphHeight;color;unit;precision;formatter;sublabel;maxEase=1;targetMax=1;minEase=1;targetMin=1;constrainedMin=null;constrainedMax=null;dataPoints=[];linePool=[];lineContainer;labelText;sublabelText;topText;bottomText;constructor(e){super();const{width:t,height:n,color:a=16777215,unit:r="",label:s="",min:o=null,max:l=null,precision:u=0,formatter:f=null,sublabel:c=()=>""}=e;this.graphWidth=t,this.graphHeight=n,this.color=a,this.unit=r,this.constrainedMax=l,this.constrainedMin=o,this.precision=u,this.formatter=f,this.sublabel=c,this.lineContainer=new Ya(t,{position:!0},16384,!0);const d=new lt("noBorder");d.tint=0,d.alpha=.3,d.width=this.graphWidth,d.height=this.graphHeight,ze(d,"widget-bg"),this.labelText=new ge(s,{fontName:"Main",fontSize:Math.min(n/5,16)}),this.labelText.alpha=.8,this.sublabelText=new ge("",{fontName:"Main",fontSize:Math.min(n/5,16)}),this.topText=new ge("",{fontName:"Main",fontSize:Math.min(n/7,12)}),this.topText.anchor.x=1,this.topText.alpha=.5,this.topText.x=this.graphWidth,this.bottomText=new ge("",{fontName:"Main",fontSize:Math.min(n/7,12)}),this.bottomText.anchor.x=1,this.bottomText.anchor.y=1,this.bottomText.alpha=.5,this.bottomText.x=this.graphWidth,this.bottomText.y=this.graphHeight,this.sublabelText.y=this.graphHeight,this.sublabelText.anchor.y=1,this.sublabelText.alpha=.5,this.addChild(d,this.lineContainer,this.labelText,this.sublabelText,this.topText,this.bottomText)}addValue(e){if(this.lineContainer.children[0]?.x+this.lineContainer.x<0){const n=this.lineContainer.children[0];this.dataPoints.shift(),this.removeChild(n),this.linePool.push(n)}this.lineContainer.x-=1,this.lineContainer.x<-1e7&&(this.lineContainer.children.forEach(n=>{n.x-=1e7}),this.lineContainer.x+=1e7);const t=this.linePool.shift()??new ye(xe.WHITE);t.width=1,t.anchor.x=.5,t.anchor.y=1,t.tint=this.color,t.alpha=.6,t.x=this.graphWidth-this.lineContainer.x,t.y=this.graphHeight,t.value=e,this.dataPoints.push(e),this.targetMax=this.constrainedMax!==null?this.constrainedMax:Math.max(...this.dataPoints),this.targetMin=this.constrainedMin!==null?this.constrainedMin:Math.min(...this.dataPoints),this.lineContainer.addChild(t)}update(){this.dataPoints.length!=0&&(this.maxEase=(this.maxEase-this.targetMax)*.1+this.targetMax,this.minEase=(this.minEase-this.targetMin)*.1+this.targetMin,this.lineContainer.children.forEach(e=>{e.height=Te((e.value-this.minEase)/this.maxEase,0,1)*this.graphHeight}),this.topText.text=this.formatter?.(this.maxEase)??`${he(this.maxEase,this.precision)} ${this.unit}`,this.bottomText.text=this.formatter?.(this.minEase)??`${he(this.minEase,this.precision)} ${this.unit}`,this.sublabelText.text=this.sublabel())}}class Dm extends an{timeText;beatText;measureText;constructor(e){super(e);const t=new lt("noBorder");t.width=330,t.height=48,t.tint=16711680,t.pivot.set(t.width/2,t.height),this.addChild(t),ze(t,"widget-bg"),this.timeText=this.createCounter("Time",{x:-110,y:-32}),this.createLine({x:-55,y:-40}),this.beatText=this.createCounter("Beat",{x:0,y:-32}),this.createLine({x:55,y:-40}),this.measureText=this.createCounter("Measure",{x:110,y:-32})}createCounter(e,t){const n=new ge("",{fontSize:32,fontName:"Main"});n.scale.set(16*1.1/32),n.anchor.set(.5,.5),n.position.set(t.x,t.y),this.addChild(n),ze(n,"text-color");const a=new ge(e,{fontSize:32,fontName:"Main"});return a.scale.set(16*.6/32),a.anchor.set(.5,.5),a.position.set(t.x,t.y+16),this.addChild(a),ze(a,"text-color-secondary"),n}createLine(e){const t=new ye(xe.WHITE);t.width=1,t.height=32,t.position.set(e.x,e.y),t.tint=8816262,t.alpha=.5,this.addChild(t)}update(){if(!this.manager.app.capturing){this.visible=!1;return}this.visible=!0,this.scale.set(b.performance.resolution*b.general.uiScale*.7),this.position.y=this.manager.app.STAGE_HEIGHT/2-32*b.performance.resolution*b.general.uiScale*.7;const e=this.manager.chartManager.loadedChart?.timingData?.getMeasure(this.manager.chartManager.beat)??this.manager.chartManager.beat/4,t=this.manager.chartManager.time;this.measureText.text=he(e,3).toFixed(3),this.beatText.text=he(this.manager.chartManager.beat,3).toFixed(3);let n="";n+=(t<0?"-":"")+Math.floor(Math.abs(t)/60).toString().padStart(2,"0"),n+=":",n+=Math.floor(Math.abs(t)%60).toString().padStart(2,"0"),n+=".",n+=(he(Math.abs(t)%1,3)*1e3).toString().padStart(3,"0"),this.timeText.text=n}}function Mc(i,e,t,n){return i!=-1&&(i==t||i==n)||e!=-1&&(e==t||e==n)}class Lc{name;layout;columnCount;upArrows;downArrows;sideArrows;constructor(e,t,n,a,r){this.name=e,this.layout=t,this.columnCount=t.length,this.upArrows=n,this.downArrows=a,this.sideArrows=r}getFacingDirectionCosine(e,t){if(e==t)return 0;let n=this.layout[t].x-this.layout[e].x;const a=this.layout[t].y-this.layout[e].y,r=Math.sqrt(n*n+a*a);return n/=r,n}getYDifference(e,t){if(e==t)return 0;const n=this.layout[t].x-this.layout[e].x;let a=this.layout[t].y-this.layout[e].y;const r=Math.sqrt(n*n+a*a);a/=r;const s=a<=0;return a=Math.pow(a,4),s&&(a=-a),a}averagePoint(e,t){return e==-1&&t==-1?{x:0,y:0}:e==-1?this.layout[t]:t==-1?this.layout[e]:{x:(this.layout[e].x+this.layout[t].x)/2,y:(this.layout[e].y+this.layout[t].y)/2}}getDistanceSq(e,t){const n=this.layout[e],a=this.layout[t];return(n.y-a.y)*(n.y-a.y)+(n.x-a.x)*(n.x-a.x)}getDistanceSqPoints(e,t){return(e.y-t.y)*(e.y-t.y)+(e.x-t.x)*(e.x-t.x)}bracketCheck(e,t){return this.getDistanceSq(e,t)<=2}getPlayerAngle(e,t){const n=this.layout[e],a=this.layout[t],r=a.x-n.x,s=a.y-n.y,o=1,l=0,u=r*o+s*l,f=r*l-s*o;return Math.atan2(f,u)}getPlacementData(e,t,n,a){const r=[],s=[];for(let D=0;D<this.layout.length;D++)n&&n.holds[D]===void 0&&e.action[D]!=me.NONE&&(r[e.action[D]]=!0),a.holds[D]===void 0&&t.action[D]!=me.NONE&&(s[t.action[D]]=!0);const o=r[me.LEFT_HEEL]||r[me.LEFT_TOE],l=r[me.RIGHT_HEEL]||r[me.RIGHT_TOE],u=s[me.LEFT_HEEL]||s[me.LEFT_TOE],f=s[me.RIGHT_HEEL]||s[me.RIGHT_TOE],c=s[me.LEFT_HEEL]&&s[me.LEFT_TOE],d=s[me.RIGHT_HEEL]&&s[me.RIGHT_TOE],h=r[me.LEFT_HEEL]&&r[me.RIGHT_HEEL],p=s[me.LEFT_HEEL]&&s[me.RIGHT_HEEL],m=!p&&Mc(e.leftHeel,e.leftToe,t.leftHeel,t.leftToe)&&o&&u,g=!p&&Mc(e.rightHeel,e.rightToe,t.rightHeel,t.rightToe)&&l&&f,y=o&&u&&!p&&!m&&!h,x=l&&f&&!p&&!g&&!h,w=this.averagePoint(e.leftHeel,e.leftToe),C=this.averagePoint(e.rightHeel,e.rightToe),_=this.averagePoint(t.leftHeel,t.leftToe),F=this.averagePoint(t.rightHeel,t.rightToe);return{previousLeftPos:w,previousRightPos:C,leftPos:_,rightPos:F,movedLeft:u,movedRight:f,leftBracket:c,rightBracket:d,previousJumped:h,jumped:p,leftJack:m,rightJack:g,leftDoubleStep:y,rightDoubleStep:x,initialState:e,resultState:t}}}const Bm={"dance-single":new Lc("dance-single",[{x:-1,y:0,rotation:0},{x:0,y:-1,rotation:Math.PI/2*3},{x:0,y:1,rotation:Math.PI/2},{x:1,y:0,rotation:Math.PI}],[2],[1],[0,3]),"dance-double":new Lc("dance-double",[{x:-2.5,y:0,rotation:0},{x:-1.5,y:-1,rotation:Math.PI/2*3},{x:-1.5,y:1,rotation:Math.PI/2},{x:-.5,y:0,rotation:Math.PI},{x:.5,y:0,rotation:0},{x:1.5,y:-1,rotation:Math.PI/2*3},{x:1.5,y:1,rotation:Math.PI/2},{x:2.5,y:0,rotation:Math.PI}],[2,6],[1,5],[0,3,4,7])},Fm="/smeditor/assets/foot-Cb_UZIxu.png",Im="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIoAAACKCAYAAAB1h9JkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFXElEQVR4nO3dTW7qSBiF4UN3CzFkwsyDjBFZA14Eq8gmgP2wCLyGSMyRmDFBbIAepIt2fA02uMr+fs4rRQpcSCzx3CqnsM3odruBsab+GnoDmI7+qbtzNBr1vR3iyrJsDQCn02k79Lb01bPZpRaK97IsW0+n00247QnLozj1VKoimU6nmzC6eI5QSlWRhIiFUO49QhLyjoVQUI9ktVphtVr9epxnLO53Zh8hWa//97Db7e7fh8d628F1PaK0QbJerzmywDGUNkhCxOIUyitIQt6xuIPyDpKQZyyuoHRBEvKKxQ2UGEhCHrG4gBITScgbFvNQUiAJecJiGkpKJCEvWMxC6Ypkv99jv9+3eqwHLCaX8GMgKYrifjvP88bnhJ9tdbnf3IgSG0lRFBxZYAxKTCSHwwGHwwEAsQCGpp5USABgPp/f/83rNGRiREmJhCPLT+qhpEQSIhblUPpAEvKORS2UPpGEPGNRCWUIJCGvWNRBGRJJyCMWVVAkIAl5w6IGiiQkXdOIRQUUiUjm8znm8zkAYLlctlqI05x4KBaRbLfbX6u2AHC5XDaSV21FQyESOYmFQiSyEgmFSOQlDgqRyEwUFCKRmxgoRCI7EVCIRH6DQyESHQ0KhUj0NBgUItHVIFCIRF+9QyESnfUKhUj0Nqq7/nmKa+F7QaK57+/vhy98LyMKkegvORQisVFSKERip2T7KBaRWOvz8/PX7d73UYjEXtGhEInNokIhErtFg0IktosChUjs1xkKkfioExQi8dPb6yjSkTA0vhbJ11GIxF8vXxVSIpLYP0t71SslxOilEUUqEpa+1lCIxHetoBAJa4RCJAxogEIkLPQQCpGwcrVQiIRVq4VCJKza4CepMx3VQrlcLpvy7d1uh+223flMeZ5juVwC4LK6pWqhnE6nLbGwcg+nHmJh5Z7uoxALCzXuzBILA1r+1UMsrPWfx8Tiu5fWUYjFby8f4RYuEFNevQ0nbbdZvQ0HOxdFcYfCQyHl99bKrMSRhW8XpO3tT1KXOLKE5/N0jfh1eq9H+sjyymf9sed1flOQWHwU5d1jYrFftMMMiMV2UY9HIRa7RT9wiVhsluQIN2Kx19vrKE1JX2cJx/Xy8qHt+nuz2fxxZ9v/+U1dr9diPB5jMpnk4b7D4YDz+dzqBfr4+AAAHI9HzGYzAMD5fO60TeH5s9kMx+Px1+9pU57nOJ/PJleBv76+Hr7wSaEAxKKpQaEAxKKlZ1CS7aNUs7jPErbbw8ew9DKihLyMLJPJJB+Px7her0Wnjeu5OguhXqEAxCI5UVAAYpGaOCgAsUhMJBSAWKQlFgpALJISDQUgFimJhwIQi4RUQAGIZejUQAGIZchUQQGIZajUQQGIZYhUQgGIpe/UQgGIpc+eQVFxVUgegzt8KqAAMrG8W91xt9KPYVEDBZCF5d3PLtSIBFAGBZCBxRsSQCEUYFgsHpEASqEAw2DxigRQDAXoF4tnJIByKEA/WLwjAQxAAdJiIZKfejuvJ3UpzhsC3rsenDUkADC63W5/3jkaDbApcYr56WUhL0jqLIRMTD3lYk5DgB8kTZmZesrFmoaq3z/LMhLA4NRTrus01DYrSFxNPeW6TkNtsoKkKdNQgLRYvCABHEAB0mDxhARwAgWIi8UbEsARFCAOFo9IAGdQgG5YvCIBHEIB3sPiGQngFArwGhbvSADHUIB2WIjkJ5NL+K/0bLm/+j3gEwlgfAn/leqW+6tZR+J2Cf+V6qahctaRNEUopR5h8Y4EwM9wU/3yXpZl68VicVssFrcsy+K+1Sy4Ogvhy/3ObF3l0cP9SPJftTuzjFXjPgpr1b/As72zHGkAugAAAABJRU5ErkJggg==";class Ot extends de{pool=[];options;constructor(e){super(),this.options=e}createChild(){if(this.pool.length==0&&this.options.maxPoolSize!==void 0&&this.children.length>=this.options.maxPoolSize)return;const e=this.pool.pop()??this.options.create();return this.addChild(e),e._disabledTime=Date.now(),e}destroyChild(e){this.children.includes(e)&&(e.removeFromParent(),e.removeAllListeners(),e.eventMode="auto",e._disabledTime=Date.now(),this.pool.push(e))}destroyAll(){this.children.forEach(e=>e._disabledTime=Date.now()),this.pool.push(...this.children),this.children.forEach(e=>{e.emit("removed",e.parent),e.removeAllListeners(),e.eventMode="auto"}),this.removeChildren()}_render(e){super._render(e);const t=Date.now();for(;t-this.pool[0]?._disabledTime>(this.options.destroyTimer??5e3);)this.pool.shift().destroy()}}const Ss=10,Ts=16;class Vi extends an{backing=new lt("noBorder");overlay=new ye(xe.WHITE);receptor=new ye(xe.WHITE);selectionOverlay=new ye(xe.WHITE);container=new de;errors=new Ot({create:()=>{const e=new ye(xe.WHITE);return e.tint=16711680,e.alpha=.3,e}});errorMap=new Map;lastHeight=0;lastBeat=-1;mouseDown=!1;queued=!1;verticalMargin=40;backingVerticalPadding=10;backingWidth=32;xOffset=20;dragStartT=0;dragEndT=0;_order=0;static widgets=[];static xGap=10;static xMargin=20;constructor(e,t={}){super(e),t={backingWidth:32,order:0,trigger:"chart",...t},this.backingWidth=t.backingWidth,this.sortableChildren=!0,this._order=t.order,this.addChild(this.backing),this.addChild(this.container),this.visible=!1,ze(this.backing,"widget-bg"),this.receptor.anchor.x=.5,this.receptor.anchor.y=0,this.receptor.alpha=.3,this.receptor.zIndex=10,this.receptor.height=2,this.addChild(this.receptor),this.overlay.anchor.x=.5,this.overlay.anchor.y=0,this.overlay.alpha=.3,this.overlay.zIndex=10,this.addChild(this.overlay),this.selectionOverlay.anchor.x=.5,this.selectionOverlay.anchor.y=0,this.selectionOverlay.tint=5140387,this.selectionOverlay.alpha=.3,this.selectionOverlay.zIndex=10,this.addChild(this.selectionOverlay),this.errors.zIndex=10,this.addChild(this.errors),this.x=this.manager.app.STAGE_WIDTH/2-this.xOffset,ie.on("chartLoaded",()=>{this.queued=!1,this.populateRange()}),ie.on("parityIgnoresModified",()=>{this.queued||this.populateRange(),this.queued=!0}),ie.on(t.trigger=="chart"?"chartModifiedAfter":"parityModified",()=>{this.queued||this.populateRange(),this.queued=!0}),ie.on("userOptionUpdated",a=>{(a=="chart.CMod"||a=="chart.layoutFollowPosition"||a=="chart.hideWarpedArrows"||a=="chart.hideFakedArrows")&&this.populateRange()});const n=setInterval(()=>{this.queued&&(this.queued=!1,this.populateRange())},3e3);this.on("destroyed",()=>clearInterval(n)),this.eventMode="static",this.on("mousedown",a=>{this.mouseDown=!0,this.handleMouse(a)}),this.on("mousemove",a=>{this.mouseDown&&this.handleMouse(a,!0)}),this.on("mouseup",()=>{this.mouseDown=!1}),this.on("mouseleave",()=>{this.mouseDown=!1}),this.pivot.x=this.backing.width/2,Vi.register(this)}handleMouse(e,t=!1){if(this.manager.chartManager.getMode()==W.Play||!this.getChart())return;const n=this.manager.app.STAGE_HEIGHT-this.verticalMargin;let a=(this.container.toLocal(e.global).y+n/2)/n;if(a=Te(a,0,1),t||(this.dragStartT=a),this.dragEndT=a,!this.getChart().getNotedata().at(-1)||t&&b.chart.layoutFollowPosition)return;const s=this.getSongPositionFromT(a);b.chart.CMod?this.manager.chartManager.time=s.second:this.manager.chartManager.beat=s.beat}update(){this.scale.y=b.chart.reverse?-1:1;const e=this.manager.app.STAGE_HEIGHT-this.verticalMargin;this.backing.height=e+this.backingVerticalPadding,this.backing.position.y=-this.backing.height/2,this.backing.position.x=-this.backing.width/2,this.x=this.manager.app.STAGE_WIDTH/2-this.xOffset;const t=this.getChart(),n=this.manager.chartManager.chartView;if(!t||!n||!fe.layout){this.visible=!1;return}if(this.visible=!0,!t.getNotedata().at(-1)){this.overlay.height=0,this.selectionOverlay.height=0;return}if(this.mouseDown&&b.chart.layoutFollowPosition){const f=this.dragEndT-this.dragStartT;b.chart.CMod?this.manager.chartManager.time=Math.max(-t.timingData.getOffset(),this.manager.chartManager.time+f*vt.shared.deltaMS*Ss/100):this.manager.chartManager.beat=Math.max(0,this.manager.chartManager.beat+f*vt.shared.deltaMS*Ts/100)}const r=n.getBeatFromYPos(-this.manager.app.STAGE_HEIGHT/2,!0),s=n.getBeatFromYPos(this.manager.app.STAGE_HEIGHT/2,!0);let o=this.getYFromBeat(r),l=this.getYFromBeat(s);o>l&&([o,l]=[l,o]),this.overlay.y=o-this.backing.height/2,this.overlay.height=l-o,this.overlay.height=Math.max(2,this.overlay.height);const u=this.manager.chartManager.selection.notes;if(u.length<1)this.selectionOverlay.visible=!1;else{this.selectionOverlay.visible=!0;const f=xn(u.map(p=>p.beat)),c=$a(u.map(p=>Ni(p)));let d=this.getYFromBeat(f),h=this.getYFromBeat(c);d>h&&([d,h]=[h,d]),this.selectionOverlay.y=d-this.backing.height/2,this.selectionOverlay.height=h-d,this.selectionOverlay.height=Math.max(2,this.selectionOverlay.height)}if(this.receptor.y=b.chart.CMod?this.getYFromSecond(n.getVisualTime())-this.backing.height/2:this.getYFromBeat(n.getVisualBeat())-this.backing.height/2,this.manager.app.STAGE_HEIGHT!=this.lastHeight&&(this.lastHeight=this.manager.app.STAGE_HEIGHT,this.updateDimensions(),this.populate()),b.chart.layoutFollowPosition&&n.getVisualBeat()!=this.lastBeat){this.lastBeat=n.getVisualBeat();const f=b.chart.CMod?t.getBeatFromSeconds(this.getTopSecond()):this.getTopBeat(),c=b.chart.CMod?t.getBeatFromSeconds(this.getBottomSecond()):this.getBottomBeat();this.populate(f,c)}this.errors.visible=b.chart.parity.showErrors}populateRange(){const e=this.getChart();if(b.chart.layoutFollowPosition||this.populate(),!e)return;const t=b.chart.CMod?e.getBeatFromSeconds(this.getTopSecond()):this.getTopBeat(),n=b.chart.CMod?e.getBeatFromSeconds(this.getBottomSecond()):this.getBottomBeat();this.populate(t,n)}updateDimensions(){if(!this.getChart())return;const t=this.manager.app.STAGE_HEIGHT-this.verticalMargin;this.backing.height=t+this.backingVerticalPadding,this.backing.width=this.backingWidth,this.overlay.width=this.backingWidth,this.receptor.width=this.backingWidth,this.selectionOverlay.width=this.backingWidth,this.pivot.x=this.backing.width/2}getYFromBeat(e){const n=this.getChart().getSecondsFromBeat(e);let a=0;if(b.chart.CMod){const r=this.getTopSecond(),s=this.getBottomSecond();a=$t(r,s,n)}else{const r=this.getTopBeat(),s=this.getBottomBeat();a=$t(r,s,e)}return a=Te(a,0,1),a*(this.manager.app.STAGE_HEIGHT-this.verticalMargin)}getYFromSecond(e){const n=this.getChart().timingData.getBeatFromSeconds(e);return this.getYFromBeat(n)}getSongPositionFromT(e){const t=this.getChart();if(b.chart.CMod){const n=this.getTopSecond(),a=this.getBottomSecond();return{second:Math.max(-t.timingData.getOffset(),Ze(n,a,e)),beat:t.timingData.getBeatFromSeconds(Math.max(-t.timingData.getOffset(),Ze(n,a,e)))}}else{const n=this.getTopBeat(),a=this.getBottomBeat();return{beat:Math.max(0,Ze(n,a,e)),second:t.getSecondsFromBeat(Math.max(0,Ze(n,a,e)))}}}getTopSecond(){const e=this.getChart(),t=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?t.getVisualTime()-Ss:e.timingData.getOffset()}getBottomSecond(){const e=this.getChart(),t=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?t.getVisualTime()+Ss:e.getLastSecond()}getTopBeat(){const e=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?e.getVisualBeat()-Ts:0}getBottomBeat(){const e=this.getChart(),t=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?t.getVisualBeat()+Ts:e.getLastBeat()}populate(e,t){const n=this.getChart();if(n)if(n.stats.parity){const a=e??this.getTopBeat(),r=t??this.getBottomBeat();for(const s of n.stats.parity.techErrors.keys()){const o=n.stats.parity.rowTimestamps[s];if(o.beat<a||o.beat>r||this.errorMap.has(s))continue;const l=this.errors.createChild();l&&(l.height=1,l.anchor.set(.5,0),this.errorMap.set(s,l))}if(b.chart.parity.showErrors)for(const[s,o]of this.errorMap.entries()){const l=n.stats.parity.rowTimestamps[s],u=n.stats.parity.techErrors.get(s);if(!l||l.beat<a||l.beat>r||!u?.size){this.errorMap.delete(s),this.errors.destroyChild(o);continue}const f=n.getErrorIgnoresAtBeat(l.beat)?.size??0;u.size-f>0?o.tint=16711680:o.tint=8947848,o.y=this.getYFromBeat(l.beat)-this.backing.height/2,o.width=this.backingWidth}}else this.errorMap.clear(),this.errors.destroyAll()}getChart(){return this.manager.chartManager.loadedChart}get order(){return this._order}set order(e){this._order=e,Vi.resort()}static register(e){this.widgets.includes(e)||(this.widgets.length==0&&vt.shared.add(()=>{let t=this.xMargin;this.widgets.forEach(n=>{n.visible&&(n.xOffset=t,t+=n.backingWidth+this.xGap)})}),this.widgets.push(e),this.resort())}static resort(){this.widgets.sort((e,t)=>e.order-t.order)}static getTotalWidgetWidth(){return this.widgets.filter(e=>e.visible).reduce((e,t)=>e+t.backingWidth,0)+this.xGap*(this.widgets.length-1)+this.xMargin}}const oi={fakeMines:{boxTint:5723991,boxOpacity:.5,textTint:14211288,text:"FM"},mines:{boxTint:6893616,boxOpacity:.3,textTint:14693428,text:"M"},holds:{boxTint:2050583,boxOpacity:.6,textTint:5494332,text:"H"},holdTails:{boxTint:1132131,boxOpacity:.6,textTint:11655162,text:"HT"}},ii={[me.NONE]:16777215,[me.LEFT_HEEL]:233724,[me.LEFT_TOE]:8500702,[me.RIGHT_HEEL]:16559363,[me.RIGHT_TOE]:15782288};class Pm extends de{isEditGUI=!1;renderer;chartDirty=!1;lastVisible=!1;debugTexts=[];debugContainer=new de;debugBG=new ye(xe.WHITE);connections=new Hi;rowMap=new Map;rowPool=new Ot({create:()=>{const e=new de,t=new de,n=new Ot({create:()=>{const o=new de,l=new lt;o.addChild(l),o.bg=l,o.letters=[];let u=0,f=0;for(let h=0;h<this.renderer.chart.getColumnCount();h++){const p=new ge("",{fontName:"Mono",fontSize:13});p&&(p.alpha=0,p.anchor.set(0,.5),p.x=u,o.addChild(p),u+=p.width,f=Math.max(f,p.height),o.letters.push(p))}l.width=u+10,l.height=f+5,l.pivot.set(l.width/2,l.height/2),o.letters.forEach(h=>{h.x-=u/2});const c=new ge("",{fontName:"Mono",fontSize:10});c.anchor.set(.5,1),c.y-=l.height/2+5,c.visible=!1,o.detail=c,o.addChild(c),o.alpha=.8;const d=new de;return o.connections=d,o.addChild(d),o}});n.sortableChildren=!0;const a=new ge("",{fontName:"Main",fontSize:35});a.tint=16745938,a.anchor.set(1,.5);const r=new ge("",{fontName:"Main",fontSize:15});r.tint=16745938,r.anchor.set(1,.5),r.align="right",r.eventMode="none",r.visible=!1,r.text="";const s=new ye(xe.WHITE);s.tint=16777215,s.anchor.set(1,.5),s.width=a.width+10,s.height=a.height+10,s.alpha=0,s.eventMode="static",t.addChild(s,a,r),e.addChild(t,n),e.hitbox=s,e.text=a,e.i=0,e.detail=r,e.sideContainer=t,e.nodePool=n,e.highlights=[],e.statusRows=[];for(let o=0;o<Object.keys(oi).length-1;o++){const l=[];for(let u=0;u<this.renderer.chart.getColumnCount();u++){const f=new ye(xe.WHITE);f.width=10,f.height=10,f.anchor.set(1,.5),f.y=(o-(Object.keys(oi).length-1)/2)*12+5,f.visible=!0,t.addChild(f),l.push(f)}e.statusRows.push(l)}return e}});activeNode;constructor(e){super(),this.visible=!0,this.renderer=e,this.addChild(this.connections),this.addChild(this.rowPool),this.debugBG.anchor.set(0,1),this.debugBG.alpha=.6,this.debugBG.tint=0,this.addChild(this.debugBG),this.addChild(this.debugContainer),this.rowPool.sortableChildren=!0;const t=()=>{this.debugTexts.forEach(r=>{const s=this.renderer.chart.stats.parity?.debug;s&&(r.text.text=r.update(s))}),this.chartDirty=!0},n=r=>{r=="debug.parity.limitGraph"&&(this.chartDirty=!0)},a=()=>{this.activeNode&&(this.activeNode.deactivate(),this.activeNode=void 0)};this.createDebugObject(16745938,r=>`Updated ${r.stats.lastUpdatedRowEnd-r.stats.lastUpdatedRowStart} rows in ${r.stats.rowUpdateTime.toFixed(3)}ms`),this.createDebugObject(11075438,r=>`Created ${r.stats.createdNodes} nodes and ${r.stats.createdEdges} edges in ${r.stats.nodeUpdateTime.toFixed(3)}ms`),this.createDebugObject(6539775,r=>`Calculated ${r.stats.calculatedEdges} costs (${r.stats.cachedEdges} cached) in ${r.stats.edgeUpdateTime.toFixed(3)}ms (cache size ${r.edgeCacheSize})`),this.createDebugObject(16751196,r=>`Found best path in ${r.stats.pathUpdateTime.toFixed(3)}ms (cached ${r.stats.cachedBestRows} rows)`),this.createDebugObject(15662955,r=>`Calculated row states in ${r.stats.rowStatsUpdateTime.toFixed(3)}ms`),this.createDebugObject(16777215,r=>`Total calculation time: ${(r.stats.rowUpdateTime+r.stats.nodeUpdateTime+r.stats.edgeUpdateTime+r.stats.pathUpdateTime+r.stats.rowStatsUpdateTime).toFixed(3)}ms`),this.createDebugObject(15417396,r=>`Debug data serialization time: ${(this.renderer.chart.stats.parity.debugTime-(r.stats.rowUpdateTime+r.stats.nodeUpdateTime+r.stats.edgeUpdateTime+r.stats.pathUpdateTime)).toFixed(3)}ms`),ie.on("parityModified",t),ie.on("userOptionUpdated",n),this.renderer.on("pointerdown",a),this.on("destroyed",()=>{ie.off("parityModified",t),ie.off("userOptionUpdated",n),this.renderer.off("pointerdown",a)})}update(e,t){const n=this.renderer.chart.stats.parity;if(this.visible=!!n&&(b.debug.parity.showGraph||b.debug.parity.showDebug),!this.visible){this.lastVisible!=this.visible&&(this.rowMap.clear(),this.rowPool.destroyAll(),this.lastVisible=this.visible);return}this.lastVisible=this.visible,this.chartDirty&&(this.rowMap.clear(),this.rowPool.destroyAll(),this.chartDirty=!1);const a=-this.renderer.chartManager.app.STAGE_WIDTH/2,r=-this.renderer.chart.gameType.notefieldWidth/2+b.chart.receptorXPos,s=this.renderer.chart.gameType.notefieldWidth/2+b.chart.receptorXPos,o=this.renderer.chartManager.app.STAGE_WIDTH/2-Vi.getTotalWidgetWidth(),l=r-a,u=o-s,f=l>u+100?"left":"right";for(let h=0;h<n.debug.notedataRows.length&&!(t<n.debug.notedataRows[h-1]?.beat);h++){if(e>n.debug.notedataRows[h+1]?.beat)continue;const p=n.debug.notedataRows[h],m=p.overrides.some(g=>g);if(!this.rowMap.has(p)){const g=this.rowPool.createChild();if(!g)break;let y=h>=n.debug.stats.lastUpdatedRowStart&&h<n.debug.stats.lastUpdatedRowEnd?16745938:11499473;m&&(y=It(new B(y),new B(16711680),.4).toNumber()),g.text.tint=y,g.i=h,g.text.text=h+"",g.hitbox.width=g.text.width+10,g.hitbox.height=g.text.height+10,g.detail.text="Second: "+p.second.toFixed(3)+`
Key: `+p.id,g.detail.tint=g.text.tint,g.detail.visible=!1,g.highlights.forEach(w=>{w.box.destroy()}),g.nodePool.children.forEach(w=>{w.deactivate()}),g.nodePool.destroyAll(),g.highlights=[],g.hitbox.removeAllListeners();const x=n.debug.nodeRows[h];if(!x||x.nodes.length===0)console.warn(`No permutations found for row ${h} at beat ${p.beat} (${p.id})`);else{let w=x.nodes;b.debug.parity.limitGraph&&(w=w.slice(0,8));for(const F of w){const D=g.nodePool.createChild();if(!D)continue;D.name=F.key;const O=D.bg,H=()=>{let R=11499473;O.alpha=.2,h>=n.debug.stats.lastUpdatedNodeStart&&h<n.debug.stats.lastUpdatedNodeEnd&&(R=2251008,O.alpha=.6),n.debug.bestPathSet?.has(F.key)&&(R=12536064,O.alpha=.6),m&&(R+=3473408,O.alpha+=.3),Y&&(R=6539775,O.alpha=.2),O.tint=R};for(let R=0;R<F.state.combinedColumns.length;R++){const v=F.state.combinedColumns[R],S=D.letters[R];S&&(S.text=fd[v],S.alpha=.3,F.state.action[R]==F.state.combinedColumns[R]&&(S.alpha=1),S.tint=ii[v])}D.detail.text=JSON.stringify(F.state,null,2)+`
Key: `+F.key;let Y=!1;H();const re=()=>{if(!Y){Y=!0,D.alpha=3,D.detail.visible=!0;for(const[R,v]of F.children.entries()){const S=this.rowMap.get(n.debug.notedataRows[h+1]);if(!S||!S.nodePool.getChildByName(R))return;const L=new de;L.text=new ge(v.TOTAL.toFixed(2),{fontName:"Mono",fontSize:10}),L.text.anchor.set(.5,1),L.text.tint=16777215,L.text.y=-O.height/2-5,L.bg=new lt,L.bg.visible=!1,L.bg.eventMode="none",L.bg.tint=3683671,L.name=R,L.addChild(L.bg,L.text),D.connections.addChild(L),L.on("pointerover",()=>{L.text.text=JSON.stringify(v,null,2)+`
`,L.scale.set(1.2),L.bg.visible=!0,L.bg.width=L.text.width+10,L.bg.height=L.text.height+10,L.bg.alpha=.3,L.bg.x=-L.bg.width/2,L.bg.y=-L.bg.height-O.height/2-10}),L.on("pointerout",()=>{L.text.text=v.TOTAL.toFixed(2),L.scale.set(1),L.bg.visible=!1}),L.text.hitArea=new Kn(-L.text.width/2,-L.text.height,L.text.width,L.text.height),L.zIndex=1,D.zIndex=1,g.zIndex=1}H()}},M=()=>{Y&&(Y=!1,D.alpha=.8,D.zIndex=0,D.detail.visible=!1,D.connections.children.forEach(R=>{R.destroy()}),D.connections.removeChildren(),H(),g.zIndex=0)};D.activate=re,D.deactivate=M,D.eventMode="static",D.on("pointerover",()=>{re()}),D.on("pointerout",()=>{this.activeNode!=D&&M()}),D.on("pointerdown",R=>{this.activeNode==D?this.activeNode=void 0:(this.activeNode?.deactivate(),this.activeNode=D,D.connections.children.forEach(v=>{v.eventMode="static"})),R.stopImmediatePropagation()}),D.cursor="pointer"}const C=g.nodePool.children[0].bg.width+5,_=C*w.length;g.nodePool.children.forEach((F,D)=>{F.x=D*C-_/2,F.y=0})}for(let w=0;w<this.renderer.chart.getColumnCount();w++)g.statusRows[0][w].tint=oi.fakeMines.textTint,g.statusRows[1][w].tint=oi.mines.textTint,g.statusRows[0][w].visible=p.fakeMines[w]!==void 0,g.statusRows[1][w].visible=p.mines[w]!==void 0,g.statusRows[2][w].visible=!0,p.holdTails.has(w)?g.statusRows[2][w].tint=oi.holdTails.textTint:p.holds[w]!==void 0?g.statusRows[2][w].tint=oi.holds.textTint:g.statusRows[2][w].visible=!1;g.hitbox.on("pointerover",()=>{g.detail.visible=!0,p.fakeMines.forEach((w,C)=>{if(w===void 0)return;const _=this.createBoxWithText(oi.fakeMines);g.highlights.push({col:C,second:w,box:_}),g.addChild(_)}),p.mines.forEach((w,C)=>{if(w===void 0)return;const _=this.createBoxWithText(oi.mines);g.highlights.push({col:C,second:w,box:_}),g.addChild(_)}),p.holds.forEach((w,C)=>{if(w===void 0||p.holdTails.has(C))return;const _=this.createBoxWithText(oi.holds);g.highlights.push({col:C,second:p.second,box:_}),g.addChild(_)}),p.holdTails.forEach(w=>{const C=this.createBoxWithText(oi.holdTails);g.highlights.push({col:w,second:p.second,box:C}),g.addChild(C)}),g.statusRows.forEach(w=>{w.forEach(C=>{C.alpha=0})})}),g.hitbox.on("pointerout",()=>{g.detail.visible=!1,g.highlights.forEach(w=>{w.box.destroy()}),g.highlights=[],g.statusRows.forEach(w=>{w.forEach(C=>{C.alpha=1})})}),this.rowMap.set(p,g)}}let c=0;const d=[...this.rowMap.entries()];for(const[h,p]of d){if(h.beat<e&&d[c+1]?.[0].beat<e||h.beat>t&&d[c-1]?.[0].beat>t){this.rowMap.delete(h),this.rowPool.destroyChild(p),this.activeNode&&this.activeNode.parent===p.nodePool&&(this.activeNode.deactivate(),this.activeNode=void 0),c++;continue}c++,p.text.text=p.i+" "+(n.techErrors.has(p.i)?n.techErrors.get(p.i).values().toArray().map(m=>Uc[m]).join(", "):""),p.visible=b.debug.parity.showGraph,p.highlights.forEach(m=>{const g=this.renderer.getXPosFromColumn(m.col),y=this.renderer.getYPosFromSecond(m.second),x=m.box;x.x=g,x.y=y-this.renderer.getYPosFromBeat(h.beat)}),p.y=this.renderer.getYPosFromBeat(h.beat),f=="left"?p.nodePool.x=(r-a)/2+a-b.chart.receptorXPos:p.nodePool.x=(o-s)/2+s-b.chart.receptorXPos;for(let m=0;m<this.renderer.chart.getColumnCount();m++)for(let g=0;g<3;g++)f=="right"?p.statusRows[g][m].x=(m-this.renderer.chart.getColumnCount())*12-p.text.width-12:p.statusRows[g][m].x=m*12+p.text.width+18;p.sideContainer.x=(-this.renderer.chart.gameType.notefieldWidth/2-128)*(f=="left"?-1:1),p.text.anchor.x=f=="left"?0:1,p.hitbox.anchor.x=p.text.anchor.x,p.nodePool.x/=b.chart.zoom,p.detail.x=(p.text.width+10)*(f=="left"?1:-1),p.detail.anchor.x=f=="left"?0:1,p.detail.align=f}if(b.debug.parity.showDebug?(this.debugTexts.forEach((h,p)=>{h.x=(-this.renderer.chartManager.app.STAGE_WIDTH/2+10-b.chart.receptorXPos)/b.chart.zoom,h.y=(this.renderer.chartManager.app.STAGE_HEIGHT/2-10)/b.chart.zoom+(p-this.debugTexts.length+1)*30}),this.debugBG.x=(-this.renderer.chartManager.app.STAGE_WIDTH/2-b.chart.receptorXPos)/b.chart.zoom,this.debugBG.y=this.renderer.chartManager.app.STAGE_HEIGHT/2/b.chart.zoom,this.debugBG.width=this.debugContainer.width+20/b.chart.zoom,this.debugBG.height=this.debugContainer.height+15/b.chart.zoom,this.debugContainer.visible=!0,this.debugBG.visible=!0):(this.debugContainer.visible=!1,this.debugBG.visible=!1),this.connections.clear(),b.debug.parity.showGraph)for(let h=0;h<n.debug.notedataRows.length&&!(t<n.debug.notedataRows[h-1]?.beat);h++){if(e>n.debug.notedataRows[h+1]?.beat)continue;const p=n.debug.notedataRows[h],m=n.debug.nodeRows[h].nodes,g=this.rowMap.get(p),y=this.rowMap.get(n.debug.notedataRows[h+1]);if(!(!g||!y))for(const x of m){const w=g.nodePool.getChildByName(x.key);if(w)for(const[C,_]of x.children.entries()){const F=y.nodePool.getChildByName(C);if(!F)continue;let D=11499473,O=1.5;h>=n.debug.stats.lastUpdatedNodeStart&&h<n.debug.stats.lastUpdatedNodeEnd&&(D=65280);let H=.5-Math.min(.45,Math.log1p(_.TOTAL)/15);if(w.connections.getChildByName(C)){const Y=w.connections.getChildByName(C);Y.x=F.x+y.nodePool.x-(w.x+g.nodePool.x),Y.y=y.y-g.y,H+=.3,D=6539775,O=2.5}n.debug.bestPathSet?.has(x.key)&&n.debug.bestPathSet.has(C)&&(D=12536064,H+=.4,O=4),this.connections.lineStyle(O,D,H),this.connections.moveTo(w.x+g.nodePool.x,g.y),this.connections.lineTo(F.x+y.nodePool.x,y.y)}}}}createBoxWithText(e){const t=new de;return t.background=new ye(xe.WHITE),t.background.width=e.boxWidth||64,t.background.height=e.boxHeight||64,t.background.tint=e.boxTint||16777215,t.background.alpha=e.boxOpacity||.5,t.background.anchor.set(.5,.5),t.addChild(t.background),t.text=new ge(e.text,{fontName:"Main",fontSize:25}),t.text.tint=e.textTint||16777215,t.text.alpha=e.textOpacity||1,t.text.anchor.set(.5,.5),t.addChild(t.text),t}createDebugObject(e,t){const n=new de;return n.text=new ge("",{fontName:"Main",fontSize:20}),n.text.tint=e,n.text.anchor.set(0,1),n.addChild(n.text),n.update=t,this.debugTexts.push(n),this.debugContainer.addChild(n),n}}const dt=80;class Rm extends an{panels=[];currentRow=-1;lastBeat=0;lastSecond=0;leftFoot;rightFoot;layout;dirty=!1;constructor(e){super(e),this.sortableChildren=!0,ie.on("chartLoaded",()=>this.build()),ie.on("parityModified",()=>this.reindex())}async build(){if(this.removeChildren(),this.panels=[],!this.manager.app.chartManager.loadedChart||(this.layout=Bm[this.manager.app.chartManager.loadedChart.gameType.id],!this.layout))return;const e=await Is.load(Im);let t=0,n=0;this.layout.layout.forEach(c=>{const d=new de,h=new ye(xe.WHITE);h.alpha=.1,h.anchor.set(.5),h.width=dt,h.height=dt;const p=new ye(xe.WHITE);p.anchor.set(.5),p.width=dt,p.height=dt,p.blendMode=Fs.COLOR_BURN,ze(p,"primary-bg-active"),d.addChild(p);const m=new ye(e);m.anchor.set(.5),m.x=c.x,m.y=c.y*-1,m.alpha=.3,m.width=dt*.75,m.height=dt*.75,m.blendMode=Fs.MULTIPLY,m.rotation=c.rotation,d.bg=h,d.arrow=m,d.x=c.x*dt,d.y=c.y*-80,d.addChild(h,m),this.addChild(d),this.panels.push(d),t=Math.max(t,Math.abs(d.x)),n=Math.max(n,Math.abs(d.y))});const a=await Is.load(Fm),r=new de,s=new de,o=new ye(a),l=new ye(a);o.scale.set(dt/4*3/o.height),l.scale.set(dt/4*3/l.height),o.tint=ii[me.LEFT_HEEL],l.tint=ii[me.RIGHT_HEEL],o.anchor.set(.5),l.anchor.set(.5),l.scale.x*=-1;const u=new ge("L",{fontSize:25,fontName:"Fancy",tint:ii[me.LEFT_TOE]}),f=new ge("R",{fontSize:25,fontName:"Fancy",tint:ii[me.RIGHT_TOE]});u.anchor.set(.5),f.anchor.set(.5),r.addChild(o,u),s.addChild(l,f),this.leftFoot=r,this.rightFoot=s,this.leftFoot.zIndex=50,this.rightFoot.zIndex=50,this.addChild(this.leftFoot,this.rightFoot),this.lastBeat=-1,this.pivot.set(t+dt/2,n+dt/2)}reindex(){const e=this.manager.app.chartManager.loadedChart?.stats.parity;if(!e||!this.manager.app.chartManager.chartView)return;const t=this.manager.app.chartManager.chartView.getVisualBeat();let n=hi(e.rowTimestamps,t,a=>a.beat);for(;e.rowTimestamps[n]?.beat<t;)n++;if(n==0&&t<e.rowTimestamps[0].beat){this.currentRow=-1;return}this.currentRow=n,this.dirty=!0}update(){const e=this.manager.app.chartManager.loadedChart?.stats.parity?.states,t=this.manager.chartManager.app.STAGE_WIDTH/2-Vi.getTotalWidgetWidth();if(this.x=t-16,this.y=this.manager.app.STAGE_HEIGHT/2-16,!e||!this.manager.app.chartManager.chartView||!this.layout||!b.chart.parity.enabled||!b.chart.parity.showDancingBot){this.visible=!1;return}this.visible=!0;const n=this.manager.app.chartManager.chartView.getVisualBeat(),a=this.manager.app.chartManager.chartView.getVisualTime();if(!(this.lastSecond==a&&!this.dirty)){if(this.dirty=!1,this.panels.forEach(r=>{const s=(n%1+1)%1;r.arrow.alpha=.3+Te(1-s,.5,1)*.8}),n<this.lastBeat)this.reindex();else for(;e[this.currentRow+1]?.beat<=n;){this.currentRow++;const r=e[this.currentRow];r.action.forEach((s,o)=>{r.holdFeet.has(s)||!s||this.flashPanel(o)})}if(this.lastBeat=n,this.lastSecond=a,this.leftFoot&&this.rightFoot){let r=e[this.currentRow];const s=e[this.currentRow+1]??e.at(-2);if(e.at(-1)==r&&(r=e.at(-2)),r){const o=this.getFeetPosition(r),l=this.getFeetPosition(s),u=Te($t(Math.max(r.second,s.second-.3),s.second,a),0,1),f=this.lerpPositions(o,l,u,s);let c=1,d=1;const h=r.movedFeet.has(me.LEFT_HEEL),p=r.movedFeet.has(me.RIGHT_HEEL),m=s.movedFeet.has(me.LEFT_HEEL),g=s.movedFeet.has(me.RIGHT_HEEL);if(a>s.second-.1){const y=Te($t(s.second-.1,s.second,a),0,1);m&&(c*=Ze(1,.9,y)),g&&(d*=Ze(1,.9,y))}if(a<r.second+.1){const y=Te($t(r.second,r.second+.1,a),0,1);h&&(c*=Ze(.9,1,y)),p&&(d*=Ze(.9,1,y))}this.leftFoot.scale.set(c),this.rightFoot.scale.set(d),this.leftFoot.x=f.left.x,this.leftFoot.y=f.left.y,this.leftFoot.rotation=f.left.angle,this.rightFoot.x=f.right.x,this.rightFoot.y=f.right.y,this.rightFoot.rotation=f.right.angle}}}}getFeetPosition(e){const t={x:this.panels[e.footColumns[me.LEFT_HEEL]]?.position.x??0,y:this.panels[e.footColumns[me.LEFT_HEEL]]?.position.y??0},n={x:this.panels[e.footColumns[me.RIGHT_HEEL]]?.position.x??0,y:this.panels[e.footColumns[me.RIGHT_HEEL]]?.position.y??0};e.footColumns[me.LEFT_TOE]!=-1&&(t.x=(t.x+this.panels[e.footColumns[me.LEFT_TOE]].position.x)/2,t.y=(t.y+this.panels[e.footColumns[me.LEFT_TOE]].position.y)/2),e.footColumns[me.RIGHT_TOE]!=-1&&(n.x=(n.x+this.panels[e.footColumns[me.RIGHT_TOE]].position.x)/2,n.y=(n.y+this.panels[e.footColumns[me.RIGHT_TOE]].position.y)/2),this.layout.name=="dance-single"&&(Math.abs(t.x)<=dt/4&&(t.x-=dt/4,t.y*=.5),Math.abs(n.x)<=dt/4&&(n.x+=dt/4,n.y*=.5),n.x<-80/4*3&&(n.y-=dt/4*Math.sign(t.y),n.x+=dt/4),t.x>dt/4*3&&(t.y-=dt/4*Math.sign(t.y),t.x-=dt/4));let a=this.getPlayerAngle(t,n)/5,r=a;return e.footColumns[me.LEFT_TOE]!=-1&&(a=-this.getPlayerAngle({x:this.panels[e.footColumns[me.LEFT_HEEL]].position.x,y:this.panels[e.footColumns[me.LEFT_HEEL]].position.y},{x:this.panels[e.footColumns[me.LEFT_TOE]].position.x,y:this.panels[e.footColumns[me.LEFT_TOE]].position.y})+Math.PI/2),e.footColumns[me.RIGHT_TOE]!=-1&&(r=-this.getPlayerAngle({x:this.panels[e.footColumns[me.RIGHT_HEEL]].position.x,y:this.panels[e.footColumns[me.RIGHT_HEEL]].position.y},{x:this.panels[e.footColumns[me.RIGHT_TOE]].position.x,y:this.panels[e.footColumns[me.RIGHT_TOE]].position.y})+Math.PI/2),{left:{x:t.x,y:t.y,angle:a},right:{x:n.x,y:n.y,angle:r}}}getPlayerAngle(e,t){const n=t.x-e.x,a=t.y-e.y,r=1,s=0,o=n*r+a*s,l=n*s-a*r;return Math.atan2(l,o)}lerpPositions(e,t,n,a){const r=a.movedFeet.has(me.LEFT_HEEL),s=a.movedFeet.has(me.RIGHT_HEEL);return{left:{x:Ze(e.left.x,t.left.x,n),y:Ze(e.left.y,t.left.y,n),angle:r?Ze(e.left.angle,t.left.angle,n):e.left.angle},right:{x:Ze(e.right.x,t.right.x,n),y:Ze(e.right.y,t.right.y,n),angle:s?Ze(e.right.angle,t.right.angle,n):e.right.angle}}}flashPanel(e){const t=this.panels[e];t&&rt.animate(t.bg,{0:{alpha:.6},1:{alpha:.1}},.4,pt(.19,1.15,.55,.96),void 0,"panel-"+e)}}function Kt(i,e){let t=i.length;if(i.length!=0)for(;t--;)e(i[t],t)&&i[t].destroy()}function qa(i){return i.button==2||i.getModifierState("Control")&&ei}function Kg(i,e,t,n,a){const r=[];for(let s=0;s<t;s++){const o=[];for(let l=0;l<e;l++)o.push(new xe(i.baseTexture,new Kn(n*l,a*s,n,a)));r.push(o)}return r}async function Xg(i){const e=i.split(`
`),t=parseInt(e[0]),n=parseInt(e[t+1]),a=[],r=[],s=[];for(let o=0;o<t;o++){const l=/(-?[0-9.]+)\s+(-?[0-9.]+)\s+(-?[0-9.]+)\s+(-?[0-9.]+)/.exec(e[o+1]);if(l)a.push(parseFloat(l[1])),a.push(parseFloat(l[2])),r.push(parseFloat(l[3])),r.push(parseFloat(l[4]));else return console.error("Failed to load vertex "+e[o+1]),new cr}for(let o=0;o<n;o++){const l=/(-?[0-9.]+)\s+(-?[0-9.]+)\s+(-?[0-9.]+)/.exec(e[o+2+t]);if(l)s.push(parseFloat(l[1])),s.push(parseFloat(l[2])),s.push(parseFloat(l[3]));else return console.error("Failed to load triangle "+e[o+2+t]),new cr}return new cr().addAttribute("aVertexPosition",a,2).addAttribute("aUvs",r,2).addIndex(s)}const ft=300,li=150,Dc=[.045,.09,.18,.37,.18,.09,.045];class Om extends an{max=0;barlines=new de;backgroundRect=new lt("noBorder");background=new de;backgroundLines=new de;statText=new de;meanText;medianText;modeText;stddevText;errorMS=[];texts=new de;showEase=0;toggled=!1;drag=!1;dragStart=0;lastMode=this.manager.chartManager.getMode();constructor(e){super(e),this.visible=!1,this.background.addChild(this.backgroundRect),ze(this.backgroundRect,"widget-bg"),this.addChild(this.background),this.addChild(this.backgroundLines),this.eventMode="static",this.on("mousedown",()=>{this.manager.chartManager.getMode()!=W.Play&&(this.drag=!0,this.dragStart=Date.now(),rt.stop("play-widget"))}),window.addEventListener("mousemove",p=>{this.drag&&(this.showEase+=p.movementY/-400)}),window.addEventListener("mouseup",()=>{this.drag&&(Date.now()-this.dragStart>400?this.toggled=this.showEase>.5:this.toggled=!this.toggled,rt.animate(this,{0:{showEase:"inherit"},1:{showEase:this.toggled?1:0}},.6,pt(.11,.71,.33,1.39),()=>{},"play-widget")),this.drag=!1}),this.on("mouseenter",()=>{!this.toggled&&this.manager.chartManager.getMode()!=W.Play&&rt.animate(this,{0:{showEase:"inherit"},1:{showEase:.05}},.6,pt(.11,.71,.33,1.39),()=>{},"play-widget")}),this.on("mouseleave",()=>{!this.toggled&&this.manager.chartManager.getMode()!=W.Play&&rt.animate(this,{0:{showEase:"inherit"},1:{showEase:0}},.6,pt(.11,.71,.33,1.39),()=>{},"play-widget")});const t=new ge("Early",{fontName:"Main",fontSize:15});t.x=-300/2+5,t.y=-190,t.alpha=.3,this.background.addChild(t),ze(t,"text-color");const n=new ge("Late",{fontName:"Main",fontSize:15});n.anchor.x=1,n.x=ft/2-5,n.y=-190,n.alpha=.3,this.background.addChild(n),ze(n,"text-color"),this.meanText=new ge("-",{fontName:"Main",fontSize:15}),this.meanText.anchor.x=.5,this.meanText.x=ft/4*-1.5,this.meanText.y=-220,this.statText.addChild(this.meanText),this.medianText=new ge("-",{fontName:"Main",fontSize:15}),this.medianText.anchor.x=.5,this.medianText.x=ft/4*-.5,this.medianText.y=-220,this.statText.addChild(this.medianText),this.modeText=new ge("-",{fontName:"Main",fontSize:15}),this.modeText.anchor.x=.5,this.modeText.x=ft/4*.5,this.modeText.y=-220,this.statText.addChild(this.modeText),this.stddevText=new ge("-",{fontName:"Main",fontSize:15}),this.stddevText.anchor.x=.5,this.stddevText.x=ft/4*1.5,this.stddevText.y=-220,this.statText.addChild(this.stddevText);const a=new ge("Mean",{fontName:"Main",fontSize:10});a.anchor.x=.5,a.x=ft/4*-1.5,a.y=-230,this.statText.addChild(a);const r=new ge("Median",{fontName:"Main",fontSize:10});r.anchor.x=.5,r.x=ft/4*-.5,r.y=-230,this.statText.addChild(r);const s=new ge("Mode",{fontName:"Main",fontSize:10});s.anchor.x=.5,s.x=ft/4*.5,s.y=-230,this.statText.addChild(s);const o=new ge("Std Dev.",{fontName:"Main",fontSize:10});o.anchor.x=.5,o.x=ft/4*1.5,o.y=-230,this.statText.addChild(o),this.statText.children.forEach(p=>{ze(p,"text-color")});const l=new de,u=new lt("noBorder");u.tint=3355443,u.alpha=.3,u.width=ft/2-10,u.height=30,u.y=-25,u.x=-300/4,u.pivot.x=(ft/2-10)/2,u.pivot.y=15;const f=new ge("Adjust song offset",{fontName:"Main",fontSize:12});f.anchor.set(.5),f.x=-300/4,f.y=-25,l.addChild(u,f),l.eventMode="static",l.addEventListener("mouseenter",()=>{u.alpha=.6}),l.addEventListener("mousedown",p=>{p.stopImmediatePropagation(),this.adjustOffset("song")}),l.addEventListener("mouseleave",()=>{u.alpha=.3}),this.statText.addChild(l),ze(f,"text-color");const c=new de,d=new lt("noBorder");d.tint=3355443,d.alpha=.3,d.width=ft/2-10,d.height=30,d.y=-25,d.x=ft/4,d.pivot.x=(ft/2-10)/2,d.pivot.y=15,d.eventMode="static",c.addEventListener("mouseenter",()=>{d.alpha=.6}),c.addEventListener("mouseleave",()=>{d.alpha=.3});const h=new ge("Adjust global offset",{fontName:"Main",fontSize:12});h.anchor.set(.5),h.x=ft/4,h.y=-25,c.addChild(d,h),ze(h,"text-color"),c.eventMode="static",c.addEventListener("mouseenter",()=>{d.alpha=.6}),c.addEventListener("mousedown",p=>{p.stopImmediatePropagation(),this.adjustOffset("global")}),c.addEventListener("mouseleave",()=>{d.alpha=.3}),this.statText.addChild(c),this.addChild(this.background),this.addChild(this.backgroundLines),this.eventMode="static",this.addChild(this.statText),this.addChild(this.barlines),this.addChild(this.texts)}update(){this.visible=!!this.manager.chartManager.gameStats,this.x=-this.manager.chartManager.app.STAGE_WIDTH/2+20+ft/2,this.y=this.manager.chartManager.app.STAGE_HEIGHT/2-20,this.backgroundRect.width=ft+10,this.backgroundRect.height=li+260,this.backgroundRect.x=-300/2-5,this.backgroundRect.y=-410,this.visible=!!this.manager.chartManager.gameStats;for(const e of this.barlines.children)b.general.smoothAnimations?e.height=(e.targetHeight-e.height)*.2+e.height:e.height=e.targetHeight;this.lastMode!=this.manager.chartManager.getMode()&&(this.lastMode=this.manager.chartManager.getMode(),rt.animate(this,{0:{showEase:"inherit"},1:{showEase:this.manager.chartManager.getMode()==W.Play?1:0}},.6,pt(.11,.71,.33,1.39),()=>{},"play-widget")),b.general.smoothAnimations?this.y+=(1-Math.abs(this.showEase))*400:this.manager.chartManager.getMode()!=W.Play&&(this.y+=400)}newLine(){const e=new ye(xe.WHITE);return e.smoothCount=0,e.targetHeight=0,e.anchor.y=1,e.anchor.x=.5,e.height=0,e.visible=!1,e}startPlay(){const e=this.manager.chartManager.gameStats;this.max=0,this.errorMS=[],this.meanText.text="-",this.medianText.text="-",this.modeText.text="-",this.stddevText.text="-",Kt(this.barlines.children,()=>!0),Kt(this.backgroundLines.children,()=>!0),Kt(this.texts.children,()=>!0);const t=_t.getCollection(b.play.timingCollection),n=t.getStandardWindows().length+1,a=Math.round(t.maxWindowMS());for(let p=0;p<a*2;p++){const m=this.newLine();m.width=ft/a/2,m.x=(p-a)*m.width,m.y=-50,this.barlines.addChild(m)}let r=0;for(const p of t.getStandardWindows().reverse()){const m=Math.round(p.getTimingWindowMS());if(m!=0){for(let g=-1;g<=1;g+=2){const y=new ye(xe.WHITE);y.anchor.y=1,y.anchor.x=.5,y.height=li,y.tint=p.color,y.alpha=.2,y.width=1,y.x=m*g*ft/a/2,y.y=-50,this.backgroundLines.addChild(y)}for(let g=-m+a;g<m+a;g++)this.barlines.children[Math.round(g)].tint=p.color}}const s=new ye(xe.WHITE);s.anchor.y=1,s.anchor.x=.5,s.height=li,s.alpha=.2,s.width=1,s.tint=8947848,s.y=-50,this.backgroundLines.addChild(s);for(const p of[...t.getStandardWindows(),t.getMissJudgement()]){const m=new ge(p.name,{fontName:"Main",fontSize:15}),g=new ge("0",{fontName:"Main",fontSize:15});m.tint=p.color,g.tint=p.color,g.name=p.id,this.texts.addChild(m),this.texts.addChild(g),m.x=-300/2+10,g.x=-300/2+140,m.y=130/n*r-li-220,g.y=130/n*r++-li-220,m.anchor.y=.5,g.anchor.y=.5,g.anchor.x=1}const o=this.manager.chartManager.loadedChart?.gameType.gameLogic.usesHoldTicks??!1,l=(o?0:t.getHoldWindows().length)+2;r=0;for(const p of o?[t.getMineJudgement()]:[...t.getHoldWindows(),t.getMineJudgement()]){const m=yn(p)?p.noteType:"Mine",g=new ge(m,{fontName:"Main",fontSize:15}),y=new ge("0",{fontName:"Main",fontSize:15});ze(g,"text-color"),ze(y,"text-color"),m!="Mine"&&(y.text="0 / "+this.manager.chartManager.loadedChart.getNotedata().filter(x=>x.type==m&&!x.fake).length),g.alpha=.8,y.alpha=.8,y.name=m,this.texts.addChild(g),this.texts.addChild(y),g.x=-300/2+160,y.x=-300/2+290,g.y=80/l*r-li-220,y.y=80/l*r++-li-220,g.anchor.y=.5,y.anchor.y=.5,y.anchor.x=1}const u=new ge("Max Combo",{fontName:"Main",fontSize:15});ze(u,"text-color");const f=new ge("0",{fontName:"Main",fontSize:15});ze(f,"text-color"),u.alpha=.8,f.alpha=.8,f.name="Combo",this.texts.addChild(u),this.texts.addChild(f),u.x=-300/2+160,f.x=-300/2+290,u.y=80/l*r-li-220,f.y=80/l*r++-li-220,u.anchor.y=.5,f.anchor.y=.5,f.anchor.x=1;const c=new ge("0.00 / 0.00",{fontName:"Main",fontSize:20});ze(c,"text-color"),c.alpha=.8,c.x=-300/2+225,c.y=-262,c.name="Score",this.texts.addChild(c),c.anchor.set(.5);const d=new ge("Score / Current Score",{fontName:"Main",fontSize:13});ze(d,"text-color"),d.alpha=.5,d.x=-300/2+225,d.y=-285,this.texts.addChild(d),d.anchor.set(.5);const h=new ge("Play Statistics",{fontName:"Main",fontSize:13});h.y=-395,h.anchor.set(.5),ze(h,"text-color"),this.texts.addChild(h),e.onJudge((p,m)=>{let g="";(mi(m)||xi(m))&&(g=m.id),yn(m)&&(g=m.noteType),eo(m)&&(g="Mine");const y=this.texts.getChildByName(g);if(yn(m)){const w=y.text.split(" / ")[1];y.text=e.getCount(m)+" / "+w}else Xn(m)||(y.text=e.getCount(m)+"");if(this.texts.getChildByName("Combo").text=e.getMaxCombo()+"",this.texts.getChildByName("Score").text=he(e.getScore()*100,2).toFixed(2)+" / "+he(e.getCumulativeScore()*100,2).toFixed(2),mi(m)||!xi(m)||p==null)return;const x=Math.round(p*1e3);for(let w=-3;w<=3;w++)this.barlines.children[x+a+w]&&(this.barlines.children[x+a+w].smoothCount+=Dc[w+3],this.barlines.children[x+a+w].visible=!0,this.barlines.children[x+a+w].smoothCount>this.max&&(this.modeText.text=x+"ms",this.max=this.barlines.children[x+a+w].smoothCount));this.errorMS.push(p*1e3),this.meanText.text=pd(this.errorMS).toFixed(2)+"ms",this.medianText.text=ja(this.errorMS).toFixed(2)+"ms",this.stddevText.text=zc(this.errorMS).toFixed(2)+"ms",this.redraw()})}redraw(){for(const e of this.barlines.children)e.targetHeight=e.smoothCount*(li-20)/this.max}adjustOffset(e){const t=this.manager.chartManager.gameStats;if(!t)return;const n=Math.round(t.getMedian()*1e3)/1e3;if(n==0)return;t.applyOffset(-n),this.barlines.children.forEach(o=>{o.smoothCount=0});const a=_t.getCollection(b.play.timingCollection),r=Math.round(a.maxWindowMS());t.getDataPoints().forEach(o=>{if(mi(o.judgement)||!xi(o.judgement)||o.error===null)return;const l=Math.round(o.error*1e3);for(let u=-3;u<=3;u++)this.barlines.children[l+r+u]&&(this.barlines.children[l+r+u].smoothCount+=Dc[u+3],this.barlines.children[l+r+u].visible=!0,this.barlines.children[l+r+u].smoothCount>this.max&&(this.modeText.text=l+"ms",this.max=this.barlines.children[l+r+u].smoothCount))}),this.redraw();const s=e=="global"?b.play.offset:this.manager.app.chartManager.loadedChart.timingData.getOffset();if(e=="global")b.play.offset=he(b.play.offset-n,3);else if(e=="song"){const o=this.manager.app.chartManager.loadedChart.timingData.hasChartOffset()?this.manager.app.chartManager.loadedChart.timingData:this.manager.app.chartManager.loadedSM.timingData;o.setOffset(he(o.getOffset()-n,3))}ce.create(`Adjusted ${e} offset from ${he(s,3).toFixed(3)} to ${he(s-n,3).toFixed(3)}`)}}class Nm extends an{registeredSpinners=[];registeredToggles=[];registeredCheckboxes=[];changeRow;warpRow;fakeRow;view;collapseButton;lastSpeedMod=b.chart.CMod;rateSpinner;enteredMain=!1;constructor(e){super(e),this.visible=!1;const t=document.createElement("div");t.id="playback-options",b.general.showPlaybackOptions||t.classList.add("collapsed"),t.style.height="0px",ie.on("resize",()=>{this.registeredToggles.forEach(G=>{G.update(!1)})}),document.getElementById("menubar")?.insertAdjacentElement("afterend",t),this.view=t;const n=document.createElement("button");n.classList.add("po-collapse"),n.tabIndex=-1;const a=be.getIcon("CHEVRON",18);n.appendChild(a),b.general.showPlaybackOptions&&n.classList.add("toggled"),this.collapseButton=n,n.onclick=()=>{b.general.showPlaybackOptions=!b.general.showPlaybackOptions,t.classList.toggle("collapsed"),n.classList.toggle("toggled",!t.classList.contains("collapsed")),n.blur()},n.style.display="none",Xe(n,{onShow(G){G.setContent((t.classList.contains("collapsed")?"Show ":"Hide ")+"playback options")}});const r=this.createRow("Zoom"),s=this.createSpinner({value:b.chart.zoom*100,step:10,altStep:2,min:10,hardMin:0,onChange:G=>b.chart.zoom=G/100,getValue:()=>b.chart.zoom*100});r.appendChild(s),t.appendChild(r);const o=document.createElement("div"),l=document.createElement("h1");l.innerText="a",o.appendChild(l),Ae.createKeybindTooltip(r)`Adjust playfield size ${"zoomOut"}/${"zoomIn"}`,t.appendChild(this.createSeparator());const u=this.createRow("Playback"),f=this.createSpinner({value:b.audio.rate*100,step:10,altStep:2,min:10,hardMin:0,onChange:G=>b.audio.rate=G/100,getValue:()=>b.audio.rate*100});u.appendChild(f),t.appendChild(u),this.rateSpinner=this.registeredSpinners.at(-1),Ae.createKeybindTooltip(u)`Adjust audio playback rate  ${"rateDown"}/${"rateUp"}`;const c=document.createElement("div");c.style.gap="0.25rem",c.style.display="flex",c.style.alignItems="center";const d=this.createCheckbox({getValue:()=>b.audio.assistTick,value:b.audio.assistTick,onEl:be.getIcon("CLAP",18),offEl:be.getIcon("X_CLAP",18),onChange:G=>b.audio.assistTick=G});c.appendChild(d),Ae.createKeybindTooltip(d)`Toggle assist tick ${"assistTick"}`;const h=this.createCheckbox({getValue:()=>b.audio.metronome,value:b.audio.metronome,onEl:be.getIcon("METRONOME",18),offEl:be.getIcon("X_METRONOME",18),onChange:G=>b.audio.metronome=G});c.appendChild(h),t.appendChild(c),Ae.createKeybindTooltip(h)`Toggle metronome ${"metronome"}`,t.appendChild(this.createSeparator());const p=this.createRow("Scroll"),m=be.getIcon("DBL_CHEVRON",16);m.style.padding="0.125rem";const g=be.getIcon("DBL_CHEVRON",16);g.style.padding="0.125rem",g.style.transform="rotate(180deg)";const y=this.createToggle({values:[m,g],value:b.chart.reverse?1:0,getValue:()=>b.chart.reverse?1:0,onChange:(G,V)=>b.chart.reverse=V!=0});p.appendChild(y),t.appendChild(p),Ae.createKeybindTooltip(p)`Change scroll direction ${"reverse"}`;const x=this.createRow("Speedmod"),w=this.createToggle({values:["X","C"],value:b.chart.CMod?1:0,getValue:()=>b.chart.CMod?1:0,onChange:G=>b.chart.CMod=G!="X"});Ae.createKeybindTooltip(w)`Change speedmod type ${"XMod"}/${"CMod"}`;const C=this.createSpinner({value:b.chart.speed,step:25,altStep:5,min:10,hardMin:10,hardMax:35e3,onChange:G=>b.chart.speed=G,getValue:()=>b.chart.speed});x.appendChild(w),x.appendChild(C),t.appendChild(x),Ae.createKeybindTooltip(C)`Adjust scroll speed ${"increaseScrollSpeed"}/${"decreaseScrollSpeed"}`,t.appendChild(this.createSeparator());const _=this.createRow("Speed Changes"),F=this.createToggle({values:["On","Off"],value:b.chart.doSpeedChanges?0:1,getValue:()=>b.chart.doSpeedChanges?0:1,onChange:G=>b.chart.doSpeedChanges=G=="On"});_.appendChild(F),t.appendChild(_),Ae.createKeybindTooltip(_)`Allow scroll/speed events (XMod only) ${"doSpeedChanges"}`,this.changeRow=_;const D=this.createRow("Warped Notes"),O=this.createCheckbox({getValue:()=>b.chart.hideWarpedArrows,value:b.chart.hideWarpedArrows,onEl:be.getIcon("X_EYE",18),offEl:be.getIcon("EYE",18),onChange:G=>b.chart.hideWarpedArrows=G});D.appendChild(O),t.appendChild(D),Ae.createKeybindTooltip(D)`Show/hide warped notes (CMod only) ${"hideWarpedArrows"}`,this.warpRow=D;const H=this.createRow("Faked Notes"),Y=this.createCheckbox({getValue:()=>b.chart.hideFakedArrows,value:b.chart.hideFakedArrows,onEl:be.getIcon("X_EYE",18),offEl:be.getIcon("EYE",18),onChange:G=>b.chart.hideFakedArrows=G});H.appendChild(Y),t.appendChild(H),Ae.createKeybindTooltip(H)`Show/hide faked notes (CMod only) ${"hideFakedArrows"}`,this.fakeRow=H;const re=be.getIcon("VOLUME",22);re.style.marginLeft="auto",re.style.marginRight="-1rem",re.style.height="1.375rem",re.style.width="1.375rem",re.style.alignSelf="center",t.appendChild(re);const M=this.createRow("Master"),R=this.createSpinner({value:b.audio.masterVolume*100,step:5,altStep:1,min:0,max:200,hardMin:0,hardMax:200,onChange:G=>b.audio.masterVolume=G/100,getValue:()=>b.audio.masterVolume*100});M.appendChild(R),t.appendChild(M);const v=this.createRow("Song"),S=this.createSpinner({value:b.audio.songVolume*100,step:5,altStep:1,min:0,max:200,hardMin:0,hardMax:200,onChange:G=>b.audio.songVolume=G/100,getValue:()=>b.audio.songVolume*100});v.appendChild(S),t.appendChild(v);const $=this.createRow("FX"),L=this.createSpinner({value:b.audio.soundEffectVolume*100,step:5,altStep:1,min:0,max:200,hardMin:0,hardMax:200,onChange:G=>b.audio.soundEffectVolume=G/100,getValue:()=>b.audio.soundEffectVolume*100});$.appendChild(L),t.appendChild($),this.changeRow.style.setProperty("--w",this.changeRow.offsetWidth/16+"rem"),this.warpRow.style.setProperty("--w",this.warpRow.offsetWidth/16+"rem"),this.fakeRow.style.setProperty("--w",this.fakeRow.offsetWidth/16+"rem"),this.changeRow.classList.toggle("hidden",b.chart.CMod),this.warpRow.classList.toggle("hidden",!b.chart.CMod),this.fakeRow.classList.toggle("hidden",!b.chart.CMod),fe.playbackOptions||(t.style.display="none",n.style.display="none")}createRow(e){const t=document.createElement("div");t.classList.add("playback-options-row");const n=document.createElement("div");return n.classList.add("playback-options-label"),n.innerText=e,t.appendChild(n),t}createSeparator(){const e=document.createElement("div");return e.classList.add("po-separator"),e}createSpinner(e){const t=document.createElement("div");t.classList.add("po-spinner");const n=u=>{let f=b.general.spinnerStep;return u.getModifierState("Shift")?f=e.altStep??(e.step!==void 0?e.step/10:b.general.spinnerStep):f=e.step??b.general.spinnerStep,f},a=document.createElement("button");a.classList.add("po-spinner-btn"),a.innerText="-",a.onclick=u=>{l.currentValue-=n(u),e.min!==void 0&&l.currentValue<e.min&&(l.currentValue=e.min),o(!0)};const r=document.createElement("button");r.classList.add("po-spinner-btn"),r.innerText="+",r.onclick=u=>{l.currentValue+=n(u),e.max!==void 0&&l.currentValue>e.max&&(l.currentValue=e.max),o(!0)};const s=document.createElement("input");s.classList.add("po-spinner-input"),s.type="text";const o=(u=!0)=>{e.hardMin!==void 0&&l.currentValue<e.hardMin&&(l.currentValue=e.hardMin),e.hardMax!==void 0&&l.currentValue>e.hardMax&&(l.currentValue=e.hardMax),u&&e.onChange(l.currentValue),s.value=l.currentValue.toFixed()};s.addEventListener("wheel",u=>{u.preventDefault(),l.currentValue+=n(u)*u.deltaY/100*(b.chart.scroll.invertZoomScroll?-1:1)*b.chart.scroll.scrollSensitivity,e.max!==void 0&&l.currentValue>e.max&&(l.currentValue=e.max),e.min!==void 0&&l.currentValue<e.min&&(l.currentValue=e.min),o(!0)});const l={btnMinus:a,btnPlus:r,input:s,options:e,currentValue:e.value??0,update:o};return o(),t.replaceChildren(a,s,r),s.spellcheck=!1,s.onkeydown=u=>{u.key=="Enter"&&s.blur(),u.key=="Escape"&&(l.currentValue=e.getValue(),o(!1))},s.onfocus=()=>{s.select()},s.onblur=()=>{const u=this.parseString(s);if(u==null){l.currentValue=e.getValue(),o(!1);return}l.currentValue=u,o()},s.ondragstart=u=>u.preventDefault(),this.registeredSpinners.push(l),t}createToggle(e){const t=document.createElement("div");if(t.classList.add("po-toggle"),e.values.length==0)return t;const n=document.createElement("div");n.classList.add("po-toggle-highlight");const a=e.values.map((l,u)=>{if(typeof l=="string"){const f=document.createElement("div");return f.classList.add("po-toggle-item"),f.innerText=l,t.appendChild(f),f.onclick=()=>{o.currentValue!=u&&(o.currentValue=u,s())},f}else return l.onclick=()=>{o.currentValue!=u&&(o.currentValue=u,s())},t.appendChild(l),l});t.style.visibility="hidden",document.body.appendChild(t);const r=l=>{n.style.left=a[l].getBoundingClientRect().left-a[0].getBoundingClientRect().left+"px",n.style.width=a[l].getBoundingClientRect().width+"px",n.style.height=a[l].getBoundingClientRect().height+"px"},s=(l=!0)=>{l&&e.onChange(e.values[o.currentValue],o.currentValue),[...t.querySelectorAll(".active")].forEach(u=>u.classList.remove("active")),r(o.currentValue),a[o.currentValue].classList.add("active")},o={currentValue:e.value??0,options:e,update:s};return this.registeredToggles.push(o),s(!1),t.remove(),t.style.visibility="",t.appendChild(n),t}createCheckbox(e){const t=document.createElement("div");t.classList.add("ico-checkbox");const n=(r=!0)=>{r&&e.onChange(a.currentValue),a.options.onEl.style.display=a.currentValue?"":"none",a.options.offEl.style.display=a.currentValue?"none":""},a={currentValue:e.value??!0,options:e,update:n};return t.onclick=()=>{a.currentValue=!a.currentValue,n()},this.registeredCheckboxes.push(a),n(!1),t.replaceChildren(a.options.onEl,a.options.offEl),t}update(){!this.enteredMain&&this.manager.chartManager.loadedChart!==void 0&&fe.menuBar&&(this.enteredMain=!0,this.view.style.height="",this.collapseButton.style.display="",document.getElementById("menubar")?.appendChild(this.collapseButton));for(const t of this.registeredSpinners)t.currentValue!=t.options.getValue()&&document.activeElement!=t.input&&(t.currentValue=t.options.getValue(),t.update(!1));for(const t of this.registeredToggles)t.currentValue!=t.options.getValue()&&(t.currentValue=t.options.getValue(),t.update(!1));for(const t of this.registeredCheckboxes)t.currentValue!=t.options.getValue()&&(t.currentValue=t.options.getValue(),t.update(!1));const e=this.manager.chartManager.getMode()==W.Play||this.manager.chartManager.getMode()==W.Record;this.rateSpinner.btnMinus.disabled=e,this.rateSpinner.btnPlus.disabled=e,this.rateSpinner.input.disabled=e,b.chart.CMod!=this.lastSpeedMod&&(this.lastSpeedMod=b.chart.CMod,this.changeRow.classList.toggle("hidden",b.chart.CMod),this.warpRow.classList.toggle("hidden",!b.chart.CMod),this.fakeRow.classList.toggle("hidden",!b.chart.CMod))}parseString(e){try{const t=Wc.evaluate(e.value);return isFinite(t)?t:0}catch{return null}}}const Ei={BPMS:9182254,STOPS:4934913,DELAYS:217453,WARPS:9243998,FAKES:4868682,COMBOS:939078,SPEEDS:2968693,LABELS:7747359,SCROLLS:3557006,TIMESIGNATURES:5392684,TICKCOUNTS:1594906,BGCHANGES:8460415,FGCHANGES:8857115,ATTACKS:1856083};class Hm extends de{isEditGUI=!0;renderer;areaPool=new Ot({create:()=>{const e=new ye(xe.WHITE);return Object.assign(e,{alpha:.2,width:this.renderer.chart.gameType.notefieldWidth+128}),e.anchor.set(.5,0),e}});timingAreaMap=new Map;timingEvents=[];timingDirty=!0;constructor(e){super(),this.renderer=e,this.addChild(this.areaPool);const t=()=>this.timingDirty=!0;ie.on("timingModified",t),this.on("destroyed",()=>ie.off("timingModified",t))}update(e,t){this.timingDirty&&(this.timingAreaMap.clear(),this.areaPool.destroyAll(),this.timingDirty=!1,this.timingEvents=this.renderer.chart.timingData.getTimingData("STOPS","WARPS","DELAYS","FAKES"));for(const n of this.timingEvents){if(n.beat>t)break;if(this.shouldDrawEvent(n,e,t)&&!this.timingAreaMap.has(n)){const a=this.areaPool.createChild();if(!a)break;a.tint=Ei[n.type],this.timingAreaMap.set(n,a)}}for(const[n,a]of this.timingAreaMap.entries()){if(!this.shouldDrawEvent(n,e,t)){this.timingAreaMap.delete(n),this.areaPool.destroyChild(a);continue}let r=b.chart.CMod?this.renderer.getYPosFromSecond(n.second):this.renderer.getYPosFromBeat(n.beat),s=r;switch(n.type){case"STOPS":case"DELAYS":{b.chart.CMod&&n.value>0?s=this.renderer.getYPosFromSecond(n.second+n.value):n.value<0&&(s=this.renderer.getYPosFromBeat(this.renderer.chart.getBeatFromSeconds(n.second+1e-4)));break}case"FAKES":{s=this.renderer.getYPosFromBeat(n.beat+n.value);break}case"WARPS":{b.chart.CMod||(s=this.renderer.getYPosFromBeat(n.beat+n.value));break}}s<r&&([s,r]=[r,s]);const o=s-r;a.y=r,a.height=o}}shouldDrawEvent(e,t,n){return(e.type=="STOPS"||e.type=="DELAYS")&&e.second+Math.abs(e.value)<=this.renderer.chart.timingData.getSecondsFromBeat(t)||(e.type=="WARPS"||e.type=="FAKES")&&e.beat+e.value<t||(e.type=="STOPS"||e.type=="DELAYS")&&!(!b.chart.CMod&&e.value<0||b.chart.CMod&&e.value>0)||e.type=="WARPS"&&b.chart.CMod?!1:e.beat<=n}}const je={chart:{title:"Chart Timing Column",desc:"Events in this column are only used by this difficulty",convertText:"Convert to song timing",buttonOne:{text:"Copy chart events",tooltip:"Copies chart events from this column to song timing",tooltipAll:"Copies offset and chart events from all columns to song timing",action:(i,e)=>{i.copyColumnsToSimfile([e])},actionAll:i=>{i.copyAllToSimfile()}},buttonTwo:{text:"Delete chart events",tooltip:"Reverts this column to the events in song timing, deleting any difficulty-specific events",tooltipAll:"Reverts offset and all columns to the events in song timing, deleting any difficulty-specific events",action:(i,e)=>{i.deleteColumns([e])},actionAll:i=>{i.deleteAllChartSpecific()}}},song:{title:"Song Timing Column",desc:"Events in this column are used by all difficulties (unless overridden)",convertText:"Convert to chart timing",buttonOne:{text:"Copy song events",tooltip:"Copies song events from this column to chart timing",tooltipAll:"Copies offset and song events from all columns to chart timing",action:(i,e)=>{i.copyColumnsFromSimfile([e])},actionAll:i=>{i.copyAllFromSimfile()}},buttonTwo:{text:"Don't copy song events",tooltip:"Converts this column to chart timing without copying any song events",tooltipAll:"Converts offset and all columns to chart timing without copying any song events",action:(i,e)=>{i.createChartColumns([e])},actionAll:i=>{i.createEmptyData()}}}},Wi={chart:{title:"Chart Specific Offset",desc:"This offset is only used by this difficulty",convertText:"Convert to song timing",buttonOne:{text:"Copy chart offset",tooltip:"Sets the song offset to this chart offset",action:i=>{i.copyOffsetToSimfile()}},buttonTwo:{text:"Revert to song offset",tooltip:"Reverts to the song offset, removing the chart-specific offset",action:i=>{i.removeChartOffset()}}},song:{title:"Song Specific Offset",desc:"This offset is used by all difficulties (unless overridden)",convertText:"Convert to chart timing",buttonOne:{text:"Copy song offset",tooltip:"Copies song offset to the chart offset",action:i=>{i.setOffset(i.getOffset())}},buttonTwo:{text:"Don't copy song offset",tooltip:"Sets the new chart offset to 0",action:i=>{i.setOffset(0)}}}},Bc=150;class Ui{static active=!1;static persistent=!1;static options;static popup;static view;static title;static desc;static editText;static clickOutside;static moveInterval;static updateInterval;static _open(e){if(!this.active){if(this.options=e,this._build(),!document.getElementById("popups")){console.error("Failed to open popup!","error");return}document.getElementById("popups")?.appendChild(this.popup),this.clickOutside&&window.removeEventListener("click",this.clickOutside,!0),this.clickOutside=this.options.clickHandler??(t=>{this.popup?.contains(t.target)||this.close()}),this.popup.style.transitionDuration="0s",this.movePosition(),this.moveInterval=setInterval(()=>this.movePosition(),Bc),this.active=!0,this.options.cancelableOnOpen&&setTimeout(()=>window.addEventListener("click",this.clickOutside,!0),200)}}static cloneRect(e){return{top:e.top,bottom:e.bottom,left:e.left,right:e.right,width:e.width,height:e.height}}static movePosition(){const e=this.options.attach instanceof HTMLElement?this.options.attach.getBoundingClientRect():this.cloneRect(this.options.attach.getBounds());this.options.attach instanceof HTMLElement||(e.top+=document.getElementById("pixi").offsetTop+9);const t=e.left+e.width/2,n=this.popup.clientWidth,a=n/2+15,r=window.innerWidth-n/2-15;this.popup.style.left=`${Te(t,a,r)}px`;const s=e.top+e.height/2+15;this.popup.style.top=`${s}px`,s+this.popup.clientHeight>window.innerHeight-15?(this.popup.style.transform="translate(-50%, -100%)",this.view.style.transformOrigin="bottom",this.popup.style.top=`${e.top-15}px`):(this.popup.style.transform="",this.view.style.transformOrigin=""),requestAnimationFrame(()=>this.popup.style.transitionDuration="")}static _build(){const e=document.createElement("div");e.classList.add("popup"),this.popup=e;const t=document.createElement("div");t.classList.add("popup-zoomer"),this.options.width&&(t.style.width=`${this.options.width/16}rem`),t.style.backgroundColor=this.options.background??"",t.style.color=this.options.textColor??"",e.appendChild(t),this.view=t;const n=document.createElement("div");if(n.innerText=this.options.title,n.classList.add("popup-title"),t.appendChild(n),this.title=n,this.options.description!==void 0){const a=document.createElement("div");a.innerText=this.options.description,a.classList.add("popup-desc"),t.appendChild(a),this.desc=a}if(this.buildContent(),this.options.editable){const a=document.createElement("div");a.innerText="click to edit",a.style.marginTop="4px",a.style.height="10px",t.appendChild(a),a.classList.add("popup-desc"),this.editText=a}if(this.options.options){const a=document.createElement("div");a.classList.add("popup-options"),this.options.options.forEach(r=>{const s=document.createElement("button");s.innerText=r.label,s.onclick=()=>{r.callback?.()},s.classList.add(r.type),a.appendChild(s)}),this.view.append(a)}}static buildContent(){}static close(){if(!this.popup||!this.active)return;window.removeEventListener("click",this.clickOutside,!0),this.popup.classList.add("exiting");const e=this.popup;setTimeout(()=>e.remove(),200),this.active=!1,this.persistent=!1,clearInterval(this.moveInterval),clearInterval(this.updateInterval)}static select(){!this.popup||!this.options.editable||(this.persistent=!0,this.view.classList.add("selected"),this.editText.style.transform="scale(0)",this.editText.style.height="0px",this.options.cancelableOnOpen||setTimeout(()=>window.addEventListener("click",this.clickOutside,!0),200))}static detach(){clearInterval(this.moveInterval)}static attach(e){clearInterval(this.moveInterval),this.moveInterval=setInterval(()=>this.movePosition(),Bc),this.options.attach=e}}class Ms extends Ui{static app;static timingGrid;static onTimingChange=this.updateValues.bind(this);static open(e){this.active||(this.app=e,super._open({title:"Manage Split Timing",editable:!1,attach:document.getElementById("split-timing"),cancelableOnOpen:!0,clickHandler:t=>{!this.popup?.contains(t.target)&&!document.getElementById("split-timing")?.contains(t.target)&&this.close()}}),ie.on("timingModified",this.onTimingChange))}static buildContent(){this.popup.id="split-timing";const e=document.createElement("div");e.classList.add("split-timing-grid"),this.timingGrid=e;const t=this.buildModifyGrid();this.updateValues(),this.view.appendChild(e),this.view.appendChild(t)}static updateValues(){this.timingGrid.replaceChildren();const e=document.createElement("div");e.classList.add("split-timing-row"),e.style.backgroundColor="rgba(0, 0, 0, 0.3";const t=document.createElement("div");t.innerText="OFFSET";const n=this.app.chartManager.loadedChart.timingData.hasChartOffset(),a=n?"chart":"song",r=document.createElement("div");r.innerText=n?"C":"S",Xe(r,{content:Wi[a].desc});const s=document.createElement("button");s.innerText=Wi[a].buttonOne.text,Xe(s,{content:Wi[a].buttonOne.tooltip}),s.onclick=()=>{Wi[a].buttonOne.action(this.app.chartManager.loadedChart.timingData)};const o=document.createElement("button");o.innerText=Wi[a].buttonTwo.text,o.classList.toggle("delete",n),Xe(o,{content:Wi[a].buttonTwo.tooltip}),o.onclick=()=>{Wi[a].buttonTwo.action(this.app.chartManager.loadedChart.timingData)},e.replaceChildren(t,r,s,o),this.timingGrid.appendChild(e);for(const l of Ia)this.timingGrid.appendChild(this.buildRow(l));return e}static buildRow(e){const t=document.createElement("div");t.classList.add("split-timing-row"),t.style.backgroundColor=En(Ei[e].toString(16).padStart(6,"0"),"#333333",.75);const n=document.createElement("div");n.innerText=e;const a=this.app.chartManager.loadedChart.timingData.isPropertyChartSpecific(e),r=a?"chart":"song",s=document.createElement("div");s.innerText=a?"C":"S",Xe(s,{content:je[r].desc});const o=document.createElement("button");o.innerText=je[r].buttonOne.text,Xe(o,{content:je[r].buttonOne.tooltip}),o.onclick=()=>{je[r].buttonOne.action(this.app.chartManager.loadedChart.timingData,e)};const l=document.createElement("button");return l.innerText=je[r].buttonTwo.text,l.classList.toggle("delete",a),Xe(l,{content:je[r].buttonTwo.tooltip}),l.onclick=()=>{je[r].buttonTwo.action(this.app.chartManager.loadedChart.timingData,e)},t.replaceChildren(n,s,o,l),t}static buildModifyGrid(){const e=document.createElement("div");e.classList.add("split-timing-grid");const t=document.createElement("div");t.classList.add("split-timing-modify-row"),t.style.backgroundColor="rgba(0, 0, 0, 0.3";const n=document.createElement("div");n.innerText="Convert all to chart timing";const a=document.createElement("button");a.innerText=je.song.buttonOne.text,Xe(a,{content:je.song.buttonOne.tooltipAll}),a.onclick=()=>{je.song.buttonOne.actionAll(this.app.chartManager.loadedChart.timingData),a.blur()};const r=document.createElement("button");r.innerText=je.song.buttonTwo.text,r.classList.add("delete"),Xe(r,{content:je.song.buttonTwo.tooltipAll}),r.onclick=()=>{je.song.buttonTwo.actionAll(this.app.chartManager.loadedChart.timingData),r.blur()},t.replaceChildren(n,a,r);const s=document.createElement("div");s.classList.add("split-timing-modify-row"),s.style.backgroundColor="rgba(0, 0, 0, 0.3";const o=document.createElement("div");o.innerText="Convert all to song timing";const l=document.createElement("button");l.innerText=je.chart.buttonOne.text,Xe(l,{content:je.chart.buttonOne.tooltipAll}),l.onclick=()=>{je.chart.buttonOne.actionAll(this.app.chartManager.loadedChart.timingData),l.blur()};const u=document.createElement("button");return u.innerText=je.chart.buttonTwo.text,Xe(u,{content:je.chart.buttonTwo.tooltipAll}),u.onclick=()=>{je.chart.buttonTwo.actionAll(this.app.chartManager.loadedChart.timingData),u.blur()},s.replaceChildren(o,l,u),e.replaceChildren(t,s),e}static close(){!this.popup||!this.active||super.close()}}class Ls extends Ui{static draggedElement;static dragOffsetX=0;static dragOffsetY=0;static grid;static leftovers;static boundaryCache=[];static open(){this.active||super._open({title:"Reorder Timing Tracks",editable:!1,attach:document.getElementById("toggle-tracks"),cancelableOnOpen:!0,clickHandler:e=>{!this.popup?.contains(e.target)&&!this.draggedElement?.contains(e.target)&&!document.getElementById("toggle-tracks")?.contains(e.target)&&this.close()}})}static buildContent(){this.popup.id="timing-track-order";const e=document.createElement("div");e.classList.add("track-grid-options");const t=document.createElement("button");t.classList.add("delete"),t.innerText="Reset",t.onclick=()=>{b.chart.timingEventOrder.left=structuredClone(No.chart.timingEventOrder.left),b.chart.timingEventOrder.right=structuredClone(No.chart.timingEventOrder.right),this.clearBoundaries(),this.grid?.replaceChildren(),this.leftovers?.replaceChildren();const r=[...Ia];for(const o of b.chart.timingEventOrder.left){const l=this.makeDraggableTrack(o);l.classList.add("left"),this.grid?.appendChild(l),r.splice(r.indexOf(o),1)}const s=document.createElement("div");s.classList.add("draggable-track"),s.innerText="PLAYFIELD",s.style.backgroundColor="#2D2D2D",s.style.padding="1.25rem 0.625rem",s.style.writingMode="horizontal-tb",s.addEventListener("mousedown",o=>this.startDragging(o,s)),s.dataset.type="PLAYFIELD",this.grid?.appendChild(s);for(const o of b.chart.timingEventOrder.right){const l=this.makeDraggableTrack(o);l.classList.add("right"),this.grid?.appendChild(l),r.splice(r.indexOf(o),1)}for(const o of r)this.leftovers?.appendChild(this.makeLeftoverTrack(o))},this.grid=document.createElement("div"),this.grid.classList.add("track-grid"),this.view.appendChild(this.grid),this.view.appendChild(e);const n=[...Ia];for(const r of b.chart.timingEventOrder.left){const s=this.makeDraggableTrack(r);s.classList.add("left"),this.grid.appendChild(s),n.splice(n.indexOf(r),1)}const a=document.createElement("div");a.classList.add("draggable-track"),a.innerText="PLAYFIELD",a.style.backgroundColor="#2D2D2D",a.style.padding="1.25rem 0.625rem",a.style.writingMode="horizontal-tb",a.addEventListener("mousedown",r=>this.startDragging(r,a)),a.dataset.type="PLAYFIELD",this.grid.appendChild(a);for(const r of b.chart.timingEventOrder.right){const s=this.makeDraggableTrack(r);s.classList.add("right"),this.grid.appendChild(s),n.splice(n.indexOf(r),1)}this.leftovers=document.createElement("div"),this.leftovers.classList.add("track-selector"),e.appendChild(this.leftovers),e.appendChild(t);for(const r of n)this.leftovers.appendChild(this.makeLeftoverTrack(r))}static makeDraggableTrack(e){const t=document.createElement("div");t.classList.add("draggable-track");const n=document.createElement("div");n.classList.add("draggable-track-text"),n.innerText=e,t.style.backgroundColor=En(Ei[e].toString(16).padStart(6,"0"),"#333333",.7),t.appendChild(n);let a=!0;const r=be.getIcon("TRASH",16);return r.addEventListener("click",()=>{if(!a)return;a=!1,this.deleteTrack(e),t.classList.add("exiting"),setTimeout(()=>t.remove(),400);const s=this.makeLeftoverTrack(e);s.classList.add("entering"),setTimeout(()=>s.classList.remove("entering"),400),this.leftovers?.appendChild(s),this.clearBoundaries()}),t.appendChild(r),t.addEventListener("mousedown",s=>{a&&(r.contains(s.target)||this.startDragging(s,t))}),t.dataset.type=e,t}static makeLeftoverTrack(e){const t=document.createElement("div");t.classList.add("leftover-track");const n=be.getIcon("PLUS",8);t.append(n);const a=document.createElement("div");a.classList.add("leftover-track-text"),a.innerText=e,t.style.backgroundColor=En(Ei[e].toString(16).padStart(6,"0"),"#333333",.7),t.appendChild(a);let r=0,s=0,o=!1,l=!1;return t.addEventListener("mousedown",()=>{o=!0}),t.addEventListener("mousemove",u=>{if(!(!o||l)&&(r+=u.movementX,s+=u.movementY,r*r+s*s>15)){l=!0;const f=this.makeDraggableTrack(e);this.grid?.appendChild(f),this.clearBoundaries();const c=t.getBoundingClientRect(),d=this.getClosestSlot(c.left),h=b.chart.timingEventOrder.left.concat(["PLAYFIELD"],b.chart.timingEventOrder.right);h.splice(d,0,e),this.saveOptions(h),h.forEach(p=>{const m=this.grid?.querySelector(`div[data-type=${p}]`);this.grid?.appendChild(m),p!="PLAYFIELD"&&(m?.classList.remove("left","right"),b.chart.timingEventOrder.left.includes(p)&&m?.classList.add("left"),b.chart.timingEventOrder.right.includes(p)&&m?.classList.add("right"))}),this.startDragging(u,f,u.clientX,u.clientY),b.general.smoothAnimations?(t.style.width=t.clientWidth+"px",t.style.transition="0.4s cubic-bezier(0, 0.91, 0.34, 1.05)",setTimeout(()=>{t.style.width="0px",t.style.opacity="0",t.style.padding="0",t.style.fontSize="0"},10),setTimeout(()=>t.remove(),400)):t.remove()}}),t.addEventListener("mouseup",()=>{if(!o||l)return;l=!0,b.chart.timingEventOrder.right.push(e),b.general.smoothAnimations?(t.style.width=t.clientWidth+"px",t.style.transition="0.4s cubic-bezier(0, 0.91, 0.34, 1.05)",setTimeout(()=>{t.style.width="0px",t.style.opacity="0",t.style.padding="0",t.style.fontSize="0"},10),setTimeout(()=>t.remove(),400)):t.remove();const u=this.makeDraggableTrack(e);u.classList.add("entering"),u.classList.add("right"),setTimeout(()=>u.classList.remove("entering"),400),this.grid?.appendChild(u),this.clearBoundaries()}),t}static startDragging(e,t,n,a){if(!this.popup)return;this.draggedElement=t.cloneNode(!0),this.draggedElement.style.position="fixed";const r=t.getBoundingClientRect(),s=this.popup.getBoundingClientRect();!n||!a?(this.dragOffsetX=e.clientX-r.left,this.dragOffsetY=e.clientY-r.top,this.draggedElement.style.left=r.left-s.left+"px",this.draggedElement.style.top=r.top-s.top+"px"):(this.dragOffsetX=r.width/2,this.dragOffsetY=r.height/4*3,this.draggedElement.style.left=n-r.width/2-s.left+"px",this.draggedElement.style.top=a-r.height/4*3-s.top+"px",this.draggedElement.classList.add("entering")),this.draggedElement.style.boxShadow="6px 6px 6px #222",this.draggedElement.style.transition="none",t.style.opacity="0.03",this.popup.appendChild(this.draggedElement);const o=b.chart.timingEventOrder.left.concat(["PLAYFIELD"],b.chart.timingEventOrder.right),l=t.dataset.type;let u=o.indexOf(l);const f=o.indexOf(l),c=h=>{this.draggedElement.style.left=h.clientX-this.dragOffsetX-s.left+"px",this.draggedElement.style.top=h.clientY-this.dragOffsetY-s.top+"px";let p=this.getClosestSlot(h.clientX-this.dragOffsetX);Math.abs(h.clientY-this.dragOffsetY-s.top-(r.top-s.top))>140&&(p=f),u!=p&&(o.splice(u,1),o.splice(p,0,l),this.saveOptions(o),o.forEach(m=>{const g=this.grid?.querySelector(`div[data-type=${m}]`);this.grid?.appendChild(g),m!="PLAYFIELD"&&(g?.classList.remove("left","right"),b.chart.timingEventOrder.left.includes(m)&&g?.classList.add("left"),b.chart.timingEventOrder.right.includes(m)&&g?.classList.add("right"))}),l!="PLAYFIELD"&&(this.draggedElement?.classList.remove("left","right"),b.chart.timingEventOrder.left.includes(l)&&this.draggedElement?.classList.add("left"),b.chart.timingEventOrder.right.includes(l)&&this.draggedElement?.classList.add("right")),u=p)};window.addEventListener("mousemove",c);const d=()=>{this.draggedElement?.remove(),this.draggedElement=void 0,window.removeEventListener("mousemove",c),t.style.opacity="",this.clearBoundaries(),window.removeEventListener("mouseup",d)};window.addEventListener("mouseup",d)}static saveOptions(e){const t=e.indexOf("PLAYFIELD");t!=-1&&(b.chart.timingEventOrder.left=e.slice(0,t),b.chart.timingEventOrder.right=e.slice(t+1))}static deleteTrack(e){const t=b.chart.timingEventOrder.left.indexOf(e);t!=-1&&b.chart.timingEventOrder.left.splice(t,1);const n=b.chart.timingEventOrder.right.indexOf(e);n!=-1&&b.chart.timingEventOrder.right.splice(n,1),b.chart.timingEventOrder.left=[...b.chart.timingEventOrder.left],b.chart.timingEventOrder.right=[...b.chart.timingEventOrder.right]}static getClosestSlot(e){this.boundaryCache.length==0&&this.getBoundaries();let t=-1,n=999999,a=999999;for(let r=0;r<this.boundaryCache.length;r++){const s=Math.abs(e-this.boundaryCache[r][1].left);if(s<n&&(n=s,t=r),s>a)break;a=s}return t}static getBoundaries(){if(this.grid){for(const e of this.grid.children)this.boundaryCache.push([e,e.getBoundingClientRect()]);this.boundaryCache.sort((e,t)=>e[1].left-t[1].left)}}static clearBoundaries(){this.boundaryCache=[]}static close(){!this.popup||!this.active||(super.close(),this.clearBoundaries())}}class zm extends an{view;playbackBar;skipStart;skipEnd;play;playIcon;stopIcon;record;playtest;timeCounter;beatCounter;min;sec;millis;beat;beatDropdown;editBar;editSteps;editTiming;stepsContainer;timingContainer;editChoiceContainer;addTimingEvent;splitTiming;toggleTimingTracks;detectSync;offsetCounter;offset;noteArrows=[];noteArrowMask;lastTime=null;lastBeat=null;lastOffset=null;lastMode=W.Edit;lastTimingMode=Se.Off;lastHover=0;lastPlaying=!1;hovering=!1;trackingMovement=!0;idleFrames=0;lastBounds;constructor(e){super(e);const t=document.createElement("div");t.id="status-widget",document.getElementById("view-wrapper")?.appendChild(t),fe.viewMode&&t.classList.add("collapsed"),this.playbackBar=document.createElement("div"),this.playbackBar.classList.add("playback-bar"),this.editBar=document.createElement("div"),this.editBar.classList.add("edit-bar"),this.skipStart=document.createElement("button"),this.skipStart.tabIndex=-1;const n=be.getIcon("SKIP_START",36);this.skipStart.appendChild(n),this.skipStart.onclick=()=>{this.manager.chartManager.beat=Math.max(0,this.manager.chartManager.loadedChart.getBeatFromSeconds(0)),this.skipStart.blur()},Ae.createKeybindTooltip(this.skipStart)`Skip to start ${"jumpSongStart"}`,this.skipEnd=document.createElement("button"),this.skipEnd.tabIndex=-1;const a=be.getIcon("SKIP_END",36);this.skipEnd.appendChild(a),this.skipEnd.onclick=()=>{this.manager.chartManager.beat=this.manager.chartManager.loadedChart.getBeatFromSeconds(this.manager.chartManager.chartAudio.getSongLength()),this.skipEnd.blur()},Ae.createKeybindTooltip(this.skipEnd)`Skip to end ${"jumpSongEnd"}`,this.play=document.createElement("button"),this.play.tabIndex=-1;const r=be.getIcon("PLAY",40);this.play.appendChild(r),this.playIcon=r;const s=be.getIcon("STOP",32);this.play.appendChild(s),this.stopIcon=s,this.stopIcon.style.display="none",this.play.onclick=()=>{(this.manager.chartManager.getMode()==W.Record||this.manager.chartManager.getMode()==W.Play)&&this.manager.chartManager.setMode(W.Edit),this.manager.chartManager.playPause(),this.play.blur()},Ae.createKeybindTooltip(this.play)`Play/Pause ${"playback"}`,this.record=document.createElement("button"),this.record.tabIndex=-1;const o=be.getIcon("RECORD",36,void 0,"red");this.record.appendChild(o),this.record.onclick=()=>{this.manager.chartManager.setMode(W.Record),this.record.blur()},Ae.createKeybindTooltip(this.record)`Record ${"recordMode"}`,(fe.viewMode||!fe.recordMode)&&(this.record.style.display="none"),this.playtest=document.createElement("button"),this.playtest.tabIndex=-1;const l=be.getIcon("PLAYTEST",30);this.playtest.appendChild(l),this.playtest.onclick=()=>{this.manager.chartManager.setMode(W.Play),this.playtest.blur()},Ae.createKeybindTooltip(this.playtest)`Playtest ${"playMode"}`,fe.playMode||(this.playtest.style.display="none");const u=document.createElement("div");u.classList.add("playback-separator"),this.timeCounter=document.createElement("div"),this.timeCounter.classList.add("playback-counter");const f=document.createElement("div");f.style.display="flex",f.classList.add("playback-counter-main");const c=document.createElement("div");c.classList.add("inlineEdit"),c.innerText="00",c.spellcheck=!1,c.contentEditable="true",c.style.maxWidth=`${27/16}rem`,c.onkeydown=S=>{S.key=="Enter"&&c.blur(),S.key=="Escape"&&(c.innerText=Math.floor(Math.abs(this.manager.chartManager.time)/60).toString().padStart(2,"0"),c.blur())},c.onfocus=()=>setTimeout(()=>this.selectText(c),25),c.onblur=()=>this.updateTime(),c.ondragstart=S=>S.preventDefault();const d=document.createElement("div");d.classList.add("inlineEdit"),d.innerText="00",d.spellcheck=!1,d.contentEditable="true",d.style.maxWidth=`${18/16}rem`,d.onkeydown=S=>{S.key=="Enter"&&d.blur(),S.key=="Escape"&&(d.innerText=Math.floor(Math.abs(this.manager.chartManager.time)%60).toString().padStart(2,"0"),d.blur())},d.onfocus=()=>setTimeout(()=>this.selectText(d),25),d.onblur=()=>this.updateTime(),d.ondragstart=S=>S.preventDefault();const h=document.createElement("div");h.classList.add("inlineEdit"),h.innerText="000",h.spellcheck=!1,h.contentEditable="true",h.style.maxWidth=`${27/16}rem`,h.onkeydown=S=>{S.key=="Enter"&&h.blur(),S.key=="Escape"&&(h.innerText=(he(Math.abs(this.manager.chartManager.time)%1,3)*1e3).toString().padStart(3,"0"),h.blur())},h.onfocus=()=>setTimeout(()=>this.selectText(h),25),h.onblur=()=>this.updateTime(),h.ondragstart=S=>S.preventDefault(),this.min=c,this.sec=d,this.millis=h;const p=document.createElement("div");p.classList.add("playback-counter-label"),p.innerText="Time",f.appendChild(c),f.appendChild(document.createTextNode(":")),f.appendChild(d),f.appendChild(document.createTextNode(".")),f.appendChild(h),this.timeCounter.appendChild(f),this.timeCounter.appendChild(p);const m=document.createElement("div");m.classList.add("playback-separator"),this.beatCounter=document.createElement("div"),this.beatCounter.classList.add("playback-counter");const g=document.createElement("div");g.style.display="flex",g.classList.add("playback-counter-main");const y=document.createElement("div");y.classList.add("inlineEdit"),y.innerText="0.000",y.spellcheck=!1,y.contentEditable="true",y.onkeydown=S=>{if(S.key=="Enter"&&y.blur(),S.key=="Escape"){if(this.beatDropdown.value=="Measure"){const $=this.manager.chartManager.loadedChart?.timingData?.getMeasure(this.manager.chartManager.beat)??this.manager.chartManager.beat/4;y.innerText=he($,3).toFixed(3)}else y.innerText=he(this.manager.chartManager.beat,3).toFixed(3);y.blur()}},y.onfocus=()=>{setTimeout(()=>this.selectText(y),25)},y.onblur=()=>this.updateBeat(),y.ondragstart=S=>S.preventDefault(),this.beat=y,this.beatDropdown=gi.create(["Beat","Measure"],"Beat"),this.beatDropdown.view.querySelector(".dropdown-selected").classList.add("playback-counter-label"),this.beatCounter.appendChild(g),g.appendChild(y),this.beatCounter.appendChild(this.beatDropdown.view),this.beatDropdown.onChange(()=>{if(this.beatDropdown.value=="Measure"){const S=this.manager.chartManager.loadedChart?.timingData?.getMeasure(this.manager.chartManager.beat)??this.manager.chartManager.beat/4;y.innerText=he(S,3).toFixed(3)}else y.innerText=he(this.manager.chartManager.beat,3).toFixed(3)}),this.playbackBar.appendChild(this.skipStart),this.playbackBar.appendChild(this.skipEnd),this.playbackBar.appendChild(this.play),this.playbackBar.appendChild(this.record),this.playbackBar.appendChild(this.playtest),this.playbackBar.appendChild(u),this.playbackBar.appendChild(this.timeCounter),this.playbackBar.appendChild(m),this.playbackBar.appendChild(this.beatCounter),this.editSteps=document.createElement("button"),this.editSteps.tabIndex=-1,this.editSteps.classList.add("edit-fancy-button");const x=be.getIcon("FEET",24);x.style.marginBottom=`${2/16}rem`,this.editSteps.appendChild(x),this.editSteps.appendChild(document.createTextNode("Edit Steps")),this.editSteps.onclick=()=>{this.manager.chartManager.editTimingMode=Se.Off,this.editSteps.blur()},this.editSteps.classList.add("active"),this.editTiming=document.createElement("button"),this.editTiming.tabIndex=-1,this.editTiming.classList.add("edit-fancy-button");const w=be.getIcon("METRONOME",24);w.style.marginBottom=`${2/16}rem`,this.editTiming.appendChild(w),this.editTiming.appendChild(document.createTextNode("Edit Timing")),this.editTiming.onclick=()=>{this.manager.chartManager.editTimingMode=Se.Edit,this.editTiming.blur()};const C=document.createElement("div");C.classList.add("playback-separator");const _=document.createElement("div");_.classList.add("edit-bar-left"),_.appendChild(this.editSteps),_.appendChild(this.editTiming),_.appendChild(C),this.editBar.appendChild(_),this.editChoiceContainer=document.createElement("div"),this.editChoiceContainer.classList.add("edit-choice-container"),this.stepsContainer=document.createElement("div"),this.stepsContainer.classList.add("edit-steps-container"),this.timingContainer=document.createElement("div"),this.timingContainer.classList.add("edit-timing-container"),this.editChoiceContainer.appendChild(this.stepsContainer),this.editChoiceContainer.appendChild(this.timingContainer),this.addTimingEvent=document.createElement("button"),this.addTimingEvent.tabIndex=-1;const F=be.getIcon("ADD_EVENT",32);this.addTimingEvent.appendChild(F),this.addTimingEvent.onclick=()=>{this.manager.chartManager.editTimingMode==Se.Add?this.manager.chartManager.editTimingMode=Se.Edit:this.manager.chartManager.editTimingMode=Se.Add,this.addTimingEvent.blur()},this.timingContainer.appendChild(this.addTimingEvent),Ae.createKeybindTooltip(this.addTimingEvent)`Add timing events ${"toggleAddTiming"}`;const D=document.createElement("div");D.classList.add("playback-separator"),this.timingContainer.appendChild(D),this.splitTiming=document.createElement("button"),this.splitTiming.tabIndex=-1;const O=be.getIcon("SPLIT_TIMING",32);this.splitTiming.appendChild(O),this.splitTiming.onclick=()=>{Ms.active?Ms.close():Ms.open(this.manager.app),this.splitTiming.blur()},this.splitTiming.id="split-timing",this.timingContainer.appendChild(this.splitTiming),Xe(this.splitTiming,{content:"Manage split timing"}),this.toggleTimingTracks=document.createElement("button"),this.toggleTimingTracks.tabIndex=-1;const H=be.getIcon("EYE",32);this.toggleTimingTracks.appendChild(H),this.toggleTimingTracks.onclick=()=>{Ls.active?Ls.close():Ls.open(),this.toggleTimingTracks.blur()},this.toggleTimingTracks.id="toggle-tracks",this.timingContainer.appendChild(this.toggleTimingTracks),Xe(this.toggleTimingTracks,{content:"Toggle timing track visibility"}),this.detectSync=document.createElement("button"),this.detectSync.tabIndex=-1;const Y=be.getIcon("DETECT_SYNC",32);this.detectSync.appendChild(Y),this.detectSync.onclick=()=>{this.manager.app.windowManager.openWindow(new Zu(this.manager.app)),this.detectSync.blur()},this.detectSync.id="detect-sync",this.timingContainer.appendChild(this.detectSync),Ae.createKeybindTooltip(this.detectSync)`Detect audio sync ${"detectSync"}`;const re=document.createElement("div");re.classList.add("playback-separator"),this.timingContainer.appendChild(re),this.offsetCounter=document.createElement("div"),this.offsetCounter.classList.add("playback-counter");const M=document.createElement("div");M.classList.add("playback-counter-label"),M.innerText="Offset";const R=document.createElement("div");R.classList.add("playback-counter-main","inlineEdit"),R.innerText="0.000",R.spellcheck=!1,R.contentEditable="true",R.onkeydown=S=>{S.key=="Enter"&&R.blur(),S.key=="Escape"&&(R.innerText=he(this.manager.chartManager.loadedChart?.timingData.getOffset()??0,3).toFixed(3),R.blur())},R.tabIndex=-1,R.onfocus=()=>{setTimeout(()=>this.selectText(R),25)},R.onblur=()=>this.updateOffset(),R.ondragstart=S=>S.preventDefault(),this.offset=R,this.offsetCounter.appendChild(R),this.offsetCounter.appendChild(M),this.timingContainer.appendChild(this.offsetCounter),this.editBar.appendChild(this.editChoiceContainer);const v=document.createElement("div");v.classList.add("note-placeholder-right"),this.stepsContainer.appendChild(v),ie.on("resize",()=>{this.trackingMovement=!0,this.idleFrames=5}),ie.on("noteskinLoaded",()=>{this.stepsContainer.replaceChildren(),this.noteArrows.forEach($=>{this.removeChild($.sprite),this.removeChild($.bg),this.removeChild($.highlight)}),this.noteArrows=[];const S=document.createElement("div");if(S.classList.add("note-placeholder-right"),this.stepsContainer.appendChild(S),!!this.manager.chartManager.loadedChart){for(const $ of this.manager.chartManager.loadedChart.gameType.editNoteTypes){if(md.includes($))continue;const L=this.manager.chartManager.chartView.getNotefield().createNote({type:$,beat:0,col:0,quant:4,second:0,warped:!1,fake:!1});L.scale.set(.5);const G=new ye(xe.WHITE);ze(G,"widget-bg"),G.width=48,G.height=48,G.anchor.set(.5);const V=new lt("noBorder");V.alpha=0,V.width=48,V.height=48,V.pivot.x=24,V.pivot.y=24;const J=document.createElement("button");J.tabIndex=-1,J.style.height="3rem",J.style.width="3rem",J.classList.add("note-placeholder"),J.onclick=()=>{this.manager.chartManager.setEditingNoteType($),J.blur()},Ae.createKeybindTooltip(J)`${"\\"+$} ${"noteType"+$}`;const N={element:J,sprite:L,type:$,bg:G,highlight:V,hovered:!1};J.onmouseover=()=>{N.hovered=!0},J.onmouseleave=()=>{N.hovered=!1},this.addChild(G),this.addChild(L),this.addChild(V);const P=J.getBoundingClientRect();L.position.y=P.top-this.manager.app.view.clientHeight/2-this.manager.app.view.getBoundingClientRect().top+24,L.position.x=P.left-this.manager.app.view.clientWidth/2+24,G.position=L.position,this.noteArrows.push(N)}this.stepsContainer.replaceChildren(...this.noteArrows.map($=>$.element),S),this.trackingMovement=!0,this.idleFrames=5}}),this.noteArrowMask=new ye(xe.WHITE),this.noteArrowMask.height=48,this.noteArrowMask.width=2500,this.noteArrowMask.anchor.y=1,this.noteArrowMask.anchor.x=.5,this.addChild(this.noteArrowMask),this.mask=this.noteArrowMask,t.onmouseenter=()=>{this.lastHover=Date.now(),this.hovering=!0,this.view.style.opacity="",this.view.style.transition=""},t.onmouseleave=()=>this.hovering=!1,t.appendChild(this.playbackBar),t.appendChild(this.editBar),this.view=t,t.style.display="none"}update(){this.view.style.display=this.manager.chartManager.loadedSM&&fe.status&&!this.manager.app.capturing?"":"none",this.scale.set(1/this.manager.chartManager.app.stage.scale.x);const e=this.manager.chartManager.time;this.lastTime!=e&&(document.activeElement!=this.min&&(this.min.innerText=(e<0?"-":"")+Math.floor(Math.abs(e)/60).toString().padStart(2,"0")),document.activeElement!=this.sec&&(this.sec.innerText=Math.floor(Math.abs(e)%60).toString().padStart(2,"0")),document.activeElement!=this.millis&&(this.millis.innerText=(he(Math.abs(e)%1,3)*1e3).toString().padStart(3,"0")),this.lastTime=e);const t=this.manager.chartManager.beat;if(this.lastBeat!=t){if(document.activeElement!=this.beat)if(this.beatDropdown.value=="Measure"){const c=this.manager.chartManager.loadedChart?.timingData?.getMeasure(t)??t/4;this.beat.innerText=he(c,3).toFixed(3)}else this.beat.innerText=he(t,3).toFixed(3);this.lastBeat=t}const n=this.manager.chartManager.loadedChart?.timingData.getOffset()??0;this.lastOffset!=n&&document.activeElement!=this.offset&&(this.offset.innerText=he(n,3).toFixed(3));const a=this.manager.chartManager.getMode(),r=this.manager.chartManager.editTimingMode;if(this.lastMode!=a){switch(a){case W.Edit:this.skipStart.disabled=!1,this.skipEnd.disabled=!1,this.record.disabled=!1,this.playtest.disabled=!1,this.min.contentEditable="true",this.sec.contentEditable="true",this.millis.contentEditable="true",this.beat.contentEditable="true",this.offset.contentEditable="true",this.record.style.background="",this.playtest.style.background="",this.view.style.opacity="",this.view.style.transition="",this.view.classList.remove("collapsed"),this.beatDropdown.disabled=!1;break;case W.Record:this.lastHover=Date.now(),this.skipStart.disabled=!0,this.skipEnd.disabled=!0,this.record.disabled=!1,this.record.style.background="rgba(170, 0, 0, 0.35)",this.playtest.disabled=!0,this.min.contentEditable="false",this.sec.contentEditable="false",this.millis.contentEditable="false",this.beat.contentEditable="false",this.offset.contentEditable="false",r!=Se.Off&&(this.visible=!1),this.view.classList.add("collapsed"),this.beatDropdown.closeDropdown(),this.beatDropdown.disabled=!0;break;case W.Play:this.lastHover=Date.now(),this.skipStart.disabled=!0,this.skipEnd.disabled=!0,this.record.disabled=!0,this.playtest.disabled=!1,this.playtest.style.background="rgba(12, 97, 31, 0.35)",this.min.contentEditable="false",this.sec.contentEditable="false",this.millis.contentEditable="false",this.beat.contentEditable="false",this.offset.contentEditable="false",r!=Se.Off&&(this.visible=!1),this.view.classList.add("collapsed"),this.beatDropdown.closeDropdown(),this.beatDropdown.disabled=!0;break;case W.View:this.lastHover=Date.now(),this.skipStart.disabled=!1,this.skipEnd.disabled=!1,this.record.disabled=!0,this.playtest.disabled=!1,this.min.contentEditable="true",this.sec.contentEditable="true",this.millis.contentEditable="true",this.beat.contentEditable="true",this.offset.contentEditable="true",r!=Se.Off&&(this.visible=!1),this.view.classList.add("collapsed"),this.beatDropdown.closeDropdown(),this.beatDropdown.disabled=!0}this.trackingMovement=!0,this.idleFrames=5,this.lastMode=a}if(this.lastTimingMode!=r){switch(r){case Se.Off:this.visible=!0,this.stepsContainer.style.transform="",this.timingContainer.style.transform="",this.editSteps.classList.add("active"),this.editTiming.classList.remove("active"),this.offset.tabIndex=-1;break;case Se.Add:this.addTimingEvent.classList.add("active");break;case Se.Edit:this.addTimingEvent.classList.remove("active"),this.offset.tabIndex=0}(this.lastTimingMode==Se.Off&&r!=Se.Off||this.lastTimingMode!=Se.Off&&r==Se.Off)&&this.manager.chartManager.clearSelections(),this.trackingMovement=!0,this.idleFrames=5,this.lastTimingMode=r,this.stepsContainer.style.transform=r==Se.Off?"":"translateY(-3rem)",this.timingContainer.style.transform=r==Se.Off?"":"translateY(-3rem)",this.editSteps.classList.toggle("active",r==Se.Off),this.editTiming.classList.toggle("active",r!=Se.Off)}const s=this.manager.chartManager.chartAudio.isPlaying();if(this.lastPlaying!=s&&(this.playIcon.style.display=s?"none":"",this.stopIcon.style.display=s?"":"none",this.lastPlaying=s),(a==W.Play||a==W.Record)&&this.view.style.opacity==""&&!this.hovering&&Date.now()-this.lastHover>3e3&&(this.view.style.opacity="0.2",this.view.style.transition="2s cubic-bezier(.11,.72,.51,1.14)"),this.trackingMovement){let c=48;const d=this.noteArrows[0];if(d){const p=d.element.getBoundingClientRect();c=p.width,this.noteArrows.forEach((m,g)=>{m.sprite.position.y=p.top-this.manager.app.view.clientHeight/2-this.manager.app.view.getBoundingClientRect().top+c/2,m.sprite.position.x=p.left-this.manager.app.view.clientWidth/2+c/2+g*c,m.sprite.scale.set(c/96),m.bg.width=c,m.bg.height=c,m.bg.position=m.sprite.position,m.highlight.width=c,m.highlight.height=c,m.highlight.position=m.sprite.position,m.highlight.pivot.set(c/2)}),this.lastBounds&&Math.abs(this.lastBounds.top-p.top)+Math.abs(this.lastBounds.left-p.left)==0&&(this.idleFrames--,this.idleFrames<0&&(this.trackingMovement=!1,this.lastBounds=void 0,r!=Se.Off&&(this.visible=!1))),this.lastBounds=p}const h=this.view.getBoundingClientRect();this.noteArrowMask.y=h.bottom-this.manager.app.view.clientHeight/2-this.manager.app.view.getBoundingClientRect().top,this.noteArrowMask.height=c}const o=this.manager.chartManager.getEditingNoteType(),l=Fe.getColor("editable-overlay-hover"),u=Fe.getColor("editable-overlay-active"),f=new B(l).setAlpha(0);this.noteArrows.forEach(c=>{let d=o==c.type?u:c.hovered?l:f;b.general.smoothAnimations&&(d=new B(It(new B(c.highlight.tint).setAlpha(c.highlight.alpha),d,.3))),c.highlight.tint=d.toNumber(),c.highlight.alpha=d.alpha})}selectText(e){const t=window.getSelection(),n=document.createRange();!t||!n||(n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n))}updateTime(){this.millis.innerText=this.millis.innerText.padEnd(3,"0").slice(0,3);const e=this.parseString(this.min),t=this.parseString(this.sec),n=this.parseString(this.millis);if(e===null||t===null||n===null){this.lastTime=null;return}let a=e*60+t+n/1e3;a>9999999&&(a=9999999),a<0&&(a=0),this.manager.chartManager.time=a,this.lastTime=null}updateBeat(){let e=this.parseString(this.beat);if(e===null){this.lastBeat=null;return}this.beatDropdown.value=="Measure"&&(e=this.manager.chartManager.loadedChart?.timingData?.getBeatFromMeasure(e)??e*4),e>9999999&&(e=9999999),e<0&&(e=0),this.manager.chartManager.beat=e,this.lastBeat=null}updateOffset(){let e=this.parseString(this.offset);if(e===null){this.lastOffset=null;return}e>9999999&&(e=9999999),e<-9999999&&(e=-9999999),this.lastOffset=null,!(!this.manager.chartManager.loadedChart||!this.manager.chartManager.loadedSM)&&(this.manager.chartManager.loadedChart.timingData.hasChartOffset()?this.manager.chartManager.loadedChart.timingData:this.manager.chartManager.loadedSM.timingData).setOffset(e)}parseString(e){try{const t=Wc.evaluate(e.innerText);return isFinite(t)?t:0}catch{return null}}}class Vm extends Vi{npsGraph;graphGradient=null;graphWidth=40;npsText=new ge("",{fontName:"Main",fontSize:12});constructor(e){super(e,{backingWidth:60,order:9}),this.graphWidth=40,this.graphGradient=this.makeGradient(),this.npsGraph=new Hi,this.container.addChild(this.npsGraph),this.name="density",this.npsText.visible=!1,this.npsText.anchor.x=1,this.npsText.anchor.y=.5,ze(this.npsText,"text-color"),this.addChild(this.npsText),ie.on("userOptionUpdated",n=>{(n=="chart.npsGraph.color1"||n=="chart.npsGraph.color2")&&(this.graphGradient=this.makeGradient(),this.populate())}),this.on("mouseleave",()=>{this.hideNpsDisplay()}),this.on("mouseenter",()=>{this.showNpsDisplay()}),this.on("mousemove",n=>{this.updateNpsDisplay(n)}),this.populate()}updateNpsDisplay(e){const t=this.getChart();if(!t){this.npsText.visible=!1;return}if(!t.getNotedata().at(-1)){this.npsText.visible=!1;return}const a=t.stats.npsGraph,r=this.manager.app.STAGE_HEIGHT-this.verticalMargin;let s=this.npsGraph.toLocal(e.global).y/r;s=Te(s,0,1);const o=this.getSongPositionFromT(s),l=Math.floor(t.timingData.getMeasure(o.beat)),u=a[l]??0;this.npsText.text=u.toFixed(1)+" nps",this.npsText.position.y=this.npsGraph.toLocal(e.global).y-r/2,this.npsText.position.x=-this.backing.width/2-10,this.npsText.visible=!0}hideNpsDisplay(){this.npsText.visible=!1}showNpsDisplay(){const e=this.getChart();if(!e){this.npsText.visible=!1;return}if(!e.getNotedata().at(-1)){this.npsText.visible=!1;return}this.npsText.visible=!0}update(){if(!b.chart.npsGraph.enabled){this.visible=!1;return}this.visible=!0,this.npsText.scale.y=b.chart.reverse?-1:1,super.update()}populate(e,t){super.populate(e,t);const n=this.getChart();if(!n)return;const a=n.stats.getMaxNPS(),r=n.stats.npsGraph,s=n.getLastBeat();if(this.npsGraph.clear(),n.getNotedata().length==0)return;this.graphGradient?this.npsGraph.beginTextureFill({texture:this.graphGradient}):this.npsGraph.beginFill(0,1),this.npsGraph.pivot.x=this.backing.width/2,this.npsGraph.pivot.y=(this.manager.app.STAGE_HEIGHT-this.verticalMargin)/2;const o=Math.floor(this.getChart().timingData.getMeasure(s)),l=this.getYFromBeat(this.getSongPositionFromT(0).beat),u=this.getYFromBeat(this.getSongPositionFromT(1).beat);this.npsGraph.moveTo(0,l);for(let h=0;h<=o;h++){const p=r[h]??0,m=n.timingData.getBeatFromMeasure(h),g=Math.min(s,n.timingData.getBeatFromMeasure(h+1));if(e!==void 0&&g<e)continue;if(t!==void 0&&m>t)break;const y=$t(0,a,p)*this.graphWidth,x=Te(this.getYFromBeat(m),l,u),w=Te(this.getYFromBeat(g),l,u);this.npsGraph.lineTo(y,x),this.npsGraph.lineTo(y,w)}const f=r.at(-1)??0,c=$t(0,a,f)*this.graphWidth,d=Te(this.getYFromBeat(s),l,u);this.npsGraph.lineTo(c,d),this.npsGraph.lineTo(0,d),this.npsGraph.endFill()}makeGradient(){const e=this.graphWidth,t=document.createElement("canvas");t.width=e,t.height=e;const n=t.getContext("2d");if(n==null)return null;const a=n.createLinearGradient(0,0,e,0);return a.addColorStop(0,ea(b.chart.npsGraph.color1).toHexa()),a.addColorStop(.8,ea(b.chart.npsGraph.color2).toHexa()),n.fillStyle=a,n.fillRect(0,0,e,e),xe.from(t)}}class Um extends Vi{barContainer=new Ya(1500,{position:!0,scale:!0,tint:!0},16384,!0);bars;barTexture;middleLine;colorCache=new Map;constructor(e){super(e,{backingWidth:48,order:1,trigger:"parity"}),this.visible=!1,this.name="facing",this.backing.tint=0,this.backing.alpha=.3,this.middleLine=new ye(xe.WHITE),this.middleLine.anchor.set(.5),this.middleLine.width=1,this.middleLine.alpha=.2,this.middleLine.height=this.manager.app.STAGE_HEIGHT,this.addChild(this.middleLine),this.barTexture=Jt.create({resolution:this.manager.app.renderer.resolution}),this.bars=new ye(this.barTexture),this.bars.anchor.set(.5),this.container.addChild(this.bars),this.container.addChild(this.barContainer),this.populate(),ie.on("userOptionUpdated",t=>{t=="chart.parity.showCandles"&&this.populate()})}update(){if(!b.chart.facingLayout.enabled||!b.chart.parity.enabled){this.visible=!1;return}this.visible=!0,this.middleLine.height=this.backing.height,b.chart.layoutFollowPosition?(this.bars.visible=!1,this.barContainer.visible=!0):(this.bars.visible=!0,this.barContainer.visible=!1),super.update()}populate(e,t){super.populate(e,t);const n=this.getChart();if(!n||!n.stats.parity||n.stats.parity.rowTimestamps.length==0){Kt(this.barContainer.children,()=>!0),this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture});return}let a=0;const r=this.manager.app.STAGE_HEIGHT-this.verticalMargin;b.chart.layoutFollowPosition?(this.barContainer.y=-r/2,this.barContainer.x=-16):(this.barContainer.position.set(0),this.barTexture.resize(32,r)),this.updateDimensions();const s=Fn(n.stats.parity.rowTimestamps,e??0,o=>o.beat);for(let o=s;o<n.stats.parity.facingRows.length;o++){if(e!==void 0&&n.stats.parity.rowTimestamps[o].beat<e)continue;if(t!==void 0&&n.stats.parity.rowTimestamps[o].beat>t)break;if(n.stats.parity.candles.has(o)&&b.chart.parity.showCandles){let c=this.barContainer.children[a];c||(c=new ye(xe.WHITE),this.barContainer.addChild(c)),c.anchor.set(.5),c.height=3,c.width=32,c.alpha=.4,c.tint=ii[n.stats.parity.candles.get(o)],c.x=16,c.y=this.getYFromBeat(n.stats.parity.rowTimestamps[o].beat),a++}let l=this.barContainer.children[a];l||(l=new ye(xe.WHITE),l.width=6,this.barContainer.addChild(l));let u=n.stats.parity.facingRows[o];if(u=Te(u,-2,2),this.colorCache.has(u))l.tint=this.colorCache.get(u);else{let c;n.stats.parity.facingRows[o]<0?c=En("#ffffff",new B(ii[me.LEFT_HEEL]).toHex(),u/-2):c=En("#ffffff",new B(ii[me.RIGHT_HEEL]).toHex(),u/2),this.colorCache.set(u,c)}l.anchor.set(.5),l.height=1,l.width=6,l.alpha=1,Math.abs(u)>1.6&&(l.height=2,l.width=8);const f=Math.sign(u)*Math.pow(Math.abs(u),1.5)/2;l.x=16+f*8,l.y=this.getYFromBeat(n.stats.parity.rowTimestamps[o].beat),a++}Kt(this.barContainer.children,(o,l)=>l>=a),b.chart.layoutFollowPosition||(this.barContainer.visible=!0,this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture}),this.barContainer.visible=!1)}}class Ea extends Ui{static onSnapChange=this.updateValues.bind(this);static divInput;static divLabel;static beatInput;static open(e){this.active||(super._open({attach:e,title:"Snap Options",width:200,editable:!0,cancelableOnOpen:!1}),ie.on("snapChanged",this.onSnapChange))}static buildContent(){const e=document.createElement("div");e.classList.add("popup-flex"),this.view.appendChild(e);const t=document.createElement("div");t.classList.add("popup-row");const n=document.createElement("div");n.innerText="Snap to nearest ";const a=ht.create({value:b.chart.snap==0?0:Math.round(4/b.chart.snap),step:1,precision:0,min:0,max:1e3});a.onchange=f=>{if(f===void 0){this.updateValues();return}f==0?b.chart.snap=0:b.chart.snap=4/f,this.updateValues()};const r=document.createElement("div");r.innerText=this.suffixSnap()+" note",t.replaceChildren(n,a.view,r);const s=document.createElement("div");s.classList.add("popup-row");const o=document.createElement("div");o.innerText="Snap every";const l=ht.create({value:b.chart.snap,step:.001,precision:3,min:0});l.onchange=f=>{if(f===void 0){this.updateValues();return}f==0?b.chart.snap=0:b.chart.snap=f,this.updateValues()};const u=document.createElement("div");u.innerText=" beats",s.replaceChildren(o,l.view,u),e.replaceChildren(t,s),this.beatInput=l,this.divInput=a,this.divLabel=r}static updateValues(){document.activeElement==this.divInput.input||document.activeElement==this.beatInput.input||(this.divInput.value=b.chart.snap==0?0:Math.round(4/b.chart.snap),this.divLabel.innerText=this.suffixSnap()+" note",this.beatInput.value=b.chart.snap)}static suffixSnap(){const e=b.chart.snap==0?0:Math.round(4/b.chart.snap);return e%10==1&&e!=11?"st":e%10==2&&e!=12?"nd":e%10==3&&e!=13?"rd":"th"}static close(){!this.popup||!this.active||(super.close(),ie.off("timingModified",this.onSnapChange))}}const Wm={fontName:"Main",fontSize:10,fill:["#ffffff"]},td={4:15157287,8:4033015,12:11152884,16:8577607,24:14167723,32:15376696,48:15699179,64:7071886,96:8553090,192:8553090};class Gm extends de{isEditGUI=!0;renderer;children=[];constructor(e){super(),this.renderer=e;for(let t=0;t<2;t++){const n=new de,a=new Hi,r=new ge("4",Wm);n.x=(t-.5)*(this.renderer.chart.gameType.notefieldWidth+48),a.rotation=Math.PI/4,a.lineStyle(1,0,1),a.beginFill(16777215),a.drawRect(-12,-12,24,24),a.endFill(),r.anchor.set(.5),n.addChild(a,r),this.addChild(n),n.eventMode="static",n.cursor="pointer",n.on("mouseenter",()=>Ea.open(a)),n.on("mousedown",()=>Ea.select()),n.on("mouseleave",()=>{Ea.persistent||Ea.close()})}}update(){this.y=this.renderer.getActualReceptorYPos();for(let e=0;e<2;e++){const t=this.children[e],n=t.children[0];n.tint=td[4/b.chart.snap]??7368816;const a=t.children[1];a.text=""+(b.chart.snap==0||4/b.chart.snap%1!=0?"":4/b.chart.snap)}}}class qm extends Vi{barContainer=new Ya(1500,{position:!0,scale:!0,tint:!0},16384,!0);bars;barTexture;constructor(e){super(e),this.visible=!1,this.name="note-layout",this.backing.tint=0,this.backing.alpha=.3,this.barTexture=Jt.create({resolution:this.manager.app.renderer.resolution}),this.bars=new ye(this.barTexture),this.bars.anchor.set(.5),this.container.addChild(this.bars),this.container.addChild(this.barContainer),this.populate()}update(){if(!b.chart.noteLayout.enabled){this.visible=!1;return}this.visible=!0,b.chart.layoutFollowPosition?(this.bars.visible=!1,this.barContainer.visible=!0):(this.bars.visible=!0,this.barContainer.visible=!1),super.update()}populate(e,t){super.populate(e,t);const n=this.getChart();if(!n){Kt(this.barContainer.children,()=>!0),this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture});return}let a=0;const r=n.gameType.numCols,s=n.getNotedata().at(-1),o=this.manager.app.STAGE_HEIGHT-this.verticalMargin;if(this.barTexture.resize(r*6,o),this.backingWidth=r*6+8,b.chart.layoutFollowPosition?(this.barContainer.y=-o/2,this.barContainer.x=-r*3):(this.barContainer.position.set(0),this.barTexture.resize(r*6,o)),this.updateDimensions(),!s){Kt(this.barContainer.children,()=>!0),this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture});return}for(const l of n.getNotedataInRange(e??0,t??n.getLastBeat())){if(!this.shouldDisplayNote(l))continue;let u=this.barContainer.children[a];if(u||(u=new ye(xe.WHITE),u.width=4,this.barContainer.addChild(u)),u.anchor.set(.5),u.height=1,u.x=(l.col+.5)*6,u.y=this.getYFromBeat(l.beat),u.tint=td[l.quant],l.type=="Mine"&&(u.tint=8421504),a++,Oe(l)){let f=this.barContainer.children[a];f||(f=new ye(xe.WHITE),f.width=4,f.height=2,this.barContainer.addChild(f)),f.anchor.x=.5,f.anchor.y=0,f.x=(l.col+.5)*6;const c=this.getYFromBeat(l.beat+l.hold)+1;f.y=u.y,f.height=c-u.y,l.type=="Hold"&&(f.tint=10526880),l.type=="Roll"&&(f.tint=11379586),a++}}Kt(this.barContainer.children,(l,u)=>u>=a),b.chart.layoutFollowPosition||(this.barContainer.visible=!0,this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture}),this.barContainer.visible=!1)}shouldDisplayNote(e){return!(b.chart.CMod&&e.fake&&b.chart.hideFakedArrows||b.chart.CMod&&b.chart.hideWarpedArrows&&e.warped)}}class jm extends de{app;chartManager;children=[];constructor(e){super(),this.app=e.app,this.chartManager=e,this.addChild(new qm(this)),this.addChild(new Om(this)),this.addChild(new zm(this)),this.addChild(new en(this)),this.addChild(new Vm(this)),this.addChild(new Nm(this)),this.addChild(new Um(this)),this.addChild(new Dm(this)),this.addChild(new Rm(this)),this.zIndex=2}update(){this.children.forEach(e=>e.update())}startPlay(){this.children.forEach(e=>e.startPlay())}endPlay(){this.children.forEach(e=>e.endPlay())}}const Ks=Array(85).fill(void 0).map((i,e)=>33+e),id=[];for(const i of Ks)for(const e of Ks)id.push([i,e]);const Xs="<~".split("").map(i=>i.charCodeAt(0)),Zs="~>".split("").map(i=>i.charCodeAt(0));function $m(i,e,t,n=!1,a=!1,r=!1){let s;typeof i=="string"?s=i.split("").map(c=>c.charCodeAt(0)):s=[...new Uint8Array(i)];const o=4-s.length%4;for(let c=0;c<o;c++)s.push(0);const l=new Uint8Array(s),u=new DataView(l.buffer);let f=[];for(let c=0;c<s.length;c+=4){const d=u.getUint32(c);a&&!d?f.push(122):r&&d==538976288?f.push(121):(f=f.concat(t[Math.floor(d/614125)],t[Math.floor(d/85)%7225]),f.push(e[d%85]))}if(o&&!n){if(f.at(-1)==122){f.pop();for(let c=0;c<5;c++)f.push(e[0])}for(let c=0;c<o;c++)f.pop()}return f}function Bo(i,e=!1,t=!1,n=!1){let a=$m(i,Ks,id,t,!0,e);return n&&(a=Xs.concat(a).concat(Zs)),a}function Fo(i,e=!1,t=` 	
\r\v`){let n;if(typeof i=="string"?n=i.split("").map(o=>o.charCodeAt(0)):n=[...new Uint8Array(i)],e){if(n.at(-1)!=Zs.at(-1)||n.at(-2)!=Zs.at(-2))return!1;n.at(0)==Xs.at(0)&&n.at(1)==Xs.at(1)?n=n.slice(2,-2):n=n.slice(void 0,-2)}for(let o=0;o<4;o++)n.push(117);let a=[],r=[];for(const o of n)if(o>=33&&117>=o){if(r.push(o),r.length==5){let l=0;for(const u of r)l=85*l+(u-33);if(l>2**32-1)return!1;a.push(l>>24&255),a.push(l>>16&255),a.push(l>>8&255),a.push(l&255),r=[]}}else if(o==122){if(r.length!=0)return!1;a.push(0),a.push(0),a.push(0),a.push(0)}else if(o==121){if(r.length!=0)return!1;a.push(32),a.push(32),a.push(32),a.push(32)}else if(!t.includes(String.fromCharCode(o)))return!1;const s=4-r.length;return s&&(a=a.slice(void 0,-s)),a}function qt(i){let e=0,t=0,n=129;for(;(n&128)!=0;){const a=i.shift();if(!a)break;e=e|(a&127)<<7*t++,n=a}return e}function jt(i){const e=[];let t=!1;for(;!t;){let n=i&127;i=i>>7,t=i==0,t||(n=n|128),e.push(n)}return e}const Ym=["Hold","Mine","Roll","Lift","Fake"];function Km(i){if(i.startsWith("ArrowVortex:notes:")){const e=Fo(i.slice(18));if(e!==!1){const t=Array.from(e);if(t.shift()!=0)return;const n=qt(t),a=[];for(let r=0;r<n;r++){const s=t.shift();if(s==null)return;const o=s&127;if((s&128)!=0){const l=qt(t),u=qt(t),f=t.shift();if(f==null||f>4)continue;const c=Ym[f];if(l==u){if(c=="Hold"||c=="Roll")continue;a.push({type:c,beat:l/48,col:o})}else{if(c=="Mine"||c=="Fake"||c=="Lift")continue;a.push({type:c,beat:l/48,hold:(u-l)/48,col:o})}}else a.push({type:"Tap",beat:qt(t)/48,col:o})}return a}}}function Xm(i){const e=[0];e.push(...jt(i.length));for(const t of i)if(t.type=="Tap"){const n=Math.round(t.beat*48);e.push(t.col),e.push(...jt(n))}else{e.push(t.col+128);const n=Math.round(t.beat*48);let a=0;Oe(t)&&(a=t.hold);const r=Math.round(a*48)+n;e.push(...jt(n)),e.push(...jt(r)),e.push(["Hold","Mine","Roll","Lift","Fake"].indexOf(t.type))}return"ArrowVortex:notes:"+Bo(e).map(t=>String.fromCharCode(t)).join("")}const lr=["BPMS","STOPS","DELAYS","WARPS","TIMESIGNATURES","TICKCOUNTS","COMBOS","SPEEDS","SCROLLS","FAKES","LABELS","ATTACKS","BGCHANGES","FGCHANGES"];function _i(i){const e=new ArrayBuffer(4);return new DataView(e).setUint32(0,i,!0),Array.from(new Uint8Array(e))}function Ai(i){const e=new Uint8Array(i.splice(0,4));return new DataView(e.buffer).getUint32(0,!0)}function Pi(i){const e=new ArrayBuffer(8);return new DataView(e).setFloat64(0,i,!0),Array.from(new Uint8Array(e))}function Ri(i){const e=new Uint8Array(i.splice(0,8)),t=new DataView(e.buffer);return he(t.getFloat64(0,!0),3)}function Zm(i){return[i.length,...i.split("").map(e=>e.charCodeAt(0))]}function Qm(i){const e=i.shift();if(!e)return"";let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(i.shift());return t}function ki(i){return jt(i.length).concat(i.split("").map(e=>e.charCodeAt(0)))}function Si(i){const e=qt(i);if(!e)return"";let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(i.shift());return t}function Jm(i){return i.some(e=>{if(e.type=="ATTACKS"||e.type=="BGCHANGES"||e.type=="FGCHANGES")return!0;const t=Math.round(e.beat*48)/48;if(Math.abs(t-e.beat)>5e-4)return!0;if(e.type=="FAKES"||e.type=="WARPS"){const n=Math.round(e.value*48)/48;if(Math.abs(n-e.value)>5e-4)return!0}return e.type=="LABELS"&&e.value.length>255||e.type=="TIMESIGNATURES"&&(e.upper>2**32-1||e.lower>2**32-1)||e.type=="COMBOS"&&(e.hitMult>2**32-1||e.missMult>2**32-1)?!0:e.type=="TICKCOUNTS"&&e.value>2**32-1})?tg(i):eg(i)}function eg(i){const e=[],t=new Map;i.forEach(n=>{t.has(n.type)||t.set(n.type,[]),t.get(n.type)?.push(n)});for(const[n,a]of t.entries())if(!(n=="ATTACKS"||n=="BGCHANGES"||n=="FGCHANGES")){e.push(a.length),e.push(lr.indexOf(n));for(const r of a)switch(e.push(..._i(Math.round(r.beat*48))),r.type){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":e.push(...Pi(r.value));break;case"FAKES":case"WARPS":e.push(..._i(Math.round(r.value*48)));break;case"TIMESIGNATURES":e.push(..._i(Math.round(r.upper))),e.push(..._i(Math.round(r.lower)));break;case"COMBOS":e.push(..._i(Math.round(r.hitMult))),e.push(..._i(Math.round(r.missMult)));break;case"TICKCOUNTS":e.push(..._i(Math.round(r.value)));break;case"SPEEDS":e.push(...Pi(r.value)),e.push(...Pi(r.delay)),e.push(..._i(r.unit=="B"?0:1));break;case"LABELS":e.push(...Zm(r.value))}}return e.push(0),"ArrowVortex:tempo:"+Bo(e).map(n=>String.fromCharCode(n)).join("")}function tg(i){const e=[],t=new Map;i.forEach(n=>{t.has(n.type)||t.set(n.type,[]),t.get(n.type)?.push(n)});for(const[n,a]of t.entries()){e.push(...jt(a.length)),e.push(lr.indexOf(n));for(const r of a)switch(e.push(...jt(Math.round((r.type=="ATTACKS"?r.second:r.beat)*1e3))),r.type){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":case"FAKES":case"WARPS":e.push(...Pi(r.value));break;case"TIMESIGNATURES":e.push(...jt(Math.round(r.upper))),e.push(...jt(Math.round(r.lower)));break;case"COMBOS":e.push(...jt(Math.round(r.hitMult))),e.push(...jt(Math.round(r.missMult)));break;case"TICKCOUNTS":e.push(...jt(Math.round(r.value)));break;case"SPEEDS":e.push(...Pi(r.value)),e.push(...Pi(r.delay)),e.push(r.unit=="B"?0:1);break;case"LABELS":e.push(...ki(r.value));break;case"ATTACKS":e.push(...Pi(r.value)),e.push(r.endType=="LEN"?0:1),e.push(...ki(r.mods));break;case"BGCHANGES":case"FGCHANGES":e.push((r.crossFade?1:0)+((r.stretchRewind?1:0)<<1)+((r.stretchNoLoop?1:0)<<2)),e.push(...ki(r.file)),e.push(...Pi(r.updateRate)),e.push(...ki(r.effect)),e.push(...ki(r.file2)),e.push(...ki(r.transition)),e.push(...ki(r.color1)),e.push(...ki(r.color2))}}return"SMEditor:tempo:"+Bo(e).map(n=>String.fromCharCode(n)).join("")}function ig(i){if(i.startsWith("SMEditor:tempo:"))return ag(i);if(i.startsWith("ArrowVortex:tempo:"))return ng(i)}function ng(i){if(!i.startsWith("ArrowVortex:tempo:"))return;const e=Fo(i.slice(18)),t=[];if(e===!1)return;const n=Array.from(e);try{for(;;){const a=n.shift();if(a===void 0)return;if(a==0)break;const r=n.shift();if(r===void 0)return;const s=lr[r];for(let o=0;o<a;o++){const l=Ai(n)/48;switch(s){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":t.push({type:s,beat:l,value:Ri(n)});break;case"FAKES":case"WARPS":t.push({type:s,beat:l,value:Ai(n)/48});break;case"TIMESIGNATURES":t.push({type:s,beat:l,upper:Ai(n),lower:Ai(n)});break;case"COMBOS":t.push({type:s,beat:l,hitMult:Ai(n),missMult:Ai(n)});break;case"TICKCOUNTS":t.push({type:s,beat:l,value:Ai(n)});break;case"SPEEDS":t.push({type:s,beat:l,value:Ri(n),delay:Ri(n),unit:Ai(n)==1?"T":"B"});break;case"LABELS":t.push({type:s,beat:l,value:Qm(n)})}}}}catch{return}return t}function ag(i){if(!i.startsWith("SMEditor:tempo:"))return;const e=Fo(i.slice(15)),t=[];if(e===!1)return;const n=Array.from(e);try{for(;;){const a=qt(n);if(a===void 0)return;if(a==0)break;const r=n.shift();if(r===void 0)return;const s=lr[r];for(let o=0;o<a;o++){const l=qt(n)/1e3;switch(s){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":case"FAKES":case"WARPS":t.push({type:s,beat:l,value:Ri(n)});break;case"TIMESIGNATURES":t.push({type:s,beat:l,upper:qt(n),lower:qt(n)});break;case"COMBOS":t.push({type:s,beat:l,hitMult:qt(n),missMult:qt(n)});break;case"TICKCOUNTS":t.push({type:s,beat:l,value:qt(n)});break;case"SPEEDS":t.push({type:s,beat:l,value:Ri(n),delay:Ri(n),unit:n.shift()==0?"B":"T"});break;case"LABELS":t.push({type:s,beat:l,value:Si(n)});break;case"ATTACKS":t.push({type:s,second:l,value:Ri(n),endType:n.shift()==0?"LEN":"END",mods:Si(n)});break;case"BGCHANGES":case"FGCHANGES":{const u=n.shift();t.push({type:s,beat:l,file:Si(n),updateRate:Ri(n),crossFade:(u&1)>0,stretchRewind:(u&2)>0,stretchNoLoop:(u&4)>0,effect:Si(n),file2:Si(n),transition:Si(n),color1:Si(n),color2:Si(n)})}}}}}catch{return}return t}let rg=class nd extends AudioBufferSourceNode{started=!1;start(e,t,n){this.started||super.start(e,t,n),this.started=!0}stop(e){this.started&&super.stop(e),this.started=!1}static create(e){const t=e;return t.started=!1,Object.setPrototypeOf(t,nd.prototype),t}};class Ds{_gainNode;_audioContext=new AudioContext;_sources=[];_rate=1;_buffer;_volume=1;_destroyed=!1;loaded;constructor(e){this._gainNode=this._audioContext.createGain(),this._gainNode.connect(this._audioContext.destination),e.volume!==void 0&&this.volume(e.volume),e.rate!==void 0&&this.rate(e.rate),this._buffer=this._audioContext.createBuffer(2,1,44100),this.loaded=new Promise(t=>{fetch(e.src).then(n=>n.arrayBuffer()).then(n=>this.decodeData(n)).then(n=>{n&&(this._buffer=n)}).catch(n=>{ce.createFormatted("Failed to load sound effect: "+n.message,"error")}).finally(()=>{t()})})}destroy(){this._destroyed||(this.stop(),this._buffer=this._audioContext.createBuffer(2,1,44100),this._destroyed=!0)}async decodeData(e){return new Promise((t,n)=>{if(!e){t();return}(async()=>{try{t(await this._audioContext.decodeAudioData(e))}catch(a){n(a)}})()})}volume(e){this._destroyed||this._volume!=e&&(this._volume=e,this._gainNode.gain.setValueAtTime(e,this._audioContext.currentTime))}rate(e){if(!this._destroyed&&this._rate!=e){this._rate=e;for(const t of this._sources)t.playbackRate.value=e}}play(e){if(this._destroyed)return;const t=rg.create(this._audioContext.createBufferSource());t.buffer=this._buffer,t.connect(this._gainNode),this._gainNode.connect(this._audioContext.destination),t.start(e+this._audioContext.currentTime,0),t.playbackRate.value=this._rate,this._sources.push(t),t.onended=()=>{t.disconnect(),this._sources=this._sources.filter(n=>n!=t)}}stop(){if(!this._destroyed){for(const e of this._sources)e.stop(),e.disconnect();this._sources=[]}}getBuffer(){return this._buffer}}class Qs{static menuElement;static closeTimeout;static open(e,t){e.chartManager.getMode()!=W.View&&(this.buildMenu(e),this.menuElement.style.display="none",setTimeout(()=>this.fitContextMenu(t)),this.menuElement.classList.add("entering"),clearTimeout(this.closeTimeout),setTimeout(()=>this.menuElement?.classList.remove("entering"),300),this.menuElement.style.left=t.clientX+"px",this.menuElement.style.top=t.clientY+"px")}static fitContextMenu(e){this.menuElement.style.display="";const t=this.menuElement.getBoundingClientRect(),n=window.innerHeight-t.bottom-20,a=window.innerWidth-t.right-20;n<0&&(this.menuElement.style.top=e.clientY+n+"px"),a<0&&(this.menuElement.style.left=e.clientX+a+"px"),this.menuElement.style.transformOrigin=`${Math.max(0,-a)}px ${Math.max(0,-n)}px`}static close(){this.menuElement&&(this.menuElement.classList.add("exiting"),this.closeTimeout=setTimeout(()=>this.menuElement.replaceChildren(),300))}static buildMenu(e){const t=document.createElement("div");if(t.appendChild(this.createElement(e,{type:"selection",id:"cut"})),t.appendChild(this.createElement(e,{type:"selection",id:"copy"})),t.appendChild(this.createElement(e,{type:"selection",id:"paste"})),t.appendChild(this.createElement(e,{type:"selection",id:"pasteReplace"})),e.chartManager.getMode()==W.Edit&&e.chartManager.hasNoteSelection()){const n=document.createElement("div");n.classList.add("separator"),t.appendChild(n),bn.selection.options.slice(0,-4).forEach(a=>{t.appendChild(this.createElement(e,a))})}this.menuElement=t,t.id="context-menu",document.getElementById("context-menu")?.replaceWith(this.menuElement)}static createElement(e,t){if(t.type=="separator"){const n=document.createElement("div");return n.classList.add("separator"),n}if(t.type=="selection"||t.type=="checkbox"||t.type=="dropdown"){const n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div");let s;if(t.type=="selection"||t.type=="checkbox"){const o=$e[t.id];s=document.createElement("div"),s.innerText=Ae.getKeybindString(t.id),s.classList.add("keybind","unselectable"),r.innerText=o?.label??t.id;let l=o?.disabled??!0;typeof l=="function"&&(l=l(e)),l&&n.classList.add("disabled"),n.addEventListener("click",()=>{l||(o?.callback(e),this.close())})}else s=be.getIcon("CHEVRON",16),s.style.transform="rotate(-90deg)",r.innerText=typeof t.title=="function"?t.title(e):t.title;if(a.appendChild(r),a.appendChild(s),n.appendChild(a),n.classList.add("menu-item"),a.classList.add("menu-item-title","menu-hover"),r.classList.add("title","unselectable"),t.type=="dropdown"){const o=document.createElement("div");n.appendChild(o),o.classList.add("menubar-dropdown"),t.options.map(l=>this.createElement(e,l)).forEach(l=>o.appendChild(l))}if(t.type=="checkbox"){let o=t.checked;typeof o=="function"&&(o=o(e)),o&&(r.innerText="✓ "+r.innerText)}return n}if(t.type=="menu"){const n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div");return n.appendChild(a),a.innerText=t.title,n.appendChild(r),a.classList.add("title","unselectable"),n.classList.add("menu-item","menu-main"),a.classList.add("menu-hover"),r.classList.add("menubar-dropdown","unselectable"),n.onmouseenter=()=>{r.replaceChildren(...t.options.map(s=>this.createElement(e,s)))},n.onmouseleave=()=>{r.replaceChildren()},n}return document.createElement("div")}}const sg={fontName:"Main",fontSize:20,fill:["#ffffff"]};class og extends de{isEditGUI=!0;renderer;barlineMap=new Map;barlineLabelMap=new Map;barlinePool=new Ot({create:()=>{const e=new ye(xe.WHITE);return ze(e,"text-color"),e}});barlineLabelPool=new Ot({create:()=>{const e=new ge("",sg);return ze(e,"text-color"),e}});constructor(e){super(),this.renderer=e;const t=()=>{this.barlineMap.clear(),this.barlineLabelMap.clear(),this.barlinePool.destroyAll(),this.barlineLabelPool.destroyAll()};ie.on("timeSigChanged",t),this.on("destroyed",()=>ie.off("timeSigChanged",t)),this.addChild(this.barlinePool,this.barlineLabelPool)}update(e,t){for(const[n,a]of this.renderer.chart.timingData.getMeasureBeats(e,t)){if(!this.barlineMap.has(n)){const r=this.barlinePool.createChild();if(!r)continue;Object.assign(r,{width:this.renderer.chart.gameType.notefieldWidth+128,height:a?4:1,visible:!0}),r.anchor.set(.5),this.barlineMap.set(n,r)}if(a&&!this.barlineLabelMap.has(n)){const r=this.barlineLabelPool.createChild();if(!r)continue;Object.assign(r,{x:(this.renderer.chart.gameType.notefieldWidth+128)/-2-16,text:`${Math.round(this.renderer.chart.timingData.getMeasure(n))}`,visible:!0}),r.anchor.set(1,.5),this.barlineLabelMap.set(n,r)}}for(const[n,a]of this.barlineMap.entries()){if(n<e||n>t){this.barlineMap.delete(n),this.barlinePool.destroyChild(a);continue}a.y=this.renderer.getYPosFromBeat(n)}for(const[n,a]of this.barlineLabelMap.entries()){if(n<e||n>t){this.barlineLabelMap.delete(n),this.barlineLabelPool.destroyChild(a);continue}a.y=this.renderer.getYPosFromBeat(n)}}}class Gi extends Ui{static box;static open(e,t){this.active||(this.box=e,super._open({attach:e,title:"Candle",description:`The ${t==me.LEFT_HEEL?"left":"right"} foot is used to vertically cross the center panel.`,width:150,editable:!1,cancelableOnOpen:!1,background:It(new B(ii[t]),new B("black"),.8).toHex(),textColor:"#ffffff",options:[]}))}static close(){this.active&&(super.close(),this.box=void 0)}}class Yt{static instance;renderer;rows=new Map;objectMap=new Map;constructor(e){this.renderer=e,Yt.instance=this}register(e,t,n,a,r,s=!1){const o=Math.round(t*48)+":"+n.toFixed(3);this.rows.has(o)||this.rows.set(o,{left:{items:[]},right:{items:[]}});const l=this.rows.get(o);a==="left"?(l.left.items.push({object:e,priority:r,x:s?0:null,beat:t,second:n,registerTime:s?void 0:Date.now()}),l.left.items.sort((u,f)=>u.priority-f.priority)):(l.right.items.push({object:e,priority:r,x:s?0:null,beat:t,second:n,registerTime:s?void 0:Date.now()}),l.right.items.sort((u,f)=>u.priority-f.priority)),this.objectMap.set(e,{key:o,align:a}),e.on("destroyed",()=>{this.deregister(e)}),e.on("removed",()=>{this.deregister(e)}),this.updateX(o)}deregister(e){const t=this.objectMap.get(e);if(!t?.key)return;rt.stop(t.animationId),this.objectMap.delete(e);const n=this.rows.get(t.key);n&&(n.left.items=n.left.items.filter(a=>a.object!=e),n.right.items=n.right.items.filter(a=>a.object!=e),this.updateX(t.key))}updatePriority(e,t){const n=this.objectMap.get(e);if(!n?.key)return;const a=this.rows.get(n.key);if(a){for(const r of[a.left,a.right]){for(const s of r.items)if(s.object==e){if(s.priority==t)return;s.priority=t}r.items.sort((s,o)=>s.priority-o.priority)}this.updateX(n.key)}}updateAlign(e,t){const n=this.objectMap.get(e);if(!n?.key||n.align==t)return;const a=this.rows.get(n.key);if(a)for(const r of[a.left,a.right]){const s=r.items.findIndex(l=>l.object==e);if(s==-1)continue;const o=r.items.splice(s,1)[0];t=="left"?(a.left.items.push(o),a.left.items.sort((l,u)=>l.priority-u.priority)):(a.right.items.push(o),a.right.items.sort((l,u)=>l.priority-u.priority)),this.updateX(n.key)}}updateX(e){const t=this.rows.get(e);if(!t)return;let n=-this.renderer.chart.gameType.notefieldWidth*.5-80-30;for(const a of t.left.items)a.object.x!=n&&a.x!=null&&(a.registerTime===void 0||Date.now()-a.registerTime>100)?this.objectMap.get(a.object).animationId=rt.animate(a.object,{0:{x:"inherit","pivot.x":"inherit"},1:{x:n,"pivot.x":a.object.width/2}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},this.objectMap.get(a.object)?.animationId):(a.object.x=n,a.object.pivot.x=a.object.width/2),a.x=n,n-=a.object.width+5;n=this.renderer.chart.gameType.notefieldWidth*.5+80;for(const a of t.right.items)a.object.x!=n&&a.x!=null&&(a.registerTime===void 0||Date.now()-a.registerTime>100)?this.objectMap.get(a.object).animationId=rt.animate(a.object,{0:{x:"inherit","pivot.x":"inherit"},1:{x:n,"pivot.x":-a.object.width/2}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},this.objectMap.get(a.object)?.animationId):(a.object.x=n,a.object.pivot.x=-a.object.width/2),a.x=n,n+=a.object.width+5}update(){for(const[e,t]of this.rows.entries()){let n=!1;for(const a of t.left.items)a.width!=a.object.width&&(a.width=a.object.width,n||this.updateX(e),n=!0),a.object.y=b.chart.CMod?this.renderer.getYPosFromSecond(a.second):this.renderer.getYPosFromBeat(a.beat);for(const a of t.right.items)a.width!=a.object.width&&(a.width=a.object.width,n||this.updateX(e),n=!0),a.object.y=b.chart.CMod?this.renderer.getYPosFromSecond(a.second):this.renderer.getYPosFromBeat(a.beat)}}}class lg extends de{isEditGUI=!0;renderer;parityDirty=!1;boxPool=new Ot({create:()=>this.createBox()});highlightPool=new Ot({create:()=>{const e=new ye(xe.WHITE);return e.height=16,e.alpha=.6,e.anchor.set(.5,.5),e}});rowMap=new Map;constructor(e){super(),this.renderer=e,this.addChild(this.highlightPool),this.addChild(this.boxPool);const t=()=>{Gi.close(),this.parityDirty=!0};ie.on("parityModified",t),this.on("destroyed",()=>{ie.off("parityModified",t)})}update(e,t){const n=this.renderer.chart.stats.parity;if(!n||!b.chart.parity.enabled||!b.chart.parity.showCandles){this.visible=!1;return}this.visible=!0,this.parityDirty&&(this.rowMap.clear(),this.boxPool.destroyAll(),this.highlightPool.destroyAll(),this.parityDirty=!1);for(const a of n.candles.keys()){const r=n.rowTimestamps[a];if(!(t<r.beat)&&!(e>r.beat)&&!this.rowMap.has(a)){const s=n.candles.get(a),o=this.boxPool.createChild(),l=this.highlightPool.createChild();if(!o||!l)break;Yt.instance.register(o,r.beat,r.second,"left",30),o.textObj.text=(s==me.LEFT_HEEL,"C");const u=It(new B(ii[s]),new B("black"),.5);o.bg.tint=u,o.on("mouseenter",()=>{this.renderer.isDragSelecting()||(Gi.active&&Gi.close(),this.renderer.chartManager.getMode()==W.Edit&&Gi.open(o,s))}),o.on("mouseleave",()=>{Gi.close()}),o.eventMode="static",l.width=this.renderer.chart.gameType.notefieldWidth+80,l.tint=u,this.rowMap.set(a,{box:o,highlight:l})}}for(const[a,r]of this.rowMap.entries()){const s=n.rowTimestamps[a];if(!s)continue;if(s.beat<e||s.beat>t){this.rowMap.delete(a),this.boxPool.destroyChild(r.box),this.highlightPool.destroyChild(r.highlight),Gi.box==r.box&&Gi.close();continue}const o=this.renderer.getYPosFromBeat(s.beat);r.highlight.y=o}}createBox(){const e=new de;e.textObj=new ge("",{fontName:"Fancy",fontSize:15});const t=new lt("noBorder");return e.bg=t,e.addChild(t,e.textObj),e.textObj.anchor.set(.5,.55),e.bg.width=e.textObj.width+18,e.bg.height=25,e.bg.position.x=-e.bg.width/2,e.bg.position.y=-25/2,e}}class cg extends de{isEditGUI=!0;previewArea=new ye(xe.WHITE);previewText=new ge("SONG PREVIEW",{fontName:"Main",fontSize:13});renderer;constructor(e){super(),this.renderer=e,Object.assign(this.previewArea,{alpha:.2,tint:11052482,width:this.renderer.chart.gameType.notefieldWidth+96,height:64}),this.previewText.x=-this.previewArea.width/2+5,this.previewArea.anchor.x=.5,ze(this.previewText,"text-color"),this.addChild(this.previewArea,this.previewText)}update(e,t){const n=Number(this.renderer.chart.sm.properties.SAMPLESTART),a=Number(this.renderer.chart.sm.properties.SAMPLELENGTH);if(Number.isNaN(n)||Number.isNaN(a)||this.renderer.chart.timingData.getBeatFromSeconds(n+a)<e||this.renderer.chart.timingData.getBeatFromSeconds(n)>t){this.visible=!1;return}this.visible=!0;let r=this.renderer.getYPosFromSecond(n),s=this.renderer.getYPosFromSecond(n+a);s<r&&([s,r]=[r,s]),this.previewArea.y=r,this.previewArea.height=s-r,this.previewText.anchor.y=b.chart.reverse?1:0,b.chart.reverse?this.previewText.y=Te(this.renderer.getUpperBound()-35,this.previewArea.y+15,this.previewArea.y+this.previewArea.height-5):this.previewText.y=Te(this.renderer.getUpperBound()+35,this.previewArea.y+5,this.previewArea.y+this.previewArea.height-15)}}class ug extends de{isEditGUI=!1;renderer;scrollMap=new Map;receptors;topBound;bottomBound;topBoundBeat;bottomBoundBeat;topScreenBeat;bottomScreenBeat;topScreenBeatText;bottomScreenBeatText;children=[];constructor(e){super(),this.visible=!1,this.renderer=e,this.receptors=this.createBar(7829503),this.receptors.width=300,this.addChild(this.receptors),this.topBound=this.createBar(16711680),this.addChild(this.topBound),this.bottomBound=this.createBar(16711680),this.addChild(this.bottomBound),this.topBoundBeat=this.createBar(16777096),this.addChild(this.topBoundBeat),this.bottomBoundBeat=this.createBar(8978431),this.addChild(this.bottomBoundBeat),this.topScreenBeat=this.createBar(16746751),this.topScreenBeat.width=300,this.addChild(this.topScreenBeat),this.topScreenBeatText=new ge("",{fontName:"Fancy",fontSize:50}),this.topScreenBeatText.anchor.x=.5,this.topScreenBeatText.anchor.y=.5,this.topScreenBeatText.tint=16746751,this.addChild(this.topScreenBeatText),this.bottomScreenBeat=this.createBar(16724991),this.bottomScreenBeat.width=300,this.addChild(this.bottomScreenBeat),this.bottomScreenBeatText=new ge("",{fontName:"Fancy",fontSize:50}),this.bottomScreenBeatText.anchor.x=.5,this.bottomScreenBeatText.anchor.y=.5,this.bottomScreenBeatText.tint=16724991,this.addChild(this.bottomScreenBeatText),this.scale.x=.4,this.scale.y=.4}createBar(e){const t=new ye(xe.WHITE);return Object.assign(t,{width:750,height:15,tint:e,opacity:.5}),t.anchor.set(.5),t}update(){if(this.visible=b.debug.showScroll,!this.visible)return;const e=this.renderer.chart.timingData.getTimingData("SCROLLS");this.x=this.renderer.chartManager.app.STAGE_WIDTH/4;for(const r of this.scrollMap.values())r.marked=!1;for(const r of e){if(r==e.at(-1))continue;if(this.scrollMap.has(r)){this.scrollMap.get(r).marked=!0;continue}const s=new de,o=new ye(xe.WHITE),l=new ge("",{fontName:"Main",fontSize:25});o.alpha=.2,o.width=150,o.anchor.x=.5,l.anchor.x=.5,s.text=l,s.marked=!0,s.box=o,this.scrollMap.set(r,s),s.addChild(o,l),this.addChild(s)}const t=this.renderer.chartManager.beat;for(let r=0;r<e.length-1;r++){let s=this.renderer.getYPosFromBeat(e[r].beat),o=this.renderer.getYPosFromBeat(e[r+1].beat);const l=this.scrollMap.get(e[r]);if(!this.inBounds(o)&&!this.inBounds(s)&&s*o>=0){l.visible=!1;continue}if(Math.abs(e[r].beat-t)>20&&Math.abs(e[r+1].beat-t)>20&&!(t>e[r].beat&&t<e[r+1].beat)){l.visible=!1;continue}l.text.text=`yStart:${he(s,1)}
yEnd:${he(o,1)}
val:${e[r].value}
h:${he(o-s,1)}`,o<s&&([s,o]=[o,s]),l.visible=!0,l.y=s,l.box.height=o-s,l.box.tint=16777215,l.text.tint=16777215,t>e[r].beat&&t<e[r+1].beat&&(l.text.y=Math.max(this.renderer.getActualReceptorYPos()-s,0),l.box.tint=8978312),t<e[r].beat&&(l.text.y=0),t>e[r+1].beat&&(l.text.y=l.box.height),l.x=(r%4-1.5)*150}for(const[r,s]of this.scrollMap.entries())if(!s.marked){this.scrollMap.delete(r),s.destroy();continue}const n=this.renderer.findFirstOnScreenScroll(),a=this.renderer.findLastOnScreenScroll();{const r=this.scrollMap.get(n);r&&(r.text.text+=`
start`,r.box.tint==16777215&&(r.box.tint=16777096),r.text.tint=16777096)}{const r=this.scrollMap.get(a);r&&(r.text.text+=`
end`,r.box.tint==16777215&&(r.box.tint=8978431),r.text.tint=8978431)}this.receptors.y=this.renderer.getActualReceptorYPos(),this.topBound.y=this.renderer.getUpperBound(),this.bottomBound.y=this.renderer.getLowerBound(),this.topBoundBeat.y=this.renderer.getYPosFromBeat(this.renderer.getVisualBeat()-b.chart.maxDrawBeatsBack),this.bottomBoundBeat.y=this.renderer.getYPosFromBeat(this.renderer.getVisualBeat()+b.chart.maxDrawBeats),this.topScreenBeat.y=this.renderer.getYPosFromBeat(this.renderer.getTopOnScreenBeat()),this.bottomScreenBeat.y=this.renderer.getYPosFromBeat(this.renderer.getBottomOnScreenBeat()),this.topScreenBeatText.y=this.topScreenBeat.y,this.topScreenBeatText.text=he(this.renderer.getTopOnScreenBeat(),3)+"",this.bottomScreenBeatText.y=this.bottomScreenBeat.y,this.bottomScreenBeatText.text=he(this.renderer.getBottomOnScreenBeat(),3)+""}inBounds(e){const t=this.renderer.chartManager.app.STAGE_HEIGHT/this.scale.y;return Math.abs(e)<t}}class dg extends de{isEditGUI=!0;startMarker=new ye(xe.WHITE);selectionArea=new ye(xe.WHITE);renderer;constructor(e){super(),this.renderer=e,Object.assign(this.startMarker,{alpha:0,width:this.renderer.chart.gameType.notefieldWidth,height:64}),Object.assign(this.selectionArea,{alpha:0,tint:5140387,width:this.renderer.chart.gameType.notefieldWidth,height:64}),this.startMarker.anchor.set(.5),this.selectionArea.anchor.x=.5,this.addChild(this.selectionArea,this.startMarker)}update(){if(this.renderer.chartManager.getMode()==W.Play||this.renderer.chartManager.app.capturing){this.visible=!1;return}this.visible=!0;const e=this.renderer.chartManager.startRegion,t=this.renderer.chartManager.endRegion;e!==void 0&&t===void 0?(this.startMarker.alpha=Math.sin(Date.now()/320)*.1+.3,this.startMarker.y=this.renderer.getYPosFromBeat(e)):this.startMarker.alpha=0,e!==void 0&&t!==void 0?(this.selectionArea.alpha=Math.sin(Date.now()/320)*.1+.3,this.selectionArea.y=this.renderer.getYPosFromBeat(Math.min(e,t)),this.selectionArea.height=this.renderer.getYPosFromBeat(Math.max(e,t))-this.selectionArea.y):this.selectionArea.alpha=0}}class hg extends ye{isEditGUI=!0;renderer;constructor(e){super(xe.WHITE),this.renderer=e,this.visible=!1,this.alpha=.2,this.eventMode="none"}update(){const e=this.renderer.getSelectionBounds();if(this.visible=!!e,e){const t=this.renderer.getYPosFromBeat(e?.startBeat),n=this.renderer.getYPosFromBeat(e?.endBeat);this.position.x=Math.min(e.startX,e.endX),this.position.y=Math.min(t,n),this.width=Math.abs(e.endX-e.startX),this.height=Math.abs(n-t)}}}class Bt extends Ui{static options;static cachedError;static editText;static onParityChange;static open(e){if(this.active)return;this.cachedError={beat:e.beat,error:e.error};const t=e.chart.isErrorIgnored(this.cachedError.error,this.cachedError.beat);super._open({...e,attach:e.box,title:Ho[e.error].title,description:Ho[e.error].description,width:150,editable:!1,cancelableOnOpen:!1,background:t?"#404040":"#41031c",textColor:"#ffffff",options:[]}),this.onParityChange=this.updateValues.bind(this),ie.on("parityIgnoresModified",this.onParityChange),ie.on("parityModified",this.onParityChange),this.updateValues()}static buildContent(){const e=document.createElement("div");e.innerText="click to ignore",e.style.marginTop="4px",e.style.height="10px",e.classList.add("popup-desc"),this.editText=e,this.view.appendChild(e)}static updateValues(){if(!this.active||!this.cachedError)return;const e=this.options.chart.isErrorIgnored(this.cachedError.error,this.cachedError.beat);this.editText.innerText=e?"click to unignore":"click to ignore",this.view.style.backgroundColor=e?"#404040":"#41031c"}static close(){this.active&&(super.close(),ie.off("parityIgnoresModified",this.onParityChange),ie.off("parityModified",this.onParityChange),this.cachedError=void 0)}static getError(){return this.cachedError}}class fg extends de{isEditGUI=!0;renderer;parityDirty=!1;errorIconTexture;errorIconIgnoredTexture;boxPool=new Ot({create:()=>this.createErrorBox()});highlightPool=new Ot({create:()=>{const e=new ye(xe.WHITE);return e.height=16,e.alpha=.6,e.anchor.set(.5,.5),e}});reposition=!1;topCounter;bottomCounter;previousTopVisible=!1;previousBottomVisible=!1;rowMap=new Map;children=[];constructor(e){super(),this.renderer=e,this.addChild(this.highlightPool),this.addChild(this.boxPool);const t=()=>{this.parityDirty=!0},n=c=>{(c=="chart.zoom"||c=="chart.reverse"||c=="general.uiScale")&&(this.reposition=!0)};ie.on("parityModified",t),ie.on("parityIgnoresModified",t),ie.on("userOptionUpdated",n),this.on("destroyed",()=>{ie.off("parityModified",t),ie.off("parityIgnoresModified",t),ie.off("userOptionUpdated",n)});const a=new Hi;a.beginFill(11341390),a.drawCircle(0,0,12),a.endFill(),a.lineStyle(.5,0),a.drawCircle(0,0,12),a.lineStyle(.5,16777215),a.drawCircle(0,0,10);const r=new ge("!",{fontName:"Fancy",fontSize:15});r.anchor.set(.5,.5),r.y-=2,r.x+=.3;const s=new de;s.addChild(a,r),s.x=16,s.y=16,this.errorIconTexture=Jt.create({resolution:b.performance.resolution,width:32,height:32}),this.renderer.chartManager.app.renderer.render(s,{renderTexture:this.errorIconTexture}),a.clear(),a.beginFill(4473924),a.drawCircle(0,0,12),a.endFill(),a.lineStyle(.5,0),a.drawCircle(0,0,12),a.lineStyle(.5,16777215),a.drawCircle(0,0,10),this.errorIconIgnoredTexture=Jt.create({resolution:b.performance.resolution,width:32,height:32}),this.renderer.chartManager.app.renderer.render(s,{renderTexture:this.errorIconIgnoredTexture}),this.topCounter=this.createErrorBox(),this.bottomCounter=this.createErrorBox();const o=new Hi;o.beginFill(16777215),o.moveTo(6,0),o.lineTo(0,-6),o.lineTo(-6,0),o.endFill(),o.y=-15,this.topCounter.addChild(o);const l=this.topCounter.setText.bind(this.topCounter);this.topCounter.setText=c=>{l(c),o.x=-this.topCounter.textObj.width/2+16};const u=new Hi;u.beginFill(16777215),u.moveTo(6,0),u.lineTo(0,6),u.lineTo(-6,0),u.endFill(),this.bottomCounter.addChild(u),u.y=15;const f=this.bottomCounter.setText.bind(this.bottomCounter);this.bottomCounter.setText=c=>{f(c),u.x=-this.bottomCounter.textObj.width/2+16},this.topCounter.y=b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT/2+50:-this.renderer.chartManager.app.STAGE_HEIGHT/2-50,this.topCounter.y/=b.chart.zoom,this.bottomCounter.y=b.chart.reverse?-this.renderer.chartManager.app.STAGE_HEIGHT/2-50:this.renderer.chartManager.app.STAGE_HEIGHT/2+50,this.bottomCounter.y/=b.chart.zoom,this.addChild(this.topCounter,this.bottomCounter),this.topCounter.on("pointerover",()=>{rt.animate(this.topCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.4,y:1.4}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},"te-top-hover")}),this.topCounter.on("pointerout",()=>{rt.animate(this.topCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.25,y:1.25}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},"te-top-hover")}),this.topCounter.on("pointerdown",c=>{if(!this.renderer.chart.stats.parity)return;const d=this.renderer.chart.getTechErrors(c.shiftKey).map(p=>p.beat),h=ka(d,this.renderer.chartManager.beat);h!==null&&(c.stopImmediatePropagation(),this.renderer.chartManager.beat=h)}),this.topCounter.eventMode="static",this.topCounter.cursor="pointer",this.bottomCounter.on("pointerover",()=>{rt.animate(this.bottomCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.4,y:1.4}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},"te-bottom-hover")}),this.bottomCounter.on("pointerout",()=>{rt.animate(this.bottomCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.25,y:1.25}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},"te-bottom-hover")}),this.bottomCounter.on("pointerdown",c=>{if(!this.renderer.chart.stats.parity)return;const d=this.renderer.chart.getTechErrors(c.shiftKey).map(p=>p.beat),h=Aa(d,this.renderer.chartManager.beat);h!==null&&(c.stopImmediatePropagation(),this.renderer.chartManager.beat=h)}),this.bottomCounter.eventMode="static",this.bottomCounter.cursor="pointer",this.topCounter.scale.set(1.25),this.bottomCounter.scale.set(1.25)}update(e,t){const n=this.renderer.chart.stats.parity,a=this.renderer.chart;if(!n||!b.chart.parity.enabled||!b.chart.parity.showErrors){this.visible=!1;return}this.visible=!0,this.parityDirty&&(this.rowMap.clear(),this.boxPool.destroyAll(),this.highlightPool.destroyAll(),this.parityDirty=!1);let r=0,s=0;for(const o of n.techErrors.keys()){const l=n.rowTimestamps[o];if(t<l.beat){a.getTechErrorsAtRow(o).size!=0&&(s+=a.getTechErrorsAtRow(o).size);continue}if(e>l.beat){a.getTechErrorsAtRow(o).size!=0&&(r+=a.getTechErrorsAtRow(o).size);continue}if(!this.rowMap.has(o)){const u=n.techErrors.get(o).values().toArray().sort(),f=[],c=this.highlightPool.createChild();if(!c)break;c.width=this.renderer.chart.gameType.notefieldWidth+80,c.tint=11341390;for(const d of u){const h=this.boxPool.createChild();if(!h)break;Yt.instance.register(h,l.beat,l.second,"left",40+d),f.push(h),h.setText(Uc[d]),a.isErrorIgnored(d,l.beat)?h.ignore():h.unignore(),Bt.getError()?.beat==l.beat&&Bt.getError()?.error==d&&Bt.attach(h),h.cursor="pointer",h.on("mouseenter",()=>{this.renderer.isDragSelecting()||Bt.getError()?.beat==l.beat&&Bt.getError()?.error==d||(Bt.active&&Bt.close(),this.renderer.chartManager.getMode()==W.Edit&&Bt.open({box:h,beat:l.beat,error:d,ignored:!1,chart:a}))}),h.on("mouseleave",()=>{Bt.getError()?.beat!=l.beat||Bt.getError()?.error!=d||Bt.close()}),h.on("pointerdown",p=>{qa(p)||(p.stopImmediatePropagation(),a.isErrorIgnored(d,l.beat)?a.deleteErrorIgnore(d,l.beat):a.addErrorIgnore(d,l.beat))}),h.eventMode="static"}this.rowMap.set(o,{boxes:f,highlight:c})}}for(const[o,{boxes:l,highlight:u}]of this.rowMap.entries()){const f=n.rowTimestamps[o];if(!f)continue;if(f.beat<e||f.beat>t){this.rowMap.delete(o),l.forEach(d=>{this.boxPool.destroyChild(d)}),Bt.getError()?.beat==f.beat&&Bt.close(),this.highlightPool.destroyChild(u);continue}const c=this.renderer.getYPosFromBeat(f.beat);u.y=c,u.visible=a.getTechErrorsAtRow(o).size!=0}if(this.topCounter.setText(r+""),this.bottomCounter.setText(s+""),this.previousTopVisible!=r>0||this.reposition){this.previousTopVisible=r>0;let o=b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT/2-40:-this.renderer.chartManager.app.STAGE_HEIGHT/2+40;r==0&&(b.chart.reverse?o+=90:o-=90),rt.animate(this.topCounter,{0:{y:"inherit"},1:{y:o/b.chart.zoom}},b.general.smoothAnimations&&!this.reposition?.3:0,pt(0,0,.16,1.01),()=>{},"te-top-counter")}if(this.previousBottomVisible!=s>0||this.reposition){this.previousBottomVisible=s>0;let o=b.chart.reverse?-this.renderer.chartManager.app.STAGE_HEIGHT/2+40:this.renderer.chartManager.app.STAGE_HEIGHT/2-40;s==0&&(b.chart.reverse?o-=90:o+=90),rt.animate(this.bottomCounter,{0:{y:"inherit"},1:{y:o/b.chart.zoom}},b.general.smoothAnimations&&!this.reposition?.3:0,pt(0,0,.16,1.01),()=>{},"te-bottom-counter")}this.topCounter.x=-this.renderer.chart.gameType.notefieldWidth/2-160,this.bottomCounter.x=-this.renderer.chart.gameType.notefieldWidth/2-160,this.reposition=!1}createErrorBox(){const e=new de;e.textObj=new ge("",{fontName:"Main",fontSize:15});const t=new ye(this.errorIconTexture);t.anchor.y=.5,t.anchor.x=.5,e.icon=t;const n=new lt("noBorder");n.tint=11341390,e.bg=n,e.addChild(n,e.textObj,t);let a="-";const r=l=>{l!==a&&(a=l,e.textObj.text=l,e.textObj.anchor.set(.5,.55),e.textObj.x=13,e.bg.width=e.textObj.width+17,e.bg.height=20,e.bg.position.x=-e.bg.width/2+8,e.bg.position.y=-20/2,e.icon.position.x=-e.bg.width/2-2+8)};e.setText=r,r("");const s=()=>{n.tint=4473924,e.textObj.alpha=.5,t.texture=this.errorIconIgnoredTexture},o=()=>{n.tint=11341390,e.textObj.alpha=1,t.texture=this.errorIconTexture};return e.ignore=s,e.unignore=o,e}}class dn extends Ui{static box;static open(e,t){this.active||(this.box=e,super._open({attach:e,title:zo[t].title,description:zo[t].description,width:150,editable:!1,cancelableOnOpen:!1,background:"#404040",textColor:"#ffffff",options:[]}))}static close(){this.active&&(super.close(),this.box=void 0)}}class pg extends de{isEditGUI=!0;renderer;parityDirty=!1;boxPool=new Ot({create:()=>{const e=new de;return e.textObj=new ge("",{fontName:"Main",fontSize:20}),e.addChild(e.textObj),e}});rowMap=new Map;children=[];constructor(e){super(),this.renderer=e,this.addChild(this.boxPool);const t=()=>{this.parityDirty=!0};ie.on("parityModified",t),this.on("destroyed",()=>ie.off("parityModified",t))}update(e,t){const n=this.renderer.chart.stats.parity;if(!n||!b.chart.parity.enabled||!b.chart.parity.showTech){this.visible=!1;return}this.visible=!0,this.parityDirty&&(this.rowMap.clear(),this.boxPool.destroyAll(),this.parityDirty=!1);for(let a=0;a<n.techRows.length;a++){const r=n.rowTimestamps[a];if(n.techRows[a]!==void 0){if(t<r.beat)break;if(!(e>r.beat)&&!this.rowMap.has(a)){const s=n.techRows[a].values().toArray().sort(),o=[];for(const l of s){const u=this.boxPool.createChild();if(!u)break;Yt.instance.register(u,r.beat,r.second,"right",20+l),o.push(u),u.textObj.text=Nc[l],u.textObj.anchor.set(.5,.55),u.on("mouseenter",()=>{this.renderer.isDragSelecting()||(dn.active&&dn.close(),this.renderer.chartManager.getMode()==W.Edit&&dn.open(u,l))}),u.on("mouseleave",()=>{dn.close()}),u.eventMode="static"}this.rowMap.set(a,o)}}}for(const[a,r]of this.rowMap.entries()){const s=n.rowTimestamps[a];if(s&&(s.beat<e||s.beat>t)){this.rowMap.delete(a),r.forEach(o=>{this.boxPool.destroyChild(o),dn.box==o&&dn.close()});continue}}}}const mg=3500;class gg extends ye{isEditGUI=!0;lineContainer=new Ya(1500,{position:!0,scale:!0,tint:!0,alpha:!0},16384,!0);waveformTex;renderer;rawData=[];filteredRawData=[];speed;lastSpeed;lastSpeedTimeout;sampleRate=44100;poolSearch=0;trackedVariables=new Map;drawDirty=!0;blockCache=new Map;colorCache=new B("black");filteredColorCache=new B("black");constructor(e){super(),this.renderer=e,this.waveformTex=Jt.create({resolution:Math.min(1,b.performance.resolution)}),this.texture=this.waveformTex,this.speed=this.getSpeed(),this.lastSpeed=this.getSpeed(),this.trackVariable(()=>this.renderer.getVisualBeat()),this.trackVariable(()=>this.renderer.getVisualTime()),this.trackVariable(()=>b.chart.speed),this.trackVariable(()=>this.getSpeed(),r=>{this.speed=r,clearTimeout(this.lastSpeedTimeout),this.lastSpeedTimeout=setTimeout(()=>{this.blockCache.clear(),this.lastSpeed=this.speed,this.drawDirty=!0},200)}),this.trackVariable(()=>b.chart.zoom),this.trackVariable(()=>b.chart.CMod),this.trackVariable(()=>b.chart.doSpeedChanges),this.trackVariable(()=>b.chart.waveform.allowFilter),this.trackVariable(()=>b.chart.reverse),this.trackVariable(()=>b.chart.waveform.antialiasing,r=>{this.filters=r?[new Vo]:[]}),this.trackVariable(()=>this.renderer.chartManager.app.STAGE_WIDTH,()=>this.resizeWaveform()),this.trackVariable(()=>this.renderer.chartManager.app.STAGE_HEIGHT,()=>this.resizeWaveform()),this.trackVariable(()=>b.chart.waveform.filteredColor),this.trackVariable(()=>b.chart.waveform.color),this.trackVariable(()=>b.chart.waveform.speedChanges),this.trackVariable(()=>b.chart.receptorYPos),this.trackVariable(()=>b.chart.waveform.lineHeight,()=>{b.chart.waveform.lineHeight<=0&&(b.chart.waveform.lineHeight=1),this.updateLineHeight()}),this.trackVariable(()=>b.chart.zoom,()=>this.resizeWaveform()),this.trackVariable(()=>this.renderer.chartManager.chartAudio.hasFilters());const t=()=>this.getData();this.anchor.set(.5),this.renderer.chartManager.chartAudio.onUpdate(t),this.getData(),this.resizeWaveform(),this.filters=b.chart.waveform.antialiasing?[new Vo]:[];const n=()=>this.drawDirty=!0,a=()=>{this.getData(),this.resizeWaveform(),this.renderer.chartManager.chartAudio.onUpdate(t)};ie.on("timingModified",n),this.on("destroyed",()=>{ie.off("timingModified",n)}),ie.on("audioLoaded",a),this.on("destroyed",()=>{ie.off("audioLoaded",a),this.renderer.chartManager.chartAudio.offUpdate(t)})}getData(){this.rawData=this.renderer.chartManager.chartAudio.getRawData(),this.filteredRawData=this.renderer.chartManager.chartAudio.getFilteredRawData(),this.sampleRate=this.renderer.chartManager.chartAudio.getSampleRate(),this.blockCache.clear(),this.drawDirty=!0}resizeWaveform(){this.waveformTex.resize(Te((this.rawData?.length??0)*288*b.chart.zoom,1,this.renderer.chartManager.app.STAGE_WIDTH),this.renderer.chartManager.app.STAGE_HEIGHT)}update(){this.visible=b.chart.waveform.enabled,b.chart.waveform.enabled&&((this.drawDirty||this.variableChanged())&&(this.colorCache.toHexa()!=b.chart.waveform.color&&(this.colorCache=ea(b.chart.waveform.color)),this.filteredColorCache.toHexa()!=b.chart.waveform.filteredColor&&(this.filteredColorCache=ea(b.chart.waveform.filteredColor)),this.drawDirty=!1,this.renderData(),this.renderer.chartManager.app.renderer.render(this.lineContainer,{renderTexture:this.waveformTex})),this.scale.set(1/b.chart.zoom))}trackVariable(e,t){this.trackedVariables.set(e,{value:e(),cb:t})}variableChanged(){let e=!1;for(const[t,n]of this.trackedVariables.entries())t()!=n.value&&(this.trackedVariables.get(t).value=t(),this.trackedVariables.get(t).cb?.(t()),e=!0);return e}getSample(e,t,n){if(t<0)return 0;const a=this.sampleRate/(this.lastSpeed*4),r=Math.floor(t*this.lastSpeed*4);if(this.blockCache.get(n)?.[r]!==void 0)return this.blockCache.get(n)[r];const s=Math.floor(r*a),o=e.slice(s,Math.floor(s+a)).reduce((l,u)=>l+Math.abs(u),0)/a;return this.blockCache.has(n)||this.blockCache.set(n,[]),this.blockCache.get(n)[r]=o,o}renderData(){this.resetPool();const e=b.chart.waveform.allowFilter&&this.renderer.chartManager.chartAudio.hasFilters(),t={data:{bpms:[],bpmIndex:0,timing:[],timingIndex:0,offset:0,lastBeat:-999,timingData:null},init(a){if(this.data.bpms=a.getTimingData("BPMS"),this.data.timing=a.getBeatTiming(),this.data.offset=a.getOffset(),this.data.bpms[0]?.beat!==0){const r=structuredClone(this.data.bpms[0])??{value:120,type:"BPMS",beat:0};r.beat=0,this.data.bpms.unshift(r)}this.data.timing.length==0&&this.data.timing.unshift({beat:0,secondBefore:-this.data.offset,secondAfter:-this.data.offset,secondClamp:-this.data.offset,secondOf:-this.data.offset,warped:!1,bpm:120}),this.data.timingData=a},getBPM(a){for(;a>this.data.bpms[this.data.bpmIndex+1]?.beat;)this.data.bpmIndex++;return this.data.bpms[this.data.bpmIndex].value},getSecond(a){const r=Math.floor(a*48)/48;if(a<=0)return-this.data.offset+a*60/this.getBPM(a);if(r>=this.data.timing[this.data.timingIndex+1]?.beat){for(;r>=this.data.timing[this.data.timingIndex+1]?.beat;)this.data.timingIndex++;return this.data.timingData.getSecondsFromBeat(a)}else{const s=this.data.timing[this.data.timingIndex];let l=(a-s.beat)*60/s.bpm;return s.warped&&(l=0),Math.max(s.secondClamp,s.secondAfter+l)}}},n=this.renderer.chartManager.app.STAGE_HEIGHT;if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const a=b.chart.speed,r=this.renderer.getCurrentSpeedMult(),s=this.renderer.getTopOnScreenBeat(),o=this.renderer.getBottomOnScreenBeat(),l=Math.min(s,o),u=Math.max(s,o),f=this.renderer.findFirstOnScreenScroll(),c=this.renderer.findLastOnScreenScroll(),d=[...this.renderer.chart.timingData.getTimingData("SCROLLS")];d[0]?.beat!=0&&d.unshift({type:"SCROLLS",beat:0,value:d[0]?.value??1}),t.init(this.renderer.chart.timingData);const h=d.findIndex(w=>w.beat==f.beat),p=d.findIndex(w=>w.beat==c.beat),m=100/a/Math.abs(r)/64/b.chart.zoom;let g=l,y=Math.round(this.renderer.getYPosFromBeat(g)*b.chart.zoom+n/2),x=this.renderer.chart.getSecondsFromBeat(g);for(const w of d.slice(h,p+1)){if(w.value==0)continue;const C=m/Math.abs(w.value);w.beat!=f.beat?g=w.beat:g=Math.round((g-w.beat)/C)*C+w.beat,y=Math.round(this.renderer.getYPosFromBeat(g)*b.chart.zoom+n/2),x=this.renderer.chart.getSecondsFromBeat(g);const _=this.renderer.getScrollDirection(w.value),F=d[d.indexOf(w)+1]?.beat??Number.MAX_VALUE;for(;g<Math.min(F,u);){if(y<0){if(_<0){g=F;break}g+=C*-y,y=0;continue}if(y>n){if(_>0){g=F;break}g+=C*(y-n),y=n;continue}g+=C*b.chart.waveform.lineHeight,y+=_*b.chart.waveform.lineHeight,x=t.getSecond(g),this.drawLine(x,y,e)}}}else if(b.chart.CMod){let a=this.renderer.getSecondFromYPos((-n/2+(b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT:0))/b.chart.zoom);const r=this.renderer.getPixelsToSecondsRatio()/b.chart.zoom;a=Math.floor(a/r)*r;const s=o=>{a+=r*b.chart.waveform.lineHeight,this.drawLine(a,o,e)};if(b.chart.reverse)for(let o=this.renderer.chartManager.app.STAGE_HEIGHT;o>=0;o-=b.chart.waveform.lineHeight)s(o);else for(let o=0;o<=this.renderer.chartManager.app.STAGE_HEIGHT;o+=b.chart.waveform.lineHeight)s(o)}else{let a=this.renderer.getBeatFromYPos((-n/2+(b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT:0))/b.chart.zoom);t.init(this.renderer.chart.timingData);const r=this.renderer.getPixelsToEffectiveBeatsRatio()/b.chart.zoom;a=Math.floor(a/r)*r;let s=this.renderer.chart.getSecondsFromBeat(a);const o=l=>{a+=r*b.chart.waveform.lineHeight,s=t.getSecond(a),this.drawLine(s,l,e)};if(b.chart.reverse)for(let l=this.renderer.chartManager.app.STAGE_HEIGHT;l>=0;l-=b.chart.waveform.lineHeight)o(l);else for(let l=0;l<=this.renderer.chartManager.app.STAGE_HEIGHT;l+=b.chart.waveform.lineHeight)o(l)}this.purgePool()}drawLine(e,t,n){if(!(e<0))for(let a=0;a<this.rawData.length;a++){const r=this.getLine();if(r.scale.x=this.getSample(this.rawData[a],e,"main")*16*b.chart.zoom,r.y=t,r.tint=this.colorCache,r.alpha=this.colorCache.alpha,r.x=this.waveformTex.width/2+288*(a+.5-this.rawData.length/2)*b.chart.zoom,!n)continue;const s=this.getLine();s.scale.x=this.getSample(this.filteredRawData[a],e,"filter")*16*b.chart.zoom,s.tint=this.filteredColorCache,s.alpha=this.filteredColorCache.alpha,s.y=t,s.x=this.waveformTex.width/2+288*(a+.5-this.filteredRawData.length/2)*b.chart.zoom}}resetPool(){this.poolSearch=0}purgePool(){Kt(this.lineContainer.children,(e,t)=>t>=this.poolSearch)}updateLineHeight(){for(const e of this.lineContainer.children){const t=e;t.height=b.chart.waveform.lineHeight}}getLine(){if(this.lineContainer.children[this.poolSearch]){const t=this.lineContainer.children[this.poolSearch];return t.visible=!0,this.poolSearch++,t}const e=new ye(xe.WHITE);return e.height=b.chart.waveform.lineHeight,e.anchor.set(.5),e.visible=!0,this.poolSearch++,this.lineContainer.addChild(e),e}getSpeed(){return Math.min(b.chart.speed,mg)}}const bg="/smeditor/assets/missing-Dwhls35X.png",ad=xe.from(bg),yg={HoldBodyTopOffset:0,HoldBodyBottomOffset:0,RollBodyTopOffset:0,RollBodyBottomOffset:0};class wg{renderer;options;objects=[];updateHooks=new Set;hooks={};metrics;constructor(e,t){this.renderer=e,this.options=t,this.options.init?.(e),this.metrics={...yg,...this.options.metrics}}update(e){this.options.update?.(e),this.updateHooks.forEach(({item:t,cb:n})=>{t.destroyed||n(e)})}getPlaceholderSprite(){const e=new ye(ad);return e.anchor.set(.5),e}getBlankSprite(){return new ye(xe.EMPTY)}getElement(e,t={}){try{return this.options.load?this.options.load.bind(this)(e,{noteskin:this,columnName:e.columnName,columnNumber:e.columnNumber,...t})??this.getPlaceholderSprite():this.loadElement(e,t)??this.getPlaceholderSprite()}catch(n){return console.error(n),b.debug.showNoteskinErrors&&ce.createFormatted("Noteskin Error: "+n,"error"),this.getPlaceholderSprite()}}loadElement(e,t={}){const n=this.followRedirs(e);return n===void 0?(b.debug.showNoteskinErrors&&ce.createFormatted(`Noteskin element ${e.columnName} ${e.element} failed to load for noteskin: Redirect loop`,"error"),this.getPlaceholderSprite()):n({noteskin:this,columnName:e.columnName,columnNumber:e.columnNumber,...t})}followRedirs(e){const t=[e];let n=e;for(;;){const a=this.options.elements[n.columnName]?.[n.element];if(a===void 0)return;if(typeof a=="function")return a;if(n={columnName:a.columnName??n.columnName,columnNumber:a.columnNumber??n.columnNumber,element:a.element},t.some(r=>n.columnName==r.columnName&&n.element==r.element))return;t.push(n)}}on(e,t,n){this.hooks[t]===void 0&&(this.hooks[t]=new Set);const a={item:e,cb:n};this.hooks[t].add(a),e.once("destroyed",()=>this.hooks[t].delete(a))}onUpdate(e,t){const n={item:e,cb:t};this.updateHooks.add(n),e.once("destroyed",()=>this.updateHooks.delete(n))}broadcast(e){if(this.hooks[e.type]===void 0)return;this.hooks[e.type].forEach(({item:n,cb:a})=>{n.destroyed||a(e)})}}const vg="/smeditor/assets/hold_judgement-BL12d-N2.png";class Zi extends de{children=[];static held_tex;static dropped_tex;notefield;constructor(e){super(),Zi.held_tex||this.loadTex(),this.notefield=e}async loadTex(){const e=await Is.load(vg),t=e.height,n=e.width;Zi.held_tex=new xe(e,new Kn(0,0,n,t/2)),Zi.dropped_tex=new xe(e,new Kn(0,t/2,n,t/2))}update(){this.y=this.notefield.renderer.getActualReceptorYPos()+(b.chart.reverse?-48:48);for(const e of this.children){const t=(Date.now()-e.createTime)/1e3;if(t<.1){const n=1-(1-t/.1)*(1-t/.1);e.scale.set(.3*n)}else if(t>.6&&t<.8){const n=(t-.6)/.2*(t-.6)/.2;e.scale.set(.3*(1-n))}}Kt(this.children,e=>Date.now()-e.createTime>800)}addJudge(e,t){if(!Xn(t)&&!yn(t))return;const n=new ye(Xn(t)?Zi.dropped_tex:Zi.held_tex);n.anchor.set(.5),n.x=this.notefield.getColumnX(e),n.createTime=Date.now(),n.scale.set(0),this.addChild(n)}}class xg extends de{notefield;arrowMap=new Map;notesDirty=!1;children=[];constructor(e){super(),this.notefield=e,this.sortableChildren=!0;const t=()=>{this.arrowMap.clear(),this.removeChildren()},n=()=>this.notesDirty=!0;ie.on("timeSigChanged",t),ie.on("chartModified",n),this.on("destroyed",()=>{ie.off("timeSigChanged",t),ie.off("chartModified",n)})}update(e,t){const n=this.notefield.renderer.chart.getNotedata();if(this.notesDirty){for(const[a,r]of this.arrowMap.entries())n.includes(a)||(r.destroy(),this.arrowMap.delete(a));this.notesDirty=!1}for(const a of n){if(a.beat>t)break;if(this.shouldDisplayNote(a,e,t)&&!this.arrowMap.has(a)){const r=new de,s=this.notefield.createNote(a);Object.assign(r,{x:this.notefield.getColumnX(a.col),zIndex:a.beat});const o=new ye(xe.WHITE),l=s.getLocalBounds();o.x=l.x,o.y=l.y,o.width=l.width,o.height=l.height,o.alpha=0;const u=new ye(xe.WHITE);u.x=l.x,u.y=l.y,u.width=l.width,u.height=l.height,u.alpha=0;const f=new ye(xe.WHITE);f.x=l.x,f.y=l.y,f.width=l.width,f.height=5,f.tint=16711680,f.alpha=0,this.notefield.renderer.registerDragNote(r,a),r.wrapper=s,r.selection=o,r.parity=u,r.parityOverride=f,r.lastActive=!1,this.arrowMap.set(a,r),r.addChild(s,o,u,f),this.addChild(r)}}for(const[a,r]of this.arrowMap.entries()){if(!this.shouldDisplayNote(a,e,t)){r.destroy(),this.arrowMap.delete(a);continue}if(r.y=this.notefield.renderer.getActualReceptorYPos(),(!Oe(a)||!a.gameplay?.lastHoldActivation||this.notefield.renderer.getVisualBeat()<a.beat)&&(r.y=this.notefield.renderer.getYPosFromBeat(a.beat)),Oe(a)&&a.gameplay?.droppedHoldBeat&&(r.y=this.notefield.renderer.getYPosFromBeat(a.gameplay.droppedHoldBeat)),Oe(a)){const s=this.notefield.renderer.getYPosFromBeat(Ni(a))-r.y,o=r.wrapper.object;if(o.setLength(s),a.gameplay?.lastHoldActivation){let u=(Date.now()-a.gameplay.lastHoldActivation)/_t.getCollection(b.play.timingCollection).getHeldJudgement(a).getTimingWindowMS();u=Math.min(1.2,u),o.setBrightness(1-u*.7)}else o.setBrightness(1);a.gameplay?o.setActive(!(a.gameplay.lastHoldActivation===void 0||a.gameplay.droppedHoldBeat!==void 0)):o.setActive(!1);const l=r.wrapper.getLocalBounds();r.parity.x=l.x,r.parity.y=l.y,r.parity.width=l.width,r.parity.height=l.height,r.parityOverride.x=l.x,r.parityOverride.y=l.y,r.parityOverride.width=l.width}if(this.notefield.renderer.chartManager.editTimingMode==Se.Off){const s=this.notefield.renderer.shouldDisplayNoteSelection(a);if(r.selection.alpha=s?Math.sin(Date.now()/320)*.1+.3:0,s&&r.wrapper.object.type=="hold"){const l=r.wrapper.getLocalBounds();r.selection.x=l.x,r.selection.y=l.y,r.selection.width=l.width,r.selection.height=l.height}r.visible=!s||!this.notefield.renderer.chartManager.selection.shift;const o=this.notefield.renderer.selectionTest(r.wrapper);!s&&o&&this.notefield.renderer.chartManager.addNoteToDragSelection(a),s&&!o&&this.notefield.renderer.chartManager.removeNoteFromDragSelection(a)}b.chart.parity.enabled&&b.chart.parity.showHighlights&&this.notefield.renderer.chartManager.getMode()==W.Edit?(r.parity.alpha=a.parity?.4:0,r.parity.tint=a.parity?.foot!==void 0?ii[a.parity.foot]:16777215,a.parity?.override?r.parityOverride.alpha=.4:r.parityOverride.alpha=0):(r.parity.alpha=0,r.parityOverride.alpha=0)}}shouldDisplayNote(e,t,n){return e.gameplay?.hideNote||b.chart.CMod&&e.fake&&b.chart.hideFakedArrows||b.chart.CMod&&b.chart.hideWarpedArrows&&e.warped||Ni(e)<t?!1:e.beat<=n}}class Eg extends de{notefield;children=[];constructor(e){super(),this.notefield=e,this.eventMode="none";for(let t=0;t<this.notefield.gameType.numCols;t++){const n=this.notefield.getElement({element:"NoteFlash",columnName:this.notefield.getColumnName(t),columnNumber:t});n.x=this.notefield.getColumnX(t),this.addChild(n)}}update(){this.y=this.notefield.renderer.getActualReceptorYPos()}}class Cg extends de{notefield;children=[];dragStart=null;dragOptionsStart=null;optionUpdate=e=>{e=="chart.allowReceptorDrag"&&(this.eventMode=b.chart.allowReceptorDrag?"static":"passive")};constructor(e){super(),this.notefield=e,this.cursor="grab";for(let a=0;a<this.notefield.gameType.numCols;a++){const r=this.notefield.getElement({element:"Receptor",columnName:this.notefield.getColumnName(a),columnNumber:a});r.x=this.notefield.getColumnX(a),this.addChild(r)}const t=a=>{!this.dragStart||!this.dragOptionsStart||(b.chart.receptorXPos=Math.round(this.dragOptionsStart[0]+a.global.x-this.dragStart.x),b.chart.receptorYPos=Math.round(this.dragOptionsStart[1]+(a.global.y-this.dragStart.y)*(b.chart.reverse?-1:1)))},n=()=>{this.cursor="grab",this.notefield.renderer.off("pointermove",t),window.removeEventListener("pointerup",n)};this.on("pointerdown",a=>{this.cursor="grabbing",this.dragStart=new gd(a.globalX,a.globalY),this.dragOptionsStart=[b.chart.receptorXPos,b.chart.receptorYPos],a.preventDefault(),a.stopImmediatePropagation(),this.notefield.renderer.on("pointermove",t),window.addEventListener("pointerup",n)}),ie.on("userOptionUpdated",this.optionUpdate),this.optionUpdate("chart.allowReceptorDrag")}destroy(){ie.off("userOptionUpdated",this.optionUpdate)}update(){this.y=this.notefield.renderer.getActualReceptorYPos()}}class _g extends de{notefield;arrowMap=new Map;children=[];lastBeatShift=0;lastColShift=0;constructor(e){super(),this.notefield=e,this.sortableChildren=!0}update(e,t){if(!this.notefield.renderer.chartManager.selection.shift){this.removeChildren(),this.arrowMap.clear();return}const n=this.notefield.renderer.chartManager.selection.shift.beatShift,a=this.notefield.renderer.chartManager.selection.shift.columnShift;if(this.lastBeatShift!=n||this.lastColShift!=a){this.lastBeatShift=n,this.lastColShift=a;for(const[r,s]of this.arrowMap.entries()){const o=this.notefield.renderer.chartManager.loadedChart.computeNote({...r,beat:r.beat+n,col:r.col+a});s.x=this.notefield.getColumnX(o.col),s.wrapper.destroy(),s.wrapper.alpha=.4,s.wrapper=this.notefield.createNote(o);const l=s.wrapper.getBounds();s.selection.x=l.x,s.selection.y=l.y,s.selection.width=l.width,s.selection.height=l.height,s.addChild(s.wrapper,s.selection)}}for(const r of this.notefield.renderer.chartManager.selection.notes)if(!(r.beat+n+(Oe(r)?r.hold:0)<e)&&!(r.beat+n>t)&&!this.arrowMap.has(r)){const s={...r,beat:r.beat+n,col:r.col+a},o=new de,l=this.notefield.createNote(s);Object.assign(o,{x:this.notefield.getColumnX(s.col),zIndex:s.beat,alpha:.4});const u=new ye(xe.WHITE),f=l.getBounds();u.x=f.x,u.y=f.y,u.width=f.width,u.height=f.height,u.alpha=0,this.notefield.renderer.registerDragNote(l,s),o.wrapper=l,o.selection=u,this.arrowMap.set(r,o),o.addChild(l,u),this.addChild(o)}for(const[r,s]of this.arrowMap.entries()){if(r.beat+n+(Oe(r)?r.hold:0)<e||r.beat+n>t){s.destroy(),this.arrowMap.delete(r);continue}const o=r.beat+n;if(s.y=this.notefield.renderer.getYPosFromBeat(o),s.selection.alpha=Math.sin(Date.now()/320)*.1+.3,Oe(r)){const l=this.notefield.renderer.getYPosFromBeat(o+(Oe(r)?r.hold:0))-s.y,u=s.wrapper.object;u.setLength(l),u.setBrightness(1);const f=s.wrapper.getLocalBounds();s.selection.x=f.x,s.selection.y=f.y,s.selection.width=f.width,s.selection.height=f.height}}}}const Ag="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAZ5QTFRFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8fHx9vb29PT0AAAA+fn5/////f39AAAAAAAAAAAAAAAA/v7+AAAAAAAA9vb2AAAAAAAA8/PzAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAv401VgAAAIp0Uk5TABZHbpW80t3u+bttRhUKT5H+/9GQTgkCPJnxok0DCGreaQd05nLf41Qgs7EeUFYTx8QSGtYdKOLhJxvg5B/VxZRS8O+ysHVw5fv28fRn7v/qvtwBQeo+nvKb8vRLwr2Mz/0URGuSudPt6/jOSp2aQD3bZnNJrkxRjgYP0NQmGREEiFVvM+yNRZO6TR9aLAAABG9JREFUeJzt2VloFEkYAOD/T2aSzJh0gmSM7kbFQYOJGWJWNB6oefBYjAdeeBCMB3iB7IPHgw/isoIu6y6yeIDZNQaVhYjghSd44IO6G6IxwSsq4n2GGE2Midr2SI4+/uqq6h5lhfkfcnRX1dfddXRVNcJXCIwiUSSKfGsItgWoquppjkd8HVlEQWzsZE6qxmjiswghaVpZTYxzCdq5++6RHoj1tgkavsM77hAlgLW8y4DO+NT+OuyRdP8LLhGOAF53imTiEyEiHN2w2hESqvELG1oTSL0ijwRrYySIcMT7WA2AheTgPUkDoCdWSCEDqhKlDe3u8T8JZBDWODAAMvC8MDIUrzkyALLwnCCS4+V1YXZkvyHqhUCCinydd0TovvUKCSSf3eBF4mOdANJXaPS2iZzTXCSz22WXSG6zufItyChGh5KIASc5SOihawPA/8AWUUJOe4ihlEZjvZqQMeURMAAGHrdBghn/RgTp3GzoakakJzXLydMmC+9pPCtFmx5dJE4MO8RE0nzEuzrPi+FJ11miqJGqqs2MWgglH/exkGmniJIGe8M/495blZGe5vCvlgtErlFlLGSGuYGHY4gHaKXVAN8JItfYfxiIMv4YkXxoLJBKmwGJR4lc/at1rViPJMcSqSErVaWUdgOryZnZuN00kkJPHQqaWouL259EHPQdJnNNKKWROMZ7nVC4BkzcSSKYwpq6tD+atidmOWCNSbiDQmJSGOkt98K/Dy0m/00hscnMDEZFyIApf1GIR2Hn0CszhQyYWkwh/gSbLLpqAG59fI5p2ylk0V67PB330hr296GV/JJChnHeV0aFZ4Byl0IWl1lTMhWuATO2UYjPx8mmU/gGzNzqGtGNMFKI3OPiKvTjkqx4nkJXvGwT5ih0E/4qnVFwWPGp1PvFGvSwIjZAam2XfItZgh4ghYb6z/1DSKGH+iRPRF9aFZUUIvD6be/n/HuZtaXjbz2S+lHUEFBYE4nAByo1d0rURM6TZ2+mESWR2qBzNrnLrdHN6w11vWwPkdzZNLXwT90/BuSnXURyZxPuOZtYSFpdJ2tyR0uHonvMpQP0ekUUlYfKG8YiaJAnsZ5cBM39Q//fl1nOBVoMex+mTr68JCLIK2NnMC+xu4ptn9pHfrlxC8g8XK3YAe5DvzahEOj32LWx4DfTAQuSnXbJpdEYMu9EWkf3VcXuvqmoC381HyIKZKzqRGPhBsshanuwe5ULoyB9vQgCq3EbcVQslh4R2+h0s2Ub8FLfBehKHqLedGRkjP6FOsxoSWu2qA6M7Lcy2+gAPyTJ135B8Gf6BLNPrMVNcv1FVZdY2xUHAUh+J/WRZvEa5jm7qx1eKz6OLThDVwcX0YaYMvvPbm3RMH233WnOc++S23CVSwQKi+0/IXArN9jPe8Y2QRHGsypcGNFi3caVvzNO9b/xY90+xjk5BKDHiPQneMB0cJL/+0cHhT61iPeF+X1u98b6jfNKoahkxfPgLbW8kp9JFnERUSSKRJH/CfIJY3BkdLZ23K0AAAAASUVORK5CYII=",kg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAapQTFRFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/v7+/v7+AAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAA+Pj4AAAAAAAA+fn5////AAAAAAAAAAAAAAAAAAAA/Pz8AAAAAAAAAAAAAAAAAAAAAAAA+Pj4AAAA////AAAA9fX19PT0+/v7AAAA+fn5/v7+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAE+ClvgAAAI50Uk5TABZHbpW80t3u+bttRhUKT5H+/9GQTgkCPJnxok0DCGreaQd05nLf41Qgs7EeUFYTx8QSGtYdKOLhJxvg5B/VxZRS8O+ysHVw5f/+Z//cAUE+nptL+IzP+P79FOxEa/SS7bnT6/j55/Lo+/328vfzzkqdmkA922ZzSa5MUY7CBg/Q1CYZEQSIVW8zjUWTutnbD5QAAARSSURBVHic7dlpSBRRHADw918tz1axVjNTyQ+S6WIWnVKoWUInHWAKRRcERUX0oYMo6EA6iOpDQQcihV0UJYREQUREJ5UZlgVR2U1JnpWV02y17s6b/7t2pijY/wdx33s7v5l99xsgfyEgiASRIPK/IeANomlaaEcYQIu9iBOgPYouqjl08Z1NSIJ+rc+MvHA9r8E6kgLQzC3Q1geeWEOcLmgU3QaJg7f8++AjfSPfCwlPuOBhoEgGvJEiPJEI9wNC3I8jpQ29CfS6p46kNToUCE+ERbAaAAvJhueKBiGpcFsJGVwbrWzoTw83FZCh8DgAg5B0uCqNjIQHARmEDIDLkkh2N1EXZkdWK1IvCJLmVK9zX7gbzHeIIHnsBi8TnR8lkP5Sozcnsi8KkYzEuxaRnA668k1IIaNDKcTg8wLE/dKyQUjkCy7idAfaQwxXaTfWK4WMu2WDQciQcxwkLf2GLUhch6GrGZFU8SpnmL4kui4sNeIsE0mI4M/Vegz3zDKd10TFcqGKhUzBRjezIaOMPs1Cpl6SMySUvFMMJD5L0NmH+2ZkkRL+za8V+yMxIdKGWMk/iSOx/KVDgXGtKlDGnMCR7tx5vYBeD/OVwuMoArG8ld7Ytt//RJNWGaUIKjHEEcv5TtdzRIe8cUkp4w9jSEiMlFFNcqSUCYcwJNQpNuK+V+t/pZRJFRgSGc4q31UfcY5fo8Xkz14lip6gumJKOYbMO40U9QT1HJ7wPQtTgQ8YksuYrxBDRnE+xZA5VeaSLENCmXoQQyIiFAxdSfJu9HBl2gFphGkIFRzBfi6OIVLwnwupeK4hUPCKNzdhgcFX8CZs6ozTX3sNB97w9F7Z6VUST1JZeGekV/Mz4KXI8FOS4LgxBx9WosKMpYobxIafknzMmIEPkNHdjaVmPpcwfErKUWM6PtT3CKUmrZJnEoZXST1iTC2qq8EQ0lMzliv9eYBWSUSBlpu1y/e/P9KrU3g9+WAtJFzfbURm78QR4eJOIQbeZyzuyPIKumzAMWeH3wcDsqKc2BXztrOQhI9RNhnz65lbB9KvySZkwVb/T39mO+f6ajj7oDr5yv22IE3GzkBvsXvLHZ/yI7fGeAREr7FX7bMByafmFtNCPvM1naIcC8uoBBOSlXDHotHupk8izVuSNXutvVPRFm2mk5ALCnZ1oli0yZSEHQ8m11owFsMGGYSsh90BG8vOyB10WjmydXXD3gvglTxCexSQkT5+HZbMaEkbd2p4BjeyPqkcoxMyqId67S8OW4tnMPvEZtim1l80bam5XQkQQmK+KL2kWbKamce721GN8uPYwgt4dQgRfYipFB7l/Yy2ifSaXgEh8TltdULCNXcP/xWCsHLTMhxXuAXmQzirwqURPbaUTcA3Wvoarj6/WbQgl33BnDIk41HIOSqxKD7p1SmpVy3yfaE05142tJSVHCPFR1Y/y6zRamvEX1JFLEQQCSJB5B9BfgCwNDJ0if9eSgAAAABJRU5ErkJggg==";class Sg extends qc{offsetY=0;setY=0;_last=0;_lastTop=!1;constructor(e){super(e,0,0,0,0),this.scale.cb=()=>{this.refresh()}}cropBottom(e,t=!1){this._last==e&&!this._lastTop&&!t||(this._last=e,this._lastTop=!1,this._height=this.texture.height-e/Math.abs(this.scale.y),this._bottomHeight=0,this.offsetY=0,this.topHeight=this.texture.height-e/Math.abs(this.scale.y),this._updateY())}cropTop(e,t=!1){this._last==e&&this._lastTop&&!t||(this._last=e,this._lastTop=!0,this._height=this.texture.height-e/Math.abs(this.scale.y),this._topHeight=0,this.bottomHeight=this.texture.height-e/Math.abs(this.scale.y),this.offsetY=e/Math.abs(this.scale.y),this._updateY())}get y(){return this.setY}set y(e){this.setY=e,this._updateY()}_updateY(){super.y=this.setY+this.offsetY*Math.abs(this.scale.y)}refresh(){this._lastTop?this.cropTop(this._last,!0):this.cropBottom(this._last,!0)}}class rd extends Sg{constructor(e,t=64){super(e),this.scale.set(t/this.texture.width),this.pivot.x=t/2/this.scale.x,this.texture.on("update",()=>{this.width=this.texture.width,this.height=this.texture.height,this.scale.set(t/this.texture.width),this.pivot.x=t/2/this.scale.x,this.refresh()})}}class Zg extends rd{_playing=!1;_autoUpdate=!1;_isConnectedToTicker=!1;_tickerUpdate=this.update.bind(this);_currentTime=0;_textures;_previousFrame=null;onComplete=null;onLoop=null;onFrameChange=null;animationSpeed=1;loop=!1;updateAnchor=!1;constructor(e,t){super(e[0],t),this.textures=e}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(vt.shared.remove(this._tickerUpdate),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(vt.shared.add(this._tickerUpdate,this,Gc.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(e){this.stop(),this.currentFrame=e}gotoAndPlay(e){this.currentFrame=e,this.play()}update(e){if(!this._playing)return;const t=this.animationSpeed*e,n=this.currentFrame;this._currentTime+=t,this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete?.()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete?.()):n!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<n||this.animationSpeed<0&&this.currentFrame>n)&&this.onLoop(),this.updateTexture())}updateTexture(){const e=this.currentFrame;this._previousFrame!==e&&(this._previousFrame=e,this.texture=this._textures[e],this.onFrameChange?.(this.currentFrame))}destroy(e){this.stop(),super.destroy(e),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}get totalFrames(){return this._textures?.length??0}get textures(){return this._textures??[]}set textures(e){this._textures=e,this._previousFrame=null,this.gotoAndStop(0),this.updateTexture()}get currentFrame(){let e=Math.floor(this._currentTime)%this._textures.length;return e<0&&(e+=this._textures.length),e}set currentFrame(e){if(e<0||e>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${e}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const t=this.currentFrame;this._currentTime=e,t!==this.currentFrame&&this.updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(vt.shared.remove(this._tickerUpdate),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(vt.shared.add(this._tickerUpdate),this._isConnectedToTicker=!0))}}const Tg={Fake:xe.from(Ag),Lift:xe.from(kg)};class Fc extends de{object;icon;constructor(e){super(),this.object=e,this.icon=new ye(Tg[e.note.type]),this.icon.anchor.set(.5),this.icon.scale.set(.3),this.icon.alpha=.8,this.icon.visible=!1,this.addChild(e,this.icon),e.nf.noteskin===void 0?ie.on("noteskinLoaded",()=>this.loadEventHandler()):this.loadEventHandler()}loadEventHandler(){this.object.nf.noteskin.onUpdate(this,e=>{if(!b.chart.drawIcons){this.icon.visible=!1;return}if(this.object.nf.noteskinOptions?.hideIcons?.includes(this.object.note.type)){this.icon.visible=!1;return}this.icon.visible=!0,this.object.note.type=="Fake"&&(this.icon.visible=e.chartManager.getMode()!=W.Play)})}}class Mg extends de{type="note";note;nf;constructor(e,t){super(),this.note=t,this.nf=e,this.on("destroyed",()=>{this.removeAllListeners()}),this.nf.noteskin===void 0?ie.on("noteskinLoaded",()=>{this.loadElement(t)}):this.loadElement(t)}loadElement(e){const t=this.nf.noteskin.getElement({element:e.type,columnName:this.nf.getColumnName(e.col),columnNumber:e.col},{note:e});this.addChild(t)}}function Lg(i){return i.cropTop!==void 0}class Dg extends de{type="hold";note;active;inactive;wasActive=!1;lastLength=null;elements;metrics;ns;nf;loaded=!1;constructor(e,t){super();const n=new de,a=new de;this.note=t,this.ns=e.noteskin,this.nf=e,this.metrics=this.ns.metrics,n.visible=!1,this.active=n,this.inactive=a,this.addChild(a,n),e.noteskin===void 0?ie.on("noteskinLoaded",()=>{this.loadElements()}):this.loadElements()}loadElements(){if(!this.loaded){this.elements={};for(const e of["Active","Inactive"]){this.elements[e]={};for(const t of["BottomCap","Body","TopCap","Head"]){const n=this.getNoteskinElement(`${e} ${t}`);t=="BottomCap"?Lg(n)?this.elements[e][t]=n:(b.debug.showNoteskinErrors&&ce.createFormatted(`Noteskin Error: invalid tail found for ${e} ${t}!`,"error"),this.elements[e][t]=new rd(ad,64)):this.elements[e][t]=n,(e=="Active"?this.active:this.inactive).addChild(this.elements[e][t])}}this.loaded=!0}}getNoteskinElement(e){return this.ns.getElement({element:`${this.note.type} ${e}`,columnName:this.nf.getColumnName(this.note.col),columnNumber:this.note.col},{note:this.note})}setActive(e){this.wasActive!=e&&(this.wasActive=e,this.active.visible=e,this.inactive.visible=!e)}setBrightness(e){if(!this.loaded)return;const t=["Active","Inactive"],n=["Body","TopCap","BottomCap"];for(const a of t)for(const r of n)"tint"in this.elements[a][r]&&(this.elements[a][r].tint=go(e*255,e*255,e*255))}setLength(e){if(!this.loaded||this.lastLength==e)return;this.lastLength=e;const t=this.metrics[`${this.note.type}BodyBottomOffset`],n=this.metrics[`${this.note.type}BodyTopOffset`],a=["Active","Inactive"],r=e>=0?1:-1,s=Math.abs(e);for(const o of a){this.elements[o].Body.height=Math.max(0,s+t-n),this.elements[o].Body.y=s+t,this.elements[o].BottomCap.y=s+t,this.elements[o].BottomCap.y<0?(this.elements[o].BottomCap.cropTop(-this.elements[o].BottomCap.y),e<0&&(this.elements[o].BottomCap.y-=this.elements[o].BottomCap.y/Math.abs(this.elements[o].BottomCap.scale.y))):this.elements[o].BottomCap.cropTop(0),this.elements[o].TopCap.y=n;const l=Math.abs(this.elements[o].BottomCap.scale.y);this.elements[o].BottomCap.scale.y=e<0?-l:l;const u=Math.abs(this.elements[o].TopCap.scale.y);this.elements[o].TopCap.scale.y=e<0?-u:u,this.elements[o].Body.height*=r,this.elements[o].Body.y*=r,this.elements[o].BottomCap.y*=r,this.elements[o].TopCap.y*=r}}}class Ic extends de{isEditGUI=!1;noteskinOptions;noteskin;gameType;renderer;receptors;notes;selectionNotes;flashes;holdJudges;ghostNote;ghostNoteEntry;columnX=[];constructor(e){super(),this.renderer=e,this.gameType=e.chart.gameType,it.getNoteskin(this.gameType,b.chart.noteskin.name).then(t=>{if(!t){ce.createFormatted("Couldn't find an available noteskin!","error");return}let n=0;for(let a=0;a<this.gameType.numCols;a++){const r=this.gameType.columnWidths[a];this.columnX.push(n-this.gameType.notefieldWidth/2+r/2),n+=r}this.noteskinOptions=t,this.noteskin=new wg(this.renderer,t),this.receptors=new Cg(this),this.flashes=new Eg(this),this.notes=new xg(this),this.selectionNotes=new _g(this),this.holdJudges=new Zi(this),this.addChild(this.receptors,this.notes,this.selectionNotes,this.flashes,this.holdJudges),ie.emit("noteskinLoaded")})}setGhostNote(e){this.ghostNote?.destroy(),this.ghostNote=void 0,this.ghostNoteEntry=e,e&&(this.ghostNote=this.createNote(e),this.addChildAt(this.ghostNote,1),this.ghostNote.alpha=.4,this.ghostNote.x=this.getColumnX(e.col),this.ghostNote.y=this.renderer.getYPosFromBeat(e.beat))}getElement(e,t={}){return this.noteskin.getElement(e,t)}update(e,t){this.noteskin!==void 0&&(this.noteskin.update(this.renderer),this.receptors.update(),this.flashes.update(),this.notes.update(e,t),this.selectionNotes.update(e,t),this.holdJudges.update(),this.ghostNote&&(this.ghostNote.y=this.renderer.getYPosFromBeat(this.ghostNoteEntry.beat),this.ghostNote.visible=b.chart.mousePlacement&&this.renderer.chartManager.getMode()==W.Edit&&this.renderer.chartManager.editTimingMode==Se.Off&&this.ghostNoteEntry.beat>=e&&this.ghostNoteEntry.beat<=t&&this.ghostNoteEntry.beat>=0))}onJudgement(e,t){this.noteskin!==void 0&&(this.renderer.chartManager.getMode()==W.Play&&this.holdJudges.addJudge(e,t),xi(t)&&this.noteskin.broadcast({type:"hit",judgement:t,columnName:this.getColumnName(e),columnNumber:e}),yn(t)&&this.noteskin.broadcast({type:"held",columnName:this.getColumnName(e),columnNumber:e}),Xn(t)&&this.noteskin.broadcast({type:"letgo",columnName:this.getColumnName(e),columnNumber:e}),mi(t)&&this.noteskin.broadcast({type:"miss",judgement:t,columnName:this.getColumnName(e),columnNumber:e}),eo(t)&&this.noteskin.broadcast({type:"hitmine",columnName:this.getColumnName(e),columnNumber:e}))}startPlay(){}endPlay(){if(this.noteskin!==void 0)for(let e=0;e<this.gameType.numCols;e++)this.noteskin.broadcast({type:"holdoff",columnName:this.getColumnName(e),columnNumber:e}),this.noteskin.broadcast({type:"rolloff",columnName:this.getColumnName(e),columnNumber:e}),this.noteskin.broadcast({type:"lift",columnName:this.getColumnName(e),columnNumber:e})}press(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"press",columnName:this.getColumnName(e),columnNumber:e})}lift(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"lift",columnName:this.getColumnName(e),columnNumber:e})}ghostTap(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"ghosttap",columnName:this.getColumnName(e),columnNumber:e})}activateHold(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"holdon",columnName:this.getColumnName(e),columnNumber:e})}releaseHold(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"holdoff",columnName:this.getColumnName(e),columnNumber:e})}activateRoll(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"rollon",columnName:this.getColumnName(e),columnNumber:e})}releaseRoll(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"rolloff",columnName:this.getColumnName(e),columnNumber:e})}getColumnX(e){return this.columnX[e]??0}getColumnWidth(e){return this.gameType.columnWidths[e]}getColumnName(e){return this.gameType.columnNames[e]}createNote(e){return Oe(e)?new Fc(new Dg(this,e)):new Fc(new Mg(this,e))}}class Bg extends ge{isEditGUI=!1;renderer;constructor(e){super("",{fontName:"Fancy"}),this.anchor.set(.5),this.renderer=e}update(){this.y=b.chart.reverse?-50:50;const e=this.renderer.chartManager.gameStats;if(this.visible=this.renderer.chartManager.getMode()==W.Play,!e)return;const t=e.getCombo()==0?e.getMissCombo():e.getCombo();t<4?this.text="":this.text=t+"",e.getCombo()==0?this.tint=_t.getCollection(b.play.timingCollection).getMissJudgement().color:e.getBestJudge()?this.tint=bo(e.getBestJudge().color,Math.sin(Date.now()/225)*.2+1.2):this.tint=16777215}}const Fg=1,Pc=15,Ig={fontName:"Fancy",fontSize:12};class Pg extends de{isEditGUI=!1;barlines=new de;barline;currentMedian;errorText=new ge("",Ig);errorTextTime=-1;renderer;target=0;constructor(e){super(),this.renderer=e,this.barline=new ye(xe.WHITE),this.barline.anchor.set(.5),this.barline.height=1,this.barline.alpha=.5,ze(this.barline,"text-color");const t=new ye(xe.WHITE);t.width=2,t.height=Pc,t.anchor.set(.5),ze(t,"text-color"),this.currentMedian=new Hi,this.currentMedian.beginFill(16777215),this.currentMedian.moveTo(0,-10),this.currentMedian.lineTo(5,-15),this.currentMedian.lineTo(-5,-15),this.currentMedian.lineTo(0,-10),ze(this.currentMedian,"text-color"),this.errorText.y=-25,this.errorText.anchor.set(.5),this.addChild(this.barline,t,this.barlines,this.currentMedian,this.errorText)}update(){this.y=b.chart.reverse?-10:10,this.errorText.y=b.chart.reverse?25:-25,this.visible=this.renderer.chartManager.getMode()==W.Play;for(const e of this.barlines.children){const t=(Date.now()-e.createTime)/5e3;t<.05?e.alpha=1:t<.3?e.alpha=Ze(1,.2,(t-.05)/.25):t<.9?e.alpha=.2:e.alpha=(1-t)*3}this.errorText.alpha=Te((2e3-(Date.now()-this.errorTextTime))/1e3,0,1),this.barline.width=_t.getCollection(b.play.timingCollection).maxWindowMS()/1e3*2*400,Kt(this.barlines.children,e=>Date.now()-e.createTime>5e3),b.general.smoothAnimations?this.currentMedian.x=(this.currentMedian.x-this.target)*.8+this.target:this.currentMedian.x=this.target}addBar(e,t){if(e==null||!mi(t)&&!xi(t))return;const n=new ye(xe.WHITE);n.width=Fg,n.height=Pc,n.anchor.set(.5),n.x=e*400,n.tint=t.color,n.createTime=Date.now(),n.miss=mi(t),n.ms=Math.round(e*1e3),this.errorText.tint=t.color,this.errorText.text=(e*1e3).toFixed(1)+"ms",this.errorTextTime=Date.now(),this.barlines.addChild(n),this.target=ja(this.barlines.children.filter(a=>!a.miss).map(a=>a.ms))*.4}reset(){this.currentMedian.x=0,this.target=0,Kt(this.barlines.children,()=>!0)}}class Rg extends ye{isEditGUI=!1;createTime=-1;active=!1;type=Js;constructor(){super(),this.anchor.set(.5)}update(){if(this.y=b.chart.reverse?40:-40,this.visible=this.active,this.active){const e=(Date.now()-this.createTime)/1e3;let t=1.2;if(_t.getCollection(b.play.timingCollection).shouldHideNote(this.type)||(t=.8),e<.1){const n=1-(1-e/.1)*(1-e/.1),a=(1-t)*n+t;this.scale.x=.4*a,this.scale.y=.4*a}else if(e>.6&&e<.8){const n=(e-.6)/.2*(e-.6)/.2;this.scale.x=.4*(1-n),this.scale.y=.4*(1-n)}else e>.8&&(this.active=!1)}}doJudge(e,t){if(e==null&&(e=0),!xi(t)&&!mi(t))return;const n=t.judgementTexture.getTexture(e,t);n&&(this.texture=n,this.texture.updateUvs(),this.active=!0,this.type=t,this.createTime=Date.now(),b.play.judgementTilt?this.rotation=Te(e,-.05,.05)*300/180*Math.PI:this.rotation=0)}reset(){this.active=!1}}class wi extends Ui{static options;static convertText;static convertBtnOne;static convertBtnTwo;static onTimingChange=this.updateValues.bind(this);onConfirm=()=>{};persistent=!1;static open(e){super._open({...e,title:"Column",description:"",width:255,editable:!0,cancelableOnOpen:!1}),ie.on("timingModified",this.onTimingChange),this.updateValues()}static buildContent(){const e=document.createElement("div");e.style.display="flex",e.style.gap="0.25rem",e.style.alignItems="center",e.style.flexDirection="column",e.style.marginTop="0.6rem",e.style.fontSize="0.75rem";const t=document.createElement("div"),n=document.createElement("button"),a=document.createElement("button");this.convertBtnOne=n,this.convertBtnTwo=a,this.convertText=t,e.replaceChildren(t,n,a),this.view.appendChild(e)}static close(){!this.popup||!this.active||(super.close(),ie.off("timingModified",this.onTimingChange))}static updateValues(){const e=this.options.timingData.isPropertyChartSpecific(this.options.type),t=e?"chart":"song";this.title.innerText=je[t].title,this.desc.innerText=je[t].desc,this.convertText.innerText=je[t].convertText,this.convertBtnOne.innerText=je[t].buttonOne.text,this.convertBtnTwo.innerText=je[t].buttonTwo.text,this.convertBtnTwo.classList.toggle("delete",e),Xe(this.convertBtnOne,{content:je[t].buttonOne.tooltip}),Xe(this.convertBtnTwo,{content:je[t].buttonTwo.tooltip}),this.convertBtnOne.onclick=()=>{je[t].buttonOne.action(this.options.timingData,this.options.type),this.close()},this.convertBtnTwo.onclick=()=>{je[t].buttonTwo.action(this.options.timingData,this.options.type),this.close()}}}const Ca={BPMS:{title:"BPM Event",rows:[{label:"Tempo",key:"value",input:{type:"spinner"}}]},STOPS:{title:"Stop Event",description:"Stops for a number of seconds. Notes on this beat are hit before the stop occurs.",rows:[{label:"Seconds",key:"value",input:{type:"spinner"}}]},WARPS:{title:"Warp Event",description:"Warps ahead a number of beats. Warped notes do not count towards score.",rows:[{label:"Beats",key:"value",input:{type:"spinner",min:0,step:1/48}}]},DELAYS:{title:"Delay Event",description:"Stops for a number of seconds. Notes on this beat are hit after the delay occurs.",rows:[{label:"Seconds",key:"value",input:{type:"spinner"}}]},SCROLLS:{title:"Scroll Event",description:"Notes after this event will scroll at the specified speed.",rows:[{label:"Multiplier",key:"value",input:{type:"spinner"}}]},TICKCOUNTS:{title:"Tickcount Event",description:"Number of ticks per beat in a hold. Only applies to pump gamemodes.",rows:[{label:"Ticks",key:"value",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:0}}]},FAKES:{title:"Fake Event",description:"Creates an area of notes that cannot be hit and do not count towards score.",rows:[{label:"Beats",key:"value",input:{type:"spinner",min:0,step:1/48}}]},LABELS:{title:"Label Event",rows:[{label:"Label",key:"value",input:{type:"text"}}]},SPEEDS:{title:"Speed Event",width:200,description:"The entire playfield scrolls at the specified speed. Can slowly ease over a certain amount of time.",rows:[{label:"Multiplier",key:"value",input:{type:"spinner"}},{label:"Ease time",key:"delay",input:{type:"spinner",min:0}},{label:"Ease unit",key:"unit",input:{type:"dropdown",items:["Beats","Seconds"],transformers:{serialize:i=>i=="B"?"Beats":"Seconds",deserialize:i=>i=="Beats"?"B":"T"}}}]},TIMESIGNATURES:{title:"Time Signature Event",width:200,rows:[{label:"Upper",key:"upper",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:1}},{label:"Lower",key:"lower",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:1}}]},COMBOS:{title:"Combo Event",width:200,description:"Multiplies the combo gained from hitting/missing notes after this event.",rows:[{label:"Hit multiplier",key:"hitMult",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:0}},{label:"Miss multiplier",key:"missMult",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:0}}]},ATTACKS:{title:"Attack Event",width:200,description:"Applies a modifier to the playfield. Can specify the length of the applied attack in seconds or the end time of the attack.",rows:[{label:"Timing type",key:"endType",input:{type:"dropdown",items:["Length","End"],transformers:{serialize:i=>i=="LEN"?"Length":"End",deserialize:i=>i=="Length"?"LEN":"END"}}},{label:"Seconds",key:"value",input:{type:"spinner"}},{label:"Mods",key:"mods",input:{type:"text"}}]},BGCHANGES:{title:"BG Change Event",width:250,rows:[{label:"File",key:"file",input:{type:"text"}},{label:"Update rate",key:"updateRate",input:{type:"spinner",precision:3,min:0}},{label:"Crossfade",key:"crossfade",input:{type:"checkbox"}},{label:"StretchRewind",key:"stretchRewind",input:{type:"checkbox"}},{label:"StretchNoLoop",key:"StretchNoLoop",input:{type:"checkbox"}},{label:"Effect",key:"effect",input:{type:"text"}},{label:"File2",key:"file2",input:{type:"text"}},{label:"Transition",key:"transition",input:{type:"text"}},{label:"Color1",key:"color1",input:{type:"text"}},{label:"Color2",key:"color2",input:{type:"text"}}]},FGCHANGES:{title:"FG Change Event",width:250,rows:[{label:"File",key:"file",input:{type:"text"}},{label:"Update rate",key:"updateRate",input:{type:"spinner",precision:3,min:0}},{label:"Crossfade",key:"crossfade",input:{type:"checkbox"}},{label:"StretchRewind",key:"stretchRewind",input:{type:"checkbox"}},{label:"StretchNoLoop",key:"StretchNoLoop",input:{type:"checkbox"}},{label:"Effect",key:"effect",input:{type:"text"}},{label:"File2",key:"file2",input:{type:"text"}},{label:"Transition",key:"transition",input:{type:"text"}},{label:"Color1",key:"color1",input:{type:"text"}},{label:"Color2",key:"color2",input:{type:"text"}}]}};class Ke extends Ui{static options;static cachedEvent;static rows=[];static onTimingChange;static open(e){this.active||(super._open({...e,attach:e.box.backgroundObj,title:Ca[e.box.event.type].title,description:Ca[e.box.event.type].description,width:Ca[e.box.event.type].width??150,editable:!0,cancelableOnOpen:!1,background:En(Ei[e.box.event.type].toString(16).padStart(6,"0"),"#333333",.75),textColor:"#ffffff",options:[{label:"Ok",type:"confirm",callback:()=>{this.close(),this.options.onConfirm(this.cachedEvent)}},{label:"Delete",type:"delete",callback:()=>{this.options.modifyBox||this.options.timingData.delete([{type:this.cachedEvent.type,[this.cachedEvent.type=="ATTACKS"?"second":"beat"]:this.cachedEvent.type=="ATTACKS"?this.cachedEvent.second:this.cachedEvent.beat}]),this.close()}}]}),this.cachedEvent=structuredClone(e.box.event),this.onTimingChange=this.updateValues.bind(this),ie.on("timingModified",this.onTimingChange))}static buildContent(){const e=Ca[this.options.box.event.type],t=document.createElement("div");t.classList.add("popup-grid"),this.view.appendChild(t),e.rows.forEach(n=>t.append(...this.buildRow(n)))}static buildRow(e){const t=structuredClone(this.options.box.event),n=document.createElement("div");n.innerText=e.label,n.classList.add("popup-label");const a=[];switch(a.push(n),e.input.type){case"spinner":{const r=ht.create({value:t[e.key],precision:Vc,minPrecision:Ti,...e.input});r.onchange=s=>{s!==void 0&&this.modifyEvent(e.key,s)},this.rows.push({data:e,el:r}),a.push(r.view);break}case"text":{const r=document.createElement("input");r.type="text",r.autocomplete="off",r.spellcheck=!1,r.onkeydown=s=>{s.key=="Enter"&&r.blur()},r.onblur=()=>{this.modifyEvent(e.key,r.value)},r.value=t[e.key],this.rows.push({data:e,el:r}),a.push(r);break}case"dropdown":{if(e.input.transformers){const r=e.input.transformers.deserialize,s=e.input.transformers.serialize,o=gi.create(e.input.items,s(t[e.key]));o.onChange(l=>{this.modifyEvent(e.key,r(l))}),this.rows.push({data:e,el:o}),a.push(o.view)}else{const r=gi.create(e.input.items,t[e.key]);r.onChange(s=>{this.modifyEvent(e.key,s)}),this.rows.push({data:e,el:r}),a.push(r.view)}break}case"checkbox":{const r=document.createElement("input");r.type="checkbox",r.checked=t[e.key],r.onchange=()=>{this.modifyEvent(e.key,r.checked)},this.rows.push({data:e,el:r}),a.push(r);break}}return a}static modifyEvent(e,t){this.options.modifyBox?Object.assign(this.options.box.event,{[e]:t}):this.options.timingData.modify([[structuredClone(this.options.box.event),Object.assign(this.options.box.event,{[e]:t})]]),this.cachedEvent=structuredClone(this.options.box.event)}static updateValues(){const e=this.options.timingData.getEventAtBeat(this.options.box.event.type,this.options.box.event.beat,!1);if(!this.options.box||!e||e.beat!=this.options.box.event.beat){this.close();return}this.rows.forEach(t=>{switch(t.data.input.type){case"spinner":{t.el.value=e[t.data.key];break}case"text":{t.el.value=e[t.data.key];break}case"dropdown":{const n=t.el;t.data.input.transformers?n.setSelected(t.data.input.transformers.serialize(e[t.data.key])):n.setSelected(e[t.data.key]);break}case"checkbox":{t.el.checked=e[t.data.key];break}}})}static close(){this.active&&(super.close(),ie.off("timingModified",this.onTimingChange))}static getEvent(){return this.cachedEvent}static attach(e){super.attach(e.backgroundObj),this.options.box=e,this.cachedEvent=e.event}}const Fa={fontName:"Main",fontSize:15},Wt={BPMS:55,STOPS:55,DELAYS:55,WARPS:55,FAKES:55,COMBOS:40,SPEEDS:80,LABELS:80,SCROLLS:55,TIMESIGNATURES:40,TICKCOUNTS:40,BGCHANGES:55,FGCHANGES:55,ATTACKS:55};class Og extends de{isEditGUI=!0;tracks=new de;renderer;timingBoxMap=new Map;wasEditingTiming=!1;boxPool=new Ot({create:()=>{const e=new de;return e.textObj=new ge("",Fa),e.backgroundObj=new lt,e.selection=new lt("onlyBorder"),e.selection.tint=3841008,e.addChild(e.backgroundObj,e.textObj,e.selection),e}});ghostBox;timingDirty=!1;tracksDirty=!0;constructor(e){super(),this.renderer=e,this.boxPool.sortableChildren=!0,this.sortableChildren=!0,this.addChild(this.tracks,this.boxPool);const t=()=>{this.timingDirty=!0,this.tracksDirty=!0},n=a=>{a.startsWith("chart.timingEventOrder")&&(this.tracksDirty=!0)};ie.on("timingModified",t),ie.on("userOptionUpdated",n),this.on("destroyed",()=>{ie.off("timingModified",t),ie.off("userOptionUpdated",n)})}update(e,t){this.renderer.chartManager.editTimingMode!=Se.Add&&(this.ghostBox?.removeFromParent(),this.ghostBox?.destroy(),this.ghostBox=void 0);const n=this.wasEditingTiming!=(this.renderer.chartManager.editTimingMode!=Se.Off&&this.renderer.chartManager.getMode()==W.Edit);this.updateTracks(),this.updateBoxes(e,t,n)}createTrack(e,t){const n=Object.assign(new de,{alpha:0,name:e,x:t,type:e,timingMode:"song",background:new ye(xe.WHITE),btns:new de});n.background=new ye(xe.WHITE),n.background.width=Wt[e],n.background.height=5e3,n.background.tint=2503250,n.background.anchor.y=.5,n.background.alpha=0,n.btns.y=this.renderer.getActualReceptorYPos()+(b.chart.reverse?50:-50);const a=new de,r=new lt,s=new ge(e,Fa);return r.width=20,r.height=20,ze(r,"widget-bg"),r.pivot.set(10,10),s.anchor.set(.5,.55),s.text="S",ze(s,"text-color"),a.alpha=.4,a.name="timingTypeBtn",a.eventMode="static",a.on("mouseenter",()=>{wi.persistent||wi.open({attach:a,type:e,timingData:this.renderer.chart.timingData})}),a.on("mouseleave",()=>{wi.persistent||wi.close()}),a.on("pointerdown",()=>{wi.persistent&&wi.open({attach:a,type:e,timingData:this.renderer.chart.timingData}),wi.select()}),a.addChild(r,s),n.btns.addChild(a),n.addChild(n.background,n.btns),this.tracks.addChild(n),n}initializeBox(e,t){if(rt.stop(e.animationId),Object.assign(e,{event:t,lastX:void 0,lastAnchor:void 0,animationId:void 0,zIndex:t.beat,eventMode:"static"}),e.textObj.text=this.getLabelFromEvent(t),e.textObj.anchor.set(.5,.55),e.backgroundObj.width=e.textObj.width+10,e.backgroundObj.height=25,e.backgroundObj.position.x=-e.backgroundObj.width/2,e.backgroundObj.position.y=-25/2,e.selection.width=e.textObj.width+10,e.selection.height=25,e.selection.position=e.backgroundObj.position,Ke.active){const n=Ke.getEvent();n.type=="ATTACKS"&&t.type=="ATTACKS"&&n.second==t.second&&Ke.attach(e),n.type!="ATTACKS"&&t.type!="ATTACKS"&&n.type==t.type&&n.beat==t.beat&&Ke.attach(e)}}addDragListeners(e,t){e.cursor="pointer",e.on("mouseenter",()=>{Ke.persistent||this.renderer.chartManager.eventSelection.timingEvents.length>0||this.renderer.isDragSelecting()||(Ke.active&&Ke.close(),this.renderer.chartManager.getMode()==W.Edit&&Ke.open({box:e,timingData:this.getTargetTimingData(e.event),modifyBox:!1,onConfirm:()=>{this.renderer.chartManager.removeEventFromSelection(t)}}))}),e.on("mouseleave",()=>{Ke.persistent||Ke.close()});let n=0,a;const r=s=>{const o=a,l=this.toLocal(s.global);if(Math.abs(l.y-n)<32){this.renderer.chartManager.eventSelection.shift&&(this.renderer.chartManager.eventSelection.shift={beatShift:0});return}Ke.close();const u=this.renderer.getBeatFromYPos(l.y),f=b.chart.snap==0?1/48:b.chart.snap;let c=Math.round(u/f)*f;Math.abs(c-u)>Math.abs(u-o.beat)&&(c=o.beat),this.renderer.chartManager.eventSelection.shift||={beatShift:0},this.renderer.chartManager.eventSelection.shift.beatShift=Math.max(-Math.min(...this.renderer.chartManager.eventSelection.timingEvents.map(d=>d.beat)),c-o.beat)};e.on("pointerdown",s=>{if(qa(s)){this.renderer.chartManager.clearSelections(),this.renderer.chartManager.addEventToSelection(t),Ke.close();return}if(s.stopImmediatePropagation(),this.renderer.chartManager.isEventInSelection(t)?(s.getModifierState("Control")||s.getModifierState("Meta"))&&this.renderer.chartManager.removeEventFromSelection(t):(!s.getModifierState("Control")&&!s.getModifierState("Meta")&&!s.getModifierState("Shift")&&this.renderer.chartManager.clearSelections(),this.renderer.chartManager.addEventToSelection(t)),this.renderer.chartManager.getMode()==W.Edit&&this.renderer.chartManager.eventSelection.timingEvents.length==1&&Ke.options?.box!=e&&(Ke.close(),Ke.open({box:e,timingData:this.getTargetTimingData(e.event),modifyBox:!1,onConfirm:()=>{this.renderer.chartManager.removeEventFromSelection(t)}})),Ke.active&&!s.getModifierState("Control")&&!s.getModifierState("Meta")&&!s.getModifierState("Shift")?Ke.select():Ke.close(),n=e.y,a=t,this.renderer.chartManager.editTimingMode==Se.Add)return;this.renderer.on("pointermove",r);const o=()=>{this.renderer.off("pointermove",r),this.renderer.off("pointerup",o),(this.renderer.chartManager.eventSelection.shift?.beatShift??0)!=0&&this.renderer.chartManager.modifyEventSelection(l=>(l.type=="ATTACKS"&&(l.second=this.renderer.chart.timingData.getSecondsFromBeat(l.beat+this.renderer.chartManager.eventSelection.shift.beatShift)),l.beat+=this.renderer.chartManager.eventSelection.shift.beatShift,l)),this.renderer.chartManager.eventSelection.shift=void 0};this.renderer.on("pointerup",o)})}updateTracks(){const e=this.renderer.chartManager.editTimingMode!=Se.Off&&this.renderer.chartManager.getMode()==W.Edit;if(e&&this.tracks.children.forEach(s=>{s.btns.y=this.renderer.getActualReceptorYPos()+(b.chart.reverse?50:-50)}),!this.tracksDirty&&this.wasEditingTiming==e)return;this.wasEditingTiming=e,this.tracksDirty=!1;const t=b.chart.timingEventOrder.left,n=b.chart.timingEventOrder.right;this.tracks.children.forEach(s=>{s.visible=!1});let a=-this.renderer.chart.gameType.notefieldWidth*.5-128;const r=(s,o,l,u,f)=>{rt.animate(s,{0:{[o]:"inherit"},1:{[o]:l}},b.general.smoothAnimations?u:0,pt(0,0,.16,1.01),()=>{},f)};for(let s=t.length-1;s>=0;s--){const o=t[s],l=this.tracks.getChildByName(o)??this.createTrack(o,a);l.visible=!0;const u=s%2==0?.1:0;r(l,"x",a,.3,`track-${o}-x`),r(l.btns,"x",-Wt[o]/2,.3,`track-${o}-btn-x`),r(l.background,"anchor.x",1,.3,`track-${o}-anchor-x`),r(l.background,"alpha",e?u:0,.3,`track-${o}-bg-alpha`),a-=Wt[o]}a=this.renderer.chart.gameType.notefieldWidth*.5+128;for(let s=0;s<n.length;s++){const o=n[s],l=this.tracks.getChildByName(o)??this.createTrack(o,a);l.visible=!0;const u=s%2==0?.1:0;r(l,"x",a,.3,`track-${o}-x`),r(l.btns,"x",Wt[o]/2,.3,`track-${o}-btn-x`),r(l.background,"anchor.x",0,.3,`track-${o}-anchor-x`),r(l.background,"alpha",e?u:0,.3,`track-${o}-bg-alpha`),a+=Wt[o]}for(const s of this.tracks.children)r(s,"alpha",e?1:0,.3,`track-${s.type}-alpha`);e||wi.close(),this.tracks.children.forEach(s=>{const o=s.btns.getChildByName("timingTypeBtn"),l=o?.children[1];o&&(o.eventMode=e?"static":"none"),l&&(l.text=this.renderer.chart.timingData.isPropertyChartSpecific(s.type)?"C":"S")})}updateBoxes(e,t,n){this.timingDirty&&(this.timingBoxMap.clear(),this.boxPool.destroyAll(),this.timingDirty=!1);const a=this.renderer.chartManager.editTimingMode!=Se.Off&&this.renderer.chartManager.getMode()==W.Edit;this.ghostBox&&(this.ghostBox.visible=this.renderer.shouldDisplayEditGUI()&&a);for(const r of this.renderer.chart.timingData.getTimingData()){if(t<r.beat)break;if(!(!b.chart.timingEventOrder.left.includes(r.type)&&!b.chart.timingEventOrder.right.includes(r.type))&&!(e>r.beat)&&!this.timingBoxMap.has(r)){const s=this.boxPool.createChild(),o=b.chart.timingEventOrder.right.includes(r.type)?"right":"left";if(!s)break;if(this.initializeBox(s,r),this.addDragListeners(s,r),this.timingBoxMap.set(r,s),a){let l=this.tracks.getChildByName(r.type)?.x??s.x;l+=Wt[r.type]/2*(l>0?1:-1),s.x=l,s.pivot.x=0}else{const l=o=="left"?-b.chart.timingEventOrder.left.indexOf(r.type):b.chart.timingEventOrder.right.indexOf(r.type);Yt.instance.register(s,r.beat,r.second,o,l,!1)}}}for(const[r,s]of this.timingBoxMap.entries()){if(r.beat<e||r.beat>t||!b.chart.timingEventOrder.left.includes(r.type)&&!b.chart.timingEventOrder.right.includes(r.type)){this.timingBoxMap.delete(r),Ke.options?.box==s?Ke.detach():Ke.persistent||Ke.close(),this.boxPool.destroyChild(s);continue}const o=b.chart.timingEventOrder.right.includes(r.type)?"right":"left",l=o=="left"?-b.chart.timingEventOrder.left.indexOf(r.type):b.chart.timingEventOrder.right.indexOf(r.type);if(Yt.instance.updatePriority(s,l),Yt.instance.updateAlign(s,o),n)if(a){Yt.instance.deregister(s);let f=this.tracks.getChildByName(r.type)?.x??s.x;f+=Wt[r.type]/2*(f>0?1:-1),s.animationId=rt.animate(s,{0:{x:"inherit","pivot.x":"inherit"},1:{x:f,"pivot.x":0}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},s.animationId),s.lastX=f}else rt.stop(s.animationId),Yt.instance.register(s,r.beat,r.second,o,l,!0);if(a){s.y=b.chart.CMod?this.renderer.getYPosFromSecond(r.second):this.renderer.getYPosFromBeat(r.beat);let f=this.tracks.getChildByName(r.type)?.x??s.x;f+=Wt[r.type]/2*(f>0?1:-1),s.lastX!=f&&(s.animationId=rt.animate(s,{0:{x:"inherit","pivot.x":"inherit"},1:{x:f,"pivot.x":0}},b.general.smoothAnimations?.3:0,pt(0,0,.16,1.01),()=>{},s.animationId),s.lastX=f)}const u=this.renderer.shouldDisplayEventSelection(r);if(s.backgroundObj.tint=u?bo(Ei[r.type]??0,Math.sin(Date.now()/320)*.4+1.5):Ei[r.type]??0,s.selection.alpha=u?1:0,s.visible=!u||!this.renderer.chartManager.eventSelection.shift,this.renderer.chartManager.editTimingMode!=Se.Off){const f=this.renderer.selectionTest(s);!u&&f&&this.renderer.chartManager.addEventToDragSelection(r),u&&!f&&this.renderer.chartManager.removeEventFromDragSelection(r)}}}updateGhostEvent(e){const t=b.chart.snap==0?.020833333333333332:b.chart.snap,n=Math.round(this.renderer.getBeatFromYPos(e.y)/t)*t,a=Ke.active&&Ke.options?.box==this.ghostBox,r=a?this.ghostBox.event.type:this.getClosestTrack(e.x)?.name;if(!r){this.ghostBox?.removeFromParent(),this.ghostBox?.destroy(),this.ghostBox=void 0;return}if(!this.ghostBox){const l=new de;l.textObj=new ge("",Fa),l.backgroundObj=new lt,l.selection=new lt("onlyBorder"),l.guideLine=new ye(xe.WHITE),l.selection.tint=3841008,l.selection.alpha=0,l.addChild(l.guideLine,l.backgroundObj,l.textObj,l.selection),this.addChild(l),l.visible=this.renderer.shouldDisplayEditGUI(),l.textObj.anchor.set(.5,.55),l.backgroundObj.height=25,l.selection.height=25,l.guideLine.height=1,l.guideLine.anchor.y=.5,this.ghostBox=l}!a&&(this.ghostBox.event?.beat!=n||this.ghostBox.event?.type!=r)&&(this.ghostBox.event=structuredClone(this.renderer.chart.timingData.getEventAtBeat(r,n))??this.renderer.chart.timingData.getDefaultEvent(r,n),this.ghostBox.event.beat=n,r=="ATTACKS"&&(this.ghostBox.event.second=this.renderer.chart.getSecondsFromBeat(n)),this.ghostBox.textObj.text=this.getLabelFromEvent(this.ghostBox.event),this.ghostBox.backgroundObj.width=this.ghostBox.textObj.width+10,this.ghostBox.selection.width=this.ghostBox.textObj.width+10),this.ghostBox.alpha=a?1:.4,this.ghostBox.selection.alpha=a?1:0,this.ghostBox.name=r;const s=this.renderer.getYPosFromBeat(a?this.ghostBox.event.beat:n);let o=this.tracks.getChildByName(r).x;o+=Wt[r]/2*(o>0?1:-1),this.ghostBox.position.x=o,this.ghostBox.backgroundObj.tint=Ei[r]??0,this.ghostBox.backgroundObj.position.x=-this.ghostBox.backgroundObj.width/2,this.ghostBox.backgroundObj.position.y=-25/2,this.ghostBox.guideLine.anchor.x=o<0?0:1,this.ghostBox.guideLine.width=Math.abs(this.ghostBox.position.x)+192-this.ghostBox.backgroundObj.width/2,this.ghostBox.guideLine.position.x=(o<0?1:-1)*this.ghostBox.backgroundObj.width/2,this.ghostBox.y=s,this.ghostBox.selection.position=this.ghostBox.backgroundObj.position}placeGhostEvent(){if(!this.ghostBox)return;const e=this.renderer.chart.timingData.getEventAtBeat(this.ghostBox.event.type,this.ghostBox.event.beat,!1);this.ghostBox.event.type=="ATTACKS"&&this.ghostBox.event.second==e?.second||this.ghostBox.event.type!="ATTACKS"&&this.ghostBox.event.beat==e?.beat||(this.renderer.chartManager.clearSelections(),Ke.open({box:this.ghostBox,timingData:this.getTargetTimingData(this.ghostBox.event),modifyBox:!0,onConfirm:t=>{this.getTargetTimingData(this.ghostBox.event).insert([t])}}),Ke.select())}getClosestTrack(e){let t=Number.MAX_SAFE_INTEGER,n=this.tracks.children[0];for(const a of this.tracks.children){const r=Math.abs(a.x+(.5-a.background.anchor.x)*a.width-e);r<t&&(n=a,t=r)}if(!(t>n.width))return n}getLabelFromEvent(e){let t="";switch(e.type){case"BPMS":case"STOPS":case"WARPS":case"DELAYS":case"TICKCOUNTS":case"FAKES":case"SCROLLS":t=he(e.value,Ti).toString();break;case"SPEEDS":t=`${he(e.value,Ti)}/${he(e.delay,Ti)}/${e.unit}`;break;case"LABELS":t=e.value;break;case"TIMESIGNATURES":t=`${he(e.upper,Ti)}/${he(e.lower,Ti)}`;break;case"COMBOS":t=`${he(e.hitMult,Ti)}/${he(e.missMult,3)}`;break;case"BGCHANGES":case"FGCHANGES":t=e.file;break;case"ATTACKS":t=`${e.mods}`}return t}getTargetTimingData(e){return this.renderer.chart.timingData.isPropertyChartSpecific(e.type)?this.renderer.chart.timingData:this.renderer.chart.timingData.songTimingData}}class Ng extends de{isEditGUI=!0;children=[];renderer;timingBoxMap=new Map;trackPosCache=new Map;timingBoxPool=new Ot({create:()=>{const e=new de;return e.guideLine=new ye(xe.WHITE),e.textObj=new ge("",Fa),e.backgroundObj=new lt,e.addChild(e.guideLine,e.backgroundObj,e.textObj),e}});constructor(e){super(),this.renderer=e,this.timingBoxPool.sortableChildren=!0,this.addChild(this.timingBoxPool)}update(e,t){if(!this.renderer.chartManager.eventSelection.shift){this.timingBoxPool.destroyAll(),this.timingBoxMap.clear(),this.trackPosCache.clear();return}const n=this.renderer.chartManager.eventSelection.shift.beatShift;for(const a of this.renderer.chartManager.eventSelection.timingEvents)if(!(t<a.beat+n)&&!(e>a.beat+n)&&!this.timingBoxMap.has(a)){const r=this.timingBoxPool.createChild();if(!r)continue;this.timingBoxMap.set(a,r);let s="";switch(a.type){case"BPMS":case"STOPS":case"WARPS":case"DELAYS":case"TICKCOUNTS":case"FAKES":case"SCROLLS":s=he(a.value,3).toString();break;case"SPEEDS":s=`${he(a.value,3)}/${he(a.delay,3)}/${a.unit}`;break;case"LABELS":s=a.value;break;case"TIMESIGNATURES":s=`${he(a.upper,3)}/${he(a.lower,3)}`;break;case"COMBOS":s=`${he(a.hitMult,3)}/${he(a.missMult,3)}`;break;case"BGCHANGES":case"FGCHANGES":s=a.file;break;case"ATTACKS":s=`${a.mods} (${a.endType}=${a.value})`}const o=b.chart.timingEventOrder.right.includes(a.type)?"right":"left";if(Object.assign(r,{alpha:.4,zIndex:a.beat}),r.textObj.text=s,r.textObj.anchor.set(.5,.55),r.backgroundObj.width=r.textObj.width+10,r.backgroundObj.height=25,r.backgroundObj.tint=Ei[a.type]??0,r.backgroundObj.position.x=-r.backgroundObj.width/2,r.backgroundObj.position.y=-r.backgroundObj.height/2,r.guideLine.height=1,r.guideLine.anchor.set(o=="left"?0:1,.5),r.guideLine.width=Math.abs(r.position.x)+192-r.backgroundObj.width/2,r.guideLine.position.x=(o=="left"?1:-1)*r.backgroundObj.width/2,this.renderer.chartManager.editTimingMode!=Se.Off){let l=this.getTrackPos(a.type);l+=Wt[a.type]/2*(l>0?1:-1),r.position.x=l,r.pivot.x=0}else{let l=(o=="right"?1:-1)*(this.renderer.chart.gameType.notefieldWidth*.5+80);o=="left"&&(l-=30),r.position.x=l,r.pivot.x=o=="right"?-r.backgroundObj.width/2:r.backgroundObj.width/2}}for(const[a,r]of this.timingBoxMap.entries()){if(t<a.beat+n||e>a.beat+n){this.timingBoxPool.destroyChild(r),this.timingBoxMap.delete(a);continue}r.y=b.chart.CMod&&a.second?this.renderer.getYPosFromSecond(a.second):this.renderer.getYPosFromBeat(a.beat+n)}}getTrackPos(e){if(this.trackPosCache.has(e))return this.trackPosCache.get(e);const t=b.chart.timingEventOrder.left,n=b.chart.timingEventOrder.right;let a=-this.renderer.chart.gameType.notefieldWidth*.5-128;for(let r=t.length-1;r>=0;r--){const s=t[r];this.trackPosCache.set(s,a),a-=Wt[s]}a=this.renderer.chart.gameType.notefieldWidth*.5+128;for(let r=0;r<n.length;r++){const s=n[r];this.trackPosCache.set(s,a),a+=Wt[s]}return this.trackPosCache.get(e)??0}}class Hg extends de{chartManager;chart;speedMult=1;lastMousePos;lastMouseBeat=-1;lastMouseCol=-1;lastNoteType=null;lastHoldBeat=null;editingCol=-1;cachedBeat=0;cachedTime=0;waveform;barlines;timingAreas;timingTracks;techIndicators;techErrors;candleIndicator;selectedEvents;timingBar;notefield;snapDisplay;judgement;combo;selectionBoundary;selectionArea;previewArea;scrollDebug;parityDebug;selectionBounds;constructor(e){super(),this.chartManager=e,this.chart=e.loadedChart,this.waveform=new gg(this),this.barlines=new og(this),this.timingAreas=new Hm(this),this.timingTracks=new Og(this),this.techIndicators=new pg(this),this.techErrors=new fg(this),this.candleIndicator=new lg(this),this.selectedEvents=new Ng(this),this.timingBar=new Pg(this),this.notefield=new Ic(this),this.snapDisplay=new Gm(this),this.previewArea=new cg(this),this.selectionArea=new dg(this),this.judgement=new Rg,this.combo=new Bg(this),this.selectionBoundary=new hg(this),this.scrollDebug=new ug(this),this.parityDebug=new Pm(this),this.addChild(this.waveform,this.barlines,this.timingAreas,this.previewArea,this.selectionArea,this.timingTracks,this.candleIndicator,this.techIndicators,this.techErrors,this.selectedEvents,this.timingBar,this.combo,this.notefield,this.snapDisplay,this.judgement,this.selectionBoundary,this.scrollDebug,this.parityDebug),new Yt(this),this.chartManager.app.stage.addChild(this),this.eventMode="static",this.hitArea=new Kn(-1e5,-1e5,2e5,2e5);const t=r=>{if(this.editingCol!=-1){const s=b.chart.snap==0?.020833333333333332:b.chart.snap,o=Math.round(this.getBeatFromYPos(this.lastMousePos.y)/s)*s;this.chartManager.editHoldBeat(this.editingCol,o,r.shiftKey)}};let n=0;const a=()=>{this.selectionBounds&&(this.selectionBounds.lastKnownBeat!=this.cachedBeat&&(this.selectionBounds.endBeat+=this.cachedBeat-this.selectionBounds.lastKnownBeat,this.selectionBounds.lastKnownBeat=this.cachedBeat,this.selectionBoundary.update()),n!=0&&(this.chartManager.beat=Math.max(0,this.chartManager.beat+n),this.selectionBounds.endBeat+=n,this.selectionBoundary.update()))};vt.shared.add(a),window.addEventListener("keydown",t),this.on("destroyed",()=>{window.removeEventListener("keydown",t),this.removeAllListeners(),vt.shared.remove(a)}),this.on("pointerdown",r=>{qa(r)||this.chartManager.getMode()==W.Play||this.chartManager.getMode()==W.View||(this.chartManager.editTimingMode==Se.Add&&this.lastMousePos?this.timingTracks.placeGhostEvent():this.chartManager.editTimingMode==Se.Off&&b.chart.mousePlacement&&this.lastMouseBeat!=-1&&this.lastMouseCol!=-1&&!r.getModifierState("Shift")?(this.chartManager.clearSelections(),this.editingCol=this.lastMouseCol,this.lastHoldBeat=null,this.chartManager.setNote(this.lastMouseCol,"mouse",this.lastMouseBeat)):(!r.getModifierState("Control")&&!r.getModifierState("Meta")&&!r.getModifierState("Shift")&&this.chartManager.clearSelections(),this.chartManager[this.chartManager.editTimingMode==Se.Off?"startDragSelection":"startDragEventSelection"](),this.selectionBounds={startX:this.toLocal(r.global).x,startBeat:this.getBeatFromYPos(this.toLocal(r.global).y),endX:this.toLocal(r.global).x,endBeat:this.getBeatFromYPos(this.toLocal(r.global).y),lastKnownBeat:this.cachedBeat},this.selectionBoundary.update()))}),this.on("mousemove",r=>{if(this.lastMousePos=this.toLocal(r.global),this.editingCol!=-1){const s=b.chart.snap==0?.020833333333333332:b.chart.snap,o=Math.round(this.getBeatFromYPos(this.lastMousePos.y)/s)*s;this.lastHoldBeat!=o&&(this.lastHoldBeat=o,this.chartManager.editHoldBeat(this.editingCol,o,r.shiftKey))}this.selectionBounds&&(this.selectionBounds.endBeat=this.getBeatFromYPos(this.toLocal(r.global).y),this.selectionBounds.endX=this.toLocal(r.global).x,this.selectionBounds.lastKnownBeat=this.cachedBeat,this.selectionBoundary.update()),n=Math.max(0,this.lastMousePos.y-this.getLowerBound()+100)/600,this.lastMousePos.y<0&&(n=Math.min(0,this.lastMousePos.y-this.getUpperBound()-100)/600),b.chart.reverse&&(n=Math.max(0,this.getUpperBound()-this.lastMousePos.y+100)/600,this.lastMousePos.y>0&&(n=Math.min(0,this.getLowerBound()-this.lastMousePos.y-100)/600))}),this.on("pointerup",()=>{this.editingCol!=-1&&(this.chartManager.endEditing(this.editingCol),this.editingCol=-1),this.chartManager[this.chartManager.editTimingMode==Se.Off?"endDragSelection":"endDragEventSelection"](),this.selectionBounds=void 0,this.selectionBoundary.update(),n=0})}isDragSelecting(){return!!this.selectionBounds}doJudgement(e,t,n){this.chartManager.getMode()==W.Play&&(this.judgement.doJudge(t,n),this.timingBar.addBar(t,n)),this.notefield.onJudgement(e.col,n)}startPlay(){this.notefield.startPlay()}endPlay(){this.notefield.endPlay(),this.timingBar.reset(),this.judgement.reset()}update(){if(this.destroyed)return;this.cachedBeat=this.chartManager.beat,this.cachedTime=this.chartManager.time,this.x=b.chart.receptorXPos,this.speedMult=b.chart.doSpeedChanges?this.getCurrentSpeedMult():1;const e=this.getTopOnScreenBeat(),t=this.getBottomOnScreenBeat(),n=Math.min(e,t),a=Math.max(e,t);if(this.scale.x=b.chart.zoom,this.scale.y=b.chart.zoom,this.children.forEach(r=>{if(r.isEditGUI&&!this.shouldDisplayEditGUI()){r.visible=!1;return}r.visible=!0,r.update(n,a)}),Yt.instance.update(),this.notefield.alpha=this.chartManager.editTimingMode==Se.Off||this.chartManager.getMode()==W.Play?1:.3,b.chart.mousePlacement&&this.lastMousePos&&this.chartManager.getMode()!=W.Play){const r=b.chart.snap==0?.020833333333333332:b.chart.snap,s=Math.round(this.getBeatFromYPos(this.lastMousePos.y)/r)*r;let o=-1;for(let l=0;l<this.chart.gameType.numCols;l++){const u=this.chart.gameType.columnWidths[l],f=this.getXPosFromColumn(l);if(this.lastMousePos.x<f+u/2&&this.lastMousePos.x>f-u/2){o=l;break}}(s!=this.lastMouseBeat||o!=this.lastMouseCol||this.chartManager.getEditingNoteType()!=this.lastNoteType)&&(this.lastMouseBeat=s,this.lastMouseCol=o,this.lastNoteType=this.chartManager.getEditingNoteType(),this.editingCol!=-1&&this.chartManager.editHoldBeat(this.editingCol,s,!1),o===-1?(this.lastMouseBeat=-1,this.lastMouseCol=-1,this.notefield.setGhostNote()):this.notefield.setGhostNote(this.chart.computeNote({beat:s,col:this.lastMouseCol,type:this.chartManager.getEditingNoteType()})))}this.lastMousePos&&this.chartManager.editTimingMode==Se.Add&&this.timingTracks.updateGhostEvent(this.lastMousePos)}getTimeWithOffset(){let e=this.cachedTime;return(this.chartManager.getMode()==W.Play||this.chartManager.getMode()==W.Record)&&(e+=b.play.offset*b.audio.rate),e}getBeatWithOffset(){let e=this.cachedBeat;return(this.chartManager.getMode()==W.Play||this.chartManager.getMode()==W.Record)&&(e=this.chart.getBeatFromSeconds(this.getTimeWithOffset())),e}getVisualTime(){let e=this.cachedTime;return(this.chartManager.getMode()==W.Play||this.chartManager.getMode()==W.Record)&&(e+=(b.play.offset+b.play.visualOffset)*b.audio.rate),e}getVisualBeat(){let e=this.cachedBeat;return(this.chartManager.getMode()==W.Play||this.chartManager.getMode()==W.Record)&&(e=this.chart.getBeatFromSeconds(this.getVisualTime())),e}getXPosFromColumn(e){return this.notefield.getColumnX(e)}getYPosFromBeat(e){const t=this.getVisualTime(),n=this.getVisualBeat(),a=b.chart.reverse?-1:1;return b.chart.CMod?(this.chart.getSecondsFromBeat(e)-t)*this.getSecondsToPixelsRatio()*a+this.getActualReceptorYPos():n==e?this.getActualReceptorYPos():(b.chart.doSpeedChanges?this.chart.timingData.getEffectiveBeat(e)-this.chart.timingData.getEffectiveBeat(n):e-n)*this.getEffectiveBeatsToPixelsRatio()*a+this.getActualReceptorYPos()}getYPosFromSecond(e){const t=this.getVisualTime(),n=b.chart.reverse?-1:1;return b.chart.CMod?(e-t)*this.getSecondsToPixelsRatio()*n+this.getActualReceptorYPos():this.getYPosFromBeat(this.chart.timingData.getBeatFromSeconds(e))}getSecondFromYPos(e){const t=b.chart.reverse?-1:1;if(b.chart.CMod){const n=this.getPixelsToSecondsRatio(),a=this.getVisualTime(),s=(e-this.getActualReceptorYPos())*n*t;return a+s}return this.chart.getSecondsFromBeat(this.getBeatFromYPos(e))}getBeatFromYPos(e,t){const n=this.getVisualBeat(),a=b.chart.reverse?-1:1;if(b.chart.CMod)return this.chart.getBeatFromSeconds(this.getSecondFromYPos(e));const s=(e-this.getActualReceptorYPos())*this.getPixelsToEffectiveBeatsRatio()*a;if(b.chart.doSpeedChanges&&!t){const o=this.chart.timingData.getEffectiveBeat(n)+s;return this.chart.getBeatFromEffectiveBeat(o)}return n+s}getColumnFromXPos(e){const t=this.chart.gameType;let n=null;for(let a=0;a<t.numCols;a++){const r=Math.abs(this.getXPosFromColumn(a)-e);if(n!==null&&r>n)return a-1;n=r}return t.numCols-1}getActualReceptorYPos(){return b.chart.receptorYPos/b.chart.zoom*(b.chart.reverse?-1:1)}getEffectiveBeatsToPixelsRatio(){return b.chart.speed/100*64*this.speedMult}getPixelsToEffectiveBeatsRatio(){return 1/this.getEffectiveBeatsToPixelsRatio()}getSecondsToPixelsRatio(){return b.chart.speed/100*64*4}getPixelsToSecondsRatio(){return 1/this.getSecondsToPixelsRatio()}isNegScroll(e){return b.chart.doSpeedChanges&&(this.speedMult<0||(this.chart.timingData.getEventAtBeat("SCROLLS",e)?.value??1)<0||(this.chart.timingData.getEventAtBeat("BPMS",e)?.value??120)<0)}getUpperBound(){return-this.chartManager.app.STAGE_HEIGHT/2/b.chart.zoom-64}getLowerBound(){return this.chartManager.app.STAGE_HEIGHT/2/b.chart.zoom+64}findFirstOnScreenScroll(){const e=[...this.chart.timingData.getTimingData("SCROLLS")];e[0]?.beat!=0&&e.splice(0,0,{beat:0,value:e[0]?.value??1,type:"SCROLLS"});let t=hi(e,this.getVisualBeat()-b.chart.maxDrawBeatsBack,n=>n.beat);for(;t<e.length&&(e[t].beat??0)<this.getVisualBeat()+b.chart.maxDrawBeats;){const n=e[t];t++;const a=n===void 0?-1/0*this.getScrollDirection(e[0]?.value??1):this.getYPosFromBeat(n.beat??0),r=e[t]===void 0?1/0*this.getScrollDirection(n.value):this.getYPosFromBeat(e[t].beat);if(this.isAreaOnScreen(a,r))return n}return e.at(-1)??{beat:0,value:1,type:"SCROLLS"}}findLastOnScreenScroll(){const e=[...this.chart.timingData.getTimingData("SCROLLS")];e[0]?.beat!=0&&e.splice(0,0,{beat:0,value:e[0]?.value??1,type:"SCROLLS"});let t=hi(e,this.getVisualBeat()+b.chart.maxDrawBeats,a=>a.beat);const n=hi(e,this.getVisualBeat()-b.chart.maxDrawBeatsBack,a=>a.beat);for(;t>=n;){const a=e[t];t--;const r=a===void 0?-1/0*this.getScrollDirection(e[0]?.value??1):this.getYPosFromBeat(a.beat??0),s=e[t+2]===void 0?1/0*this.getScrollDirection(a.value):this.getYPosFromBeat(e[t+2].beat);if(this.isAreaOnScreen(r,s))return a}return{beat:0,value:1,type:"SCROLLS"}}getTopOnScreenBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=this.findFirstOnScreenScroll(),t=1/Math.abs(this.getEffectiveBeatsToPixelsRatio()),n=this.getYPosFromBeat(e.beat),a=t/Math.abs(e.value),r=this.getScrollDirection(e.value),s=r==1?this.getUpperBound():this.getLowerBound(),o=r*(s-n)*a+e.beat;return Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,o)}return b.chart.CMod?this.getBeatFromYPos(this.getUpperBound()):Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,this.getBeatFromYPos(this.getUpperBound()))}getBottomOnScreenBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=this.findLastOnScreenScroll(),t=1/Math.abs(this.getEffectiveBeatsToPixelsRatio()),n=this.getYPosFromBeat(e.beat),a=t/Math.abs(e.value),r=this.getScrollDirection(e.value),s=r==1?this.getLowerBound():this.getUpperBound(),o=r*(s-n)*a+e.beat;return Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,o)}return b.chart.CMod?this.getBeatFromYPos(this.getLowerBound()):Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,this.getBeatFromYPos(this.getLowerBound()))}isAreaOnScreen(e,t){t<e&&([e,t]=[t,e]);const n=this.getUpperBound(),a=this.getLowerBound();return e<a&&t>n}getCurrentSpeedMult(){return this.chart.timingData.getSpeedMult(this.getVisualBeat(),this.getVisualTime())}getScrollDirection(e){let t=1;return this.getCurrentSpeedMult()<0&&(t*=-1),b.chart.reverse&&(t*=-1),e<0&&(t*=-1),t}getUpperBoundBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=b.chart.speed,t=this.chart.timingData.getSpeedMult(this.getVisualBeat(),this.getVisualTime()),n=t>=0!=b.chart.reverse?1:-1,a=this.chart.timingData.getTimingData("SCROLLS"),r=100/e/Math.abs(t)/64/b.chart.zoom,s=this.getUpperBound(),o=this.getLowerBound();let l=hi(a,this.getVisualBeat()-b.chart.maxDrawBeatsBack,m=>m.beat);for(this.getVisualBeat()-b.chart.maxDrawBeatsBack<a[0]?.beat&&(l=-1);l<a.length&&(a[l]?.beat??0)<this.getVisualBeat()+b.chart.maxDrawBeats;){const m=a[l],g=this.getYPosFromBeat(m?.beat??0),y=a[l+1]?.beat??this.getVisualBeat()+b.chart.maxDrawBeats,x=this.getYPosFromBeat(y);if((m?.value??1)*n>0&&x>s&&(g<s||!a[l-1]||a[l-1].beat<this.getVisualBeat()-b.chart.maxDrawBeatsBack||a[l-1].value==0)||(m?.value??1)*n<0&&x<s&&(g>s||!a[l-1]||a[l-1].beat<this.getVisualBeat()-b.chart.maxDrawBeatsBack||a[l-1].value==0))break;l++}const u=a[l]?.beat??0,f=this.getYPosFromBeat(u),c=a[l]?.value??1,d=r/Math.abs(c)*b.chart.zoom,h=b.chart.reverse?s:o,p=b.chart.reverse?o:s;return c*n>0?a[l-1]?.value==0&&this.getYPosFromBeat(a[l-1].beat)>p?this.getVisualBeat()-b.chart.maxDrawBeatsBack:Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,u+d*(p-f)):a[l-1]?.value==0&&this.getYPosFromBeat(a[l-1].beat)<h?this.getVisualBeat()-b.chart.maxDrawBeatsBack:Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,u+d*(f-h))}return b.chart.CMod?this.getBeatFromYPos(this.getUpperBound()):Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,this.getBeatFromYPos(this.getUpperBound()))}getLowerBoundBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=b.chart.speed,t=this.chart.timingData.getSpeedMult(this.getVisualBeat(),this.getVisualTime()),n=t>=0!=b.chart.reverse?1:-1,a=this.chart.timingData.getTimingData("SCROLLS"),r=100/e/Math.abs(t)/64/b.chart.zoom,s=this.getUpperBound(),o=this.getLowerBound();let l=hi(a,this.getVisualBeat()+b.chart.maxDrawBeats,m=>m.beat);for(;l<a.length&&l>=0&&(a[l].beat??0)>this.getVisualBeat()-b.chart.maxDrawBeatsBack;){const m=a[l],g=this.getYPosFromBeat(m?.beat??0),y=a[l+1]?.beat??this.getVisualBeat()+b.chart.maxDrawBeats,x=this.getYPosFromBeat(y);if((m?.value??1)*n>0&&g<o&&(x>o||!a[l+1]||a[l+1].beat>this.getVisualBeat()+b.chart.maxDrawBeatsBack||a[l+1].value==0)||(m?.value??1)*n<0&&g>o&&(x<o||!a[l+1]||a[l+1].beat>this.getVisualBeat()+b.chart.maxDrawBeatsBack||a[l+1].value==0))break;l--}const u=a[l]?.beat??0,f=this.getYPosFromBeat(u),c=a[l]?.value??1,d=r/Math.abs(c)*b.chart.zoom,h=b.chart.reverse?o:s,p=b.chart.reverse?s:o;return c*n>0?a[l+1]?.value==0&&this.getYPosFromBeat(a[l+1].beat)<p?this.getVisualBeat()+b.chart.maxDrawBeats:Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,u+d*(p-f)):a[l+1]?.value==0&&this.getYPosFromBeat(a[l+1].beat)>h?this.getVisualBeat()+b.chart.maxDrawBeats:Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,u+d*(f-h))}return b.chart.CMod?this.getBeatFromYPos(this.getLowerBound()):Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,this.getBeatFromYPos(this.getLowerBound()))}selectionTest(e){if(!this.selectionBounds)return!1;const t=this.selectionBoundary.getBounds(),n=e.getBounds(),a=16*b.chart.zoom;return t.x+t.width>n.x+a&&t.x<n.x+n.width-a&&t.y+t.height>n.y+a&&t.y<n.y+n.height-a}registerDragNote(e,t){e.eventMode="static",e.removeAllListeners();let n=0,a=0,r=0,s=0,o;const l=u=>{const f=o,c=this.toLocal(u.global);if(Math.abs(c.y-s-r)**2+Math.abs(c.x-a)**2<32*32){this.chartManager.selection.shift&&(this.chartManager.selection.shift={columnShift:0,beatShift:0});return}const d=this.getBeatFromYPos(c.y-s),h=b.chart.snap==0?1/48:b.chart.snap;let p=Math.round(d/h)*h;Math.abs(p-d)>Math.abs(d-f.beat)&&(p=f.beat);const m=this.getColumnFromXPos(c.x);this.chartManager.selection.shift||={columnShift:0,beatShift:0},n!=m-f.col&&(n=m-f.col,this.chartManager.selection.notes.every(g=>{const y=g.col+n;return y>=0&&y<this.chartManager.loadedChart.gameType.numCols})&&(this.chartManager.selection.shift.columnShift=m-f.col)),this.chartManager.selection.shift.beatShift=Math.max(-Math.min(...this.chartManager.selection.notes.map(g=>g.beat)),p-f.beat)};e.on("pointerdown",u=>{if(this.chartManager.getMode()==W.View)return;if(qa(u)){this.chartManager.isNoteInSelection(t)||(this.chartManager.clearSelections(),this.chartManager.addNoteToSelection(t)),Qs.open(this.chartManager.app,u),u.preventDefault();return}if(b.chart.mousePlacement&&!u.getModifierState("Meta")&&!u.getModifierState("Control")&&!u.getModifierState("Shift")&&!this.chartManager.isNoteInSelection(t))return;u.stopImmediatePropagation(),this.chartManager.isNoteInSelection(t)?(u.getModifierState("Control")||u.getModifierState("Meta"))&&this.chartManager.removeNoteFromSelection(t):(!u.getModifierState("Control")&&!u.getModifierState("Meta")&&!u.getModifierState("Shift")&&this.chartManager.clearSelections(),this.chartManager.addNoteToSelection(t)),a=e.x,r=e.y,s=this.toLocal(u.global).y-e.y,o=t,this.on("pointermove",l);const f=()=>{this.off("pointermove",l),this.off("pointerup",f),((this.chartManager.selection.shift?.beatShift??0)!=0||(this.chartManager.selection.shift?.columnShift??0)!=0)&&this.chartManager.modifySelection(c=>(c.beat+=this.chartManager.selection.shift.beatShift,c.col+=this.chartManager.selection.shift.columnShift,c)),this.chartManager.selection.shift=void 0};this.on("pointerup",f)}),e.on("destroyed",()=>{e?.removeAllListeners()})}getNotefield(){return this.notefield}swapNoteskin(e){b.chart.noteskin.name=e,b.chart.lastNoteskins[this.chart.gameType.id]=e,this.reloadNotefield()}reloadNotefield(){const e=new Ic(this);this.addChildAt(e,this.children.indexOf(this.notefield)),this.notefield.destroy(),this.notefield=e}getSelectionBounds(){return this.selectionBounds}shouldDisplayEditGUI(){return(this.chartManager.getMode()!=W.Play||!b.play.hideBarlines)&&fe.barlines}shouldDisplayNoteSelection(e){return this.chartManager.getMode()!=W.Play&&!this.chartManager.app.capturing&&this.chartManager.isNoteInSelection(e)}shouldDisplayEventSelection(e){return this.chartManager.getMode()!=W.Play&&!this.chartManager.app.capturing&&this.chartManager.isEventInSelection(e)}}class Io extends AudioBufferSourceNode{started=!1;start(e,t,n){this.started||super.start(e,t,n),this.started=!0}stop(e){this.started&&super.stop(e),this.started=!1}static create(e){const t=e;return t.started=!1,Object.setPrototypeOf(t,Io.prototype),t}}class zg extends BiquadFilterNode{enabled=!1;static create(e){const t=e;return t.enabled=!1,t}}class _a{_audioAnalyzer;_filteredAudioAnalyzer;_freqData;_filteredFreqData;_gainNode;type;_audioContext=new AudioContext;_source;_playbackTime=0;_startTimestamp=0;_rate=1;_isPlaying=!1;_buffer;_filteredBuffer;_loadedBuffer;_delay;_loadListeners=[];_updateListeners=[];_volume=1;_destroyed=!1;_renderTimeout;_filters=[this.createFilter({type:"highpass",frequency:20,Q:.71}),this.createFilter({type:"lowshelf",frequency:75,gain:0}),this.createFilter({type:"peaking",frequency:100,gain:0,Q:.6}),this.createFilter({type:"peaking",frequency:250,gain:0,Q:.3}),this.createFilter({type:"peaking",frequency:1040,gain:0,Q:.41}),this.createFilter({type:"peaking",frequency:2500,gain:0,Q:.2}),this.createFilter({type:"highshelf",frequency:7500,gain:0}),this.createFilter({type:"lowpass",frequency:2e4,Q:.71})];_filtersEnabled=!1;onStop;loaded;constructor(e,t){this.type=t??"",this._filters[0].gain.value=-25,this._audioAnalyzer=this._audioContext.createAnalyser(),this._audioAnalyzer.fftSize=4096,this._audioAnalyzer.maxDecibels=0,this._freqData=new Uint8Array(this._audioAnalyzer.frequencyBinCount),this._filteredAudioAnalyzer=this._audioContext.createAnalyser(),this._filteredAudioAnalyzer.fftSize=4096,this._filteredAudioAnalyzer.maxDecibels=0,this._filteredFreqData=new Uint8Array(this._filteredAudioAnalyzer.frequencyBinCount),this._gainNode=this._audioContext.createGain(),this._buffer=this._audioContext.createBuffer(2,1,44100),this._filteredBuffer=this._audioContext.createBuffer(2,1,44100),this._loadedBuffer=this._audioContext.createBuffer(2,1,44100),this.initSource(),this.loaded=new Promise(n=>{this.decodeData(e).then(a=>{if(a)return this._loadedBuffer=a,a}).then(async a=>(await this.renderBuffer(a),await this.renderFilteredBuffer(a),a)).catch(a=>{a.name=="EncodingError"?ce.createFormatted("Failed to load audio: file format not supported","error"):ce.createFormatted("Failed to load audio: "+a.message,"error")}).finally(()=>{this.initSource(),this.callLoadListeners(),this.callUpdateListeners(),n()})})}async renderBuffer(e){if(!e)return;const t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=t.createBufferSource();return n.buffer=e,n.connect(t.destination),n.start(),await t.startRendering().then(a=>{this._buffer=a}).catch(()=>{ce.createFormatted("Failed to load audio: audio rendering failed","error")})}async renderFilteredBuffer(e){if(!e)return;const t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=t.createBufferSource();n.buffer=e;let a=n;for(const r of this._filters){if(!r.enabled)continue;const s=t.createBiquadFilter();s.type=r.type,s.Q.setValueAtTime(r.Q.value,0),s.frequency.setValueAtTime(r.frequency.value,0),s.gain.setValueAtTime(r.gain.value,0),a.connect(s),a=s}return a.connect(t.destination),n.start(),await t.startRendering().then(r=>{this._filteredBuffer=r}).catch(()=>{ce.createFormatted("Failed to load audio: audio rendering failed","error")})}createFilter(e){const t=zg.create(this._audioContext.createBiquadFilter());return t.type=e.type,e.Q!==void 0&&(t.Q.value=e.Q),e.gain!==void 0&&(t.gain.value=e.gain),e.frequency!==void 0&&(t.frequency.value=e.frequency),t}getFilters(){return this._filters}getFilter(e){return this._filters[e]}updateFilter(e,t){this._filters[e]&&(t.Q!==void 0&&(this._filters[e].Q.value=t.Q),t.frequency!==void 0&&(this._filters[e].frequency.value=t.frequency),t.gain!==void 0&&(this._filters[e].gain.value=t.gain),clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout(()=>this.renderFilteredBuffer(this._loadedBuffer).then(()=>this.callUpdateListeners()),500))}enableFilter(e){this._filters[e].enabled=!0,this.initSource(),clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout(()=>this.renderFilteredBuffer(this._loadedBuffer).then(()=>this.callUpdateListeners()),500),this._filtersEnabled=!0}disableFilter(e){this._filters[e].enabled=!1,this.initSource(),clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout(()=>this.renderFilteredBuffer(this._loadedBuffer).then(()=>this.callUpdateListeners()),500),this._filtersEnabled=this._filters.some(t=>t.enabled)}hasFilters(){return this._filtersEnabled}onLoad(e){this._loadListeners.push(e)}offLoad(e){this._loadListeners=this._loadListeners.filter(t=>t!=e)}onUpdate(e){this._updateListeners.push(e)}offUpdate(e){this._updateListeners=this._updateListeners.filter(t=>t!=e)}getSongLength(){return this._buffer.length/this._buffer.sampleRate}getFrequencyData(){return this._destroyed?new Uint8Array:(this._audioAnalyzer.getByteFrequencyData(this._freqData),this._freqData)}getFilteredFrequencyData(){return this._destroyed?new Uint8Array:(this._filteredAudioAnalyzer.getByteFrequencyData(this._filteredFreqData),this._filteredFreqData)}getSampleRate(){return this._buffer.sampleRate}getFFTSize(){return this._audioAnalyzer.fftSize}getRawData(){if(this._destroyed)return[];const e=[];for(let t=0;t<this._buffer.numberOfChannels;t++){const n=new Float32Array(this._buffer.length);this._buffer.copyFromChannel(n,t),e.push(n)}return e}getFilteredRawData(){if(this._destroyed)return[];const e=[];for(let t=0;t<this._filteredBuffer.numberOfChannels;t++){const n=new Float32Array(this._filteredBuffer.length);this._filteredBuffer.copyFromChannel(n,t),e.push(n)}return e}getBuffer(){return this._loadedBuffer}isPlaying(){return this._destroyed?!1:this._isPlaying}reload(){this.initSource()}destroy(){this._destroyed||(this.stop(),this._buffer=this._audioContext.createBuffer(2,1,44100),this._updateListeners=[],clearTimeout(this._delay),this._destroyed=!0)}getFrequencyResponse(e){const t=new Float32Array(e);return this._filters.some(n=>n.enabled)?this._filters.filter(n=>n.enabled).map(n=>{const a=new Float32Array(e.length);return n.getFrequencyResponse(t,a,new Float32Array(e.length)),[...a]}).reduce((n,a)=>n.map((r,s)=>r*a[s])):new Array(e.length).fill(1)}callLoadListeners(){this._loadListeners.forEach(e=>e())}callUpdateListeners(){this._updateListeners.forEach(e=>e())}async decodeData(e){return new Promise((t,n)=>{if(!e){t();return}(async()=>{try{t(await this._audioContext.decodeAudioData(e))}catch(a){if(this.type==".ogg"){const r=(await We(async()=>{const{default:s}=await import("./OggDec-BmLxerny.js");return{default:s}},[])).default;try{t(await r.decodeOggData(e))}catch(s){n(s)}return}n(a)}})()})}initSource(){for(const t of this._filters)t.disconnect();this._audioAnalyzer.disconnect(),this._filteredAudioAnalyzer.disconnect(),this._gainNode.disconnect(),this._audioContext.destination.disconnect(),this._source?.stop(),this._source=Io.create(this._audioContext.createBufferSource()),this._source.buffer=this._buffer,this._source.connect(this._audioAnalyzer);let e=this._audioAnalyzer;for(const t of this._filters)t.enabled&&(e.connect(t),e=t);e.connect(this._filteredAudioAnalyzer),b.audio.allowFilter?this._filteredAudioAnalyzer.connect(this._gainNode):this._audioAnalyzer.connect(this._gainNode),this._gainNode.connect(this._audioContext.destination),this._source.playbackRate.value=this._rate,this._isPlaying&&(this.pause(),this.play())}volume(e){this._destroyed||this._volume!=e&&(this._volume=e,this._gainNode.gain.setValueAtTime(e,this._audioContext.currentTime))}rate(e){this._destroyed||this._rate!=e&&(this._rate=e,this._source&&(this._isPlaying&&(this._playbackTime+=(this._audioContext.currentTime-this._startTimestamp)*this._source.playbackRate.value),this._startTimestamp=this._audioContext.currentTime,this._source.playbackRate.value=e))}play(){this._destroyed||this._source&&(this._isPlaying||(this.initSource(),this._playbackTime<=this._buffer.duration&&this._source.start(Math.max(0,this._audioContext.currentTime-this._playbackTime/b.audio.rate),Math.max(0,this._playbackTime)),this._startTimestamp=this._audioContext.currentTime,this._isPlaying=!0))}seek(e){if(e===void 0)return this._destroyed?this._playbackTime:this._source?this._isPlaying?(this._audioContext.currentTime-this._startTimestamp)*this._source.playbackRate.value+this._playbackTime:this._playbackTime:this._playbackTime;this._isPlaying?(this.stop(),this._playbackTime=e,this.play()):this._playbackTime=e}pause(){this._destroyed||this.stop(!0)}stop(e){this._destroyed||this._source&&this._isPlaying&&(this.onStop?.(),clearTimeout(this._delay),this._isPlaying=!1,this._playbackTime<=this._buffer.duration&&this._source.stop(),this._playbackTime=e?(this._audioContext.currentTime-this._startTimestamp)*this._source.playbackRate.value+this._playbackTime:0)}}class Vg{judgementCounts=new Map;holdJudgementCounts=new Map;dancePoints=0;maxCumulativeDancePoints=0;maxDancePoints=0;chartManager;notedata;dataPoints=[];handlers=[];combo=0;missCombo=0;maxCombo=0;bestJudge;constructor(e){this.notedata=e.loadedChart.getNotedata(),this.chartManager=e,this.bestJudge=_t.getCollection(b.play.timingCollection).getStandardWindows()[0],this.calculateMaxDP()}onJudge(e){this.handlers.push(e)}applyOffset(e){this.dataPoints=this.dataPoints.map(t=>mi(t.judgement)||!xi(t.judgement)?t:{...t,error:t.error!==null?t.error+e:null})}addDataPoint(e,t,n){this.judgementCounts.has(t)||this.judgementCounts.set(t,0),this.judgementCounts.set(t,this.judgementCounts.get(t)+1),this.dancePoints+=t.dancePoints;const a=this.chartManager.loadedChart.timingData.getEventAtBeat("COMBOS",e[0].beat),r=a?.hitMult??1,s=a?.missMult??1;eo(t)||(this.maxCumulativeDancePoints+=_t.getCollection(b.play.timingCollection).getMaxDancePoints()),mi(t)?(this.chartManager.loadedChart.gameType.gameLogic.usesHoldTicks||(this.maxCumulativeDancePoints+=e.filter(Oe).reduce((o,l)=>o+_t.getCollection(b.play.timingCollection).getMaxHoldDancePoints(l.type),0)),this.combo=0,this.chartManager.loadedChart.gameType.gameLogic.missComboIsPerRow?this.missCombo+=e.length*s:this.missCombo+=s,this.bestJudge=void 0):xi(t)&&(_t.getCollection(b.play.timingCollection).shouldHideNote(t)?(this.chartManager.loadedChart.gameType.gameLogic.comboIsPerRow?this.combo+=e.length*r:this.combo+=r,this.combo>this.maxCombo&&(this.maxCombo=this.combo),this.missCombo=0,this.bestJudge&&t.getTimingWindowMS()>this.bestJudge.getTimingWindowMS()&&(this.bestJudge=t)):(this.bestJudge=void 0,this.combo=0)),this.handlers.forEach(o=>o(n,t)),this.dataPoints.push({second:e[0].second,error:n,judgement:t,notes:e})}addHoldDataPoint(e,t){this.judgementCounts.has(t)||this.judgementCounts.set(t,0),this.judgementCounts.set(t,this.judgementCounts.get(t)+1);const n=_t.getCollection(b.play.timingCollection).getHeldJudgement(e);this.holdJudgementCounts.has(n)||this.holdJudgementCounts.set(n,[0,0]);const a=this.holdJudgementCounts.get(n);yn(t)?a[0]++:a[1]++,this.holdJudgementCounts.set(n,a),this.dancePoints+=t.dancePoints,this.maxCumulativeDancePoints+=_t.getCollection(b.play.timingCollection).getMaxHoldDancePoints(e.type),this.handlers.forEach(r=>r(0,t)),Xn(t)&&(this.bestJudge=void 0)}getScore(){return this.maxDancePoints==0?0:this.dancePoints/this.maxDancePoints}getCumulativeScore(){return this.maxCumulativeDancePoints==0?0:this.dancePoints/this.maxCumulativeDancePoints}getDataPoints(){return this.dataPoints}getMedian(){return ja(this.dataPoints.filter(e=>!mi(e.judgement)&&xi(e.judgement)&&e.error!=null).map(e=>e.error))}getMaxCombo(){return this.maxCombo}calculateMaxDP(){this.maxDancePoints=this.chartManager.loadedChart.gameType.gameLogic.calculateMaxDP(this.notedata,this.chartManager.loadedChart.timingData)}getCount(e){return this.judgementCounts.get(e)??0}getCombo(){return this.combo}getMissCombo(){return this.missCombo}getBestJudge(){return this.bestJudge}}const Ut=[1,2,3,4,6,8,12,16,24,48,-1],Rc=.2;var W=(i=>(i.View="View Mode",i.Edit="Edit Mode",i.Play="Play Mode",i.Record="Record Mode",i))(W||{}),Se=(i=>(i[i.Off=0]="Off",i[i.Edit=1]="Edit",i[i.Add=2]="Add",i))(Se||{});class Ug{app;chartAudio=new _a;chartView;widgetManager;assistTick=new Ds({src:sh,volume:.5});me_high=new Ds({src:Zc,volume:.5});me_low=new Ds({src:Qc,volume:.5});mine=new Ps.Howl({src:oh,volume:.5});loadedSM;smPath="";loadedChart;selection={notes:[],inProgressNotes:[]};eventSelection={timingEvents:[],inProgressTimingEvents:[]};editTimingMode=0;holdEditing=[];editNoteTypeIndex=0;partialScroll=0;noteFlashIndex=0;assistTickIndex=0;lastMetronomeDivision=-1;lastMetronomeMeasure=-1;holdFlashes=[];lastSong=null;mode="Edit Mode";lastMode="Edit Mode";_beat=0;cachedSecond=0;cachedBeat=0;noChartTextA;noChartTextB;loadingText;shiftPressed=0;virtualClipboard="";lastAutoSave=0;startRegion;endRegion;gameStats;constructor(e){this.app=e,document.addEventListener("keydown",t=>{t.key=="Shift"&&this.shiftPressed++}),document.addEventListener("keyup",t=>{t.key=="Shift"&&(this.shiftPressed=Math.max(this.shiftPressed-1,0))}),document.addEventListener("cut",t=>{if(t.target.classList.contains("inlineEdit")||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement||this.mode!="Edit Mode")return;const n=this.copy();n&&t.clipboardData?.setData("text/plain",n),this.eventSelection.timingEvents.length>0?this.deleteEventSelection():this.deleteSelection(),t.preventDefault()},!0),document.addEventListener("copy",t=>{if(t.target.classList.contains("inlineEdit")||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement||this.mode!="Edit Mode")return;const n=this.copy();n&&t.clipboardData?.setData("text/plain",n),t.preventDefault(),t.stopImmediatePropagation()},!0),document.addEventListener("paste",t=>{if(t.target.classList.contains("inlineEdit")||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement||this.mode!="Edit Mode")return;const n=t.clipboardData?.getData("text/plain");n&&this.paste(n,this.shiftPressed>0),t.preventDefault(),t.stopImmediatePropagation()},!0),e.view.addEventListener?.("wheel",t=>{if(!(this.loadedSM==null||this.loadedChart==null||this.chartView==null))if(t.preventDefault(),ei&&t.metaKey||!ei&&t.ctrlKey){const n=t.deltaY/5*b.chart.scroll.scrollSensitivity*(b.chart.scroll.invertZoomScroll?-1:1);b.chart.speed=Te(b.chart.speed*Math.pow(1.01,n),10,35e3)}else{if(this.mode=="Play Mode"||this.mode=="Record Mode")return;let n=this.beat;const a=b.chart.snap;let r=t.deltaY/b.chart.speed*b.chart.scroll.scrollSensitivity;if(b.chart.reverse&&b.chart.scroll.invertReverseScroll&&(r*=-1),b.chart.scroll.invertScroll&&(r*=-1),a==0?(this.partialScroll=0,n=this.beat+r):b.chart.scroll.scrollSnapEveryScroll?r<0?n=Math.round((this.beat-a)/a)*a:n=Math.round((this.beat+a)/a)*a:(this.partialScroll+=r,Math.abs(this.partialScroll)>a&&(this.partialScroll<0?n=Math.round((this.beat+Math.ceil(this.partialScroll/a)*a)/a)*a:n=Math.round((this.beat+Math.floor(this.partialScroll/a)*a)/a)*a,this.partialScroll%=a)),n=Math.max(0,n),n!=this.beat&&(this.beat=n),!this.holdEditing.every(s=>s==null))for(let s=0;s<this.holdEditing.length;s++)!this.holdEditing[s]||this.holdEditing[s].type=="mouse"||this.editHoldBeat(s,this.beat,t.shiftKey)}}),this.widgetManager=new jm(this),this.app.stage.addChild(this.widgetManager),this.noChartTextA=new ge("No Chart",{fontName:"Main",fontSize:30}),this.noChartTextA.anchor.set(.5),this.noChartTextA.tint=5592405,this.app.stage.addChild(this.noChartTextA),this.noChartTextB=new ge("Create a new chart",{fontName:"Main",fontSize:15}),this.noChartTextB.anchor.set(.5),this.noChartTextB.tint=5596791,this.noChartTextB.eventMode="static",this.noChartTextB.on("mouseover",()=>{this.noChartTextB.tint=8952234}),this.noChartTextB.on("mouseleave",()=>{this.noChartTextB.tint=5596791}),this.noChartTextB.on("mousedown",()=>{this.app.windowManager.openWindow(new ju(e,yt.getGameType("dance-single")))}),this.noChartTextA.visible=!1,this.noChartTextB.visible=!1,this.app.stage.addChild(this.noChartTextB),this.loadingText=new ge("Loading simfile...",{fontName:"Main",fontSize:20}),this.loadingText.anchor.set(.5),this.loadingText.tint=5592405,this.app.stage.addChild(this.loadingText),this.loadingText.visible=!1,this.noChartTextA.x=0,this.noChartTextA.y=-20,this.noChartTextB.x=0,this.noChartTextB.y=10,this.loadingText.x=0,this.loadingText.y=0,setInterval(()=>{if(!this.loadedSM||!this.loadedChart||!this.chartView)return;const t=performance.now(),n=this.chartAudio.seek();if(this.chartAudio.isPlaying()&&!this.holdEditing.every(r=>!r))for(let r=0;r<this.holdEditing.length;r++){if(!this.holdEditing[r]||this.holdEditing[r].type=="mouse")continue;let s=this.beat;this.mode=="Record Mode"&&(s=this.loadedChart.getBeatFromSeconds(this.time+b.play.offset));const o=b.chart.snap==0?1/48:b.chart.snap,l=Math.round(s/o)*o,u=this.holdEditing[r];(Math.max(0,Math.round(Math.max(this.beat,u.endBeat)*48)/48)-Math.max(0,Math.round(Math.min(this.beat,u.startBeat)*48)/48))*60/(this.loadedChart.timingData.getEventAtBeat("BPMS",this.beat)?.value??120)>.3&&this.editHoldBeat(r,l,!1)}const a=this.loadedChart.getNotedata();if(this.chartAudio.isPlaying()){this._beat=this.loadedChart?.getBeatFromSeconds(this.time)??0;let r=a[this.noteFlashIndex];for(;this.noteFlashIndex<a.length&&n>r.second;)this.mode!="Record Mode"&&this.loadedChart.gameType.gameLogic.shouldAssistTick(r)&&this.mode!="Play Mode"&&(this.chartView.doJudgement(r,0,Js),Oe(r)&&(r.type=="Hold"&&this.chartView.getNotefield().activateHold(r.col),r.type=="Roll"&&this.chartView.getNotefield().activateRoll(r.col),this.holdFlashes.push(r))),this.noteFlashIndex++,r=a[this.noteFlashIndex];this.holdFlashes=this.holdFlashes.filter(o=>this._beat<o.beat+o.hold?!0:(this.chartView&&(o.type=="Hold"&&this.chartView.getNotefield().releaseHold(o.col),o.type=="Roll"&&this.chartView.getNotefield().releaseRoll(o.col),this.chartView.doJudgement(o,null,_t.getCollection(b.play.timingCollection).getHeldJudgement(o))),!1));const s=new Set;for(;this.assistTickIndex<a.length&&n>a[this.assistTickIndex].second+b.play.effectOffset-Rc;){if(s.has(a[this.assistTickIndex].second)||a[this.assistTickIndex].second+b.play.effectOffset-n<0){this.assistTickIndex++;continue}this.mode!="Record Mode"&&this.loadedChart.gameType.gameLogic.shouldAssistTick(a[this.assistTickIndex])&&(b.audio.assistTick&&fe.assist&&this.assistTick.play((a[this.assistTickIndex].second+b.play.effectOffset-n)/b.audio.rate),s.add(a[this.assistTickIndex].second)),this.assistTickIndex++}}if(this.chartAudio.isPlaying()&&b.audio.metronome&&fe.assist){const r=this.loadedChart.timingData,s=this.loadedChart.getBeatFromSeconds(this.time+b.play.effectOffset+Rc),o=new Set,l=r.getBeatFromMeasure(this.lastMetronomeMeasure),u=r.getDivisionLength(l),f=l+u*this.lastMetronomeDivision,c=[...r.getMeasureBeats(f,s)].slice(1);for(const[d,h]of c){if(this.beat>d)continue;const p=r.getSecondsFromBeat(d);if(o.has(p))continue;o.add(p);const m=(p+b.play.effectOffset-this.time)/b.audio.rate;h?this.me_high.play(m):this.me_low.play(m)}if(c.length>0){const d=c.at(-1)[0];this.lastMetronomeMeasure=Math.floor(r.getMeasure(d)),this.lastMetronomeDivision=Math.round(r.getDivisionOfMeasure(d))}}this.mode=="Play Mode"&&this.loadedChart.gameType.gameLogic.update(this),this.lastAutoSave+b.general.autosaveInterval*1e3<Date.now()&&(this.lastAutoSave=Date.now(),Mt.instance.isDirty()&&this.autosave()),this.updateSoundProperties(),Lm(),en.instance?.addUpdateTimeValue(performance.now()-t)},5),ie.on("chartModified",()=>{this.loadedChart&&(this.setNoteIndex(),ie.emit("chartModifiedAfter"))}),ie.on("userOptionUpdated",t=>{t!="audio.rate"&&t!="play.effectOffset"&&t!="audio.assistTick"&&t!="audio.metronome"||(this.assistTick.stop(),this.me_low.stop(),this.me_high.stop(),this.setNoteIndex())}),window.addEventListener("keyup",t=>{if(this.mode=="Edit Mode"&&t.code.startsWith("Digit")){let n=parseInt(t.code.slice(5))-1;n==-1&&(n=9),this.endEditing(n)}},!0),window.addEventListener("keydown",t=>{const n=Ae.getKeyNameFromEvent(t);if(this.mode=="Edit Mode"&&!t.target.classList.contains("inlineEdit")&&!(t.target instanceof HTMLTextAreaElement)&&!(t.target instanceof HTMLInputElement)&&!An.active){if(t.code.startsWith("Digit")&&!t.repeat&&!t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.ctrlKey){let a=parseInt(t.code.slice(5))-1;a==-1&&(a=9),a<(this.loadedChart?.gameType.numCols??4)&&(this.setNote(a,"key"),t.preventDefault(),t.stopImmediatePropagation())}if(!this.holdEditing.every(a=>a==null)){const a=["cursorUp","cursorDown","previousNote","nextNote","previousMeasure","nextMeasure","jumpChartStart","jumpChartEnd","jumpSongStart","jumpSongEnd"];for(const r of a)if(Ae.getCombosForKeybind(r).map(s=>s.key).includes(n)){t.preventDefault(),t.stopImmediatePropagation(),$e[r].callback(this.app);for(let s=0;s<this.holdEditing.length;s++)!this.holdEditing[s]||this.holdEditing[s].type=="mouse"||this.editHoldBeat(s,this.beat,t.shiftKey);return}for(const r of["undo","redo"])if(Ae.getCombosForKeybind(r).map(s=>s.key).includes(n)){this.holdEditing=[];return}}}},!0),window.addEventListener("keydown",t=>{this.mode!="Play Mode"&&this.mode!="Record Mode"||t.key=="Escape"&&(this.setMode(this.lastMode),this.chartAudio.pause())},!0)}get beat(){if(!this.loadedChart)return 0;if(!this.chartAudio.isPlaying())return this._beat;if(this.cachedSecond==this.time)return this.cachedBeat;const e=this.loadedChart.getBeatFromSeconds(this.time);return this.cachedBeat=e,this.cachedSecond=this.time,e}set beat(e){this.loadedChart&&(this.chartAudio.seek(this.loadedChart.getSecondsFromBeat(e)),this._beat=e,this.setNoteIndex(),this.lastMetronomeMeasure=Math.floor(this.loadedChart.timingData.getMeasure(this.beat)),this.lastMetronomeDivision=Math.floor(this.loadedChart.timingData.getDivisionOfMeasure(this.beat)))}get time(){return this.chartAudio.seek()}set time(e){this.loadedChart&&(this.chartAudio.seek(e),this._beat=this.loadedChart.getBeatFromSeconds(e),this.setNoteIndex())}async loadSM(e){if(Ju.close(),ed.close(),Tm.close(),Mt.instance.isDirty()){const l=new vn(this.app,"Save","Do you wish to save the current file?",[{label:"Cancel",type:"default"},{label:"No",type:"default"},{label:"Yes",type:"confirm"}]);this.app.windowManager.openWindow(l);const u=await l.resolved;if(u=="Cancel")return;u=="Yes"&&this.save(),u=="No"&&await this.removeAutosaves()}if(!e){this.smPath="",this.loadedSM?.destroy(),this.loadedSM=void 0,this.chartAudio.stop(),this.noChartTextA.visible=!1,this.noChartTextB.visible=!1,this.chartView?.destroy({children:!0});return}if(this.chartAudio.stop(),this.chartAudio.seek(0),this.lastSong=null,this.smPath=e,this.loadingText.visible=!0,At(this.smPath)==".sm"&&b.general.loadSSC!="Never"){const l=this.getSMPath(".ssc");if(await Ce.hasFile(l))if(b.general.loadSSC=="Prompt"){const u=new vn(this.app,"Use SSC File","An SSC file was found. Do you wish to use the SSC file instead?",[{label:"No",type:"default"},{label:"Yes",type:"confirm"}],"You can change the default behavior in settings");this.app.windowManager.openWindow(u),await u.resolved=="Yes"&&(this.smPath=l)}else b.general.loadSSC=="Always"&&(ce.create("Loading available SSC file"),this.smPath=l)}let t=this.smPath;const n=this.getSMPath(".smebak");if(await Ce.hasFile(n)){const l=new vn(this.app,"Autosave","An autosave was found. Do you wish to load the autosave?",[{label:"No",type:"default"},{label:"Yes",type:"confirm"}]);this.app.windowManager.openWindow(l),await l.resolved=="Yes"&&(t=n)}const a=await Ce.getFileHandle(t);if(!a){ce.createFormatted("Couldn't load the file at "+t,"error"),this.app.windowManager.openWindow(new Lo(this.app)),this.loadingText.visible=!1;return}const r=await a.getFile(),s=await Ce.getFileHandle(this.getDataPath()),o=s?await s.getFile():void 0;this.loadedSM?.destroy(),this.loadedSM=new Hc(r,o),await this.loadedSM.loaded,this.loadingText.visible=!1,this.noChartTextA.visible=!0,this.noChartTextB.visible=!0,this.editTimingMode=0,ie.emit("smLoaded"),await this.loadChart(),ie.emit("smLoadedAfter"),this.beat=0,$u.addSM(this.smPath,this.loadedSM)}async loadChart(e){if(this.loadedSM==null)return;if(e==null){if(this.loadedChart){const a=this.loadedSM.charts[this.loadedChart.gameType.id];a&&a.length>0&&(e=a.at(-1))}if(!e)for(const a of yt.getPriority()){const r=this.loadedSM.charts[a.id];if(r&&r.length>0){e=r.at(-1);break}}if(!e){this.chartView?.destroy({children:!0}),this.chartView?.removeChildren(),this.beat=0,this.loadedChart=void 0,this.chartView=void 0,this.noChartTextA.visible=!0,this.noChartTextB.visible=!0,ie.emit("chartLoaded",null),ie.emit("chartModified");return}}if(e==this.loadedChart)return;this.chartView?.destroy({children:!0}),this.chartView?.removeChildren(),this.clearSelections(),this.loadedChart=e,this.beat=this.loadedChart.getBeatFromSeconds(this.time),Mt.instance.reset(),b.play.timingCollection="ITG";for(const[a,r]of Object.entries(b.play.defaultTimingCollections))if(e.gameType.id.startsWith(a)){b.play.timingCollection=r;break}const t=yt.getGameType(b.chart.noteskin.type),n={type:e.gameType.id,name:b.chart.lastNoteskins[e.gameType.id]??"default"};if(t){const a=it.getNoteskinData(t,b.chart.noteskin.name);a?.gameTypes.includes(e.gameType.id)&&(n.name=a.id)}if(b.chart.noteskin=n,b.chart.lastNoteskins[e.gameType.id]=n.name,this.setNoteIndex(),this.chartView=new Hg(this),(this.mode=="Play Mode"||this.mode=="Record Mode")&&this.setMode(this.lastMode),fe.viewMode&&this.setMode("View Mode"),this.noChartTextA.visible=!1,this.noChartTextB.visible=!1,this.loadedChart.getMusicPath()!=this.lastSong){this.lastSong=this.loadedChart.getMusicPath();const a=this.chartAudio.isPlaying();await this.loadAudio(),a&&this.chartAudio.play()}ce.create("Loaded chart "+e.difficulty+" "+e.meter+" "+e.gameType.id),ie.emit("chartLoaded",e),ie.emit("chartModified"),fe.autoPlay&&this.playPause()}async loadAudio(){if(!this.loadedSM||!this.loadedChart)return;this.chartAudio.stop(),this.chartAudio?.destroy();const e=this.loadedChart.getMusicPath();if(ce.create("Loading audio..."),e==""){ce.createFormatted("Failed to load audio: no audio file","error");const r=Math.max(0,this.beat);this.chartAudio=new _a(void 0),this.beat=r,ie.emit("audioLoaded");return}const t=await this.getAudioHandle(e);if(t==null){ce.createFormatted("Failed to load audio: couldn't find audio file "+e,"error");const r=Math.max(0,this.beat);this.chartAudio=new _a(void 0),this.beat=r,ie.emit("audioLoaded");return}const n=await t.getFile(),a=Math.max(0,this.beat);this.chartAudio=new _a(await n.arrayBuffer(),At(n.name)),this.chartAudio.onLoad(()=>{ce.create("Loaded audio")}),this.beat=a,this.chartAudio.onStop=()=>{this.assistTick.stop(),this.me_high.stop(),this.me_low.stop()},this.setNoteIndex(),ie.emit("audioLoaded")}async getAudioHandle(e){let t=await Ce.getFileHandleRelativeTo(this.smPath,e);if(t)return t;try{const n=await Ce.getDirectoryFiles(at(this.smPath));if(t=n.filter(a=>a.name.toLowerCase()==Tt(e).toLowerCase())[0],t)return ce.createFormatted("Failed to locate audio file "+e+", using file "+t.name+" instead","warn"),t;t=n.filter(a=>er.includes(At(a.name)))[0],t&&ce.createFormatted("Failed to locate audio file "+e+", using file "+t.name+" instead","warn")}catch{return}return t}getAudio(){return this.chartAudio}updateSoundProperties(){this.setEffectVolume(b.audio.soundEffectVolume*b.audio.masterVolume),this.setVolume(b.audio.songVolume*b.audio.masterVolume),this.setRate(b.audio.rate)}setRate(e){this.chartAudio.rate(e)}setVolume(e){this.chartAudio.volume(e)}setEffectVolume(e){this.assistTick.volume(e),this.me_high.volume(e),this.me_low.volume(e),this.mine.volume()!=e&&this.mine.volume(e)}setNoteIndex(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null||this.loadedChart.getNotedata().length==0){this.noteFlashIndex=0,this.assistTickIndex=0;return}this.assistTick.stop(),this.noteFlashIndex=hi(this.loadedChart.getNotedata(),this.time,e=>e.second)+1,this.noteFlashIndex>=1&&this.time<=this.loadedChart.getNotedata()[this.noteFlashIndex-1].second&&this.noteFlashIndex--,this.assistTickIndex=this.noteFlashIndex;for(const e of this.holdFlashes)e.type=="Hold"?this.chartView.getNotefield().releaseHold(e.col):e.type=="Roll"&&this.chartView.getNotefield().releaseRoll(e.col);this.holdFlashes=[]}playPause(){this.setNoteIndex(),this.chartAudio.isPlaying()?(this.chartAudio.pause(),this._beat=this.loadedChart?.getBeatFromSeconds(this.time)??0):this.chartAudio.play()}getClosestTick(e,t){if(!this.loadedChart)return 0;const n=Math.max(.001,4/t),a=this.loadedChart.timingData.getBeatOfMeasure(e),r=e-a,s=Math.round(a/n)*n;return Math.max(0,r+s)}snapToNearestTick(e){this.beat=Math.max(0,this.getClosestTick(e,4/b.chart.snap))}snapToPreviousTick(){if(!this.loadedChart)return;const e=Math.max(.001,b.chart.snap),t=Math.floor(this.loadedChart.timingData.getMeasure(this.beat)),n=this.loadedChart.timingData.getBeatFromMeasure(t),a=Math.floor((this.beat-n)/e)*e,r=Math.abs(a-(this.beat-n))<5e-4?a-e:a,s=r+n;if(r<0){const o=this.loadedChart.timingData.getBeatFromMeasure(t-1),l=Math.round((s-o)/e)*e;this.beat=Math.max(0,o+l);return}this.beat=Math.max(0,s)}snapToNextTick(){if(!this.loadedChart)return;const e=Math.max(.001,b.chart.snap),t=Math.floor(this.loadedChart.timingData.getMeasure(this.beat)),n=this.loadedChart.timingData.getBeatFromMeasure(t),s=Math.floor((this.beat-n+5e-4)/e)*e+e+n,o=this.loadedChart.timingData.getBeatFromMeasure(t+1);if(s>o){this.beat=o;return}this.beat=s}previousSnap(){let e=this.getSnapIndex()-1;e=(e+Ut.length)%Ut.length,b.chart.snap=Ut[e]==-1?0:1/Ut[e],ie.emit("snapChanged")}nextSnap(){let e=this.getSnapIndex();(e==Ut.length-1||Math.abs(1/b.chart.snap-Ut[e])<=5e-4)&&e++,e=(e+Ut.length)%Ut.length,b.chart.snap=Ut[e]==-1?0:1/Ut[e],ie.emit("snapChanged")}getSnapIndex(){return b.chart.snap==0?Ut.length-1:Ut.findIndex(e=>1/e<=b.chart.snap)}removeDuplicateBeats(e){if(e.length===0)return e;const t=[e[0]];for(let n=1;n<e.length;n++)e[n-1]!==e[n]&&t.push(e[n]);return t}getRows(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return[];if(this.loadedChart.getNotedata().length==0)return[];const e=this.loadedChart.getNotedata().filter(Oe).map(n=>n.beat+n.hold),t=this.loadedChart.getNotedata().map(n=>n.beat).concat(e).sort((n,a)=>n-a);return this.removeDuplicateBeats(t)}previousNote(){const e=this.getRows();if(e.length==0)return;let t=hi(e,this.beat);this.beat==e[t]&&t--,this.beat=e[Math.max(0,t)]}nextNote(){const e=this.getRows();if(e.length==0)return;let t=hi(e,this.beat);this.beat>=e[t]&&t++,this.beat=e[Math.min(e.length-1,t)]}firstNote(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;const e=this.loadedChart.getNotedata();e.length!=0&&(this.beat=e[0].beat)}lastNote(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;const e=this.loadedChart.getNotedata();if(e.length==0)return;const t=e[e.length-1];this.beat=Ni(t)}truncateHold(e,t){const n=Te(Math.round((t-Math.max(.020833333333333332,b.chart.snap))*48)/48,e.beat,e.beat+e.hold-.020833333333333332);return n==e.beat?{beat:e.beat,col:e.col,type:"Tap"}:{beat:e.beat,col:e.col,type:e.type,hold:n-e.beat}}setNote(e,t,n=this.beat){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;if(n=Math.max(0,Math.round(n*48)/48),b.chart.forceSnapNotes){const o=b.chart.snap==0?.020833333333333332:b.chart.snap;n=Math.round(n/o)*o}const a=this.loadedChart.getNotedata().filter(o=>o.col!=e?!1:Math.abs(o.beat-n)<.003?!0:Oe(o)&&o.beat==n),r=this.loadedChart.getNotedata().filter(o=>Oe(o)&&o.col==e&&n>o.beat&&n<=Math.round((o.beat+o.hold)*48)/48).map(o=>({oldNote:o,newNote:this.truncateHold(o,n)})),s={startBeat:n,endBeat:n,roll:!1,originalNote:void 0,type:t,removedNotes:a,truncatedHolds:r,direction:null};this.holdEditing[e]=s,a.length==0&&(s.originalNote={beat:n,col:e,type:this.getEditingNoteType()}),this.setNoteIndex(),this.app.actionHistory.run({action:()=>{s.removedNotes.forEach(o=>{this.loadedChart.removeNote(o),this.removeNoteFromSelection(o)}),s.truncatedHolds.forEach(o=>this.loadedChart.modifyNote(o.oldNote,o.newNote)),s.originalNote&&this.loadedChart.addNote(s.originalNote)},undo:()=>{s.originalNote&&this.loadedChart.removeNote(s.originalNote),s.truncatedHolds.forEach(o=>this.loadedChart.modifyNote(o.newNote,o.oldNote)),s.removedNotes.forEach(o=>this.loadedChart.addNote(o))}})}editHoldBeat(e,t,n){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;const a=this.holdEditing[e];if(a==null||(t=Math.round(t*48)/48,t==a.startBeat&&t==a.endBeat))return;if(a.direction===null&&(t<a.startBeat?a.direction="up":a.direction="down"),b.chart.defaultHoldPlacement?a.direction=="up"?a.startBeat=Math.min(a.endBeat,Math.round(t*48)/48):a.endBeat=Math.max(a.startBeat,Math.round(t*48)/48):(a.startBeat=Math.min(a.startBeat,Math.round(t*48)/48),a.endBeat=Math.max(a.endBeat,Math.round(t*48)/48)),a.roll||=n,a.originalNote){const s={beat:a.startBeat,type:a.roll?"Roll":"Hold",hold:a.endBeat-a.startBeat};a.endBeat-a.startBeat==0&&(s.hold=void 0,s.type="Tap"),(s.beat!=a.originalNote.beat||s.type!=a.originalNote.type||Oe(a.originalNote)&&s.hold!=a.originalNote.hold)&&this.loadedChart.modifyNote(a.originalNote,s)}else{const s={beat:a.startBeat,col:e,type:a.roll?"Roll":"Hold",hold:a.endBeat-a.startBeat};a.endBeat-a.startBeat==0&&(s.type="Tap",Object.assign(s,{hold:void 0})),this.loadedChart.addNote(s)}a.originalNote={beat:a.startBeat,col:e,type:a.endBeat-a.startBeat==0?"Tap":a.roll?"Roll":"Hold",hold:a.endBeat-a.startBeat==0?void 0:a.endBeat-a.startBeat};const r=this.loadedChart.getNotedata().filter(s=>s.beat==a.originalNote.beat&&s.col==a.originalNote.col||s.col!=e?!1:s.beat>=a.startBeat&&s.beat<=a.endBeat?!0:Oe(s)&&s.beat+s.hold>=a.startBeat&&s.beat+s.hold<=a.endBeat);a.removedNotes=a.removedNotes.concat(r),r.forEach(s=>this.loadedChart.removeNote(s)),this.setNoteIndex()}endEditing(e){this.holdEditing[e]=void 0}previousNoteType(){const e=this.loadedChart?.gameType.editNoteTypes.length??0;this.editNoteTypeIndex=(this.editNoteTypeIndex-1+e)%e}nextNoteType(){const e=this.loadedChart?.gameType.editNoteTypes.length??0;this.editNoteTypeIndex=(this.editNoteTypeIndex+1+e)%e}getEditingNoteType(){return this.loadedChart?.gameType.editNoteTypes[this.editNoteTypeIndex]??null}setEditingNoteType(e){if(!this.loadedChart)return;const n=(this.loadedChart?.gameType.editNoteTypes).indexOf(e);n!=-1&&(this.editNoteTypeIndex=n)}getMode(){return this.mode}setMode(e){if(!this.loadedChart||!this.chartView)return;if(this.mode==e){(e=="Play Mode"||e=="Record Mode")&&(this.setMode(this.lastMode),this.setNoteIndex(),this.chartAudio.pause());return}(this.mode=="View Mode"||this.mode=="Edit Mode")&&(this.lastMode=this.mode),this.mode=e;const t=this.loadedChart.getNotedata();if(this.mode=="Play Mode"){t.forEach(n=>{n.gameplay={hideNote:!1,hasHit:!1}}),this.holdFlashes=[];for(let n=0;n<this.loadedChart.gameType.numCols;n++)this.chartView.getNotefield().releaseHold(n),this.chartView.getNotefield().releaseRoll(n);for(const n of t)if(n.second<this.time)n.gameplay.hasHit=!0;else break;this.gameStats=new Vg(this),this.widgetManager.startPlay(),this.chartAudio.seek(Math.max(0,this.time)-1),this.loadedChart.gameType.gameLogic.startPlay(this),this.chartAudio.play(),this.chartView.startPlay()}else this.mode=="Record Mode"?(this.chartAudio.seek(Math.max(0,this.time)-1),this.chartAudio.play()):(this.chartView.endPlay(),t.forEach(n=>n.gameplay=void 0))}judgeCol(e){if(!(!this.loadedChart||!this.chartView)){if(this.mode=="Play Mode")this.loadedChart.gameType.gameLogic.keyDown(this,e);else if(this.mode=="Record Mode"){const t=this.loadedChart.getBeatFromSeconds(this.time+b.play.offset),n=b.chart.snap==0?1/48:b.chart.snap,a=Math.round(t/n)*n;this.setNote(e,"key",a)}}}judgeColUp(e){!this.loadedChart||!this.chartView||(this.mode=="Play Mode"?this.loadedChart.gameType.gameLogic.keyUp(this,e):this.mode=="Record Mode"&&this.endEditing(e))}async save(){if(!this.loadedSM||this.smPath.startsWith("https://")||this.smPath.startsWith("http://"))return;const e=this.getSMPath(".sm"),t=this.getSMPath(".ssc");let n=null;!this.loadedSM.usesChartTiming()&&await Ce.getFileHandle(this.getSMPath(".sm"))&&await Ce.writeFile(e,this.loadedSM.serialize("sm")).catch(a=>{const r=a.message;r.includes(mn.GONE[0])||(n=r)}),(this.loadedSM.requiresSSC()||await Ce.getFileHandle(t))&&await Ce.writeFile(t,this.loadedSM.serialize("ssc")).catch(a=>{const r=a.message;r.includes(mn.GONE[0])||(n=r)}),await Ce.writeFile(this.getDataPath(),bd(this.loadedSM)).catch(a=>{const r=a.message;r.includes(mn.GONE[0])||(n=r)}),n==null?(this.loadedSM.usesChartTiming()?ce.create("Saved. No SM file since split timing was used."):ce.create("Saved"),await this.removeAutosaves()):ce.createFormatted("Failed to save file: "+n,"error"),Mt.instance.setLimit()}getDataPath(){if(window.nw){const e=window.nw.require("path"),t=e.parse(this.smPath);return e.resolve(t.dir,"data.sme")}else return at(this.smPath)+"/data.sme"}getSMPath(e){if(window.nw){const t=window.nw.require("path"),n=t.parse(this.smPath);return t.resolve(n.dir,n.name+e)}else{const t=at(this.smPath),n=Tt(this.smPath),a=n.includes(".")?n.split(".").slice(0,-1).join("."):n;return t+"/"+a+e}}async removeAutosaves(){await Ce.removeFile(this.getSMPath(".smebak")).catch(()=>{})}async autosave(){if(!this.loadedSM||this.smPath.startsWith("https://")||this.smPath.startsWith("http://"))return;let e=null;await Ce.writeFile(this.getSMPath(".smebak"),this.loadedSM.serialize("smebak")).catch(t=>{const n=t.message;n.includes(mn.GONE[0])||(e=n)}),e==null?ce.create("Autosaved"):ce.createFormatted("Failed to autosave file: "+e,"error")}hasSelection(){return this.hasNoteSelection()||this.hasEventSelection()}hasNoteSelection(){return this.selection.notes.length>0||this.startRegion!==void 0&&this.endRegion!==void 0}hasEventSelection(){return this.eventSelection.timingEvents.length>0}hasRange(){return this.selection.notes.length>1||this.eventSelection.timingEvents.length>1||this.startRegion!==void 0&&this.endRegion!==void 0}clearSelections(){this.selection={notes:[],inProgressNotes:[]},this.eventSelection={timingEvents:[],inProgressTimingEvents:[]}}startDragSelection(){this.selection.inProgressNotes=[]}endDragSelection(){let e=0,t=0;const n=[],a=this.selection.inProgressNotes,r=this.selection.notes,s=(o,l)=>o.beat==l.beat?o.col-l.col:o.beat-l.beat;if(a.length==0||r.length==0){this.selection.notes=a.concat(r),this.selection.inProgressNotes=[];return}for(;;)if(s(a[e],r[t])<0){if(n.push(a[e]),e++,e>=a.length){this.selection.notes=n.concat(r.slice(t));break}}else if(n.push(r[t]),t++,t>=r.length){this.selection.notes=n.concat(a.slice(e));break}this.selection.inProgressNotes=[]}startDragEventSelection(){this.eventSelection.inProgressTimingEvents=[]}endDragEventSelection(){let e=0,t=0;const n=[],a=this.eventSelection.inProgressTimingEvents,r=this.eventSelection.timingEvents,s=(o,l)=>o.beat-l.beat;if(a.length==0||r.length==0){this.eventSelection.timingEvents=a.concat(r),this.eventSelection.inProgressTimingEvents=[];return}for(;;)if(s(a[e],r[t])<0){if(n.push(a[e]),e++,e>=a.length){this.eventSelection.timingEvents=n.concat(r.slice(t));break}}else if(n.push(r[t]),t++,t>=r.length){this.eventSelection.timingEvents=n.concat(a.slice(e));break}this.eventSelection.inProgressTimingEvents=[]}addNoteToDragSelection(e){this.addNoteSelection(this.selection.inProgressNotes,e)}removeNoteFromDragSelection(e){this.removeNoteSelection(this.selection.inProgressNotes,e)}addEventToDragSelection(e){this.addEventSelection(this.eventSelection.inProgressTimingEvents,e)}removeEventFromDragSelection(e){this.removeEventSelection(this.eventSelection.inProgressTimingEvents,e)}addNoteToSelection(e){this.addNoteSelection(this.selection.notes,e)}removeNoteFromSelection(e){this.removeNoteSelection(this.selection.notes,e)}setNoteSelection(e){this.selection.inProgressNotes=[],this.selection.notes=[...e].sort((t,n)=>t.beat==n.beat?t.col-n.col:t.beat-n.beat)}addEventToSelection(e){this.addEventSelection(this.eventSelection.timingEvents,e)}removeEventFromSelection(e){this.removeEventSelection(this.eventSelection.timingEvents,e)}setEventSelection(e){this.eventSelection.inProgressTimingEvents=[],this.eventSelection.timingEvents=e.sort((t,n)=>t.beat-n.beat)}isNoteInSelection(e){return this.getNoteSelectionIndex(this.selection.notes,e)!=-1||this.getNoteSelectionIndex(this.selection.inProgressNotes,e)!=-1}isEventInSelection(e){return this.getEventSelectionIndex(this.eventSelection.timingEvents,e)!=-1||this.getEventSelectionIndex(this.eventSelection.inProgressTimingEvents,e)!=-1}addNoteSelection(e,t){let n=Fn(e,t.beat,a=>a.beat);for(;e[n]&&(e[n].beat<t.beat||e[n].beat==t.beat&&e[n].col<t.col);)n++;e.splice(n,0,t)}removeNoteSelection(e,t){const n=this.getNoteSelectionIndex(e,t);n!=-1&&e.splice(n,1)}getNoteSelectionIndex(e,t){let n=Fn(e,t.beat,a=>a.beat);for(;e[n]&&e[n].beat==t.beat;){if(Uo(e[n],t))return n;n++}return-1}addEventSelection(e,t){let n=Fn(e,t.beat,a=>a.beat);for(;e[n]&&e[n].beat<=t.beat;)n++;e.splice(n,0,t)}removeEventSelection(e,t){const n=this.getEventSelectionIndex(e,t);n!=-1&&e.splice(n,1)}getEventSelectionIndex(e,t){let n=Fn(e,t.beat,a=>a.beat);for(;e[n]&&e[n].beat==t.beat;){if(Uo(e[n],t))return n;n++}return-1}selectRegion(){if(this.loadedChart){if(this.endRegion!==void 0&&(this.startRegion=void 0,this.endRegion=void 0),this.startRegion===void 0){this.clearSelections(),this.startRegion=this.beat;return}this.endRegion=this.beat,this.endRegion<this.startRegion&&(this.endRegion=this.startRegion,this.startRegion=this.beat),ie.emit("regionChanged",this.startRegion,this.endRegion),this.editTimingMode==0?this.setNoteSelection(this.loadedChart.getNotedataInRange(this.startRegion,this.endRegion)):this.setEventSelection(Ia.flatMap(e=>this.loadedChart.timingData.getColumn(e).events).filter(e=>e.beat>=this.startRegion&&e.beat<=this.endRegion))}}modifySelection(e,t=!1){if(!this.loadedChart)return;const n=this.selection.notes,a=structuredClone(this.selection.notes).map(e).sort((l,u)=>l.beat==u.beat?l.col-u.col:l.beat-u.beat);if(a.length==0)return;const r=[];for(const l of a){const u=r.at(-1);u!==void 0&&u.beat==l.beat&&u.col==l.col||r.push(l)}if(r.length==0)return;const{removedNotes:s,truncatedHolds:o}=this.checkConflicts(r,n);if(t){const l=r.map(h=>Ni(h));let u=0;for(const h of l)h>u&&(u=h);const f=new Array(this.loadedChart.gameType.numCols).fill(0).map((h,p)=>({type:"Hold",hold:u-r[0].beat,col:p,beat:r[0].beat})),{removedNotes:c,truncatedHolds:d}=this.checkConflicts(f,n);c.forEach(h=>{s.includes(h)||s.push(h)}),d.forEach(h=>{const p=o.find(m=>m.oldNote==h.oldNote);if(p){const m=Oe(p.newNote)?p.newNote.hold:0,g=Oe(p.newNote)?p.newNote.hold:0,y=Math.min(m,g);y==0?p.newNote={beat:p.newNote.beat,col:p.newNote.col,type:"Tap"}:p.newNote={beat:p.newNote.beat,col:p.newNote.col,type:p.newNote.type,hold:y}}}),s.sort((h,p)=>h.beat==p.beat?h.col-p.col:h.beat-p.beat),o.sort((h,p)=>h.newNote.beat==p.newNote.beat?h.newNote.col-p.newNote.col:h.newNote.beat-p.newNote.beat)}this.app.actionHistory.run({action:()=>{this.loadedChart.removeNotes(n.concat(s),!1),o.forEach(l=>this.loadedChart.modifyNote(l.oldNote,l.newNote,!1)),this.clearSelections(),this.setNoteSelection(this.loadedChart.addNotes(r))},undo:()=>{this.loadedChart.removeNotes(r,!1),o.forEach(l=>this.loadedChart.modifyNote(l.newNote,l.oldNote,!1)),this.loadedChart.addNotes(s,!1),this.clearSelections(),this.setNoteSelection(this.loadedChart.addNotes(n))}})}checkConflicts(e,t=[]){if(e.length==0)return{removedNotes:[],truncatedHolds:[]};const n=this.loadedChart.getNotedata(),a=this.loadedChart.gameType.numCols,r=new Array(a).fill(0).map(f=>[]);for(const f of n)r[f.col].push(f);const s=new Array(a).fill(0).map(f=>[]);for(const f of e)f.col>a||s[f.col].push(f);const o=[],l=[],u=[];for(let f=0;f<a;f++){if(s[f].length==0)continue;let c=r[f].findIndex(d=>s[f][0].beat<=(Oe(d)?d.beat+d.hold:d.beat));for(const d of s[f])for(;r[f][c];){const h=r[f][c],p=Oe(d)?d.beat+d.hold:d.beat;if(!t.includes(h)&&!u.includes(h)&&(d.beat<=h.beat&&p>=h.beat?(u.push(h),o.push(h)):Oe(h)&&h.beat+h.hold>=d.beat&&h.beat<d.beat&&(u.push(h),l.push({oldNote:h,newNote:this.truncateHold(h,d.beat)}))),r[f][c+1]?.beat>p)break;c++}}return o.sort((f,c)=>f.beat==c.beat?f.col-c.col:f.beat-c.beat),l.sort((f,c)=>f.newNote.beat==c.newNote.beat?f.newNote.col-c.newNote.col:f.newNote.beat-c.newNote.beat),{removedNotes:o,truncatedHolds:l}}modifyEventSelection(e){if(!this.loadedChart||!this.loadedSM)return;const t=this.eventSelection.timingEvents.map(n=>[n,e(structuredClone(n))]);this.loadedChart.timingData.modifyColumnEvents(t)}deleteSelection(){if(this.selection.notes.length==0)return;const e=this.selection.notes;this.app.actionHistory.run({action:()=>{this.loadedChart.removeNotes(e),this.clearSelections()},undo:()=>{this.selection.notes=this.loadedChart.addNotes(e)}})}deleteEventSelection(){this.eventSelection.timingEvents.length!=0&&(!this.loadedChart||!this.loadedSM||this.loadedChart.timingData.deleteColumnEvents(this.eventSelection.timingEvents))}paste(e,t=!1){if(this.loadedChart&&(e.startsWith("ArrowVortex:notes:")&&(this.pasteNotes(e,t)||this.pasteNotes(this.virtualClipboard,t)),e.startsWith("ArrowVortex:tempo:")||e.startsWith("SMEditor:tempo:"))){this.pasteTempo(e)||this.pasteTempo(this.virtualClipboard);return}}pasteNotes(e,t=!1){if(!this.loadedChart)return!0;const n=Km(e);return!n||n.length==0?!1:(this.insertNotes(n.map(a=>(a.beat+=this.beat,a.beat=Math.round(a.beat*48)/48,a)),t),!0)}insertNotes(e,t=!1){e.sort((r,s)=>r.beat==s.beat?r.col-s.col:r.beat-s.beat);const{removedNotes:n,truncatedHolds:a}=this.checkConflicts(e);if(t){const r=e.map(f=>Ni(f));let s=0;for(const f of r)f>s&&(s=f);const o=new Array(this.loadedChart.gameType.numCols).fill(0).map((f,c)=>({type:"Hold",hold:s-e[0].beat,col:c,beat:e[0].beat})),{removedNotes:l,truncatedHolds:u}=this.checkConflicts(o);l.forEach(f=>{n.includes(f)||n.push(f)}),u.forEach(f=>{const c=a.find(d=>d.oldNote==f.oldNote);if(c){const d=Oe(c.newNote)?c.newNote.hold:0,h=Oe(c.newNote)?c.newNote.hold:0,p=Math.min(d,h);p==0?c.newNote={beat:c.newNote.beat,col:c.newNote.col,type:"Tap"}:c.newNote={beat:c.newNote.beat,col:c.newNote.col,type:c.newNote.type,hold:p}}}),n.sort((f,c)=>f.beat==c.beat?f.col-c.col:f.beat-c.beat),a.sort((f,c)=>f.newNote.beat==c.newNote.beat?f.newNote.col-c.newNote.col:f.newNote.beat-c.newNote.beat)}this.app.actionHistory.run({action:()=>{this.loadedChart.removeNotes(n,!1),a.forEach(r=>{this.loadedChart.modifyNote(r.oldNote,r.newNote,!1)}),this.clearSelections(),this.setNoteSelection(this.loadedChart.addNotes(e))},undo:()=>{this.loadedChart.removeNotes(e,!1),a.forEach(r=>{this.loadedChart.modifyNote(r.newNote,r.oldNote,!1)}),this.setNoteSelection(this.loadedChart.addNotes(n)),this.clearSelections()}})}pasteTempo(e){if(!this.loadedChart||!this.loadedSM)return!0;const t=ig(e);return!t||t.length==0?!1:(t.forEach(n=>{n.type=="ATTACKS"?n.second+=this.time:n.beat+=this.beat}),this.loadedChart.timingData.insertColumnEvents(t),!0)}copy(){if(this.selection.notes.length!=0){const e=Math.min(...this.selection.notes.map(a=>a.beat)),t=structuredClone(this.selection.notes).map(a=>(a.beat-=e,a)).sort((a,r)=>a.beat==r.beat?a.col-r.col:a.beat-r.beat),n=Xm(t);return this.virtualClipboard=n,n}else if(this.eventSelection.timingEvents.length!=0){const e=Math.min(...this.eventSelection.timingEvents.map(r=>r.beat)),t=this.loadedChart.timingData.getSecondsFromBeat(e),n=structuredClone(this.eventSelection.timingEvents).map(r=>r.type=="ATTACKS"?(r.second-=t,r):(r.beat-=e,r)).sort((r,s)=>r.type!=s.type?r.type.localeCompare(s.type):r.type=="ATTACKS"?r.second-s.second:r.beat-s.beat),a=Jm(n);return this.virtualClipboard=a,a}}}class Wg{app;view;constructor(e,t){if(this.app=e,this.view=t,!fe.menuBar)return;const n=Object.values(bn).map(a=>this.createElement(a));t.replaceChildren(...n)}createElement(e){if(e.type=="separator"){const t=document.createElement("div");return t.classList.add("separator"),t}if(e.type=="selection"||e.type=="checkbox"||e.type=="dropdown"){const t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div");let r;if(e.type=="selection"||e.type=="checkbox"){const s=$e[e.id]??{label:e.id,combos:[],callback:()=>{}};r=document.createElement("div"),r.innerText=Ae.getKeybindString(e.id),r.classList.add("keybind","unselectable"),a.innerText=s.label;let o=s.disabled;typeof o=="function"&&(o=o(this.app)),o&&t.classList.add("disabled"),t.addEventListener("click",()=>{let l=s.disabled;typeof l=="function"&&(l=l(this.app)),l||s.callback(this.app),t.closest(".menu-main").querySelector(".menubar-dropdown").replaceChildren()})}else r=be.getIcon("CHEVRON",16),r.style.transform="rotate(-90deg)",a.innerText=typeof e.title=="function"?e.title(this.app):e.title;if(n.appendChild(a),n.appendChild(r),t.appendChild(n),t.classList.add("menu-item"),n.classList.add("menu-item-title","menu-hover"),a.classList.add("title","unselectable"),e.type=="dropdown"){const s=document.createElement("div");t.appendChild(s),s.classList.add("menubar-dropdown"),e.options.map(o=>this.createElement(o)).forEach(o=>s.appendChild(o))}if(e.type=="checkbox"){let s=e.checked;typeof s=="function"&&(s=s(this.app)),s&&(a.innerText="✓ "+a.innerText)}return t}if(e.type=="menu"){const t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div");return t.appendChild(n),n.innerText=e.title,t.appendChild(a),n.classList.add("title","unselectable"),t.classList.add("menu-item","menu-main"),n.classList.add("menu-hover"),a.classList.add("menubar-dropdown","unselectable"),t.onmouseenter=()=>{a.replaceChildren(...e.options.map(r=>this.createElement(r)))},t.onmouseleave=()=>{a.replaceChildren()},t}return document.createElement("div")}}class Gg{view;windows=[];app;constructor(e,t){this.app=e,this.view=t}unfocusAll(){for(const e of this.view.querySelectorAll(".focused"))e.classList.remove("focused")}getFocusedWindow(){for(const e of this.windows)if(e.windowElement.classList.contains("focused"))return e;return null}isBlocked(){return!this.windows.every(e=>!e.options.blocking)}openWindow(e){if(e.options.win_id){const t=this.getWindowById(e.options.win_id);if(t){t.focus();return}}e.addToManager(this),this.windows.push(e)}removeWindow(e){this.windows.splice(this.windows.indexOf(e),1)}getWindowById(e){for(const t of this.windows)if(t.options.win_id==e)return t}}const Bs=960;class qg{VERSION="1.4.0";options=b;events=ie;themes=Fe;renderer;stage;view;chartManager;windowManager;menubarManager;actionHistory;capturing=!1;STAGE_HEIGHT=Bs;STAGE_WIDTH=Bs;lastWidth=-1;lastHeight=-1;constructor(){if(Xe.setDefaultProps({duration:[200,100],theme:"sm"}),b.loadOptions(),yd(),Ae.load(this),window.nw){const e=nw.Window.get();b.app.fullscreen?e.enterFullscreen():e.resizeTo(b.app.width,b.app.height)}if(setInterval(()=>{this.capturing||b.saveOptions()},1e4),b.general.smoothAnimations&&document.body.classList.add("animated"),document.body.parentElement.style.fontSize=`${b.general.uiScale*100}%`,this.registerFonts(),this.view=document.getElementById("pixi"),document.oncontextmenu=e=>{e.preventDefault(),this.chartManager.loadedChart&&e.target==this.view&&Qs.open(this,e)},this.view.onmousedown=()=>{Qs.close()},this.stage=new de,this.stage.sortableChildren=!0,this.renderer=new wd({backgroundColor:1579292,antialias:b.performance.antialiasing,width:this.view.clientWidth,height:this.view.clientHeight,resolution:b.performance.resolution,autoDensity:!0,view:this.view,powerPreference:"low-power"}),vt.shared.maxFPS=0,vt.shared.add(()=>{const e=performance.now();this.chartManager.widgetManager.update(),this.chartManager.loadedSM&&this.chartManager.loadedChart&&this.chartManager.chartView&&this.chartManager.chartView.update(),en.instance?.addDrawUpdateTimeValue(performance.now()-e);const t=performance.now();this.renderer.render(this.stage),en.instance?.addFrameTimeValue(performance.now()-t),performance.memory?.usedJSHeapSize&&en.instance?.addMemoryTimeValue(performance.memory.usedJSHeapSize),Mm()},Gc.HIGH),lt.init(this.renderer),this.chartManager=new Ug(this),this.menubarManager=new Wg(this,document.getElementById("menubar")),this.windowManager=new Gg(this,document.getElementById("windows")),this.actionHistory=new Mt(this),this.registerListeners(),!fe.hidePoweredByText&&vd()){const e=document.getElementById("embed");e.appendChild(document.createTextNode("Powered by "));const t=document.createElement("a");if(t.href="https://tillvit.github.io/smeditor/",t.innerText="SMEditor",t.target="_blank",e.appendChild(t),fe.url!=null){e.appendChild(document.createTextNode(" | Open this chart in a "));const n=document.createElement("a"),a=new URL(location.origin+"/smeditor/app/");n.innerText="new tab",n.target="_blank",a.searchParams.append("url",fe.url),fe.chartType!==null&&a.searchParams.append("chartType",fe.chartType),fe.chartIndex!==null&&a.searchParams.append("chartIndex",fe.chartIndex+""),n.href=a.toString(),e.appendChild(n)}}Ce.initFileSystem().then(()=>{if(fe.url){this.chartManager.loadSM(fe.url).then(()=>{const e=this.chartManager.loadedSM;if(!e)return;let t;if(fe.chartType!=null&&(t=e.charts[fe.chartType],t===void 0)){ce.createFormatted(`Couldn't find chart with type ${fe.chartType}`,"warn");return}if(t===void 0){const a=Object.keys(e.charts);if(a.length==0||(t=e.charts[a[0]],t.length==0))return}let n;if(fe.chartIndex!=null&&(n=t.at(fe.chartIndex),n===void 0)){ce.createFormatted(`Couldn't find chart with index ${fe.chartIndex}`,"warn");return}n===void 0&&(n=t.at(-1),!n)||this.chartManager.loadChart(n)});return}if(this.windowManager.openWindow(new Lo(this)),window.nw){const e=nw.Window.get();nw.App.on("open",t=>{if(!t||t?.length===0){nw.Window.open(window.location.href);return}let n="";for(let a of t)if(a.startsWith("file://")&&(a=a.substring(7)),At(a)==".ssc"){n=a;break}else n==""&&At(a)==".sm"&&(n=a);n!=""&&(this.chartManager.loadSM(n),this.windowManager.getWindowById("select_sm_initial")?.closeWindow())}),window.addEventListener("keydown",t=>{t.key=="r"&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),e.reload()),t.code=="KeyW"&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),e.close()),process.versions["nw-flavor"]=="sdk"&&t.code=="KeyI"&&t.metaKey&&t.altKey&&(t.preventDefault(),e.showDevTools())}),e.on("enter-fullscreen",()=>{b.app.fullscreen=e.isFullscreen}),e.on("resize",(t,n)=>{e.isFullscreen||(b.app.width=t,b.app.height=n)}),e.on("restore",()=>{b.app.fullscreen=e.isFullscreen}),this.checkAppVersion()}this.checkCoreVersion()}),window.onbeforeunload=e=>{if(Mt.instance.isDirty()&&b.general.warnBeforeExit)return e.preventDefault(),e.returnValue="Are you sure you want to exit?"},window.onpagehide=()=>{this.capturing||b.saveOptions()},Fe.loadTheme(b.general.theme),vt.shared.start()}registerFonts(){ur.from("Main",{fontFamily:"Assistant",fontSize:20,fill:"white"},{chars:[["a","z"],["A","Z"],"!@#$%^&*()~{}[]:.-?=,_|","0123456789/"," "],resolution:window.devicePixelRatio}),ur.from("Mono",{fontFamily:"monospace",fontSize:20,fill:"white"},{chars:[["a","z"],["A","Z"],"!@#$%^&*()~{}[]:.-?=,_|","0123456789/"," "],resolution:window.devicePixelRatio}),ur.from("Fancy",{fontFamily:"Assistant",fontSize:40,fontWeight:"700",fill:["#dddddd","#ffffff"],fillGradientType:xd.LINEAR_VERTICAL,stroke:11184810,strokeThickness:3},{chars:[["a","z"],["A","Z"],"!@#$%^&*()~{}[]:.-?=,_|","0123456789/"," "],resolution:window.devicePixelRatio})}registerListeners(){this.view.addEventListener("mousedown",()=>{this.windowManager.unfocusAll()}),ie.on("themeChanged",()=>{this.renderer.background.color=new B(Fe.getCurrentTheme()["editor-bg"]).toNumber()}),ie.on("userOptionUpdated",e=>{e=="general.uiScale"&&this.updateSize()}),window.addEventListener("keydown",function(e){e.code=="Enter"&&e.target instanceof HTMLButtonElement&&e.preventDefault()}),window.addEventListener("dragstart",function(e){e.target instanceof HTMLImageElement&&e.preventDefault()}),setInterval(()=>{if(this.capturing)return;const e=window.innerWidth,t=this.getCanvasHeight();(this.lastHeight!=t||this.lastWidth!=e)&&(this.lastHeight=t,this.lastWidth=e,this.onResize(e,t),ie.emit("resize"))},100),window.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),window.addEventListener("drop",e=>{if(window.nw){e.stopPropagation(),e.preventDefault();let t="";for(const n of e.dataTransfer.files)if(n.path)if(At(n.path)==".ssc"){t=n.path;break}else t==""&&At(n.path)==".sm"&&(t=n.path);t!=""&&(this.chartManager.loadSM(t),this.windowManager.getWindowById("select_sm_initial")?.closeWindow())}else Ce.handleDropEvent(e).then(t=>{const n=new or(this,{title:"Select an sm/ssc file...",accepted_file_types:[".sm",".ssc"],disableClose:!0,callback:a=>{this.chartManager.loadSM(a),this.windowManager.getWindowById("select_sm_initial")?.closeWindow()},onload:()=>{n.getAcceptableFile(t??"").then(a=>n.selectPath(a))}});this.windowManager.openWindow(n)})})}onResize(e,t){this.renderer.screen.width=e,this.renderer.screen.height=t,this.view.width=e*this.renderer.resolution,this.view.height=t*this.renderer.resolution,this.view.style.width=`${e}px`,this.view.style.height=`${t}px`,this.STAGE_HEIGHT=Bs/b.general.uiScale;const n=t/this.STAGE_HEIGHT;this.stage.scale.set(n),this.stage.position.set(e/2,t/2),this.STAGE_WIDTH=e/n}updateSize(){const e=window.innerWidth,t=this.getCanvasHeight();this.lastHeight=t,this.lastWidth=e,this.onResize(e,t),ie.emit("resize")}getCanvasHeight(){return window.innerHeight-(document.getElementById("menubar")?.clientHeight??0)-(document.getElementById("playback-options")?.clientHeight??0)}checkAppVersion(){if(!window.nw)return;const e=nw.require("nw.gui"),t={stable:3,beta:2,alpha:1,nightly:0};let n="win";process.platform=="darwin"?n=nw.require("os").arch()=="arm64"?"mac-arm":"mac-x64":process.platform=="linux"&&(n="linux"),fetch("/smeditor/assets/app/versions.json").then(a=>a.json()).then(a=>{a=a.sort((s,o)=>t[s.type]!=t[o.type]?t[o.type]-t[s.type]:o.date-s.date);const r=a[0];Il.lt(e.App.manifest.version,r.version)&&localStorage.getItem("downloadedVersion")!==r.version&&Ju.open(r.version,r.downloads[n])})}checkCoreVersion(){const e=Qd({});navigator.serviceWorker.addEventListener("controllerchange",()=>{ed.open(e),console.log("Found new version")});const t=localStorage.getItem("coreVersion");t!==null&&Il.lt(t,this.VERSION)&&this.windowManager.openWindow(new Vu(this)),localStorage.setItem("coreVersion",this.VERSION)}}document.querySelector("body").innerHTML=`<div id="popups"></div>
          <div id="view-wrapper">
            <div id="menubar"></div>
            <div id="waterfall"><div id="waterfall-container"></div></div>
            <canvas id="pixi"></canvas>
          </div>
          <div id="context-menu"></div>
          <div id="blocker" style="display: none"></div>
          <div id="windows"></div>
          <div id="embed"></div>
        `;th.load({custom:{families:["Assistant"]},active:Oc,inactive:Oc,classes:!1});function Oc(){const i=document.createElement("canvas");i.getContext("webgl")||i.getContext("experimental-webgl")?(window.app=new qg,window.GameTypeRegistry=yt,window.NoteskinRegistry=it):document.querySelector("body").innerHTML=`<div class='browser-unsupported'>
      <div class='browser-unsupported-item'>
      <h1>WebGL is not enabled</h1>
      <div>Please visit your browser settings and enable WebGL.</div>
      </div>
    </div>`}export{Zg as A,rt as B,nn as F,rd as H,We as _,ra as a,pt as b,mn as e,ih as i,Xg as l,go as r,Kg as s};
