const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["memory-TENAsLGL.js","Simfile-DgZSKnU-.js","assets/Simfile-Bi8zDpmu.css","downloader-DjQwgpik.js","FileSystemWritableFileStream-D05uA35V.js","web-streams-ponyfill-BfVhaP7e.js","NodeFileHandler-DCs-8a02.js","Noteskin-CR6HHWkZ.js","HoldBody-DrZoJoRZ.js","Noteskin-DSc9KGCH.js","Noteskin-D9_02-tj.js","AnimatedSprite-3wI3HXkZ.js","Noteskin-DnReuYHF.js","Noteskin-BA2AU3N9.js","Noteskin-CNgOhnUG.js","Noteskin-DtoXnjwS.js","Noteskin-DSilrxY-.js","Noteskin-BvTgUoTH.js","Noteskin-DV03CRI5.js","Noteskin-BX6w0wz_.js","Noteskin-CzAs-Xul.js","Noteskin-xrz4C4VG.js","Noteskin-DdCjW-Ir.js","Noteskin-CsCC7Tro.js","Noteskin-CyScyomH.js"])))=>i.map(i=>d[i]);
import{M as cd,a as ud,b as dd,T as xe,C as he,B as Fs,c as B,g as or,d as vi,O as b,I as be,e as Se,F as pe,f as xt,h as hi,i as Js,j as Oe,k as kt,G as wt,t as Ze,p as Yn,r as fe,W as ue,E as ee,l as Qe,m as ce,D as gi,n as hd,o as Po,A as Dt,q as fd,s as Sn,u as Nc,S as Hc,v as Ro,w as zc,x as jr,y as Kt,z as Si,H as Vc,J as pd,K as xn,L as $r,N as Ar,P as kr,Q as ii,R as Mn,U as oi,V as Oo,X as md,Y as Uc,Z as Ni,_ as Hi,$ as ti,a0 as ge,a1 as ye,a2 as Is,a3 as Kn,a4 as ca,a5 as yn,a6 as mi,a7 as xi,a8 as eo,a9 as Xn,aa as gd,ab as Wc,ac as Ir,ad as No,ae as bd,af as Fn,ag as Gc,ah as Ho,ai as zo,aj as Vo,ak as yd,al as qc,am as wd,an as Uo,ao as vd,ap as xd,aq as Ed,ar as ua,as as Cd}from"./Simfile-DgZSKnU-.js";class _d extends cd{constructor(e=100,t=100,n=10,r=10){super(),this.segWidth=n,this.segHeight=r,this.width=e,this.height=t,this.build()}build(){const e=this.segWidth*this.segHeight,t=[],n=[],r=[],a=this.segWidth-1,s=this.segHeight-1,o=this.width/a,l=this.height/s;for(let f=0;f<e;f++){const c=f%this.segWidth,d=f/this.segWidth|0;t.push(c*o,d*l),n.push(c/a,d/s)}const u=a*s;for(let f=0;f<u;f++){const c=f%a,d=f/a|0,h=d*this.segWidth+c,p=d*this.segWidth+c+1,m=(d+1)*this.segWidth+c,g=(d+1)*this.segWidth+c+1;r.push(h,p,m,p,g,m)}this.buffers[0].data=new Float32Array(t),this.buffers[1].data=new Float32Array(n),this.indexBuffer.data=new Uint16Array(r),this.buffers[0].update(),this.buffers[1].update(),this.indexBuffer.update()}}class Ad extends ud{constructor(e,t,n){const r=new _d(e.width,e.height,t,n),a=new dd(xe.WHITE);super(r,a),this.texture=e,this.autoResize=!0}textureUpdated(){this._textureID=this.shader.texture._updateID;const e=this.geometry,{width:t,height:n}=this.shader.texture;this.autoResize&&(e.width!==t||e.height!==n)&&(e.width=this.shader.texture.width,e.height=this.shader.texture.height,e.build())}set texture(e){this.shader.texture!==e&&(this.shader.texture=e,this._textureID=-1,e.baseTexture.valid?this.textureUpdated():e.once("update",this.textureUpdated,this))}get texture(){return this.shader.texture}_render(e){this._textureID!==this.shader.texture._updateID&&this.textureUpdated(),super._render(e)}destroy(e){this.shader.texture.off("update",this.textureUpdated,this),super.destroy(e)}}const hr=10;class jc extends Ad{constructor(e,t,n,r,a){super(xe.WHITE,4,4),this._origWidth=e.orig.width,this._origHeight=e.orig.height,this._width=this._origWidth,this._height=this._origHeight,this._leftWidth=t??e.defaultBorders?.left??hr,this._rightWidth=r??e.defaultBorders?.right??hr,this._topHeight=n??e.defaultBorders?.top??hr,this._bottomHeight=a??e.defaultBorders?.bottom??hr,this.texture=e}textureUpdated(){this._textureID=this.shader.texture._updateID,this._refresh()}get vertices(){return this.geometry.getBuffer("aVertexPosition").data}set vertices(e){this.geometry.getBuffer("aVertexPosition").data=e}updateHorizontalVertices(){const e=this.vertices,t=this._getMinScale();e[9]=e[11]=e[13]=e[15]=this._topHeight*t,e[17]=e[19]=e[21]=e[23]=this._height-this._bottomHeight*t,e[25]=e[27]=e[29]=e[31]=this._height}updateVerticalVertices(){const e=this.vertices,t=this._getMinScale();e[2]=e[10]=e[18]=e[26]=this._leftWidth*t,e[4]=e[12]=e[20]=e[28]=this._width-this._rightWidth*t,e[6]=e[14]=e[22]=e[30]=this._width}_getMinScale(){const e=this._leftWidth+this._rightWidth,t=this._width>e?1:this._width/e,n=this._topHeight+this._bottomHeight,r=this._height>n?1:this._height/n;return Math.min(t,r)}get width(){return this._width}set width(e){this._width=e,this._refresh()}get height(){return this._height}set height(e){this._height=e,this._refresh()}get leftWidth(){return this._leftWidth}set leftWidth(e){this._leftWidth=e,this._refresh()}get rightWidth(){return this._rightWidth}set rightWidth(e){this._rightWidth=e,this._refresh()}get topHeight(){return this._topHeight}set topHeight(e){this._topHeight=e,this._refresh()}get bottomHeight(){return this._bottomHeight}set bottomHeight(e){this._bottomHeight=e,this._refresh()}_refresh(){const e=this.texture,t=this.geometry.buffers[1].data;this._origWidth=e.orig.width,this._origHeight=e.orig.height;const n=1/this._origWidth,r=1/this._origHeight;t[0]=t[8]=t[16]=t[24]=0,t[1]=t[3]=t[5]=t[7]=0,t[6]=t[14]=t[22]=t[30]=1,t[25]=t[27]=t[29]=t[31]=1,t[2]=t[10]=t[18]=t[26]=n*this._leftWidth,t[4]=t[12]=t[20]=t[28]=1-n*this._rightWidth,t[9]=t[11]=t[13]=t[15]=r*this._topHeight,t[17]=t[19]=t[21]=t[23]=1-r*this._bottomHeight,this.updateHorizontalVertices(),this.updateVerticalVertices(),this.geometry.buffers[0].update(),this.geometry.buffers[1].update()}}class Yr extends he{constructor(e=1500,t,n=16384,r=!1){super();const a=16384;n>a&&(n=a),this._properties=[!1,!0,!1,!1,!1],this._maxSize=e,this._batchSize=n,this._buffers=null,this._bufferUpdateIDs=[],this._updateID=0,this.interactiveChildren=!1,this.blendMode=Fs.NORMAL,this.autoResize=r,this.roundPixels=!0,this.baseTexture=null,this.setProperties(t),this._tintColor=new B(0),this.tintRgb=new Float32Array(3),this.tint=16777215}setProperties(e){e&&(this._properties[0]="vertices"in e||"scale"in e?!!e.vertices||!!e.scale:this._properties[0],this._properties[1]="position"in e?!!e.position:this._properties[1],this._properties[2]="rotation"in e?!!e.rotation:this._properties[2],this._properties[3]="uvs"in e?!!e.uvs:this._properties[3],this._properties[4]="tint"in e||"alpha"in e?!!e.tint||!!e.alpha:this._properties[4])}updateTransform(){this.displayObjectUpdateTransform()}get tint(){return this._tintColor.value}set tint(e){this._tintColor.setValue(e),this._tintColor.toRgbArray(this.tintRgb)}render(e){!this.visible||this.worldAlpha<=0||!this.children.length||!this.renderable||(this.baseTexture||(this.baseTexture=this.children[0]._texture.baseTexture,this.baseTexture.valid||this.baseTexture.once("update",()=>this.onChildrenChange(0))),e.batch.setObjectRenderer(e.plugins.particle),e.plugins.particle.render(this))}onChildrenChange(e){const t=Math.floor(e/this._batchSize);for(;this._bufferUpdateIDs.length<t;)this._bufferUpdateIDs.push(0);this._bufferUpdateIDs[t]=++this._updateID}dispose(){if(this._buffers){for(let e=0;e<this._buffers.length;++e)this._buffers[e].destroy();this._buffers=null}}destroy(e){super.destroy(e),this.dispose(),this._properties=null,this._buffers=null,this._bufferUpdateIDs=null}}var fr={exports:{}},da,Wo;function Kr(){if(Wo)return da;Wo=1;const i="2.0.0",e=256,t=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,r=e-6;return da={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:i,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},da}var ha,Go;function Xr(){if(Go)return ha;Go=1;var i={};return ha=typeof process=="object"&&i&&i.NODE_DEBUG&&/\bsemver\b/i.test(i.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{},ha}var qo;function lr(){return qo||(qo=1,function(i,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:r}=Kr(),a=Xr();e=i.exports={};const s=e.re=[],o=e.safeRe=[],l=e.src=[],u=e.t={};let f=0;const c="[a-zA-Z0-9-]",d=[["\\s",1],["\\d",r],[c,n]],h=m=>{for(const[g,y]of d)m=m.split(`${g}*`).join(`${g}{0,${y}}`).split(`${g}+`).join(`${g}{1,${y}}`);return m},p=(m,g,y)=>{const x=h(g),w=f++;a(m,w,g),u[m]=w,l[w]=g,s[w]=new RegExp(g,y?"g":void 0),o[w]=new RegExp(x,y?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${c}*`),p("MAINVERSION",`(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${l[u.NUMERICIDENTIFIER]}|${l[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${l[u.NUMERICIDENTIFIERLOOSE]}|${l[u.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${l[u.PRERELEASEIDENTIFIER]}(?:\\.${l[u.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${l[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[u.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${c}+`),p("BUILD",`(?:\\+(${l[u.BUILDIDENTIFIER]}(?:\\.${l[u.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${l[u.MAINVERSION]}${l[u.PRERELEASE]}?${l[u.BUILD]}?`),p("FULL",`^${l[u.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${l[u.MAINVERSIONLOOSE]}${l[u.PRERELEASELOOSE]}?${l[u.BUILD]}?`),p("LOOSE",`^${l[u.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${l[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${l[u.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:${l[u.PRERELEASE]})?${l[u.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:${l[u.PRERELEASELOOSE]})?${l[u.BUILD]}?)?)?`),p("XRANGE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),p("COERCE",`${l[u.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",l[u.COERCEPLAIN]+`(?:${l[u.PRERELEASE]})?(?:${l[u.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",l[u.COERCE],!0),p("COERCERTLFULL",l[u.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${l[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",p("TILDE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${l[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",p("CARET",`^${l[u.LONECARET]}${l[u.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${l[u.LONECARET]}${l[u.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${l[u.GTLT]}\\s*(${l[u.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]}|${l[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${l[u.XRANGEPLAIN]})\\s+-\\s+(${l[u.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${l[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[u.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(fr,fr.exports)),fr.exports}var fa,jo;function to(){if(jo)return fa;jo=1;const i=Object.freeze({loose:!0}),e=Object.freeze({});return fa=n=>n?typeof n!="object"?i:n:e,fa}var pa,$o;function $c(){if($o)return pa;$o=1;const i=/^[0-9]+$/,e=(n,r)=>{const a=i.test(n),s=i.test(r);return a&&s&&(n=+n,r=+r),n===r?0:a&&!s?-1:s&&!a?1:n<r?-1:1};return pa={compareIdentifiers:e,rcompareIdentifiers:(n,r)=>e(r,n)},pa}var ma,Yo;function St(){if(Yo)return ma;Yo=1;const i=Xr(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:t}=Kr(),{safeRe:n,t:r}=lr(),a=to(),{compareIdentifiers:s}=$c();class o{constructor(u,f){if(f=a(f),u instanceof o){if(u.loose===!!f.loose&&u.includePrerelease===!!f.includePrerelease)return u;u=u.version}else if(typeof u!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof u}".`);if(u.length>e)throw new TypeError(`version is longer than ${e} characters`);i("SemVer",u,f),this.options=f,this.loose=!!f.loose,this.includePrerelease=!!f.includePrerelease;const c=u.trim().match(f.loose?n[r.LOOSE]:n[r.FULL]);if(!c)throw new TypeError(`Invalid Version: ${u}`);if(this.raw=u,this.major=+c[1],this.minor=+c[2],this.patch=+c[3],this.major>t||this.major<0)throw new TypeError("Invalid major version");if(this.minor>t||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>t||this.patch<0)throw new TypeError("Invalid patch version");c[4]?this.prerelease=c[4].split(".").map(d=>{if(/^[0-9]+$/.test(d)){const h=+d;if(h>=0&&h<t)return h}return d}):this.prerelease=[],this.build=c[5]?c[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(u){if(i("SemVer.compare",this.version,this.options,u),!(u instanceof o)){if(typeof u=="string"&&u===this.version)return 0;u=new o(u,this.options)}return u.version===this.version?0:this.compareMain(u)||this.comparePre(u)}compareMain(u){return u instanceof o||(u=new o(u,this.options)),s(this.major,u.major)||s(this.minor,u.minor)||s(this.patch,u.patch)}comparePre(u){if(u instanceof o||(u=new o(u,this.options)),this.prerelease.length&&!u.prerelease.length)return-1;if(!this.prerelease.length&&u.prerelease.length)return 1;if(!this.prerelease.length&&!u.prerelease.length)return 0;let f=0;do{const c=this.prerelease[f],d=u.prerelease[f];if(i("prerelease compare",f,c,d),c===void 0&&d===void 0)return 0;if(d===void 0)return 1;if(c===void 0)return-1;if(c===d)continue;return s(c,d)}while(++f)}compareBuild(u){u instanceof o||(u=new o(u,this.options));let f=0;do{const c=this.build[f],d=u.build[f];if(i("build compare",f,c,d),c===void 0&&d===void 0)return 0;if(d===void 0)return 1;if(c===void 0)return-1;if(c===d)continue;return s(c,d)}while(++f)}inc(u,f,c){switch(u){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",f,c);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",f,c);break;case"prepatch":this.prerelease.length=0,this.inc("patch",f,c),this.inc("pre",f,c);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",f,c),this.inc("pre",f,c);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const d=Number(c)?1:0;if(!f&&c===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[d];else{let h=this.prerelease.length;for(;--h>=0;)typeof this.prerelease[h]=="number"&&(this.prerelease[h]++,h=-2);if(h===-1){if(f===this.prerelease.join(".")&&c===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(d)}}if(f){let h=[f,d];c===!1&&(h=[f]),s(this.prerelease[0],f)===0?isNaN(this.prerelease[1])&&(this.prerelease=h):this.prerelease=h}break}default:throw new Error(`invalid increment argument: ${u}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return ma=o,ma}var ga,Ko;function kn(){if(Ko)return ga;Ko=1;const i=St();return ga=(t,n,r=!1)=>{if(t instanceof i)return t;try{return new i(t,n)}catch(a){if(!r)return null;throw a}},ga}var ba,Xo;function kd(){if(Xo)return ba;Xo=1;const i=kn();return ba=(t,n)=>{const r=i(t,n);return r?r.version:null},ba}var ya,Zo;function Td(){if(Zo)return ya;Zo=1;const i=kn();return ya=(t,n)=>{const r=i(t.trim().replace(/^[=v]+/,""),n);return r?r.version:null},ya}var wa,Qo;function Sd(){if(Qo)return wa;Qo=1;const i=St();return wa=(t,n,r,a,s)=>{typeof r=="string"&&(s=a,a=r,r=void 0);try{return new i(t instanceof i?t.version:t,r).inc(n,a,s).version}catch{return null}},wa}var va,Jo;function Md(){if(Jo)return va;Jo=1;const i=kn();return va=(t,n)=>{const r=i(t,null,!0),a=i(n,null,!0),s=r.compare(a);if(s===0)return null;const o=s>0,l=o?r:a,u=o?a:r,f=!!l.prerelease.length;if(!!u.prerelease.length&&!f)return!u.patch&&!u.minor?"major":l.patch?"patch":l.minor?"minor":"major";const d=f?"pre":"";return r.major!==a.major?d+"major":r.minor!==a.minor?d+"minor":r.patch!==a.patch?d+"patch":"prerelease"},va}var xa,el;function Ld(){if(el)return xa;el=1;const i=St();return xa=(t,n)=>new i(t,n).major,xa}var Ea,tl;function Dd(){if(tl)return Ea;tl=1;const i=St();return Ea=(t,n)=>new i(t,n).minor,Ea}var Ca,il;function Bd(){if(il)return Ca;il=1;const i=St();return Ca=(t,n)=>new i(t,n).patch,Ca}var _a,nl;function Fd(){if(nl)return _a;nl=1;const i=kn();return _a=(t,n)=>{const r=i(t,n);return r&&r.prerelease.length?r.prerelease:null},_a}var Aa,rl;function ri(){if(rl)return Aa;rl=1;const i=St();return Aa=(t,n,r)=>new i(t,r).compare(new i(n,r)),Aa}var ka,al;function Id(){if(al)return ka;al=1;const i=ri();return ka=(t,n,r)=>i(n,t,r),ka}var Ta,sl;function Pd(){if(sl)return Ta;sl=1;const i=ri();return Ta=(t,n)=>i(t,n,!0),Ta}var Sa,ol;function io(){if(ol)return Sa;ol=1;const i=St();return Sa=(t,n,r)=>{const a=new i(t,r),s=new i(n,r);return a.compare(s)||a.compareBuild(s)},Sa}var Ma,ll;function Rd(){if(ll)return Ma;ll=1;const i=io();return Ma=(t,n)=>t.sort((r,a)=>i(r,a,n)),Ma}var La,cl;function Od(){if(cl)return La;cl=1;const i=io();return La=(t,n)=>t.sort((r,a)=>i(a,r,n)),La}var Da,ul;function Zr(){if(ul)return Da;ul=1;const i=ri();return Da=(t,n,r)=>i(t,n,r)>0,Da}var Ba,dl;function no(){if(dl)return Ba;dl=1;const i=ri();return Ba=(t,n,r)=>i(t,n,r)<0,Ba}var Fa,hl;function Yc(){if(hl)return Fa;hl=1;const i=ri();return Fa=(t,n,r)=>i(t,n,r)===0,Fa}var Ia,fl;function Kc(){if(fl)return Ia;fl=1;const i=ri();return Ia=(t,n,r)=>i(t,n,r)!==0,Ia}var Pa,pl;function ro(){if(pl)return Pa;pl=1;const i=ri();return Pa=(t,n,r)=>i(t,n,r)>=0,Pa}var Ra,ml;function ao(){if(ml)return Ra;ml=1;const i=ri();return Ra=(t,n,r)=>i(t,n,r)<=0,Ra}var Oa,gl;function Xc(){if(gl)return Oa;gl=1;const i=Yc(),e=Kc(),t=Zr(),n=ro(),r=no(),a=ao();return Oa=(o,l,u,f)=>{switch(l){case"===":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o===u;case"!==":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o!==u;case"":case"=":case"==":return i(o,u,f);case"!=":return e(o,u,f);case">":return t(o,u,f);case">=":return n(o,u,f);case"<":return r(o,u,f);case"<=":return a(o,u,f);default:throw new TypeError(`Invalid operator: ${l}`)}},Oa}var Na,bl;function Nd(){if(bl)return Na;bl=1;const i=St(),e=kn(),{safeRe:t,t:n}=lr();return Na=(a,s)=>{if(a instanceof i)return a;if(typeof a=="number"&&(a=String(a)),typeof a!="string")return null;s=s||{};let o=null;if(!s.rtl)o=a.match(s.includePrerelease?t[n.COERCEFULL]:t[n.COERCE]);else{const h=s.includePrerelease?t[n.COERCERTLFULL]:t[n.COERCERTL];let p;for(;(p=h.exec(a))&&(!o||o.index+o[0].length!==a.length);)(!o||p.index+p[0].length!==o.index+o[0].length)&&(o=p),h.lastIndex=p.index+p[1].length+p[2].length;h.lastIndex=-1}if(o===null)return null;const l=o[2],u=o[3]||"0",f=o[4]||"0",c=s.includePrerelease&&o[5]?`-${o[5]}`:"",d=s.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${l}.${u}.${f}${c}${d}`,s)},Na}var Ha,yl;function Hd(){if(yl)return Ha;yl=1;class i{constructor(){this.max=1e3,this.map=new Map}get(t){const n=this.map.get(t);if(n!==void 0)return this.map.delete(t),this.map.set(t,n),n}delete(t){return this.map.delete(t)}set(t,n){if(!this.delete(t)&&n!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(t,n)}return this}}return Ha=i,Ha}var za,wl;function ai(){if(wl)return za;wl=1;const i=/\s+/g;class e{constructor(S,Y){if(Y=r(Y),S instanceof e)return S.loose===!!Y.loose&&S.includePrerelease===!!Y.includePrerelease?S:new e(S.raw,Y);if(S instanceof a)return this.raw=S.value,this.set=[[S]],this.formatted=void 0,this;if(this.options=Y,this.loose=!!Y.loose,this.includePrerelease=!!Y.includePrerelease,this.raw=S.trim().replace(i," "),this.set=this.raw.split("||").map(D=>this.parseRange(D.trim())).filter(D=>D.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const D=this.set[0];if(this.set=this.set.filter(G=>!m(G[0])),this.set.length===0)this.set=[D];else if(this.set.length>1){for(const G of this.set)if(G.length===1&&g(G[0])){this.set=[G];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let S=0;S<this.set.length;S++){S>0&&(this.formatted+="||");const Y=this.set[S];for(let D=0;D<Y.length;D++)D>0&&(this.formatted+=" "),this.formatted+=Y[D].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(S){const D=((this.options.includePrerelease&&h)|(this.options.loose&&p))+":"+S,G=n.get(D);if(G)return G;const V=this.options.loose,J=V?l[u.HYPHENRANGELOOSE]:l[u.HYPHENRANGE];S=S.replace(J,L(this.options.includePrerelease)),s("hyphen replace",S),S=S.replace(l[u.COMPARATORTRIM],f),s("comparator trim",S),S=S.replace(l[u.TILDETRIM],c),s("tilde trim",S),S=S.replace(l[u.CARETTRIM],d),s("caret trim",S);let H=S.split(" ").map(te=>x(te,this.options)).join(" ").split(/\s+/).map(te=>ae(te,this.options));V&&(H=H.filter(te=>(s("loose invalid filter",te,this.options),!!te.match(l[u.COMPARATORLOOSE])))),s("range list",H);const P=new Map,re=H.map(te=>new a(te,this.options));for(const te of re){if(m(te))return[te];P.set(te.value,te)}P.size>1&&P.has("")&&P.delete("");const ne=[...P.values()];return n.set(D,ne),ne}intersects(S,Y){if(!(S instanceof e))throw new TypeError("a Range is required");return this.set.some(D=>y(D,Y)&&S.set.some(G=>y(G,Y)&&D.every(V=>G.every(J=>V.intersects(J,Y)))))}test(S){if(!S)return!1;if(typeof S=="string")try{S=new o(S,this.options)}catch{return!1}for(let Y=0;Y<this.set.length;Y++)if(O(this.set[Y],S,this.options))return!0;return!1}}za=e;const t=Hd(),n=new t,r=to(),a=Qr(),s=Xr(),o=St(),{safeRe:l,t:u,comparatorTrimReplace:f,tildeTrimReplace:c,caretTrimReplace:d}=lr(),{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:p}=Kr(),m=v=>v.value==="<0.0.0-0",g=v=>v.value==="",y=(v,S)=>{let Y=!0;const D=v.slice();let G=D.pop();for(;Y&&D.length;)Y=D.every(V=>G.intersects(V,S)),G=D.pop();return Y},x=(v,S)=>(s("comp",v,S),v=F(v,S),s("caret",v),v=_(v,S),s("tildes",v),v=R(v,S),s("xrange",v),v=j(v,S),s("stars",v),v),w=v=>!v||v.toLowerCase()==="x"||v==="*",_=(v,S)=>v.trim().split(/\s+/).map(Y=>C(Y,S)).join(" "),C=(v,S)=>{const Y=S.loose?l[u.TILDELOOSE]:l[u.TILDE];return v.replace(Y,(D,G,V,J,H)=>{s("tilde",v,D,G,V,J,H);let P;return w(G)?P="":w(V)?P=`>=${G}.0.0 <${+G+1}.0.0-0`:w(J)?P=`>=${G}.${V}.0 <${G}.${+V+1}.0-0`:H?(s("replaceTilde pr",H),P=`>=${G}.${V}.${J}-${H} <${G}.${+V+1}.0-0`):P=`>=${G}.${V}.${J} <${G}.${+V+1}.0-0`,s("tilde return",P),P})},F=(v,S)=>v.trim().split(/\s+/).map(Y=>T(Y,S)).join(" "),T=(v,S)=>{s("caret",v,S);const Y=S.loose?l[u.CARETLOOSE]:l[u.CARET],D=S.includePrerelease?"-0":"";return v.replace(Y,(G,V,J,H,P)=>{s("caret",v,G,V,J,H,P);let re;return w(V)?re="":w(J)?re=`>=${V}.0.0${D} <${+V+1}.0.0-0`:w(H)?V==="0"?re=`>=${V}.${J}.0${D} <${V}.${+J+1}.0-0`:re=`>=${V}.${J}.0${D} <${+V+1}.0.0-0`:P?(s("replaceCaret pr",P),V==="0"?J==="0"?re=`>=${V}.${J}.${H}-${P} <${V}.${J}.${+H+1}-0`:re=`>=${V}.${J}.${H}-${P} <${V}.${+J+1}.0-0`:re=`>=${V}.${J}.${H}-${P} <${+V+1}.0.0-0`):(s("no pr"),V==="0"?J==="0"?re=`>=${V}.${J}.${H}${D} <${V}.${J}.${+H+1}-0`:re=`>=${V}.${J}.${H}${D} <${V}.${+J+1}.0-0`:re=`>=${V}.${J}.${H} <${+V+1}.0.0-0`),s("caret return",re),re})},R=(v,S)=>(s("replaceXRanges",v,S),v.split(/\s+/).map(Y=>N(Y,S)).join(" ")),N=(v,S)=>{v=v.trim();const Y=S.loose?l[u.XRANGELOOSE]:l[u.XRANGE];return v.replace(Y,(D,G,V,J,H,P)=>{s("xRange",v,D,G,V,J,H,P);const re=w(V),ne=re||w(J),te=ne||w(H),Me=te;return G==="="&&Me&&(G=""),P=S.includePrerelease?"-0":"",re?G===">"||G==="<"?D="<0.0.0-0":D="*":G&&Me?(ne&&(J=0),H=0,G===">"?(G=">=",ne?(V=+V+1,J=0,H=0):(J=+J+1,H=0)):G==="<="&&(G="<",ne?V=+V+1:J=+J+1),G==="<"&&(P="-0"),D=`${G+V}.${J}.${H}${P}`):ne?D=`>=${V}.0.0${P} <${+V+1}.0.0-0`:te&&(D=`>=${V}.${J}.0${P} <${V}.${+J+1}.0-0`),s("xRange return",D),D})},j=(v,S)=>(s("replaceStars",v,S),v.trim().replace(l[u.STAR],"")),ae=(v,S)=>(s("replaceGTE0",v,S),v.trim().replace(l[S.includePrerelease?u.GTE0PRE:u.GTE0],"")),L=v=>(S,Y,D,G,V,J,H,P,re,ne,te,Me)=>(w(D)?Y="":w(G)?Y=`>=${D}.0.0${v?"-0":""}`:w(V)?Y=`>=${D}.${G}.0${v?"-0":""}`:J?Y=`>=${Y}`:Y=`>=${Y}${v?"-0":""}`,w(re)?P="":w(ne)?P=`<${+re+1}.0.0-0`:w(te)?P=`<${re}.${+ne+1}.0-0`:Me?P=`<=${re}.${ne}.${te}-${Me}`:v?P=`<${re}.${ne}.${+te+1}-0`:P=`<=${P}`,`${Y} ${P}`.trim()),O=(v,S,Y)=>{for(let D=0;D<v.length;D++)if(!v[D].test(S))return!1;if(S.prerelease.length&&!Y.includePrerelease){for(let D=0;D<v.length;D++)if(s(v[D].semver),v[D].semver!==a.ANY&&v[D].semver.prerelease.length>0){const G=v[D].semver;if(G.major===S.major&&G.minor===S.minor&&G.patch===S.patch)return!0}return!1}return!0};return za}var Va,vl;function Qr(){if(vl)return Va;vl=1;const i=Symbol("SemVer ANY");class e{static get ANY(){return i}constructor(f,c){if(c=t(c),f instanceof e){if(f.loose===!!c.loose)return f;f=f.value}f=f.trim().split(/\s+/).join(" "),s("comparator",f,c),this.options=c,this.loose=!!c.loose,this.parse(f),this.semver===i?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(f){const c=this.options.loose?n[r.COMPARATORLOOSE]:n[r.COMPARATOR],d=f.match(c);if(!d)throw new TypeError(`Invalid comparator: ${f}`);this.operator=d[1]!==void 0?d[1]:"",this.operator==="="&&(this.operator=""),d[2]?this.semver=new o(d[2],this.options.loose):this.semver=i}toString(){return this.value}test(f){if(s("Comparator.test",f,this.options.loose),this.semver===i||f===i)return!0;if(typeof f=="string")try{f=new o(f,this.options)}catch{return!1}return a(f,this.operator,this.semver,this.options)}intersects(f,c){if(!(f instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new l(f.value,c).test(this.value):f.operator===""?f.value===""?!0:new l(this.value,c).test(f.semver):(c=t(c),c.includePrerelease&&(this.value==="<0.0.0-0"||f.value==="<0.0.0-0")||!c.includePrerelease&&(this.value.startsWith("<0.0.0")||f.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&f.operator.startsWith(">")||this.operator.startsWith("<")&&f.operator.startsWith("<")||this.semver.version===f.semver.version&&this.operator.includes("=")&&f.operator.includes("=")||a(this.semver,"<",f.semver,c)&&this.operator.startsWith(">")&&f.operator.startsWith("<")||a(this.semver,">",f.semver,c)&&this.operator.startsWith("<")&&f.operator.startsWith(">")))}}Va=e;const t=to(),{safeRe:n,t:r}=lr(),a=Xc(),s=Xr(),o=St(),l=ai();return Va}var Ua,xl;function Jr(){if(xl)return Ua;xl=1;const i=ai();return Ua=(t,n,r)=>{try{n=new i(n,r)}catch{return!1}return n.test(t)},Ua}var Wa,El;function zd(){if(El)return Wa;El=1;const i=ai();return Wa=(t,n)=>new i(t,n).set.map(r=>r.map(a=>a.value).join(" ").trim().split(" ")),Wa}var Ga,Cl;function Vd(){if(Cl)return Ga;Cl=1;const i=St(),e=ai();return Ga=(n,r,a)=>{let s=null,o=null,l=null;try{l=new e(r,a)}catch{return null}return n.forEach(u=>{l.test(u)&&(!s||o.compare(u)===-1)&&(s=u,o=new i(s,a))}),s},Ga}var qa,_l;function Ud(){if(_l)return qa;_l=1;const i=St(),e=ai();return qa=(n,r,a)=>{let s=null,o=null,l=null;try{l=new e(r,a)}catch{return null}return n.forEach(u=>{l.test(u)&&(!s||o.compare(u)===1)&&(s=u,o=new i(s,a))}),s},qa}var ja,Al;function Wd(){if(Al)return ja;Al=1;const i=St(),e=ai(),t=Zr();return ja=(r,a)=>{r=new e(r,a);let s=new i("0.0.0");if(r.test(s)||(s=new i("0.0.0-0"),r.test(s)))return s;s=null;for(let o=0;o<r.set.length;++o){const l=r.set[o];let u=null;l.forEach(f=>{const c=new i(f.semver.version);switch(f.operator){case">":c.prerelease.length===0?c.patch++:c.prerelease.push(0),c.raw=c.format();case"":case">=":(!u||t(c,u))&&(u=c);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${f.operator}`)}}),u&&(!s||t(s,u))&&(s=u)}return s&&r.test(s)?s:null},ja}var $a,kl;function Gd(){if(kl)return $a;kl=1;const i=ai();return $a=(t,n)=>{try{return new i(t,n).range||"*"}catch{return null}},$a}var Ya,Tl;function so(){if(Tl)return Ya;Tl=1;const i=St(),e=Qr(),{ANY:t}=e,n=ai(),r=Jr(),a=Zr(),s=no(),o=ao(),l=ro();return Ya=(f,c,d,h)=>{f=new i(f,h),c=new n(c,h);let p,m,g,y,x;switch(d){case">":p=a,m=o,g=s,y=">",x=">=";break;case"<":p=s,m=l,g=a,y="<",x="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(r(f,c,h))return!1;for(let w=0;w<c.set.length;++w){const _=c.set[w];let C=null,F=null;if(_.forEach(T=>{T.semver===t&&(T=new e(">=0.0.0")),C=C||T,F=F||T,p(T.semver,C.semver,h)?C=T:g(T.semver,F.semver,h)&&(F=T)}),C.operator===y||C.operator===x||(!F.operator||F.operator===y)&&m(f,F.semver))return!1;if(F.operator===x&&g(f,F.semver))return!1}return!0},Ya}var Ka,Sl;function qd(){if(Sl)return Ka;Sl=1;const i=so();return Ka=(t,n,r)=>i(t,n,">",r),Ka}var Xa,Ml;function jd(){if(Ml)return Xa;Ml=1;const i=so();return Xa=(t,n,r)=>i(t,n,"<",r),Xa}var Za,Ll;function $d(){if(Ll)return Za;Ll=1;const i=ai();return Za=(t,n,r)=>(t=new i(t,r),n=new i(n,r),t.intersects(n,r)),Za}var Qa,Dl;function Yd(){if(Dl)return Qa;Dl=1;const i=Jr(),e=ri();return Qa=(t,n,r)=>{const a=[];let s=null,o=null;const l=t.sort((d,h)=>e(d,h,r));for(const d of l)i(d,n,r)?(o=d,s||(s=d)):(o&&a.push([s,o]),o=null,s=null);s&&a.push([s,null]);const u=[];for(const[d,h]of a)d===h?u.push(d):!h&&d===l[0]?u.push("*"):h?d===l[0]?u.push(`<=${h}`):u.push(`${d} - ${h}`):u.push(`>=${d}`);const f=u.join(" || "),c=typeof n.raw=="string"?n.raw:String(n);return f.length<c.length?f:n},Qa}var Ja,Bl;function Kd(){if(Bl)return Ja;Bl=1;const i=ai(),e=Qr(),{ANY:t}=e,n=Jr(),r=ri(),a=(c,d,h={})=>{if(c===d)return!0;c=new i(c,h),d=new i(d,h);let p=!1;e:for(const m of c.set){for(const g of d.set){const y=l(m,g,h);if(p=p||y!==null,y)continue e}if(p)return!1}return!0},s=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],l=(c,d,h)=>{if(c===d)return!0;if(c.length===1&&c[0].semver===t){if(d.length===1&&d[0].semver===t)return!0;h.includePrerelease?c=s:c=o}if(d.length===1&&d[0].semver===t){if(h.includePrerelease)return!0;d=o}const p=new Set;let m,g;for(const R of c)R.operator===">"||R.operator===">="?m=u(m,R,h):R.operator==="<"||R.operator==="<="?g=f(g,R,h):p.add(R.semver);if(p.size>1)return null;let y;if(m&&g){if(y=r(m.semver,g.semver,h),y>0)return null;if(y===0&&(m.operator!==">="||g.operator!=="<="))return null}for(const R of p){if(m&&!n(R,String(m),h)||g&&!n(R,String(g),h))return null;for(const N of d)if(!n(R,String(N),h))return!1;return!0}let x,w,_,C,F=g&&!h.includePrerelease&&g.semver.prerelease.length?g.semver:!1,T=m&&!h.includePrerelease&&m.semver.prerelease.length?m.semver:!1;F&&F.prerelease.length===1&&g.operator==="<"&&F.prerelease[0]===0&&(F=!1);for(const R of d){if(C=C||R.operator===">"||R.operator===">=",_=_||R.operator==="<"||R.operator==="<=",m){if(T&&R.semver.prerelease&&R.semver.prerelease.length&&R.semver.major===T.major&&R.semver.minor===T.minor&&R.semver.patch===T.patch&&(T=!1),R.operator===">"||R.operator===">="){if(x=u(m,R,h),x===R&&x!==m)return!1}else if(m.operator===">="&&!n(m.semver,String(R),h))return!1}if(g){if(F&&R.semver.prerelease&&R.semver.prerelease.length&&R.semver.major===F.major&&R.semver.minor===F.minor&&R.semver.patch===F.patch&&(F=!1),R.operator==="<"||R.operator==="<="){if(w=f(g,R,h),w===R&&w!==g)return!1}else if(g.operator==="<="&&!n(g.semver,String(R),h))return!1}if(!R.operator&&(g||m)&&y!==0)return!1}return!(m&&_&&!g&&y!==0||g&&C&&!m&&y!==0||T||F)},u=(c,d,h)=>{if(!c)return d;const p=r(c.semver,d.semver,h);return p>0?c:p<0||d.operator===">"&&c.operator===">="?d:c},f=(c,d,h)=>{if(!c)return d;const p=r(c.semver,d.semver,h);return p<0?c:p>0||d.operator==="<"&&c.operator==="<="?d:c};return Ja=a,Ja}var es,Fl;function Xd(){if(Fl)return es;Fl=1;const i=lr(),e=Kr(),t=St(),n=$c(),r=kn(),a=kd(),s=Td(),o=Sd(),l=Md(),u=Ld(),f=Dd(),c=Bd(),d=Fd(),h=ri(),p=Id(),m=Pd(),g=io(),y=Rd(),x=Od(),w=Zr(),_=no(),C=Yc(),F=Kc(),T=ro(),R=ao(),N=Xc(),j=Nd(),ae=Qr(),L=ai(),O=Jr(),v=zd(),S=Vd(),Y=Ud(),D=Wd(),G=Gd(),V=so(),J=qd(),H=jd(),P=$d(),re=Yd(),ne=Kd();return es={parse:r,valid:a,clean:s,inc:o,diff:l,major:u,minor:f,patch:c,prerelease:d,compare:h,rcompare:p,compareLoose:m,compareBuild:g,sort:y,rsort:x,gt:w,lt:_,eq:C,neq:F,gte:T,lte:R,cmp:N,coerce:j,Comparator:ae,Range:L,satisfies:O,toComparators:v,maxSatisfying:S,minSatisfying:Y,minVersion:D,validRange:G,outside:V,gtr:J,ltr:H,intersects:P,simplifyRange:re,subset:ne,SemVer:t,re:i.re,src:i.src,tokens:i.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},es}var Zd=Xd();const Il=or(Zd),Qd="modulepreload",Jd=function(i){return"/smeditor/"+i},Pl={},qe=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let l=function(u){return Promise.all(u.map(f=>Promise.resolve(f).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),o=s?.nonce||s?.getAttribute("nonce");r=l(t.map(u=>{if(u=Jd(u),u in Pl)return;Pl[u]=!0;const f=u.endsWith(".css"),c=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${c}`))return;const d=document.createElement("link");if(d.rel=f?"stylesheet":Qd,f||(d.as="script"),d.crossOrigin="",d.href=u,o&&d.setAttribute("nonce",o),document.head.appendChild(d),f)return new Promise((h,p)=>{d.addEventListener("load",h),d.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${u}`)))})}))}function a(s){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=s,window.dispatchEvent(o),!o.defaultPrevented)throw s}return r.then(s=>{for(const o of s||[])o.status==="rejected"&&a(o.reason);return e().catch(a)})};function eh(i={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:n,onRegistered:r,onRegisteredSW:a,onRegisterError:s}=i;let o,l;const u=async(c=!0)=>{await l};async function f(){if("serviceWorker"in navigator){if(o=await qe(async()=>{const{Workbox:c}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:c}},[]).then(({Workbox:c})=>new c("/smeditor/sw.js",{scope:"/smeditor/",type:"classic"})).catch(c=>{s?.(c)}),!o)return;o.addEventListener("activated",c=>{(c.isUpdate||c.isExternal)&&window.location.reload()}),o.addEventListener("installed",c=>{c.isUpdate||n?.()}),o.register({immediate:e}).then(c=>{a?a("/smeditor/sw.js",c):r?.(c)}).catch(c=>{s?.(c)})}}return l=f(),u}var ts={exports:{}},Rl;function th(){return Rl||(Rl=1,function(i){(function(){function e(A,I,ie){return A.call.apply(A.bind,arguments)}function t(A,I,ie){if(!A)throw Error();if(2<arguments.length){var Z=Array.prototype.slice.call(arguments,2);return function(){var se=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(se,Z),A.apply(I,se)}}return function(){return A.apply(I,arguments)}}function n(A,I,ie){return n=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?e:t,n.apply(null,arguments)}var r=Date.now||function(){return+new Date};function a(A,I){this.a=A,this.o=I||A,this.c=this.o.document}var s=!!window.FontFace;function o(A,I,ie,Z){if(I=A.c.createElement(I),ie)for(var se in ie)ie.hasOwnProperty(se)&&(se=="style"?I.style.cssText=ie[se]:I.setAttribute(se,ie[se]));return Z&&I.appendChild(A.c.createTextNode(Z)),I}function l(A,I,ie){A=A.c.getElementsByTagName(I)[0],A||(A=document.documentElement),A.insertBefore(ie,A.lastChild)}function u(A){A.parentNode&&A.parentNode.removeChild(A)}function f(A,I,ie){I=I||[],ie=ie||[];for(var Z=A.className.split(/\s+/),se=0;se<I.length;se+=1){for(var me=!1,Ee=0;Ee<Z.length;Ee+=1)if(I[se]===Z[Ee]){me=!0;break}me||Z.push(I[se])}for(I=[],se=0;se<Z.length;se+=1){for(me=!1,Ee=0;Ee<ie.length;Ee+=1)if(Z[se]===ie[Ee]){me=!0;break}me||I.push(Z[se])}A.className=I.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function c(A,I){for(var ie=A.className.split(/\s+/),Z=0,se=ie.length;Z<se;Z++)if(ie[Z]==I)return!0;return!1}function d(A){return A.o.location.hostname||A.a.location.hostname}function h(A,I,ie){function Z(){Re&&se&&me&&(Re(Ee),Re=null)}I=o(A,"link",{rel:"stylesheet",href:I,media:"all"});var se=!1,me=!0,Ee=null,Re=ie||null;s?(I.onload=function(){se=!0,Z()},I.onerror=function(){se=!0,Ee=Error("Stylesheet failed to load"),Z()}):setTimeout(function(){se=!0,Z()},0),l(A,"head",I)}function p(A,I,ie,Z){var se=A.c.getElementsByTagName("head")[0];if(se){var me=o(A,"script",{src:I}),Ee=!1;return me.onload=me.onreadystatechange=function(){Ee||this.readyState&&this.readyState!="loaded"&&this.readyState!="complete"||(Ee=!0,ie&&ie(null),me.onload=me.onreadystatechange=null,me.parentNode.tagName=="HEAD"&&se.removeChild(me))},se.appendChild(me),setTimeout(function(){Ee||(Ee=!0,ie&&ie(Error("Script load timeout")))},Z||5e3),me}return null}function m(){this.a=0,this.c=null}function g(A){return A.a++,function(){A.a--,x(A)}}function y(A,I){A.c=I,x(A)}function x(A){A.a==0&&A.c&&(A.c(),A.c=null)}function w(A){this.a=A||"-"}w.prototype.c=function(A){for(var I=[],ie=0;ie<arguments.length;ie++)I.push(arguments[ie].replace(/[\W_]+/g,"").toLowerCase());return I.join(this.a)};function _(A,I){this.c=A,this.f=4,this.a="n";var ie=(I||"n4").match(/^([nio])([1-9])$/i);ie&&(this.a=ie[1],this.f=parseInt(ie[2],10))}function C(A){return R(A)+" "+(A.f+"00")+" 300px "+F(A.c)}function F(A){var I=[];A=A.split(/,\s*/);for(var ie=0;ie<A.length;ie++){var Z=A[ie].replace(/['"]/g,"");Z.indexOf(" ")!=-1||/^\d/.test(Z)?I.push("'"+Z+"'"):I.push(Z)}return I.join(",")}function T(A){return A.a+A.f}function R(A){var I="normal";return A.a==="o"?I="oblique":A.a==="i"&&(I="italic"),I}function N(A){var I=4,ie="n",Z=null;return A&&((Z=A.match(/(normal|oblique|italic)/i))&&Z[1]&&(ie=Z[1].substr(0,1).toLowerCase()),(Z=A.match(/([1-9]00|normal|bold)/i))&&Z[1]&&(/bold/i.test(Z[1])?I=7:/[1-9]00/.test(Z[1])&&(I=parseInt(Z[1].substr(0,1),10)))),ie+I}function j(A,I){this.c=A,this.f=A.o.document.documentElement,this.h=I,this.a=new w("-"),this.j=I.events!==!1,this.g=I.classes!==!1}function ae(A){A.g&&f(A.f,[A.a.c("wf","loading")]),O(A,"loading")}function L(A){if(A.g){var I=c(A.f,A.a.c("wf","active")),ie=[],Z=[A.a.c("wf","loading")];I||ie.push(A.a.c("wf","inactive")),f(A.f,ie,Z)}O(A,"inactive")}function O(A,I,ie){A.j&&A.h[I]&&(ie?A.h[I](ie.c,T(ie)):A.h[I]())}function v(){this.c={}}function S(A,I,ie){var Z=[],se;for(se in I)if(I.hasOwnProperty(se)){var me=A.c[se];me&&Z.push(me(I[se],ie))}return Z}function Y(A,I){this.c=A,this.f=I,this.a=o(this.c,"span",{"aria-hidden":"true"},this.f)}function D(A){l(A.c,"body",A.a)}function G(A){return"display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+F(A.c)+";"+("font-style:"+R(A)+";font-weight:"+(A.f+"00")+";")}function V(A,I,ie,Z,se,me){this.g=A,this.j=I,this.a=Z,this.c=ie,this.f=se||3e3,this.h=me||void 0}V.prototype.start=function(){var A=this.c.o.document,I=this,ie=r(),Z=new Promise(function(Ee,Re){function ze(){r()-ie>=I.f?Re():A.fonts.load(C(I.a),I.h).then(function(et){1<=et.length?Ee():setTimeout(ze,25)},function(){Re()})}ze()}),se=null,me=new Promise(function(Ee,Re){se=setTimeout(Re,I.f)});Promise.race([me,Z]).then(function(){se&&(clearTimeout(se),se=null),I.g(I.a)},function(){I.j(I.a)})};function J(A,I,ie,Z,se,me,Ee){this.v=A,this.B=I,this.c=ie,this.a=Z,this.s=Ee||"BESbswy",this.f={},this.w=se||3e3,this.u=me||null,this.m=this.j=this.h=this.g=null,this.g=new Y(this.c,this.s),this.h=new Y(this.c,this.s),this.j=new Y(this.c,this.s),this.m=new Y(this.c,this.s),A=new _(this.a.c+",serif",T(this.a)),A=G(A),this.g.a.style.cssText=A,A=new _(this.a.c+",sans-serif",T(this.a)),A=G(A),this.h.a.style.cssText=A,A=new _("serif",T(this.a)),A=G(A),this.j.a.style.cssText=A,A=new _("sans-serif",T(this.a)),A=G(A),this.m.a.style.cssText=A,D(this.g),D(this.h),D(this.j),D(this.m)}var H={D:"serif",C:"sans-serif"},P=null;function re(){if(P===null){var A=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);P=!!A&&(536>parseInt(A[1],10)||parseInt(A[1],10)===536&&11>=parseInt(A[2],10))}return P}J.prototype.start=function(){this.f.serif=this.j.a.offsetWidth,this.f["sans-serif"]=this.m.a.offsetWidth,this.A=r(),te(this)};function ne(A,I,ie){for(var Z in H)if(H.hasOwnProperty(Z)&&I===A.f[H[Z]]&&ie===A.f[H[Z]])return!0;return!1}function te(A){var I=A.g.a.offsetWidth,ie=A.h.a.offsetWidth,Z;(Z=I===A.f.serif&&ie===A.f["sans-serif"])||(Z=re()&&ne(A,I,ie)),Z?r()-A.A>=A.w?re()&&ne(A,I,ie)&&(A.u===null||A.u.hasOwnProperty(A.a.c))?He(A,A.v):He(A,A.B):Me(A):He(A,A.v)}function Me(A){setTimeout(n(function(){te(this)},A),50)}function He(A,I){setTimeout(n(function(){u(this.g.a),u(this.h.a),u(this.j.a),u(this.m.a),I(this.a)},A),0)}function _e(A,I,ie){this.c=A,this.a=I,this.f=0,this.m=this.j=!1,this.s=ie}var ve=null;_e.prototype.g=function(A){var I=this.a;I.g&&f(I.f,[I.a.c("wf",A.c,T(A).toString(),"active")],[I.a.c("wf",A.c,T(A).toString(),"loading"),I.a.c("wf",A.c,T(A).toString(),"inactive")]),O(I,"fontactive",A),this.m=!0,Le(this)},_e.prototype.h=function(A){var I=this.a;if(I.g){var ie=c(I.f,I.a.c("wf",A.c,T(A).toString(),"active")),Z=[],se=[I.a.c("wf",A.c,T(A).toString(),"loading")];ie||Z.push(I.a.c("wf",A.c,T(A).toString(),"inactive")),f(I.f,Z,se)}O(I,"fontinactive",A),Le(this)};function Le(A){--A.f==0&&A.j&&(A.m?(A=A.a,A.g&&f(A.f,[A.a.c("wf","active")],[A.a.c("wf","loading"),A.a.c("wf","inactive")]),O(A,"active")):L(A.a))}function Be(A){this.j=A,this.a=new v,this.h=0,this.f=this.g=!0}Be.prototype.load=function(A){this.c=new a(this.j,A.context||this.j),this.g=A.events!==!1,this.f=A.classes!==!1,ut(this,new j(this.c,A),A)};function ct(A,I,ie,Z,se){var me=--A.h==0;(A.f||A.g)&&setTimeout(function(){var Ee=se||null,Re=Z||null||{};if(ie.length===0&&me)L(I.a);else{I.f+=ie.length,me&&(I.j=me);var ze,et=[];for(ze=0;ze<ie.length;ze++){var $e=ie[ze],ft=Re[$e.c],Jt=I.a,sn=$e;if(Jt.g&&f(Jt.f,[Jt.a.c("wf",sn.c,T(sn).toString(),"loading")]),O(Jt,"fontloading",sn),Jt=null,ve===null)if(window.FontFace){var sn=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),ld=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);ve=sn?42<parseInt(sn[1],10):!ld}else ve=!1;ve?Jt=new V(n(I.g,I),n(I.h,I),I.c,$e,I.s,ft):Jt=new J(n(I.g,I),n(I.h,I),I.c,$e,I.s,Ee,ft),et.push(Jt)}for(ze=0;ze<et.length;ze++)et[ze].start()}},0)}function ut(A,I,ie){var se=[],Z=ie.timeout;ae(I);var se=S(A.a,ie,A.c),me=new _e(A.c,I,Z);for(A.h=se.length,I=0,ie=se.length;I<ie;I++)se[I].load(function(Ee,Re,ze){ct(A,me,Ee,Re,ze)})}function E(A,I){this.c=A,this.a=I}E.prototype.load=function(A){function I(){if(me["__mti_fntLst"+Z]){var Ee=me["__mti_fntLst"+Z](),Re=[],ze;if(Ee)for(var et=0;et<Ee.length;et++){var $e=Ee[et].fontfamily;Ee[et].fontStyle!=null&&Ee[et].fontWeight!=null?(ze=Ee[et].fontStyle+Ee[et].fontWeight,Re.push(new _($e,ze))):Re.push(new _($e))}A(Re)}else setTimeout(function(){I()},50)}var ie=this,Z=ie.a.projectId,se=ie.a.version;if(Z){var me=ie.c.o;p(this.c,(ie.a.api||"https://fast.fonts.net/jsapi")+"/"+Z+".js"+(se?"?v="+se:""),function(Ee){Ee?A([]):(me["__MonotypeConfiguration__"+Z]=function(){return ie.a},I())}).id="__MonotypeAPIScript__"+Z}else A([])};function X(A,I){this.c=A,this.a=I}X.prototype.load=function(A){var I,ie,Z=this.a.urls||[],se=this.a.families||[],me=this.a.testStrings||{},Ee=new m;for(I=0,ie=Z.length;I<ie;I++)h(this.c,Z[I],g(Ee));var Re=[];for(I=0,ie=se.length;I<ie;I++)if(Z=se[I].split(":"),Z[1])for(var ze=Z[1].split(","),et=0;et<ze.length;et+=1)Re.push(new _(Z[0],ze[et]));else Re.push(new _(Z[0]));y(Ee,function(){A(Re,me)})};function q(A,I){A?this.c=A:this.c=M,this.a=[],this.f=[],this.g=I||""}var M="https://fonts.googleapis.com/css";function k(A,I){for(var ie=I.length,Z=0;Z<ie;Z++){var se=I[Z].split(":");se.length==3&&A.f.push(se.pop());var me="";se.length==2&&se[1]!=""&&(me=":"),A.a.push(se.join(me))}}function z(A){if(A.a.length==0)throw Error("No fonts to load!");if(A.c.indexOf("kit=")!=-1)return A.c;for(var I=A.a.length,ie=[],Z=0;Z<I;Z++)ie.push(A.a[Z].replace(/ /g,"+"));return I=A.c+"?family="+ie.join("%7C"),0<A.f.length&&(I+="&subset="+A.f.join(",")),0<A.g.length&&(I+="&text="+encodeURIComponent(A.g)),I}function $(A){this.f=A,this.a=[],this.c={}}var Q={latin:"BESbswy","latin-ext":"çöüğş",cyrillic:"йяЖ",greek:"αβΣ",khmer:"កខគ",Hanuman:"កខគ"},W={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},oe={i:"i",italic:"i",n:"n",normal:"n"},de=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;function le(A){for(var I=A.f.length,ie=0;ie<I;ie++){var Z=A.f[ie].split(":"),se=Z[0].replace(/\+/g," "),me=["n4"];if(2<=Z.length){var Ee,Re=Z[1];if(Ee=[],Re)for(var Re=Re.split(","),ze=Re.length,et=0;et<ze;et++){var $e;if($e=Re[et],$e.match(/^[\w-]+$/)){var ft=de.exec($e.toLowerCase());if(ft==null)$e="";else{if($e=ft[2],$e=$e==null||$e==""?"n":oe[$e],ft=ft[1],ft==null||ft=="")ft="4";else var Jt=W[ft],ft=Jt||(isNaN(ft)?"4":ft.substr(0,1));$e=[$e,ft].join("")}}else $e="";$e&&Ee.push($e)}0<Ee.length&&(me=Ee),Z.length==3&&(Z=Z[2],Ee=[],Z=Z?Z.split(","):Ee,0<Z.length&&(Z=Q[Z[0]])&&(A.c[se]=Z))}for(A.c[se]||(Z=Q[se])&&(A.c[se]=Z),Z=0;Z<me.length;Z+=1)A.a.push(new _(se,me[Z]))}}function we(A,I){this.c=A,this.a=I}var je={Arimo:!0,Cousine:!0,Tinos:!0};we.prototype.load=function(A){var I=new m,ie=this.c,Z=new q(this.a.api,this.a.text),se=this.a.families;k(Z,se);var me=new $(se);le(me),h(ie,z(Z),g(I)),y(I,function(){A(me.a,me.c,je)})};function De(A,I){this.c=A,this.a=I}De.prototype.load=function(A){var I=this.a.id,ie=this.c.o;I?p(this.c,(this.a.api||"https://use.typekit.net")+"/"+I+".js",function(Z){if(Z)A([]);else if(ie.Typekit&&ie.Typekit.config&&ie.Typekit.config.fn){Z=ie.Typekit.config.fn;for(var se=[],me=0;me<Z.length;me+=2)for(var Ee=Z[me],Re=Z[me+1],ze=0;ze<Re.length;ze++)se.push(new _(Ee,Re[ze]));try{ie.Typekit.load({events:!1,classes:!1,async:!0})}catch{}A(se)}},2e3):A([])};function _t(A,I){this.c=A,this.f=I,this.a=[]}_t.prototype.load=function(A){var I=this.f.id,ie=this.c.o,Z=this;I?(ie.__webfontfontdeckmodule__||(ie.__webfontfontdeckmodule__={}),ie.__webfontfontdeckmodule__[I]=function(se,me){for(var Ee=0,Re=me.fonts.length;Ee<Re;++Ee){var ze=me.fonts[Ee];Z.a.push(new _(ze.name,N("font-weight:"+ze.weight+";font-style:"+ze.style)))}A(Z.a)},p(this.c,(this.f.api||"https://f.fontdeck.com/s/css/js/")+d(this.c)+"/"+I+".js",function(se){se&&A([])})):A([])};var Mt=new Be(window);Mt.a.c.custom=function(A,I){return new X(I,A)},Mt.a.c.fontdeck=function(A,I){return new _t(I,A)},Mt.a.c.monotype=function(A,I){return new E(I,A)},Mt.a.c.typekit=function(A,I){return new De(I,A)},Mt.a.c.google=function(A,I){return new we(I,A)};var Ft={load:n(Mt.load,Mt)};i.exports?i.exports=Ft:(window.WebFont=Ft,window.WebFontConfig&&Mt.load(window.WebFontConfig))})()}(ts)),ts.exports}var ih=th();const nh=or(ih),gn={INVALID:["seeking position failed.","InvalidStateError"],GONE:["A requested file or directory could not be found at the time an operation was processed.","NotFoundError"],MISMATCH:["The path supplied exists, but was not an entry of requested type.","TypeMismatchError"],MOD_ERR:["The object can not be modified in this way.","InvalidModificationError"],SYNTAX:i=>[`Failed to execute 'write' on 'UnderlyingSinkBase': Invalid params passed. ${i}`,"SyntaxError"],DISALLOWED:["The request is not allowed by the user agent or the platform in the current context.","NotAllowedError"]},rh=i=>typeof i=="object"&&typeof i.type<"u";async function ah(i){var e,t,n;const{FolderHandle:r,FileHandle:a}=await qe(async()=>{const{FolderHandle:u,FileHandle:f}=await import("./memory-TENAsLGL.js");return{FolderHandle:u,FileHandle:f}},__vite__mapDeps([0,1,2])),{FileSystemDirectoryHandle:s}=await qe(async()=>{const{FileSystemDirectoryHandle:u}=await Promise.resolve().then(()=>Q0);return{FileSystemDirectoryHandle:u}},void 0),o=(t=(e=i[0].webkitRelativePath)===null||e===void 0?void 0:e.split("/",1)[0])!==null&&t!==void 0?t:"",l=new r(o,!1);for(let u=0;u<i.length;u++){const f=i[u],c=!((n=f.webkitRelativePath)===null||n===void 0)&&n.length?f.webkitRelativePath.split("/"):["",f.name];c.shift();const d=c.pop(),h=c.reduce((p,m)=>(p._entries[m]||(p._entries[m]=new r(m,!1)),p._entries[m]),l);h._entries[d]=new a(f.name,f,!1)}return new s(l)}async function sh(i){const{FileHandle:e}=await qe(async()=>{const{FileHandle:r}=await import("./memory-TENAsLGL.js");return{FileHandle:r}},__vite__mapDeps([0,1,2])),{FileSystemFileHandle:t}=await qe(async()=>{const{FileSystemFileHandle:r}=await Promise.resolve().then(()=>Gu);return{FileSystemFileHandle:r}},void 0);return Array.from(i).map(r=>new t(new e(r.name,r,!1)))}const Zc=Object.freeze(Object.defineProperty({__proto__:null,errors:gn,isChunkObject:rh,makeDirHandleFromFileList:ah,makeFileHandlesFromFileList:sh},Symbol.toStringTag,{value:"Module"}));var is={};/*! howler.js v2.2.4 | (c) 2013-2020, James Simpson of GoldFire Studios | MIT License | howlerjs.com */var Ol;function oh(){return Ol||(Ol=1,function(i){(function(){var e=function(){this.init()};e.prototype={init:function(){var c=this||t;return c._counter=1e3,c._html5AudioPool=[],c.html5PoolSize=10,c._codecs={},c._howls=[],c._muted=!1,c._volume=1,c._canPlayEvent="canplaythrough",c._navigator=typeof window<"u"&&window.navigator?window.navigator:null,c.masterGain=null,c.noAudio=!1,c.usingWebAudio=!0,c.autoSuspend=!0,c.ctx=null,c.autoUnlock=!0,c._setup(),c},volume:function(c){var d=this||t;if(c=parseFloat(c),d.ctx||f(),c!==void 0&&c>=0&&c<=1){if(d._volume=c,d._muted)return d;d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c,t.ctx.currentTime);for(var h=0;h<d._howls.length;h++)if(!d._howls[h]._webAudio)for(var p=d._howls[h]._getSoundIds(),m=0;m<p.length;m++){var g=d._howls[h]._soundById(p[m]);g&&g._node&&(g._node.volume=g._volume*c)}return d}return d._volume},mute:function(c){var d=this||t;d.ctx||f(),d._muted=c,d.usingWebAudio&&d.masterGain.gain.setValueAtTime(c?0:d._volume,t.ctx.currentTime);for(var h=0;h<d._howls.length;h++)if(!d._howls[h]._webAudio)for(var p=d._howls[h]._getSoundIds(),m=0;m<p.length;m++){var g=d._howls[h]._soundById(p[m]);g&&g._node&&(g._node.muted=!!c||g._muted)}return d},stop:function(){for(var c=this||t,d=0;d<c._howls.length;d++)c._howls[d].stop();return c},unload:function(){for(var c=this||t,d=c._howls.length-1;d>=0;d--)c._howls[d].unload();return c.usingWebAudio&&c.ctx&&c.ctx.close!==void 0&&(c.ctx.close(),c.ctx=null,f()),c},codecs:function(c){return(this||t)._codecs[c.replace(/^x-/,"")]},_setup:function(){var c=this||t;if(c.state=c.ctx&&c.ctx.state||"suspended",c._autoSuspend(),!c.usingWebAudio)if(typeof Audio<"u")try{var d=new Audio;d.oncanplaythrough===void 0&&(c._canPlayEvent="canplay")}catch{c.noAudio=!0}else c.noAudio=!0;try{var d=new Audio;d.muted&&(c.noAudio=!0)}catch{}return c.noAudio||c._setupCodecs(),c},_setupCodecs:function(){var c=this||t,d=null;try{d=typeof Audio<"u"?new Audio:null}catch{return c}if(!d||typeof d.canPlayType!="function")return c;var h=d.canPlayType("audio/mpeg;").replace(/^no$/,""),p=c._navigator?c._navigator.userAgent:"",m=p.match(/OPR\/(\d+)/g),g=m&&parseInt(m[0].split("/")[1],10)<33,y=p.indexOf("Safari")!==-1&&p.indexOf("Chrome")===-1,x=p.match(/Version\/(.*?) /),w=y&&x&&parseInt(x[1],10)<15;return c._codecs={mp3:!(g||!h&&!d.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!h,opus:!!d.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!d.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(d.canPlayType('audio/wav; codecs="1"')||d.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!d.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!d.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(d.canPlayType("audio/x-m4a;")||d.canPlayType("audio/m4a;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(d.canPlayType("audio/x-m4b;")||d.canPlayType("audio/m4b;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(d.canPlayType("audio/x-mp4;")||d.canPlayType("audio/mp4;")||d.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!(w||!d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!(w||!d.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!d.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(d.canPlayType("audio/x-flac;")||d.canPlayType("audio/flac;")).replace(/^no$/,"")},c},_unlockAudio:function(){var c=this||t;if(!c._audioUnlocked&&c.ctx){c._audioUnlocked=!1,c.autoUnlock=!1,c._mobileUnloaded||c.ctx.sampleRate===44100||(c._mobileUnloaded=!0,c.unload()),c._scratchBuffer=c.ctx.createBuffer(1,1,22050);var d=function(h){for(;c._html5AudioPool.length<c.html5PoolSize;)try{var p=new Audio;p._unlocked=!0,c._releaseHtml5Audio(p)}catch{c.noAudio=!0;break}for(var m=0;m<c._howls.length;m++)if(!c._howls[m]._webAudio)for(var g=c._howls[m]._getSoundIds(),y=0;y<g.length;y++){var x=c._howls[m]._soundById(g[y]);x&&x._node&&!x._node._unlocked&&(x._node._unlocked=!0,x._node.load())}c._autoResume();var w=c.ctx.createBufferSource();w.buffer=c._scratchBuffer,w.connect(c.ctx.destination),w.start===void 0?w.noteOn(0):w.start(0),typeof c.ctx.resume=="function"&&c.ctx.resume(),w.onended=function(){w.disconnect(0),c._audioUnlocked=!0,document.removeEventListener("touchstart",d,!0),document.removeEventListener("touchend",d,!0),document.removeEventListener("click",d,!0),document.removeEventListener("keydown",d,!0);for(var _=0;_<c._howls.length;_++)c._howls[_]._emit("unlock")}};return document.addEventListener("touchstart",d,!0),document.addEventListener("touchend",d,!0),document.addEventListener("click",d,!0),document.addEventListener("keydown",d,!0),c}},_obtainHtml5Audio:function(){var c=this||t;if(c._html5AudioPool.length)return c._html5AudioPool.pop();var d=new Audio().play();return d&&typeof Promise<"u"&&(d instanceof Promise||typeof d.then=="function")&&d.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(c){var d=this||t;return c._unlocked&&d._html5AudioPool.push(c),d},_autoSuspend:function(){var c=this;if(c.autoSuspend&&c.ctx&&c.ctx.suspend!==void 0&&t.usingWebAudio){for(var d=0;d<c._howls.length;d++)if(c._howls[d]._webAudio){for(var h=0;h<c._howls[d]._sounds.length;h++)if(!c._howls[d]._sounds[h]._paused)return c}return c._suspendTimer&&clearTimeout(c._suspendTimer),c._suspendTimer=setTimeout(function(){if(c.autoSuspend){c._suspendTimer=null,c.state="suspending";var p=function(){c.state="suspended",c._resumeAfterSuspend&&(delete c._resumeAfterSuspend,c._autoResume())};c.ctx.suspend().then(p,p)}},3e4),c}},_autoResume:function(){var c=this;if(c.ctx&&c.ctx.resume!==void 0&&t.usingWebAudio)return c.state==="running"&&c.ctx.state!=="interrupted"&&c._suspendTimer?(clearTimeout(c._suspendTimer),c._suspendTimer=null):c.state==="suspended"||c.state==="running"&&c.ctx.state==="interrupted"?(c.ctx.resume().then(function(){c.state="running";for(var d=0;d<c._howls.length;d++)c._howls[d]._emit("resume")}),c._suspendTimer&&(clearTimeout(c._suspendTimer),c._suspendTimer=null)):c.state==="suspending"&&(c._resumeAfterSuspend=!0),c}};var t=new e,n=function(c){var d=this;if(!c.src||c.src.length===0)return void console.error("An array of source files must be passed with any new Howl.");d.init(c)};n.prototype={init:function(c){var d=this;return t.ctx||f(),d._autoplay=c.autoplay||!1,d._format=typeof c.format!="string"?c.format:[c.format],d._html5=c.html5||!1,d._muted=c.mute||!1,d._loop=c.loop||!1,d._pool=c.pool||5,d._preload=typeof c.preload!="boolean"&&c.preload!=="metadata"||c.preload,d._rate=c.rate||1,d._sprite=c.sprite||{},d._src=typeof c.src!="string"?c.src:[c.src],d._volume=c.volume!==void 0?c.volume:1,d._xhr={method:c.xhr&&c.xhr.method?c.xhr.method:"GET",headers:c.xhr&&c.xhr.headers?c.xhr.headers:null,withCredentials:!(!c.xhr||!c.xhr.withCredentials)&&c.xhr.withCredentials},d._duration=0,d._state="unloaded",d._sounds=[],d._endTimers={},d._queue=[],d._playLock=!1,d._onend=c.onend?[{fn:c.onend}]:[],d._onfade=c.onfade?[{fn:c.onfade}]:[],d._onload=c.onload?[{fn:c.onload}]:[],d._onloaderror=c.onloaderror?[{fn:c.onloaderror}]:[],d._onplayerror=c.onplayerror?[{fn:c.onplayerror}]:[],d._onpause=c.onpause?[{fn:c.onpause}]:[],d._onplay=c.onplay?[{fn:c.onplay}]:[],d._onstop=c.onstop?[{fn:c.onstop}]:[],d._onmute=c.onmute?[{fn:c.onmute}]:[],d._onvolume=c.onvolume?[{fn:c.onvolume}]:[],d._onrate=c.onrate?[{fn:c.onrate}]:[],d._onseek=c.onseek?[{fn:c.onseek}]:[],d._onunlock=c.onunlock?[{fn:c.onunlock}]:[],d._onresume=[],d._webAudio=t.usingWebAudio&&!d._html5,t.ctx!==void 0&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(d),d._autoplay&&d._queue.push({event:"play",action:function(){d.play()}}),d._preload&&d._preload!=="none"&&d.load(),d},load:function(){var c=this,d=null;if(t.noAudio)return void c._emit("loaderror",null,"No audio support.");typeof c._src=="string"&&(c._src=[c._src]);for(var h=0;h<c._src.length;h++){var p,m;if(c._format&&c._format[h])p=c._format[h];else{if(typeof(m=c._src[h])!="string"){c._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}p=/^data:audio\/([^;,]+);/i.exec(m),p||(p=/\.([^.]+)$/.exec(m.split("?",1)[0])),p&&(p=p[1].toLowerCase())}if(p||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),p&&t.codecs(p)){d=c._src[h];break}}return d?(c._src=d,c._state="loading",window.location.protocol==="https:"&&d.slice(0,5)==="http:"&&(c._html5=!0,c._webAudio=!1),new r(c),c._webAudio&&s(c),c):void c._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(c,d){var h=this,p=null;if(typeof c=="number")p=c,c=null;else{if(typeof c=="string"&&h._state==="loaded"&&!h._sprite[c])return null;if(c===void 0&&(c="__default",!h._playLock)){for(var m=0,g=0;g<h._sounds.length;g++)h._sounds[g]._paused&&!h._sounds[g]._ended&&(m++,p=h._sounds[g]._id);m===1?c=null:p=null}}var y=p?h._soundById(p):h._inactiveSound();if(!y)return null;if(p&&!c&&(c=y._sprite||"__default"),h._state!=="loaded"){y._sprite=c,y._ended=!1;var x=y._id;return h._queue.push({event:"play",action:function(){h.play(x)}}),x}if(p&&!y._paused)return d||h._loadQueue("play"),y._id;h._webAudio&&t._autoResume();var w=Math.max(0,y._seek>0?y._seek:h._sprite[c][0]/1e3),_=Math.max(0,(h._sprite[c][0]+h._sprite[c][1])/1e3-w),C=1e3*_/Math.abs(y._rate),F=h._sprite[c][0]/1e3,T=(h._sprite[c][0]+h._sprite[c][1])/1e3;y._sprite=c,y._ended=!1;var R=function(){y._paused=!1,y._seek=w,y._start=F,y._stop=T,y._loop=!(!y._loop&&!h._sprite[c][2])};if(w>=T)return void h._ended(y);var N=y._node;if(h._webAudio){var j=function(){h._playLock=!1,R(),h._refreshBuffer(y);var v=y._muted||h._muted?0:y._volume;N.gain.setValueAtTime(v,t.ctx.currentTime),y._playStart=t.ctx.currentTime,N.bufferSource.start===void 0?y._loop?N.bufferSource.noteGrainOn(0,w,86400):N.bufferSource.noteGrainOn(0,w,_):y._loop?N.bufferSource.start(0,w,86400):N.bufferSource.start(0,w,_),C!==1/0&&(h._endTimers[y._id]=setTimeout(h._ended.bind(h,y),C)),d||setTimeout(function(){h._emit("play",y._id),h._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?j():(h._playLock=!0,h.once("resume",j),h._clearTimer(y._id))}else{var ae=function(){N.currentTime=w,N.muted=y._muted||h._muted||t._muted||N.muted,N.volume=y._volume*t.volume(),N.playbackRate=y._rate;try{var v=N.play();if(v&&typeof Promise<"u"&&(v instanceof Promise||typeof v.then=="function")?(h._playLock=!0,R(),v.then(function(){h._playLock=!1,N._unlocked=!0,d?h._loadQueue():h._emit("play",y._id)}).catch(function(){h._playLock=!1,h._emit("playerror",y._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),y._ended=!0,y._paused=!0})):d||(h._playLock=!1,R(),h._emit("play",y._id)),N.playbackRate=y._rate,N.paused)return void h._emit("playerror",y._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");c!=="__default"||y._loop?h._endTimers[y._id]=setTimeout(h._ended.bind(h,y),C):(h._endTimers[y._id]=function(){h._ended(y),N.removeEventListener("ended",h._endTimers[y._id],!1)},N.addEventListener("ended",h._endTimers[y._id],!1))}catch(S){h._emit("playerror",y._id,S)}};N.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(N.src=h._src,N.load());var L=window&&window.ejecta||!N.readyState&&t._navigator.isCocoonJS;if(N.readyState>=3||L)ae();else{h._playLock=!0,h._state="loading";var O=function(){h._state="loaded",ae(),N.removeEventListener(t._canPlayEvent,O,!1)};N.addEventListener(t._canPlayEvent,O,!1),h._clearTimer(y._id)}}return y._id},pause:function(c){var d=this;if(d._state!=="loaded"||d._playLock)return d._queue.push({event:"pause",action:function(){d.pause(c)}}),d;for(var h=d._getSoundIds(c),p=0;p<h.length;p++){d._clearTimer(h[p]);var m=d._soundById(h[p]);if(m&&!m._paused&&(m._seek=d.seek(h[p]),m._rateSeek=0,m._paused=!0,d._stopFade(h[p]),m._node))if(d._webAudio){if(!m._node.bufferSource)continue;m._node.bufferSource.stop===void 0?m._node.bufferSource.noteOff(0):m._node.bufferSource.stop(0),d._cleanBuffer(m._node)}else isNaN(m._node.duration)&&m._node.duration!==1/0||m._node.pause();arguments[1]||d._emit("pause",m?m._id:null)}return d},stop:function(c,d){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"stop",action:function(){h.stop(c)}}),h;for(var p=h._getSoundIds(c),m=0;m<p.length;m++){h._clearTimer(p[m]);var g=h._soundById(p[m]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,h._stopFade(p[m]),g._node&&(h._webAudio?g._node.bufferSource&&(g._node.bufferSource.stop===void 0?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),h._cleanBuffer(g._node)):isNaN(g._node.duration)&&g._node.duration!==1/0||(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&h._clearSound(g._node))),d||h._emit("stop",g._id))}return h},mute:function(c,d){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"mute",action:function(){h.mute(c,d)}}),h;if(d===void 0){if(typeof c!="boolean")return h._muted;h._muted=c}for(var p=h._getSoundIds(d),m=0;m<p.length;m++){var g=h._soundById(p[m]);g&&(g._muted=c,g._interval&&h._stopFade(g._id),h._webAudio&&g._node?g._node.gain.setValueAtTime(c?0:g._volume,t.ctx.currentTime):g._node&&(g._node.muted=!!t._muted||c),h._emit("mute",g._id))}return h},volume:function(){var c,d,h=this,p=arguments;if(p.length===0)return h._volume;p.length===1||p.length===2&&p[1]===void 0?h._getSoundIds().indexOf(p[0])>=0?d=parseInt(p[0],10):c=parseFloat(p[0]):p.length>=2&&(c=parseFloat(p[0]),d=parseInt(p[1],10));var m;if(!(c!==void 0&&c>=0&&c<=1))return m=d?h._soundById(d):h._sounds[0],m?m._volume:0;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"volume",action:function(){h.volume.apply(h,p)}}),h;d===void 0&&(h._volume=c),d=h._getSoundIds(d);for(var g=0;g<d.length;g++)(m=h._soundById(d[g]))&&(m._volume=c,p[2]||h._stopFade(d[g]),h._webAudio&&m._node&&!m._muted?m._node.gain.setValueAtTime(c,t.ctx.currentTime):m._node&&!m._muted&&(m._node.volume=c*t.volume()),h._emit("volume",m._id));return h},fade:function(c,d,h,p){var m=this;if(m._state!=="loaded"||m._playLock)return m._queue.push({event:"fade",action:function(){m.fade(c,d,h,p)}}),m;c=Math.min(Math.max(0,parseFloat(c)),1),d=Math.min(Math.max(0,parseFloat(d)),1),h=parseFloat(h),m.volume(c,p);for(var g=m._getSoundIds(p),y=0;y<g.length;y++){var x=m._soundById(g[y]);if(x){if(p||m._stopFade(g[y]),m._webAudio&&!x._muted){var w=t.ctx.currentTime,_=w+h/1e3;x._volume=c,x._node.gain.setValueAtTime(c,w),x._node.gain.linearRampToValueAtTime(d,_)}m._startFadeInterval(x,c,d,h,g[y],p===void 0)}}return m},_startFadeInterval:function(c,d,h,p,m,g){var y=this,x=d,w=h-d,_=Math.abs(w/.01),C=Math.max(4,_>0?p/_:p),F=Date.now();c._fadeTo=h,c._interval=setInterval(function(){var T=(Date.now()-F)/p;F=Date.now(),x+=w*T,x=Math.round(100*x)/100,x=w<0?Math.max(h,x):Math.min(h,x),y._webAudio?c._volume=x:y.volume(x,c._id,!0),g&&(y._volume=x),(h<d&&x<=h||h>d&&x>=h)&&(clearInterval(c._interval),c._interval=null,c._fadeTo=null,y.volume(h,c._id),y._emit("fade",c._id))},C)},_stopFade:function(c){var d=this,h=d._soundById(c);return h&&h._interval&&(d._webAudio&&h._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(h._interval),h._interval=null,d.volume(h._fadeTo,c),h._fadeTo=null,d._emit("fade",c)),d},loop:function(){var c,d,h,p=this,m=arguments;if(m.length===0)return p._loop;if(m.length===1){if(typeof m[0]!="boolean")return!!(h=p._soundById(parseInt(m[0],10)))&&h._loop;c=m[0],p._loop=c}else m.length===2&&(c=m[0],d=parseInt(m[1],10));for(var g=p._getSoundIds(d),y=0;y<g.length;y++)(h=p._soundById(g[y]))&&(h._loop=c,p._webAudio&&h._node&&h._node.bufferSource&&(h._node.bufferSource.loop=c,c&&(h._node.bufferSource.loopStart=h._start||0,h._node.bufferSource.loopEnd=h._stop,p.playing(g[y])&&(p.pause(g[y],!0),p.play(g[y],!0)))));return p},rate:function(){var c,d,h=this,p=arguments;if(p.length===0)d=h._sounds[0]._id;else if(p.length===1){var m=h._getSoundIds(),g=m.indexOf(p[0]);g>=0?d=parseInt(p[0],10):c=parseFloat(p[0])}else p.length===2&&(c=parseFloat(p[0]),d=parseInt(p[1],10));var y;if(typeof c!="number")return y=h._soundById(d),y?y._rate:h._rate;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"rate",action:function(){h.rate.apply(h,p)}}),h;d===void 0&&(h._rate=c),d=h._getSoundIds(d);for(var x=0;x<d.length;x++)if(y=h._soundById(d[x])){h.playing(d[x])&&(y._rateSeek=h.seek(d[x]),y._playStart=h._webAudio?t.ctx.currentTime:y._playStart),y._rate=c,h._webAudio&&y._node&&y._node.bufferSource?y._node.bufferSource.playbackRate.setValueAtTime(c,t.ctx.currentTime):y._node&&(y._node.playbackRate=c);var w=h.seek(d[x]),_=(h._sprite[y._sprite][0]+h._sprite[y._sprite][1])/1e3-w,C=1e3*_/Math.abs(y._rate);!h._endTimers[d[x]]&&y._paused||(h._clearTimer(d[x]),h._endTimers[d[x]]=setTimeout(h._ended.bind(h,y),C)),h._emit("rate",y._id)}return h},seek:function(){var c,d,h=this,p=arguments;if(p.length===0)h._sounds.length&&(d=h._sounds[0]._id);else if(p.length===1){var m=h._getSoundIds(),g=m.indexOf(p[0]);g>=0?d=parseInt(p[0],10):h._sounds.length&&(d=h._sounds[0]._id,c=parseFloat(p[0]))}else p.length===2&&(c=parseFloat(p[0]),d=parseInt(p[1],10));if(d===void 0)return 0;if(typeof c=="number"&&(h._state!=="loaded"||h._playLock))return h._queue.push({event:"seek",action:function(){h.seek.apply(h,p)}}),h;var y=h._soundById(d);if(y){if(!(typeof c=="number"&&c>=0)){if(h._webAudio){var x=h.playing(d)?t.ctx.currentTime-y._playStart:0,w=y._rateSeek?y._rateSeek-y._seek:0;return y._seek+(w+x*Math.abs(y._rate))}return y._node.currentTime}var _=h.playing(d);_&&h.pause(d,!0),y._seek=c,y._ended=!1,h._clearTimer(d),h._webAudio||!y._node||isNaN(y._node.duration)||(y._node.currentTime=c);var C=function(){_&&h.play(d,!0),h._emit("seek",d)};if(_&&!h._webAudio){var F=function(){h._playLock?setTimeout(F,0):C()};setTimeout(F,0)}else C()}return h},playing:function(c){var d=this;if(typeof c=="number"){var h=d._soundById(c);return!!h&&!h._paused}for(var p=0;p<d._sounds.length;p++)if(!d._sounds[p]._paused)return!0;return!1},duration:function(c){var d=this,h=d._duration,p=d._soundById(c);return p&&(h=d._sprite[p._sprite][1]/1e3),h},state:function(){return this._state},unload:function(){for(var c=this,d=c._sounds,h=0;h<d.length;h++)d[h]._paused||c.stop(d[h]._id),c._webAudio||(c._clearSound(d[h]._node),d[h]._node.removeEventListener("error",d[h]._errorFn,!1),d[h]._node.removeEventListener(t._canPlayEvent,d[h]._loadFn,!1),d[h]._node.removeEventListener("ended",d[h]._endFn,!1),t._releaseHtml5Audio(d[h]._node)),delete d[h]._node,c._clearTimer(d[h]._id);var p=t._howls.indexOf(c);p>=0&&t._howls.splice(p,1);var m=!0;for(h=0;h<t._howls.length;h++)if(t._howls[h]._src===c._src||c._src.indexOf(t._howls[h]._src)>=0){m=!1;break}return a&&m&&delete a[c._src],t.noAudio=!1,c._state="unloaded",c._sounds=[],c=null,null},on:function(c,d,h,p){var m=this,g=m["_on"+c];return typeof d=="function"&&g.push(p?{id:h,fn:d,once:p}:{id:h,fn:d}),m},off:function(c,d,h){var p=this,m=p["_on"+c],g=0;if(typeof d=="number"&&(h=d,d=null),d||h)for(g=0;g<m.length;g++){var y=h===m[g].id;if(d===m[g].fn&&y||!d&&y){m.splice(g,1);break}}else if(c)p["_on"+c]=[];else{var x=Object.keys(p);for(g=0;g<x.length;g++)x[g].indexOf("_on")===0&&Array.isArray(p[x[g]])&&(p[x[g]]=[])}return p},once:function(c,d,h){var p=this;return p.on(c,d,h,1),p},_emit:function(c,d,h){for(var p=this,m=p["_on"+c],g=m.length-1;g>=0;g--)m[g].id&&m[g].id!==d&&c!=="load"||(setTimeout(function(y){y.call(this,d,h)}.bind(p,m[g].fn),0),m[g].once&&p.off(c,m[g].fn,m[g].id));return p._loadQueue(c),p},_loadQueue:function(c){var d=this;if(d._queue.length>0){var h=d._queue[0];h.event===c&&(d._queue.shift(),d._loadQueue()),c||h.action()}return d},_ended:function(c){var d=this,h=c._sprite;if(!d._webAudio&&c._node&&!c._node.paused&&!c._node.ended&&c._node.currentTime<c._stop)return setTimeout(d._ended.bind(d,c),100),d;var p=!(!c._loop&&!d._sprite[h][2]);if(d._emit("end",c._id),!d._webAudio&&p&&d.stop(c._id,!0).play(c._id),d._webAudio&&p){d._emit("play",c._id),c._seek=c._start||0,c._rateSeek=0,c._playStart=t.ctx.currentTime;var m=1e3*(c._stop-c._start)/Math.abs(c._rate);d._endTimers[c._id]=setTimeout(d._ended.bind(d,c),m)}return d._webAudio&&!p&&(c._paused=!0,c._ended=!0,c._seek=c._start||0,c._rateSeek=0,d._clearTimer(c._id),d._cleanBuffer(c._node),t._autoSuspend()),d._webAudio||p||d.stop(c._id,!0),d},_clearTimer:function(c){var d=this;if(d._endTimers[c]){if(typeof d._endTimers[c]!="function")clearTimeout(d._endTimers[c]);else{var h=d._soundById(c);h&&h._node&&h._node.removeEventListener("ended",d._endTimers[c],!1)}delete d._endTimers[c]}return d},_soundById:function(c){for(var d=this,h=0;h<d._sounds.length;h++)if(c===d._sounds[h]._id)return d._sounds[h];return null},_inactiveSound:function(){var c=this;c._drain();for(var d=0;d<c._sounds.length;d++)if(c._sounds[d]._ended)return c._sounds[d].reset();return new r(c)},_drain:function(){var c=this,d=c._pool,h=0,p=0;if(!(c._sounds.length<d)){for(p=0;p<c._sounds.length;p++)c._sounds[p]._ended&&h++;for(p=c._sounds.length-1;p>=0;p--){if(h<=d)return;c._sounds[p]._ended&&(c._webAudio&&c._sounds[p]._node&&c._sounds[p]._node.disconnect(0),c._sounds.splice(p,1),h--)}}},_getSoundIds:function(c){var d=this;if(c===void 0){for(var h=[],p=0;p<d._sounds.length;p++)h.push(d._sounds[p]._id);return h}return[c]},_refreshBuffer:function(c){var d=this;return c._node.bufferSource=t.ctx.createBufferSource(),c._node.bufferSource.buffer=a[d._src],c._panner?c._node.bufferSource.connect(c._panner):c._node.bufferSource.connect(c._node),c._node.bufferSource.loop=c._loop,c._loop&&(c._node.bufferSource.loopStart=c._start||0,c._node.bufferSource.loopEnd=c._stop||0),c._node.bufferSource.playbackRate.setValueAtTime(c._rate,t.ctx.currentTime),d},_cleanBuffer:function(c){var d=this,h=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!c.bufferSource)return d;if(t._scratchBuffer&&c.bufferSource&&(c.bufferSource.onended=null,c.bufferSource.disconnect(0),h))try{c.bufferSource.buffer=t._scratchBuffer}catch{}return c.bufferSource=null,d},_clearSound:function(c){/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent)||(c.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var r=function(c){this._parent=c,this.init()};r.prototype={init:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++t._counter,d._sounds.push(c),c.create(),c},create:function(){var c=this,d=c._parent,h=t._muted||c._muted||c._parent._muted?0:c._volume;return d._webAudio?(c._node=t.ctx.createGain===void 0?t.ctx.createGainNode():t.ctx.createGain(),c._node.gain.setValueAtTime(h,t.ctx.currentTime),c._node.paused=!0,c._node.connect(t.masterGain)):t.noAudio||(c._node=t._obtainHtml5Audio(),c._errorFn=c._errorListener.bind(c),c._node.addEventListener("error",c._errorFn,!1),c._loadFn=c._loadListener.bind(c),c._node.addEventListener(t._canPlayEvent,c._loadFn,!1),c._endFn=c._endListener.bind(c),c._node.addEventListener("ended",c._endFn,!1),c._node.src=d._src,c._node.preload=d._preload===!0?"auto":d._preload,c._node.volume=h*t.volume(),c._node.load()),c},reset:function(){var c=this,d=c._parent;return c._muted=d._muted,c._loop=d._loop,c._volume=d._volume,c._rate=d._rate,c._seek=0,c._rateSeek=0,c._paused=!0,c._ended=!0,c._sprite="__default",c._id=++t._counter,c},_errorListener:function(){var c=this;c._parent._emit("loaderror",c._id,c._node.error?c._node.error.code:0),c._node.removeEventListener("error",c._errorFn,!1)},_loadListener:function(){var c=this,d=c._parent;d._duration=Math.ceil(10*c._node.duration)/10,Object.keys(d._sprite).length===0&&(d._sprite={__default:[0,1e3*d._duration]}),d._state!=="loaded"&&(d._state="loaded",d._emit("load"),d._loadQueue()),c._node.removeEventListener(t._canPlayEvent,c._loadFn,!1)},_endListener:function(){var c=this,d=c._parent;d._duration===1/0&&(d._duration=Math.ceil(10*c._node.duration)/10,d._sprite.__default[1]===1/0&&(d._sprite.__default[1]=1e3*d._duration),d._ended(c)),c._node.removeEventListener("ended",c._endFn,!1)}};var a={},s=function(c){var d=c._src;if(a[d])return c._duration=a[d].duration,void u(c);if(/^data:[^;]+;base64,/.test(d)){for(var h=atob(d.split(",")[1]),p=new Uint8Array(h.length),m=0;m<h.length;++m)p[m]=h.charCodeAt(m);l(p.buffer,c)}else{var g=new XMLHttpRequest;g.open(c._xhr.method,d,!0),g.withCredentials=c._xhr.withCredentials,g.responseType="arraybuffer",c._xhr.headers&&Object.keys(c._xhr.headers).forEach(function(y){g.setRequestHeader(y,c._xhr.headers[y])}),g.onload=function(){var y=(g.status+"")[0];if(y!=="0"&&y!=="2"&&y!=="3")return void c._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");l(g.response,c)},g.onerror=function(){c._webAudio&&(c._html5=!0,c._webAudio=!1,c._sounds=[],delete a[d],c.load())},o(g)}},o=function(c){try{c.send()}catch{c.onerror()}},l=function(c,d){var h=function(){d._emit("loaderror",null,"Decoding audio data failed.")},p=function(m){m&&d._sounds.length>0?(a[d._src]=m,u(d,m)):h()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(c).then(p).catch(h):t.ctx.decodeAudioData(c,p,h)},u=function(c,d){d&&!c._duration&&(c._duration=d.duration),Object.keys(c._sprite).length===0&&(c._sprite={__default:[0,1e3*c._duration]}),c._state!=="loaded"&&(c._state="loaded",c._emit("load"),c._loadQueue())},f=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var c=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),d=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),h=d?parseInt(d[1],10):null;if(c&&h&&h<9){var p=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!p&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=t.ctx.createGain===void 0?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};i.Howler=t,i.Howl=n,typeof vi<"u"?(vi.HowlerGlobal=e,vi.Howler=t,vi.Howl=n,vi.Sound=r):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=n,window.Sound=r)})()}(is)),is}var Ps=oh();const lh="data:audio/wav;base64,UklGRkYEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAATElTVBoAAABJTkZPSVNGVA0AAABMYXZmNjAuMy4xMDAAAGRhdGEABAAAAIDfjHvG/eK+8VP5Bvyg/v3+Dv8O/1v+8P59B0sXqgoxBa4BQgEEAIMATAAyAE4AnwA8APf/oH+tf3J/6F74LWgXiQpfBbABbAGy/+b/4f+X/w+AAIAKjAzF7uIk8Ln4efsB/jf+Of66/kv+Ev84/6sBbf+eAMn/IADgACQA3gBXABMBrP9/ACIAvgraEnAIfwVbAdYCxf5zAVr/iQBb/6cAMP9KAKtP4H9VaPUyfhjgC0EFigNcAL4AqP/qABoA5wAc/T7yE/iK/CX94v+A/a3+4P7n/eX+cv0b/w7/v/4AgGK2Qdso7ub2vfsQ/ef96/6b/u//+/1UANb9sIAAgJq/3N4+8MX37PtP/fD+Hf5S/zf+c/80/f3DWsiL5Cby0fm5/OT9IQAG/y0A1P6S/1z/jP//f/9/un+oY5kwqheUC5oFXAGAAFv/WwDN/xQBRf9mgACAWoT+weri4/BI+aH7Xv+l/Zr/Nf3k/xT9/3/1ff9/OkPbIUEPXQiVBN4AiQDT//YA0/8JAA2AAICvgIWfetA55xX0Mfmz/Az+w/5H/4r+Zf8r/015Q1d6KlgVZwkkBqUBigHH/q4A6/7WACL/qgBtHDFPaCbnE/sIigQNAloBpf8qALn/aP9vAMj+mABm5FLnpvMc+iz99f51/wH/zP4c/wcAjf+X/zD/+CAbf51Znio6FNwI5AS5AdUAnf8g/93/yv6lAJH/R4AAgDetL9ZL7LH1VPum/Lr+JP+Y/5z+0v4b/pP+AdF63vruUPj4+7r9nP6Y/Qz/Bv5Q/3P+jf+i/ln8K+1/9y769f1I/RQAxP4RABT+5/8x/mH/ff6k//hB7n/0U6opvRPDCUkEOgF5ASD/PwBI/4cAsP9iAEgHfg1JBb4DCwGVAJz/iQCX/30Awf8LAND/HADc/xLy0+8l+K/7/v06/+b+Bf/W/sH+x/7U/tv+k/4A/yoVChNQCeEDSgLoAEEABQA9ABUABADR/xUAx/8WAHvQ7dWg6v/1wfpZ/eb9OP/6/h7/7f76/sz+zf7X/tkgHR0mDiMHGwP+AC4A9v8xAAoAQgDi/ywA9v9aABMAIAGa/+b/+v8TALT/5v8gAPT/8f8OAC4ANAAFAA3pyuQE8+D5Rf3y/Rr/5f7H/rP+g/7t/q7+Iv/Q/oAALQB9AAcAJQAJAPv/2v/O/yAAWgAbAFkBSAP+ATMCCgIGAY0AKwAzADEAMABIABMAHAC4/17/x/4J//T+Uv9b/6b/wP/Y//D/3v8QAPz/7v8GAEAAFQA4ACoAEwAIAAIABwD9//L/CAADAAkADgAWABMAGwAPAA0ACwAQAAgABQAJAAoAAwD///b/9f/y/+n/9//2//f//f/9/w==",Qc="/smeditor/assets/metronome_high-C7Kf-JE0.wav",Jc="/smeditor/assets/metronome_low-BSgffp0_.wav",ch="/smeditor/assets/mine-Dy-Y9L9c.wav",ea=[".aac",".mid",".midi",".mp3",".oga",".ogg",".opus",".wav",".webm",".weba",".flac",".aiff"],qi=[".bmp",".gif",".jpeg",".jpg",".png",".tif",".tiff",".webp"];class ht{windowManager;minimizeElement;closeElement;closed=!1;options;windowElement;viewElement;constructor(e){this.options=e;const t=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");t.appendChild(r),t.appendChild(n),t.style.width=e.width/16+"rem",t.style.left=window.innerWidth/2-e.width/2*b.general.uiScale+"px",e.height&&(t.style.top=window.innerHeight/2-e.height/2*b.general.uiScale+"px"),t.classList.add("window"),e.win_id&&(t.dataset.win_id=e.win_id),n.classList.add("view"),e.height&&(n.style.height=e.height/16+"rem"),n.style.width=e.width/16+"rem",r.classList.add("navbar"),e.title!==""&&r.appendChild(a);const s=be.getIcon("MINIMIZE",15),o=be.getIcon("CLOSE_WINDOW",15);s.classList.add("unselectable"),s.draggable=!1,s.onclick=()=>{n.style.height!="0px"?n.style.height="0px":n.style.height=e.height+"px",this.clampPosition()},o.classList.add("unselectable"),o.draggable=!1,o.onclick=()=>this.closeWindow(),r.appendChild(s),r.appendChild(o),this.minimizeElement=s,this.closeElement=o,e.disableClose&&(s.style.display="none",o.style.display="none"),a.innerText=e.title,a.classList.add("title"),t.addEventListener("mousedown",()=>this.focus()),e.blocking&&(window.addEventListener("mousedown",this.block,!0),document.getElementById("blocker").style.display="block",t.dataset.blocking="block"),a.addEventListener("mousedown",()=>{window.addEventListener("mousemove",this.handleDrag),window.addEventListener("mouseup",()=>window.removeEventListener("mousemove",this.handleDrag))}),this.focus(),t.classList.add("focused"),this.windowElement=t,this.viewElement=n,requestAnimationFrame(()=>this.center())}addToManager(e){this.windowManager=e,e.view.appendChild(this.windowElement),this.focus()}onClose(){}closeWindow(){this.windowManager&&(this.closed=!0,this.onClose(),this.windowManager.removeWindow(this),this.windowElement.classList.add("exiting"),window.removeEventListener("mousedown",this.block,!0),this.options.blocking&&this.windowManager.windows.filter(e=>e.options.blocking).length==0&&(document.getElementById("blocker").style.display="none"),setTimeout(()=>this.windowManager.view.removeChild(this.windowElement),40))}focus(){if(this.windowManager==null)return;this.windowManager.unfocusAll(),this.windowElement.classList.add("focused");const e=Array.from(this.windowManager.view.children).map(t=>t).filter(t=>t!=this.windowElement);e.sort((t,n)=>parseInt(t.style.zIndex)-parseInt(n.style.zIndex)),e.push(this.windowElement);for(let t=0;t<e.length;t++)e[t].style.zIndex=((e[t].dataset.blocking?10001:0)+t).toString()}unfocus(){this.windowManager!=null&&this.windowElement.classList.remove("focused")}center(){const e=this.windowElement.getBoundingClientRect();this.windowElement.style.left=window.innerWidth/2-e.width/2*b.general.uiScale+"px",this.windowElement.style.top=window.innerHeight/2-e.height/2*b.general.uiScale+"px",this.clampPosition()}block=e=>{!e.target||this.windowElement.contains(e.target)||(e.stopImmediatePropagation(),e.preventDefault())};handleDrag=e=>{const t=parseInt(this.windowElement.style.left.slice(0,-2))+e.movementX,n=parseInt(this.windowElement.style.top.slice(0,-2))+e.movementY;this.windowElement.style.left=t+"px",this.windowElement.style.top=n+"px",this.clampPosition()};clampPosition(){if(this.windowManager==null)return;const e=parseInt(this.windowElement.style.left.slice(0,-2)),t=parseInt(this.windowElement.style.top.slice(0,-2)),n=this.windowManager.app.view.getBoundingClientRect();this.windowElement.style.left=Se(e,n.left,n.width-this.windowElement.clientWidth+n.left)+"px",this.windowElement.style.top=Se(t,n.top,n.height-this.windowElement.clientHeight+n.top)+"px"}move(e,t){this.windowElement.style.left=e+"px",this.windowElement.style.top=t+"px"}setDisableClose(e){e?(this.minimizeElement.style.display="none",this.closeElement.style.display="none"):(this.minimizeElement.style.display="",this.closeElement.style.display="")}setBlocking(e){e?(this.windowElement.dataset.blocking="block",document.getElementById("blocker").style.display="block",window.addEventListener("mousedown",this.block,!0)):(this.windowElement.dataset.blocking="",document.getElementById("blocker").style.display="none",window.removeEventListener("mousedown",this.block,!0)),this.focus()}}class uh extends ht{app;constructor(e){super({title:"About",width:300,win_id:"about"}),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("about-container");const n=document.createElement("div");n.classList.add("logo-container");const r=document.createElement("img");r.src="/smeditor/assets/icon/logo.png";const a=document.createElement("div");a.innerText="SMEditor";const s=document.createElement("div");s.style.textAlign="center",s.innerText="Open source online web tool to view and edit StepMania charts (.sm/.ssc files). Maintained by tillvit";const o=document.createElement("div");if(o.style.fontSize="0.875rem",o.style.color="var(--text-color-secondary)",o.style.textAlign="center",o.innerText=`Core v${window.app.VERSION}`,window.nw){const l=nw.require("nw.gui");o.innerText+=` | App v${l.App.manifest.version}`}{const l=new Date("2025-09-04T10:26:54-04:00");o.innerText+=` | master-2927f21 (${l.toLocaleString()})`}t.appendChild(n),n.appendChild(r),n.appendChild(a),t.appendChild(s),t.appendChild(o),e.appendChild(t),this.viewElement.appendChild(e)}}const Nl={videoHeight:{label:"Video Height",input:{type:"dropdown",items:["360p","480p","720p","1080p"],advanced:!0,transformers:{serialize:i=>`${i}p`,deserialize:i=>parseInt(i.slice(0,-1))}}},fps:{label:"FPS",input:{type:"dropdown",items:[24,30,60],advanced:!1}},bitrate:{label:"Bitrate",input:{type:"display-slider",transformers:{serialize:i=>Math.log(i),deserialize:i=>Math.round(Math.exp(i)/1e3)*1e3,display:i=>Math.round(Math.exp(i)/1e3)+" kbps"},min:Math.log(1e6),max:Math.log(2e7),step:1e-5,displayWidth:80,width:80}},aspectRatio:{label:"Aspect Ratio",input:{type:"dropdown",items:["4 / 3","16 / 9","16 / 10"],advanced:!0,transformers:{serialize:i=>{const e={"4 / 3":1.3333333333333333,"16 / 9":1.7777777777777777,"16 / 10":1.6};return Object.keys(e).find(t=>{if(Math.abs(e[t]-i)<1e-4)return!0})},deserialize:i=>({"4 / 3":1.3333333333333333,"16 / 9":1.7777777777777777,"16 / 10":1.6})[i]}}}},dh={hideBarlines:{label:"Hide edit GUI",input:{type:"checkbox"}},playbackRate:{label:"Playback Rate",input:{type:"number",min:10,max:300,step:10,precision:3,minPrecision:0,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},assistTick:{label:"Assist Tick",input:{type:"checkbox"}},metronome:{label:"Metronome",input:{type:"checkbox"}}};var oo=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)},K=(i,e,t)=>(oo(i,e,"read from private field"),t?t.call(i):e.get(i)),Ie=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},vt=(i,e,t,n)=>(oo(i,e,"write to private field"),e.set(i,t),t),it=(i,e,t)=>(oo(i,e,"access private method"),t),We=new Uint8Array(8),Ci=new DataView(We.buffer),jt=i=>[(i%256+256)%256],Ke=i=>(Ci.setUint16(0,i,!1),[We[0],We[1]]),hh=i=>(Ci.setInt16(0,i,!1),[We[0],We[1]]),eu=i=>(Ci.setUint32(0,i,!1),[We[1],We[2],We[3]]),ke=i=>(Ci.setUint32(0,i,!1),[We[0],We[1],We[2],We[3]]),fh=i=>(Ci.setUint32(0,Math.floor(i/2**32),!1),Ci.setUint32(4,i,!1),[We[0],We[1],We[2],We[3],We[4],We[5],We[6],We[7]]),lo=i=>(Ci.setInt16(0,2**8*i,!1),[We[0],We[1]]),di=i=>(Ci.setInt32(0,2**16*i,!1),[We[0],We[1],We[2],We[3]]),ns=i=>(Ci.setInt32(0,2**30*i,!1),[We[0],We[1],We[2],We[3]]),ui=(i,e=!1)=>{let t=Array(i.length).fill(null).map((n,r)=>i.charCodeAt(r));return e&&t.push(0),t},nn=i=>i&&i[i.length-1],Zn=(i,e,t=!0)=>{let n=i*e;return t?Math.round(n):n},tu=i=>{let e=i*(Math.PI/180),t=Math.cos(e),n=Math.sin(e);return[t,n,0,-n,t,0,0,0,1]},ph=tu(0),iu=i=>[di(i[0]),di(i[1]),ns(i[2]),di(i[3]),di(i[4]),ns(i[5]),di(i[6]),di(i[7]),ns(i[8])],zn=i=>!i||typeof i!="object"?i:Array.isArray(i)?i.map(zn):Object.fromEntries(Object.entries(i).map(([e,t])=>[e,zn(t)])),Et=(i,e,t)=>({type:i,contents:e&&new Uint8Array(e.flat(10)),children:t}),Ct=(i,e,t,n,r)=>Et(i,[jt(e),eu(t),n??[]],r),mh=i=>i?Et("ftyp",[ui("isom"),ke(0),ui("iso4"),ui("hvc1")]):Et("ftyp",[ui("isom"),ke(0),ui("isom"),ui("avc1"),ui("mp41")]),Hl=i=>({type:"mdat",largeSize:i}),gh=i=>({type:"free",size:i}),rs=(i,e)=>Et("moov",null,[bh(e,i),...i.map(t=>yh(t,e))]),bh=(i,e)=>{let t=Zn(Math.max(0,...e.filter(r=>r.samples.length>0).map(r=>nn(r.samples).timestamp+nn(r.samples).duration)),Ns),n=Math.max(...e.map(r=>r.id))+1;return Ct("mvhd",0,0,[ke(i),ke(i),ke(Ns),ke(t),di(1),lo(1),Array(10).fill(0),iu(ph),Array(24).fill(0),ke(n)])},yh=(i,e)=>Et("trak",null,[wh(i,e),vh(i,e)]),wh=(i,e)=>{let t=nn(i.samples),n=Zn(t?t.timestamp+t.duration:0,Ns);return Ct("tkhd",0,3,[ke(e),ke(e),ke(i.id),ke(0),ke(n),Array(8).fill(0),Ke(0),Ke(0),lo(i.info.type==="audio"?1:0),Ke(0),iu(tu(i.info.type==="video"?i.info.rotation:0)),di(i.info.type==="video"?i.info.width:0),di(i.info.type==="video"?i.info.height:0)])},vh=(i,e)=>Et("mdia",null,[xh(i,e),Eh(i.info.type==="video"?"vide":"soun"),Ch(i)]),xh=(i,e)=>{let t=nn(i.samples),n=Zn(t?t.timestamp+t.duration:0,i.timescale);return Ct("mdhd",0,0,[ke(e),ke(e),ke(i.timescale),ke(n),Ke(21956),Ke(0)])},Eh=i=>Ct("hdlr",0,0,[ui("mhlr"),ui(i),ke(0),ke(0),ke(0),ui("mp4-muxer-hdlr")]),Ch=i=>Et("minf",null,[i.info.type==="video"?_h():Ah(),kh(),Mh(i)]),_h=()=>Ct("vmhd",0,1,[Ke(0),Ke(0),Ke(0),Ke(0)]),Ah=()=>Ct("smhd",0,0,[Ke(0),Ke(0)]),kh=()=>Et("dinf",null,[Th()]),Th=()=>Ct("dref",0,0,[ke(1)],[Sh()]),Sh=()=>Ct("url ",0,1),Mh=i=>Et("stbl",null,[Lh(i),Hh(i),zh(i),Vh(i),Uh(i),Wh(i)]),Lh=i=>Ct("stsd",0,0,[ke(1)],[i.info.type==="video"?Dh(Gh[i.info.codec],i):Rh(jh[i.info.codec],i)]),Dh=(i,e)=>Et(i,[Array(6).fill(0),Ke(1),Ke(0),Ke(0),Array(12).fill(0),Ke(e.info.width),Ke(e.info.height),ke(4718592),ke(4718592),ke(0),Ke(1),Array(32).fill(0),Ke(24),hh(65535)],[qh[e.info.codec](e)]),Bh=i=>i.codecPrivate&&Et("avcC",[...i.codecPrivate]),Fh=i=>i.codecPrivate&&Et("hvcC",[...i.codecPrivate]),Ih=i=>i.codecPrivate&&Et("vpcC",[...i.codecPrivate]),Ph=i=>i.codecPrivate&&Et("av1C",[...i.codecPrivate]),Rh=(i,e)=>Et(i,[Array(6).fill(0),Ke(1),Ke(0),Ke(0),ke(0),Ke(e.info.numberOfChannels),Ke(16),Ke(0),Ke(0),di(e.info.sampleRate)],[$h[e.info.codec](e)]),Oh=i=>Ct("esds",0,0,[ke(58753152),jt(32+i.codecPrivate.byteLength),Ke(1),jt(0),ke(75530368),jt(18+i.codecPrivate.byteLength),jt(64),jt(21),eu(0),ke(130071),ke(130071),ke(92307584),jt(i.codecPrivate.byteLength),...i.codecPrivate,ke(109084800),jt(1),jt(2)]),Nh=i=>Et("dOps",[jt(0),jt(i.info.numberOfChannels),Ke(3840),ke(i.info.sampleRate),lo(0),jt(0)]),Hh=i=>Ct("stts",0,0,[ke(i.timeToSampleTable.length),i.timeToSampleTable.map(e=>[ke(e.sampleCount),ke(e.sampleDelta)])]),zh=i=>{if(i.samples.every(t=>t.type==="key"))return null;let e=[...i.samples.entries()].filter(([,t])=>t.type==="key");return Ct("stss",0,0,[ke(e.length),e.map(([t])=>ke(t+1))])},Vh=i=>Ct("stsc",0,0,[ke(i.compactlyCodedChunkTable.length),i.compactlyCodedChunkTable.map(e=>[ke(e.firstChunk),ke(e.samplesPerChunk),ke(1)])]),Uh=i=>Ct("stsz",0,0,[ke(0),ke(i.samples.length),i.samples.map(e=>ke(e.size))]),Wh=i=>i.finalizedChunks.length>0&&nn(i.finalizedChunks).offset>=2**32?Ct("co64",0,0,[ke(i.finalizedChunks.length),i.finalizedChunks.map(e=>fh(e.offset))]):Ct("stco",0,0,[ke(i.finalizedChunks.length),i.finalizedChunks.map(e=>ke(e.offset))]),Gh={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},qh={avc:Bh,hevc:Fh,vp9:Ih,av1:Ph},jh={aac:"mp4a",opus:"Opus"},$h={aac:Oh,opus:Nh},nu=class{constructor(){this.buffer=null}},ru=class{constructor(i,e,t){this.onData=i,this.onDone=e,this.options=t}},Yh=class{constructor(i,e){this.stream=i,this.options=e}},ji,fn,co=class{constructor(){this.pos=0,Ie(this,ji,new Uint8Array(8)),Ie(this,fn,new DataView(K(this,ji).buffer)),this.offsets=new WeakMap}seek(i){this.pos=i}writeU32(i){K(this,fn).setUint32(0,i,!1),this.write(K(this,ji).subarray(0,4))}writeU64(i){K(this,fn).setUint32(0,Math.floor(i/2**32),!1),K(this,fn).setUint32(4,i,!1),this.write(K(this,ji).subarray(0,8))}writeAscii(i){for(let e=0;e<i.length;e++)K(this,fn).setUint8(e%8,i.charCodeAt(e)),e%8===7&&this.write(K(this,ji));i.length%8!==0&&this.write(K(this,ji).subarray(0,i.length%8))}writeBox(i){if(this.offsets.set(i,this.pos),i.contents&&!i.children)this.writeBoxHeader(i,i.size??i.contents.byteLength+8),this.write(i.contents);else{let e=this.pos;if(this.writeBoxHeader(i,0),i.contents&&this.write(i.contents),i.children)for(let r of i.children)r&&this.writeBox(r);let t=this.pos,n=i.size??t-e;this.seek(e),this.writeBoxHeader(i,n),this.seek(t)}}writeBoxHeader(i,e){this.writeU32(i.largeSize?1:e),this.writeAscii(i.type),i.largeSize&&this.writeU64(e)}measureBoxHeader(i){return 8+(i.largeSize?8:0)}patchBox(i){let e=this.pos;this.seek(this.offsets.get(i)),this.writeBox(i),this.seek(e)}measureBox(i){if(i.contents&&!i.children)return this.measureBoxHeader(i)+i.contents.byteLength;{let e=this.measureBoxHeader(i);if(i.contents&&(e+=i.contents.byteLength),i.children)for(let t of i.children)t&&(e+=this.measureBox(t));return e}}};ji=new WeakMap;fn=new WeakMap;var Tr,Ji,Qn,In,Sr,Rs,Kh=class extends co{constructor(i){super(),Ie(this,Sr),Ie(this,Tr,void 0),Ie(this,Ji,new ArrayBuffer(2**16)),Ie(this,Qn,new Uint8Array(K(this,Ji))),Ie(this,In,0),vt(this,Tr,i)}write(i){it(this,Sr,Rs).call(this,this.pos+i.byteLength),K(this,Qn).set(i,this.pos),this.pos+=i.byteLength,vt(this,In,Math.max(K(this,In),this.pos))}finalize(){it(this,Sr,Rs).call(this,this.pos),K(this,Tr).buffer=K(this,Ji).slice(0,Math.max(K(this,In),this.pos))}};Tr=new WeakMap;Ji=new WeakMap;Qn=new WeakMap;In=new WeakMap;Sr=new WeakSet;Rs=function(i){let e=K(this,Ji).byteLength;for(;e<i;)e*=2;if(e===K(this,Ji).byteLength)return;let t=new ArrayBuffer(e),n=new Uint8Array(t);n.set(K(this,Qn),0),vt(this,Ji,t),vt(this,Qn,n)};var Pn,$i,au=class extends co{constructor(i){super(),Ie(this,Pn,void 0),Ie(this,$i,[]),vt(this,Pn,i)}write(i){K(this,$i).push({data:i.slice(),start:this.pos}),this.pos+=i.byteLength}flush(){if(K(this,$i).length===0)return;let i=[],e=[...K(this,$i)].sort((t,n)=>t.start-n.start);i.push({start:e[0].start,size:e[0].data.byteLength});for(let t=1;t<e.length;t++){let n=i[i.length-1],r=e[t];r.start<=n.start+n.size?n.size=Math.max(n.size,r.start+r.data.byteLength-n.start):i.push({start:r.start,size:r.data.byteLength})}for(let t of i){t.data=new Uint8Array(t.size);for(let n of K(this,$i))t.start<=n.start&&n.start<t.start+t.size&&t.data.set(n.data,n.start-t.start);K(this,Pn).onData(t.data,t.start)}K(this,$i).length=0}finalize(){K(this,Pn).onDone?.()}};Pn=new WeakMap;$i=new WeakMap;var Xh=2**24,Zh=2,Vn,ni,Ot,Pr,Os,uo,su,ho,ou,Un,Rr,lu=class extends co{constructor(i){if(super(),Ie(this,Pr),Ie(this,uo),Ie(this,ho),Ie(this,Un),Ie(this,Vn,void 0),Ie(this,ni,void 0),Ie(this,Ot,[]),vt(this,Vn,i),vt(this,ni,i.options?.chunkSize??Xh),!Number.isInteger(K(this,ni))||K(this,ni)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(i){it(this,Pr,Os).call(this,i,this.pos),it(this,Un,Rr).call(this),this.pos+=i.byteLength}finalize(){it(this,Un,Rr).call(this,!0),K(this,Vn).onDone?.()}};Vn=new WeakMap;ni=new WeakMap;Ot=new WeakMap;Pr=new WeakSet;Os=function(i,e){let t=K(this,Ot).findIndex(o=>o.start<=e&&e<o.start+K(this,ni));t===-1&&(t=it(this,ho,ou).call(this,e));let n=K(this,Ot)[t],r=e-n.start,a=i.subarray(0,Math.min(K(this,ni)-r,i.byteLength));n.data.set(a,r);let s={start:r,end:r+a.byteLength};if(it(this,uo,su).call(this,n,s),n.written[0].start===0&&n.written[0].end===K(this,ni)&&(n.shouldFlush=!0),K(this,Ot).length>Zh){for(let o=0;o<K(this,Ot).length-1;o++)K(this,Ot)[o].shouldFlush=!0;it(this,Un,Rr).call(this)}a.byteLength<i.byteLength&&it(this,Pr,Os).call(this,i.subarray(a.byteLength),e+a.byteLength)};uo=new WeakSet;su=function(i,e){let t=0,n=i.written.length-1,r=-1;for(;t<=n;){let a=Math.floor(t+(n-t+1)/2);i.written[a].start<=e.start?(t=a+1,r=a):n=a-1}for(i.written.splice(r+1,0,e),(r===-1||i.written[r].end<e.start)&&r++;r<i.written.length-1&&i.written[r].end>=i.written[r+1].start;)i.written[r].end=Math.max(i.written[r].end,i.written[r+1].end),i.written.splice(r+1,1)};ho=new WeakSet;ou=function(i){let t={start:Math.floor(i/K(this,ni))*K(this,ni),data:new Uint8Array(K(this,ni)),written:[],shouldFlush:!1};return K(this,Ot).push(t),K(this,Ot).sort((n,r)=>n.start-r.start),K(this,Ot).indexOf(t)};Un=new WeakSet;Rr=function(i=!1){for(let e=0;e<K(this,Ot).length;e++){let t=K(this,Ot)[e];if(!(!t.shouldFlush&&!i)){for(let n of t.written)K(this,Vn).onData(t.data.subarray(n.start,n.end),t.start+n.start);K(this,Ot).splice(e--,1)}}};var Qh=class extends lu{constructor(i){super(new ru((e,t)=>i.stream.write({type:"write",data:e,position:t}),void 0,{chunkSize:i.options?.chunkSize}))}},Ns=1e3,Jh=["avc","hevc","vp9","av1"],ef=["aac","opus"],tf=2082844800,nf=.5,rf=["strict","offset"],Pe,Ge,Or,Pt,Mi,Li,Rn,Wn,Gn,Hs,cu,zs,uu,fo,du,Vs,hu,po,fu,Mr,Us,mo,pu,qn,Nr,Jn,ta,Lr,Ws,af=class{constructor(i){if(Ie(this,Hs),Ie(this,zs),Ie(this,fo),Ie(this,Vs),Ie(this,po),Ie(this,Mr),Ie(this,mo),Ie(this,qn),Ie(this,Jn),Ie(this,Lr),Ie(this,Pe,void 0),Ie(this,Ge,void 0),Ie(this,Or,void 0),Ie(this,Pt,void 0),Ie(this,Mi,null),Ie(this,Li,null),Ie(this,Rn,Math.floor(Date.now()/1e3)+tf),Ie(this,Wn,[]),Ie(this,Gn,!1),it(this,Hs,cu).call(this,i),i.video=zn(i.video),i.audio=zn(i.audio),i.fastStart=zn(i.fastStart),this.target=i.target,vt(this,Pe,{firstTimestampBehavior:"strict",...i}),i.target instanceof nu)vt(this,Ge,new Kh(i.target));else if(i.target instanceof ru)vt(this,Ge,i.target.options?.chunked?new lu(i.target):new au(i.target));else if(i.target instanceof Yh)vt(this,Ge,new Qh(i.target));else throw new Error(`Invalid target: ${i.target}`);it(this,zs,uu).call(this),it(this,Vs,hu).call(this)}addVideoChunk(i,e,t){let n=new Uint8Array(i.byteLength);i.copyTo(n),this.addVideoChunkRaw(n,i.type,t??i.timestamp,i.duration,e)}addVideoChunkRaw(i,e,t,n,r){if(it(this,Lr,Ws).call(this),!K(this,Pe).video)throw new Error("No video track declared.");if(typeof K(this,Pe).fastStart=="object"&&K(this,Mi).samples.length===K(this,Pe).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${K(this,Pe).fastStart.expectedVideoChunks}).`);it(this,Mr,Us).call(this,K(this,Mi),i,e,t,n,r)}addAudioChunk(i,e,t){let n=new Uint8Array(i.byteLength);i.copyTo(n),this.addAudioChunkRaw(n,i.type,t??i.timestamp,i.duration,e)}addAudioChunkRaw(i,e,t,n,r){if(it(this,Lr,Ws).call(this),!K(this,Pe).audio)throw new Error("No audio track declared.");if(typeof K(this,Pe).fastStart=="object"&&K(this,Li).samples.length===K(this,Pe).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${K(this,Pe).fastStart.expectedAudioChunks}).`);it(this,Mr,Us).call(this,K(this,Li),i,e,t,n,r)}finalize(){if(K(this,Gn))throw new Error("Cannot finalize a muxer more than once.");K(this,Mi)&&it(this,qn,Nr).call(this,K(this,Mi)),K(this,Li)&&it(this,qn,Nr).call(this,K(this,Li));let i=[K(this,Mi),K(this,Li)].filter(Boolean);if(K(this,Pe).fastStart==="in-memory"){let e;for(let n=0;n<2;n++){let r=rs(i,K(this,Rn)),a=K(this,Ge).measureBox(r);e=K(this,Ge).measureBox(K(this,Pt));let s=K(this,Ge).pos+a+e;for(let o of K(this,Wn)){o.offset=s;for(let l of o.sampleData)s+=l.byteLength,e+=l.byteLength}if(s<2**32)break;e>=2**32&&(K(this,Pt).largeSize=!0)}let t=rs(i,K(this,Rn));K(this,Ge).writeBox(t),K(this,Pt).size=e,K(this,Ge).writeBox(K(this,Pt));for(let n of K(this,Wn)){for(let r of n.sampleData)K(this,Ge).write(r);n.sampleData=null}}else{let e=K(this,Ge).offsets.get(K(this,Pt)),t=K(this,Ge).pos-e;K(this,Pt).size=t,K(this,Pt).largeSize=t>=2**32,K(this,Ge).patchBox(K(this,Pt));let n=rs(i,K(this,Rn));if(typeof K(this,Pe).fastStart=="object"){K(this,Ge).seek(K(this,Or)),K(this,Ge).writeBox(n);let r=e-K(this,Ge).pos;K(this,Ge).writeBox(gh(r))}else K(this,Ge).writeBox(n)}it(this,Jn,ta).call(this),K(this,Ge).finalize(),vt(this,Gn,!0)}};Pe=new WeakMap;Ge=new WeakMap;Or=new WeakMap;Pt=new WeakMap;Mi=new WeakMap;Li=new WeakMap;Rn=new WeakMap;Wn=new WeakMap;Gn=new WeakMap;Hs=new WeakSet;cu=function(i){if(i.video){if(!Jh.includes(i.video.codec))throw new Error(`Unsupported video codec: ${i.video.codec}`);if(i.video.rotation!==void 0&&![0,90,180,270].includes(i.video.rotation))throw new Error(`Invalid video rotation: ${i.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(i.audio&&!ef.includes(i.audio.codec))throw new Error(`Unsupported audio codec: ${i.audio.codec}`);if(i.firstTimestampBehavior&&!rf.includes(i.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${i.firstTimestampBehavior}`);if(typeof i.fastStart=="object"){if(i.video&&i.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(i.audio&&i.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory"].includes(i.fastStart))throw new Error("'fastStart' option must be false, 'in-memory' or an object.")};zs=new WeakSet;uu=function(){let i=K(this,Pe).video?.codec==="hevc";if(K(this,Ge).writeBox(mh(i)),vt(this,Or,K(this,Ge).pos),K(this,Pe).fastStart==="in-memory")vt(this,Pt,Hl(!1));else{if(typeof K(this,Pe).fastStart=="object"){let e=it(this,fo,du).call(this);K(this,Ge).seek(K(this,Ge).pos+e)}vt(this,Pt,Hl(!0)),K(this,Ge).writeBox(K(this,Pt))}it(this,Jn,ta).call(this)};fo=new WeakSet;du=function(){if(typeof K(this,Pe).fastStart!="object")return;let i=0,e=[K(this,Pe).fastStart.expectedVideoChunks,K(this,Pe).fastStart.expectedAudioChunks];for(let t of e)t&&(i+=8*Math.ceil(2/3*t),i+=4*t,i+=12*Math.ceil(2/3*t),i+=4*t,i+=8*t);return i+=4096,i};Vs=new WeakSet;hu=function(){if(K(this,Pe).video&&vt(this,Mi,{id:1,info:{type:"video",codec:K(this,Pe).video.codec,width:K(this,Pe).video.width,height:K(this,Pe).video.height,rotation:K(this,Pe).video.rotation??0},timescale:720,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),K(this,Pe).audio){let i=it(this,po,fu).call(this,2,K(this,Pe).audio.sampleRate,K(this,Pe).audio.numberOfChannels);vt(this,Li,{id:K(this,Pe).video?2:1,info:{type:"audio",codec:K(this,Pe).audio.codec,numberOfChannels:K(this,Pe).audio.numberOfChannels,sampleRate:K(this,Pe).audio.sampleRate},timescale:K(this,Pe).audio.sampleRate,codecPrivate:i,samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}};po=new WeakSet;fu=function(i,e,t){let r=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(e),a=t,s="";s+=i.toString(2).padStart(5,"0"),s+=r.toString(2).padStart(4,"0"),r===15&&(s+=e.toString(2).padStart(24,"0")),s+=a.toString(2).padStart(4,"0");let o=Math.ceil(s.length/8)*8;s=s.padEnd(o,"0");let l=new Uint8Array(s.length/8);for(let u=0;u<s.length;u+=8)l[u/8]=parseInt(s.slice(u,u+8),2);return l};Mr=new WeakSet;Us=function(i,e,t,n,r,a){let s=n/1e6,o=r/1e6;if(i.firstTimestamp===void 0&&(i.firstTimestamp=s),s=it(this,mo,pu).call(this,s,i),i.lastTimestamp=s,(!i.currentChunk||s-i.currentChunk.startTimestamp>=nf)&&(i.currentChunk&&it(this,qn,Nr).call(this,i),i.currentChunk={startTimestamp:s,sampleData:[],sampleCount:0}),i.currentChunk.sampleData.push(e),i.currentChunk.sampleCount++,a?.decoderConfig?.description&&(i.codecPrivate=new Uint8Array(a.decoderConfig.description)),i.samples.push({timestamp:s,duration:o,size:e.byteLength,type:t}),i.lastTimescaleUnits!==null){let l=Zn(s,i.timescale,!1),u=Math.round(l-i.lastTimescaleUnits);i.lastTimescaleUnits+=u;let f=nn(i.timeToSampleTable);f.sampleCount===1?(f.sampleDelta=u,f.sampleCount++):f.sampleDelta===u?f.sampleCount++:(f.sampleCount--,i.timeToSampleTable.push({sampleCount:2,sampleDelta:u}))}else i.lastTimescaleUnits=0,i.timeToSampleTable.push({sampleCount:1,sampleDelta:Zn(o,i.timescale)})};mo=new WeakSet;pu=function(i,e){if(K(this,Pe).firstTimestampBehavior==="strict"&&e.lastTimestamp===-1&&i!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${i}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(K(this,Pe).firstTimestampBehavior==="offset"&&(i-=e.firstTimestamp),i<e.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${e.lastTimestamp*1e6} to ${i*1e6}).`);return i};qn=new WeakSet;Nr=function(i){if(i.currentChunk){if((i.compactlyCodedChunkTable.length===0||nn(i.compactlyCodedChunkTable).samplesPerChunk!==i.currentChunk.sampleCount)&&i.compactlyCodedChunkTable.push({firstChunk:i.finalizedChunks.length+1,samplesPerChunk:i.currentChunk.sampleCount}),i.finalizedChunks.push(i.currentChunk),K(this,Wn).push(i.currentChunk),K(this,Pe).fastStart==="in-memory"){i.currentChunk.offset=0;return}i.currentChunk.offset=K(this,Ge).pos;for(let e of i.currentChunk.sampleData)K(this,Ge).write(e);i.currentChunk.sampleData=null,it(this,Jn,ta).call(this)}};Jn=new WeakSet;ta=function(){K(this,Ge)instanceof au&&K(this,Ge).flush()};Lr=new WeakSet;Ws=function(){if(K(this,Gn))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};class sf{app;options;encoder;ac;muxer;recording=!1;renderInterval;cachedBarlines;_currentFrame=0;blob;totalFrames;constructor(e,t){this.options={aspectRatio:4/3,videoHeight:1080,fps:60,bitrate:4e7,playbackRate:1,assistTick:!1,metronome:!1,hideBarlines:!1,startTime:0,endTime:10,...t},this.app=e,this.muxer=new af({target:new nu,video:{codec:"avc",width:Math.round(this.options.videoHeight*this.options.aspectRatio/2)*2,height:this.options.videoHeight},audio:{codec:"opus",numberOfChannels:this.app.chartManager.chartAudio.getBuffer().numberOfChannels,sampleRate:this.app.chartManager.chartAudio.getSampleRate()},fastStart:"in-memory"}),this.totalFrames=Math.ceil((this.options.endTime-this.options.startTime)*this.options.fps),this.cachedBarlines=pe.barlines,this.encoder=new VideoEncoder({output:(n,r)=>void this.muxer.addVideoChunk(n,r),error:n=>{throw n}}),this.ac=new AudioEncoder({output:(n,r)=>void this.muxer.addAudioChunk(n,r),error:n=>{throw n}})}async renderBufferWithModifications(e,t){const n=new OfflineAudioContext(e.numberOfChannels,Math.ceil(e.duration*t.sampleRate/t.rate),t.sampleRate),r=n.createGain();r.gain.setValueAtTime(t.volume,0);const a=n.createBufferSource();a.buffer=e,a.playbackRate.setValueAtTime(t.rate,0),a.connect(r),r.connect(n.destination),a.start();const s=await n.startRendering();return a.stop(),s}async createAssistSounds(e,t,n,r){const a=new AudioBuffer({length:Math.ceil((t-e)*n/r),sampleRate:n,numberOfChannels:2}),s=this.app.chartManager.loadedChart,o=s.getBeatFromSeconds(e),l=s.getBeatFromSeconds(t),u=s.getNotedataInRange(o,l);if(this.options.assistTick){let f=this.app.chartManager.assistTick.getBuffer();f=await this.renderBufferWithModifications(f,{volume:b.audio.soundEffectVolume*b.audio.masterVolume,sampleRate:n,rate:1});let c=-1;for(const d of u)if(d.beat!=c&&(c=d.beat,s.gameType.gameLogic.shouldAssistTick(d))){const h=Math.floor((d.second-e)*n/r);for(let p=0;p<a.numberOfChannels;p++){const m=a.getChannelData(p);for(let g=0;g<f.length&&!(h+g>=m.length);g++)m[h+g]+=f.getChannelData(p%f.numberOfChannels)[g]}}}if(this.options.metronome){let f=this.app.chartManager.me_high.getBuffer();f=await this.renderBufferWithModifications(f,{volume:b.audio.soundEffectVolume*b.audio.masterVolume,sampleRate:n,rate:1});let c=this.app.chartManager.me_low.getBuffer();c=await this.renderBufferWithModifications(c,{volume:b.audio.soundEffectVolume*b.audio.masterVolume,sampleRate:n,rate:1});let d=null;for(const[h,p]of s.timingData.getMeasureBeats(o,l)){const m=s.timingData.getSecondsFromBeat(h);if(d!==null&&m==d)continue;d=m;const g=p?f:c,y=Math.floor((m-e)*n/r);for(let x=0;x<a.numberOfChannels;x++){const w=a.getChannelData(x);for(let _=0;_<g.length&&!(y+_>=w.length);_++)w[y+_]+=g.getChannelData(x%g.numberOfChannels)[_]}}}return a}async start(){console.time("capture");const e={codec:"avc1.420028",width:Math.round(this.options.videoHeight*this.options.aspectRatio/2)*2,height:this.options.videoHeight,bitrate:this.options.bitrate,hardwareAcceleration:"no-preference",framerate:this.options.fps},t={codec:"opus",numberOfChannels:this.app.chartManager.chartAudio.getBuffer().numberOfChannels,sampleRate:this.app.chartManager.chartAudio.getSampleRate(),bitrate:192e3};if(!(await VideoEncoder.isConfigSupported(e)).supported||!(await AudioEncoder.isConfigSupported(t)).supported)throw new Error("Exporting is not available on this browser!");this.encoder.configure(e),this.ac.configure(t);const n=this.app.chartManager.loadedChart;document.body.classList.remove("animated"),this.app.chartManager.setMode(U.View),pe.barlines=!this.options.hideBarlines,this.app.capturing=!0,this.app.chartManager.chartAudio.isPlaying()&&this.app.chartManager.playPause(),this.options.endTime===void 0&&(this.options.endTime=this.app.chartManager.loadedChart?.getLastSecond()??this.app.chartManager.chartAudio.getBuffer().length/this.app.chartManager.chartAudio.getBuffer().sampleRate),this._currentFrame=0,this.app.onResize(this.options.videoHeight*this.options.aspectRatio,this.options.videoHeight),this.app.view.style.width=window.innerWidth+"px",this.app.view.style.height=window.innerHeight+"px",xt.shared.stop();let r=this.app.chartManager.chartAudio.getBuffer();const a=Math.floor(this.options.startTime*r.sampleRate),s=Math.ceil(this.options.endTime*r.sampleRate),o=s-a,l=new AudioBuffer({length:o,sampleRate:r.sampleRate,numberOfChannels:r.numberOfChannels});for(let d=0;d<r.numberOfChannels;d++){const h=r.getChannelData(d);l.copyToChannel(h.subarray(Math.max(0,a),s),d,Math.max(0,-a))}r=await this.renderBufferWithModifications(l,{volume:b.audio.songVolume*b.audio.masterVolume,sampleRate:l.sampleRate,rate:this.options.playbackRate});let u=0;u=hi(n.getNotedata(),this.options.startTime,d=>d.second)+1,u>=1&&this.options.startTime<=n.getNotedata()[u-1].second&&u--;let f=[];const c=await this.createAssistSounds(this.options.startTime,this.options.endTime,r.sampleRate,this.options.playbackRate);return console.log(this.ac.state),new Promise((d,h)=>{this.recording=!0,this.renderInterval=setInterval(()=>{if(this.recording)try{if(this.encoder.encodeQueueSize<300){const p=this._currentFrame/this.options.fps*this.options.playbackRate+this.options.startTime;if(p>this.options.endTime){d(this.stop());return}this.app.chartManager.time=p;const m=n.getNotedata();for(;u<m.length&&p>m[u].second;){const T=m[u];n.gameType.gameLogic.shouldAssistTick(T)&&(this.app.chartManager.chartView.doJudgement(T,0,Js),Oe(T)&&(T.type=="Hold"?this.app.chartManager.chartView.getNotefield().activateHold(T.col):T.type=="Roll"&&this.app.chartManager.chartView.getNotefield().activateRoll(T.col),f.push(T))),u++}f=f.filter(T=>this.app.chartManager.beat<T.beat+T.hold?!0:(T.type=="Hold"&&this.app.chartManager.chartView.getNotefield().releaseHold(T.col),T.type=="Roll"&&this.app.chartManager.chartView.getNotefield().releaseRoll(T.col),this.app.chartManager.chartView.doJudgement(T,null,kt.getCollection(b.play.timingCollection).getHeldJudgement(T)),!1)),xt.shared.update(xt.shared.lastTime+1e3/this.options.fps),this.app.renderer.render(this.app.stage);const g=new VideoFrame(this.app.view,{timestamp:this._currentFrame/this.options.fps*1e6}),y=(p-this.options.startTime)/this.options.playbackRate,x=Math.floor(y*r.sampleRate),w=Math.ceil((y+1/this.options.fps)*r.sampleRate),_=w-x,C=new Float32Array(_*r.numberOfChannels);for(let T=0;T<r.numberOfChannels;T++){const R=r.getChannelData(T);if(C.set(R.subarray(x,w),T*_),this.options.metronome||this.options.assistTick){const N=c.getChannelData(T);for(let j=x;j<w&&!(j>=N.length);j++)C[T*_+j-x]+=N[j]}}const F=new AudioData({data:C,format:"f32-planar",numberOfChannels:r.numberOfChannels,numberOfFrames:_,sampleRate:r.sampleRate,timestamp:this._currentFrame/this.options.fps*1e6});this._currentFrame+=1,this.encoder.encode(g),this.ac.encode(F),F.close(),this.options.updateCallback?.({currentRenderFrame:this._currentFrame,currentEncodeQueue:this.encoder.encodeQueueSize,totalFrames:this.totalFrames,currentVideoFrame:g}).then(()=>{g.close()})}}catch(p){h(p),this.stop()}},10)})}async stop(){clearInterval(this.renderInterval),xt.shared.start(),this.app.chartManager.setMode(U.Edit),this.app.updateSize(),this.recording=!1,this.app.capturing=!1,pe.barlines=this.cachedBarlines;const e=setInterval(()=>{this.options.updateCallback?.({currentRenderFrame:this.totalFrames,currentEncodeQueue:this.encoder.encodeQueueSize,totalFrames:this.totalFrames,currentVideoFrame:null})},100);this.encoder.state=="configured"&&await this.encoder.flush(),this.ac.state=="configured"&&await this.ac.flush(),this.muxer.finalize(),clearInterval(e);const{buffer:t}=this.muxer.target,n=new Blob([t],{type:"video/mp4"});this.blob=n;const r=URL.createObjectURL(n);return b.general.smoothAnimations&&document.body.classList.add("animated"),console.timeEnd("capture"),this.options.onFinish?.(r),r}get currentRenderFrame(){return this._currentFrame}get currentEncodeQueue(){return this.encoder?.encodeQueueSize??0}get size(){return this.blob?this.blob.size:0}}const Bi={"dance-single":[{label:"Left",keys:["Left","A"]},{label:"Down",keys:["Down","S"]},{label:"Up",keys:["Up","W"]},{label:"Right",keys:["Right","D"]}],"dance-double":[{label:"P1 Left",keys:["Left"]},{label:"P1 Down",keys:["Down"]},{label:"P1 Up",keys:["Up"]},{label:"P1 Right",keys:["Right"]},{label:"P2 Left",keys:["A"]},{label:"P2 Down",keys:["S"]},{label:"P2 Up",keys:["W"]},{label:"P2 Right",keys:["D"]}],"dance-couple":[{label:"P1 Left",keys:["Left"]},{label:"P1 Down",keys:["Down"]},{label:"P1 Up",keys:["Up"]},{label:"P1 Right",keys:["Right"]},{label:"P2 Left",keys:["A"]},{label:"P2 Down",keys:["S"]},{label:"P2 Up",keys:["W"]},{label:"P2 Right",keys:["D"]}],"dance-solo":[{label:"Left",keys:["Left","A"]},{label:"UpLeft",keys:["Q"]},{label:"Down",keys:["Down","S"]},{label:"Up",keys:["Up","W"]},{label:"UpRight",keys:["E"]},{label:"Right",keys:["Right","D"]}],"dance-solodouble":[{label:"P1 Left",keys:["A"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Down",keys:["S"]},{label:"P1 Up",keys:["W"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 Right",keys:["D"]},{label:"P2 Left",keys:["J"]},{label:"P2 UpLeft",keys:["U"]},{label:"P2 Down",keys:["K"]},{label:"P2 Up",keys:["I"]},{label:"P2 UpRight",keys:["O"]},{label:"P2 Right",keys:["L"]}],"dance-threepanel":[{label:"UpLeft",keys:["Left","Q"]},{label:"Down",keys:["Down","S"]},{label:"UpRight",keys:["Right","E"]}],"dance-threedouble":[{label:"P1 UpLeft",keys:["Left"]},{label:"P1 Down",keys:["Down"]},{label:"P1 UpRight",keys:["Right"]},{label:"P2 UpLeft",keys:["Q"]},{label:"P2 Down",keys:["S"]},{label:"P2 UpRight",keys:["E"]}],"pump-single":[{label:"DownLeft",keys:["Z"]},{label:"UpLeft",keys:["Q"]},{label:"Center",keys:["S"]},{label:"UpRight",keys:["E"]},{label:"DownRight",keys:["C"]}],"pump-double":[{label:"P1 DownLeft",keys:["Z"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]},{label:"P2 UpRight",keys:["Y"]},{label:"P2 DownRight",keys:["N"]}],"pump-versus":[{label:"P1 DownLeft",keys:["Z"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]},{label:"P2 UpRight",keys:["Y"]},{label:"P2 DownRight",keys:["N"]}],"pump-couple":[{label:"P1 DownLeft",keys:["Z"]},{label:"P1 UpLeft",keys:["Q"]},{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]},{label:"P2 UpRight",keys:["Y"]},{label:"P2 DownRight",keys:["N"]}],"pump-halfdouble":[{label:"P1 Center",keys:["S"]},{label:"P1 UpRight",keys:["E"]},{label:"P1 DownRight",keys:["C"]},{label:"P2 DownLeft",keys:["V"]},{label:"P2 UpLeft",keys:["R"]},{label:"P2 Center",keys:["G"]}]};class Ae{static app;static userKeybinds=new Map;static userGameplayKeybinds=new Map;static enabled=!0;static load(e){this.app=e;try{this.loadKeybinds()}catch(t){console.error("Failed to load user keybinds!"),console.error(t.stack),this.userKeybinds.clear(),this.userGameplayKeybinds.clear()}window.addEventListener("keydown",t=>this.checkKey(t,"keydown")),window.addEventListener("keyup",t=>this.checkKey(t,"keyup"))}static checkKey(e,t){if(!this.enabled||e.target.classList.contains("inlineEdit")||e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLInputElement||e.target instanceof HTMLButtonElement||["Meta","Control","Shift","Alt"].includes(e.key))return;const n=[];for(let s=0;s<Gr.length;s++)e[Gr[s]]&&n.push(Br[s]);const r=Ae.getKeyNameFromEvent(e);if((this.app.chartManager.getMode()==U.Play||this.app.chartManager.getMode()==U.Record)&&this.app.chartManager.loadedChart?.gameType&&!e.repeat){const s=Bi[this.app.chartManager.loadedChart?.gameType.id]??[],o=this.userGameplayKeybinds.get(this.app.chartManager.loadedChart?.gameType.id)??[],l=Object.values(s).findIndex((u,f)=>(o[f]??u.keys).some(c=>r==c));if(l!=-1){if(e.preventDefault(),this.app.windowManager.getFocusedWindow()?.options?.win_id=="keybind_options"||this.app.windowManager.isBlocked())return;this.app.chartManager[t=="keydown"?"judgeCol":"judgeColUp"](l);return}}const a=Object.keys(Ne).filter(s=>!["cut","copy","paste","pasteReplace"].includes(s)).filter(s=>{for(const o of this.getCombosForKeybind(s))if(this.compareModifiers(o.mods,n)&&o.key==r)return!0;return!1}).map(s=>Ne[s]);if(a.length>0){if(a.every(s=>s.preventDefault!=!1)&&e.preventDefault(),this.app.windowManager.getFocusedWindow()?.options?.win_id=="keybind_options"||this.app.windowManager.isBlocked())return;for(const s of a){let o=s.disabled;if(o instanceof Function&&(o=o(this.app)),!o&&!(s.disableRepeat&&e.repeat)){t=="keydown"?s.callback(this.app):s.callbackKeyUp?.(this.app);return}}}}static getKeyNameFromEvent(e){if(e.which>=65&&e.which<=90)return String.fromCharCode(e.which).toUpperCase();let t=e.code;return t.startsWith("Digit")&&(t=t.slice(5)),t.startsWith("Key")&&(t=t.slice(3)),t in kc&&(t=kc[t]),t}static getKeybindString(e){return this.getCombosForKeybind(e).map(t=>this.getComboString(t)).join(" / ")}static getComboString(e){const t=Br.filter(n=>e.mods.includes(n)).map(n=>Mm[n]).join("");return t+(t!=""?" ":"")+(Ju[e.key]??e.key)}static getCombosForKeybind(e){return e in Ne?this.userKeybinds.get(e)??Ne[e].combos:(console.log("Couldn't find keybind with id "+e),[])}static getKeysForGameType(e){const t=wt.getGameType(e);return t?new Array(t.numCols).fill(null).map((n,r)=>this.userGameplayKeybinds.get(e)?.[r]??Bi[e]?.[r].keys??[]):(console.log("Couldn't find game type with id "+e),[])}static compareModifiers(e,t){if(e.length!=t.length)return!1;for(const n of Br)if((e.includes(n)?1:0)+(t.includes(n)?1:0)==1)return!1;return!0}static compareCombos(e,t){return e.key==t.key&&this.compareModifiers(e.mods,t.mods)}static loadKeybinds(){const e=localStorage.getItem("keybinds");if(e){const n=JSON.parse(e);if(typeof n!="object")return console.error("Couldn't load keybinds from storage");for(const[r,a]of Object.entries(n)){if(!(r in Ne)){console.warn("Couldn't load keybind "+r+": key doesn't exist");continue}Array.isArray(a)||console.warn("Couldn't load keybind "+r+": value is not an array"),this.userKeybinds.set(r,a.filter(s=>typeof s.key!="string"||!Array.isArray(s.mods)?(console.warn("Couldn't load keycombo for keybind "+r+": "+JSON.stringify(s)),!1):!0))}}const t=localStorage.getItem("keybindsGP");if(t){const n=JSON.parse(t);if(typeof n!="object")return console.error("Couldn't load gameplay keybinds from storage");for(const[r,a]of Object.entries(n)){if(!wt.getGameType(r)){console.warn("Couldn't load gameplay keybinds for gameType "+r+": gameType doesn't exist");continue}Array.isArray(a)||console.warn("Couldn't load gameplay keybind "+r+": value is not an array"),this.userGameplayKeybinds.set(r,a.map((s,o)=>!Array.isArray(s)&&s!==null?(console.warn("Couldn't load gameplay keys for type "+r+" col "+o+": "+JSON.stringify(s)),null):s))}}}static clearSave(){localStorage.removeItem("keybinds"),localStorage.removeItem("keybindsGP")}static setKeybind(e,t){this.userKeybinds.has(e)||this.userKeybinds.set(e,[...Ne[e].combos]),this.userKeybinds.get(e)?.push(t),this.checkIsDefault(e),this.saveKeybinds()}static removeKeybind(e,t){this.userKeybinds.has(e)||this.userKeybinds.set(e,[...Ne[e].combos]),this.userKeybinds.set(e,this.userKeybinds.get(e).filter(n=>!this.compareCombos(n,t))),this.checkIsDefault(e),this.saveKeybinds()}static revertKeybind(e){this.userKeybinds.delete(e),this.saveKeybinds()}static revertGameplayKeybind(e,t){this.userGameplayKeybinds.has(e)&&(this.userGameplayKeybinds.get(e)[t]=null,this.userGameplayKeybinds.get(e).every(n=>n===null)&&this.userGameplayKeybinds.delete(e)),this.saveKeybinds()}static setGameplayKeybind(e,t,n){this.userGameplayKeybinds.has(e)||this.userGameplayKeybinds.set(e,new Array(wt.getGameType(e).numCols).fill(null)),this.userGameplayKeybinds.get(e)[t]==null&&(this.userGameplayKeybinds.get(e)[t]=[...Bi[e]?.[t].keys??[]]),this.userGameplayKeybinds.get(e)[t].push(n),this.checkIsDefaultGameplay(e,t),this.saveKeybinds()}static removeGameplayKeybind(e,t,n){this.userGameplayKeybinds.has(e)||this.userGameplayKeybinds.set(e,new Array(wt.getGameType(e).numCols).fill(null)),this.userGameplayKeybinds.get(e)[t]==null&&(this.userGameplayKeybinds.get(e)[t]=[...Bi[e]?.[t].keys??[]]),this.userGameplayKeybinds.get(e)[t]=this.userGameplayKeybinds.get(e)[t].filter(r=>r!=n),this.checkIsDefaultGameplay(e,t),this.saveKeybinds()}static checkIsDefault(e){if(!this.userKeybinds.has(e))return!0;const t=this.userKeybinds.get(e),n=[...Ne[e].combos];return t.length!=n.length?!1:t.map(r=>this.getComboString(r)).sort().join("∆")==n.map(r=>this.getComboString(r)).sort().join("∆")?(this.userKeybinds.delete(e),!0):!1}static checkIsDefaultGameplay(e,t){if(!this.userGameplayKeybinds.has(e)||this.userGameplayKeybinds.get(e)[t]===null)return!0;const n=this.userGameplayKeybinds.get(e)[t],r=[...Bi[e]?.[t].keys??[]];return n.length!=r.length?!1:n.sort().join("∆")==r.sort().join("∆")?(this.userGameplayKeybinds.get(e)[t]=null,this.userGameplayKeybinds.get(e).every(a=>a===null)&&this.userGameplayKeybinds.delete(e),!0):!1}static saveKeybinds(){const e={};for(const[n,r]of this.userKeybinds.entries())e[n]=r;localStorage.setItem("keybinds",JSON.stringify(e));const t={};for(const[n,r]of this.userGameplayKeybinds.entries())t[n]=r;localStorage.setItem("keybindsGP",JSON.stringify(t))}static getKeybindTooltip(e){return this.getCombosForKeybind(e).map(n=>{let r=this.getComboString(n);return r==""?"":(r=r.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"),"<button class='pref-keybind-combo'>"+r+"</button>")}).join("")}static evaluateTaggedTooltip(e,t){t=t.map(r=>r.startsWith("\\")?r.slice(1):this.getKeybindTooltip(r));const n=[];for(let r=0;r<t.length;r++)n.push(e[r]),n.push(t[r]);return n.push(e[t.length]),"<div style='display: flex; align-items: center; gap: 0.375rem'>"+n.join("")+"</div>"}static createKeybindTooltip(e){return(t,...n)=>{Ze(e,{allowHTML:!0,onShow:r=>{r.setContent(this.evaluateTaggedTooltip(t,n))}})}}static disableKeybinds(){this.enabled=!1}static enableKeybinds(){this.enabled=!0}}class pt{view;input;options;lastVal="";constructor(e,t){this.view=e,this.view.classList.add("spinner"),this.options={value:0,precision:3,step:null,minPrecision:null,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,...t},this.view.onfocus=()=>{n.focus()};const n=document.createElement("input");n.classList.add("spinner-input"),n.type="text",n.autocomplete="off",n.spellcheck=!1,n.onblur=()=>{if(n.value===this.lastVal)return;if(n.value===""){this.options.onchange?.(void 0);return}const o=Yn(n.value);if(o===null){n.value=this.lastVal;return}const l=fe(Se(o,this.options.min,this.options.max),this.options.precision);n.value=this.formatValue(l),this.options.onchange?.(l)},n.onkeydown=o=>{o.key=="Enter"&&n.blur(),o.key=="Escape"&&(n.value=this.lastVal,n.blur())},n.onfocus=()=>{this.lastVal=n.value},this.input=n,this.value=this.options.value,e.appendChild(n);const r=document.createElement("div");r.classList.add("spinner-btns"),e.appendChild(r);const a=document.createElement("button");a.classList.add("spinner-up"),a.appendChild(be.getIcon("CHEVRON",10)),a.tabIndex=-1,a.onclick=o=>{let l=this.options.step??b.general.spinnerStep;if(o.getModifierState("Shift")&&(l/=10),parseFloat(n.value)+l>this.options.max){n.value=this.formatValue(this.options.max),this.options.onchange?.(this.options.max);return}n.value=this.formatValue(parseFloat(n.value)+l),this.options.onchange?.(parseFloat(n.value))},r.appendChild(a);const s=document.createElement("button");s.classList.add("spinner-down"),s.appendChild(be.getIcon("CHEVRON",10)),s.tabIndex=-1,s.onclick=o=>{let l=this.options.step??b.general.spinnerStep;if(o.getModifierState("Shift")&&(l/=10),parseFloat(n.value)-l<this.options.min){n.value=this.formatValue(this.options.min),this.options.onchange?.(this.options.min);return}n.value=this.formatValue(parseFloat(n.value)-l),this.options.onchange?.(parseFloat(n.value))},r.appendChild(s)}static create(e){return new pt(document.createElement("div"),e)}formatValue(e){const t=e.toString().split(".")[1]?.length??0;return this.options.minPrecision!==null&&this.options.minPrecision>=t?fe(e,this.options.minPrecision).toFixed(this.options.minPrecision):this.options.minPrecision!==null&&this.options.precision>=t?e.toString():fe(e,this.options.precision).toFixed(this.options.precision)}get value(){return parseFloat(this.input.value)}set value(e){parseFloat(this.input.value)!=fe(e,this.options.precision)&&(this.input.value=this.formatValue(e))}get step(){return this.options.step}set step(e){this.options.step=e}get min(){return this.options.min}set min(e){this.options.min=e}get max(){return this.options.max}set max(e){this.options.max=e}get precision(){return this.options.precision}set precision(e){this.options.precision=e}get minPrecision(){return this.options.minPrecision}set minPrecision(e){this.options.minPrecision=e}get onchange(){return this.options.onchange}set onchange(e){this.options.onchange=e}get disabled(){return this.input.disabled}set disabled(e){this.input.disabled=e}}const zl=["accent-color","editor-bg","widget-bg","editable-overlay-hover","editable-overlay-active","text-color","text-color-secondary","text-color-detail","text-color-disabled","primary-bg","primary-border","primary-bg-active","primary-bg-hover","secondary-bg","secondary-border","secondary-bg-active","secondary-bg-hover","tooltip-bg","input-bg","input-bg-active","input-bg-hover","input-border","navbar-bg","navbar-bg-inactive","window-bg","window-border"],of=["primary-bg","secondary-bg","text-color","accent-color","widget-bg","editor-bg","editable-overlay-active","input-bg","window-bg"],lf=[{name:"primary-bg",ids:[{id:"primary-bg",label:"base"},{id:"primary-bg-active",label:"active"},{id:"primary-bg-hover",label:"hover"},{id:"primary-border",label:"border"}]},{name:"secondary-bg",ids:[{id:"secondary-bg",label:"base"},{id:"secondary-bg-active",label:"active"},{id:"secondary-bg-hover",label:"hover"},{id:"secondary-border",label:"border"}]},{name:"text-color",ids:[{id:"text-color",label:"primary"},{id:"text-color-secondary",label:"secondary"},{id:"text-color-detail",label:"detail"},{id:"text-color-disabled",label:"disabled"}]},{name:"other",ids:[{id:"accent-color",label:"accent-color"},{id:"widget-bg",label:"widget-bg"},{id:"tooltip-bg",label:"tooltip-bg"},{id:"editor-bg",label:"editor-bg"}]},{name:"editable-overlay",ids:[{id:"editable-overlay-hover",label:"hover"},{id:"editable-overlay-active",label:"active"}]},{name:"input",ids:[{id:"input-bg",label:"background"},{id:"input-bg-active",label:"active"},{id:"input-bg-hover",label:"hover"},{id:"input-border",label:"border"}]},{name:"window",ids:[{id:"window-bg",label:"background"},{id:"window-border",label:"border"}]},{name:"window-navbar",ids:[{id:"navbar-bg",label:"active"},{id:"navbar-bg-inactive",label:"inactive"}]}],Vl={"accent-color":"Color used for focus input rings, confirm buttons","text-color":"Base text color","text-color-secondary":"Secondary text color, used for text in recent files, menubar keybinds","text-color-detail":"Detail text color, used for text in timing event boxes","text-color-disabled":"Used for texts relating to empty/disabled things (ex. no files in directory picker)","primary-bg":"Primary background, used for menubar, context/dropdown menus","primary-border":"","primary-bg-active":"","primary-bg-hover":"","navbar-bg":"Window navbar background","navbar-bg-inactive":"","window-bg":"Window background","window-border":"","secondary-bg":"Secondary background, used for subareas in menus","secondary-border":"","secondary-bg-active":"","secondary-bg-hover":"","editable-overlay-hover":"Overlay on top of editable items (status widget buttons, playback option toggles, textareas)","editable-overlay-active":"","input-bg":"Background color for input","input-bg-active":"","input-bg-hover":"","input-border":"","widget-bg":"Widget background","tooltip-bg":"Color of these tooltips","editor-bg":"Editor background"},as={"primary-bg":{"primary-border":function(i){return this.lighten(i,10).setAlpha(187/255)},"primary-bg-active":function(i){return this.lighten(i,10)},"primary-bg-hover":function(i){return this.lighten(i,30)},"widget-bg":function(i){return this.add(i,-50).setAlpha(136/255)},"window-bg":function(i){return this.lighten(i,-10)},"text-color":function(i){return this.average(i)>.5?new B("#000"):new B("#fff")},"input-bg":function(i){return this.average(i)<.5?new B("#000"):new B("#fff")},"input-border":function(i){return this.average(i)>.5?this.add(i,-30).setAlpha(119/255):this.add(i,30).setAlpha(119/255)},"tooltip-bg":function(i){return this.lighten(i,-10).setAlpha(238/255)},"secondary-bg":function(i){return this.lighten(i,-20)},"editor-bg":function(i){return this.lighten(i,-60)}},"window-bg":{"navbar-bg":function(i){return new B(i)}},"secondary-bg":{"secondary-border":function(i){return this.lighten(i,10).setAlpha(187/255)},"secondary-bg-active":function(i){return this.lighten(i,50)},"secondary-bg-hover":function(i){return this.lighten(i,30)}},"navbar-bg":{"navbar-bg-inactive":function(i){return this.lighten(i,-33)}},"text-color":{"text-color-secondary":function(i){return new B(i).setAlpha(119/255)},"text-color-detail":function(i){return new B(i).setAlpha(68/255)},"text-color-disabled":function(i){return new B(i).setAlpha(136/255)}},"input-bg":{"input-border":function(i){return this.lighten(i,10).setAlpha(187/255)},"input-bg-active":function(i){return this.lighten(i,50)},"input-bg-hover":function(i){return this.lighten(i,30)}}},Yi={default:{"accent-color":new B("rgb(23, 131, 208)"),"text-color":new B("#fff"),"text-color-secondary":new B("#888"),"text-color-detail":new B("#757a89"),"text-color-disabled":new B("#888"),"primary-bg":new B("#555"),"primary-border":new B("#444"),"primary-bg-active":new B("#575757"),"primary-bg-hover":new B("#666"),"navbar-bg":new B("#3d3d3d"),"navbar-bg-inactive":new B("#626262"),"window-bg":new B("#3d3d3d"),"window-border":new B("#00000000"),"secondary-bg":new B("#373737"),"secondary-border":new B("#333"),"secondary-bg-active":new B("#555"),"secondary-bg-hover":new B("#454545"),"editable-overlay-hover":new B("rgb(255, 255, 255, 0.1)"),"editable-overlay-active":new B("rgb(255, 255, 255, 0.2)"),"input-bg":new B("rgba(35, 35, 35, 0.309)"),"input-bg-active":new B("rgba(50, 50, 50, 0.309)"),"input-bg-hover":new B("rgba(79, 79, 79, 0.309)"),"input-border":new B("rgba(0, 0, 0, 0.3)"),"widget-bg":new B("rgba(0, 0, 0, 0.5)"),"tooltip-bg":new B("rgba(20, 20, 20, 0.95)"),"editor-bg":new B("#18191c")},dusk:{"accent-color":new B("#b34e97ff"),"text-color":new B("#ffffffff"),"text-color-secondary":new B("#ffffff77"),"text-color-detail":new B("#ffffff44"),"text-color-disabled":new B("#ffffff88"),"primary-bg":new B("#1b0131ff"),"primary-border":new B("#1e0136bb"),"primary-bg-active":new B("#2f0057ff"),"primary-bg-hover":new B("#230140ff"),"navbar-bg":new B("#18012cff"),"navbar-bg-inactive":new B("#10011dff"),"window-bg":new B("#18012cff"),"window-border":new B("#00000000"),"secondary-bg":new B("#160127ff"),"secondary-border":new B("#18012bbb"),"secondary-bg-active":new B("#310a52ff"),"secondary-bg-hover":new B("#25033fff"),"editable-overlay-hover":new B("#e79dff1a"),"editable-overlay-active":new B("#e79dff33"),"input-bg":new B("#000000ff"),"input-bg-active":new B("#000000ff"),"input-bg-hover":new B("#000000ff"),"input-border":new B("#391f4f77"),"widget-bg":new B("#00000088"),"tooltip-bg":new B("#18012cee"),"editor-bg":new B("#0b0014ff")},nord:{"accent-color":new B("#1783d0ff"),"text-color":new B("#d9dee8ff"),"text-color-secondary":new B("#d9dee878"),"text-color-detail":new B("#d9dee845"),"text-color-disabled":new B("#d9dee887"),"primary-bg":new B("#2e3440ff"),"primary-border":new B("#323946ba"),"primary-bg-active":new B("#636d83ff"),"primary-bg-hover":new B("#485061ff"),"navbar-bg":new B("#292e39ff"),"navbar-bg-inactive":new B("#2f333cff"),"window-bg":new B("#292e39ff"),"window-border":new B("#00000000"),"secondary-bg":new B("#242933ff"),"secondary-border":new B("#272d38ba"),"secondary-bg-active":new B("#444d5fff"),"secondary-bg-hover":new B("#3f4755ff"),"editable-overlay-hover":new B("#ffffff1a"),"editable-overlay-active":new B("#ffffff33"),"input-bg":new B("#1212124f"),"input-bg-active":new B("#141414ff"),"input-bg-hover":new B("#171717ff"),"input-border":new B("#121212ff"),"widget-bg":new B("#00020e87"),"tooltip-bg":new B("#292e39ed"),"editor-bg":new B("#18191cff")},light:{"accent-color":new B("#ff594cff"),"text-color":new B("#000000ff"),"text-color-secondary":new B("#00000078"),"text-color-detail":new B("#00000045"),"text-color-disabled":new B("#00000087"),"primary-bg":new B("#ffffffff"),"primary-border":new B("#b5b5b5ff"),"primary-bg-active":new B("#ebebebff"),"primary-bg-hover":new B("#ffd4d1ff"),"navbar-bg":new B("#edededff"),"navbar-bg-inactive":new B("#d1d1d1ff"),"window-bg":new B("#edededff"),"window-border":new B("#00000000"),"secondary-bg":new B("#d9d9d9ff"),"secondary-border":new B("#c7c7c7ff"),"secondary-bg-active":new B("#f0f0f0ff"),"secondary-bg-hover":new B("#e3e3e3ff"),"editable-overlay-hover":new B("#ff594c3d"),"editable-overlay-active":new B("#ff594c73"),"input-bg":new B("#ebebebff"),"input-bg-active":new B("#e0e0e0ff"),"input-bg-hover":new B("#ffffffff"),"input-border":new B("#9e9e9eff"),"widget-bg":new B("#f7f7f7e5"),"tooltip-bg":new B("#ffffffff"),"editor-bg":new B("#cfcfcfff")},rust:{"accent-color":new B("#b37100ff"),"text-color":new B("#ffd7bdf2"),"text-color-secondary":new B("#ffd7bd78"),"text-color-detail":new B("#ffd7bd45"),"text-color-disabled":new B("#ffd7bd87"),"primary-bg":new B("#3c2e2aff"),"primary-border":new B("#42332eff"),"primary-bg-active":new B("#68524bff"),"primary-bg-hover":new B("#4e3c37ff"),"navbar-bg":new B("#362926ff"),"navbar-bg-inactive":new B("#241b19ff"),"window-bg":new B("#58413cff"),"window-border":new B("#00000000"),"secondary-bg":new B("#40302ba1"),"secondary-border":new B("#46352fff"),"secondary-bg-active":new B("#614a42ff"),"secondary-bg-hover":new B("#533e38ff"),"editable-overlay-hover":new B("#fff8e01a"),"editable-overlay-active":new B("#fff8e033"),"input-bg":new B("#231515ff"),"input-bg-active":new B("#271717ff"),"input-bg-hover":new B("#2e1b1bff"),"input-border":new B("#4b413fff"),"widget-bg":new B("#311e1cdd"),"tooltip-bg":new B("#362926ff"),"editor-bg":new B("#181211ff")},tron:{"accent-color":new B("#00ccffff"),"text-color":new B("#ffffffff"),"text-color-secondary":new B("#ffffffe4"),"text-color-detail":new B("#ffffff5b"),"text-color-disabled":new B("#ffffff88"),"primary-bg":new B("#000000ff"),"primary-border":new B("#ff7b00c9"),"primary-bg-active":new B("#00e1ff98"),"primary-bg-hover":new B("#ff751a5a"),"navbar-bg":new B("#000000ff"),"navbar-bg-inactive":new B("#000000ff"),"window-bg":new B("#000000ff"),"window-border":new B("#ff880085"),"secondary-bg":new B("#121212ff"),"secondary-border":new B("#ff8800aa"),"secondary-bg-active":new B("#00e1ffa3"),"secondary-bg-hover":new B("#ff7e145a"),"editable-overlay-hover":new B("#ffffff1a"),"editable-overlay-active":new B("#ffffff33"),"input-bg":new B("#000000ff"),"input-bg-active":new B("#000000ff"),"input-bg-hover":new B("#000000ff"),"input-border":new B("#1e1e1eff"),"widget-bg":new B("#000000ad"),"tooltip-bg":new B("#000000ff"),"editor-bg":new B("#000000ff")},gilded:{"accent-color":new B("#ffc014ff"),"text-color":new B("#e6e6e6ff"),"text-color-secondary":new B("#ffffff6b"),"text-color-detail":new B("#e6e6e645"),"text-color-disabled":new B("#e6e6e687"),"primary-bg":new B("#232325ff"),"primary-border":new B("#272729ff"),"primary-bg-active":new B("#ffc0145b"),"primary-bg-hover":new B("#ffc01421"),"navbar-bg":new B("#202021ff"),"navbar-bg-inactive":new B("#151516ff"),"window-bg":new B("#202021ff"),"window-border":new B("#00000000"),"secondary-bg":new B("#1c1c1eff"),"secondary-border":new B("#1f1f21ff"),"secondary-bg-active":new B("#1f1f21ff"),"secondary-bg-hover":new B("#242427ff"),"editable-overlay-hover":new B("#ffffff1a"),"editable-overlay-active":new B("#ffffff33"),"input-bg":new B("#0d0d0dff"),"input-bg-active":new B("#0e0e0eff"),"input-bg-hover":new B("#111111ff"),"input-border":new B("#0e0e0eff"),"widget-bg":new B("#171717db"),"tooltip-bg":new B("#202021ff"),"editor-bg":new B("#0e0e0fff")}};class Fe{static _themes=Yi;static _userThemes={};static _initialized=!1;static style;static currentTheme;static initialize(){this._createThemeStyle(),this._loadUserThemes(),this._initialized=!0}static _createThemeStyle(){const e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e),this.style=e}static _loadUserThemes(){let e={};try{e=JSON.parse(localStorage.getItem("themes")??"{}")}catch{console.warn("Error loading user themes")}const t={};for(const[n,r]of Object.entries(e))t[n]=this.validateTheme(r);this._userThemes=t}static _saveUserThemes(){const e=Object.fromEntries(Object.entries(this._userThemes).map(([t,n])=>[t,this.convertThemeToString(n)]));localStorage.setItem("themes",JSON.stringify(e))}static validateTheme(e){const t={...Yi.default};if(typeof e!="object")return t;for(const n of zl)if(e[n]!==void 0)try{t[n]=new B(e[n])}catch{console.warn(`Invalid color ${e[n]} for ${n}`)}return t}static getThemes(){return{...this._themes,...this._userThemes}}static getBuiltinThemes(){return this._themes}static getUserThemes(){return this._userThemes}static loadTheme(e){this._initialized||this.initialize();let t=this.getThemes()[e];t||(ue.createFormatted("Error loading theme: Invalid theme id","error"),t=Yi.default),b.general.theme=e,this._applyTheme(t)}static _applyTheme(e){const t=`body{${zl.map(n=>`--${n}: ${(e[n]??Yi.default[n]).toHexa()};`).join("")}}`;this.style.innerHTML=t,this.currentTheme={...e},ee.emit("themeChanged")}static loadThemeFromColors(e){this._applyTheme(this.validateTheme(e))}static getCurrentTheme(){return this.currentTheme}static convertThemeToString(e){return Object.fromEntries(Object.entries(e).map(([t,n])=>[t,n.toHexa()]))}static exportCurrentTheme(e){return e={code:!1,spaces:!1,...e},e.code?JSON.stringify(Object.fromEntries(Object.entries(this.currentTheme).map(([t,n])=>[t,`^new Color('${n.toHexa()}')^`])),null,e.spaces?2:0).replaceAll('"^',"").replaceAll('^"',""):JSON.stringify(this.convertThemeToString(this.currentTheme),null,e.spaces?2:0)}static createUserTheme(e,t){this.getThemes()[e]===void 0&&(t?this._userThemes[e]={...t}:this._userThemes[e]={...Yi.default},this._saveUserThemes())}static setUserTheme(e,t){this._userThemes[e]!==void 0&&(this._userThemes[e]={...t},this._saveUserThemes())}static deleteUserTheme(e){this._userThemes[e]!==void 0&&(delete this._userThemes[e],this.loadTheme("default"),this._saveUserThemes())}static renameUserTheme(e,t){this._userThemes[e]!==void 0&&this.getThemes()[t]===void 0&&(this._userThemes[t]=this._userThemes[e],delete this._userThemes[e],this._saveUserThemes())}static parseThemeText(e){let t;try{t=JSON.parse(e)}catch{return null}return this.validateTheme(t)}static getColor(e){return this.currentTheme?.[e]??Yi.default[e]}static isDarkTheme(){const e=this.getColor("primary-bg");return(e.red+e.green+e.blue)/3<.5}}function go(i,e,t){return(i<<16)+(e<<8)+t}function bo(i,e){let t=i>>16,n=i>>8&255,r=i&255;return t=Se(Math.round(t*e),0,255),n=Se(Math.round(n*e),0,255),r=Se(Math.round(r*e),0,255),go(t,n,r)}function cf(i,e){let t=i>>16,n=i>>8&255,r=i&255;return t=Se(Math.round(t+e),0,255),n=Se(Math.round(n+e),0,255),r=Se(Math.round(r+e),0,255),go(t,n,r)}function Gs(i){return(i.red+i.green+i.blue)/3}function En(i,e,t){const[n,r,a]=i.match(/\w\w/g).map(d=>parseInt(d,16)),[s,o,l]=e.match(/\w\w/g).map(d=>parseInt(d,16)),u=Math.round(n+(s-n)*t).toString(16).padStart(2,"0"),f=Math.round(r+(o-r)*t).toString(16).padStart(2,"0"),c=Math.round(a+(l-a)*t).toString(16).padStart(2,"0");return"#"+u+f+c}function Rt(i,e,t){const n=Qe(i.red,e.red,t),r=Qe(i.green,e.green,t),a=Qe(i.blue,e.blue,t),s=Qe(i.alpha,e.alpha,t);return new B([n,r,a,s])}const jn=new Map;ee.on("themeChanged",()=>{for(const[i,e]of jn.entries()){const t=Fe.getColor(i);e.forEach(n=>{n.destroyed||(n.tint=t.toNumber(),n.alpha=t.alpha)}),jn.set(i,e.filter(n=>!n.destroyed))}});function Ue(i,e){jn.has(e)||jn.set(e,[]),jn.get(e).push(i);const t=Fe.getColor(e);i.tint=t.toNumber(),i.alpha=t.alpha}function ss(i){const{r:e,g:t,b:n,a:r}=i.toRgba(),a=Math.max(e,t,n),s=Math.min(e,t,n);let o=0,l=0;const u=(a+s)/2;if(a==s)o=l=0;else{const f=a-s;switch(l=u>.5?f/(2-a-s):f/(a+s),a){case e:o=(t-n)/f+(t<n?6:0);break;case t:o=(n-e)/f+2;break;case n:o=(e-t)/f+4;break}o/=6}return[o,l,u,r]}function pr(i){const{r:e,g:t,b:n,a:r}=i.toRgba(),a=Math.max(e,t,n),s=Math.min(e,t,n);let o=0,l=0;const u=a,f=a-s;if(l=a==0?0:f/a,a==s)o=0;else{switch(a){case e:o=(t-n)/f+(t<n?6:0);break;case t:o=(n-e)/f+2;break;case n:o=(e-t)/f+4;break}o/=6}return[o,l,u,r]}function er(i,e){try{return new B(i)}catch{return new B("black")}}function At(i){return i==ce.LEFT_HEEL?new B(b.chart.parity.leftHeelColor):i==ce.LEFT_TOE?new B(b.chart.parity.leftToeColor):i==ce.RIGHT_HEEL?new B(b.chart.parity.rightHeelColor):i==ce.RIGHT_TOE?new B(b.chart.parity.rightToeColor):new B("#00000000")}class mu extends HTMLDivElement{colorElement;set color(e){this.colorElement.style.background=e.toHexa()}}function os(){const i=document.createElement("div");i.classList.add("color-picker-transparent"),Object.setPrototypeOf(i,mu.prototype);const e=document.createElement("div");return e.style.width="100%",e.style.height="100%",i.colorElement=e,i.appendChild(e),i}class bn extends HTMLDivElement{inputs;opts;getValue;onupdate;static create(e){const t=document.createElement("div");Object.setPrototypeOf(t,bn.prototype),t.opts=e.inputs,t.inputs={},t.getValue=e.getValue.bind(t),t.onupdate=e.onupdate,t.classList.add("color-format");const n=document.createElement("div");n.classList.add("color-format-label"),n.innerText=e.label;const r=document.createElement("div");return r.classList.add("color-format-inputs"),Object.entries(e.inputs).forEach(([a,s])=>{const o=document.createElement("input");o.type="text";let l="";o.onfocus=()=>{l=o.value},o.onkeydown=u=>{u.key=="Enter"&&(o.blur(),u.preventDefault()),u.key=="Escape"&&(o.value=l,o.blur(),u.stopImmediatePropagation())},o.oninput=()=>{s.isValid(o.value)!==null&&t.onupdate?.(t.getValue())},o.onblur=()=>{const u=s.isValid(o.value);u===null?o.value=l:o.value=u,t.onupdate?.(t.getValue())},t.inputs[a]=o,r.appendChild(o)}),t.replaceChildren(n,r),t}setValue(e){Object.entries(this.inputs).forEach(([t,n])=>{document.activeElement!=n&&(n.value=this.opts[t].setValue(e))})}}const zt=(i,e,t)=>n=>{t!==void 0&&n.endsWith(t)&&(n=n.slice(0,n.length-t.length));let r;try{r=parseInt(n)}catch{return null}return Se(r,i,e)+""},Vt=(i,e,t,n)=>{let r;n!==void 0&&i.endsWith(n)&&(i=i.slice(0,i.length-n.length));try{r=parseInt(i)}catch{return e}return Se(r,e,t)};class ia extends mu{_value;_hue=0;_sat=0;_val=0;_alp=1;popup;matrix;matrixDot;matrixDragging=!1;hueDragging=!1;hueThumb;alphaDragging=!1;alphaBg;alphaThumb;previewNew;formats=[];onColorChange;static create(e){const t=os();return Object.setPrototypeOf(t,ia.prototype),t.value=er(e.value),t.classList.add("color-picker"),t.formats=[],e.height!==void 0&&(t.style.height=e.height/16+"rem"),e.width!==void 0&&(t.style.width=e.width/16+"rem"),t.addEventListener("click",()=>{t.createPopup()}),t}updatePreview(){this.color=this._value}get value(){return this._value}set value(e){this._value=e;const t=pr(this._value);this._hue=t[0],this._sat=t[1],this._val=t[2],this._alp=t[3],this.updatePreview(),this.updatePopup()}get hue(){return this._hue}set hue(e){this._hue=e,this.updateColor()}get sat(){return this._sat}set sat(e){this._sat=e,this.updateColor()}get val(){return this._val}set val(e){this._val=e,this.updateColor()}get alpha(){return this._alp}set alpha(e){this._alp=e,this.updateColor()}updateColor(){this._value=new B({h:this._hue*360,s:this._sat*100,v:this._val*100,a:this._alp}),this.updatePreview(),this.updatePopup()}createPopup(){if(this.popup){this.closePopup();return}const e=document.createElement("div");e.classList.add("color-picker-popup");const t=document.createElement("div");t.classList.add("color-picker-area");const[n,r]=this.createMatrix();this.matrix=n,this.matrixDot=r,r.style.background="#f00";const[a,s]=this.createSlider({ondrag:()=>this.hueDragging=!0,offdrag:()=>this.hueDragging=!1,change:C=>{this.hue=C,this.onColorChange?.(this._value)}});this.hueThumb=s,a.style.background="linear-gradient(to right, red 0%, #ff0 17%, lime 33%, cyan 50%, blue 66%, #f0f 83%, red 100%)";const[o,l]=this.createSlider({ondrag:()=>this.alphaDragging=!0,offdrag:()=>this.alphaDragging=!1,change:C=>{this.alpha=C,this.onColorChange?.(this._value)}});this.alphaThumb=l,o.classList.add("color-picker-transparent");const u=document.createElement("div");u.classList.add("color-slider"),o.appendChild(u),this.alphaBg=u,t.replaceChildren(n,a,o);const f=document.createElement("div");f.classList.add("color-picker-area");const c=bn.create({label:"HEX",inputs:{hex:{setValue:C=>C.alpha!=1?C.toHexa():C.toHex(),isValid:C=>{const F=/#?([0-9a-fA-F]+)/.exec(C);return F&&[3,4,6,8].includes(F[1].length)?(C[0]!="#"&&(C="#"+C),C):null}}},getValue(){let C=this.inputs.hex.value;return C[0]!="#"&&(C="#"+C),new B(C)},onupdate:C=>{this.value=C,this.onColorChange?.(this._value)}});this.formats.push(c),f.appendChild(c);const d=bn.create({label:"RGBA",inputs:{r:{setValue:C=>Math.round(C.red*255).toString(),isValid:zt(0,255)},g:{setValue:C=>Math.round(C.green*255).toString(),isValid:zt(0,255)},b:{setValue:C=>Math.round(C.blue*255).toString(),isValid:zt(0,255)},a:{setValue:C=>Math.round(C.alpha*100)+"%",isValid:zt(0,100,"%")}},getValue(){return new B({r:Vt(this.inputs.r.value,0,255),g:Vt(this.inputs.g.value,0,255),b:Vt(this.inputs.b.value,0,255),a:Vt(this.inputs.a.value,0,100,"%")/100})},onupdate:C=>{this.value=C,this.onColorChange?.(this._value)}});this.formats.push(d),f.appendChild(d);const h=bn.create({label:"HSVA",inputs:{h:{setValue:C=>Math.round(pr(C)[0]*360)+"º",isValid:zt(0,360,"º")},s:{setValue:C=>Math.round(pr(C)[1]*100)+"%",isValid:zt(0,100,"%")},v:{setValue:C=>Math.round(pr(C)[2]*100)+"%",isValid:zt(0,100,"%")},a:{setValue:C=>Math.round(C.alpha*100)+"%",isValid:zt(0,100,"%")}},getValue(){return new B({h:Vt(this.inputs.h.value,0,360,"º"),s:Vt(this.inputs.s.value,0,100,"%"),v:Vt(this.inputs.v.value,0,100,"%"),a:Vt(this.inputs.a.value,0,100,"%")/100})},onupdate:C=>{this.value=C,this.onColorChange?.(this._value)}});this.formats.push(h),f.appendChild(h);const p=bn.create({label:"HSLA",inputs:{h:{setValue:C=>Math.round(ss(C)[0]*360)+"º",isValid:zt(0,360,"º")},s:{setValue:C=>Math.round(ss(C)[1]*100)+"%",isValid:zt(0,100,"%")},l:{setValue:C=>Math.round(ss(C)[2]*100)+"%",isValid:zt(0,100,"%")},a:{setValue:C=>Math.round(C.alpha*100)+"%",isValid:zt(0,100,"%")}},getValue(){return new B({h:Vt(this.inputs.h.value,0,360,"º"),s:Vt(this.inputs.s.value,0,100,"%"),l:Vt(this.inputs.l.value,0,100,"%"),a:Vt(this.inputs.a.value,0,100,"%")/100})},onupdate:C=>{this.value=C,this.onColorChange?.(this._value)}});this.formats.push(p),f.appendChild(p);const m=document.createElement("div");m.classList.add("color-picker-preview");const g=os(),y=os();y.color=this._value,g.color=this._value,m.replaceChildren(g,y),this.previewNew=g,f.appendChild(m),e.replaceChildren(t,f),this.popup=e,this.updatePopup();const x=this._value,w=C=>{C.key=="Escape"&&(C.stopImmediatePropagation(),window.removeEventListener("keydown",w),window.removeEventListener("mousedown",_),this.closePopup(),this.value=x,this.onColorChange?.(this._value))},_=C=>{e.contains(C.target)||(window.removeEventListener("keydown",w),window.removeEventListener("mousedown",_),this.closePopup())};window.addEventListener("keydown",w),window.addEventListener("mousedown",_),document.getElementById("popups").appendChild(e),setTimeout(()=>this.movePosition())}updatePopup(){if(!this.popup)return;this.matrix.style.backgroundColor=`hsl(${this._hue*360} 100% 50%)`,this.matrixDot.style.backgroundColor=this._value.toHex(),this.matrixDragging||(this.matrixDot.style.left=this._sat*200/16+"rem",this.matrixDot.style.top=(1-this._val)*200/16+"rem"),this.hueDragging||(this.hueThumb.style.left=this._hue*200/16+"rem");const e=`rgba(${this._value.red*255}, ${this._value.green*255}, ${this._value.blue*255}`;this.alphaBg.style.background=`linear-gradient(to right, ${e}, 0 ), ${e}, 1))`,this.alphaDragging||(this.alphaThumb.style.left=this._alp*200/16+"rem"),this.formats.forEach(t=>t.setValue(this._value)),this.previewNew.color=this._value}closePopup(){const e=this.popup;this.popup=void 0,e&&(e.classList.add("exiting"),setTimeout(()=>{e.remove()},500))}createMatrix(){const e=document.createElement("div");e.classList.add("color-matrix"),e.style.backgroundColor="#ff0000";const t=document.createElement("div");t.classList.add("color-matrix-x");const n=document.createElement("div");n.classList.add("color-matrix-y");const r=document.createElement("div");r.classList.add("color-matrix-dot"),e.appendChild(r),e.replaceChildren(t,n,r),e.onmousedown=o=>{window.addEventListener("mousemove",a),window.addEventListener("mouseup",s),a(o),this.matrixDragging=!0};const a=o=>{const l=e.getBoundingClientRect(),u=Se((o.clientX-l.left)/l.width,0,1),f=Se((o.clientY-l.top)/l.height,0,1);r.style.left=u*l.width+"px",r.style.top=f*l.height+"px",this._sat=u,this.val=1-f,this.onColorChange?.(this._value)},s=()=>{window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",s),this.matrixDragging=!1};return[e,r]}createSlider(e){const t=document.createElement("div");t.classList.add("color-slider");const n=document.createElement("div");n.classList.add("color-slider-thumb"),t.appendChild(n),t.onmousedown=s=>{window.addEventListener("mousemove",r),window.addEventListener("mouseup",a),r(s),e.ondrag?.(),this.onColorChange?.(this._value)};const r=s=>{const o=t.getBoundingClientRect(),l=Se((s.clientX-o.left)/o.width,0,1);n.style.left=l*o.width+"px",e.change(l)},a=()=>{window.removeEventListener("mousemove",r),window.removeEventListener("mouseup",a),e.offdrag?.()};return[t,n]}movePosition(){const e=this.getBoundingClientRect(),t=e.left+e.width/2-this.popup.clientWidth/2,n=e.top+e.height+10,r=15,a=window.innerWidth-this.popup.clientWidth-15;this.popup.style.left=`${Se(t,r,a)}px`,this.popup.style.top=`${n}px`,n+this.popup.clientHeight>window.innerHeight-15&&(this.popup.style.transformOrigin="bottom center",this.popup.style.top=`${e.top-this.popup.clientHeight-10}px`)}isActive(){return this.popup!==void 0}}class Fi{view;slider;text;options;constructor(e,t){this.view=e,this.options=t,this.view.classList.add("slider");const n=document.createElement("input");n.classList.add("slider-input"),n.type="range",n.min=t.min.toString(),n.max=t.max.toString(),n.step=t.step.toString(),n.value=(t.value??(t.min+t.max)/2).toString(),n.oninput=()=>{r.innerText=this.formatValue(parseFloat(n.value))+"",this.options.onChange?.(parseFloat(n.value))},t.width!==void 0&&(n.style.width=t.width/16+"rem"),this.slider=n,e.appendChild(n);const r=document.createElement("div");r.innerText=this.formatValue(parseFloat(n.value))+"",r.style.width=`${(this.options.displayWidth??32)/16}rem`,this.text=r,e.appendChild(r)}get value(){return parseFloat(this.slider.value)}setValue(e){this.slider.value=e+"",this.text.innerText=this.formatValue(parseFloat(this.slider.value))+""}static create(e){return new Fi(document.createElement("div"),e)}formatValue(e){return this.options.transformer?this.options.transformer(e):this.options.precision===void 0?fe(e,3).toString():fe(e,this.options.precision).toFixed(this.options.precision)}}function gu(i,e,t){switch(e.type){case"checkbox":{const n=document.createElement("input"),r=e.onChange;return n.type="checkbox",n.checked=t,n.onblur=null,n.onchange=()=>{r?.(i,n.checked)},n.classList.add("pref-input","right"),n.onkeydown=a=>{a.key=="Enter"&&n.blur()},n}case"dropdown":if(e.advanced){const n=e.transformers.deserialize,r=e.transformers.serialize,a=e.onChange,s=gi.create(e.items,r(t));return s.onChange(o=>{a?.(i,n(o))}),s.view}else{const n=e.onChange,r=gi.create(e.items,t);return r.onChange(a=>{n?.(i,a)}),r.view}case"number":{const n=e.transformers?.deserialize??(o=>o),r=e.transformers?.serialize??(o=>o),a=e.onChange,s=pt.create({value:r(t),...e,onchange:o=>{if(!o){s.value=r(o);return}a?.(i,n(o))}});return s.view}case"slider":{const n=e.transformers?.deserialize??(c=>c),r=e.transformers?.serialize??(c=>c),a=e.onChange,s=document.createElement("div");s.style.display="flex",s.style.alignItems="center";const o=document.createElement("input");o.type="range",o.min=e.min?.toString()??"",o.max=e.max?.toString()??"",o.step=e.step?.toString()??"1",o.value=r(t).toString();const l=document.createElement("input");l.type="text",l.value=(Math.round(r(t)*1e3)/1e3).toString();const u=e.hardMin??e.min??-Number.MAX_VALUE,f=e.hardMax??e.max??Number.MAX_VALUE;return l.onblur=()=>{let c=Yn(l.value);if(c===null){l.value=(Math.round(r(t)*1e3)/1e3).toString();return}c=Se(c,u,f),l.value=fe(c,3).toString(),l.blur(),l.value==""&&(l.value=r(c).toString()),o.value=c.toString(),a?.(i,n(c))},o.oninput=()=>{const c=parseFloat(o.value);l.value=fe(c,3).toString(),a?.(i,n(c))},l.style.width="3rem",l.onkeydown=c=>{c.key=="Enter"&&l.blur()},s.appendChild(o),s.appendChild(l),s}case"display-slider":{const n=e.transformers?.deserialize??(l=>l),r=e.transformers?.serialize??(l=>l),a=e.transformers?.display??(l=>l),s=e.onChange;return Fi.create({...e,value:r(t),transformer:l=>a(l),onChange:l=>{s?.(i,n(l))}}).view}case"text":{const n=e.onChange,r=document.createElement("input");return r.type="text",r.value=t.toString(),r.onblur=()=>{n?.(i,r.value)},r.onkeydown=a=>{a.key=="Enter"&&r.blur()},r}case"color":{const n=e.onChange,r=ia.create({value:t});return r.onColorChange=a=>{n?.(i,a.toHexa())},r}}}class uf extends ht{app;captureOptions={aspectRatio:4/3,videoHeight:720,fps:60,bitrate:4e6,playbackRate:1,assistTick:!1,metronome:!1,hideBarlines:!1};startBeat=0;endBeat=1;presetDropdown;exportButton;optionsView;captureView;captureCanvas;videoContainer;progressLabel;progressBar;currentCapture;videoURL;stopButton;returnButton;downloadButton;estimateInterval;regionHandler;constructor(e){super({title:"Export Recording",width:600,height:400,disableClose:!1,win_id:"capture",blocking:!1}),this.app=e,this.app.chartManager.startRegion!==void 0&&this.app.chartManager.endRegion!==void 0?(this.startBeat=this.app.chartManager.startRegion,this.endBeat=this.app.chartManager.endRegion):(this.startBeat=0,this.endBeat=this.app.chartManager.loadedChart.getLastBeat()),this.initView()}onClose(){ee.off("regionChanged",this.regionHandler),this.currentCapture&&this.currentCapture.stop()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");if(e.classList.add("padding"),this.initOptionsView(),this.initCaptureView(),e.replaceChildren(this.optionsView,this.captureView),!VideoEncoder||!AudioEncoder){const t=document.createElement("div");t.classList.add("capture-error");const n=document.createElement("h3");n.innerText="Your browser doesn't seem to support web encoding.";const r=document.createElement("p");r.innerText="Please try a different browser or use the desktop app.",t.replaceChildren(n,r),this.optionsView.style.filter="blur(10px)",this.optionsView.style.pointerEvents="none",e.appendChild(t),this.exportButton.disabled=!0}this.viewElement.appendChild(e)}initOptionsView(){const e=document.createElement("div");e.classList.add("capture-options-container");const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="row",t.style.gap="2rem",t.style.alignItems="flex-start";const n=document.createElement("div");n.classList.add("capture-options");const r=document.createElement("div");r.classList.add("capture-options-label"),r.innerText="Record Range";const{item:a,update:s}=this.buildBeatSecondInput("Start",m=>{this.startBeat=m,this.startBeat>this.endBeat&&(this.startBeat=this.endBeat,s(this.startBeat)),this.updateSizeEstimate()}),{item:o,update:l}=this.buildBeatSecondInput("End",m=>{this.endBeat=m,this.endBeat<this.startBeat&&(this.endBeat=this.startBeat,l(this.endBeat)),this.updateSizeEstimate()});s(this.startBeat),l(this.endBeat);const u=(m,g)=>{this.startBeat=m,this.endBeat=g,s(m),l(g)};this.regionHandler=u.bind(this),ee.on("regionChanged",this.regionHandler),n.replaceChildren(r,a,o);let f=this.buildOptions("Video Options",Nl);const c=this.buildOptions("View Options",dh),d=document.createElement("div");d.classList.add("pref-item");const h=document.createElement("div");h.classList.add("pref-item-label","label"),h.innerText="Quality Preset",this.presetDropdown=gi.create(["Minimal","Low","Medium","High"],"Medium"),this.presetDropdown.onChange(m=>{const g=()=>{const y=this.buildOptions("Video Options",Nl);y.firstElementChild?.insertAdjacentElement("afterend",d),f.replaceWith(y),f=y,this.updateSizeEstimate()};switch(m){case"Minimal":this.captureOptions={...this.captureOptions,videoHeight:360,fps:24,bitrate:1e6},g();break;case"Low":this.captureOptions={...this.captureOptions,videoHeight:480,fps:30,bitrate:25e5},g();break;case"Medium":this.captureOptions={...this.captureOptions,videoHeight:720,fps:60,bitrate:4e6},g();break;case"High":this.captureOptions={...this.captureOptions,videoHeight:1080,fps:60,bitrate:8e6},g();break}}),f.firstElementChild?.insertAdjacentElement("afterend",d),d.replaceChildren(h,this.presetDropdown.view),t.replaceChildren(f,c);const p=document.createElement("button");p.innerText="Export Recording",p.classList.add("confirm"),p.onclick=async()=>{this.startCapture()},this.exportButton=p,e.replaceChildren(n,t,p),this.optionsView=e,this.updateSizeEstimate()}initCaptureView(){const e=document.createElement("div");e.classList.add("capture-view");const t=document.createElement("div");t.classList.add("capture-video-container");const n=document.createElement("canvas");n.width=560,n.height=320,n.style.width="35rem",n.style.height="20rem",n.style.filter="brightness(0.6) saturate(0.5)",t.appendChild(n);const r=document.createElement("div");r.classList.add("capture-video-overlay");const a=document.createElement("div");a.innerText="Rendering...",a.style.textAlign="center",this.progressLabel=a,r.appendChild(a);const s=document.createElement("div");s.classList.add("capture-progress-bar"),this.progressBar=s,r.appendChild(s),t.appendChild(r);const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="row",o.style.gap="1rem",o.style.justifyContent="center",o.style.marginTop="1rem";const l=document.createElement("button");l.innerText="Stop exporting",l.classList.add("delete"),l.style.flex="1",l.onclick=()=>{this.currentCapture&&(this.currentCapture.stop(),l.disabled=!0)},this.stopButton=l;const u=document.createElement("button");u.innerText="Export another video",u.style.flex="1",u.onclick=()=>{this.captureView.style.display="none",this.optionsView.style.display="",this.videoContainer.childNodes.forEach(c=>{c.style.display="",c instanceof HTMLVideoElement&&(URL.revokeObjectURL(c.src),c.pause(),c.remove())})},u.style.display="none",this.returnButton=u;const f=document.createElement("button");f.innerText="Download video",f.style.flex="1",f.classList.add("confirm"),f.onclick=()=>{if(this.videoURL){const c=document.createElement("a");c.href=this.videoURL;const d=new Date;c.download=`SME-${d.toISOString().slice(0,10)}-${d.toTimeString().slice(0,8).replaceAll(":","-")}.mp4`,c.click()}},f.style.display="none",this.downloadButton=f,o.replaceChildren(l,u,f),e.replaceChildren(t,o),this.captureCanvas=n,this.videoContainer=t,this.captureView=e,e.style.display="none"}startCapture(){Ae.disableKeybinds(),this.stopButton.disabled=!1,this.stopButton.style.display="",this.returnButton.style.display="none",this.downloadButton.style.display="none",this.setDisableClose(!0),this.setBlocking(!0);const e=this.captureCanvas.getContext("2d"),t=[];let n=-1,r=0;this.estimateInterval=setInterval(()=>{if(!this.currentCapture)return;const a=this.currentCapture.currentRenderFrame-this.currentCapture.currentEncodeQueue;t.push(a-r),r=a,t.length>20&&t.shift();const o=t.reduce((u,f)=>u+f,0)/t.length,l=this.currentCapture.totalFrames-a;n=Math.round(l/o)},1e3),this.captureView.style.display="",this.optionsView.style.display="none";try{const a=new sf(this.app,{...this.captureOptions,startTime:this.app.chartManager.loadedChart.getSecondsFromBeat(this.startBeat)-1,endTime:this.app.chartManager.loadedChart.getSecondsFromBeat(this.endBeat)+1,updateCallback:async s=>{const o=(s.currentRenderFrame-s.currentEncodeQueue)/s.totalFrames;this.progressBar.style.background=`linear-gradient(90deg, var(--accent-color) 0 ${o*100}%, var(--input-bg) ${o*100}% 100%)`;const l=s.currentRenderFrame==s.totalFrames?"Encoding":"Rendering";if(this.progressLabel.innerText=`${l}...`,n>=0&&l==="Rendering"&&(this.progressLabel.innerText+=` (est. ${hd(n)})`),!e||!s.currentVideoFrame)return;e.clearRect(0,0,this.captureCanvas.width,this.captureCanvas.height);const u=await createImageBitmap(s.currentVideoFrame),f=u.height/this.captureCanvas.height,c=u.width/f,d=(this.captureCanvas.width-c)/2;e.drawImage(u,0,0,u.width,u.height,d,0,c,this.captureCanvas.height)},onFinish:s=>{this.stopCapture(s)}});this.currentCapture=a,a.start().catch(s=>{console.error("Error starting capture:",s),this.stopCapture("")})}catch(a){console.error("Error starting capture:",a),this.stopCapture("")}}stopCapture(e){if(!this.currentCapture||(this.setDisableClose(!1),this.setBlocking(!1),Ae.enableKeybinds(),this.videoURL=e,this.stopButton.style.display="none",this.returnButton.style.display="",e!=""?(this.downloadButton.style.display="",this.downloadButton.innerText=`Download video (${Po(this.currentCapture.size)})`):this.progressLabel.innerText="Failed to export video! Check console for details.",clearInterval(this.estimateInterval),this.currentCapture=void 0,this.closed||e==""))return;const t=document.createElement("video");t.src=e,t.controls=!0,t.style.height="20rem",this.videoContainer.childNodes.forEach(n=>{n.style.display="none"}),this.videoContainer.appendChild(t)}buildBeatSecondInput(e,t){const n=document.createElement("div");n.classList.add("pref-item");const r=document.createElement("div");r.classList.add("pref-item-label","label"),r.innerText=e,n.appendChild(r);const a=document.createElement("div"),s=document.createElement("div");s.appendChild(document.createTextNode("Beat: "));const o=document.createElement("div");o.appendChild(document.createTextNode("Second: ")),s.style.display="flex",o.style.display="flex",s.style.gap="0.85rem",o.style.gap="0.85rem",s.style.flexDirection="row",o.style.flexDirection="row",a.style.display="flex",a.style.flexDirection="row",a.style.gap="1.5rem";const l=c=>{const d=this.app.chartManager.loadedChart.getSecondsFromBeat(c);f.value=d,u.value=c},u=pt.create({value:0,onchange:c=>{c!==void 0&&(l(c),t(c))}}),f=pt.create({value:0,onchange:c=>{c!==void 0&&(l(this.app.chartManager.loadedChart.getBeatFromSeconds(c)),t(this.app.chartManager.loadedChart.getBeatFromSeconds(c)))}});return a.replaceChildren(s,o),s.appendChild(u.view),o.appendChild(f.view),n.appendChild(a),{item:n,update:l}}updateSizeEstimate(){const e=this.captureOptions.bitrate,t=this.app.chartManager.loadedChart.getSecondsFromBeat(this.endBeat)-this.app.chartManager.loadedChart.getSecondsFromBeat(this.startBeat)+2,n=Math.round(e*t/8);this.exportButton.innerText=`Export Recording (Est. ${Po(n)})`}buildOptions(e,t){const n=document.createElement("div");n.classList.add("capture-options");const r=document.createElement("div");return r.classList.add("capture-options-label"),r.innerText=e,n.appendChild(r),Object.entries(t).forEach(([a,s])=>{const o=document.createElement("div");o.classList.add("pref-item");const l=document.createElement("div");l.classList.add("pref-item-label","label"),l.innerText=s.label,o.appendChild(l);const u=gu(this.app,{...s.input,onChange:(f,c)=>{Object.assign(this.captureOptions,{[a]:c}),["videoHeight","fps","bitrate"].includes(a)&&this.presetDropdown.setSelected("Custom"),this.updateSizeEstimate()}},this.captureOptions[a]);o.appendChild(u),n.appendChild(o)}),n}}const Ul={};function df(i){let e=Ul[i];if(e)return e;e=Ul[i]=[];for(let t=0;t<128;t++){const n=String.fromCharCode(t);e.push(n)}for(let t=0;t<i.length;t++){const n=i.charCodeAt(t);e[n]="%"+("0"+n.toString(16).toUpperCase()).slice(-2)}return e}function Cn(i,e){typeof e!="string"&&(e=Cn.defaultChars);const t=df(e);return i.replace(/(%[a-f0-9]{2})+/gi,function(n){let r="";for(let a=0,s=n.length;a<s;a+=3){const o=parseInt(n.slice(a+1,a+3),16);if(o<128){r+=t[o];continue}if((o&224)===192&&a+3<s){const l=parseInt(n.slice(a+4,a+6),16);if((l&192)===128){const u=o<<6&1984|l&63;u<128?r+="��":r+=String.fromCharCode(u),a+=3;continue}}if((o&240)===224&&a+6<s){const l=parseInt(n.slice(a+4,a+6),16),u=parseInt(n.slice(a+7,a+9),16);if((l&192)===128&&(u&192)===128){const f=o<<12&61440|l<<6&4032|u&63;f<2048||f>=55296&&f<=57343?r+="���":r+=String.fromCharCode(f),a+=6;continue}}if((o&248)===240&&a+9<s){const l=parseInt(n.slice(a+4,a+6),16),u=parseInt(n.slice(a+7,a+9),16),f=parseInt(n.slice(a+10,a+12),16);if((l&192)===128&&(u&192)===128&&(f&192)===128){let c=o<<18&1835008|l<<12&258048|u<<6&4032|f&63;c<65536||c>1114111?r+="����":(c-=65536,r+=String.fromCharCode(55296+(c>>10),56320+(c&1023))),a+=9;continue}}r+="�"}return r})}Cn.defaultChars=";/?:@&=+$,#";Cn.componentChars="";const Wl={};function hf(i){let e=Wl[i];if(e)return e;e=Wl[i]=[];for(let t=0;t<128;t++){const n=String.fromCharCode(t);/^[0-9a-z]$/i.test(n)?e.push(n):e.push("%"+("0"+t.toString(16).toUpperCase()).slice(-2))}for(let t=0;t<i.length;t++)e[i.charCodeAt(t)]=i[t];return e}function cr(i,e,t){typeof e!="string"&&(t=e,e=cr.defaultChars),typeof t>"u"&&(t=!0);const n=hf(e);let r="";for(let a=0,s=i.length;a<s;a++){const o=i.charCodeAt(a);if(t&&o===37&&a+2<s&&/^[0-9a-f]{2}$/i.test(i.slice(a+1,a+3))){r+=i.slice(a,a+3),a+=2;continue}if(o<128){r+=n[o];continue}if(o>=55296&&o<=57343){if(o>=55296&&o<=56319&&a+1<s){const l=i.charCodeAt(a+1);if(l>=56320&&l<=57343){r+=encodeURIComponent(i[a]+i[a+1]),a++;continue}}r+="%EF%BF%BD";continue}r+=encodeURIComponent(i[a])}return r}cr.defaultChars=";/?:@&=+$,-_.!~*'()#";cr.componentChars="-_.!~*'()";function yo(i){let e="";return e+=i.protocol||"",e+=i.slashes?"//":"",e+=i.auth?i.auth+"@":"",i.hostname&&i.hostname.indexOf(":")!==-1?e+="["+i.hostname+"]":e+=i.hostname||"",e+=i.port?":"+i.port:"",e+=i.pathname||"",e+=i.search||"",e+=i.hash||"",e}function Hr(){this.protocol=null,this.slashes=null,this.auth=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.pathname=null}const ff=/^([a-z0-9.+-]+:)/i,pf=/:[0-9]*$/,mf=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,gf=["<",">",'"',"`"," ","\r",`
`,"	"],bf=["{","}","|","\\","^","`"].concat(gf),yf=["'"].concat(bf),Gl=["%","/","?",";","#"].concat(yf),ql=["/","?","#"],wf=255,jl=/^[+a-z0-9A-Z_-]{0,63}$/,vf=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,$l={javascript:!0,"javascript:":!0},Yl={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function wo(i,e){if(i&&i instanceof Hr)return i;const t=new Hr;return t.parse(i,e),t}Hr.prototype.parse=function(i,e){let t,n,r,a=i;if(a=a.trim(),!e&&i.split("#").length===1){const u=mf.exec(a);if(u)return this.pathname=u[1],u[2]&&(this.search=u[2]),this}let s=ff.exec(a);if(s&&(s=s[0],t=s.toLowerCase(),this.protocol=s,a=a.substr(s.length)),(e||s||a.match(/^\/\/[^@\/]+@[^@\/]+/))&&(r=a.substr(0,2)==="//",r&&!(s&&$l[s])&&(a=a.substr(2),this.slashes=!0)),!$l[s]&&(r||s&&!Yl[s])){let u=-1;for(let p=0;p<ql.length;p++)n=a.indexOf(ql[p]),n!==-1&&(u===-1||n<u)&&(u=n);let f,c;u===-1?c=a.lastIndexOf("@"):c=a.lastIndexOf("@",u),c!==-1&&(f=a.slice(0,c),a=a.slice(c+1),this.auth=f),u=-1;for(let p=0;p<Gl.length;p++)n=a.indexOf(Gl[p]),n!==-1&&(u===-1||n<u)&&(u=n);u===-1&&(u=a.length),a[u-1]===":"&&u--;const d=a.slice(0,u);a=a.slice(u),this.parseHost(d),this.hostname=this.hostname||"";const h=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!h){const p=this.hostname.split(/\./);for(let m=0,g=p.length;m<g;m++){const y=p[m];if(y&&!y.match(jl)){let x="";for(let w=0,_=y.length;w<_;w++)y.charCodeAt(w)>127?x+="x":x+=y[w];if(!x.match(jl)){const w=p.slice(0,m),_=p.slice(m+1),C=y.match(vf);C&&(w.push(C[1]),_.unshift(C[2])),_.length&&(a=_.join(".")+a),this.hostname=w.join(".");break}}}}this.hostname.length>wf&&(this.hostname=""),h&&(this.hostname=this.hostname.substr(1,this.hostname.length-2))}const o=a.indexOf("#");o!==-1&&(this.hash=a.substr(o),a=a.slice(0,o));const l=a.indexOf("?");return l!==-1&&(this.search=a.substr(l),a=a.slice(0,l)),a&&(this.pathname=a),Yl[t]&&this.hostname&&!this.pathname&&(this.pathname=""),this};Hr.prototype.parseHost=function(i){let e=pf.exec(i);e&&(e=e[0],e!==":"&&(this.port=e.substr(1)),i=i.substr(0,i.length-e.length)),i&&(this.hostname=i)};const xf=Object.freeze(Object.defineProperty({__proto__:null,decode:Cn,encode:cr,format:yo,parse:wo},Symbol.toStringTag,{value:"Module"})),bu=/[\0-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,yu=/[\0-\x1F\x7F-\x9F]/,Ef=/[\xAD\u0600-\u0605\u061C\u06DD\u070F\u0890\u0891\u08E2\u180E\u200B-\u200F\u202A-\u202E\u2060-\u2064\u2066-\u206F\uFEFF\uFFF9-\uFFFB]|\uD804[\uDCBD\uDCCD]|\uD80D[\uDC30-\uDC3F]|\uD82F[\uDCA0-\uDCA3]|\uD834[\uDD73-\uDD7A]|\uDB40[\uDC01\uDC20-\uDC7F]/,vo=/[!-#%-\*,-\/:;\?@\[-\]_\{\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061D-\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1B7D\u1B7E\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52-\u2E5D\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59\uDF86-\uDF89]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDEB9\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2\uDF00-\uDF09]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDF43-\uDF4F\uDFFF]|\uD809[\uDC70-\uDC74]|\uD80B[\uDFF1\uDFF2]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]/,wu=/[\$\+<->\^`\|~\xA2-\xA6\xA8\xA9\xAC\xAE-\xB1\xB4\xB8\xD7\xF7\u02C2-\u02C5\u02D2-\u02DF\u02E5-\u02EB\u02ED\u02EF-\u02FF\u0375\u0384\u0385\u03F6\u0482\u058D-\u058F\u0606-\u0608\u060B\u060E\u060F\u06DE\u06E9\u06FD\u06FE\u07F6\u07FE\u07FF\u0888\u09F2\u09F3\u09FA\u09FB\u0AF1\u0B70\u0BF3-\u0BFA\u0C7F\u0D4F\u0D79\u0E3F\u0F01-\u0F03\u0F13\u0F15-\u0F17\u0F1A-\u0F1F\u0F34\u0F36\u0F38\u0FBE-\u0FC5\u0FC7-\u0FCC\u0FCE\u0FCF\u0FD5-\u0FD8\u109E\u109F\u1390-\u1399\u166D\u17DB\u1940\u19DE-\u19FF\u1B61-\u1B6A\u1B74-\u1B7C\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u2044\u2052\u207A-\u207C\u208A-\u208C\u20A0-\u20C0\u2100\u2101\u2103-\u2106\u2108\u2109\u2114\u2116-\u2118\u211E-\u2123\u2125\u2127\u2129\u212E\u213A\u213B\u2140-\u2144\u214A-\u214D\u214F\u218A\u218B\u2190-\u2307\u230C-\u2328\u232B-\u2426\u2440-\u244A\u249C-\u24E9\u2500-\u2767\u2794-\u27C4\u27C7-\u27E5\u27F0-\u2982\u2999-\u29D7\u29DC-\u29FB\u29FE-\u2B73\u2B76-\u2B95\u2B97-\u2BFF\u2CE5-\u2CEA\u2E50\u2E51\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFF\u3004\u3012\u3013\u3020\u3036\u3037\u303E\u303F\u309B\u309C\u3190\u3191\u3196-\u319F\u31C0-\u31E3\u31EF\u3200-\u321E\u322A-\u3247\u3250\u3260-\u327F\u328A-\u32B0\u32C0-\u33FF\u4DC0-\u4DFF\uA490-\uA4C6\uA700-\uA716\uA720\uA721\uA789\uA78A\uA828-\uA82B\uA836-\uA839\uAA77-\uAA79\uAB5B\uAB6A\uAB6B\uFB29\uFBB2-\uFBC2\uFD40-\uFD4F\uFDCF\uFDFC-\uFDFF\uFE62\uFE64-\uFE66\uFE69\uFF04\uFF0B\uFF1C-\uFF1E\uFF3E\uFF40\uFF5C\uFF5E\uFFE0-\uFFE6\uFFE8-\uFFEE\uFFFC\uFFFD]|\uD800[\uDD37-\uDD3F\uDD79-\uDD89\uDD8C-\uDD8E\uDD90-\uDD9C\uDDA0\uDDD0-\uDDFC]|\uD802[\uDC77\uDC78\uDEC8]|\uD805\uDF3F|\uD807[\uDFD5-\uDFF1]|\uD81A[\uDF3C-\uDF3F\uDF45]|\uD82F\uDC9C|\uD833[\uDF50-\uDFC3]|\uD834[\uDC00-\uDCF5\uDD00-\uDD26\uDD29-\uDD64\uDD6A-\uDD6C\uDD83\uDD84\uDD8C-\uDDA9\uDDAE-\uDDEA\uDE00-\uDE41\uDE45\uDF00-\uDF56]|\uD835[\uDEC1\uDEDB\uDEFB\uDF15\uDF35\uDF4F\uDF6F\uDF89\uDFA9\uDFC3]|\uD836[\uDC00-\uDDFF\uDE37-\uDE3A\uDE6D-\uDE74\uDE76-\uDE83\uDE85\uDE86]|\uD838[\uDD4F\uDEFF]|\uD83B[\uDCAC\uDCB0\uDD2E\uDEF0\uDEF1]|\uD83C[\uDC00-\uDC2B\uDC30-\uDC93\uDCA0-\uDCAE\uDCB1-\uDCBF\uDCC1-\uDCCF\uDCD1-\uDCF5\uDD0D-\uDDAD\uDDE6-\uDE02\uDE10-\uDE3B\uDE40-\uDE48\uDE50\uDE51\uDE60-\uDE65\uDF00-\uDFFF]|\uD83D[\uDC00-\uDED7\uDEDC-\uDEEC\uDEF0-\uDEFC\uDF00-\uDF76\uDF7B-\uDFD9\uDFE0-\uDFEB\uDFF0]|\uD83E[\uDC00-\uDC0B\uDC10-\uDC47\uDC50-\uDC59\uDC60-\uDC87\uDC90-\uDCAD\uDCB0\uDCB1\uDD00-\uDE53\uDE60-\uDE6D\uDE70-\uDE7C\uDE80-\uDE88\uDE90-\uDEBD\uDEBF-\uDEC5\uDECE-\uDEDB\uDEE0-\uDEE8\uDEF0-\uDEF8\uDF00-\uDF92\uDF94-\uDFCA]/,vu=/[ \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000]/,Cf=Object.freeze(Object.defineProperty({__proto__:null,Any:bu,Cc:yu,Cf:Ef,P:vo,S:wu,Z:vu},Symbol.toStringTag,{value:"Module"})),_f=new Uint16Array('ᵁ<Õıʊҝջאٵ۞ޢߖࠏ੊ઑඡ๭༉༦჊ረዡᐕᒝᓃᓟᔥ\0\0\0\0\0\0ᕫᛍᦍᰒᷝ὾⁠↰⊍⏀⏻⑂⠤⤒ⴈ⹈⿎〖㊺㘹㞬㣾㨨㩱㫠㬮ࠀEMabcfglmnoprstu\\bfms¦³¹ÈÏlig耻Æ䃆P耻&䀦cute耻Á䃁reve;䄂Āiyx}rc耻Â䃂;䐐r;쀀𝔄rave耻À䃀pha;䎑acr;䄀d;橓Āgp¡on;䄄f;쀀𝔸plyFunction;恡ing耻Å䃅Ācs¾Ãr;쀀𝒜ign;扔ilde耻Ã䃃ml耻Ä䃄ЀaceforsuåûþėĜĢħĪĀcrêòkslash;或Ŷöø;櫧ed;挆y;䐑ƀcrtąċĔause;戵noullis;愬a;䎒r;쀀𝔅pf;쀀𝔹eve;䋘còēmpeq;扎܀HOacdefhilorsuōőŖƀƞƢƵƷƺǜȕɳɸɾcy;䐧PY耻©䂩ƀcpyŝŢźute;䄆Ā;iŧŨ拒talDifferentialD;慅leys;愭ȀaeioƉƎƔƘron;䄌dil耻Ç䃇rc;䄈nint;戰ot;䄊ĀdnƧƭilla;䂸terDot;䂷òſi;䎧rcleȀDMPTǇǋǑǖot;抙inus;抖lus;投imes;抗oĀcsǢǸkwiseContourIntegral;戲eCurlyĀDQȃȏoubleQuote;思uote;怙ȀlnpuȞȨɇɕonĀ;eȥȦ户;橴ƀgitȯȶȺruent;扡nt;戯ourIntegral;戮ĀfrɌɎ;愂oduct;成nterClockwiseContourIntegral;戳oss;樯cr;쀀𝒞pĀ;Cʄʅ拓ap;才րDJSZacefiosʠʬʰʴʸˋ˗ˡ˦̳ҍĀ;oŹʥtrahd;椑cy;䐂cy;䐅cy;䐏ƀgrsʿ˄ˇger;怡r;憡hv;櫤Āayː˕ron;䄎;䐔lĀ;t˝˞戇a;䎔r;쀀𝔇Āaf˫̧Ācm˰̢riticalȀADGT̖̜̀̆cute;䂴oŴ̋̍;䋙bleAcute;䋝rave;䁠ilde;䋜ond;拄ferentialD;慆Ѱ̽\0\0\0͔͂\0Ѕf;쀀𝔻ƀ;DE͈͉͍䂨ot;惜qual;扐blèCDLRUVͣͲ΂ϏϢϸontourIntegraìȹoɴ͹\0\0ͻ»͉nArrow;懓Āeo·ΤftƀARTΐΖΡrrow;懐ightArrow;懔eåˊngĀLRΫτeftĀARγιrrow;柸ightArrow;柺ightArrow;柹ightĀATϘϞrrow;懒ee;抨pɁϩ\0\0ϯrrow;懑ownArrow;懕erticalBar;戥ǹABLRTaВЪаўѿͼrrowƀ;BUНОТ憓ar;椓pArrow;懵reve;䌑eft˒к\0ц\0ѐightVector;楐eeVector;楞ectorĀ;Bљњ憽ar;楖ightǔѧ\0ѱeeVector;楟ectorĀ;BѺѻ懁ar;楗eeĀ;A҆҇护rrow;憧ĀctҒҗr;쀀𝒟rok;䄐ࠀNTacdfglmopqstuxҽӀӄӋӞӢӧӮӵԡԯԶՒ՝ՠեG;䅊H耻Ð䃐cute耻É䃉ƀaiyӒӗӜron;䄚rc耻Ê䃊;䐭ot;䄖r;쀀𝔈rave耻È䃈ement;戈ĀapӺӾcr;䄒tyɓԆ\0\0ԒmallSquare;旻erySmallSquare;斫ĀgpԦԪon;䄘f;쀀𝔼silon;䎕uĀaiԼՉlĀ;TՂՃ橵ilde;扂librium;懌Āci՗՚r;愰m;橳a;䎗ml耻Ë䃋Āipժկsts;戃onentialE;慇ʀcfiosօֈ֍ֲ׌y;䐤r;쀀𝔉lledɓ֗\0\0֣mallSquare;旼erySmallSquare;斪Ͱֺ\0ֿ\0\0ׄf;쀀𝔽All;戀riertrf;愱cò׋؀JTabcdfgorstר׬ׯ׺؀ؒؖ؛؝أ٬ٲcy;䐃耻>䀾mmaĀ;d׷׸䎓;䏜reve;䄞ƀeiy؇،ؐdil;䄢rc;䄜;䐓ot;䄠r;쀀𝔊;拙pf;쀀𝔾eater̀EFGLSTصلَٖٛ٦qualĀ;Lؾؿ扥ess;招ullEqual;执reater;檢ess;扷lantEqual;橾ilde;扳cr;쀀𝒢;扫ЀAacfiosuڅڋږڛڞڪھۊRDcy;䐪Āctڐڔek;䋇;䁞irc;䄤r;愌lbertSpace;愋ǰگ\0ڲf;愍izontalLine;攀Āctۃۅòکrok;䄦mpńېۘownHumðįqual;扏܀EJOacdfgmnostuۺ۾܃܇܎ܚܞܡܨ݄ݸދޏޕcy;䐕lig;䄲cy;䐁cute耻Í䃍Āiyܓܘrc耻Î䃎;䐘ot;䄰r;愑rave耻Ì䃌ƀ;apܠܯܿĀcgܴܷr;䄪inaryI;慈lieóϝǴ݉\0ݢĀ;eݍݎ戬Āgrݓݘral;戫section;拂isibleĀCTݬݲomma;恣imes;恢ƀgptݿރވon;䄮f;쀀𝕀a;䎙cr;愐ilde;䄨ǫޚ\0ޞcy;䐆l耻Ï䃏ʀcfosuެ޷޼߂ߐĀiyޱ޵rc;䄴;䐙r;쀀𝔍pf;쀀𝕁ǣ߇\0ߌr;쀀𝒥rcy;䐈kcy;䐄΀HJacfosߤߨ߽߬߱ࠂࠈcy;䐥cy;䐌ppa;䎚Āey߶߻dil;䄶;䐚r;쀀𝔎pf;쀀𝕂cr;쀀𝒦րJTaceflmostࠥࠩࠬࡐࡣ঳সে্਷ੇcy;䐉耻<䀼ʀcmnpr࠷࠼ࡁࡄࡍute;䄹bda;䎛g;柪lacetrf;愒r;憞ƀaeyࡗ࡜ࡡron;䄽dil;䄻;䐛Āfsࡨ॰tԀACDFRTUVarࡾࢩࢱࣦ࣠ࣼयज़ΐ४Ānrࢃ࢏gleBracket;柨rowƀ;BR࢙࢚࢞憐ar;懤ightArrow;懆eiling;挈oǵࢷ\0ࣃbleBracket;柦nǔࣈ\0࣒eeVector;楡ectorĀ;Bࣛࣜ懃ar;楙loor;挊ightĀAV࣯ࣵrrow;憔ector;楎Āerँगeƀ;AVउऊऐ抣rrow;憤ector;楚iangleƀ;BEतथऩ抲ar;槏qual;抴pƀDTVषूौownVector;楑eeVector;楠ectorĀ;Bॖॗ憿ar;楘ectorĀ;B॥०憼ar;楒ightáΜs̀EFGLSTॾঋকঝঢভqualGreater;拚ullEqual;扦reater;扶ess;檡lantEqual;橽ilde;扲r;쀀𝔏Ā;eঽা拘ftarrow;懚idot;䄿ƀnpw৔ਖਛgȀLRlr৞৷ਂਐeftĀAR০৬rrow;柵ightArrow;柷ightArrow;柶eftĀarγਊightáοightáϊf;쀀𝕃erĀLRਢਬeftArrow;憙ightArrow;憘ƀchtਾੀੂòࡌ;憰rok;䅁;扪Ѐacefiosuਗ਼੝੠੷੼અઋ઎p;椅y;䐜Ādl੥੯iumSpace;恟lintrf;愳r;쀀𝔐nusPlus;戓pf;쀀𝕄cò੶;䎜ҀJacefostuણધભીଔଙඑ඗ඞcy;䐊cute;䅃ƀaey઴હાron;䅇dil;䅅;䐝ƀgswે૰଎ativeƀMTV૓૟૨ediumSpace;怋hiĀcn૦૘ë૙eryThiî૙tedĀGL૸ଆreaterGreateòٳessLesóੈLine;䀊r;쀀𝔑ȀBnptଢନଷ଺reak;恠BreakingSpace;䂠f;愕ڀ;CDEGHLNPRSTV୕ୖ୪୼஡௫ఄ౞಄ದ೘ൡඅ櫬Āou୛୤ngruent;扢pCap;扭oubleVerticalBar;戦ƀlqxஃஊ஛ement;戉ualĀ;Tஒஓ扠ilde;쀀≂̸ists;戄reater΀;EFGLSTஶஷ஽௉௓௘௥扯qual;扱ullEqual;쀀≧̸reater;쀀≫̸ess;批lantEqual;쀀⩾̸ilde;扵umpń௲௽ownHump;쀀≎̸qual;쀀≏̸eĀfsఊధtTriangleƀ;BEచఛడ拪ar;쀀⧏̸qual;括s̀;EGLSTవశ఼ౄోౘ扮qual;扰reater;扸ess;쀀≪̸lantEqual;쀀⩽̸ilde;扴estedĀGL౨౹reaterGreater;쀀⪢̸essLess;쀀⪡̸recedesƀ;ESಒಓಛ技qual;쀀⪯̸lantEqual;拠ĀeiಫಹverseElement;戌ghtTriangleƀ;BEೋೌ೒拫ar;쀀⧐̸qual;拭ĀquೝഌuareSuĀbp೨೹setĀ;E೰ೳ쀀⊏̸qual;拢ersetĀ;Eഃആ쀀⊐̸qual;拣ƀbcpഓതൎsetĀ;Eഛഞ쀀⊂⃒qual;抈ceedsȀ;ESTലള഻െ抁qual;쀀⪰̸lantEqual;拡ilde;쀀≿̸ersetĀ;E൘൛쀀⊃⃒qual;抉ildeȀ;EFT൮൯൵ൿ扁qual;扄ullEqual;扇ilde;扉erticalBar;戤cr;쀀𝒩ilde耻Ñ䃑;䎝܀Eacdfgmoprstuvලෂ෉෕ෛ෠෧෼ขภยา฿ไlig;䅒cute耻Ó䃓Āiy෎ීrc耻Ô䃔;䐞blac;䅐r;쀀𝔒rave耻Ò䃒ƀaei෮ෲ෶cr;䅌ga;䎩cron;䎟pf;쀀𝕆enCurlyĀDQฎบoubleQuote;怜uote;怘;橔Āclวฬr;쀀𝒪ash耻Ø䃘iŬื฼de耻Õ䃕es;樷ml耻Ö䃖erĀBP๋๠Āar๐๓r;怾acĀek๚๜;揞et;掴arenthesis;揜Ҁacfhilors๿ງຊຏຒດຝະ໼rtialD;戂y;䐟r;쀀𝔓i;䎦;䎠usMinus;䂱Āipຢອncareplanåڝf;愙Ȁ;eio຺ູ໠໤檻cedesȀ;EST່້໏໚扺qual;檯lantEqual;扼ilde;找me;怳Ādp໩໮uct;戏ortionĀ;aȥ໹l;戝Āci༁༆r;쀀𝒫;䎨ȀUfos༑༖༛༟OT耻"䀢r;쀀𝔔pf;愚cr;쀀𝒬؀BEacefhiorsu༾གྷཇའཱིྦྷྪྭ႖ႩႴႾarr;椐G耻®䂮ƀcnrཎནབute;䅔g;柫rĀ;tཛྷཝ憠l;椖ƀaeyཧཬཱron;䅘dil;䅖;䐠Ā;vླྀཹ愜erseĀEUྂྙĀlq྇ྎement;戋uilibrium;懋pEquilibrium;楯r»ཹo;䎡ghtЀACDFTUVa࿁࿫࿳ဢဨၛႇϘĀnr࿆࿒gleBracket;柩rowƀ;BL࿜࿝࿡憒ar;懥eftArrow;懄eiling;按oǵ࿹\0စbleBracket;柧nǔည\0နeeVector;楝ectorĀ;Bဝသ懂ar;楕loor;挋Āerိ၃eƀ;AVဵံြ抢rrow;憦ector;楛iangleƀ;BEၐၑၕ抳ar;槐qual;抵pƀDTVၣၮၸownVector;楏eeVector;楜ectorĀ;Bႂႃ憾ar;楔ectorĀ;B႑႒懀ar;楓Āpuႛ႞f;愝ndImplies;楰ightarrow;懛ĀchႹႼr;愛;憱leDelayed;槴ڀHOacfhimoqstuფჱჷჽᄙᄞᅑᅖᅡᅧᆵᆻᆿĀCcჩხHcy;䐩y;䐨FTcy;䐬cute;䅚ʀ;aeiyᄈᄉᄎᄓᄗ檼ron;䅠dil;䅞rc;䅜;䐡r;쀀𝔖ortȀDLRUᄪᄴᄾᅉownArrow»ОeftArrow»࢚ightArrow»࿝pArrow;憑gma;䎣allCircle;战pf;쀀𝕊ɲᅭ\0\0ᅰt;戚areȀ;ISUᅻᅼᆉᆯ斡ntersection;抓uĀbpᆏᆞsetĀ;Eᆗᆘ抏qual;抑ersetĀ;Eᆨᆩ抐qual;抒nion;抔cr;쀀𝒮ar;拆ȀbcmpᇈᇛሉላĀ;sᇍᇎ拐etĀ;Eᇍᇕqual;抆ĀchᇠህeedsȀ;ESTᇭᇮᇴᇿ扻qual;檰lantEqual;扽ilde;承Tháྌ;我ƀ;esሒሓሣ拑rsetĀ;Eሜም抃qual;抇et»ሓրHRSacfhiorsሾቄ቉ቕ቞ቱቶኟዂወዑORN耻Þ䃞ADE;愢ĀHc቎ቒcy;䐋y;䐦Ābuቚቜ;䀉;䎤ƀaeyብቪቯron;䅤dil;䅢;䐢r;쀀𝔗Āeiቻ኉ǲኀ\0ኇefore;戴a;䎘Ācn኎ኘkSpace;쀀  Space;怉ldeȀ;EFTካኬኲኼ戼qual;扃ullEqual;扅ilde;扈pf;쀀𝕋ipleDot;惛Āctዖዛr;쀀𝒯rok;䅦ૡዷጎጚጦ\0ጬጱ\0\0\0\0\0ጸጽ፷ᎅ\0᏿ᐄᐊᐐĀcrዻጁute耻Ú䃚rĀ;oጇገ憟cir;楉rǣጓ\0጖y;䐎ve;䅬Āiyጞጣrc耻Û䃛;䐣blac;䅰r;쀀𝔘rave耻Ù䃙acr;䅪Ādiፁ፩erĀBPፈ፝Āarፍፐr;䁟acĀekፗፙ;揟et;掵arenthesis;揝onĀ;P፰፱拃lus;抎Āgp፻፿on;䅲f;쀀𝕌ЀADETadps᎕ᎮᎸᏄϨᏒᏗᏳrrowƀ;BDᅐᎠᎤar;椒ownArrow;懅ownArrow;憕quilibrium;楮eeĀ;AᏋᏌ报rrow;憥ownáϳerĀLRᏞᏨeftArrow;憖ightArrow;憗iĀ;lᏹᏺ䏒on;䎥ing;䅮cr;쀀𝒰ilde;䅨ml耻Ü䃜ҀDbcdefosvᐧᐬᐰᐳᐾᒅᒊᒐᒖash;披ar;櫫y;䐒ashĀ;lᐻᐼ抩;櫦Āerᑃᑅ;拁ƀbtyᑌᑐᑺar;怖Ā;iᑏᑕcalȀBLSTᑡᑥᑪᑴar;戣ine;䁼eparator;杘ilde;所ThinSpace;怊r;쀀𝔙pf;쀀𝕍cr;쀀𝒱dash;抪ʀcefosᒧᒬᒱᒶᒼirc;䅴dge;拀r;쀀𝔚pf;쀀𝕎cr;쀀𝒲Ȁfiosᓋᓐᓒᓘr;쀀𝔛;䎞pf;쀀𝕏cr;쀀𝒳ҀAIUacfosuᓱᓵᓹᓽᔄᔏᔔᔚᔠcy;䐯cy;䐇cy;䐮cute耻Ý䃝Āiyᔉᔍrc;䅶;䐫r;쀀𝔜pf;쀀𝕐cr;쀀𝒴ml;䅸ЀHacdefosᔵᔹᔿᕋᕏᕝᕠᕤcy;䐖cute;䅹Āayᕄᕉron;䅽;䐗ot;䅻ǲᕔ\0ᕛoWidtè૙a;䎖r;愨pf;愤cr;쀀𝒵௡ᖃᖊᖐ\0ᖰᖶᖿ\0\0\0\0ᗆᗛᗫᙟ᙭\0ᚕ᚛ᚲᚹ\0ᚾcute耻á䃡reve;䄃̀;Ediuyᖜᖝᖡᖣᖨᖭ戾;쀀∾̳;房rc耻â䃢te肻´̆;䐰lig耻æ䃦Ā;r²ᖺ;쀀𝔞rave耻à䃠ĀepᗊᗖĀfpᗏᗔsym;愵èᗓha;䎱ĀapᗟcĀclᗤᗧr;䄁g;樿ɤᗰ\0\0ᘊʀ;adsvᗺᗻᗿᘁᘇ戧nd;橕;橜lope;橘;橚΀;elmrszᘘᘙᘛᘞᘿᙏᙙ戠;榤e»ᘙsdĀ;aᘥᘦ戡ѡᘰᘲᘴᘶᘸᘺᘼᘾ;榨;榩;榪;榫;榬;榭;榮;榯tĀ;vᙅᙆ戟bĀ;dᙌᙍ抾;榝Āptᙔᙗh;戢»¹arr;捼Āgpᙣᙧon;䄅f;쀀𝕒΀;Eaeiop዁ᙻᙽᚂᚄᚇᚊ;橰cir;橯;扊d;手s;䀧roxĀ;e዁ᚒñᚃing耻å䃥ƀctyᚡᚦᚨr;쀀𝒶;䀪mpĀ;e዁ᚯñʈilde耻ã䃣ml耻ä䃤Āciᛂᛈoninôɲnt;樑ࠀNabcdefiklnoprsu᛭ᛱᜰ᜼ᝃᝈ᝸᝽០៦ᠹᡐᜍ᤽᥈ᥰot;櫭Ācrᛶ᜞kȀcepsᜀᜅᜍᜓong;扌psilon;䏶rime;怵imĀ;e᜚᜛戽q;拍Ŷᜢᜦee;抽edĀ;gᜬᜭ挅e»ᜭrkĀ;t፜᜷brk;掶Āoyᜁᝁ;䐱quo;怞ʀcmprtᝓ᝛ᝡᝤᝨausĀ;eĊĉptyv;榰séᜌnoõēƀahwᝯ᝱ᝳ;䎲;愶een;扬r;쀀𝔟g΀costuvwឍឝឳេ៕៛៞ƀaiuបពរðݠrc;旯p»፱ƀdptឤឨឭot;樀lus;樁imes;樂ɱឹ\0\0ើcup;樆ar;昅riangleĀdu៍្own;施p;斳plus;樄eåᑄåᒭarow;植ƀako៭ᠦᠵĀcn៲ᠣkƀlst៺֫᠂ozenge;槫riangleȀ;dlr᠒᠓᠘᠝斴own;斾eft;旂ight;斸k;搣Ʊᠫ\0ᠳƲᠯ\0ᠱ;斒;斑4;斓ck;斈ĀeoᠾᡍĀ;qᡃᡆ쀀=⃥uiv;쀀≡⃥t;挐Ȁptwxᡙᡞᡧᡬf;쀀𝕓Ā;tᏋᡣom»Ꮜtie;拈؀DHUVbdhmptuvᢅᢖᢪᢻᣗᣛᣬ᣿ᤅᤊᤐᤡȀLRlrᢎᢐᢒᢔ;敗;敔;敖;敓ʀ;DUduᢡᢢᢤᢦᢨ敐;敦;敩;敤;敧ȀLRlrᢳᢵᢷᢹ;敝;敚;敜;教΀;HLRhlrᣊᣋᣍᣏᣑᣓᣕ救;敬;散;敠;敫;敢;敟ox;槉ȀLRlrᣤᣦᣨᣪ;敕;敒;攐;攌ʀ;DUduڽ᣷᣹᣻᣽;敥;敨;攬;攴inus;抟lus;択imes;抠ȀLRlrᤙᤛᤝ᤟;敛;敘;攘;攔΀;HLRhlrᤰᤱᤳᤵᤷ᤻᤹攂;敪;敡;敞;攼;攤;攜Āevģ᥂bar耻¦䂦Ȁceioᥑᥖᥚᥠr;쀀𝒷mi;恏mĀ;e᜚᜜lƀ;bhᥨᥩᥫ䁜;槅sub;柈Ŭᥴ᥾lĀ;e᥹᥺怢t»᥺pƀ;Eeįᦅᦇ;檮Ā;qۜۛೡᦧ\0᧨ᨑᨕᨲ\0ᨷᩐ\0\0᪴\0\0᫁\0\0ᬡᬮ᭍᭒\0᯽\0ᰌƀcpr᦭ᦲ᧝ute;䄇̀;abcdsᦿᧀᧄ᧊᧕᧙戩nd;橄rcup;橉Āau᧏᧒p;橋p;橇ot;橀;쀀∩︀Āeo᧢᧥t;恁îړȀaeiu᧰᧻ᨁᨅǰ᧵\0᧸s;橍on;䄍dil耻ç䃧rc;䄉psĀ;sᨌᨍ橌m;橐ot;䄋ƀdmnᨛᨠᨦil肻¸ƭptyv;榲t脀¢;eᨭᨮ䂢räƲr;쀀𝔠ƀceiᨽᩀᩍy;䑇ckĀ;mᩇᩈ朓ark»ᩈ;䏇r΀;Ecefms᩟᩠ᩢᩫ᪤᪪᪮旋;槃ƀ;elᩩᩪᩭ䋆q;扗eɡᩴ\0\0᪈rrowĀlr᩼᪁eft;憺ight;憻ʀRSacd᪒᪔᪖᪚᪟»ཇ;擈st;抛irc;抚ash;抝nint;樐id;櫯cir;槂ubsĀ;u᪻᪼晣it»᪼ˬ᫇᫔᫺\0ᬊonĀ;eᫍᫎ䀺Ā;qÇÆɭ᫙\0\0᫢aĀ;t᫞᫟䀬;䁀ƀ;fl᫨᫩᫫戁îᅠeĀmx᫱᫶ent»᫩eóɍǧ᫾\0ᬇĀ;dኻᬂot;橭nôɆƀfryᬐᬔᬗ;쀀𝕔oäɔ脀©;sŕᬝr;愗Āaoᬥᬩrr;憵ss;朗Ācuᬲᬷr;쀀𝒸Ābpᬼ᭄Ā;eᭁᭂ櫏;櫑Ā;eᭉᭊ櫐;櫒dot;拯΀delprvw᭠᭬᭷ᮂᮬᯔ᯹arrĀlr᭨᭪;椸;椵ɰ᭲\0\0᭵r;拞c;拟arrĀ;p᭿ᮀ憶;椽̀;bcdosᮏᮐᮖᮡᮥᮨ截rcap;橈Āauᮛᮞp;橆p;橊ot;抍r;橅;쀀∪︀Ȁalrv᮵ᮿᯞᯣrrĀ;mᮼᮽ憷;椼yƀevwᯇᯔᯘqɰᯎ\0\0ᯒreã᭳uã᭵ee;拎edge;拏en耻¤䂤earrowĀlrᯮ᯳eft»ᮀight»ᮽeäᯝĀciᰁᰇoninôǷnt;戱lcty;挭ঀAHabcdefhijlorstuwz᰸᰻᰿ᱝᱩᱵᲊᲞᲬᲷ᳻᳿ᴍᵻᶑᶫᶻ᷆᷍rò΁ar;楥Ȁglrs᱈ᱍ᱒᱔ger;怠eth;愸òᄳhĀ;vᱚᱛ怐»ऊūᱡᱧarow;椏aã̕Āayᱮᱳron;䄏;䐴ƀ;ao̲ᱼᲄĀgrʿᲁr;懊tseq;橷ƀglmᲑᲔᲘ耻°䂰ta;䎴ptyv;榱ĀirᲣᲨsht;楿;쀀𝔡arĀlrᲳᲵ»ࣜ»သʀaegsv᳂͸᳖᳜᳠mƀ;oș᳊᳔ndĀ;ș᳑uit;晦amma;䏝in;拲ƀ;io᳧᳨᳸䃷de脀÷;o᳧ᳰntimes;拇nø᳷cy;䑒cɯᴆ\0\0ᴊrn;挞op;挍ʀlptuwᴘᴝᴢᵉᵕlar;䀤f;쀀𝕕ʀ;emps̋ᴭᴷᴽᵂqĀ;d͒ᴳot;扑inus;戸lus;戔quare;抡blebarwedgåúnƀadhᄮᵝᵧownarrowóᲃarpoonĀlrᵲᵶefôᲴighôᲶŢᵿᶅkaro÷གɯᶊ\0\0ᶎrn;挟op;挌ƀcotᶘᶣᶦĀryᶝᶡ;쀀𝒹;䑕l;槶rok;䄑Ādrᶰᶴot;拱iĀ;fᶺ᠖斿Āah᷀᷃ròЩaòྦangle;榦Āci᷒ᷕy;䑟grarr;柿ऀDacdefglmnopqrstuxḁḉḙḸոḼṉṡṾấắẽỡἪἷὄ὎὚ĀDoḆᴴoôᲉĀcsḎḔute耻é䃩ter;橮ȀaioyḢḧḱḶron;䄛rĀ;cḭḮ扖耻ê䃪lon;払;䑍ot;䄗ĀDrṁṅot;扒;쀀𝔢ƀ;rsṐṑṗ檚ave耻è䃨Ā;dṜṝ檖ot;檘Ȁ;ilsṪṫṲṴ檙nters;揧;愓Ā;dṹṺ檕ot;檗ƀapsẅẉẗcr;䄓tyƀ;svẒẓẕ戅et»ẓpĀ1;ẝẤĳạả;怄;怅怃ĀgsẪẬ;䅋p;怂ĀgpẴẸon;䄙f;쀀𝕖ƀalsỄỎỒrĀ;sỊị拕l;槣us;橱iƀ;lvỚớở䎵on»ớ;䏵ȀcsuvỪỳἋἣĀioữḱrc»Ḯɩỹ\0\0ỻíՈantĀglἂἆtr»ṝess»Ṻƀaeiἒ἖Ἒls;䀽st;扟vĀ;DȵἠD;橸parsl;槥ĀDaἯἳot;打rr;楱ƀcdiἾὁỸr;愯oô͒ĀahὉὋ;䎷耻ð䃰Āmrὓὗl耻ë䃫o;悬ƀcipὡὤὧl;䀡sôծĀeoὬὴctatioîՙnentialåչৡᾒ\0ᾞ\0ᾡᾧ\0\0ῆῌ\0ΐ\0ῦῪ \0 ⁚llingdotseñṄy;䑄male;晀ƀilrᾭᾳ῁lig;耀ﬃɩᾹ\0\0᾽g;耀ﬀig;耀ﬄ;쀀𝔣lig;耀ﬁlig;쀀fjƀaltῙ῜ῡt;晭ig;耀ﬂns;斱of;䆒ǰ΅\0ῳf;쀀𝕗ĀakֿῷĀ;vῼ´拔;櫙artint;樍Āao‌⁕Ācs‑⁒α‚‰‸⁅⁈\0⁐β•‥‧‪‬\0‮耻½䂽;慓耻¼䂼;慕;慙;慛Ƴ‴\0‶;慔;慖ʴ‾⁁\0\0⁃耻¾䂾;慗;慜5;慘ƶ⁌\0⁎;慚;慝8;慞l;恄wn;挢cr;쀀𝒻ࢀEabcdefgijlnorstv₂₉₟₥₰₴⃰⃵⃺⃿℃ℒℸ̗ℾ⅒↞Ā;lٍ₇;檌ƀcmpₐₕ₝ute;䇵maĀ;dₜ᳚䎳;檆reve;䄟Āiy₪₮rc;䄝;䐳ot;䄡Ȁ;lqsؾق₽⃉ƀ;qsؾٌ⃄lanô٥Ȁ;cdl٥⃒⃥⃕c;檩otĀ;o⃜⃝檀Ā;l⃢⃣檂;檄Ā;e⃪⃭쀀⋛︀s;檔r;쀀𝔤Ā;gٳ؛mel;愷cy;䑓Ȁ;Eajٚℌℎℐ;檒;檥;檤ȀEaesℛℝ℩ℴ;扩pĀ;p℣ℤ檊rox»ℤĀ;q℮ℯ檈Ā;q℮ℛim;拧pf;쀀𝕘Āci⅃ⅆr;愊mƀ;el٫ⅎ⅐;檎;檐茀>;cdlqr׮ⅠⅪⅮⅳⅹĀciⅥⅧ;檧r;橺ot;拗Par;榕uest;橼ʀadelsↄⅪ←ٖ↛ǰ↉\0↎proø₞r;楸qĀlqؿ↖lesó₈ií٫Āen↣↭rtneqq;쀀≩︀Å↪ԀAabcefkosy⇄⇇⇱⇵⇺∘∝∯≨≽ròΠȀilmr⇐⇔⇗⇛rsðᒄf»․ilôکĀdr⇠⇤cy;䑊ƀ;cwࣴ⇫⇯ir;楈;憭ar;意irc;䄥ƀalr∁∎∓rtsĀ;u∉∊晥it»∊lip;怦con;抹r;쀀𝔥sĀew∣∩arow;椥arow;椦ʀamopr∺∾≃≞≣rr;懿tht;戻kĀlr≉≓eftarrow;憩ightarrow;憪f;쀀𝕙bar;怕ƀclt≯≴≸r;쀀𝒽asè⇴rok;䄧Ābp⊂⊇ull;恃hen»ᱛૡ⊣\0⊪\0⊸⋅⋎\0⋕⋳\0\0⋸⌢⍧⍢⍿\0⎆⎪⎴cute耻í䃭ƀ;iyݱ⊰⊵rc耻î䃮;䐸Ācx⊼⊿y;䐵cl耻¡䂡ĀfrΟ⋉;쀀𝔦rave耻ì䃬Ȁ;inoܾ⋝⋩⋮Āin⋢⋦nt;樌t;戭fin;槜ta;愩lig;䄳ƀaop⋾⌚⌝ƀcgt⌅⌈⌗r;䄫ƀelpܟ⌏⌓inåގarôܠh;䄱f;抷ed;䆵ʀ;cfotӴ⌬⌱⌽⍁are;愅inĀ;t⌸⌹戞ie;槝doô⌙ʀ;celpݗ⍌⍐⍛⍡al;抺Āgr⍕⍙eróᕣã⍍arhk;樗rod;樼Ȁcgpt⍯⍲⍶⍻y;䑑on;䄯f;쀀𝕚a;䎹uest耻¿䂿Āci⎊⎏r;쀀𝒾nʀ;EdsvӴ⎛⎝⎡ӳ;拹ot;拵Ā;v⎦⎧拴;拳Ā;iݷ⎮lde;䄩ǫ⎸\0⎼cy;䑖l耻ï䃯̀cfmosu⏌⏗⏜⏡⏧⏵Āiy⏑⏕rc;䄵;䐹r;쀀𝔧ath;䈷pf;쀀𝕛ǣ⏬\0⏱r;쀀𝒿rcy;䑘kcy;䑔Ѐacfghjos␋␖␢␧␭␱␵␻ppaĀ;v␓␔䎺;䏰Āey␛␠dil;䄷;䐺r;쀀𝔨reen;䄸cy;䑅cy;䑜pf;쀀𝕜cr;쀀𝓀஀ABEHabcdefghjlmnoprstuv⑰⒁⒆⒍⒑┎┽╚▀♎♞♥♹♽⚚⚲⛘❝❨➋⟀⠁⠒ƀart⑷⑺⑼rò৆òΕail;椛arr;椎Ā;gঔ⒋;檋ar;楢ॣ⒥\0⒪\0⒱\0\0\0\0\0⒵Ⓔ\0ⓆⓈⓍ\0⓹ute;䄺mptyv;榴raîࡌbda;䎻gƀ;dlࢎⓁⓃ;榑åࢎ;檅uo耻«䂫rЀ;bfhlpst࢙ⓞⓦⓩ⓫⓮⓱⓵Ā;f࢝ⓣs;椟s;椝ë≒p;憫l;椹im;楳l;憢ƀ;ae⓿─┄檫il;椙Ā;s┉┊檭;쀀⪭︀ƀabr┕┙┝rr;椌rk;杲Āak┢┬cĀek┨┪;䁻;䁛Āes┱┳;榋lĀdu┹┻;榏;榍Ȁaeuy╆╋╖╘ron;䄾Ādi═╔il;䄼ìࢰâ┩;䐻Ȁcqrs╣╦╭╽a;椶uoĀ;rนᝆĀdu╲╷har;楧shar;楋h;憲ʀ;fgqs▋▌উ◳◿扤tʀahlrt▘▤▷◂◨rrowĀ;t࢙□aé⓶arpoonĀdu▯▴own»њp»०eftarrows;懇ightƀahs◍◖◞rrowĀ;sࣴࢧarpoonó྘quigarro÷⇰hreetimes;拋ƀ;qs▋ও◺lanôবʀ;cdgsব☊☍☝☨c;檨otĀ;o☔☕橿Ā;r☚☛檁;檃Ā;e☢☥쀀⋚︀s;檓ʀadegs☳☹☽♉♋pproøⓆot;拖qĀgq♃♅ôউgtò⒌ôছiíলƀilr♕࣡♚sht;楼;쀀𝔩Ā;Eজ♣;檑š♩♶rĀdu▲♮Ā;l॥♳;楪lk;斄cy;䑙ʀ;achtੈ⚈⚋⚑⚖rò◁orneòᴈard;楫ri;旺Āio⚟⚤dot;䅀ustĀ;a⚬⚭掰che»⚭ȀEaes⚻⚽⛉⛔;扨pĀ;p⛃⛄檉rox»⛄Ā;q⛎⛏檇Ā;q⛎⚻im;拦Ѐabnoptwz⛩⛴⛷✚✯❁❇❐Ānr⛮⛱g;柬r;懽rëࣁgƀlmr⛿✍✔eftĀar০✇ightá৲apsto;柼ightá৽parrowĀlr✥✩efô⓭ight;憬ƀafl✶✹✽r;榅;쀀𝕝us;樭imes;樴š❋❏st;戗áፎƀ;ef❗❘᠀旊nge»❘arĀ;l❤❥䀨t;榓ʀachmt❳❶❼➅➇ròࢨorneòᶌarĀ;d྘➃;業;怎ri;抿̀achiqt➘➝ੀ➢➮➻quo;怹r;쀀𝓁mƀ;egল➪➬;檍;檏Ābu┪➳oĀ;rฟ➹;怚rok;䅂萀<;cdhilqrࠫ⟒☹⟜⟠⟥⟪⟰Āci⟗⟙;檦r;橹reå◲mes;拉arr;楶uest;橻ĀPi⟵⟹ar;榖ƀ;ef⠀भ᠛旃rĀdu⠇⠍shar;楊har;楦Āen⠗⠡rtneqq;쀀≨︀Å⠞܀Dacdefhilnopsu⡀⡅⢂⢎⢓⢠⢥⢨⣚⣢⣤ઃ⣳⤂Dot;戺Ȁclpr⡎⡒⡣⡽r耻¯䂯Āet⡗⡙;時Ā;e⡞⡟朠se»⡟Ā;sျ⡨toȀ;dluျ⡳⡷⡻owîҌefôएðᏑker;斮Āoy⢇⢌mma;権;䐼ash;怔asuredangle»ᘦr;쀀𝔪o;愧ƀcdn⢯⢴⣉ro耻µ䂵Ȁ;acdᑤ⢽⣀⣄sôᚧir;櫰ot肻·Ƶusƀ;bd⣒ᤃ⣓戒Ā;uᴼ⣘;横ţ⣞⣡p;櫛ò−ðઁĀdp⣩⣮els;抧f;쀀𝕞Āct⣸⣽r;쀀𝓂pos»ᖝƀ;lm⤉⤊⤍䎼timap;抸ఀGLRVabcdefghijlmoprstuvw⥂⥓⥾⦉⦘⧚⧩⨕⨚⩘⩝⪃⪕⪤⪨⬄⬇⭄⭿⮮ⰴⱧⱼ⳩Āgt⥇⥋;쀀⋙̸Ā;v⥐௏쀀≫⃒ƀelt⥚⥲⥶ftĀar⥡⥧rrow;懍ightarrow;懎;쀀⋘̸Ā;v⥻ే쀀≪⃒ightarrow;懏ĀDd⦎⦓ash;抯ash;抮ʀbcnpt⦣⦧⦬⦱⧌la»˞ute;䅄g;쀀∠⃒ʀ;Eiop඄⦼⧀⧅⧈;쀀⩰̸d;쀀≋̸s;䅉roø඄urĀ;a⧓⧔普lĀ;s⧓ସǳ⧟\0⧣p肻 ଷmpĀ;e௹ఀʀaeouy⧴⧾⨃⨐⨓ǰ⧹\0⧻;橃on;䅈dil;䅆ngĀ;dൾ⨊ot;쀀⩭̸p;橂;䐽ash;怓΀;Aadqsxஒ⨩⨭⨻⩁⩅⩐rr;懗rĀhr⨳⨶k;椤Ā;oᏲᏰot;쀀≐̸uiöୣĀei⩊⩎ar;椨í஘istĀ;s஠டr;쀀𝔫ȀEest௅⩦⩹⩼ƀ;qs஼⩭௡ƀ;qs஼௅⩴lanô௢ií௪Ā;rஶ⪁»ஷƀAap⪊⪍⪑rò⥱rr;憮ar;櫲ƀ;svྍ⪜ྌĀ;d⪡⪢拼;拺cy;䑚΀AEadest⪷⪺⪾⫂⫅⫶⫹rò⥦;쀀≦̸rr;憚r;急Ȁ;fqs఻⫎⫣⫯tĀar⫔⫙rro÷⫁ightarro÷⪐ƀ;qs఻⪺⫪lanôౕĀ;sౕ⫴»శiíౝĀ;rవ⫾iĀ;eచథiäඐĀpt⬌⬑f;쀀𝕟膀¬;in⬙⬚⬶䂬nȀ;Edvஉ⬤⬨⬮;쀀⋹̸ot;쀀⋵̸ǡஉ⬳⬵;拷;拶iĀ;vಸ⬼ǡಸ⭁⭃;拾;拽ƀaor⭋⭣⭩rȀ;ast୻⭕⭚⭟lleì୻l;쀀⫽⃥;쀀∂̸lint;樔ƀ;ceಒ⭰⭳uåಥĀ;cಘ⭸Ā;eಒ⭽ñಘȀAait⮈⮋⮝⮧rò⦈rrƀ;cw⮔⮕⮙憛;쀀⤳̸;쀀↝̸ghtarrow»⮕riĀ;eೋೖ΀chimpqu⮽⯍⯙⬄୸⯤⯯Ȁ;cerല⯆ഷ⯉uå൅;쀀𝓃ortɭ⬅\0\0⯖ará⭖mĀ;e൮⯟Ā;q൴൳suĀbp⯫⯭å೸åഋƀbcp⯶ⰑⰙȀ;Ees⯿ⰀഢⰄ抄;쀀⫅̸etĀ;eഛⰋqĀ;qണⰀcĀ;eലⰗñസȀ;EesⰢⰣൟⰧ抅;쀀⫆̸etĀ;e൘ⰮqĀ;qൠⰣȀgilrⰽⰿⱅⱇìௗlde耻ñ䃱çృiangleĀlrⱒⱜeftĀ;eచⱚñదightĀ;eೋⱥñ೗Ā;mⱬⱭ䎽ƀ;esⱴⱵⱹ䀣ro;愖p;怇ҀDHadgilrsⲏⲔⲙⲞⲣⲰⲶⳓⳣash;抭arr;椄p;쀀≍⃒ash;抬ĀetⲨⲬ;쀀≥⃒;쀀>⃒nfin;槞ƀAetⲽⳁⳅrr;椂;쀀≤⃒Ā;rⳊⳍ쀀<⃒ie;쀀⊴⃒ĀAtⳘⳜrr;椃rie;쀀⊵⃒im;쀀∼⃒ƀAan⳰⳴ⴂrr;懖rĀhr⳺⳽k;椣Ā;oᏧᏥear;椧ቓ᪕\0\0\0\0\0\0\0\0\0\0\0\0\0ⴭ\0ⴸⵈⵠⵥ⵲ⶄᬇ\0\0ⶍⶫ\0ⷈⷎ\0ⷜ⸙⸫⸾⹃Ācsⴱ᪗ute耻ó䃳ĀiyⴼⵅrĀ;c᪞ⵂ耻ô䃴;䐾ʀabios᪠ⵒⵗǈⵚlac;䅑v;樸old;榼lig;䅓Ācr⵩⵭ir;榿;쀀𝔬ͯ⵹\0\0⵼\0ⶂn;䋛ave耻ò䃲;槁Ābmⶈ෴ar;榵Ȁacitⶕ⶘ⶥⶨrò᪀Āir⶝ⶠr;榾oss;榻nå๒;槀ƀaeiⶱⶵⶹcr;䅍ga;䏉ƀcdnⷀⷅǍron;䎿;榶pf;쀀𝕠ƀaelⷔ⷗ǒr;榷rp;榹΀;adiosvⷪⷫⷮ⸈⸍⸐⸖戨rò᪆Ȁ;efmⷷⷸ⸂⸅橝rĀ;oⷾⷿ愴f»ⷿ耻ª䂪耻º䂺gof;抶r;橖lope;橗;橛ƀclo⸟⸡⸧ò⸁ash耻ø䃸l;折iŬⸯ⸴de耻õ䃵esĀ;aǛ⸺s;樶ml耻ö䃶bar;挽ૡ⹞\0⹽\0⺀⺝\0⺢⺹\0\0⻋ຜ\0⼓\0\0⼫⾼\0⿈rȀ;astЃ⹧⹲຅脀¶;l⹭⹮䂶leìЃɩ⹸\0\0⹻m;櫳;櫽y;䐿rʀcimpt⺋⺏⺓ᡥ⺗nt;䀥od;䀮il;怰enk;怱r;쀀𝔭ƀimo⺨⺰⺴Ā;v⺭⺮䏆;䏕maô੶ne;明ƀ;tv⺿⻀⻈䏀chfork»´;䏖Āau⻏⻟nĀck⻕⻝kĀ;h⇴⻛;愎ö⇴sҀ;abcdemst⻳⻴ᤈ⻹⻽⼄⼆⼊⼎䀫cir;樣ir;樢Āouᵀ⼂;樥;橲n肻±ຝim;樦wo;樧ƀipu⼙⼠⼥ntint;樕f;쀀𝕡nd耻£䂣Ԁ;Eaceinosu່⼿⽁⽄⽇⾁⾉⾒⽾⾶;檳p;檷uå໙Ā;c໎⽌̀;acens່⽙⽟⽦⽨⽾pproø⽃urlyeñ໙ñ໎ƀaes⽯⽶⽺pprox;檹qq;檵im;拨iíໟmeĀ;s⾈ຮ怲ƀEas⽸⾐⽺ð⽵ƀdfp໬⾙⾯ƀals⾠⾥⾪lar;挮ine;挒urf;挓Ā;t໻⾴ï໻rel;抰Āci⿀⿅r;쀀𝓅;䏈ncsp;怈̀fiopsu⿚⋢⿟⿥⿫⿱r;쀀𝔮pf;쀀𝕢rime;恗cr;쀀𝓆ƀaeo⿸〉〓tĀei⿾々rnionóڰnt;樖stĀ;e【】䀿ñἙô༔઀ABHabcdefhilmnoprstux぀けさすムㄎㄫㅇㅢㅲㆎ㈆㈕㈤㈩㉘㉮㉲㊐㊰㊷ƀartぇおがròႳòϝail;検aròᱥar;楤΀cdenqrtとふへみわゔヌĀeuねぱ;쀀∽̱te;䅕iãᅮmptyv;榳gȀ;del࿑らるろ;榒;榥å࿑uo耻»䂻rր;abcfhlpstw࿜ガクシスゼゾダッデナp;極Ā;f࿠ゴs;椠;椳s;椞ë≝ð✮l;楅im;楴l;憣;憝Āaiパフil;椚oĀ;nホボ戶aló༞ƀabrョリヮrò៥rk;杳ĀakンヽcĀekヹ・;䁽;䁝Āes㄂㄄;榌lĀduㄊㄌ;榎;榐Ȁaeuyㄗㄜㄧㄩron;䅙Ādiㄡㄥil;䅗ì࿲âヺ;䑀Ȁclqsㄴㄷㄽㅄa;椷dhar;楩uoĀ;rȎȍh;憳ƀacgㅎㅟངlȀ;ipsླྀㅘㅛႜnåႻarôྩt;断ƀilrㅩဣㅮsht;楽;쀀𝔯ĀaoㅷㆆrĀduㅽㅿ»ѻĀ;l႑ㆄ;楬Ā;vㆋㆌ䏁;䏱ƀgns㆕ㇹㇼht̀ahlrstㆤㆰ㇂㇘㇤㇮rrowĀ;t࿜ㆭaéトarpoonĀduㆻㆿowîㅾp»႒eftĀah㇊㇐rrowó࿪arpoonóՑightarrows;應quigarro÷ニhreetimes;拌g;䋚ingdotseñἲƀahm㈍㈐㈓rò࿪aòՑ;怏oustĀ;a㈞㈟掱che»㈟mid;櫮Ȁabpt㈲㈽㉀㉒Ānr㈷㈺g;柭r;懾rëဃƀafl㉇㉊㉎r;榆;쀀𝕣us;樮imes;樵Āap㉝㉧rĀ;g㉣㉤䀩t;榔olint;樒arò㇣Ȁachq㉻㊀Ⴜ㊅quo;怺r;쀀𝓇Ābu・㊊oĀ;rȔȓƀhir㊗㊛㊠reåㇸmes;拊iȀ;efl㊪ၙᠡ㊫方tri;槎luhar;楨;愞ൡ㋕㋛㋟㌬㌸㍱\0㍺㎤\0\0㏬㏰\0㐨㑈㑚㒭㒱㓊㓱\0㘖\0\0㘳cute;䅛quï➺Ԁ;Eaceinpsyᇭ㋳㋵㋿㌂㌋㌏㌟㌦㌩;檴ǰ㋺\0㋼;檸on;䅡uåᇾĀ;dᇳ㌇il;䅟rc;䅝ƀEas㌖㌘㌛;檶p;檺im;择olint;樓iíሄ;䑁otƀ;be㌴ᵇ㌵担;橦΀Aacmstx㍆㍊㍗㍛㍞㍣㍭rr;懘rĀhr㍐㍒ë∨Ā;oਸ਼਴t耻§䂧i;䀻war;椩mĀin㍩ðnuóñt;朶rĀ;o㍶⁕쀀𝔰Ȁacoy㎂㎆㎑㎠rp;景Āhy㎋㎏cy;䑉;䑈rtɭ㎙\0\0㎜iäᑤaraì⹯耻­䂭Āgm㎨㎴maƀ;fv㎱㎲㎲䏃;䏂Ѐ;deglnprካ㏅㏉㏎㏖㏞㏡㏦ot;橪Ā;q኱ኰĀ;E㏓㏔檞;檠Ā;E㏛㏜檝;檟e;扆lus;樤arr;楲aròᄽȀaeit㏸㐈㐏㐗Āls㏽㐄lsetmé㍪hp;樳parsl;槤Ādlᑣ㐔e;挣Ā;e㐜㐝檪Ā;s㐢㐣檬;쀀⪬︀ƀflp㐮㐳㑂tcy;䑌Ā;b㐸㐹䀯Ā;a㐾㐿槄r;挿f;쀀𝕤aĀdr㑍ЂesĀ;u㑔㑕晠it»㑕ƀcsu㑠㑹㒟Āau㑥㑯pĀ;sᆈ㑫;쀀⊓︀pĀ;sᆴ㑵;쀀⊔︀uĀbp㑿㒏ƀ;esᆗᆜ㒆etĀ;eᆗ㒍ñᆝƀ;esᆨᆭ㒖etĀ;eᆨ㒝ñᆮƀ;afᅻ㒦ְrť㒫ֱ»ᅼaròᅈȀcemt㒹㒾㓂㓅r;쀀𝓈tmîñiì㐕aræᆾĀar㓎㓕rĀ;f㓔ឿ昆Āan㓚㓭ightĀep㓣㓪psiloîỠhé⺯s»⡒ʀbcmnp㓻㕞ሉ㖋㖎Ҁ;Edemnprs㔎㔏㔑㔕㔞㔣㔬㔱㔶抂;櫅ot;檽Ā;dᇚ㔚ot;櫃ult;櫁ĀEe㔨㔪;櫋;把lus;檿arr;楹ƀeiu㔽㕒㕕tƀ;en㔎㕅㕋qĀ;qᇚ㔏eqĀ;q㔫㔨m;櫇Ābp㕚㕜;櫕;櫓c̀;acensᇭ㕬㕲㕹㕻㌦pproø㋺urlyeñᇾñᇳƀaes㖂㖈㌛pproø㌚qñ㌗g;晪ڀ123;Edehlmnps㖩㖬㖯ሜ㖲㖴㗀㗉㗕㗚㗟㗨㗭耻¹䂹耻²䂲耻³䂳;櫆Āos㖹㖼t;檾ub;櫘Ā;dሢ㗅ot;櫄sĀou㗏㗒l;柉b;櫗arr;楻ult;櫂ĀEe㗤㗦;櫌;抋lus;櫀ƀeiu㗴㘉㘌tƀ;enሜ㗼㘂qĀ;qሢ㖲eqĀ;q㗧㗤m;櫈Ābp㘑㘓;櫔;櫖ƀAan㘜㘠㘭rr;懙rĀhr㘦㘨ë∮Ā;oਫ਩war;椪lig耻ß䃟௡㙑㙝㙠ዎ㙳㙹\0㙾㛂\0\0\0\0\0㛛㜃\0㜉㝬\0\0\0㞇ɲ㙖\0\0㙛get;挖;䏄rë๟ƀaey㙦㙫㙰ron;䅥dil;䅣;䑂lrec;挕r;쀀𝔱Ȁeiko㚆㚝㚵㚼ǲ㚋\0㚑eĀ4fኄኁaƀ;sv㚘㚙㚛䎸ym;䏑Ācn㚢㚲kĀas㚨㚮pproø዁im»ኬsðኞĀas㚺㚮ð዁rn耻þ䃾Ǭ̟㛆⋧es膀×;bd㛏㛐㛘䃗Ā;aᤏ㛕r;樱;樰ƀeps㛡㛣㜀á⩍Ȁ;bcf҆㛬㛰㛴ot;挶ir;櫱Ā;o㛹㛼쀀𝕥rk;櫚á㍢rime;怴ƀaip㜏㜒㝤dåቈ΀adempst㜡㝍㝀㝑㝗㝜㝟ngleʀ;dlqr㜰㜱㜶㝀㝂斵own»ᶻeftĀ;e⠀㜾ñम;扜ightĀ;e㊪㝋ñၚot;旬inus;樺lus;樹b;槍ime;樻ezium;揢ƀcht㝲㝽㞁Āry㝷㝻;쀀𝓉;䑆cy;䑛rok;䅧Āio㞋㞎xô᝷headĀlr㞗㞠eftarro÷ࡏightarrow»ཝऀAHabcdfghlmoprstuw㟐㟓㟗㟤㟰㟼㠎㠜㠣㠴㡑㡝㡫㢩㣌㣒㣪㣶ròϭar;楣Ācr㟜㟢ute耻ú䃺òᅐrǣ㟪\0㟭y;䑞ve;䅭Āiy㟵㟺rc耻û䃻;䑃ƀabh㠃㠆㠋ròᎭlac;䅱aòᏃĀir㠓㠘sht;楾;쀀𝔲rave耻ù䃹š㠧㠱rĀlr㠬㠮»ॗ»ႃlk;斀Āct㠹㡍ɯ㠿\0\0㡊rnĀ;e㡅㡆挜r»㡆op;挏ri;旸Āal㡖㡚cr;䅫肻¨͉Āgp㡢㡦on;䅳f;쀀𝕦̀adhlsuᅋ㡸㡽፲㢑㢠ownáᎳarpoonĀlr㢈㢌efô㠭ighô㠯iƀ;hl㢙㢚㢜䏅»ᏺon»㢚parrows;懈ƀcit㢰㣄㣈ɯ㢶\0\0㣁rnĀ;e㢼㢽挝r»㢽op;挎ng;䅯ri;旹cr;쀀𝓊ƀdir㣙㣝㣢ot;拰lde;䅩iĀ;f㜰㣨»᠓Āam㣯㣲rò㢨l耻ü䃼angle;榧ހABDacdeflnoprsz㤜㤟㤩㤭㦵㦸㦽㧟㧤㧨㧳㧹㧽㨁㨠ròϷarĀ;v㤦㤧櫨;櫩asèϡĀnr㤲㤷grt;榜΀eknprst㓣㥆㥋㥒㥝㥤㦖appá␕othinçẖƀhir㓫⻈㥙opô⾵Ā;hᎷ㥢ïㆍĀiu㥩㥭gmá㎳Ābp㥲㦄setneqĀ;q㥽㦀쀀⊊︀;쀀⫋︀setneqĀ;q㦏㦒쀀⊋︀;쀀⫌︀Āhr㦛㦟etá㚜iangleĀlr㦪㦯eft»थight»ၑy;䐲ash»ံƀelr㧄㧒㧗ƀ;beⷪ㧋㧏ar;抻q;扚lip;拮Ābt㧜ᑨaòᑩr;쀀𝔳tré㦮suĀbp㧯㧱»ജ»൙pf;쀀𝕧roð໻tré㦴Ācu㨆㨋r;쀀𝓋Ābp㨐㨘nĀEe㦀㨖»㥾nĀEe㦒㨞»㦐igzag;榚΀cefoprs㨶㨻㩖㩛㩔㩡㩪irc;䅵Ādi㩀㩑Ābg㩅㩉ar;機eĀ;qᗺ㩏;扙erp;愘r;쀀𝔴pf;쀀𝕨Ā;eᑹ㩦atèᑹcr;쀀𝓌ૣណ㪇\0㪋\0㪐㪛\0\0㪝㪨㪫㪯\0\0㫃㫎\0㫘ៜ៟tré៑r;쀀𝔵ĀAa㪔㪗ròσrò৶;䎾ĀAa㪡㪤ròθrò৫að✓is;拻ƀdptឤ㪵㪾Āfl㪺ឩ;쀀𝕩imåឲĀAa㫇㫊ròώròਁĀcq㫒ីr;쀀𝓍Āpt៖㫜ré។Ѐacefiosu㫰㫽㬈㬌㬑㬕㬛㬡cĀuy㫶㫻te耻ý䃽;䑏Āiy㬂㬆rc;䅷;䑋n耻¥䂥r;쀀𝔶cy;䑗pf;쀀𝕪cr;쀀𝓎Ācm㬦㬩y;䑎l耻ÿ䃿Ԁacdefhiosw㭂㭈㭔㭘㭤㭩㭭㭴㭺㮀cute;䅺Āay㭍㭒ron;䅾;䐷ot;䅼Āet㭝㭡træᕟa;䎶r;쀀𝔷cy;䐶grarr;懝pf;쀀𝕫cr;쀀𝓏Ājn㮅㮇;怍j;怌'.split("").map(i=>i.charCodeAt(0))),Af=new Uint16Array("Ȁaglq	\x1Bɭ\0\0p;䀦os;䀧t;䀾t;䀼uot;䀢".split("").map(i=>i.charCodeAt(0)));var ls;const kf=new Map([[0,65533],[128,8364],[130,8218],[131,402],[132,8222],[133,8230],[134,8224],[135,8225],[136,710],[137,8240],[138,352],[139,8249],[140,338],[142,381],[145,8216],[146,8217],[147,8220],[148,8221],[149,8226],[150,8211],[151,8212],[152,732],[153,8482],[154,353],[155,8250],[156,339],[158,382],[159,376]]),Tf=(ls=String.fromCodePoint)!==null&&ls!==void 0?ls:function(i){let e="";return i>65535&&(i-=65536,e+=String.fromCharCode(i>>>10&1023|55296),i=56320|i&1023),e+=String.fromCharCode(i),e};function Sf(i){var e;return i>=55296&&i<=57343||i>1114111?65533:(e=kf.get(i))!==null&&e!==void 0?e:i}var bt;(function(i){i[i.NUM=35]="NUM",i[i.SEMI=59]="SEMI",i[i.EQUALS=61]="EQUALS",i[i.ZERO=48]="ZERO",i[i.NINE=57]="NINE",i[i.LOWER_A=97]="LOWER_A",i[i.LOWER_F=102]="LOWER_F",i[i.LOWER_X=120]="LOWER_X",i[i.LOWER_Z=122]="LOWER_Z",i[i.UPPER_A=65]="UPPER_A",i[i.UPPER_F=70]="UPPER_F",i[i.UPPER_Z=90]="UPPER_Z"})(bt||(bt={}));const Mf=32;var Oi;(function(i){i[i.VALUE_LENGTH=49152]="VALUE_LENGTH",i[i.BRANCH_LENGTH=16256]="BRANCH_LENGTH",i[i.JUMP_TABLE=127]="JUMP_TABLE"})(Oi||(Oi={}));function qs(i){return i>=bt.ZERO&&i<=bt.NINE}function Lf(i){return i>=bt.UPPER_A&&i<=bt.UPPER_F||i>=bt.LOWER_A&&i<=bt.LOWER_F}function Df(i){return i>=bt.UPPER_A&&i<=bt.UPPER_Z||i>=bt.LOWER_A&&i<=bt.LOWER_Z||qs(i)}function Bf(i){return i===bt.EQUALS||Df(i)}var gt;(function(i){i[i.EntityStart=0]="EntityStart",i[i.NumericStart=1]="NumericStart",i[i.NumericDecimal=2]="NumericDecimal",i[i.NumericHex=3]="NumericHex",i[i.NamedEntity=4]="NamedEntity"})(gt||(gt={}));var Ii;(function(i){i[i.Legacy=0]="Legacy",i[i.Strict=1]="Strict",i[i.Attribute=2]="Attribute"})(Ii||(Ii={}));class Ff{constructor(e,t,n){this.decodeTree=e,this.emitCodePoint=t,this.errors=n,this.state=gt.EntityStart,this.consumed=1,this.result=0,this.treeIndex=0,this.excess=1,this.decodeMode=Ii.Strict}startEntity(e){this.decodeMode=e,this.state=gt.EntityStart,this.result=0,this.treeIndex=0,this.excess=1,this.consumed=1}write(e,t){switch(this.state){case gt.EntityStart:return e.charCodeAt(t)===bt.NUM?(this.state=gt.NumericStart,this.consumed+=1,this.stateNumericStart(e,t+1)):(this.state=gt.NamedEntity,this.stateNamedEntity(e,t));case gt.NumericStart:return this.stateNumericStart(e,t);case gt.NumericDecimal:return this.stateNumericDecimal(e,t);case gt.NumericHex:return this.stateNumericHex(e,t);case gt.NamedEntity:return this.stateNamedEntity(e,t)}}stateNumericStart(e,t){return t>=e.length?-1:(e.charCodeAt(t)|Mf)===bt.LOWER_X?(this.state=gt.NumericHex,this.consumed+=1,this.stateNumericHex(e,t+1)):(this.state=gt.NumericDecimal,this.stateNumericDecimal(e,t))}addToNumericResult(e,t,n,r){if(t!==n){const a=n-t;this.result=this.result*Math.pow(r,a)+parseInt(e.substr(t,a),r),this.consumed+=a}}stateNumericHex(e,t){const n=t;for(;t<e.length;){const r=e.charCodeAt(t);if(qs(r)||Lf(r))t+=1;else return this.addToNumericResult(e,n,t,16),this.emitNumericEntity(r,3)}return this.addToNumericResult(e,n,t,16),-1}stateNumericDecimal(e,t){const n=t;for(;t<e.length;){const r=e.charCodeAt(t);if(qs(r))t+=1;else return this.addToNumericResult(e,n,t,10),this.emitNumericEntity(r,2)}return this.addToNumericResult(e,n,t,10),-1}emitNumericEntity(e,t){var n;if(this.consumed<=t)return(n=this.errors)===null||n===void 0||n.absenceOfDigitsInNumericCharacterReference(this.consumed),0;if(e===bt.SEMI)this.consumed+=1;else if(this.decodeMode===Ii.Strict)return 0;return this.emitCodePoint(Sf(this.result),this.consumed),this.errors&&(e!==bt.SEMI&&this.errors.missingSemicolonAfterCharacterReference(),this.errors.validateNumericCharacterReference(this.result)),this.consumed}stateNamedEntity(e,t){const{decodeTree:n}=this;let r=n[this.treeIndex],a=(r&Oi.VALUE_LENGTH)>>14;for(;t<e.length;t++,this.excess++){const s=e.charCodeAt(t);if(this.treeIndex=If(n,r,this.treeIndex+Math.max(1,a),s),this.treeIndex<0)return this.result===0||this.decodeMode===Ii.Attribute&&(a===0||Bf(s))?0:this.emitNotTerminatedNamedEntity();if(r=n[this.treeIndex],a=(r&Oi.VALUE_LENGTH)>>14,a!==0){if(s===bt.SEMI)return this.emitNamedEntityData(this.treeIndex,a,this.consumed+this.excess);this.decodeMode!==Ii.Strict&&(this.result=this.treeIndex,this.consumed+=this.excess,this.excess=0)}}return-1}emitNotTerminatedNamedEntity(){var e;const{result:t,decodeTree:n}=this,r=(n[t]&Oi.VALUE_LENGTH)>>14;return this.emitNamedEntityData(t,r,this.consumed),(e=this.errors)===null||e===void 0||e.missingSemicolonAfterCharacterReference(),this.consumed}emitNamedEntityData(e,t,n){const{decodeTree:r}=this;return this.emitCodePoint(t===1?r[e]&~Oi.VALUE_LENGTH:r[e+1],n),t===3&&this.emitCodePoint(r[e+2],n),n}end(){var e;switch(this.state){case gt.NamedEntity:return this.result!==0&&(this.decodeMode!==Ii.Attribute||this.result===this.treeIndex)?this.emitNotTerminatedNamedEntity():0;case gt.NumericDecimal:return this.emitNumericEntity(0,2);case gt.NumericHex:return this.emitNumericEntity(0,3);case gt.NumericStart:return(e=this.errors)===null||e===void 0||e.absenceOfDigitsInNumericCharacterReference(this.consumed),0;case gt.EntityStart:return 0}}}function xu(i){let e="";const t=new Ff(i,n=>e+=Tf(n));return function(r,a){let s=0,o=0;for(;(o=r.indexOf("&",o))>=0;){e+=r.slice(s,o),t.startEntity(a);const u=t.write(r,o+1);if(u<0){s=o+t.end();break}s=o+u,o=u===0?s+1:s}const l=e+r.slice(s);return e="",l}}function If(i,e,t,n){const r=(e&Oi.BRANCH_LENGTH)>>7,a=e&Oi.JUMP_TABLE;if(r===0)return a!==0&&n===a?t:-1;if(a){const l=n-a;return l<0||l>=r?-1:i[t+l]-1}let s=t,o=s+r-1;for(;s<=o;){const l=s+o>>>1,u=i[l];if(u<n)s=l+1;else if(u>n)o=l-1;else return i[l+r]}return-1}const Pf=xu(_f);xu(Af);function Eu(i,e=Ii.Legacy){return Pf(i,e)}function Rf(i){return Object.prototype.toString.call(i)}function xo(i){return Rf(i)==="[object String]"}const Of=Object.prototype.hasOwnProperty;function Nf(i,e){return Of.call(i,e)}function na(i){return Array.prototype.slice.call(arguments,1).forEach(function(t){if(t){if(typeof t!="object")throw new TypeError(t+"must be object");Object.keys(t).forEach(function(n){i[n]=t[n]})}}),i}function Cu(i,e,t){return[].concat(i.slice(0,e),t,i.slice(e+1))}function Eo(i){return!(i>=55296&&i<=57343||i>=64976&&i<=65007||(i&65535)===65535||(i&65535)===65534||i>=0&&i<=8||i===11||i>=14&&i<=31||i>=127&&i<=159||i>1114111)}function zr(i){if(i>65535){i-=65536;const e=55296+(i>>10),t=56320+(i&1023);return String.fromCharCode(e,t)}return String.fromCharCode(i)}const _u=/\\([!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~])/g,Hf=/&([a-z#][a-z0-9]{1,31});/gi,zf=new RegExp(_u.source+"|"+Hf.source,"gi"),Vf=/^#((?:x[a-f0-9]{1,8}|[0-9]{1,8}))$/i;function Uf(i,e){if(e.charCodeAt(0)===35&&Vf.test(e)){const n=e[1].toLowerCase()==="x"?parseInt(e.slice(2),16):parseInt(e.slice(1),10);return Eo(n)?zr(n):i}const t=Eu(i);return t!==i?t:i}function Wf(i){return i.indexOf("\\")<0?i:i.replace(_u,"$1")}function _n(i){return i.indexOf("\\")<0&&i.indexOf("&")<0?i:i.replace(zf,function(e,t,n){return t||Uf(e,n)})}const Gf=/[&<>"]/,qf=/[&<>"]/g,jf={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};function $f(i){return jf[i]}function zi(i){return Gf.test(i)?i.replace(qf,$f):i}const Yf=/[.?*+^$[\]\\(){}|-]/g;function Kf(i){return i.replace(Yf,"\\$&")}function Je(i){switch(i){case 9:case 32:return!0}return!1}function tr(i){if(i>=8192&&i<=8202)return!0;switch(i){case 9:case 10:case 11:case 12:case 13:case 32:case 160:case 5760:case 8239:case 8287:case 12288:return!0}return!1}function ir(i){return vo.test(i)||wu.test(i)}function nr(i){switch(i){case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 58:case 59:case 60:case 61:case 62:case 63:case 64:case 91:case 92:case 93:case 94:case 95:case 96:case 123:case 124:case 125:case 126:return!0;default:return!1}}function ra(i){return i=i.trim().replace(/\s+/g," "),"ẞ".toLowerCase()==="Ṿ"&&(i=i.replace(/ẞ/g,"ß")),i.toLowerCase().toUpperCase()}const Xf={mdurl:xf,ucmicro:Cf},Zf=Object.freeze(Object.defineProperty({__proto__:null,arrayReplaceAt:Cu,assign:na,escapeHtml:zi,escapeRE:Kf,fromCodePoint:zr,has:Nf,isMdAsciiPunct:nr,isPunctChar:ir,isSpace:Je,isString:xo,isValidEntityCode:Eo,isWhiteSpace:tr,lib:Xf,normalizeReference:ra,unescapeAll:_n,unescapeMd:Wf},Symbol.toStringTag,{value:"Module"}));function Qf(i,e,t){let n,r,a,s;const o=i.posMax,l=i.pos;for(i.pos=e+1,n=1;i.pos<o;){if(a=i.src.charCodeAt(i.pos),a===93&&(n--,n===0)){r=!0;break}if(s=i.pos,i.md.inline.skipToken(i),a===91){if(s===i.pos-1)n++;else if(t)return i.pos=l,-1}}let u=-1;return r&&(u=i.pos),i.pos=l,u}function Jf(i,e,t){let n,r=e;const a={ok:!1,pos:0,str:""};if(i.charCodeAt(r)===60){for(r++;r<t;){if(n=i.charCodeAt(r),n===10||n===60)return a;if(n===62)return a.pos=r+1,a.str=_n(i.slice(e+1,r)),a.ok=!0,a;if(n===92&&r+1<t){r+=2;continue}r++}return a}let s=0;for(;r<t&&(n=i.charCodeAt(r),!(n===32||n<32||n===127));){if(n===92&&r+1<t){if(i.charCodeAt(r+1)===32)break;r+=2;continue}if(n===40&&(s++,s>32))return a;if(n===41){if(s===0)break;s--}r++}return e===r||s!==0||(a.str=_n(i.slice(e,r)),a.pos=r,a.ok=!0),a}function ep(i,e,t,n){let r,a=e;const s={ok:!1,can_continue:!1,pos:0,str:"",marker:0};if(n)s.str=n.str,s.marker=n.marker;else{if(a>=t)return s;let o=i.charCodeAt(a);if(o!==34&&o!==39&&o!==40)return s;e++,a++,o===40&&(o=41),s.marker=o}for(;a<t;){if(r=i.charCodeAt(a),r===s.marker)return s.pos=a+1,s.str+=_n(i.slice(e,a)),s.ok=!0,s;if(r===40&&s.marker===41)return s;r===92&&a+1<t&&a++,a++}return s.can_continue=!0,s.str+=_n(i.slice(e,a)),s}const tp=Object.freeze(Object.defineProperty({__proto__:null,parseLinkDestination:Jf,parseLinkLabel:Qf,parseLinkTitle:ep},Symbol.toStringTag,{value:"Module"})),bi={};bi.code_inline=function(i,e,t,n,r){const a=i[e];return"<code"+r.renderAttrs(a)+">"+zi(a.content)+"</code>"};bi.code_block=function(i,e,t,n,r){const a=i[e];return"<pre"+r.renderAttrs(a)+"><code>"+zi(i[e].content)+`</code></pre>
`};bi.fence=function(i,e,t,n,r){const a=i[e],s=a.info?_n(a.info).trim():"";let o="",l="";if(s){const f=s.split(/(\s+)/g);o=f[0],l=f.slice(2).join("")}let u;if(t.highlight?u=t.highlight(a.content,o,l)||zi(a.content):u=zi(a.content),u.indexOf("<pre")===0)return u+`
`;if(s){const f=a.attrIndex("class"),c=a.attrs?a.attrs.slice():[];f<0?c.push(["class",t.langPrefix+o]):(c[f]=c[f].slice(),c[f][1]+=" "+t.langPrefix+o);const d={attrs:c};return`<pre><code${r.renderAttrs(d)}>${u}</code></pre>
`}return`<pre><code${r.renderAttrs(a)}>${u}</code></pre>
`};bi.image=function(i,e,t,n,r){const a=i[e];return a.attrs[a.attrIndex("alt")][1]=r.renderInlineAsText(a.children,t,n),r.renderToken(i,e,t)};bi.hardbreak=function(i,e,t){return t.xhtmlOut?`<br />
`:`<br>
`};bi.softbreak=function(i,e,t){return t.breaks?t.xhtmlOut?`<br />
`:`<br>
`:`
`};bi.text=function(i,e){return zi(i[e].content)};bi.html_block=function(i,e){return i[e].content};bi.html_inline=function(i,e){return i[e].content};function Tn(){this.rules=na({},bi)}Tn.prototype.renderAttrs=function(e){let t,n,r;if(!e.attrs)return"";for(r="",t=0,n=e.attrs.length;t<n;t++)r+=" "+zi(e.attrs[t][0])+'="'+zi(e.attrs[t][1])+'"';return r};Tn.prototype.renderToken=function(e,t,n){const r=e[t];let a="";if(r.hidden)return"";r.block&&r.nesting!==-1&&t&&e[t-1].hidden&&(a+=`
`),a+=(r.nesting===-1?"</":"<")+r.tag,a+=this.renderAttrs(r),r.nesting===0&&n.xhtmlOut&&(a+=" /");let s=!1;if(r.block&&(s=!0,r.nesting===1&&t+1<e.length)){const o=e[t+1];(o.type==="inline"||o.hidden||o.nesting===-1&&o.tag===r.tag)&&(s=!1)}return a+=s?`>
`:">",a};Tn.prototype.renderInline=function(i,e,t){let n="";const r=this.rules;for(let a=0,s=i.length;a<s;a++){const o=i[a].type;typeof r[o]<"u"?n+=r[o](i,a,e,t,this):n+=this.renderToken(i,a,e)}return n};Tn.prototype.renderInlineAsText=function(i,e,t){let n="";for(let r=0,a=i.length;r<a;r++)switch(i[r].type){case"text":n+=i[r].content;break;case"image":n+=this.renderInlineAsText(i[r].children,e,t);break;case"html_inline":case"html_block":n+=i[r].content;break;case"softbreak":case"hardbreak":n+=`
`;break}return n};Tn.prototype.render=function(i,e,t){let n="";const r=this.rules;for(let a=0,s=i.length;a<s;a++){const o=i[a].type;o==="inline"?n+=this.renderInline(i[a].children,e,t):typeof r[o]<"u"?n+=r[o](i,a,e,t,this):n+=this.renderToken(i,a,e,t)}return n};function Bt(){this.__rules__=[],this.__cache__=null}Bt.prototype.__find__=function(i){for(let e=0;e<this.__rules__.length;e++)if(this.__rules__[e].name===i)return e;return-1};Bt.prototype.__compile__=function(){const i=this,e=[""];i.__rules__.forEach(function(t){t.enabled&&t.alt.forEach(function(n){e.indexOf(n)<0&&e.push(n)})}),i.__cache__={},e.forEach(function(t){i.__cache__[t]=[],i.__rules__.forEach(function(n){n.enabled&&(t&&n.alt.indexOf(t)<0||i.__cache__[t].push(n.fn))})})};Bt.prototype.at=function(i,e,t){const n=this.__find__(i),r=t||{};if(n===-1)throw new Error("Parser rule not found: "+i);this.__rules__[n].fn=e,this.__rules__[n].alt=r.alt||[],this.__cache__=null};Bt.prototype.before=function(i,e,t,n){const r=this.__find__(i),a=n||{};if(r===-1)throw new Error("Parser rule not found: "+i);this.__rules__.splice(r,0,{name:e,enabled:!0,fn:t,alt:a.alt||[]}),this.__cache__=null};Bt.prototype.after=function(i,e,t,n){const r=this.__find__(i),a=n||{};if(r===-1)throw new Error("Parser rule not found: "+i);this.__rules__.splice(r+1,0,{name:e,enabled:!0,fn:t,alt:a.alt||[]}),this.__cache__=null};Bt.prototype.push=function(i,e,t){const n=t||{};this.__rules__.push({name:i,enabled:!0,fn:e,alt:n.alt||[]}),this.__cache__=null};Bt.prototype.enable=function(i,e){Array.isArray(i)||(i=[i]);const t=[];return i.forEach(function(n){const r=this.__find__(n);if(r<0){if(e)return;throw new Error("Rules manager: invalid rule name "+n)}this.__rules__[r].enabled=!0,t.push(n)},this),this.__cache__=null,t};Bt.prototype.enableOnly=function(i,e){Array.isArray(i)||(i=[i]),this.__rules__.forEach(function(t){t.enabled=!1}),this.enable(i,e)};Bt.prototype.disable=function(i,e){Array.isArray(i)||(i=[i]);const t=[];return i.forEach(function(n){const r=this.__find__(n);if(r<0){if(e)return;throw new Error("Rules manager: invalid rule name "+n)}this.__rules__[r].enabled=!1,t.push(n)},this),this.__cache__=null,t};Bt.prototype.getRules=function(i){return this.__cache__===null&&this.__compile__(),this.__cache__[i]||[]};function si(i,e,t){this.type=i,this.tag=e,this.attrs=null,this.map=null,this.nesting=t,this.level=0,this.children=null,this.content="",this.markup="",this.info="",this.meta=null,this.block=!1,this.hidden=!1}si.prototype.attrIndex=function(e){if(!this.attrs)return-1;const t=this.attrs;for(let n=0,r=t.length;n<r;n++)if(t[n][0]===e)return n;return-1};si.prototype.attrPush=function(e){this.attrs?this.attrs.push(e):this.attrs=[e]};si.prototype.attrSet=function(e,t){const n=this.attrIndex(e),r=[e,t];n<0?this.attrPush(r):this.attrs[n]=r};si.prototype.attrGet=function(e){const t=this.attrIndex(e);let n=null;return t>=0&&(n=this.attrs[t][1]),n};si.prototype.attrJoin=function(e,t){const n=this.attrIndex(e);n<0?this.attrPush([e,t]):this.attrs[n][1]=this.attrs[n][1]+" "+t};function Au(i,e,t){this.src=i,this.env=t,this.tokens=[],this.inlineMode=!1,this.md=e}Au.prototype.Token=si;const ip=/\r\n?|\n/g,np=/\0/g;function rp(i){let e;e=i.src.replace(ip,`
`),e=e.replace(np,"�"),i.src=e}function ap(i){let e;i.inlineMode?(e=new i.Token("inline","",0),e.content=i.src,e.map=[0,1],e.children=[],i.tokens.push(e)):i.md.block.parse(i.src,i.md,i.env,i.tokens)}function sp(i){const e=i.tokens;for(let t=0,n=e.length;t<n;t++){const r=e[t];r.type==="inline"&&i.md.inline.parse(r.content,i.md,i.env,r.children)}}function op(i){return/^<a[>\s]/i.test(i)}function lp(i){return/^<\/a\s*>/i.test(i)}function cp(i){const e=i.tokens;if(i.md.options.linkify)for(let t=0,n=e.length;t<n;t++){if(e[t].type!=="inline"||!i.md.linkify.pretest(e[t].content))continue;let r=e[t].children,a=0;for(let s=r.length-1;s>=0;s--){const o=r[s];if(o.type==="link_close"){for(s--;r[s].level!==o.level&&r[s].type!=="link_open";)s--;continue}if(o.type==="html_inline"&&(op(o.content)&&a>0&&a--,lp(o.content)&&a++),!(a>0)&&o.type==="text"&&i.md.linkify.test(o.content)){const l=o.content;let u=i.md.linkify.match(l);const f=[];let c=o.level,d=0;u.length>0&&u[0].index===0&&s>0&&r[s-1].type==="text_special"&&(u=u.slice(1));for(let h=0;h<u.length;h++){const p=u[h].url,m=i.md.normalizeLink(p);if(!i.md.validateLink(m))continue;let g=u[h].text;u[h].schema?u[h].schema==="mailto:"&&!/^mailto:/i.test(g)?g=i.md.normalizeLinkText("mailto:"+g).replace(/^mailto:/,""):g=i.md.normalizeLinkText(g):g=i.md.normalizeLinkText("http://"+g).replace(/^http:\/\//,"");const y=u[h].index;if(y>d){const C=new i.Token("text","",0);C.content=l.slice(d,y),C.level=c,f.push(C)}const x=new i.Token("link_open","a",1);x.attrs=[["href",m]],x.level=c++,x.markup="linkify",x.info="auto",f.push(x);const w=new i.Token("text","",0);w.content=g,w.level=c,f.push(w);const _=new i.Token("link_close","a",-1);_.level=--c,_.markup="linkify",_.info="auto",f.push(_),d=u[h].lastIndex}if(d<l.length){const h=new i.Token("text","",0);h.content=l.slice(d),h.level=c,f.push(h)}e[t].children=r=Cu(r,s,f)}}}}const ku=/\+-|\.\.|\?\?\?\?|!!!!|,,|--/,up=/\((c|tm|r)\)/i,dp=/\((c|tm|r)\)/ig,hp={c:"©",r:"®",tm:"™"};function fp(i,e){return hp[e.toLowerCase()]}function pp(i){let e=0;for(let t=i.length-1;t>=0;t--){const n=i[t];n.type==="text"&&!e&&(n.content=n.content.replace(dp,fp)),n.type==="link_open"&&n.info==="auto"&&e--,n.type==="link_close"&&n.info==="auto"&&e++}}function mp(i){let e=0;for(let t=i.length-1;t>=0;t--){const n=i[t];n.type==="text"&&!e&&ku.test(n.content)&&(n.content=n.content.replace(/\+-/g,"±").replace(/\.{2,}/g,"…").replace(/([?!])…/g,"$1..").replace(/([?!]){4,}/g,"$1$1$1").replace(/,{2,}/g,",").replace(/(^|[^-])---(?=[^-]|$)/mg,"$1—").replace(/(^|\s)--(?=\s|$)/mg,"$1–").replace(/(^|[^-\s])--(?=[^-\s]|$)/mg,"$1–")),n.type==="link_open"&&n.info==="auto"&&e--,n.type==="link_close"&&n.info==="auto"&&e++}}function gp(i){let e;if(i.md.options.typographer)for(e=i.tokens.length-1;e>=0;e--)i.tokens[e].type==="inline"&&(up.test(i.tokens[e].content)&&pp(i.tokens[e].children),ku.test(i.tokens[e].content)&&mp(i.tokens[e].children))}const bp=/['"]/,Kl=/['"]/g,Xl="’";function mr(i,e,t){return i.slice(0,e)+t+i.slice(e+1)}function yp(i,e){let t;const n=[];for(let r=0;r<i.length;r++){const a=i[r],s=i[r].level;for(t=n.length-1;t>=0&&!(n[t].level<=s);t--);if(n.length=t+1,a.type!=="text")continue;let o=a.content,l=0,u=o.length;e:for(;l<u;){Kl.lastIndex=l;const f=Kl.exec(o);if(!f)break;let c=!0,d=!0;l=f.index+1;const h=f[0]==="'";let p=32;if(f.index-1>=0)p=o.charCodeAt(f.index-1);else for(t=r-1;t>=0&&!(i[t].type==="softbreak"||i[t].type==="hardbreak");t--)if(i[t].content){p=i[t].content.charCodeAt(i[t].content.length-1);break}let m=32;if(l<u)m=o.charCodeAt(l);else for(t=r+1;t<i.length&&!(i[t].type==="softbreak"||i[t].type==="hardbreak");t++)if(i[t].content){m=i[t].content.charCodeAt(0);break}const g=nr(p)||ir(String.fromCharCode(p)),y=nr(m)||ir(String.fromCharCode(m)),x=tr(p),w=tr(m);if(w?c=!1:y&&(x||g||(c=!1)),x?d=!1:g&&(w||y||(d=!1)),m===34&&f[0]==='"'&&p>=48&&p<=57&&(d=c=!1),c&&d&&(c=g,d=y),!c&&!d){h&&(a.content=mr(a.content,f.index,Xl));continue}if(d)for(t=n.length-1;t>=0;t--){let _=n[t];if(n[t].level<s)break;if(_.single===h&&n[t].level===s){_=n[t];let C,F;h?(C=e.md.options.quotes[2],F=e.md.options.quotes[3]):(C=e.md.options.quotes[0],F=e.md.options.quotes[1]),a.content=mr(a.content,f.index,F),i[_.token].content=mr(i[_.token].content,_.pos,C),l+=F.length-1,_.token===r&&(l+=C.length-1),o=a.content,u=o.length,n.length=t;continue e}}c?n.push({token:r,pos:f.index,single:h,level:s}):d&&h&&(a.content=mr(a.content,f.index,Xl))}}}function wp(i){if(i.md.options.typographer)for(let e=i.tokens.length-1;e>=0;e--)i.tokens[e].type!=="inline"||!bp.test(i.tokens[e].content)||yp(i.tokens[e].children,i)}function vp(i){let e,t;const n=i.tokens,r=n.length;for(let a=0;a<r;a++){if(n[a].type!=="inline")continue;const s=n[a].children,o=s.length;for(e=0;e<o;e++)s[e].type==="text_special"&&(s[e].type="text");for(e=t=0;e<o;e++)s[e].type==="text"&&e+1<o&&s[e+1].type==="text"?s[e+1].content=s[e].content+s[e+1].content:(e!==t&&(s[t]=s[e]),t++);e!==t&&(s.length=t)}}const cs=[["normalize",rp],["block",ap],["inline",sp],["linkify",cp],["replacements",gp],["smartquotes",wp],["text_join",vp]];function Co(){this.ruler=new Bt;for(let i=0;i<cs.length;i++)this.ruler.push(cs[i][0],cs[i][1])}Co.prototype.process=function(i){const e=this.ruler.getRules("");for(let t=0,n=e.length;t<n;t++)e[t](i)};Co.prototype.State=Au;function yi(i,e,t,n){this.src=i,this.md=e,this.env=t,this.tokens=n,this.bMarks=[],this.eMarks=[],this.tShift=[],this.sCount=[],this.bsCount=[],this.blkIndent=0,this.line=0,this.lineMax=0,this.tight=!1,this.ddIndent=-1,this.listIndent=-1,this.parentType="root",this.level=0;const r=this.src;for(let a=0,s=0,o=0,l=0,u=r.length,f=!1;s<u;s++){const c=r.charCodeAt(s);if(!f)if(Je(c)){o++,c===9?l+=4-l%4:l++;continue}else f=!0;(c===10||s===u-1)&&(c!==10&&s++,this.bMarks.push(a),this.eMarks.push(s),this.tShift.push(o),this.sCount.push(l),this.bsCount.push(0),f=!1,o=0,l=0,a=s+1)}this.bMarks.push(r.length),this.eMarks.push(r.length),this.tShift.push(0),this.sCount.push(0),this.bsCount.push(0),this.lineMax=this.bMarks.length-1}yi.prototype.push=function(i,e,t){const n=new si(i,e,t);return n.block=!0,t<0&&this.level--,n.level=this.level,t>0&&this.level++,this.tokens.push(n),n};yi.prototype.isEmpty=function(e){return this.bMarks[e]+this.tShift[e]>=this.eMarks[e]};yi.prototype.skipEmptyLines=function(e){for(let t=this.lineMax;e<t&&!(this.bMarks[e]+this.tShift[e]<this.eMarks[e]);e++);return e};yi.prototype.skipSpaces=function(e){for(let t=this.src.length;e<t;e++){const n=this.src.charCodeAt(e);if(!Je(n))break}return e};yi.prototype.skipSpacesBack=function(e,t){if(e<=t)return e;for(;e>t;)if(!Je(this.src.charCodeAt(--e)))return e+1;return e};yi.prototype.skipChars=function(e,t){for(let n=this.src.length;e<n&&this.src.charCodeAt(e)===t;e++);return e};yi.prototype.skipCharsBack=function(e,t,n){if(e<=n)return e;for(;e>n;)if(t!==this.src.charCodeAt(--e))return e+1;return e};yi.prototype.getLines=function(e,t,n,r){if(e>=t)return"";const a=new Array(t-e);for(let s=0,o=e;o<t;o++,s++){let l=0;const u=this.bMarks[o];let f=u,c;for(o+1<t||r?c=this.eMarks[o]+1:c=this.eMarks[o];f<c&&l<n;){const d=this.src.charCodeAt(f);if(Je(d))d===9?l+=4-(l+this.bsCount[o])%4:l++;else if(f-u<this.tShift[o])l++;else break;f++}l>n?a[s]=new Array(l-n+1).join(" ")+this.src.slice(f,c):a[s]=this.src.slice(f,c)}return a.join("")};yi.prototype.Token=si;const xp=65536;function us(i,e){const t=i.bMarks[e]+i.tShift[e],n=i.eMarks[e];return i.src.slice(t,n)}function Zl(i){const e=[],t=i.length;let n=0,r=i.charCodeAt(n),a=!1,s=0,o="";for(;n<t;)r===124&&(a?(o+=i.substring(s,n-1),s=n):(e.push(o+i.substring(s,n)),o="",s=n+1)),a=r===92,n++,r=i.charCodeAt(n);return e.push(o+i.substring(s)),e}function Ep(i,e,t,n){if(e+2>t)return!1;let r=e+1;if(i.sCount[r]<i.blkIndent||i.sCount[r]-i.blkIndent>=4)return!1;let a=i.bMarks[r]+i.tShift[r];if(a>=i.eMarks[r])return!1;const s=i.src.charCodeAt(a++);if(s!==124&&s!==45&&s!==58||a>=i.eMarks[r])return!1;const o=i.src.charCodeAt(a++);if(o!==124&&o!==45&&o!==58&&!Je(o)||s===45&&Je(o))return!1;for(;a<i.eMarks[r];){const _=i.src.charCodeAt(a);if(_!==124&&_!==45&&_!==58&&!Je(_))return!1;a++}let l=us(i,e+1),u=l.split("|");const f=[];for(let _=0;_<u.length;_++){const C=u[_].trim();if(!C){if(_===0||_===u.length-1)continue;return!1}if(!/^:?-+:?$/.test(C))return!1;C.charCodeAt(C.length-1)===58?f.push(C.charCodeAt(0)===58?"center":"right"):C.charCodeAt(0)===58?f.push("left"):f.push("")}if(l=us(i,e).trim(),l.indexOf("|")===-1||i.sCount[e]-i.blkIndent>=4)return!1;u=Zl(l),u.length&&u[0]===""&&u.shift(),u.length&&u[u.length-1]===""&&u.pop();const c=u.length;if(c===0||c!==f.length)return!1;if(n)return!0;const d=i.parentType;i.parentType="table";const h=i.md.block.ruler.getRules("blockquote"),p=i.push("table_open","table",1),m=[e,0];p.map=m;const g=i.push("thead_open","thead",1);g.map=[e,e+1];const y=i.push("tr_open","tr",1);y.map=[e,e+1];for(let _=0;_<u.length;_++){const C=i.push("th_open","th",1);f[_]&&(C.attrs=[["style","text-align:"+f[_]]]);const F=i.push("inline","",0);F.content=u[_].trim(),F.children=[],i.push("th_close","th",-1)}i.push("tr_close","tr",-1),i.push("thead_close","thead",-1);let x,w=0;for(r=e+2;r<t&&!(i.sCount[r]<i.blkIndent);r++){let _=!1;for(let F=0,T=h.length;F<T;F++)if(h[F](i,r,t,!0)){_=!0;break}if(_||(l=us(i,r).trim(),!l)||i.sCount[r]-i.blkIndent>=4||(u=Zl(l),u.length&&u[0]===""&&u.shift(),u.length&&u[u.length-1]===""&&u.pop(),w+=c-u.length,w>xp))break;if(r===e+2){const F=i.push("tbody_open","tbody",1);F.map=x=[e+2,0]}const C=i.push("tr_open","tr",1);C.map=[r,r+1];for(let F=0;F<c;F++){const T=i.push("td_open","td",1);f[F]&&(T.attrs=[["style","text-align:"+f[F]]]);const R=i.push("inline","",0);R.content=u[F]?u[F].trim():"",R.children=[],i.push("td_close","td",-1)}i.push("tr_close","tr",-1)}return x&&(i.push("tbody_close","tbody",-1),x[1]=r),i.push("table_close","table",-1),m[1]=r,i.parentType=d,i.line=r,!0}function Cp(i,e,t){if(i.sCount[e]-i.blkIndent<4)return!1;let n=e+1,r=n;for(;n<t;){if(i.isEmpty(n)){n++;continue}if(i.sCount[n]-i.blkIndent>=4){n++,r=n;continue}break}i.line=r;const a=i.push("code_block","code",0);return a.content=i.getLines(e,r,4+i.blkIndent,!1)+`
`,a.map=[e,i.line],!0}function _p(i,e,t,n){let r=i.bMarks[e]+i.tShift[e],a=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4||r+3>a)return!1;const s=i.src.charCodeAt(r);if(s!==126&&s!==96)return!1;let o=r;r=i.skipChars(r,s);let l=r-o;if(l<3)return!1;const u=i.src.slice(o,r),f=i.src.slice(r,a);if(s===96&&f.indexOf(String.fromCharCode(s))>=0)return!1;if(n)return!0;let c=e,d=!1;for(;c++,!(c>=t||(r=o=i.bMarks[c]+i.tShift[c],a=i.eMarks[c],r<a&&i.sCount[c]<i.blkIndent));)if(i.src.charCodeAt(r)===s&&!(i.sCount[c]-i.blkIndent>=4)&&(r=i.skipChars(r,s),!(r-o<l)&&(r=i.skipSpaces(r),!(r<a)))){d=!0;break}l=i.sCount[e],i.line=c+(d?1:0);const h=i.push("fence","code",0);return h.info=f,h.content=i.getLines(e+1,c,l,!0),h.markup=u,h.map=[e,i.line],!0}function Ap(i,e,t,n){let r=i.bMarks[e]+i.tShift[e],a=i.eMarks[e];const s=i.lineMax;if(i.sCount[e]-i.blkIndent>=4||i.src.charCodeAt(r)!==62)return!1;if(n)return!0;const o=[],l=[],u=[],f=[],c=i.md.block.ruler.getRules("blockquote"),d=i.parentType;i.parentType="blockquote";let h=!1,p;for(p=e;p<t;p++){const w=i.sCount[p]<i.blkIndent;if(r=i.bMarks[p]+i.tShift[p],a=i.eMarks[p],r>=a)break;if(i.src.charCodeAt(r++)===62&&!w){let C=i.sCount[p]+1,F,T;i.src.charCodeAt(r)===32?(r++,C++,T=!1,F=!0):i.src.charCodeAt(r)===9?(F=!0,(i.bsCount[p]+C)%4===3?(r++,C++,T=!1):T=!0):F=!1;let R=C;for(o.push(i.bMarks[p]),i.bMarks[p]=r;r<a;){const N=i.src.charCodeAt(r);if(Je(N))N===9?R+=4-(R+i.bsCount[p]+(T?1:0))%4:R++;else break;r++}h=r>=a,l.push(i.bsCount[p]),i.bsCount[p]=i.sCount[p]+1+(F?1:0),u.push(i.sCount[p]),i.sCount[p]=R-C,f.push(i.tShift[p]),i.tShift[p]=r-i.bMarks[p];continue}if(h)break;let _=!1;for(let C=0,F=c.length;C<F;C++)if(c[C](i,p,t,!0)){_=!0;break}if(_){i.lineMax=p,i.blkIndent!==0&&(o.push(i.bMarks[p]),l.push(i.bsCount[p]),f.push(i.tShift[p]),u.push(i.sCount[p]),i.sCount[p]-=i.blkIndent);break}o.push(i.bMarks[p]),l.push(i.bsCount[p]),f.push(i.tShift[p]),u.push(i.sCount[p]),i.sCount[p]=-1}const m=i.blkIndent;i.blkIndent=0;const g=i.push("blockquote_open","blockquote",1);g.markup=">";const y=[e,0];g.map=y,i.md.block.tokenize(i,e,p);const x=i.push("blockquote_close","blockquote",-1);x.markup=">",i.lineMax=s,i.parentType=d,y[1]=i.line;for(let w=0;w<f.length;w++)i.bMarks[w+e]=o[w],i.tShift[w+e]=f[w],i.sCount[w+e]=u[w],i.bsCount[w+e]=l[w];return i.blkIndent=m,!0}function kp(i,e,t,n){const r=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4)return!1;let a=i.bMarks[e]+i.tShift[e];const s=i.src.charCodeAt(a++);if(s!==42&&s!==45&&s!==95)return!1;let o=1;for(;a<r;){const u=i.src.charCodeAt(a++);if(u!==s&&!Je(u))return!1;u===s&&o++}if(o<3)return!1;if(n)return!0;i.line=e+1;const l=i.push("hr","hr",0);return l.map=[e,i.line],l.markup=Array(o+1).join(String.fromCharCode(s)),!0}function Ql(i,e){const t=i.eMarks[e];let n=i.bMarks[e]+i.tShift[e];const r=i.src.charCodeAt(n++);if(r!==42&&r!==45&&r!==43)return-1;if(n<t){const a=i.src.charCodeAt(n);if(!Je(a))return-1}return n}function Jl(i,e){const t=i.bMarks[e]+i.tShift[e],n=i.eMarks[e];let r=t;if(r+1>=n)return-1;let a=i.src.charCodeAt(r++);if(a<48||a>57)return-1;for(;;){if(r>=n)return-1;if(a=i.src.charCodeAt(r++),a>=48&&a<=57){if(r-t>=10)return-1;continue}if(a===41||a===46)break;return-1}return r<n&&(a=i.src.charCodeAt(r),!Je(a))?-1:r}function Tp(i,e){const t=i.level+2;for(let n=e+2,r=i.tokens.length-2;n<r;n++)i.tokens[n].level===t&&i.tokens[n].type==="paragraph_open"&&(i.tokens[n+2].hidden=!0,i.tokens[n].hidden=!0,n+=2)}function Sp(i,e,t,n){let r,a,s,o,l=e,u=!0;if(i.sCount[l]-i.blkIndent>=4||i.listIndent>=0&&i.sCount[l]-i.listIndent>=4&&i.sCount[l]<i.blkIndent)return!1;let f=!1;n&&i.parentType==="paragraph"&&i.sCount[l]>=i.blkIndent&&(f=!0);let c,d,h;if((h=Jl(i,l))>=0){if(c=!0,s=i.bMarks[l]+i.tShift[l],d=Number(i.src.slice(s,h-1)),f&&d!==1)return!1}else if((h=Ql(i,l))>=0)c=!1;else return!1;if(f&&i.skipSpaces(h)>=i.eMarks[l])return!1;if(n)return!0;const p=i.src.charCodeAt(h-1),m=i.tokens.length;c?(o=i.push("ordered_list_open","ol",1),d!==1&&(o.attrs=[["start",d]])):o=i.push("bullet_list_open","ul",1);const g=[l,0];o.map=g,o.markup=String.fromCharCode(p);let y=!1;const x=i.md.block.ruler.getRules("list"),w=i.parentType;for(i.parentType="list";l<t;){a=h,r=i.eMarks[l];const _=i.sCount[l]+h-(i.bMarks[l]+i.tShift[l]);let C=_;for(;a<r;){const S=i.src.charCodeAt(a);if(S===9)C+=4-(C+i.bsCount[l])%4;else if(S===32)C++;else break;a++}const F=a;let T;F>=r?T=1:T=C-_,T>4&&(T=1);const R=_+T;o=i.push("list_item_open","li",1),o.markup=String.fromCharCode(p);const N=[l,0];o.map=N,c&&(o.info=i.src.slice(s,h-1));const j=i.tight,ae=i.tShift[l],L=i.sCount[l],O=i.listIndent;if(i.listIndent=i.blkIndent,i.blkIndent=R,i.tight=!0,i.tShift[l]=F-i.bMarks[l],i.sCount[l]=C,F>=r&&i.isEmpty(l+1)?i.line=Math.min(i.line+2,t):i.md.block.tokenize(i,l,t,!0),(!i.tight||y)&&(u=!1),y=i.line-l>1&&i.isEmpty(i.line-1),i.blkIndent=i.listIndent,i.listIndent=O,i.tShift[l]=ae,i.sCount[l]=L,i.tight=j,o=i.push("list_item_close","li",-1),o.markup=String.fromCharCode(p),l=i.line,N[1]=l,l>=t||i.sCount[l]<i.blkIndent||i.sCount[l]-i.blkIndent>=4)break;let v=!1;for(let S=0,Y=x.length;S<Y;S++)if(x[S](i,l,t,!0)){v=!0;break}if(v)break;if(c){if(h=Jl(i,l),h<0)break;s=i.bMarks[l]+i.tShift[l]}else if(h=Ql(i,l),h<0)break;if(p!==i.src.charCodeAt(h-1))break}return c?o=i.push("ordered_list_close","ol",-1):o=i.push("bullet_list_close","ul",-1),o.markup=String.fromCharCode(p),g[1]=l,i.line=l,i.parentType=w,u&&Tp(i,m),!0}function Mp(i,e,t,n){let r=i.bMarks[e]+i.tShift[e],a=i.eMarks[e],s=e+1;if(i.sCount[e]-i.blkIndent>=4||i.src.charCodeAt(r)!==91)return!1;function o(x){const w=i.lineMax;if(x>=w||i.isEmpty(x))return null;let _=!1;if(i.sCount[x]-i.blkIndent>3&&(_=!0),i.sCount[x]<0&&(_=!0),!_){const T=i.md.block.ruler.getRules("reference"),R=i.parentType;i.parentType="reference";let N=!1;for(let j=0,ae=T.length;j<ae;j++)if(T[j](i,x,w,!0)){N=!0;break}if(i.parentType=R,N)return null}const C=i.bMarks[x]+i.tShift[x],F=i.eMarks[x];return i.src.slice(C,F+1)}let l=i.src.slice(r,a+1);a=l.length;let u=-1;for(r=1;r<a;r++){const x=l.charCodeAt(r);if(x===91)return!1;if(x===93){u=r;break}else if(x===10){const w=o(s);w!==null&&(l+=w,a=l.length,s++)}else if(x===92&&(r++,r<a&&l.charCodeAt(r)===10)){const w=o(s);w!==null&&(l+=w,a=l.length,s++)}}if(u<0||l.charCodeAt(u+1)!==58)return!1;for(r=u+2;r<a;r++){const x=l.charCodeAt(r);if(x===10){const w=o(s);w!==null&&(l+=w,a=l.length,s++)}else if(!Je(x))break}const f=i.md.helpers.parseLinkDestination(l,r,a);if(!f.ok)return!1;const c=i.md.normalizeLink(f.str);if(!i.md.validateLink(c))return!1;r=f.pos;const d=r,h=s,p=r;for(;r<a;r++){const x=l.charCodeAt(r);if(x===10){const w=o(s);w!==null&&(l+=w,a=l.length,s++)}else if(!Je(x))break}let m=i.md.helpers.parseLinkTitle(l,r,a);for(;m.can_continue;){const x=o(s);if(x===null)break;l+=x,r=a,a=l.length,s++,m=i.md.helpers.parseLinkTitle(l,r,a,m)}let g;for(r<a&&p!==r&&m.ok?(g=m.str,r=m.pos):(g="",r=d,s=h);r<a;){const x=l.charCodeAt(r);if(!Je(x))break;r++}if(r<a&&l.charCodeAt(r)!==10&&g)for(g="",r=d,s=h;r<a;){const x=l.charCodeAt(r);if(!Je(x))break;r++}if(r<a&&l.charCodeAt(r)!==10)return!1;const y=ra(l.slice(1,u));return y?(n||(typeof i.env.references>"u"&&(i.env.references={}),typeof i.env.references[y]>"u"&&(i.env.references[y]={title:g,href:c}),i.line=s),!0):!1}const Lp=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],Dp="[a-zA-Z_:][a-zA-Z0-9:._-]*",Bp="[^\"'=<>`\\x00-\\x20]+",Fp="'[^']*'",Ip='"[^"]*"',Pp="(?:"+Bp+"|"+Fp+"|"+Ip+")",Rp="(?:\\s+"+Dp+"(?:\\s*=\\s*"+Pp+")?)",Tu="<[A-Za-z][A-Za-z0-9\\-]*"+Rp+"*\\s*\\/?>",Su="<\\/[A-Za-z][A-Za-z0-9\\-]*\\s*>",Op="<!---?>|<!--(?:[^-]|-[^-]|--[^>])*-->",Np="<[?][\\s\\S]*?[?]>",Hp="<![A-Za-z][^>]*>",zp="<!\\[CDATA\\[[\\s\\S]*?\\]\\]>",Vp=new RegExp("^(?:"+Tu+"|"+Su+"|"+Op+"|"+Np+"|"+Hp+"|"+zp+")"),Up=new RegExp("^(?:"+Tu+"|"+Su+")"),on=[[/^<(script|pre|style|textarea)(?=(\s|>|$))/i,/<\/(script|pre|style|textarea)>/i,!0],[/^<!--/,/-->/,!0],[/^<\?/,/\?>/,!0],[/^<![A-Z]/,/>/,!0],[/^<!\[CDATA\[/,/\]\]>/,!0],[new RegExp("^</?("+Lp.join("|")+")(?=(\\s|/?>|$))","i"),/^$/,!0],[new RegExp(Up.source+"\\s*$"),/^$/,!1]];function Wp(i,e,t,n){let r=i.bMarks[e]+i.tShift[e],a=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4||!i.md.options.html||i.src.charCodeAt(r)!==60)return!1;let s=i.src.slice(r,a),o=0;for(;o<on.length&&!on[o][0].test(s);o++);if(o===on.length)return!1;if(n)return on[o][2];let l=e+1;if(!on[o][1].test(s)){for(;l<t&&!(i.sCount[l]<i.blkIndent);l++)if(r=i.bMarks[l]+i.tShift[l],a=i.eMarks[l],s=i.src.slice(r,a),on[o][1].test(s)){s.length!==0&&l++;break}}i.line=l;const u=i.push("html_block","",0);return u.map=[e,l],u.content=i.getLines(e,l,i.blkIndent,!0),!0}function Gp(i,e,t,n){let r=i.bMarks[e]+i.tShift[e],a=i.eMarks[e];if(i.sCount[e]-i.blkIndent>=4)return!1;let s=i.src.charCodeAt(r);if(s!==35||r>=a)return!1;let o=1;for(s=i.src.charCodeAt(++r);s===35&&r<a&&o<=6;)o++,s=i.src.charCodeAt(++r);if(o>6||r<a&&!Je(s))return!1;if(n)return!0;a=i.skipSpacesBack(a,r);const l=i.skipCharsBack(a,35,r);l>r&&Je(i.src.charCodeAt(l-1))&&(a=l),i.line=e+1;const u=i.push("heading_open","h"+String(o),1);u.markup="########".slice(0,o),u.map=[e,i.line];const f=i.push("inline","",0);f.content=i.src.slice(r,a).trim(),f.map=[e,i.line],f.children=[];const c=i.push("heading_close","h"+String(o),-1);return c.markup="########".slice(0,o),!0}function qp(i,e,t){const n=i.md.block.ruler.getRules("paragraph");if(i.sCount[e]-i.blkIndent>=4)return!1;const r=i.parentType;i.parentType="paragraph";let a=0,s,o=e+1;for(;o<t&&!i.isEmpty(o);o++){if(i.sCount[o]-i.blkIndent>3)continue;if(i.sCount[o]>=i.blkIndent){let h=i.bMarks[o]+i.tShift[o];const p=i.eMarks[o];if(h<p&&(s=i.src.charCodeAt(h),(s===45||s===61)&&(h=i.skipChars(h,s),h=i.skipSpaces(h),h>=p))){a=s===61?1:2;break}}if(i.sCount[o]<0)continue;let d=!1;for(let h=0,p=n.length;h<p;h++)if(n[h](i,o,t,!0)){d=!0;break}if(d)break}if(!a)return!1;const l=i.getLines(e,o,i.blkIndent,!1).trim();i.line=o+1;const u=i.push("heading_open","h"+String(a),1);u.markup=String.fromCharCode(s),u.map=[e,i.line];const f=i.push("inline","",0);f.content=l,f.map=[e,i.line-1],f.children=[];const c=i.push("heading_close","h"+String(a),-1);return c.markup=String.fromCharCode(s),i.parentType=r,!0}function jp(i,e,t){const n=i.md.block.ruler.getRules("paragraph"),r=i.parentType;let a=e+1;for(i.parentType="paragraph";a<t&&!i.isEmpty(a);a++){if(i.sCount[a]-i.blkIndent>3||i.sCount[a]<0)continue;let u=!1;for(let f=0,c=n.length;f<c;f++)if(n[f](i,a,t,!0)){u=!0;break}if(u)break}const s=i.getLines(e,a,i.blkIndent,!1).trim();i.line=a;const o=i.push("paragraph_open","p",1);o.map=[e,i.line];const l=i.push("inline","",0);return l.content=s,l.map=[e,i.line],l.children=[],i.push("paragraph_close","p",-1),i.parentType=r,!0}const gr=[["table",Ep,["paragraph","reference"]],["code",Cp],["fence",_p,["paragraph","reference","blockquote","list"]],["blockquote",Ap,["paragraph","reference","blockquote","list"]],["hr",kp,["paragraph","reference","blockquote","list"]],["list",Sp,["paragraph","reference","blockquote"]],["reference",Mp],["html_block",Wp,["paragraph","reference","blockquote"]],["heading",Gp,["paragraph","reference","blockquote"]],["lheading",qp],["paragraph",jp]];function aa(){this.ruler=new Bt;for(let i=0;i<gr.length;i++)this.ruler.push(gr[i][0],gr[i][1],{alt:(gr[i][2]||[]).slice()})}aa.prototype.tokenize=function(i,e,t){const n=this.ruler.getRules(""),r=n.length,a=i.md.options.maxNesting;let s=e,o=!1;for(;s<t&&(i.line=s=i.skipEmptyLines(s),!(s>=t||i.sCount[s]<i.blkIndent));){if(i.level>=a){i.line=t;break}const l=i.line;let u=!1;for(let f=0;f<r;f++)if(u=n[f](i,s,t,!1),u){if(l>=i.line)throw new Error("block rule didn't increment state.line");break}if(!u)throw new Error("none of the block rules matched");i.tight=!o,i.isEmpty(i.line-1)&&(o=!0),s=i.line,s<t&&i.isEmpty(s)&&(o=!0,s++,i.line=s)}};aa.prototype.parse=function(i,e,t,n){if(!i)return;const r=new this.State(i,e,t,n);this.tokenize(r,r.line,r.lineMax)};aa.prototype.State=yi;function ur(i,e,t,n){this.src=i,this.env=t,this.md=e,this.tokens=n,this.tokens_meta=Array(n.length),this.pos=0,this.posMax=this.src.length,this.level=0,this.pending="",this.pendingLevel=0,this.cache={},this.delimiters=[],this._prev_delimiters=[],this.backticks={},this.backticksScanned=!1,this.linkLevel=0}ur.prototype.pushPending=function(){const i=new si("text","",0);return i.content=this.pending,i.level=this.pendingLevel,this.tokens.push(i),this.pending="",i};ur.prototype.push=function(i,e,t){this.pending&&this.pushPending();const n=new si(i,e,t);let r=null;return t<0&&(this.level--,this.delimiters=this._prev_delimiters.pop()),n.level=this.level,t>0&&(this.level++,this._prev_delimiters.push(this.delimiters),this.delimiters=[],r={delimiters:this.delimiters}),this.pendingLevel=this.level,this.tokens.push(n),this.tokens_meta.push(r),n};ur.prototype.scanDelims=function(i,e){const t=this.posMax,n=this.src.charCodeAt(i),r=i>0?this.src.charCodeAt(i-1):32;let a=i;for(;a<t&&this.src.charCodeAt(a)===n;)a++;const s=a-i,o=a<t?this.src.charCodeAt(a):32,l=nr(r)||ir(String.fromCharCode(r)),u=nr(o)||ir(String.fromCharCode(o)),f=tr(r),c=tr(o),d=!c&&(!u||f||l),h=!f&&(!l||c||u);return{can_open:d&&(e||!h||l),can_close:h&&(e||!d||u),length:s}};ur.prototype.Token=si;function $p(i){switch(i){case 10:case 33:case 35:case 36:case 37:case 38:case 42:case 43:case 45:case 58:case 60:case 61:case 62:case 64:case 91:case 92:case 93:case 94:case 95:case 96:case 123:case 125:case 126:return!0;default:return!1}}function Yp(i,e){let t=i.pos;for(;t<i.posMax&&!$p(i.src.charCodeAt(t));)t++;return t===i.pos?!1:(e||(i.pending+=i.src.slice(i.pos,t)),i.pos=t,!0)}const Kp=/(?:^|[^a-z0-9.+-])([a-z][a-z0-9.+-]*)$/i;function Xp(i,e){if(!i.md.options.linkify||i.linkLevel>0)return!1;const t=i.pos,n=i.posMax;if(t+3>n||i.src.charCodeAt(t)!==58||i.src.charCodeAt(t+1)!==47||i.src.charCodeAt(t+2)!==47)return!1;const r=i.pending.match(Kp);if(!r)return!1;const a=r[1],s=i.md.linkify.matchAtStart(i.src.slice(t-a.length));if(!s)return!1;let o=s.url;if(o.length<=a.length)return!1;o=o.replace(/\*+$/,"");const l=i.md.normalizeLink(o);if(!i.md.validateLink(l))return!1;if(!e){i.pending=i.pending.slice(0,-a.length);const u=i.push("link_open","a",1);u.attrs=[["href",l]],u.markup="linkify",u.info="auto";const f=i.push("text","",0);f.content=i.md.normalizeLinkText(o);const c=i.push("link_close","a",-1);c.markup="linkify",c.info="auto"}return i.pos+=o.length-a.length,!0}function Zp(i,e){let t=i.pos;if(i.src.charCodeAt(t)!==10)return!1;const n=i.pending.length-1,r=i.posMax;if(!e)if(n>=0&&i.pending.charCodeAt(n)===32)if(n>=1&&i.pending.charCodeAt(n-1)===32){let a=n-1;for(;a>=1&&i.pending.charCodeAt(a-1)===32;)a--;i.pending=i.pending.slice(0,a),i.push("hardbreak","br",0)}else i.pending=i.pending.slice(0,-1),i.push("softbreak","br",0);else i.push("softbreak","br",0);for(t++;t<r&&Je(i.src.charCodeAt(t));)t++;return i.pos=t,!0}const _o=[];for(let i=0;i<256;i++)_o.push(0);"\\!\"#$%&'()*+,./:;<=>?@[]^_`{|}~-".split("").forEach(function(i){_o[i.charCodeAt(0)]=1});function Qp(i,e){let t=i.pos;const n=i.posMax;if(i.src.charCodeAt(t)!==92||(t++,t>=n))return!1;let r=i.src.charCodeAt(t);if(r===10){for(e||i.push("hardbreak","br",0),t++;t<n&&(r=i.src.charCodeAt(t),!!Je(r));)t++;return i.pos=t,!0}let a=i.src[t];if(r>=55296&&r<=56319&&t+1<n){const o=i.src.charCodeAt(t+1);o>=56320&&o<=57343&&(a+=i.src[t+1],t++)}const s="\\"+a;if(!e){const o=i.push("text_special","",0);r<256&&_o[r]!==0?o.content=a:o.content=s,o.markup=s,o.info="escape"}return i.pos=t+1,!0}function Jp(i,e){let t=i.pos;if(i.src.charCodeAt(t)!==96)return!1;const r=t;t++;const a=i.posMax;for(;t<a&&i.src.charCodeAt(t)===96;)t++;const s=i.src.slice(r,t),o=s.length;if(i.backticksScanned&&(i.backticks[o]||0)<=r)return e||(i.pending+=s),i.pos+=o,!0;let l=t,u;for(;(u=i.src.indexOf("`",l))!==-1;){for(l=u+1;l<a&&i.src.charCodeAt(l)===96;)l++;const f=l-u;if(f===o){if(!e){const c=i.push("code_inline","code",0);c.markup=s,c.content=i.src.slice(t,u).replace(/\n/g," ").replace(/^ (.+) $/,"$1")}return i.pos=l,!0}i.backticks[f]=u}return i.backticksScanned=!0,e||(i.pending+=s),i.pos+=o,!0}function e0(i,e){const t=i.pos,n=i.src.charCodeAt(t);if(e||n!==126)return!1;const r=i.scanDelims(i.pos,!0);let a=r.length;const s=String.fromCharCode(n);if(a<2)return!1;let o;a%2&&(o=i.push("text","",0),o.content=s,a--);for(let l=0;l<a;l+=2)o=i.push("text","",0),o.content=s+s,i.delimiters.push({marker:n,length:0,token:i.tokens.length-1,end:-1,open:r.can_open,close:r.can_close});return i.pos+=r.length,!0}function ec(i,e){let t;const n=[],r=e.length;for(let a=0;a<r;a++){const s=e[a];if(s.marker!==126||s.end===-1)continue;const o=e[s.end];t=i.tokens[s.token],t.type="s_open",t.tag="s",t.nesting=1,t.markup="~~",t.content="",t=i.tokens[o.token],t.type="s_close",t.tag="s",t.nesting=-1,t.markup="~~",t.content="",i.tokens[o.token-1].type==="text"&&i.tokens[o.token-1].content==="~"&&n.push(o.token-1)}for(;n.length;){const a=n.pop();let s=a+1;for(;s<i.tokens.length&&i.tokens[s].type==="s_close";)s++;s--,a!==s&&(t=i.tokens[s],i.tokens[s]=i.tokens[a],i.tokens[a]=t)}}function t0(i){const e=i.tokens_meta,t=i.tokens_meta.length;ec(i,i.delimiters);for(let n=0;n<t;n++)e[n]&&e[n].delimiters&&ec(i,e[n].delimiters)}const Mu={tokenize:e0,postProcess:t0};function i0(i,e){const t=i.pos,n=i.src.charCodeAt(t);if(e||n!==95&&n!==42)return!1;const r=i.scanDelims(i.pos,n===42);for(let a=0;a<r.length;a++){const s=i.push("text","",0);s.content=String.fromCharCode(n),i.delimiters.push({marker:n,length:r.length,token:i.tokens.length-1,end:-1,open:r.can_open,close:r.can_close})}return i.pos+=r.length,!0}function tc(i,e){const t=e.length;for(let n=t-1;n>=0;n--){const r=e[n];if(r.marker!==95&&r.marker!==42||r.end===-1)continue;const a=e[r.end],s=n>0&&e[n-1].end===r.end+1&&e[n-1].marker===r.marker&&e[n-1].token===r.token-1&&e[r.end+1].token===a.token+1,o=String.fromCharCode(r.marker),l=i.tokens[r.token];l.type=s?"strong_open":"em_open",l.tag=s?"strong":"em",l.nesting=1,l.markup=s?o+o:o,l.content="";const u=i.tokens[a.token];u.type=s?"strong_close":"em_close",u.tag=s?"strong":"em",u.nesting=-1,u.markup=s?o+o:o,u.content="",s&&(i.tokens[e[n-1].token].content="",i.tokens[e[r.end+1].token].content="",n--)}}function n0(i){const e=i.tokens_meta,t=i.tokens_meta.length;tc(i,i.delimiters);for(let n=0;n<t;n++)e[n]&&e[n].delimiters&&tc(i,e[n].delimiters)}const Lu={tokenize:i0,postProcess:n0};function r0(i,e){let t,n,r,a,s="",o="",l=i.pos,u=!0;if(i.src.charCodeAt(i.pos)!==91)return!1;const f=i.pos,c=i.posMax,d=i.pos+1,h=i.md.helpers.parseLinkLabel(i,i.pos,!0);if(h<0)return!1;let p=h+1;if(p<c&&i.src.charCodeAt(p)===40){for(u=!1,p++;p<c&&(t=i.src.charCodeAt(p),!(!Je(t)&&t!==10));p++);if(p>=c)return!1;if(l=p,r=i.md.helpers.parseLinkDestination(i.src,p,i.posMax),r.ok){for(s=i.md.normalizeLink(r.str),i.md.validateLink(s)?p=r.pos:s="",l=p;p<c&&(t=i.src.charCodeAt(p),!(!Je(t)&&t!==10));p++);if(r=i.md.helpers.parseLinkTitle(i.src,p,i.posMax),p<c&&l!==p&&r.ok)for(o=r.str,p=r.pos;p<c&&(t=i.src.charCodeAt(p),!(!Je(t)&&t!==10));p++);}(p>=c||i.src.charCodeAt(p)!==41)&&(u=!0),p++}if(u){if(typeof i.env.references>"u")return!1;if(p<c&&i.src.charCodeAt(p)===91?(l=p+1,p=i.md.helpers.parseLinkLabel(i,p),p>=0?n=i.src.slice(l,p++):p=h+1):p=h+1,n||(n=i.src.slice(d,h)),a=i.env.references[ra(n)],!a)return i.pos=f,!1;s=a.href,o=a.title}if(!e){i.pos=d,i.posMax=h;const m=i.push("link_open","a",1),g=[["href",s]];m.attrs=g,o&&g.push(["title",o]),i.linkLevel++,i.md.inline.tokenize(i),i.linkLevel--,i.push("link_close","a",-1)}return i.pos=p,i.posMax=c,!0}function a0(i,e){let t,n,r,a,s,o,l,u,f="";const c=i.pos,d=i.posMax;if(i.src.charCodeAt(i.pos)!==33||i.src.charCodeAt(i.pos+1)!==91)return!1;const h=i.pos+2,p=i.md.helpers.parseLinkLabel(i,i.pos+1,!1);if(p<0)return!1;if(a=p+1,a<d&&i.src.charCodeAt(a)===40){for(a++;a<d&&(t=i.src.charCodeAt(a),!(!Je(t)&&t!==10));a++);if(a>=d)return!1;for(u=a,o=i.md.helpers.parseLinkDestination(i.src,a,i.posMax),o.ok&&(f=i.md.normalizeLink(o.str),i.md.validateLink(f)?a=o.pos:f=""),u=a;a<d&&(t=i.src.charCodeAt(a),!(!Je(t)&&t!==10));a++);if(o=i.md.helpers.parseLinkTitle(i.src,a,i.posMax),a<d&&u!==a&&o.ok)for(l=o.str,a=o.pos;a<d&&(t=i.src.charCodeAt(a),!(!Je(t)&&t!==10));a++);else l="";if(a>=d||i.src.charCodeAt(a)!==41)return i.pos=c,!1;a++}else{if(typeof i.env.references>"u")return!1;if(a<d&&i.src.charCodeAt(a)===91?(u=a+1,a=i.md.helpers.parseLinkLabel(i,a),a>=0?r=i.src.slice(u,a++):a=p+1):a=p+1,r||(r=i.src.slice(h,p)),s=i.env.references[ra(r)],!s)return i.pos=c,!1;f=s.href,l=s.title}if(!e){n=i.src.slice(h,p);const m=[];i.md.inline.parse(n,i.md,i.env,m);const g=i.push("image","img",0),y=[["src",f],["alt",""]];g.attrs=y,g.children=m,g.content=n,l&&y.push(["title",l])}return i.pos=a,i.posMax=d,!0}const s0=/^([a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)$/,o0=/^([a-zA-Z][a-zA-Z0-9+.-]{1,31}):([^<>\x00-\x20]*)$/;function l0(i,e){let t=i.pos;if(i.src.charCodeAt(t)!==60)return!1;const n=i.pos,r=i.posMax;for(;;){if(++t>=r)return!1;const s=i.src.charCodeAt(t);if(s===60)return!1;if(s===62)break}const a=i.src.slice(n+1,t);if(o0.test(a)){const s=i.md.normalizeLink(a);if(!i.md.validateLink(s))return!1;if(!e){const o=i.push("link_open","a",1);o.attrs=[["href",s]],o.markup="autolink",o.info="auto";const l=i.push("text","",0);l.content=i.md.normalizeLinkText(a);const u=i.push("link_close","a",-1);u.markup="autolink",u.info="auto"}return i.pos+=a.length+2,!0}if(s0.test(a)){const s=i.md.normalizeLink("mailto:"+a);if(!i.md.validateLink(s))return!1;if(!e){const o=i.push("link_open","a",1);o.attrs=[["href",s]],o.markup="autolink",o.info="auto";const l=i.push("text","",0);l.content=i.md.normalizeLinkText(a);const u=i.push("link_close","a",-1);u.markup="autolink",u.info="auto"}return i.pos+=a.length+2,!0}return!1}function c0(i){return/^<a[>\s]/i.test(i)}function u0(i){return/^<\/a\s*>/i.test(i)}function d0(i){const e=i|32;return e>=97&&e<=122}function h0(i,e){if(!i.md.options.html)return!1;const t=i.posMax,n=i.pos;if(i.src.charCodeAt(n)!==60||n+2>=t)return!1;const r=i.src.charCodeAt(n+1);if(r!==33&&r!==63&&r!==47&&!d0(r))return!1;const a=i.src.slice(n).match(Vp);if(!a)return!1;if(!e){const s=i.push("html_inline","",0);s.content=a[0],c0(s.content)&&i.linkLevel++,u0(s.content)&&i.linkLevel--}return i.pos+=a[0].length,!0}const f0=/^&#((?:x[a-f0-9]{1,6}|[0-9]{1,7}));/i,p0=/^&([a-z][a-z0-9]{1,31});/i;function m0(i,e){const t=i.pos,n=i.posMax;if(i.src.charCodeAt(t)!==38||t+1>=n)return!1;if(i.src.charCodeAt(t+1)===35){const a=i.src.slice(t).match(f0);if(a){if(!e){const s=a[1][0].toLowerCase()==="x"?parseInt(a[1].slice(1),16):parseInt(a[1],10),o=i.push("text_special","",0);o.content=Eo(s)?zr(s):zr(65533),o.markup=a[0],o.info="entity"}return i.pos+=a[0].length,!0}}else{const a=i.src.slice(t).match(p0);if(a){const s=Eu(a[0]);if(s!==a[0]){if(!e){const o=i.push("text_special","",0);o.content=s,o.markup=a[0],o.info="entity"}return i.pos+=a[0].length,!0}}}return!1}function ic(i){const e={},t=i.length;if(!t)return;let n=0,r=-2;const a=[];for(let s=0;s<t;s++){const o=i[s];if(a.push(0),(i[n].marker!==o.marker||r!==o.token-1)&&(n=s),r=o.token,o.length=o.length||0,!o.close)continue;e.hasOwnProperty(o.marker)||(e[o.marker]=[-1,-1,-1,-1,-1,-1]);const l=e[o.marker][(o.open?3:0)+o.length%3];let u=n-a[n]-1,f=u;for(;u>l;u-=a[u]+1){const c=i[u];if(c.marker===o.marker&&c.open&&c.end<0){let d=!1;if((c.close||o.open)&&(c.length+o.length)%3===0&&(c.length%3!==0||o.length%3!==0)&&(d=!0),!d){const h=u>0&&!i[u-1].open?a[u-1]+1:0;a[s]=s-u+h,a[u]=h,o.open=!1,c.end=s,c.close=!1,f=-1,r=-2;break}}}f!==-1&&(e[o.marker][(o.open?3:0)+(o.length||0)%3]=f)}}function g0(i){const e=i.tokens_meta,t=i.tokens_meta.length;ic(i.delimiters);for(let n=0;n<t;n++)e[n]&&e[n].delimiters&&ic(e[n].delimiters)}function b0(i){let e,t,n=0;const r=i.tokens,a=i.tokens.length;for(e=t=0;e<a;e++)r[e].nesting<0&&n--,r[e].level=n,r[e].nesting>0&&n++,r[e].type==="text"&&e+1<a&&r[e+1].type==="text"?r[e+1].content=r[e].content+r[e+1].content:(e!==t&&(r[t]=r[e]),t++);e!==t&&(r.length=t)}const ds=[["text",Yp],["linkify",Xp],["newline",Zp],["escape",Qp],["backticks",Jp],["strikethrough",Mu.tokenize],["emphasis",Lu.tokenize],["link",r0],["image",a0],["autolink",l0],["html_inline",h0],["entity",m0]],hs=[["balance_pairs",g0],["strikethrough",Mu.postProcess],["emphasis",Lu.postProcess],["fragments_join",b0]];function dr(){this.ruler=new Bt;for(let i=0;i<ds.length;i++)this.ruler.push(ds[i][0],ds[i][1]);this.ruler2=new Bt;for(let i=0;i<hs.length;i++)this.ruler2.push(hs[i][0],hs[i][1])}dr.prototype.skipToken=function(i){const e=i.pos,t=this.ruler.getRules(""),n=t.length,r=i.md.options.maxNesting,a=i.cache;if(typeof a[e]<"u"){i.pos=a[e];return}let s=!1;if(i.level<r){for(let o=0;o<n;o++)if(i.level++,s=t[o](i,!0),i.level--,s){if(e>=i.pos)throw new Error("inline rule didn't increment state.pos");break}}else i.pos=i.posMax;s||i.pos++,a[e]=i.pos};dr.prototype.tokenize=function(i){const e=this.ruler.getRules(""),t=e.length,n=i.posMax,r=i.md.options.maxNesting;for(;i.pos<n;){const a=i.pos;let s=!1;if(i.level<r){for(let o=0;o<t;o++)if(s=e[o](i,!1),s){if(a>=i.pos)throw new Error("inline rule didn't increment state.pos");break}}if(s){if(i.pos>=n)break;continue}i.pending+=i.src[i.pos++]}i.pending&&i.pushPending()};dr.prototype.parse=function(i,e,t,n){const r=new this.State(i,e,t,n);this.tokenize(r);const a=this.ruler2.getRules(""),s=a.length;for(let o=0;o<s;o++)a[o](r)};dr.prototype.State=ur;function y0(i){const e={};i=i||{},e.src_Any=bu.source,e.src_Cc=yu.source,e.src_Z=vu.source,e.src_P=vo.source,e.src_ZPCc=[e.src_Z,e.src_P,e.src_Cc].join("|"),e.src_ZCc=[e.src_Z,e.src_Cc].join("|");const t="[><｜]";return e.src_pseudo_letter="(?:(?!"+t+"|"+e.src_ZPCc+")"+e.src_Any+")",e.src_ip4="(?:(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)",e.src_auth="(?:(?:(?!"+e.src_ZCc+"|[@/\\[\\]()]).)+@)?",e.src_port="(?::(?:6(?:[0-4]\\d{3}|5(?:[0-4]\\d{2}|5(?:[0-2]\\d|3[0-5])))|[1-5]?\\d{1,4}))?",e.src_host_terminator="(?=$|"+t+"|"+e.src_ZPCc+")(?!"+(i["---"]?"-(?!--)|":"-|")+"_|:\\d|\\.-|\\.(?!$|"+e.src_ZPCc+"))",e.src_path="(?:[/?#](?:(?!"+e.src_ZCc+"|"+t+`|[()[\\]{}.,"'?!\\-;]).|\\[(?:(?!`+e.src_ZCc+"|\\]).)*\\]|\\((?:(?!"+e.src_ZCc+"|[)]).)*\\)|\\{(?:(?!"+e.src_ZCc+'|[}]).)*\\}|\\"(?:(?!'+e.src_ZCc+`|["]).)+\\"|\\'(?:(?!`+e.src_ZCc+"|[']).)+\\'|\\'(?="+e.src_pseudo_letter+"|[-])|\\.{2,}[a-zA-Z0-9%/&]|\\.(?!"+e.src_ZCc+"|[.]|$)|"+(i["---"]?"\\-(?!--(?:[^-]|$))(?:-*)|":"\\-+|")+",(?!"+e.src_ZCc+"|$)|;(?!"+e.src_ZCc+"|$)|\\!+(?!"+e.src_ZCc+"|[!]|$)|\\?(?!"+e.src_ZCc+"|[?]|$))+|\\/)?",e.src_email_name='[\\-;:&=\\+\\$,\\.a-zA-Z0-9_][\\-;:&=\\+\\$,\\"\\.a-zA-Z0-9_]*',e.src_xn="xn--[a-z0-9\\-]{1,59}",e.src_domain_root="(?:"+e.src_xn+"|"+e.src_pseudo_letter+"{1,63})",e.src_domain="(?:"+e.src_xn+"|(?:"+e.src_pseudo_letter+")|(?:"+e.src_pseudo_letter+"(?:-|"+e.src_pseudo_letter+"){0,61}"+e.src_pseudo_letter+"))",e.src_host="(?:(?:(?:(?:"+e.src_domain+")\\.)*"+e.src_domain+"))",e.tpl_host_fuzzy="(?:"+e.src_ip4+"|(?:(?:(?:"+e.src_domain+")\\.)+(?:%TLDS%)))",e.tpl_host_no_ip_fuzzy="(?:(?:(?:"+e.src_domain+")\\.)+(?:%TLDS%))",e.src_host_strict=e.src_host+e.src_host_terminator,e.tpl_host_fuzzy_strict=e.tpl_host_fuzzy+e.src_host_terminator,e.src_host_port_strict=e.src_host+e.src_port+e.src_host_terminator,e.tpl_host_port_fuzzy_strict=e.tpl_host_fuzzy+e.src_port+e.src_host_terminator,e.tpl_host_port_no_ip_fuzzy_strict=e.tpl_host_no_ip_fuzzy+e.src_port+e.src_host_terminator,e.tpl_host_fuzzy_test="localhost|www\\.|\\.\\d{1,3}\\.|(?:\\.(?:%TLDS%)(?:"+e.src_ZPCc+"|>|$))",e.tpl_email_fuzzy="(^|"+t+'|"|\\(|'+e.src_ZCc+")("+e.src_email_name+"@"+e.tpl_host_fuzzy_strict+")",e.tpl_link_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+e.src_ZPCc+"))((?![$+<=>^`|｜])"+e.tpl_host_port_fuzzy_strict+e.src_path+")",e.tpl_link_no_ip_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+e.src_ZPCc+"))((?![$+<=>^`|｜])"+e.tpl_host_port_no_ip_fuzzy_strict+e.src_path+")",e}function js(i){return Array.prototype.slice.call(arguments,1).forEach(function(t){t&&Object.keys(t).forEach(function(n){i[n]=t[n]})}),i}function sa(i){return Object.prototype.toString.call(i)}function w0(i){return sa(i)==="[object String]"}function v0(i){return sa(i)==="[object Object]"}function x0(i){return sa(i)==="[object RegExp]"}function nc(i){return sa(i)==="[object Function]"}function E0(i){return i.replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}const Du={fuzzyLink:!0,fuzzyEmail:!0,fuzzyIP:!1};function C0(i){return Object.keys(i||{}).reduce(function(e,t){return e||Du.hasOwnProperty(t)},!1)}const _0={"http:":{validate:function(i,e,t){const n=i.slice(e);return t.re.http||(t.re.http=new RegExp("^\\/\\/"+t.re.src_auth+t.re.src_host_port_strict+t.re.src_path,"i")),t.re.http.test(n)?n.match(t.re.http)[0].length:0}},"https:":"http:","ftp:":"http:","//":{validate:function(i,e,t){const n=i.slice(e);return t.re.no_http||(t.re.no_http=new RegExp("^"+t.re.src_auth+"(?:localhost|(?:(?:"+t.re.src_domain+")\\.)+"+t.re.src_domain_root+")"+t.re.src_port+t.re.src_host_terminator+t.re.src_path,"i")),t.re.no_http.test(n)?e>=3&&i[e-3]===":"||e>=3&&i[e-3]==="/"?0:n.match(t.re.no_http)[0].length:0}},"mailto:":{validate:function(i,e,t){const n=i.slice(e);return t.re.mailto||(t.re.mailto=new RegExp("^"+t.re.src_email_name+"@"+t.re.src_host_strict,"i")),t.re.mailto.test(n)?n.match(t.re.mailto)[0].length:0}}},A0="a[cdefgilmnoqrstuwxz]|b[abdefghijmnorstvwyz]|c[acdfghiklmnoruvwxyz]|d[ejkmoz]|e[cegrstu]|f[ijkmor]|g[abdefghilmnpqrstuwy]|h[kmnrtu]|i[delmnoqrst]|j[emop]|k[eghimnprwyz]|l[abcikrstuvy]|m[acdeghklmnopqrstuvwxyz]|n[acefgilopruz]|om|p[aefghklmnrstwy]|qa|r[eosuw]|s[abcdeghijklmnortuvxyz]|t[cdfghjklmnortvwz]|u[agksyz]|v[aceginu]|w[fs]|y[et]|z[amw]",k0="biz|com|edu|gov|net|org|pro|web|xxx|aero|asia|coop|info|museum|name|shop|рф".split("|");function T0(i){i.__index__=-1,i.__text_cache__=""}function S0(i){return function(e,t){const n=e.slice(t);return i.test(n)?n.match(i)[0].length:0}}function rc(){return function(i,e){e.normalize(i)}}function Vr(i){const e=i.re=y0(i.__opts__),t=i.__tlds__.slice();i.onCompile(),i.__tlds_replaced__||t.push(A0),t.push(e.src_xn),e.src_tlds=t.join("|");function n(o){return o.replace("%TLDS%",e.src_tlds)}e.email_fuzzy=RegExp(n(e.tpl_email_fuzzy),"i"),e.link_fuzzy=RegExp(n(e.tpl_link_fuzzy),"i"),e.link_no_ip_fuzzy=RegExp(n(e.tpl_link_no_ip_fuzzy),"i"),e.host_fuzzy_test=RegExp(n(e.tpl_host_fuzzy_test),"i");const r=[];i.__compiled__={};function a(o,l){throw new Error('(LinkifyIt) Invalid schema "'+o+'": '+l)}Object.keys(i.__schemas__).forEach(function(o){const l=i.__schemas__[o];if(l===null)return;const u={validate:null,link:null};if(i.__compiled__[o]=u,v0(l)){x0(l.validate)?u.validate=S0(l.validate):nc(l.validate)?u.validate=l.validate:a(o,l),nc(l.normalize)?u.normalize=l.normalize:l.normalize?a(o,l):u.normalize=rc();return}if(w0(l)){r.push(o);return}a(o,l)}),r.forEach(function(o){i.__compiled__[i.__schemas__[o]]&&(i.__compiled__[o].validate=i.__compiled__[i.__schemas__[o]].validate,i.__compiled__[o].normalize=i.__compiled__[i.__schemas__[o]].normalize)}),i.__compiled__[""]={validate:null,normalize:rc()};const s=Object.keys(i.__compiled__).filter(function(o){return o.length>0&&i.__compiled__[o]}).map(E0).join("|");i.re.schema_test=RegExp("(^|(?!_)(?:[><｜]|"+e.src_ZPCc+"))("+s+")","i"),i.re.schema_search=RegExp("(^|(?!_)(?:[><｜]|"+e.src_ZPCc+"))("+s+")","ig"),i.re.schema_at_start=RegExp("^"+i.re.schema_search.source,"i"),i.re.pretest=RegExp("("+i.re.schema_test.source+")|("+i.re.host_fuzzy_test.source+")|@","i"),T0(i)}function M0(i,e){const t=i.__index__,n=i.__last_index__,r=i.__text_cache__.slice(t,n);this.schema=i.__schema__.toLowerCase(),this.index=t+e,this.lastIndex=n+e,this.raw=r,this.text=r,this.url=r}function $s(i,e){const t=new M0(i,e);return i.__compiled__[t.schema].normalize(t,i),t}function Nt(i,e){if(!(this instanceof Nt))return new Nt(i,e);e||C0(i)&&(e=i,i={}),this.__opts__=js({},Du,e),this.__index__=-1,this.__last_index__=-1,this.__schema__="",this.__text_cache__="",this.__schemas__=js({},_0,i),this.__compiled__={},this.__tlds__=k0,this.__tlds_replaced__=!1,this.re={},Vr(this)}Nt.prototype.add=function(e,t){return this.__schemas__[e]=t,Vr(this),this};Nt.prototype.set=function(e){return this.__opts__=js(this.__opts__,e),this};Nt.prototype.test=function(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return!1;let t,n,r,a,s,o,l,u,f;if(this.re.schema_test.test(e)){for(l=this.re.schema_search,l.lastIndex=0;(t=l.exec(e))!==null;)if(a=this.testSchemaAt(e,t[2],l.lastIndex),a){this.__schema__=t[2],this.__index__=t.index+t[1].length,this.__last_index__=t.index+t[0].length+a;break}}return this.__opts__.fuzzyLink&&this.__compiled__["http:"]&&(u=e.search(this.re.host_fuzzy_test),u>=0&&(this.__index__<0||u<this.__index__)&&(n=e.match(this.__opts__.fuzzyIP?this.re.link_fuzzy:this.re.link_no_ip_fuzzy))!==null&&(s=n.index+n[1].length,(this.__index__<0||s<this.__index__)&&(this.__schema__="",this.__index__=s,this.__last_index__=n.index+n[0].length))),this.__opts__.fuzzyEmail&&this.__compiled__["mailto:"]&&(f=e.indexOf("@"),f>=0&&(r=e.match(this.re.email_fuzzy))!==null&&(s=r.index+r[1].length,o=r.index+r[0].length,(this.__index__<0||s<this.__index__||s===this.__index__&&o>this.__last_index__)&&(this.__schema__="mailto:",this.__index__=s,this.__last_index__=o))),this.__index__>=0};Nt.prototype.pretest=function(e){return this.re.pretest.test(e)};Nt.prototype.testSchemaAt=function(e,t,n){return this.__compiled__[t.toLowerCase()]?this.__compiled__[t.toLowerCase()].validate(e,n,this):0};Nt.prototype.match=function(e){const t=[];let n=0;this.__index__>=0&&this.__text_cache__===e&&(t.push($s(this,n)),n=this.__last_index__);let r=n?e.slice(n):e;for(;this.test(r);)t.push($s(this,n)),r=r.slice(this.__last_index__),n+=this.__last_index__;return t.length?t:null};Nt.prototype.matchAtStart=function(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return null;const t=this.re.schema_at_start.exec(e);if(!t)return null;const n=this.testSchemaAt(e,t[2],t[0].length);return n?(this.__schema__=t[2],this.__index__=t.index+t[1].length,this.__last_index__=t.index+t[0].length+n,$s(this,0)):null};Nt.prototype.tlds=function(e,t){return e=Array.isArray(e)?e:[e],t?(this.__tlds__=this.__tlds__.concat(e).sort().filter(function(n,r,a){return n!==a[r-1]}).reverse(),Vr(this),this):(this.__tlds__=e.slice(),this.__tlds_replaced__=!0,Vr(this),this)};Nt.prototype.normalize=function(e){e.schema||(e.url="http://"+e.url),e.schema==="mailto:"&&!/^mailto:/i.test(e.url)&&(e.url="mailto:"+e.url)};Nt.prototype.onCompile=function(){};const wn=2147483647,fi=36,Ao=1,rr=26,L0=38,D0=700,Bu=72,Fu=128,Iu="-",B0=/^xn--/,F0=/[^\0-\x7F]/,I0=/[\x2E\u3002\uFF0E\uFF61]/g,P0={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},fs=fi-Ao,pi=Math.floor,ps=String.fromCharCode;function Di(i){throw new RangeError(P0[i])}function R0(i,e){const t=[];let n=i.length;for(;n--;)t[n]=e(i[n]);return t}function Pu(i,e){const t=i.split("@");let n="";t.length>1&&(n=t[0]+"@",i=t[1]),i=i.replace(I0,".");const r=i.split("."),a=R0(r,e).join(".");return n+a}function Ru(i){const e=[];let t=0;const n=i.length;for(;t<n;){const r=i.charCodeAt(t++);if(r>=55296&&r<=56319&&t<n){const a=i.charCodeAt(t++);(a&64512)==56320?e.push(((r&1023)<<10)+(a&1023)+65536):(e.push(r),t--)}else e.push(r)}return e}const O0=i=>String.fromCodePoint(...i),N0=function(i){return i>=48&&i<58?26+(i-48):i>=65&&i<91?i-65:i>=97&&i<123?i-97:fi},ac=function(i,e){return i+22+75*(i<26)-((e!=0)<<5)},Ou=function(i,e,t){let n=0;for(i=t?pi(i/D0):i>>1,i+=pi(i/e);i>fs*rr>>1;n+=fi)i=pi(i/fs);return pi(n+(fs+1)*i/(i+L0))},Nu=function(i){const e=[],t=i.length;let n=0,r=Fu,a=Bu,s=i.lastIndexOf(Iu);s<0&&(s=0);for(let o=0;o<s;++o)i.charCodeAt(o)>=128&&Di("not-basic"),e.push(i.charCodeAt(o));for(let o=s>0?s+1:0;o<t;){const l=n;for(let f=1,c=fi;;c+=fi){o>=t&&Di("invalid-input");const d=N0(i.charCodeAt(o++));d>=fi&&Di("invalid-input"),d>pi((wn-n)/f)&&Di("overflow"),n+=d*f;const h=c<=a?Ao:c>=a+rr?rr:c-a;if(d<h)break;const p=fi-h;f>pi(wn/p)&&Di("overflow"),f*=p}const u=e.length+1;a=Ou(n-l,u,l==0),pi(n/u)>wn-r&&Di("overflow"),r+=pi(n/u),n%=u,e.splice(n++,0,r)}return String.fromCodePoint(...e)},Hu=function(i){const e=[];i=Ru(i);const t=i.length;let n=Fu,r=0,a=Bu;for(const l of i)l<128&&e.push(ps(l));const s=e.length;let o=s;for(s&&e.push(Iu);o<t;){let l=wn;for(const f of i)f>=n&&f<l&&(l=f);const u=o+1;l-n>pi((wn-r)/u)&&Di("overflow"),r+=(l-n)*u,n=l;for(const f of i)if(f<n&&++r>wn&&Di("overflow"),f===n){let c=r;for(let d=fi;;d+=fi){const h=d<=a?Ao:d>=a+rr?rr:d-a;if(c<h)break;const p=c-h,m=fi-h;e.push(ps(ac(h+p%m,0))),c=pi(p/m)}e.push(ps(ac(c,0))),a=Ou(r,u,o===s),r=0,++o}++r,++n}return e.join("")},H0=function(i){return Pu(i,function(e){return B0.test(e)?Nu(e.slice(4).toLowerCase()):e})},z0=function(i){return Pu(i,function(e){return F0.test(e)?"xn--"+Hu(e):e})},zu={version:"2.3.1",ucs2:{decode:Ru,encode:O0},decode:Nu,encode:Hu,toASCII:z0,toUnicode:H0},V0={options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:100},components:{core:{},block:{},inline:{}}},U0={options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["normalize","block","inline","text_join"]},block:{rules:["paragraph"]},inline:{rules:["text"],rules2:["balance_pairs","fragments_join"]}}},W0={options:{html:!0,xhtmlOut:!0,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["normalize","block","inline","text_join"]},block:{rules:["blockquote","code","fence","heading","hr","html_block","lheading","list","reference","paragraph"]},inline:{rules:["autolink","backticks","emphasis","entity","escape","html_inline","image","link","newline","text"],rules2:["balance_pairs","emphasis","fragments_join"]}}},G0={default:V0,zero:U0,commonmark:W0},q0=/^(vbscript|javascript|file|data):/,j0=/^data:image\/(gif|png|jpeg|webp);/;function $0(i){const e=i.trim().toLowerCase();return q0.test(e)?j0.test(e):!0}const Vu=["http:","https:","mailto:"];function Y0(i){const e=wo(i,!0);if(e.hostname&&(!e.protocol||Vu.indexOf(e.protocol)>=0))try{e.hostname=zu.toASCII(e.hostname)}catch{}return cr(yo(e))}function K0(i){const e=wo(i,!0);if(e.hostname&&(!e.protocol||Vu.indexOf(e.protocol)>=0))try{e.hostname=zu.toUnicode(e.hostname)}catch{}return Cn(yo(e),Cn.defaultChars+"%")}function Qt(i,e){if(!(this instanceof Qt))return new Qt(i,e);e||xo(i)||(e=i||{},i="default"),this.inline=new dr,this.block=new aa,this.core=new Co,this.renderer=new Tn,this.linkify=new Nt,this.validateLink=$0,this.normalizeLink=Y0,this.normalizeLinkText=K0,this.utils=Zf,this.helpers=na({},tp),this.options={},this.configure(i),e&&this.set(e)}Qt.prototype.set=function(i){return na(this.options,i),this};Qt.prototype.configure=function(i){const e=this;if(xo(i)){const t=i;if(i=G0[t],!i)throw new Error('Wrong `markdown-it` preset "'+t+'", check name')}if(!i)throw new Error("Wrong `markdown-it` preset, can't be empty");return i.options&&e.set(i.options),i.components&&Object.keys(i.components).forEach(function(t){i.components[t].rules&&e[t].ruler.enableOnly(i.components[t].rules),i.components[t].rules2&&e[t].ruler2.enableOnly(i.components[t].rules2)}),this};Qt.prototype.enable=function(i,e){let t=[];Array.isArray(i)||(i=[i]),["core","block","inline"].forEach(function(r){t=t.concat(this[r].ruler.enable(i,!0))},this),t=t.concat(this.inline.ruler2.enable(i,!0));const n=i.filter(function(r){return t.indexOf(r)<0});if(n.length&&!e)throw new Error("MarkdownIt. Failed to enable unknown rule(s): "+n);return this};Qt.prototype.disable=function(i,e){let t=[];Array.isArray(i)||(i=[i]),["core","block","inline"].forEach(function(r){t=t.concat(this[r].ruler.disable(i,!0))},this),t=t.concat(this.inline.ruler2.disable(i,!0));const n=i.filter(function(r){return t.indexOf(r)<0});if(n.length&&!e)throw new Error("MarkdownIt. Failed to disable unknown rule(s): "+n);return this};Qt.prototype.use=function(i){const e=[this].concat(Array.prototype.slice.call(arguments,1));return i.apply(i,e),this};Qt.prototype.parse=function(i,e){if(typeof i!="string")throw new Error("Input data should be a String");const t=new this.core.State(i,this,e);return this.core.process(t),t.tokens};Qt.prototype.render=function(i,e){return e=e||{},this.renderer.render(this.parse(i,e),this.options,e)};Qt.prototype.parseInline=function(i,e){const t=new this.core.State(i,this,e);return t.inlineMode=!0,this.core.process(t),t.tokens};Qt.prototype.renderInline=function(i,e){return e=e||{},this.renderer.render(this.parseInline(i,e),this.options,e)};class Uu extends ht{app;constructor(e){super({title:"Changelog",width:600,height:500,win_id:"changelog"}),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=Qt(),n=t.renderer.rules.link_open||function(o,l,u,f,c){return c.renderToken(o,l,u)};t.renderer.rules.link_open=function(o,l,u,f,c){return o[l].attrSet("target","_blank"),n(o,l,u,f,c)};const r=document.createElement("div");r.classList.add("markdown-container"),fetch("/smeditor/assets/app/changelog.json").then(o=>o.json()).then(o=>{r.innerHTML=o.map(l=>`# ${l.version}
---
`+l.changelog).map(l=>`<div>${t.render(l)}</div>`).join("")}),e.appendChild(r);const a=document.createElement("div");a.classList.add("menu-options"),a.style.justifyContent="flex-end";const s=document.createElement("button");s.innerText="Close",s.onclick=()=>{this.closeWindow()},s.classList.add("confirm"),a.append(s),e.appendChild(a),this.viewElement.appendChild(e)}}const sc=globalThis.showDirectoryPicker;async function X0(i={}){if(sc&&!i._preferPolyfill)return sc(i);const e=document.createElement("input");e.type="file",e.webkitdirectory=!0,e.multiple=!0,e.style.position="fixed",e.style.top="-100000px",e.style.left="-100000px",document.body.appendChild(e);const{makeDirHandleFromFileList:t}=await qe(async()=>{const{makeDirHandleFromFileList:n}=await Promise.resolve().then(()=>Zc);return{makeDirHandleFromFileList:n}},void 0);return new Promise((n,r)=>{e.addEventListener("change",()=>{t(e.files).then(n).catch(r),document.body.removeChild(e)}),e.click()})}const oc=globalThis.showOpenFilePicker;async function Wu(i={}){if(oc&&!i._preferPolyfill)return oc(i);const e=document.createElement("input");e.type="file",e.multiple=!!i.multiple,e.accept=(i.accepts||[]).map(n=>[...(n.extensions||[]).map(r=>"."+r),...n.mimeTypes||[]]).flat().join(","),e.style.position="fixed",e.style.top="-100000px",e.style.left="-100000px",document.body.appendChild(e);const{makeFileHandlesFromFileList:t}=await qe(async()=>{const{makeFileHandlesFromFileList:n}=await Promise.resolve().then(()=>Zc);return{makeFileHandlesFromFileList:n}},void 0);return new Promise((n,r)=>{e.addEventListener("change",()=>{t(e.files).then(n).catch(r),document.body.removeChild(e)}),e.click()})}const lc=globalThis.showSaveFilePicker;async function Z0(i={}){if(lc&&!i._preferPolyfill)return lc(i);const{FileSystemFileHandle:e}=await qe(async()=>{const{FileSystemFileHandle:n}=await Promise.resolve().then(()=>Gu);return{FileSystemFileHandle:n}},void 0),{FileHandle:t}=await qe(async()=>{const{FileHandle:n}=await import("./downloader-DjQwgpik.js");return{FileHandle:n}},__vite__mapDeps([3,1,2]));return new e(new t(i.suggestedName))}const ln=Symbol("adapter");let ko=class{constructor(e){this.kind=e.kind,this.name=e.name,this[ln]=e}get isFile(){return this.kind==="file"}get isDirectory(){return this.kind==="directory"}async queryPermission(e={mode:"read"}){const t=this[ln];if(t.queryPermission)return t.queryPermission(e);if(e.mode==="read")return"granted";if(e.mode==="readwrite")return t.writable?"granted":"denied";throw new TypeError(`Mode ${e.mode} must be 'read' or 'readwrite'`)}async requestPermission(e={mode:"read"}){const t=this[ln];if(t.requestPermission)return t.requestPermission(e);if(e.mode==="read")return"granted";if(e.mode==="readwrite")return t.writable?"granted":"denied";throw new TypeError(`Mode ${e.mode} must be 'read' or 'readwrite'`)}async isSameEntry(e){return this===e?!0:this.kind!==e.kind||!e[ln]?!1:await this[ln].isSameEntry(e[ln])}};Object.defineProperty(ko.prototype,Symbol.toStringTag,{value:"FileSystemHandle",writable:!1,enumerable:!1,configurable:!0});const ms=Symbol("adapter");let ar=class extends ko{constructor(e){super(e),this.kind="file",this[ms]=e}async createWritable(e={}){const{FileSystemWritableFileStream:t}=await qe(async()=>{const{FileSystemWritableFileStream:n}=await import("./FileSystemWritableFileStream-D05uA35V.js");return{FileSystemWritableFileStream:n}},__vite__mapDeps([4,5]));return new t(await this[ms].createWritable(e))}async getFile(){return this[ms].getFile()}};Object.defineProperty(ar.prototype,Symbol.toStringTag,{value:"FileSystemFileHandle",writable:!1,enumerable:!1,configurable:!0});Object.defineProperties(ar.prototype,{createWritable:{enumerable:!0},getFile:{enumerable:!0}});const Gu=Object.freeze(Object.defineProperty({__proto__:null,FileSystemFileHandle:ar},Symbol.toStringTag,{value:"Module"})),cn=Symbol("adapter");class rn extends ko{constructor(e){super(e),this.kind="directory",this[cn]=e}async getDirectoryHandle(e,t={}){if(e==="")throw new TypeError("Name can't be an empty string.");if(e==="."||e===".."||e.includes("/"))throw new TypeError("Name contains invalid characters.");return new rn(await this[cn].getDirectoryHandle(e,t))}getDirectory(e,t={}){return this.getDirectoryHandle(e,t)}async*entries(){for await(const[e,t]of this[cn].entries())yield[t.name,t.kind==="file"?new ar(t):new rn(t)]}async*getEntries(){return this.entries()}async*keys(){for await(const[e]of this[cn].entries())yield e}async*values(){for await(const[e,t]of this.entries())yield t}async getFileHandle(e,t={}){if(e==="")throw new TypeError("Name can't be an empty string.");if(e==="."||e===".."||e.includes("/"))throw new TypeError("Name contains invalid characters.");return t.create=!!t.create,new ar(await this[cn].getFileHandle(e,t))}getFile(e,t={}){return this.getFileHandle(e,t)}async removeEntry(e,t={}){if(e==="")throw new TypeError("Name can't be an empty string.");if(e==="."||e===".."||e.includes("/"))throw new TypeError("Name contains invalid characters.");return t.recursive=!!t.recursive,this[cn].removeEntry(e,t)}async resolve(e){if(await e.isSameEntry(this))return[];const t=[{handle:this,path:[]}];for(;t.length;){let{handle:n,path:r}=t.pop();for await(const a of n.values()){if(await a.isSameEntry(e))return[...r,a.name];a.kind==="directory"&&t.push({handle:a,path:[...r,a.name]})}}return null}[Symbol.asyncIterator](){return this.entries()}}Object.defineProperty(rn.prototype,Symbol.toStringTag,{value:"FileSystemDirectoryHandle",writable:!1,enumerable:!1,configurable:!0});Object.defineProperties(rn.prototype,{getDirectoryHandle:{enumerable:!0},entries:{enumerable:!0},getFileHandle:{enumerable:!0},removeEntry:{enumerable:!0}});const Q0=Object.freeze(Object.defineProperty({__proto__:null,FileSystemDirectoryHandle:rn},Symbol.toStringTag,{value:"Module"}));async function cc(i,e={}){var t,n,r,a;if(!i){if(!(!((t=globalThis.navigator)===null||t===void 0)&&t.storage)&&((n=globalThis.location)===null||n===void 0?void 0:n.protocol)==="http:")throw new Error("Native getDirectory not supported in HTTP context. Please use HTTPS instead or provide an adapter.");if(!(!((a=(r=globalThis.navigator)===null||r===void 0?void 0:r.storage)===null||a===void 0)&&a.getDirectory))throw new Error("Native StorageManager.getDirectory() is not supported in current environment. Please provide an adapter instead.");return globalThis.navigator.storage.getDirectory()}const s=await i,o=typeof s=="function"?await s(e):await s.default(e);return new rn(o)}var gs,bs;const J0={adapter:{native:typeof((bs=(gs=globalThis.navigator)===null||gs===void 0?void 0:gs.storage)===null||bs===void 0?void 0:bs.getDirectory)=="function"}},uc=i=>typeof i=="object"&&i!=null&&i.nodeType===1,dc=(i,e)=>(!e||i!=="hidden")&&i!=="visible"&&i!=="clip",ys=(i,e)=>{if(i.clientHeight<i.scrollHeight||i.clientWidth<i.scrollWidth){const t=getComputedStyle(i,null);return dc(t.overflowY,e)||dc(t.overflowX,e)||(n=>{const r=(a=>{if(!a.ownerDocument||!a.ownerDocument.defaultView)return null;try{return a.ownerDocument.defaultView.frameElement}catch{return null}})(n);return!!r&&(r.clientHeight<n.scrollHeight||r.clientWidth<n.scrollWidth)})(i)}return!1},br=(i,e,t,n,r,a,s,o)=>a<i&&s>e||a>i&&s<e?0:a<=i&&o<=t||s>=e&&o>=t?a-i-n:s>e&&o<t||a<i&&o>t?s-e+r:0,em=i=>{const e=i.parentElement;return e??(i.getRootNode().host||null)},hc=(i,e)=>{var t,n,r,a;if(typeof document>"u")return[];const{scrollMode:s,block:o,inline:l,boundary:u,skipOverflowHiddenElements:f}=e,c=typeof u=="function"?u:Y=>Y!==u;if(!uc(i))throw new TypeError("Invalid target");const d=document.scrollingElement||document.documentElement,h=[];let p=i;for(;uc(p)&&c(p);){if(p=em(p),p===d){h.push(p);break}p!=null&&p===document.body&&ys(p)&&!ys(document.documentElement)||p!=null&&ys(p,f)&&h.push(p)}const m=(n=(t=window.visualViewport)==null?void 0:t.width)!=null?n:innerWidth,g=(a=(r=window.visualViewport)==null?void 0:r.height)!=null?a:innerHeight,{scrollX:y,scrollY:x}=window,{height:w,width:_,top:C,right:F,bottom:T,left:R}=i.getBoundingClientRect(),{top:N,right:j,bottom:ae,left:L}=(Y=>{const D=window.getComputedStyle(Y);return{top:parseFloat(D.scrollMarginTop)||0,right:parseFloat(D.scrollMarginRight)||0,bottom:parseFloat(D.scrollMarginBottom)||0,left:parseFloat(D.scrollMarginLeft)||0}})(i);let O=o==="start"||o==="nearest"?C-N:o==="end"?T+ae:C+w/2-N+ae,v=l==="center"?R+_/2-L+j:l==="end"?F+j:R-L;const S=[];for(let Y=0;Y<h.length;Y++){const D=h[Y],{height:G,width:V,top:J,right:H,bottom:P,left:re}=D.getBoundingClientRect();if(s==="if-needed"&&C>=0&&R>=0&&T<=g&&F<=m&&C>=J&&T<=P&&R>=re&&F<=H)return S;const ne=getComputedStyle(D),te=parseInt(ne.borderLeftWidth,10),Me=parseInt(ne.borderTopWidth,10),He=parseInt(ne.borderRightWidth,10),_e=parseInt(ne.borderBottomWidth,10);let ve=0,Le=0;const Be="offsetWidth"in D?D.offsetWidth-D.clientWidth-te-He:0,ct="offsetHeight"in D?D.offsetHeight-D.clientHeight-Me-_e:0,ut="offsetWidth"in D?D.offsetWidth===0?0:V/D.offsetWidth:0,E="offsetHeight"in D?D.offsetHeight===0?0:G/D.offsetHeight:0;if(d===D)ve=o==="start"?O:o==="end"?O-g:o==="nearest"?br(x,x+g,g,Me,_e,x+O,x+O+w,w):O-g/2,Le=l==="start"?v:l==="center"?v-m/2:l==="end"?v-m:br(y,y+m,m,te,He,y+v,y+v+_,_),ve=Math.max(0,ve+x),Le=Math.max(0,Le+y);else{ve=o==="start"?O-J-Me:o==="end"?O-P+_e+ct:o==="nearest"?br(J,P,G,Me,_e+ct,O,O+w,w):O-(J+G/2)+ct/2,Le=l==="start"?v-re-te:l==="center"?v-(re+V/2)+Be/2:l==="end"?v-H+He+Be:br(re,H,V,te,He+Be,v,v+_,_);const{scrollLeft:X,scrollTop:q}=D;ve=E===0?0:Math.max(0,Math.min(q+ve/E,D.scrollHeight-G/E+ct)),Le=ut===0?0:Math.max(0,Math.min(X+Le/ut,D.scrollWidth-V/ut+Be)),O+=q-ve,v+=X-Le}S.push({el:D,top:ve,left:Le})}return S},tm=i=>i===!1?{block:"end",inline:"nearest"}:(e=>e===Object(e)&&Object.keys(e).length!==0)(i)?i:{block:"start",inline:"nearest"};function $n(i,e){if(!i.isConnected||!(r=>{let a=r;for(;a&&a.parentNode;){if(a.parentNode===document)return!0;a=a.parentNode instanceof ShadowRoot?a.parentNode.host:a.parentNode}return!1})(i))return;const t=(r=>{const a=window.getComputedStyle(r);return{top:parseFloat(a.scrollMarginTop)||0,right:parseFloat(a.scrollMarginRight)||0,bottom:parseFloat(a.scrollMarginBottom)||0,left:parseFloat(a.scrollMarginLeft)||0}})(i);if((r=>typeof r=="object"&&typeof r.behavior=="function")(e))return e.behavior(hc(i,e));const n=typeof e=="boolean"||e==null?void 0:e.behavior;for(const{el:r,top:a,left:s}of hc(i,tm(e))){const o=a-t.top+t.bottom,l=s-t.left+t.right;r.scroll({top:o,left:l,behavior:n})}}function Lt(i,e){if(window.nw)return nw.require("path").basename(i,e);let t=To(i)[2];return e&&t.slice(-1*e.length)===e&&(t=t.slice(0,t.length-e.length)),t}function ot(i){if(window.nw)return nw.require("path").dirname(i);const e=To(i),t=e[0];let n=e[1];return!t&&!n?"":(n&&(n=n.slice(0,n.length-1)),t+n)}function Tt(i){return window.nw?nw.require("path").extname(i):To(i)[3]}const im=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^/]+?|)(\.[^./]*|))(?:[/]*)$/;function To(i){return im.exec(i).slice(1)}const{GONE:qu}=gn;FileSystemFileHandle;class So{_path;kind="file";name;isFile=!0;isDirectory=!1;constructor(e){this._path=e,this.name=new URL(e).pathname.split("/").pop()??""}async getFile(){return fetch(this._path).then(e=>e.blob()).then(e=>new File([e],this.name)).catch(()=>{throw new DOMException(...qu)})}async createWritable(){throw Error("Cannot call createWriteable from a URLFileHandle")}async isSameEntry(e){return FileSystemHandle instanceof So?e._path==this._path:!1}async queryPermission(){return"granted"}async requestPermission(){return"granted"}}class nm{async handleDropEvent(e,t){throw Error("Cannot call handleDropEvent from a URLFileHandler")}async getDirectoryHandle(e,t,n){throw Error("Cannot call getDirectoryHandle from a URLFileHandler")}async hasFile(e){return fetch(e).then(t=>t.ok).catch(()=>!1)}async getFileHandle(e,t){try{if(!await this.hasFile(e))throw new DOMException(...qu);return new So(e)}catch(n){console.error("Failed to get file "+e+": "+n);return}}async getFileHandleRelativeTo(e,t){const n=new URL(e);Tt(n.pathname)!=""&&(n.pathname=n.pathname.split("/").slice(0,-1).join("/")),n.pathname+="/"+t;try{return this.getFileHandle(n.toString())}catch(r){console.error("Failed to get relative file "+n+": "+r);return}}async getDirectoryFiles(e){throw Error("Cannot call getDirectoryFiles from a URLFileHandler")}async getDirectoryFolders(e){throw Error("Cannot call getDirectoryFolders from a URLFileHandler")}async writeFile(e,t){throw Error("Cannot save to a URL file!")}async removeFile(e){throw Error("Cannot remove a URL file!")}getRelativePath(e,t){throw Error("Cannot call getRelativePath from a URLFileHandler")}resolvePath(){throw Error("Cannot call resolvePath from a URLFileHandler")}}function yr(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ws={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/var fc;function rm(){return fc||(fc=1,function(i,e){(function(t){i.exports=t()})(function(){return function t(n,r,a){function s(u,f){if(!r[u]){if(!n[u]){var c=typeof yr=="function"&&yr;if(!f&&c)return c(u,!0);if(o)return o(u,!0);var d=new Error("Cannot find module '"+u+"'");throw d.code="MODULE_NOT_FOUND",d}var h=r[u]={exports:{}};n[u][0].call(h.exports,function(p){var m=n[u][1][p];return s(m||p)},h,h.exports,t,n,r,a)}return r[u].exports}for(var o=typeof yr=="function"&&yr,l=0;l<a.length;l++)s(a[l]);return s}({1:[function(t,n,r){var a=t("./utils"),s=t("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(l){for(var u,f,c,d,h,p,m,g=[],y=0,x=l.length,w=x,_=a.getTypeOf(l)!=="string";y<l.length;)w=x-y,c=_?(u=l[y++],f=y<x?l[y++]:0,y<x?l[y++]:0):(u=l.charCodeAt(y++),f=y<x?l.charCodeAt(y++):0,y<x?l.charCodeAt(y++):0),d=u>>2,h=(3&u)<<4|f>>4,p=1<w?(15&f)<<2|c>>6:64,m=2<w?63&c:64,g.push(o.charAt(d)+o.charAt(h)+o.charAt(p)+o.charAt(m));return g.join("")},r.decode=function(l){var u,f,c,d,h,p,m=0,g=0,y="data:";if(l.substr(0,y.length)===y)throw new Error("Invalid base64 input, it looks like a data url.");var x,w=3*(l=l.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(l.charAt(l.length-1)===o.charAt(64)&&w--,l.charAt(l.length-2)===o.charAt(64)&&w--,w%1!=0)throw new Error("Invalid base64 input, bad content length.");for(x=s.uint8array?new Uint8Array(0|w):new Array(0|w);m<l.length;)u=o.indexOf(l.charAt(m++))<<2|(d=o.indexOf(l.charAt(m++)))>>4,f=(15&d)<<4|(h=o.indexOf(l.charAt(m++)))>>2,c=(3&h)<<6|(p=o.indexOf(l.charAt(m++))),x[g++]=u,h!==64&&(x[g++]=f),p!==64&&(x[g++]=c);return x}},{"./support":30,"./utils":32}],2:[function(t,n,r){var a=t("./external"),s=t("./stream/DataWorker"),o=t("./stream/Crc32Probe"),l=t("./stream/DataLengthProbe");function u(f,c,d,h,p){this.compressedSize=f,this.uncompressedSize=c,this.crc32=d,this.compression=h,this.compressedContent=p}u.prototype={getContentWorker:function(){var f=new s(a.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new l("data_length")),c=this;return f.on("end",function(){if(this.streamInfo.data_length!==c.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),f},getCompressedWorker:function(){return new s(a.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},u.createWorkerFrom=function(f,c,d){return f.pipe(new o).pipe(new l("uncompressedSize")).pipe(c.compressWorker(d)).pipe(new l("compressedSize")).withStreamInfo("compression",c)},n.exports=u},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,n,r){var a=t("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new a("STORE compression")},uncompressWorker:function(){return new a("STORE decompression")}},r.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,n,r){var a=t("./utils"),s=function(){for(var o,l=[],u=0;u<256;u++){o=u;for(var f=0;f<8;f++)o=1&o?3988292384^o>>>1:o>>>1;l[u]=o}return l}();n.exports=function(o,l){return o!==void 0&&o.length?a.getTypeOf(o)!=="string"?function(u,f,c,d){var h=s,p=d+c;u^=-1;for(var m=d;m<p;m++)u=u>>>8^h[255&(u^f[m])];return-1^u}(0|l,o,o.length,0):function(u,f,c,d){var h=s,p=d+c;u^=-1;for(var m=d;m<p;m++)u=u>>>8^h[255&(u^f.charCodeAt(m))];return-1^u}(0|l,o,o.length,0):0}},{"./utils":32}],5:[function(t,n,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(t,n,r){var a=null;a=typeof Promise<"u"?Promise:t("lie"),n.exports={Promise:a}},{lie:37}],7:[function(t,n,r){var a=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",s=t("pako"),o=t("./utils"),l=t("./stream/GenericWorker"),u=a?"uint8array":"array";function f(c,d){l.call(this,"FlateWorker/"+c),this._pako=null,this._pakoAction=c,this._pakoOptions=d,this.meta={}}r.magic="\b\0",o.inherits(f,l),f.prototype.processChunk=function(c){this.meta=c.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(u,c.data),!1)},f.prototype.flush=function(){l.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},f.prototype.cleanUp=function(){l.prototype.cleanUp.call(this),this._pako=null},f.prototype._createPako=function(){this._pako=new s[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var c=this;this._pako.onData=function(d){c.push({data:d,meta:c.meta})}},r.compressWorker=function(c){return new f("Deflate",c)},r.uncompressWorker=function(){return new f("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,n,r){function a(h,p){var m,g="";for(m=0;m<p;m++)g+=String.fromCharCode(255&h),h>>>=8;return g}function s(h,p,m,g,y,x){var w,_,C=h.file,F=h.compression,T=x!==u.utf8encode,R=o.transformTo("string",x(C.name)),N=o.transformTo("string",u.utf8encode(C.name)),j=C.comment,ae=o.transformTo("string",x(j)),L=o.transformTo("string",u.utf8encode(j)),O=N.length!==C.name.length,v=L.length!==j.length,S="",Y="",D="",G=C.dir,V=C.date,J={crc32:0,compressedSize:0,uncompressedSize:0};p&&!m||(J.crc32=h.crc32,J.compressedSize=h.compressedSize,J.uncompressedSize=h.uncompressedSize);var H=0;p&&(H|=8),T||!O&&!v||(H|=2048);var P=0,re=0;G&&(P|=16),y==="UNIX"?(re=798,P|=function(te,Me){var He=te;return te||(He=Me?16893:33204),(65535&He)<<16}(C.unixPermissions,G)):(re=20,P|=function(te){return 63&(te||0)}(C.dosPermissions)),w=V.getUTCHours(),w<<=6,w|=V.getUTCMinutes(),w<<=5,w|=V.getUTCSeconds()/2,_=V.getUTCFullYear()-1980,_<<=4,_|=V.getUTCMonth()+1,_<<=5,_|=V.getUTCDate(),O&&(Y=a(1,1)+a(f(R),4)+N,S+="up"+a(Y.length,2)+Y),v&&(D=a(1,1)+a(f(ae),4)+L,S+="uc"+a(D.length,2)+D);var ne="";return ne+=`
\0`,ne+=a(H,2),ne+=F.magic,ne+=a(w,2),ne+=a(_,2),ne+=a(J.crc32,4),ne+=a(J.compressedSize,4),ne+=a(J.uncompressedSize,4),ne+=a(R.length,2),ne+=a(S.length,2),{fileRecord:c.LOCAL_FILE_HEADER+ne+R+S,dirRecord:c.CENTRAL_FILE_HEADER+a(re,2)+ne+a(ae.length,2)+"\0\0\0\0"+a(P,4)+a(g,4)+R+S+ae}}var o=t("../utils"),l=t("../stream/GenericWorker"),u=t("../utf8"),f=t("../crc32"),c=t("../signature");function d(h,p,m,g){l.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=p,this.zipPlatform=m,this.encodeFileName=g,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(d,l),d.prototype.push=function(h){var p=h.meta.percent||0,m=this.entriesCount,g=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,l.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:m?(p+100*(m-g-1))/m:100}}))},d.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var p=this.streamFiles&&!h.file.dir;if(p){var m=s(h,p,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},d.prototype.closedSource=function(h){this.accumulate=!1;var p=this.streamFiles&&!h.file.dir,m=s(h,p,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),p)this.push({data:function(g){return c.DATA_DESCRIPTOR+a(g.crc32,4)+a(g.compressedSize,4)+a(g.uncompressedSize,4)}(h),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},d.prototype.flush=function(){for(var h=this.bytesWritten,p=0;p<this.dirRecords.length;p++)this.push({data:this.dirRecords[p],meta:{percent:100}});var m=this.bytesWritten-h,g=function(y,x,w,_,C){var F=o.transformTo("string",C(_));return c.CENTRAL_DIRECTORY_END+"\0\0\0\0"+a(y,2)+a(y,2)+a(x,4)+a(w,4)+a(F.length,2)+F}(this.dirRecords.length,m,h,this.zipComment,this.encodeFileName);this.push({data:g,meta:{percent:100}})},d.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},d.prototype.registerPrevious=function(h){this._sources.push(h);var p=this;return h.on("data",function(m){p.processChunk(m)}),h.on("end",function(){p.closedSource(p.previous.streamInfo),p._sources.length?p.prepareNextSource():p.end()}),h.on("error",function(m){p.error(m)}),this},d.prototype.resume=function(){return!!l.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},d.prototype.error=function(h){var p=this._sources;if(!l.prototype.error.call(this,h))return!1;for(var m=0;m<p.length;m++)try{p[m].error(h)}catch{}return!0},d.prototype.lock=function(){l.prototype.lock.call(this);for(var h=this._sources,p=0;p<h.length;p++)h[p].lock()},n.exports=d},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,n,r){var a=t("../compressions"),s=t("./ZipFileWorker");r.generateWorker=function(o,l,u){var f=new s(l.streamFiles,u,l.platform,l.encodeFileName),c=0;try{o.forEach(function(d,h){c++;var p=function(x,w){var _=x||w,C=a[_];if(!C)throw new Error(_+" is not a valid compression method !");return C}(h.options.compression,l.compression),m=h.options.compressionOptions||l.compressionOptions||{},g=h.dir,y=h.date;h._compressWorker(p,m).withStreamInfo("file",{name:d,dir:g,date:y,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(f)}),f.entriesCount=c}catch(d){f.error(d)}return f}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,n,r){function a(){if(!(this instanceof a))return new a;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var s=new a;for(var o in this)typeof this[o]!="function"&&(s[o]=this[o]);return s}}(a.prototype=t("./object")).loadAsync=t("./load"),a.support=t("./support"),a.defaults=t("./defaults"),a.version="3.10.1",a.loadAsync=function(s,o){return new a().loadAsync(s,o)},a.external=t("./external"),n.exports=a},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,n,r){var a=t("./utils"),s=t("./external"),o=t("./utf8"),l=t("./zipEntries"),u=t("./stream/Crc32Probe"),f=t("./nodejsUtils");function c(d){return new s.Promise(function(h,p){var m=d.decompressed.getContentWorker().pipe(new u);m.on("error",function(g){p(g)}).on("end",function(){m.streamInfo.crc32!==d.decompressed.crc32?p(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}n.exports=function(d,h){var p=this;return h=a.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),f.isNode&&f.isStream(d)?s.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):a.prepareContent("the loaded zip file",d,!0,h.optimizedBinaryString,h.base64).then(function(m){var g=new l(h);return g.load(m),g}).then(function(m){var g=[s.Promise.resolve(m)],y=m.files;if(h.checkCRC32)for(var x=0;x<y.length;x++)g.push(c(y[x]));return s.Promise.all(g)}).then(function(m){for(var g=m.shift(),y=g.files,x=0;x<y.length;x++){var w=y[x],_=w.fileNameStr,C=a.resolve(w.fileNameStr);p.file(C,w.decompressed,{binary:!0,optimizedBinaryString:!0,date:w.date,dir:w.dir,comment:w.fileCommentStr.length?w.fileCommentStr:null,unixPermissions:w.unixPermissions,dosPermissions:w.dosPermissions,createFolders:h.createFolders}),w.dir||(p.file(C).unsafeOriginalName=_)}return g.zipComment.length&&(p.comment=g.zipComment),p})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,n,r){var a=t("../utils"),s=t("../stream/GenericWorker");function o(l,u){s.call(this,"Nodejs stream input adapter for "+l),this._upstreamEnded=!1,this._bindStream(u)}a.inherits(o,s),o.prototype._bindStream=function(l){var u=this;(this._stream=l).pause(),l.on("data",function(f){u.push({data:f,meta:{percent:0}})}).on("error",function(f){u.isPaused?this.generatedError=f:u.error(f)}).on("end",function(){u.isPaused?u._upstreamEnded=!0:u.end()})},o.prototype.pause=function(){return!!s.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},n.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,n,r){var a=t("readable-stream").Readable;function s(o,l,u){a.call(this,l),this._helper=o;var f=this;o.on("data",function(c,d){f.push(c)||f._helper.pause(),u&&u(d)}).on("error",function(c){f.emit("error",c)}).on("end",function(){f.push(null)})}t("../utils").inherits(s,a),s.prototype._read=function(){this._helper.resume()},n.exports=s},{"../utils":32,"readable-stream":16}],14:[function(t,n,r){n.exports={isNode:typeof Buffer<"u",newBufferFrom:function(a,s){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(a,s);if(typeof a=="number")throw new Error('The "data" argument must not be a number');return new Buffer(a,s)},allocBuffer:function(a){if(Buffer.alloc)return Buffer.alloc(a);var s=new Buffer(a);return s.fill(0),s},isBuffer:function(a){return Buffer.isBuffer(a)},isStream:function(a){return a&&typeof a.on=="function"&&typeof a.pause=="function"&&typeof a.resume=="function"}}},{}],15:[function(t,n,r){function a(C,F,T){var R,N=o.getTypeOf(F),j=o.extend(T||{},f);j.date=j.date||new Date,j.compression!==null&&(j.compression=j.compression.toUpperCase()),typeof j.unixPermissions=="string"&&(j.unixPermissions=parseInt(j.unixPermissions,8)),j.unixPermissions&&16384&j.unixPermissions&&(j.dir=!0),j.dosPermissions&&16&j.dosPermissions&&(j.dir=!0),j.dir&&(C=y(C)),j.createFolders&&(R=g(C))&&x.call(this,R,!0);var ae=N==="string"&&j.binary===!1&&j.base64===!1;T&&T.binary!==void 0||(j.binary=!ae),(F instanceof c&&F.uncompressedSize===0||j.dir||!F||F.length===0)&&(j.base64=!1,j.binary=!0,F="",j.compression="STORE",N="string");var L=null;L=F instanceof c||F instanceof l?F:p.isNode&&p.isStream(F)?new m(C,F):o.prepareContent(C,F,j.binary,j.optimizedBinaryString,j.base64);var O=new d(C,L,j);this.files[C]=O}var s=t("./utf8"),o=t("./utils"),l=t("./stream/GenericWorker"),u=t("./stream/StreamHelper"),f=t("./defaults"),c=t("./compressedObject"),d=t("./zipObject"),h=t("./generate"),p=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),g=function(C){C.slice(-1)==="/"&&(C=C.substring(0,C.length-1));var F=C.lastIndexOf("/");return 0<F?C.substring(0,F):""},y=function(C){return C.slice(-1)!=="/"&&(C+="/"),C},x=function(C,F){return F=F!==void 0?F:f.createFolders,C=y(C),this.files[C]||a.call(this,C,null,{dir:!0,createFolders:F}),this.files[C]};function w(C){return Object.prototype.toString.call(C)==="[object RegExp]"}var _={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(C){var F,T,R;for(F in this.files)R=this.files[F],(T=F.slice(this.root.length,F.length))&&F.slice(0,this.root.length)===this.root&&C(T,R)},filter:function(C){var F=[];return this.forEach(function(T,R){C(T,R)&&F.push(R)}),F},file:function(C,F,T){if(arguments.length!==1)return C=this.root+C,a.call(this,C,F,T),this;if(w(C)){var R=C;return this.filter(function(j,ae){return!ae.dir&&R.test(j)})}var N=this.files[this.root+C];return N&&!N.dir?N:null},folder:function(C){if(!C)return this;if(w(C))return this.filter(function(N,j){return j.dir&&C.test(N)});var F=this.root+C,T=x.call(this,F),R=this.clone();return R.root=T.name,R},remove:function(C){C=this.root+C;var F=this.files[C];if(F||(C.slice(-1)!=="/"&&(C+="/"),F=this.files[C]),F&&!F.dir)delete this.files[C];else for(var T=this.filter(function(N,j){return j.name.slice(0,C.length)===C}),R=0;R<T.length;R++)delete this.files[T[R].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(C){var F,T={};try{if((T=o.extend(C||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:s.utf8encode})).type=T.type.toLowerCase(),T.compression=T.compression.toUpperCase(),T.type==="binarystring"&&(T.type="string"),!T.type)throw new Error("No output type specified.");o.checkSupport(T.type),T.platform!=="darwin"&&T.platform!=="freebsd"&&T.platform!=="linux"&&T.platform!=="sunos"||(T.platform="UNIX"),T.platform==="win32"&&(T.platform="DOS");var R=T.comment||this.comment||"";F=h.generateWorker(this,T,R)}catch(N){(F=new l("error")).error(N)}return new u(F,T.type||"string",T.mimeType)},generateAsync:function(C,F){return this.generateInternalStream(C).accumulate(F)},generateNodeStream:function(C,F){return(C=C||{}).type||(C.type="nodebuffer"),this.generateInternalStream(C).toNodejsStream(F)}};n.exports=_},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,n,r){n.exports=t("stream")},{stream:void 0}],17:[function(t,n,r){var a=t("./DataReader");function s(o){a.call(this,o);for(var l=0;l<this.data.length;l++)o[l]=255&o[l]}t("../utils").inherits(s,a),s.prototype.byteAt=function(o){return this.data[this.zero+o]},s.prototype.lastIndexOfSignature=function(o){for(var l=o.charCodeAt(0),u=o.charCodeAt(1),f=o.charCodeAt(2),c=o.charCodeAt(3),d=this.length-4;0<=d;--d)if(this.data[d]===l&&this.data[d+1]===u&&this.data[d+2]===f&&this.data[d+3]===c)return d-this.zero;return-1},s.prototype.readAndCheckSignature=function(o){var l=o.charCodeAt(0),u=o.charCodeAt(1),f=o.charCodeAt(2),c=o.charCodeAt(3),d=this.readData(4);return l===d[0]&&u===d[1]&&f===d[2]&&c===d[3]},s.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./DataReader":18}],18:[function(t,n,r){var a=t("../utils");function s(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}s.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var l,u=0;for(this.checkOffset(o),l=this.index+o-1;l>=this.index;l--)u=(u<<8)+this.byteAt(l);return this.index+=o,u},readString:function(o){return a.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},n.exports=s},{"../utils":32}],19:[function(t,n,r){var a=t("./Uint8ArrayReader");function s(o){a.call(this,o)}t("../utils").inherits(s,a),s.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,n,r){var a=t("./DataReader");function s(o){a.call(this,o)}t("../utils").inherits(s,a),s.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},s.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},s.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},s.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./DataReader":18}],21:[function(t,n,r){var a=t("./ArrayReader");function s(o){a.call(this,o)}t("../utils").inherits(s,a),s.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var l=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},n.exports=s},{"../utils":32,"./ArrayReader":17}],22:[function(t,n,r){var a=t("../utils"),s=t("../support"),o=t("./ArrayReader"),l=t("./StringReader"),u=t("./NodeBufferReader"),f=t("./Uint8ArrayReader");n.exports=function(c){var d=a.getTypeOf(c);return a.checkSupport(d),d!=="string"||s.uint8array?d==="nodebuffer"?new u(c):s.uint8array?new f(a.transformTo("uint8array",c)):new o(a.transformTo("array",c)):new l(c)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,n,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,n,r){var a=t("./GenericWorker"),s=t("../utils");function o(l){a.call(this,"ConvertWorker to "+l),this.destType=l}s.inherits(o,a),o.prototype.processChunk=function(l){this.push({data:s.transformTo(this.destType,l.data),meta:l.meta})},n.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(t,n,r){var a=t("./GenericWorker"),s=t("../crc32");function o(){a.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(o,a),o.prototype.processChunk=function(l){this.streamInfo.crc32=s(l.data,this.streamInfo.crc32||0),this.push(l)},n.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,n,r){var a=t("../utils"),s=t("./GenericWorker");function o(l){s.call(this,"DataLengthProbe for "+l),this.propName=l,this.withStreamInfo(l,0)}a.inherits(o,s),o.prototype.processChunk=function(l){if(l){var u=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=u+l.data.length}s.prototype.processChunk.call(this,l)},n.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(t,n,r){var a=t("../utils"),s=t("./GenericWorker");function o(l){s.call(this,"DataWorker");var u=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,l.then(function(f){u.dataIsReady=!0,u.data=f,u.max=f&&f.length||0,u.type=a.getTypeOf(f),u.isPaused||u._tickAndRepeat()},function(f){u.error(f)})}a.inherits(o,s),o.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,a.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(a.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var l=null,u=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":l=this.data.substring(this.index,u);break;case"uint8array":l=this.data.subarray(this.index,u);break;case"array":case"nodebuffer":l=this.data.slice(this.index,u)}return this.index=u,this.push({data:l,meta:{percent:this.max?this.index/this.max*100:0}})},n.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(t,n,r){function a(s){this.name=s||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}a.prototype={push:function(s){this.emit("data",s)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(s){this.emit("error",s)}return!0},error:function(s){return!this.isFinished&&(this.isPaused?this.generatedError=s:(this.isFinished=!0,this.emit("error",s),this.previous&&this.previous.error(s),this.cleanUp()),!0)},on:function(s,o){return this._listeners[s].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(s,o){if(this._listeners[s])for(var l=0;l<this._listeners[s].length;l++)this._listeners[s][l].call(this,o)},pipe:function(s){return s.registerPrevious(this)},registerPrevious:function(s){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=s.streamInfo,this.mergeStreamInfo(),this.previous=s;var o=this;return s.on("data",function(l){o.processChunk(l)}),s.on("end",function(){o.end()}),s.on("error",function(l){o.error(l)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var s=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),s=!0),this.previous&&this.previous.resume(),!s},flush:function(){},processChunk:function(s){this.push(s)},withStreamInfo:function(s,o){return this.extraStreamInfo[s]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var s in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,s)&&(this.streamInfo[s]=this.extraStreamInfo[s])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var s="Worker "+this.name;return this.previous?this.previous+" -> "+s:s}},n.exports=a},{}],29:[function(t,n,r){var a=t("../utils"),s=t("./ConvertWorker"),o=t("./GenericWorker"),l=t("../base64"),u=t("../support"),f=t("../external"),c=null;if(u.nodestream)try{c=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function d(p,m){return new f.Promise(function(g,y){var x=[],w=p._internalType,_=p._outputType,C=p._mimeType;p.on("data",function(F,T){x.push(F),m&&m(T)}).on("error",function(F){x=[],y(F)}).on("end",function(){try{var F=function(T,R,N){switch(T){case"blob":return a.newBlob(a.transformTo("arraybuffer",R),N);case"base64":return l.encode(R);default:return a.transformTo(T,R)}}(_,function(T,R){var N,j=0,ae=null,L=0;for(N=0;N<R.length;N++)L+=R[N].length;switch(T){case"string":return R.join("");case"array":return Array.prototype.concat.apply([],R);case"uint8array":for(ae=new Uint8Array(L),N=0;N<R.length;N++)ae.set(R[N],j),j+=R[N].length;return ae;case"nodebuffer":return Buffer.concat(R);default:throw new Error("concat : unsupported type '"+T+"'")}}(w,x),C);g(F)}catch(T){y(T)}x=[]}).resume()})}function h(p,m,g){var y=m;switch(m){case"blob":case"arraybuffer":y="uint8array";break;case"base64":y="string"}try{this._internalType=y,this._outputType=m,this._mimeType=g,a.checkSupport(y),this._worker=p.pipe(new s(y)),p.lock()}catch(x){this._worker=new o("error"),this._worker.error(x)}}h.prototype={accumulate:function(p){return d(this,p)},on:function(p,m){var g=this;return p==="data"?this._worker.on(p,function(y){m.call(g,y.data,y.meta)}):this._worker.on(p,function(){a.delay(m,arguments,g)}),this},resume:function(){return a.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(p){if(a.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new c(this,{objectMode:this._outputType!=="nodebuffer"},p)}},n.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,n,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var a=new ArrayBuffer(0);try{r.blob=new Blob([a],{type:"application/zip"}).size===0}catch{try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);s.append(a),r.blob=s.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!t("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(t,n,r){for(var a=t("./utils"),s=t("./support"),o=t("./nodejsUtils"),l=t("./stream/GenericWorker"),u=new Array(256),f=0;f<256;f++)u[f]=252<=f?6:248<=f?5:240<=f?4:224<=f?3:192<=f?2:1;u[254]=u[254]=1;function c(){l.call(this,"utf-8 decode"),this.leftOver=null}function d(){l.call(this,"utf-8 encode")}r.utf8encode=function(h){return s.nodebuffer?o.newBufferFrom(h,"utf-8"):function(p){var m,g,y,x,w,_=p.length,C=0;for(x=0;x<_;x++)(64512&(g=p.charCodeAt(x)))==55296&&x+1<_&&(64512&(y=p.charCodeAt(x+1)))==56320&&(g=65536+(g-55296<<10)+(y-56320),x++),C+=g<128?1:g<2048?2:g<65536?3:4;for(m=s.uint8array?new Uint8Array(C):new Array(C),x=w=0;w<C;x++)(64512&(g=p.charCodeAt(x)))==55296&&x+1<_&&(64512&(y=p.charCodeAt(x+1)))==56320&&(g=65536+(g-55296<<10)+(y-56320),x++),g<128?m[w++]=g:(g<2048?m[w++]=192|g>>>6:(g<65536?m[w++]=224|g>>>12:(m[w++]=240|g>>>18,m[w++]=128|g>>>12&63),m[w++]=128|g>>>6&63),m[w++]=128|63&g);return m}(h)},r.utf8decode=function(h){return s.nodebuffer?a.transformTo("nodebuffer",h).toString("utf-8"):function(p){var m,g,y,x,w=p.length,_=new Array(2*w);for(m=g=0;m<w;)if((y=p[m++])<128)_[g++]=y;else if(4<(x=u[y]))_[g++]=65533,m+=x-1;else{for(y&=x===2?31:x===3?15:7;1<x&&m<w;)y=y<<6|63&p[m++],x--;1<x?_[g++]=65533:y<65536?_[g++]=y:(y-=65536,_[g++]=55296|y>>10&1023,_[g++]=56320|1023&y)}return _.length!==g&&(_.subarray?_=_.subarray(0,g):_.length=g),a.applyFromCharCode(_)}(h=a.transformTo(s.uint8array?"uint8array":"array",h))},a.inherits(c,l),c.prototype.processChunk=function(h){var p=a.transformTo(s.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(s.uint8array){var m=p;(p=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),p.set(m,this.leftOver.length)}else p=this.leftOver.concat(p);this.leftOver=null}var g=function(x,w){var _;for((w=w||x.length)>x.length&&(w=x.length),_=w-1;0<=_&&(192&x[_])==128;)_--;return _<0||_===0?w:_+u[x[_]]>w?_:w}(p),y=p;g!==p.length&&(s.uint8array?(y=p.subarray(0,g),this.leftOver=p.subarray(g,p.length)):(y=p.slice(0,g),this.leftOver=p.slice(g,p.length))),this.push({data:r.utf8decode(y),meta:h.meta})},c.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=c,a.inherits(d,l),d.prototype.processChunk=function(h){this.push({data:r.utf8encode(h.data),meta:h.meta})},r.Utf8EncodeWorker=d},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,n,r){var a=t("./support"),s=t("./base64"),o=t("./nodejsUtils"),l=t("./external");function u(m){return m}function f(m,g){for(var y=0;y<m.length;++y)g[y]=255&m.charCodeAt(y);return g}t("setimmediate"),r.newBlob=function(m,g){r.checkSupport("blob");try{return new Blob([m],{type:g})}catch{try{var y=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return y.append(m),y.getBlob(g)}catch{throw new Error("Bug : can't construct the Blob.")}}};var c={stringifyByChunk:function(m,g,y){var x=[],w=0,_=m.length;if(_<=y)return String.fromCharCode.apply(null,m);for(;w<_;)g==="array"||g==="nodebuffer"?x.push(String.fromCharCode.apply(null,m.slice(w,Math.min(w+y,_)))):x.push(String.fromCharCode.apply(null,m.subarray(w,Math.min(w+y,_)))),w+=y;return x.join("")},stringifyByChar:function(m){for(var g="",y=0;y<m.length;y++)g+=String.fromCharCode(m[y]);return g},applyCanBeUsed:{uint8array:function(){try{return a.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return a.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}}()}};function d(m){var g=65536,y=r.getTypeOf(m),x=!0;if(y==="uint8array"?x=c.applyCanBeUsed.uint8array:y==="nodebuffer"&&(x=c.applyCanBeUsed.nodebuffer),x)for(;1<g;)try{return c.stringifyByChunk(m,y,g)}catch{g=Math.floor(g/2)}return c.stringifyByChar(m)}function h(m,g){for(var y=0;y<m.length;y++)g[y]=m[y];return g}r.applyFromCharCode=d;var p={};p.string={string:u,array:function(m){return f(m,new Array(m.length))},arraybuffer:function(m){return p.string.uint8array(m).buffer},uint8array:function(m){return f(m,new Uint8Array(m.length))},nodebuffer:function(m){return f(m,o.allocBuffer(m.length))}},p.array={string:d,array:u,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(m)}},p.arraybuffer={string:function(m){return d(new Uint8Array(m))},array:function(m){return h(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:u,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(new Uint8Array(m))}},p.uint8array={string:d,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:u,nodebuffer:function(m){return o.newBufferFrom(m)}},p.nodebuffer={string:d,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return p.nodebuffer.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:u},r.transformTo=function(m,g){if(g=g||"",!m)return g;r.checkSupport(m);var y=r.getTypeOf(g);return p[y][m](g)},r.resolve=function(m){for(var g=m.split("/"),y=[],x=0;x<g.length;x++){var w=g[x];w==="."||w===""&&x!==0&&x!==g.length-1||(w===".."?y.pop():y.push(w))}return y.join("/")},r.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":a.nodebuffer&&o.isBuffer(m)?"nodebuffer":a.uint8array&&m instanceof Uint8Array?"uint8array":a.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(m){if(!a[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(m){var g,y,x="";for(y=0;y<(m||"").length;y++)x+="\\x"+((g=m.charCodeAt(y))<16?"0":"")+g.toString(16).toUpperCase();return x},r.delay=function(m,g,y){setImmediate(function(){m.apply(y||null,g||[])})},r.inherits=function(m,g){function y(){}y.prototype=g.prototype,m.prototype=new y},r.extend=function(){var m,g,y={};for(m=0;m<arguments.length;m++)for(g in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],g)&&y[g]===void 0&&(y[g]=arguments[m][g]);return y},r.prepareContent=function(m,g,y,x,w){return l.Promise.resolve(g).then(function(_){return a.blob&&(_ instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(_))!==-1)&&typeof FileReader<"u"?new l.Promise(function(C,F){var T=new FileReader;T.onload=function(R){C(R.target.result)},T.onerror=function(R){F(R.target.error)},T.readAsArrayBuffer(_)}):_}).then(function(_){var C=r.getTypeOf(_);return C?(C==="arraybuffer"?_=r.transformTo("uint8array",_):C==="string"&&(w?_=s.decode(_):y&&x!==!0&&(_=function(F){return f(F,a.uint8array?new Uint8Array(F.length):new Array(F.length))}(_))),_):l.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,n,r){var a=t("./reader/readerFor"),s=t("./utils"),o=t("./signature"),l=t("./zipEntry"),u=t("./support");function f(c){this.files=[],this.loadOptions=c}f.prototype={checkSignature:function(c){if(!this.reader.readAndCheckSignature(c)){this.reader.index-=4;var d=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+s.pretty(d)+", expected "+s.pretty(c)+")")}},isSignature:function(c,d){var h=this.reader.index;this.reader.setIndex(c);var p=this.reader.readString(4)===d;return this.reader.setIndex(h),p},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var c=this.reader.readData(this.zipCommentLength),d=u.uint8array?"uint8array":"array",h=s.transformTo(d,c);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var c,d,h,p=this.zip64EndOfCentralSize-44;0<p;)c=this.reader.readInt(2),d=this.reader.readInt(4),h=this.reader.readData(d),this.zip64ExtensibleData[c]={id:c,length:d,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var c,d;for(c=0;c<this.files.length;c++)d=this.files[c],this.reader.setIndex(d.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),d.readLocalPart(this.reader),d.handleUTF8(),d.processAttributes()},readCentralDir:function(){var c;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(c=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(c);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var c=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(c<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(c);var d=c;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===s.MAX_VALUE_16BITS||this.diskWithCentralDirStart===s.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===s.MAX_VALUE_16BITS||this.centralDirRecords===s.MAX_VALUE_16BITS||this.centralDirSize===s.MAX_VALUE_32BITS||this.centralDirOffset===s.MAX_VALUE_32BITS){if(this.zip64=!0,(c=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(c),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var p=d-h;if(0<p)this.isSignature(d,o.CENTRAL_FILE_HEADER)||(this.reader.zero=p);else if(p<0)throw new Error("Corrupted zip: missing "+Math.abs(p)+" bytes.")},prepareReader:function(c){this.reader=a(c)},load:function(c){this.prepareReader(c),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},n.exports=f},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,n,r){var a=t("./reader/readerFor"),s=t("./utils"),o=t("./compressedObject"),l=t("./crc32"),u=t("./utf8"),f=t("./compressions"),c=t("./support");function d(h,p){this.options=h,this.loadOptions=p}d.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var p,m;if(h.skip(22),this.fileNameLength=h.readInt(2),m=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((p=function(g){for(var y in f)if(Object.prototype.hasOwnProperty.call(f,y)&&f[y].magic===g)return f[y];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+s.pretty(this.compressionMethod)+" unknown (inner file : "+s.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,p,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var p=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(p),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=a(this.extraFields[1].value);this.uncompressedSize===s.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===s.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===s.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===s.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var p,m,g,y=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<y;)p=h.readInt(2),m=h.readInt(2),g=h.readData(m),this.extraFields[p]={id:p,length:m,value:g};h.setIndex(y)},handleUTF8:function(){var h=c.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=u.utf8decode(this.fileName),this.fileCommentStr=u.utf8decode(this.fileComment);else{var p=this.findExtraFieldUnicodePath();if(p!==null)this.fileNameStr=p;else{var m=s.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var g=this.findExtraFieldUnicodeComment();if(g!==null)this.fileCommentStr=g;else{var y=s.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(y)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var p=a(h.value);return p.readInt(1)!==1||l(this.fileName)!==p.readInt(4)?null:u.utf8decode(p.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var p=a(h.value);return p.readInt(1)!==1||l(this.fileComment)!==p.readInt(4)?null:u.utf8decode(p.readData(h.length-5))}return null}},n.exports=d},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,n,r){function a(p,m,g){this.name=p,this.dir=g.dir,this.date=g.date,this.comment=g.comment,this.unixPermissions=g.unixPermissions,this.dosPermissions=g.dosPermissions,this._data=m,this._dataBinary=g.binary,this.options={compression:g.compression,compressionOptions:g.compressionOptions}}var s=t("./stream/StreamHelper"),o=t("./stream/DataWorker"),l=t("./utf8"),u=t("./compressedObject"),f=t("./stream/GenericWorker");a.prototype={internalStream:function(p){var m=null,g="string";try{if(!p)throw new Error("No output type specified.");var y=(g=p.toLowerCase())==="string"||g==="text";g!=="binarystring"&&g!=="text"||(g="string"),m=this._decompressWorker();var x=!this._dataBinary;x&&!y&&(m=m.pipe(new l.Utf8EncodeWorker)),!x&&y&&(m=m.pipe(new l.Utf8DecodeWorker))}catch(w){(m=new f("error")).error(w)}return new s(m,g,"")},async:function(p,m){return this.internalStream(p).accumulate(m)},nodeStream:function(p,m){return this.internalStream(p||"nodebuffer").toNodejsStream(m)},_compressWorker:function(p,m){if(this._data instanceof u&&this._data.compression.magic===p.magic)return this._data.getCompressedWorker();var g=this._decompressWorker();return this._dataBinary||(g=g.pipe(new l.Utf8EncodeWorker)),u.createWorkerFrom(g,p,m)},_decompressWorker:function(){return this._data instanceof u?this._data.getContentWorker():this._data instanceof f?this._data:new o(this._data)}};for(var c=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],d=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<c.length;h++)a.prototype[c[h]]=d;n.exports=a},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,n,r){(function(a){var s,o,l=a.MutationObserver||a.WebKitMutationObserver;if(l){var u=0,f=new l(p),c=a.document.createTextNode("");f.observe(c,{characterData:!0}),s=function(){c.data=u=++u%2}}else if(a.setImmediate||a.MessageChannel===void 0)s="document"in a&&"onreadystatechange"in a.document.createElement("script")?function(){var m=a.document.createElement("script");m.onreadystatechange=function(){p(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},a.document.documentElement.appendChild(m)}:function(){setTimeout(p,0)};else{var d=new a.MessageChannel;d.port1.onmessage=p,s=function(){d.port2.postMessage(0)}}var h=[];function p(){var m,g;o=!0;for(var y=h.length;y;){for(g=h,h=[],m=-1;++m<y;)g[m]();y=h.length}o=!1}n.exports=function(m){h.push(m)!==1||o||s()}}).call(this,typeof vi<"u"?vi:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,n,r){var a=t("immediate");function s(){}var o={},l=["REJECTED"],u=["FULFILLED"],f=["PENDING"];function c(y){if(typeof y!="function")throw new TypeError("resolver must be a function");this.state=f,this.queue=[],this.outcome=void 0,y!==s&&m(this,y)}function d(y,x,w){this.promise=y,typeof x=="function"&&(this.onFulfilled=x,this.callFulfilled=this.otherCallFulfilled),typeof w=="function"&&(this.onRejected=w,this.callRejected=this.otherCallRejected)}function h(y,x,w){a(function(){var _;try{_=x(w)}catch(C){return o.reject(y,C)}_===y?o.reject(y,new TypeError("Cannot resolve promise with itself")):o.resolve(y,_)})}function p(y){var x=y&&y.then;if(y&&(typeof y=="object"||typeof y=="function")&&typeof x=="function")return function(){x.apply(y,arguments)}}function m(y,x){var w=!1;function _(T){w||(w=!0,o.reject(y,T))}function C(T){w||(w=!0,o.resolve(y,T))}var F=g(function(){x(C,_)});F.status==="error"&&_(F.value)}function g(y,x){var w={};try{w.value=y(x),w.status="success"}catch(_){w.status="error",w.value=_}return w}(n.exports=c).prototype.finally=function(y){if(typeof y!="function")return this;var x=this.constructor;return this.then(function(w){return x.resolve(y()).then(function(){return w})},function(w){return x.resolve(y()).then(function(){throw w})})},c.prototype.catch=function(y){return this.then(null,y)},c.prototype.then=function(y,x){if(typeof y!="function"&&this.state===u||typeof x!="function"&&this.state===l)return this;var w=new this.constructor(s);return this.state!==f?h(w,this.state===u?y:x,this.outcome):this.queue.push(new d(w,y,x)),w},d.prototype.callFulfilled=function(y){o.resolve(this.promise,y)},d.prototype.otherCallFulfilled=function(y){h(this.promise,this.onFulfilled,y)},d.prototype.callRejected=function(y){o.reject(this.promise,y)},d.prototype.otherCallRejected=function(y){h(this.promise,this.onRejected,y)},o.resolve=function(y,x){var w=g(p,x);if(w.status==="error")return o.reject(y,w.value);var _=w.value;if(_)m(y,_);else{y.state=u,y.outcome=x;for(var C=-1,F=y.queue.length;++C<F;)y.queue[C].callFulfilled(x)}return y},o.reject=function(y,x){y.state=l,y.outcome=x;for(var w=-1,_=y.queue.length;++w<_;)y.queue[w].callRejected(x);return y},c.resolve=function(y){return y instanceof this?y:o.resolve(new this(s),y)},c.reject=function(y){var x=new this(s);return o.reject(x,y)},c.all=function(y){var x=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=y.length,_=!1;if(!w)return this.resolve([]);for(var C=new Array(w),F=0,T=-1,R=new this(s);++T<w;)N(y[T],T);return R;function N(j,ae){x.resolve(j).then(function(L){C[ae]=L,++F!==w||_||(_=!0,o.resolve(R,C))},function(L){_||(_=!0,o.reject(R,L))})}},c.race=function(y){var x=this;if(Object.prototype.toString.call(y)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=y.length,_=!1;if(!w)return this.resolve([]);for(var C=-1,F=new this(s);++C<w;)T=y[C],x.resolve(T).then(function(R){_||(_=!0,o.resolve(F,R))},function(R){_||(_=!0,o.reject(F,R))});var T;return F}},{immediate:36}],38:[function(t,n,r){var a={};(0,t("./lib/utils/common").assign)(a,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),n.exports=a},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,n,r){var a=t("./zlib/deflate"),s=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/messages"),u=t("./zlib/zstream"),f=Object.prototype.toString,c=0,d=-1,h=0,p=8;function m(y){if(!(this instanceof m))return new m(y);this.options=s.assign({level:d,method:p,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},y||{});var x=this.options;x.raw&&0<x.windowBits?x.windowBits=-x.windowBits:x.gzip&&0<x.windowBits&&x.windowBits<16&&(x.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var w=a.deflateInit2(this.strm,x.level,x.method,x.windowBits,x.memLevel,x.strategy);if(w!==c)throw new Error(l[w]);if(x.header&&a.deflateSetHeader(this.strm,x.header),x.dictionary){var _;if(_=typeof x.dictionary=="string"?o.string2buf(x.dictionary):f.call(x.dictionary)==="[object ArrayBuffer]"?new Uint8Array(x.dictionary):x.dictionary,(w=a.deflateSetDictionary(this.strm,_))!==c)throw new Error(l[w]);this._dict_set=!0}}function g(y,x){var w=new m(x);if(w.push(y,!0),w.err)throw w.msg||l[w.err];return w.result}m.prototype.push=function(y,x){var w,_,C=this.strm,F=this.options.chunkSize;if(this.ended)return!1;_=x===~~x?x:x===!0?4:0,typeof y=="string"?C.input=o.string2buf(y):f.call(y)==="[object ArrayBuffer]"?C.input=new Uint8Array(y):C.input=y,C.next_in=0,C.avail_in=C.input.length;do{if(C.avail_out===0&&(C.output=new s.Buf8(F),C.next_out=0,C.avail_out=F),(w=a.deflate(C,_))!==1&&w!==c)return this.onEnd(w),!(this.ended=!0);C.avail_out!==0&&(C.avail_in!==0||_!==4&&_!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(s.shrinkBuf(C.output,C.next_out))):this.onData(s.shrinkBuf(C.output,C.next_out)))}while((0<C.avail_in||C.avail_out===0)&&w!==1);return _===4?(w=a.deflateEnd(this.strm),this.onEnd(w),this.ended=!0,w===c):_!==2||(this.onEnd(c),!(C.avail_out=0))},m.prototype.onData=function(y){this.chunks.push(y)},m.prototype.onEnd=function(y){y===c&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=y,this.msg=this.strm.msg},r.Deflate=m,r.deflate=g,r.deflateRaw=function(y,x){return(x=x||{}).raw=!0,g(y,x)},r.gzip=function(y,x){return(x=x||{}).gzip=!0,g(y,x)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,n,r){var a=t("./zlib/inflate"),s=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/constants"),u=t("./zlib/messages"),f=t("./zlib/zstream"),c=t("./zlib/gzheader"),d=Object.prototype.toString;function h(m){if(!(this instanceof h))return new h(m);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},m||{});var g=this.options;g.raw&&0<=g.windowBits&&g.windowBits<16&&(g.windowBits=-g.windowBits,g.windowBits===0&&(g.windowBits=-15)),!(0<=g.windowBits&&g.windowBits<16)||m&&m.windowBits||(g.windowBits+=32),15<g.windowBits&&g.windowBits<48&&(15&g.windowBits)==0&&(g.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new f,this.strm.avail_out=0;var y=a.inflateInit2(this.strm,g.windowBits);if(y!==l.Z_OK)throw new Error(u[y]);this.header=new c,a.inflateGetHeader(this.strm,this.header)}function p(m,g){var y=new h(g);if(y.push(m,!0),y.err)throw y.msg||u[y.err];return y.result}h.prototype.push=function(m,g){var y,x,w,_,C,F,T=this.strm,R=this.options.chunkSize,N=this.options.dictionary,j=!1;if(this.ended)return!1;x=g===~~g?g:g===!0?l.Z_FINISH:l.Z_NO_FLUSH,typeof m=="string"?T.input=o.binstring2buf(m):d.call(m)==="[object ArrayBuffer]"?T.input=new Uint8Array(m):T.input=m,T.next_in=0,T.avail_in=T.input.length;do{if(T.avail_out===0&&(T.output=new s.Buf8(R),T.next_out=0,T.avail_out=R),(y=a.inflate(T,l.Z_NO_FLUSH))===l.Z_NEED_DICT&&N&&(F=typeof N=="string"?o.string2buf(N):d.call(N)==="[object ArrayBuffer]"?new Uint8Array(N):N,y=a.inflateSetDictionary(this.strm,F)),y===l.Z_BUF_ERROR&&j===!0&&(y=l.Z_OK,j=!1),y!==l.Z_STREAM_END&&y!==l.Z_OK)return this.onEnd(y),!(this.ended=!0);T.next_out&&(T.avail_out!==0&&y!==l.Z_STREAM_END&&(T.avail_in!==0||x!==l.Z_FINISH&&x!==l.Z_SYNC_FLUSH)||(this.options.to==="string"?(w=o.utf8border(T.output,T.next_out),_=T.next_out-w,C=o.buf2string(T.output,w),T.next_out=_,T.avail_out=R-_,_&&s.arraySet(T.output,T.output,w,_,0),this.onData(C)):this.onData(s.shrinkBuf(T.output,T.next_out)))),T.avail_in===0&&T.avail_out===0&&(j=!0)}while((0<T.avail_in||T.avail_out===0)&&y!==l.Z_STREAM_END);return y===l.Z_STREAM_END&&(x=l.Z_FINISH),x===l.Z_FINISH?(y=a.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===l.Z_OK):x!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),!(T.avail_out=0))},h.prototype.onData=function(m){this.chunks.push(m)},h.prototype.onEnd=function(m){m===l.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},r.Inflate=h,r.inflate=p,r.inflateRaw=function(m,g){return(g=g||{}).raw=!0,p(m,g)},r.ungzip=p},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,n,r){var a=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(l){for(var u=Array.prototype.slice.call(arguments,1);u.length;){var f=u.shift();if(f){if(typeof f!="object")throw new TypeError(f+"must be non-object");for(var c in f)f.hasOwnProperty(c)&&(l[c]=f[c])}}return l},r.shrinkBuf=function(l,u){return l.length===u?l:l.subarray?l.subarray(0,u):(l.length=u,l)};var s={arraySet:function(l,u,f,c,d){if(u.subarray&&l.subarray)l.set(u.subarray(f,f+c),d);else for(var h=0;h<c;h++)l[d+h]=u[f+h]},flattenChunks:function(l){var u,f,c,d,h,p;for(u=c=0,f=l.length;u<f;u++)c+=l[u].length;for(p=new Uint8Array(c),u=d=0,f=l.length;u<f;u++)h=l[u],p.set(h,d),d+=h.length;return p}},o={arraySet:function(l,u,f,c,d){for(var h=0;h<c;h++)l[d+h]=u[f+h]},flattenChunks:function(l){return[].concat.apply([],l)}};r.setTyped=function(l){l?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,s)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,o))},r.setTyped(a)},{}],42:[function(t,n,r){var a=t("./common"),s=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{s=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var l=new a.Buf8(256),u=0;u<256;u++)l[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;function f(c,d){if(d<65537&&(c.subarray&&o||!c.subarray&&s))return String.fromCharCode.apply(null,a.shrinkBuf(c,d));for(var h="",p=0;p<d;p++)h+=String.fromCharCode(c[p]);return h}l[254]=l[254]=1,r.string2buf=function(c){var d,h,p,m,g,y=c.length,x=0;for(m=0;m<y;m++)(64512&(h=c.charCodeAt(m)))==55296&&m+1<y&&(64512&(p=c.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(p-56320),m++),x+=h<128?1:h<2048?2:h<65536?3:4;for(d=new a.Buf8(x),m=g=0;g<x;m++)(64512&(h=c.charCodeAt(m)))==55296&&m+1<y&&(64512&(p=c.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(p-56320),m++),h<128?d[g++]=h:(h<2048?d[g++]=192|h>>>6:(h<65536?d[g++]=224|h>>>12:(d[g++]=240|h>>>18,d[g++]=128|h>>>12&63),d[g++]=128|h>>>6&63),d[g++]=128|63&h);return d},r.buf2binstring=function(c){return f(c,c.length)},r.binstring2buf=function(c){for(var d=new a.Buf8(c.length),h=0,p=d.length;h<p;h++)d[h]=c.charCodeAt(h);return d},r.buf2string=function(c,d){var h,p,m,g,y=d||c.length,x=new Array(2*y);for(h=p=0;h<y;)if((m=c[h++])<128)x[p++]=m;else if(4<(g=l[m]))x[p++]=65533,h+=g-1;else{for(m&=g===2?31:g===3?15:7;1<g&&h<y;)m=m<<6|63&c[h++],g--;1<g?x[p++]=65533:m<65536?x[p++]=m:(m-=65536,x[p++]=55296|m>>10&1023,x[p++]=56320|1023&m)}return f(x,p)},r.utf8border=function(c,d){var h;for((d=d||c.length)>c.length&&(d=c.length),h=d-1;0<=h&&(192&c[h])==128;)h--;return h<0||h===0?d:h+l[c[h]]>d?h:d}},{"./common":41}],43:[function(t,n,r){n.exports=function(a,s,o,l){for(var u=65535&a|0,f=a>>>16&65535|0,c=0;o!==0;){for(o-=c=2e3<o?2e3:o;f=f+(u=u+s[l++]|0)|0,--c;);u%=65521,f%=65521}return u|f<<16|0}},{}],44:[function(t,n,r){n.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,n,r){var a=function(){for(var s,o=[],l=0;l<256;l++){s=l;for(var u=0;u<8;u++)s=1&s?3988292384^s>>>1:s>>>1;o[l]=s}return o}();n.exports=function(s,o,l,u){var f=a,c=u+l;s^=-1;for(var d=u;d<c;d++)s=s>>>8^f[255&(s^o[d])];return-1^s}},{}],46:[function(t,n,r){var a,s=t("../utils/common"),o=t("./trees"),l=t("./adler32"),u=t("./crc32"),f=t("./messages"),c=0,d=4,h=0,p=-2,m=-1,g=4,y=2,x=8,w=9,_=286,C=30,F=19,T=2*_+1,R=15,N=3,j=258,ae=j+N+1,L=42,O=113,v=1,S=2,Y=3,D=4;function G(E,X){return E.msg=f[X],X}function V(E){return(E<<1)-(4<E?9:0)}function J(E){for(var X=E.length;0<=--X;)E[X]=0}function H(E){var X=E.state,q=X.pending;q>E.avail_out&&(q=E.avail_out),q!==0&&(s.arraySet(E.output,X.pending_buf,X.pending_out,q,E.next_out),E.next_out+=q,X.pending_out+=q,E.total_out+=q,E.avail_out-=q,X.pending-=q,X.pending===0&&(X.pending_out=0))}function P(E,X){o._tr_flush_block(E,0<=E.block_start?E.block_start:-1,E.strstart-E.block_start,X),E.block_start=E.strstart,H(E.strm)}function re(E,X){E.pending_buf[E.pending++]=X}function ne(E,X){E.pending_buf[E.pending++]=X>>>8&255,E.pending_buf[E.pending++]=255&X}function te(E,X){var q,M,k=E.max_chain_length,z=E.strstart,$=E.prev_length,Q=E.nice_match,W=E.strstart>E.w_size-ae?E.strstart-(E.w_size-ae):0,oe=E.window,de=E.w_mask,le=E.prev,we=E.strstart+j,je=oe[z+$-1],De=oe[z+$];E.prev_length>=E.good_match&&(k>>=2),Q>E.lookahead&&(Q=E.lookahead);do if(oe[(q=X)+$]===De&&oe[q+$-1]===je&&oe[q]===oe[z]&&oe[++q]===oe[z+1]){z+=2,q++;do;while(oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&oe[++z]===oe[++q]&&z<we);if(M=j-(we-z),z=we-j,$<M){if(E.match_start=X,Q<=($=M))break;je=oe[z+$-1],De=oe[z+$]}}while((X=le[X&de])>W&&--k!=0);return $<=E.lookahead?$:E.lookahead}function Me(E){var X,q,M,k,z,$,Q,W,oe,de,le=E.w_size;do{if(k=E.window_size-E.lookahead-E.strstart,E.strstart>=le+(le-ae)){for(s.arraySet(E.window,E.window,le,le,0),E.match_start-=le,E.strstart-=le,E.block_start-=le,X=q=E.hash_size;M=E.head[--X],E.head[X]=le<=M?M-le:0,--q;);for(X=q=le;M=E.prev[--X],E.prev[X]=le<=M?M-le:0,--q;);k+=le}if(E.strm.avail_in===0)break;if($=E.strm,Q=E.window,W=E.strstart+E.lookahead,oe=k,de=void 0,de=$.avail_in,oe<de&&(de=oe),q=de===0?0:($.avail_in-=de,s.arraySet(Q,$.input,$.next_in,de,W),$.state.wrap===1?$.adler=l($.adler,Q,de,W):$.state.wrap===2&&($.adler=u($.adler,Q,de,W)),$.next_in+=de,$.total_in+=de,de),E.lookahead+=q,E.lookahead+E.insert>=N)for(z=E.strstart-E.insert,E.ins_h=E.window[z],E.ins_h=(E.ins_h<<E.hash_shift^E.window[z+1])&E.hash_mask;E.insert&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[z+N-1])&E.hash_mask,E.prev[z&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=z,z++,E.insert--,!(E.lookahead+E.insert<N)););}while(E.lookahead<ae&&E.strm.avail_in!==0)}function He(E,X){for(var q,M;;){if(E.lookahead<ae){if(Me(E),E.lookahead<ae&&X===c)return v;if(E.lookahead===0)break}if(q=0,E.lookahead>=N&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+N-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart),q!==0&&E.strstart-q<=E.w_size-ae&&(E.match_length=te(E,q)),E.match_length>=N)if(M=o._tr_tally(E,E.strstart-E.match_start,E.match_length-N),E.lookahead-=E.match_length,E.match_length<=E.max_lazy_match&&E.lookahead>=N){for(E.match_length--;E.strstart++,E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+N-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart,--E.match_length!=0;);E.strstart++}else E.strstart+=E.match_length,E.match_length=0,E.ins_h=E.window[E.strstart],E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+1])&E.hash_mask;else M=o._tr_tally(E,0,E.window[E.strstart]),E.lookahead--,E.strstart++;if(M&&(P(E,!1),E.strm.avail_out===0))return v}return E.insert=E.strstart<N-1?E.strstart:N-1,X===d?(P(E,!0),E.strm.avail_out===0?Y:D):E.last_lit&&(P(E,!1),E.strm.avail_out===0)?v:S}function _e(E,X){for(var q,M,k;;){if(E.lookahead<ae){if(Me(E),E.lookahead<ae&&X===c)return v;if(E.lookahead===0)break}if(q=0,E.lookahead>=N&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+N-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart),E.prev_length=E.match_length,E.prev_match=E.match_start,E.match_length=N-1,q!==0&&E.prev_length<E.max_lazy_match&&E.strstart-q<=E.w_size-ae&&(E.match_length=te(E,q),E.match_length<=5&&(E.strategy===1||E.match_length===N&&4096<E.strstart-E.match_start)&&(E.match_length=N-1)),E.prev_length>=N&&E.match_length<=E.prev_length){for(k=E.strstart+E.lookahead-N,M=o._tr_tally(E,E.strstart-1-E.prev_match,E.prev_length-N),E.lookahead-=E.prev_length-1,E.prev_length-=2;++E.strstart<=k&&(E.ins_h=(E.ins_h<<E.hash_shift^E.window[E.strstart+N-1])&E.hash_mask,q=E.prev[E.strstart&E.w_mask]=E.head[E.ins_h],E.head[E.ins_h]=E.strstart),--E.prev_length!=0;);if(E.match_available=0,E.match_length=N-1,E.strstart++,M&&(P(E,!1),E.strm.avail_out===0))return v}else if(E.match_available){if((M=o._tr_tally(E,0,E.window[E.strstart-1]))&&P(E,!1),E.strstart++,E.lookahead--,E.strm.avail_out===0)return v}else E.match_available=1,E.strstart++,E.lookahead--}return E.match_available&&(M=o._tr_tally(E,0,E.window[E.strstart-1]),E.match_available=0),E.insert=E.strstart<N-1?E.strstart:N-1,X===d?(P(E,!0),E.strm.avail_out===0?Y:D):E.last_lit&&(P(E,!1),E.strm.avail_out===0)?v:S}function ve(E,X,q,M,k){this.good_length=E,this.max_lazy=X,this.nice_length=q,this.max_chain=M,this.func=k}function Le(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=x,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(2*T),this.dyn_dtree=new s.Buf16(2*(2*C+1)),this.bl_tree=new s.Buf16(2*(2*F+1)),J(this.dyn_ltree),J(this.dyn_dtree),J(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(R+1),this.heap=new s.Buf16(2*_+1),J(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(2*_+1),J(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Be(E){var X;return E&&E.state?(E.total_in=E.total_out=0,E.data_type=y,(X=E.state).pending=0,X.pending_out=0,X.wrap<0&&(X.wrap=-X.wrap),X.status=X.wrap?L:O,E.adler=X.wrap===2?0:1,X.last_flush=c,o._tr_init(X),h):G(E,p)}function ct(E){var X=Be(E);return X===h&&function(q){q.window_size=2*q.w_size,J(q.head),q.max_lazy_match=a[q.level].max_lazy,q.good_match=a[q.level].good_length,q.nice_match=a[q.level].nice_length,q.max_chain_length=a[q.level].max_chain,q.strstart=0,q.block_start=0,q.lookahead=0,q.insert=0,q.match_length=q.prev_length=N-1,q.match_available=0,q.ins_h=0}(E.state),X}function ut(E,X,q,M,k,z){if(!E)return p;var $=1;if(X===m&&(X=6),M<0?($=0,M=-M):15<M&&($=2,M-=16),k<1||w<k||q!==x||M<8||15<M||X<0||9<X||z<0||g<z)return G(E,p);M===8&&(M=9);var Q=new Le;return(E.state=Q).strm=E,Q.wrap=$,Q.gzhead=null,Q.w_bits=M,Q.w_size=1<<Q.w_bits,Q.w_mask=Q.w_size-1,Q.hash_bits=k+7,Q.hash_size=1<<Q.hash_bits,Q.hash_mask=Q.hash_size-1,Q.hash_shift=~~((Q.hash_bits+N-1)/N),Q.window=new s.Buf8(2*Q.w_size),Q.head=new s.Buf16(Q.hash_size),Q.prev=new s.Buf16(Q.w_size),Q.lit_bufsize=1<<k+6,Q.pending_buf_size=4*Q.lit_bufsize,Q.pending_buf=new s.Buf8(Q.pending_buf_size),Q.d_buf=1*Q.lit_bufsize,Q.l_buf=3*Q.lit_bufsize,Q.level=X,Q.strategy=z,Q.method=q,ct(E)}a=[new ve(0,0,0,0,function(E,X){var q=65535;for(q>E.pending_buf_size-5&&(q=E.pending_buf_size-5);;){if(E.lookahead<=1){if(Me(E),E.lookahead===0&&X===c)return v;if(E.lookahead===0)break}E.strstart+=E.lookahead,E.lookahead=0;var M=E.block_start+q;if((E.strstart===0||E.strstart>=M)&&(E.lookahead=E.strstart-M,E.strstart=M,P(E,!1),E.strm.avail_out===0)||E.strstart-E.block_start>=E.w_size-ae&&(P(E,!1),E.strm.avail_out===0))return v}return E.insert=0,X===d?(P(E,!0),E.strm.avail_out===0?Y:D):(E.strstart>E.block_start&&(P(E,!1),E.strm.avail_out),v)}),new ve(4,4,8,4,He),new ve(4,5,16,8,He),new ve(4,6,32,32,He),new ve(4,4,16,16,_e),new ve(8,16,32,32,_e),new ve(8,16,128,128,_e),new ve(8,32,128,256,_e),new ve(32,128,258,1024,_e),new ve(32,258,258,4096,_e)],r.deflateInit=function(E,X){return ut(E,X,x,15,8,0)},r.deflateInit2=ut,r.deflateReset=ct,r.deflateResetKeep=Be,r.deflateSetHeader=function(E,X){return E&&E.state?E.state.wrap!==2?p:(E.state.gzhead=X,h):p},r.deflate=function(E,X){var q,M,k,z;if(!E||!E.state||5<X||X<0)return E?G(E,p):p;if(M=E.state,!E.output||!E.input&&E.avail_in!==0||M.status===666&&X!==d)return G(E,E.avail_out===0?-5:p);if(M.strm=E,q=M.last_flush,M.last_flush=X,M.status===L)if(M.wrap===2)E.adler=0,re(M,31),re(M,139),re(M,8),M.gzhead?(re(M,(M.gzhead.text?1:0)+(M.gzhead.hcrc?2:0)+(M.gzhead.extra?4:0)+(M.gzhead.name?8:0)+(M.gzhead.comment?16:0)),re(M,255&M.gzhead.time),re(M,M.gzhead.time>>8&255),re(M,M.gzhead.time>>16&255),re(M,M.gzhead.time>>24&255),re(M,M.level===9?2:2<=M.strategy||M.level<2?4:0),re(M,255&M.gzhead.os),M.gzhead.extra&&M.gzhead.extra.length&&(re(M,255&M.gzhead.extra.length),re(M,M.gzhead.extra.length>>8&255)),M.gzhead.hcrc&&(E.adler=u(E.adler,M.pending_buf,M.pending,0)),M.gzindex=0,M.status=69):(re(M,0),re(M,0),re(M,0),re(M,0),re(M,0),re(M,M.level===9?2:2<=M.strategy||M.level<2?4:0),re(M,3),M.status=O);else{var $=x+(M.w_bits-8<<4)<<8;$|=(2<=M.strategy||M.level<2?0:M.level<6?1:M.level===6?2:3)<<6,M.strstart!==0&&($|=32),$+=31-$%31,M.status=O,ne(M,$),M.strstart!==0&&(ne(M,E.adler>>>16),ne(M,65535&E.adler)),E.adler=1}if(M.status===69)if(M.gzhead.extra){for(k=M.pending;M.gzindex<(65535&M.gzhead.extra.length)&&(M.pending!==M.pending_buf_size||(M.gzhead.hcrc&&M.pending>k&&(E.adler=u(E.adler,M.pending_buf,M.pending-k,k)),H(E),k=M.pending,M.pending!==M.pending_buf_size));)re(M,255&M.gzhead.extra[M.gzindex]),M.gzindex++;M.gzhead.hcrc&&M.pending>k&&(E.adler=u(E.adler,M.pending_buf,M.pending-k,k)),M.gzindex===M.gzhead.extra.length&&(M.gzindex=0,M.status=73)}else M.status=73;if(M.status===73)if(M.gzhead.name){k=M.pending;do{if(M.pending===M.pending_buf_size&&(M.gzhead.hcrc&&M.pending>k&&(E.adler=u(E.adler,M.pending_buf,M.pending-k,k)),H(E),k=M.pending,M.pending===M.pending_buf_size)){z=1;break}z=M.gzindex<M.gzhead.name.length?255&M.gzhead.name.charCodeAt(M.gzindex++):0,re(M,z)}while(z!==0);M.gzhead.hcrc&&M.pending>k&&(E.adler=u(E.adler,M.pending_buf,M.pending-k,k)),z===0&&(M.gzindex=0,M.status=91)}else M.status=91;if(M.status===91)if(M.gzhead.comment){k=M.pending;do{if(M.pending===M.pending_buf_size&&(M.gzhead.hcrc&&M.pending>k&&(E.adler=u(E.adler,M.pending_buf,M.pending-k,k)),H(E),k=M.pending,M.pending===M.pending_buf_size)){z=1;break}z=M.gzindex<M.gzhead.comment.length?255&M.gzhead.comment.charCodeAt(M.gzindex++):0,re(M,z)}while(z!==0);M.gzhead.hcrc&&M.pending>k&&(E.adler=u(E.adler,M.pending_buf,M.pending-k,k)),z===0&&(M.status=103)}else M.status=103;if(M.status===103&&(M.gzhead.hcrc?(M.pending+2>M.pending_buf_size&&H(E),M.pending+2<=M.pending_buf_size&&(re(M,255&E.adler),re(M,E.adler>>8&255),E.adler=0,M.status=O)):M.status=O),M.pending!==0){if(H(E),E.avail_out===0)return M.last_flush=-1,h}else if(E.avail_in===0&&V(X)<=V(q)&&X!==d)return G(E,-5);if(M.status===666&&E.avail_in!==0)return G(E,-5);if(E.avail_in!==0||M.lookahead!==0||X!==c&&M.status!==666){var Q=M.strategy===2?function(W,oe){for(var de;;){if(W.lookahead===0&&(Me(W),W.lookahead===0)){if(oe===c)return v;break}if(W.match_length=0,de=o._tr_tally(W,0,W.window[W.strstart]),W.lookahead--,W.strstart++,de&&(P(W,!1),W.strm.avail_out===0))return v}return W.insert=0,oe===d?(P(W,!0),W.strm.avail_out===0?Y:D):W.last_lit&&(P(W,!1),W.strm.avail_out===0)?v:S}(M,X):M.strategy===3?function(W,oe){for(var de,le,we,je,De=W.window;;){if(W.lookahead<=j){if(Me(W),W.lookahead<=j&&oe===c)return v;if(W.lookahead===0)break}if(W.match_length=0,W.lookahead>=N&&0<W.strstart&&(le=De[we=W.strstart-1])===De[++we]&&le===De[++we]&&le===De[++we]){je=W.strstart+j;do;while(le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&le===De[++we]&&we<je);W.match_length=j-(je-we),W.match_length>W.lookahead&&(W.match_length=W.lookahead)}if(W.match_length>=N?(de=o._tr_tally(W,1,W.match_length-N),W.lookahead-=W.match_length,W.strstart+=W.match_length,W.match_length=0):(de=o._tr_tally(W,0,W.window[W.strstart]),W.lookahead--,W.strstart++),de&&(P(W,!1),W.strm.avail_out===0))return v}return W.insert=0,oe===d?(P(W,!0),W.strm.avail_out===0?Y:D):W.last_lit&&(P(W,!1),W.strm.avail_out===0)?v:S}(M,X):a[M.level].func(M,X);if(Q!==Y&&Q!==D||(M.status=666),Q===v||Q===Y)return E.avail_out===0&&(M.last_flush=-1),h;if(Q===S&&(X===1?o._tr_align(M):X!==5&&(o._tr_stored_block(M,0,0,!1),X===3&&(J(M.head),M.lookahead===0&&(M.strstart=0,M.block_start=0,M.insert=0))),H(E),E.avail_out===0))return M.last_flush=-1,h}return X!==d?h:M.wrap<=0?1:(M.wrap===2?(re(M,255&E.adler),re(M,E.adler>>8&255),re(M,E.adler>>16&255),re(M,E.adler>>24&255),re(M,255&E.total_in),re(M,E.total_in>>8&255),re(M,E.total_in>>16&255),re(M,E.total_in>>24&255)):(ne(M,E.adler>>>16),ne(M,65535&E.adler)),H(E),0<M.wrap&&(M.wrap=-M.wrap),M.pending!==0?h:1)},r.deflateEnd=function(E){var X;return E&&E.state?(X=E.state.status)!==L&&X!==69&&X!==73&&X!==91&&X!==103&&X!==O&&X!==666?G(E,p):(E.state=null,X===O?G(E,-3):h):p},r.deflateSetDictionary=function(E,X){var q,M,k,z,$,Q,W,oe,de=X.length;if(!E||!E.state||(z=(q=E.state).wrap)===2||z===1&&q.status!==L||q.lookahead)return p;for(z===1&&(E.adler=l(E.adler,X,de,0)),q.wrap=0,de>=q.w_size&&(z===0&&(J(q.head),q.strstart=0,q.block_start=0,q.insert=0),oe=new s.Buf8(q.w_size),s.arraySet(oe,X,de-q.w_size,q.w_size,0),X=oe,de=q.w_size),$=E.avail_in,Q=E.next_in,W=E.input,E.avail_in=de,E.next_in=0,E.input=X,Me(q);q.lookahead>=N;){for(M=q.strstart,k=q.lookahead-(N-1);q.ins_h=(q.ins_h<<q.hash_shift^q.window[M+N-1])&q.hash_mask,q.prev[M&q.w_mask]=q.head[q.ins_h],q.head[q.ins_h]=M,M++,--k;);q.strstart=M,q.lookahead=N-1,Me(q)}return q.strstart+=q.lookahead,q.block_start=q.strstart,q.insert=q.lookahead,q.lookahead=0,q.match_length=q.prev_length=N-1,q.match_available=0,E.next_in=Q,E.input=W,E.avail_in=$,q.wrap=z,h},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,n,r){n.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,n,r){n.exports=function(a,s){var o,l,u,f,c,d,h,p,m,g,y,x,w,_,C,F,T,R,N,j,ae,L,O,v,S;o=a.state,l=a.next_in,v=a.input,u=l+(a.avail_in-5),f=a.next_out,S=a.output,c=f-(s-a.avail_out),d=f+(a.avail_out-257),h=o.dmax,p=o.wsize,m=o.whave,g=o.wnext,y=o.window,x=o.hold,w=o.bits,_=o.lencode,C=o.distcode,F=(1<<o.lenbits)-1,T=(1<<o.distbits)-1;e:do{w<15&&(x+=v[l++]<<w,w+=8,x+=v[l++]<<w,w+=8),R=_[x&F];t:for(;;){if(x>>>=N=R>>>24,w-=N,(N=R>>>16&255)===0)S[f++]=65535&R;else{if(!(16&N)){if((64&N)==0){R=_[(65535&R)+(x&(1<<N)-1)];continue t}if(32&N){o.mode=12;break e}a.msg="invalid literal/length code",o.mode=30;break e}j=65535&R,(N&=15)&&(w<N&&(x+=v[l++]<<w,w+=8),j+=x&(1<<N)-1,x>>>=N,w-=N),w<15&&(x+=v[l++]<<w,w+=8,x+=v[l++]<<w,w+=8),R=C[x&T];i:for(;;){if(x>>>=N=R>>>24,w-=N,!(16&(N=R>>>16&255))){if((64&N)==0){R=C[(65535&R)+(x&(1<<N)-1)];continue i}a.msg="invalid distance code",o.mode=30;break e}if(ae=65535&R,w<(N&=15)&&(x+=v[l++]<<w,(w+=8)<N&&(x+=v[l++]<<w,w+=8)),h<(ae+=x&(1<<N)-1)){a.msg="invalid distance too far back",o.mode=30;break e}if(x>>>=N,w-=N,(N=f-c)<ae){if(m<(N=ae-N)&&o.sane){a.msg="invalid distance too far back",o.mode=30;break e}if(O=y,(L=0)===g){if(L+=p-N,N<j){for(j-=N;S[f++]=y[L++],--N;);L=f-ae,O=S}}else if(g<N){if(L+=p+g-N,(N-=g)<j){for(j-=N;S[f++]=y[L++],--N;);if(L=0,g<j){for(j-=N=g;S[f++]=y[L++],--N;);L=f-ae,O=S}}}else if(L+=g-N,N<j){for(j-=N;S[f++]=y[L++],--N;);L=f-ae,O=S}for(;2<j;)S[f++]=O[L++],S[f++]=O[L++],S[f++]=O[L++],j-=3;j&&(S[f++]=O[L++],1<j&&(S[f++]=O[L++]))}else{for(L=f-ae;S[f++]=S[L++],S[f++]=S[L++],S[f++]=S[L++],2<(j-=3););j&&(S[f++]=S[L++],1<j&&(S[f++]=S[L++]))}break}}break}}while(l<u&&f<d);l-=j=w>>3,x&=(1<<(w-=j<<3))-1,a.next_in=l,a.next_out=f,a.avail_in=l<u?u-l+5:5-(l-u),a.avail_out=f<d?d-f+257:257-(f-d),o.hold=x,o.bits=w}},{}],49:[function(t,n,r){var a=t("../utils/common"),s=t("./adler32"),o=t("./crc32"),l=t("./inffast"),u=t("./inftrees"),f=1,c=2,d=0,h=-2,p=1,m=852,g=592;function y(L){return(L>>>24&255)+(L>>>8&65280)+((65280&L)<<8)+((255&L)<<24)}function x(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new a.Buf16(320),this.work=new a.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function w(L){var O;return L&&L.state?(O=L.state,L.total_in=L.total_out=O.total=0,L.msg="",O.wrap&&(L.adler=1&O.wrap),O.mode=p,O.last=0,O.havedict=0,O.dmax=32768,O.head=null,O.hold=0,O.bits=0,O.lencode=O.lendyn=new a.Buf32(m),O.distcode=O.distdyn=new a.Buf32(g),O.sane=1,O.back=-1,d):h}function _(L){var O;return L&&L.state?((O=L.state).wsize=0,O.whave=0,O.wnext=0,w(L)):h}function C(L,O){var v,S;return L&&L.state?(S=L.state,O<0?(v=0,O=-O):(v=1+(O>>4),O<48&&(O&=15)),O&&(O<8||15<O)?h:(S.window!==null&&S.wbits!==O&&(S.window=null),S.wrap=v,S.wbits=O,_(L))):h}function F(L,O){var v,S;return L?(S=new x,(L.state=S).window=null,(v=C(L,O))!==d&&(L.state=null),v):h}var T,R,N=!0;function j(L){if(N){var O;for(T=new a.Buf32(512),R=new a.Buf32(32),O=0;O<144;)L.lens[O++]=8;for(;O<256;)L.lens[O++]=9;for(;O<280;)L.lens[O++]=7;for(;O<288;)L.lens[O++]=8;for(u(f,L.lens,0,288,T,0,L.work,{bits:9}),O=0;O<32;)L.lens[O++]=5;u(c,L.lens,0,32,R,0,L.work,{bits:5}),N=!1}L.lencode=T,L.lenbits=9,L.distcode=R,L.distbits=5}function ae(L,O,v,S){var Y,D=L.state;return D.window===null&&(D.wsize=1<<D.wbits,D.wnext=0,D.whave=0,D.window=new a.Buf8(D.wsize)),S>=D.wsize?(a.arraySet(D.window,O,v-D.wsize,D.wsize,0),D.wnext=0,D.whave=D.wsize):(S<(Y=D.wsize-D.wnext)&&(Y=S),a.arraySet(D.window,O,v-S,Y,D.wnext),(S-=Y)?(a.arraySet(D.window,O,v-S,S,0),D.wnext=S,D.whave=D.wsize):(D.wnext+=Y,D.wnext===D.wsize&&(D.wnext=0),D.whave<D.wsize&&(D.whave+=Y))),0}r.inflateReset=_,r.inflateReset2=C,r.inflateResetKeep=w,r.inflateInit=function(L){return F(L,15)},r.inflateInit2=F,r.inflate=function(L,O){var v,S,Y,D,G,V,J,H,P,re,ne,te,Me,He,_e,ve,Le,Be,ct,ut,E,X,q,M,k=0,z=new a.Buf8(4),$=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!L||!L.state||!L.output||!L.input&&L.avail_in!==0)return h;(v=L.state).mode===12&&(v.mode=13),G=L.next_out,Y=L.output,J=L.avail_out,D=L.next_in,S=L.input,V=L.avail_in,H=v.hold,P=v.bits,re=V,ne=J,X=d;e:for(;;)switch(v.mode){case p:if(v.wrap===0){v.mode=13;break}for(;P<16;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(2&v.wrap&&H===35615){z[v.check=0]=255&H,z[1]=H>>>8&255,v.check=o(v.check,z,2,0),P=H=0,v.mode=2;break}if(v.flags=0,v.head&&(v.head.done=!1),!(1&v.wrap)||(((255&H)<<8)+(H>>8))%31){L.msg="incorrect header check",v.mode=30;break}if((15&H)!=8){L.msg="unknown compression method",v.mode=30;break}if(P-=4,E=8+(15&(H>>>=4)),v.wbits===0)v.wbits=E;else if(E>v.wbits){L.msg="invalid window size",v.mode=30;break}v.dmax=1<<E,L.adler=v.check=1,v.mode=512&H?10:12,P=H=0;break;case 2:for(;P<16;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(v.flags=H,(255&v.flags)!=8){L.msg="unknown compression method",v.mode=30;break}if(57344&v.flags){L.msg="unknown header flags set",v.mode=30;break}v.head&&(v.head.text=H>>8&1),512&v.flags&&(z[0]=255&H,z[1]=H>>>8&255,v.check=o(v.check,z,2,0)),P=H=0,v.mode=3;case 3:for(;P<32;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}v.head&&(v.head.time=H),512&v.flags&&(z[0]=255&H,z[1]=H>>>8&255,z[2]=H>>>16&255,z[3]=H>>>24&255,v.check=o(v.check,z,4,0)),P=H=0,v.mode=4;case 4:for(;P<16;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}v.head&&(v.head.xflags=255&H,v.head.os=H>>8),512&v.flags&&(z[0]=255&H,z[1]=H>>>8&255,v.check=o(v.check,z,2,0)),P=H=0,v.mode=5;case 5:if(1024&v.flags){for(;P<16;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}v.length=H,v.head&&(v.head.extra_len=H),512&v.flags&&(z[0]=255&H,z[1]=H>>>8&255,v.check=o(v.check,z,2,0)),P=H=0}else v.head&&(v.head.extra=null);v.mode=6;case 6:if(1024&v.flags&&(V<(te=v.length)&&(te=V),te&&(v.head&&(E=v.head.extra_len-v.length,v.head.extra||(v.head.extra=new Array(v.head.extra_len)),a.arraySet(v.head.extra,S,D,te,E)),512&v.flags&&(v.check=o(v.check,S,te,D)),V-=te,D+=te,v.length-=te),v.length))break e;v.length=0,v.mode=7;case 7:if(2048&v.flags){if(V===0)break e;for(te=0;E=S[D+te++],v.head&&E&&v.length<65536&&(v.head.name+=String.fromCharCode(E)),E&&te<V;);if(512&v.flags&&(v.check=o(v.check,S,te,D)),V-=te,D+=te,E)break e}else v.head&&(v.head.name=null);v.length=0,v.mode=8;case 8:if(4096&v.flags){if(V===0)break e;for(te=0;E=S[D+te++],v.head&&E&&v.length<65536&&(v.head.comment+=String.fromCharCode(E)),E&&te<V;);if(512&v.flags&&(v.check=o(v.check,S,te,D)),V-=te,D+=te,E)break e}else v.head&&(v.head.comment=null);v.mode=9;case 9:if(512&v.flags){for(;P<16;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(H!==(65535&v.check)){L.msg="header crc mismatch",v.mode=30;break}P=H=0}v.head&&(v.head.hcrc=v.flags>>9&1,v.head.done=!0),L.adler=v.check=0,v.mode=12;break;case 10:for(;P<32;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}L.adler=v.check=y(H),P=H=0,v.mode=11;case 11:if(v.havedict===0)return L.next_out=G,L.avail_out=J,L.next_in=D,L.avail_in=V,v.hold=H,v.bits=P,2;L.adler=v.check=1,v.mode=12;case 12:if(O===5||O===6)break e;case 13:if(v.last){H>>>=7&P,P-=7&P,v.mode=27;break}for(;P<3;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}switch(v.last=1&H,P-=1,3&(H>>>=1)){case 0:v.mode=14;break;case 1:if(j(v),v.mode=20,O!==6)break;H>>>=2,P-=2;break e;case 2:v.mode=17;break;case 3:L.msg="invalid block type",v.mode=30}H>>>=2,P-=2;break;case 14:for(H>>>=7&P,P-=7&P;P<32;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if((65535&H)!=(H>>>16^65535)){L.msg="invalid stored block lengths",v.mode=30;break}if(v.length=65535&H,P=H=0,v.mode=15,O===6)break e;case 15:v.mode=16;case 16:if(te=v.length){if(V<te&&(te=V),J<te&&(te=J),te===0)break e;a.arraySet(Y,S,D,te,G),V-=te,D+=te,J-=te,G+=te,v.length-=te;break}v.mode=12;break;case 17:for(;P<14;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(v.nlen=257+(31&H),H>>>=5,P-=5,v.ndist=1+(31&H),H>>>=5,P-=5,v.ncode=4+(15&H),H>>>=4,P-=4,286<v.nlen||30<v.ndist){L.msg="too many length or distance symbols",v.mode=30;break}v.have=0,v.mode=18;case 18:for(;v.have<v.ncode;){for(;P<3;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}v.lens[$[v.have++]]=7&H,H>>>=3,P-=3}for(;v.have<19;)v.lens[$[v.have++]]=0;if(v.lencode=v.lendyn,v.lenbits=7,q={bits:v.lenbits},X=u(0,v.lens,0,19,v.lencode,0,v.work,q),v.lenbits=q.bits,X){L.msg="invalid code lengths set",v.mode=30;break}v.have=0,v.mode=19;case 19:for(;v.have<v.nlen+v.ndist;){for(;ve=(k=v.lencode[H&(1<<v.lenbits)-1])>>>16&255,Le=65535&k,!((_e=k>>>24)<=P);){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(Le<16)H>>>=_e,P-=_e,v.lens[v.have++]=Le;else{if(Le===16){for(M=_e+2;P<M;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(H>>>=_e,P-=_e,v.have===0){L.msg="invalid bit length repeat",v.mode=30;break}E=v.lens[v.have-1],te=3+(3&H),H>>>=2,P-=2}else if(Le===17){for(M=_e+3;P<M;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}P-=_e,E=0,te=3+(7&(H>>>=_e)),H>>>=3,P-=3}else{for(M=_e+7;P<M;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}P-=_e,E=0,te=11+(127&(H>>>=_e)),H>>>=7,P-=7}if(v.have+te>v.nlen+v.ndist){L.msg="invalid bit length repeat",v.mode=30;break}for(;te--;)v.lens[v.have++]=E}}if(v.mode===30)break;if(v.lens[256]===0){L.msg="invalid code -- missing end-of-block",v.mode=30;break}if(v.lenbits=9,q={bits:v.lenbits},X=u(f,v.lens,0,v.nlen,v.lencode,0,v.work,q),v.lenbits=q.bits,X){L.msg="invalid literal/lengths set",v.mode=30;break}if(v.distbits=6,v.distcode=v.distdyn,q={bits:v.distbits},X=u(c,v.lens,v.nlen,v.ndist,v.distcode,0,v.work,q),v.distbits=q.bits,X){L.msg="invalid distances set",v.mode=30;break}if(v.mode=20,O===6)break e;case 20:v.mode=21;case 21:if(6<=V&&258<=J){L.next_out=G,L.avail_out=J,L.next_in=D,L.avail_in=V,v.hold=H,v.bits=P,l(L,ne),G=L.next_out,Y=L.output,J=L.avail_out,D=L.next_in,S=L.input,V=L.avail_in,H=v.hold,P=v.bits,v.mode===12&&(v.back=-1);break}for(v.back=0;ve=(k=v.lencode[H&(1<<v.lenbits)-1])>>>16&255,Le=65535&k,!((_e=k>>>24)<=P);){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(ve&&(240&ve)==0){for(Be=_e,ct=ve,ut=Le;ve=(k=v.lencode[ut+((H&(1<<Be+ct)-1)>>Be)])>>>16&255,Le=65535&k,!(Be+(_e=k>>>24)<=P);){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}H>>>=Be,P-=Be,v.back+=Be}if(H>>>=_e,P-=_e,v.back+=_e,v.length=Le,ve===0){v.mode=26;break}if(32&ve){v.back=-1,v.mode=12;break}if(64&ve){L.msg="invalid literal/length code",v.mode=30;break}v.extra=15&ve,v.mode=22;case 22:if(v.extra){for(M=v.extra;P<M;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}v.length+=H&(1<<v.extra)-1,H>>>=v.extra,P-=v.extra,v.back+=v.extra}v.was=v.length,v.mode=23;case 23:for(;ve=(k=v.distcode[H&(1<<v.distbits)-1])>>>16&255,Le=65535&k,!((_e=k>>>24)<=P);){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if((240&ve)==0){for(Be=_e,ct=ve,ut=Le;ve=(k=v.distcode[ut+((H&(1<<Be+ct)-1)>>Be)])>>>16&255,Le=65535&k,!(Be+(_e=k>>>24)<=P);){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}H>>>=Be,P-=Be,v.back+=Be}if(H>>>=_e,P-=_e,v.back+=_e,64&ve){L.msg="invalid distance code",v.mode=30;break}v.offset=Le,v.extra=15&ve,v.mode=24;case 24:if(v.extra){for(M=v.extra;P<M;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}v.offset+=H&(1<<v.extra)-1,H>>>=v.extra,P-=v.extra,v.back+=v.extra}if(v.offset>v.dmax){L.msg="invalid distance too far back",v.mode=30;break}v.mode=25;case 25:if(J===0)break e;if(te=ne-J,v.offset>te){if((te=v.offset-te)>v.whave&&v.sane){L.msg="invalid distance too far back",v.mode=30;break}Me=te>v.wnext?(te-=v.wnext,v.wsize-te):v.wnext-te,te>v.length&&(te=v.length),He=v.window}else He=Y,Me=G-v.offset,te=v.length;for(J<te&&(te=J),J-=te,v.length-=te;Y[G++]=He[Me++],--te;);v.length===0&&(v.mode=21);break;case 26:if(J===0)break e;Y[G++]=v.length,J--,v.mode=21;break;case 27:if(v.wrap){for(;P<32;){if(V===0)break e;V--,H|=S[D++]<<P,P+=8}if(ne-=J,L.total_out+=ne,v.total+=ne,ne&&(L.adler=v.check=v.flags?o(v.check,Y,ne,G-ne):s(v.check,Y,ne,G-ne)),ne=J,(v.flags?H:y(H))!==v.check){L.msg="incorrect data check",v.mode=30;break}P=H=0}v.mode=28;case 28:if(v.wrap&&v.flags){for(;P<32;){if(V===0)break e;V--,H+=S[D++]<<P,P+=8}if(H!==(4294967295&v.total)){L.msg="incorrect length check",v.mode=30;break}P=H=0}v.mode=29;case 29:X=1;break e;case 30:X=-3;break e;case 31:return-4;case 32:default:return h}return L.next_out=G,L.avail_out=J,L.next_in=D,L.avail_in=V,v.hold=H,v.bits=P,(v.wsize||ne!==L.avail_out&&v.mode<30&&(v.mode<27||O!==4))&&ae(L,L.output,L.next_out,ne-L.avail_out)?(v.mode=31,-4):(re-=L.avail_in,ne-=L.avail_out,L.total_in+=re,L.total_out+=ne,v.total+=ne,v.wrap&&ne&&(L.adler=v.check=v.flags?o(v.check,Y,ne,L.next_out-ne):s(v.check,Y,ne,L.next_out-ne)),L.data_type=v.bits+(v.last?64:0)+(v.mode===12?128:0)+(v.mode===20||v.mode===15?256:0),(re==0&&ne===0||O===4)&&X===d&&(X=-5),X)},r.inflateEnd=function(L){if(!L||!L.state)return h;var O=L.state;return O.window&&(O.window=null),L.state=null,d},r.inflateGetHeader=function(L,O){var v;return L&&L.state?(2&(v=L.state).wrap)==0?h:((v.head=O).done=!1,d):h},r.inflateSetDictionary=function(L,O){var v,S=O.length;return L&&L.state?(v=L.state).wrap!==0&&v.mode!==11?h:v.mode===11&&s(1,O,S,0)!==v.check?-3:ae(L,O,S,S)?(v.mode=31,-4):(v.havedict=1,d):h},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,n,r){var a=t("../utils/common"),s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],u=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];n.exports=function(f,c,d,h,p,m,g,y){var x,w,_,C,F,T,R,N,j,ae=y.bits,L=0,O=0,v=0,S=0,Y=0,D=0,G=0,V=0,J=0,H=0,P=null,re=0,ne=new a.Buf16(16),te=new a.Buf16(16),Me=null,He=0;for(L=0;L<=15;L++)ne[L]=0;for(O=0;O<h;O++)ne[c[d+O]]++;for(Y=ae,S=15;1<=S&&ne[S]===0;S--);if(S<Y&&(Y=S),S===0)return p[m++]=20971520,p[m++]=20971520,y.bits=1,0;for(v=1;v<S&&ne[v]===0;v++);for(Y<v&&(Y=v),L=V=1;L<=15;L++)if(V<<=1,(V-=ne[L])<0)return-1;if(0<V&&(f===0||S!==1))return-1;for(te[1]=0,L=1;L<15;L++)te[L+1]=te[L]+ne[L];for(O=0;O<h;O++)c[d+O]!==0&&(g[te[c[d+O]]++]=O);if(T=f===0?(P=Me=g,19):f===1?(P=s,re-=257,Me=o,He-=257,256):(P=l,Me=u,-1),L=v,F=m,G=O=H=0,_=-1,C=(J=1<<(D=Y))-1,f===1&&852<J||f===2&&592<J)return 1;for(;;){for(R=L-G,j=g[O]<T?(N=0,g[O]):g[O]>T?(N=Me[He+g[O]],P[re+g[O]]):(N=96,0),x=1<<L-G,v=w=1<<D;p[F+(H>>G)+(w-=x)]=R<<24|N<<16|j|0,w!==0;);for(x=1<<L-1;H&x;)x>>=1;if(x!==0?(H&=x-1,H+=x):H=0,O++,--ne[L]==0){if(L===S)break;L=c[d+g[O]]}if(Y<L&&(H&C)!==_){for(G===0&&(G=Y),F+=v,V=1<<(D=L-G);D+G<S&&!((V-=ne[D+G])<=0);)D++,V<<=1;if(J+=1<<D,f===1&&852<J||f===2&&592<J)return 1;p[_=H&C]=Y<<24|D<<16|F-m|0}}return H!==0&&(p[F+H]=L-G<<24|64<<16|0),y.bits=Y,0}},{"../utils/common":41}],51:[function(t,n,r){n.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,n,r){var a=t("../utils/common"),s=0,o=1;function l(k){for(var z=k.length;0<=--z;)k[z]=0}var u=0,f=29,c=256,d=c+1+f,h=30,p=19,m=2*d+1,g=15,y=16,x=7,w=256,_=16,C=17,F=18,T=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],R=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],N=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ae=new Array(2*(d+2));l(ae);var L=new Array(2*h);l(L);var O=new Array(512);l(O);var v=new Array(256);l(v);var S=new Array(f);l(S);var Y,D,G,V=new Array(h);function J(k,z,$,Q,W){this.static_tree=k,this.extra_bits=z,this.extra_base=$,this.elems=Q,this.max_length=W,this.has_stree=k&&k.length}function H(k,z){this.dyn_tree=k,this.max_code=0,this.stat_desc=z}function P(k){return k<256?O[k]:O[256+(k>>>7)]}function re(k,z){k.pending_buf[k.pending++]=255&z,k.pending_buf[k.pending++]=z>>>8&255}function ne(k,z,$){k.bi_valid>y-$?(k.bi_buf|=z<<k.bi_valid&65535,re(k,k.bi_buf),k.bi_buf=z>>y-k.bi_valid,k.bi_valid+=$-y):(k.bi_buf|=z<<k.bi_valid&65535,k.bi_valid+=$)}function te(k,z,$){ne(k,$[2*z],$[2*z+1])}function Me(k,z){for(var $=0;$|=1&k,k>>>=1,$<<=1,0<--z;);return $>>>1}function He(k,z,$){var Q,W,oe=new Array(g+1),de=0;for(Q=1;Q<=g;Q++)oe[Q]=de=de+$[Q-1]<<1;for(W=0;W<=z;W++){var le=k[2*W+1];le!==0&&(k[2*W]=Me(oe[le]++,le))}}function _e(k){var z;for(z=0;z<d;z++)k.dyn_ltree[2*z]=0;for(z=0;z<h;z++)k.dyn_dtree[2*z]=0;for(z=0;z<p;z++)k.bl_tree[2*z]=0;k.dyn_ltree[2*w]=1,k.opt_len=k.static_len=0,k.last_lit=k.matches=0}function ve(k){8<k.bi_valid?re(k,k.bi_buf):0<k.bi_valid&&(k.pending_buf[k.pending++]=k.bi_buf),k.bi_buf=0,k.bi_valid=0}function Le(k,z,$,Q){var W=2*z,oe=2*$;return k[W]<k[oe]||k[W]===k[oe]&&Q[z]<=Q[$]}function Be(k,z,$){for(var Q=k.heap[$],W=$<<1;W<=k.heap_len&&(W<k.heap_len&&Le(z,k.heap[W+1],k.heap[W],k.depth)&&W++,!Le(z,Q,k.heap[W],k.depth));)k.heap[$]=k.heap[W],$=W,W<<=1;k.heap[$]=Q}function ct(k,z,$){var Q,W,oe,de,le=0;if(k.last_lit!==0)for(;Q=k.pending_buf[k.d_buf+2*le]<<8|k.pending_buf[k.d_buf+2*le+1],W=k.pending_buf[k.l_buf+le],le++,Q===0?te(k,W,z):(te(k,(oe=v[W])+c+1,z),(de=T[oe])!==0&&ne(k,W-=S[oe],de),te(k,oe=P(--Q),$),(de=R[oe])!==0&&ne(k,Q-=V[oe],de)),le<k.last_lit;);te(k,w,z)}function ut(k,z){var $,Q,W,oe=z.dyn_tree,de=z.stat_desc.static_tree,le=z.stat_desc.has_stree,we=z.stat_desc.elems,je=-1;for(k.heap_len=0,k.heap_max=m,$=0;$<we;$++)oe[2*$]!==0?(k.heap[++k.heap_len]=je=$,k.depth[$]=0):oe[2*$+1]=0;for(;k.heap_len<2;)oe[2*(W=k.heap[++k.heap_len]=je<2?++je:0)]=1,k.depth[W]=0,k.opt_len--,le&&(k.static_len-=de[2*W+1]);for(z.max_code=je,$=k.heap_len>>1;1<=$;$--)Be(k,oe,$);for(W=we;$=k.heap[1],k.heap[1]=k.heap[k.heap_len--],Be(k,oe,1),Q=k.heap[1],k.heap[--k.heap_max]=$,k.heap[--k.heap_max]=Q,oe[2*W]=oe[2*$]+oe[2*Q],k.depth[W]=(k.depth[$]>=k.depth[Q]?k.depth[$]:k.depth[Q])+1,oe[2*$+1]=oe[2*Q+1]=W,k.heap[1]=W++,Be(k,oe,1),2<=k.heap_len;);k.heap[--k.heap_max]=k.heap[1],function(De,_t){var Mt,Ft,A,I,ie,Z,se=_t.dyn_tree,me=_t.max_code,Ee=_t.stat_desc.static_tree,Re=_t.stat_desc.has_stree,ze=_t.stat_desc.extra_bits,et=_t.stat_desc.extra_base,$e=_t.stat_desc.max_length,ft=0;for(I=0;I<=g;I++)De.bl_count[I]=0;for(se[2*De.heap[De.heap_max]+1]=0,Mt=De.heap_max+1;Mt<m;Mt++)$e<(I=se[2*se[2*(Ft=De.heap[Mt])+1]+1]+1)&&(I=$e,ft++),se[2*Ft+1]=I,me<Ft||(De.bl_count[I]++,ie=0,et<=Ft&&(ie=ze[Ft-et]),Z=se[2*Ft],De.opt_len+=Z*(I+ie),Re&&(De.static_len+=Z*(Ee[2*Ft+1]+ie)));if(ft!==0){do{for(I=$e-1;De.bl_count[I]===0;)I--;De.bl_count[I]--,De.bl_count[I+1]+=2,De.bl_count[$e]--,ft-=2}while(0<ft);for(I=$e;I!==0;I--)for(Ft=De.bl_count[I];Ft!==0;)me<(A=De.heap[--Mt])||(se[2*A+1]!==I&&(De.opt_len+=(I-se[2*A+1])*se[2*A],se[2*A+1]=I),Ft--)}}(k,z),He(oe,je,k.bl_count)}function E(k,z,$){var Q,W,oe=-1,de=z[1],le=0,we=7,je=4;for(de===0&&(we=138,je=3),z[2*($+1)+1]=65535,Q=0;Q<=$;Q++)W=de,de=z[2*(Q+1)+1],++le<we&&W===de||(le<je?k.bl_tree[2*W]+=le:W!==0?(W!==oe&&k.bl_tree[2*W]++,k.bl_tree[2*_]++):le<=10?k.bl_tree[2*C]++:k.bl_tree[2*F]++,oe=W,je=(le=0)===de?(we=138,3):W===de?(we=6,3):(we=7,4))}function X(k,z,$){var Q,W,oe=-1,de=z[1],le=0,we=7,je=4;for(de===0&&(we=138,je=3),Q=0;Q<=$;Q++)if(W=de,de=z[2*(Q+1)+1],!(++le<we&&W===de)){if(le<je)for(;te(k,W,k.bl_tree),--le!=0;);else W!==0?(W!==oe&&(te(k,W,k.bl_tree),le--),te(k,_,k.bl_tree),ne(k,le-3,2)):le<=10?(te(k,C,k.bl_tree),ne(k,le-3,3)):(te(k,F,k.bl_tree),ne(k,le-11,7));oe=W,je=(le=0)===de?(we=138,3):W===de?(we=6,3):(we=7,4)}}l(V);var q=!1;function M(k,z,$,Q){ne(k,(u<<1)+(Q?1:0),3),function(W,oe,de,le){ve(W),re(W,de),re(W,~de),a.arraySet(W.pending_buf,W.window,oe,de,W.pending),W.pending+=de}(k,z,$)}r._tr_init=function(k){q||(function(){var z,$,Q,W,oe,de=new Array(g+1);for(W=Q=0;W<f-1;W++)for(S[W]=Q,z=0;z<1<<T[W];z++)v[Q++]=W;for(v[Q-1]=W,W=oe=0;W<16;W++)for(V[W]=oe,z=0;z<1<<R[W];z++)O[oe++]=W;for(oe>>=7;W<h;W++)for(V[W]=oe<<7,z=0;z<1<<R[W]-7;z++)O[256+oe++]=W;for($=0;$<=g;$++)de[$]=0;for(z=0;z<=143;)ae[2*z+1]=8,z++,de[8]++;for(;z<=255;)ae[2*z+1]=9,z++,de[9]++;for(;z<=279;)ae[2*z+1]=7,z++,de[7]++;for(;z<=287;)ae[2*z+1]=8,z++,de[8]++;for(He(ae,d+1,de),z=0;z<h;z++)L[2*z+1]=5,L[2*z]=Me(z,5);Y=new J(ae,T,c+1,d,g),D=new J(L,R,0,h,g),G=new J(new Array(0),N,0,p,x)}(),q=!0),k.l_desc=new H(k.dyn_ltree,Y),k.d_desc=new H(k.dyn_dtree,D),k.bl_desc=new H(k.bl_tree,G),k.bi_buf=0,k.bi_valid=0,_e(k)},r._tr_stored_block=M,r._tr_flush_block=function(k,z,$,Q){var W,oe,de=0;0<k.level?(k.strm.data_type===2&&(k.strm.data_type=function(le){var we,je=4093624447;for(we=0;we<=31;we++,je>>>=1)if(1&je&&le.dyn_ltree[2*we]!==0)return s;if(le.dyn_ltree[18]!==0||le.dyn_ltree[20]!==0||le.dyn_ltree[26]!==0)return o;for(we=32;we<c;we++)if(le.dyn_ltree[2*we]!==0)return o;return s}(k)),ut(k,k.l_desc),ut(k,k.d_desc),de=function(le){var we;for(E(le,le.dyn_ltree,le.l_desc.max_code),E(le,le.dyn_dtree,le.d_desc.max_code),ut(le,le.bl_desc),we=p-1;3<=we&&le.bl_tree[2*j[we]+1]===0;we--);return le.opt_len+=3*(we+1)+5+5+4,we}(k),W=k.opt_len+3+7>>>3,(oe=k.static_len+3+7>>>3)<=W&&(W=oe)):W=oe=$+5,$+4<=W&&z!==-1?M(k,z,$,Q):k.strategy===4||oe===W?(ne(k,2+(Q?1:0),3),ct(k,ae,L)):(ne(k,4+(Q?1:0),3),function(le,we,je,De){var _t;for(ne(le,we-257,5),ne(le,je-1,5),ne(le,De-4,4),_t=0;_t<De;_t++)ne(le,le.bl_tree[2*j[_t]+1],3);X(le,le.dyn_ltree,we-1),X(le,le.dyn_dtree,je-1)}(k,k.l_desc.max_code+1,k.d_desc.max_code+1,de+1),ct(k,k.dyn_ltree,k.dyn_dtree)),_e(k),Q&&ve(k)},r._tr_tally=function(k,z,$){return k.pending_buf[k.d_buf+2*k.last_lit]=z>>>8&255,k.pending_buf[k.d_buf+2*k.last_lit+1]=255&z,k.pending_buf[k.l_buf+k.last_lit]=255&$,k.last_lit++,z===0?k.dyn_ltree[2*$]++:(k.matches++,z--,k.dyn_ltree[2*(v[$]+c+1)]++,k.dyn_dtree[2*P(z)]++),k.last_lit===k.lit_bufsize-1},r._tr_align=function(k){ne(k,2,3),te(k,w,ae),function(z){z.bi_valid===16?(re(z,z.bi_buf),z.bi_buf=0,z.bi_valid=0):8<=z.bi_valid&&(z.pending_buf[z.pending++]=255&z.bi_buf,z.bi_buf>>=8,z.bi_valid-=8)}(k)}},{"../utils/common":41}],53:[function(t,n,r){n.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,n,r){(function(a){(function(s,o){if(!s.setImmediate){var l,u,f,c,d=1,h={},p=!1,m=s.document,g=Object.getPrototypeOf&&Object.getPrototypeOf(s);g=g&&g.setTimeout?g:s,l={}.toString.call(s.process)==="[object process]"?function(_){process.nextTick(function(){x(_)})}:function(){if(s.postMessage&&!s.importScripts){var _=!0,C=s.onmessage;return s.onmessage=function(){_=!1},s.postMessage("","*"),s.onmessage=C,_}}()?(c="setImmediate$"+Math.random()+"$",s.addEventListener?s.addEventListener("message",w,!1):s.attachEvent("onmessage",w),function(_){s.postMessage(c+_,"*")}):s.MessageChannel?((f=new MessageChannel).port1.onmessage=function(_){x(_.data)},function(_){f.port2.postMessage(_)}):m&&"onreadystatechange"in m.createElement("script")?(u=m.documentElement,function(_){var C=m.createElement("script");C.onreadystatechange=function(){x(_),C.onreadystatechange=null,u.removeChild(C),C=null},u.appendChild(C)}):function(_){setTimeout(x,0,_)},g.setImmediate=function(_){typeof _!="function"&&(_=new Function(""+_));for(var C=new Array(arguments.length-1),F=0;F<C.length;F++)C[F]=arguments[F+1];var T={callback:_,args:C};return h[d]=T,l(d),d++},g.clearImmediate=y}function y(_){delete h[_]}function x(_){if(p)setTimeout(x,0,_);else{var C=h[_];if(C){p=!0;try{(function(F){var T=F.callback,R=F.args;switch(R.length){case 0:T();break;case 1:T(R[0]);break;case 2:T(R[0],R[1]);break;case 3:T(R[0],R[1],R[2]);break;default:T.apply(o,R)}})(C)}finally{y(_),p=!1}}}}function w(_){_.source===s&&typeof _.data=="string"&&_.data.indexOf(c)===0&&x(+_.data.slice(c.length))}})(typeof self>"u"?a===void 0?this:a:self)}).call(this,typeof vi<"u"?vi:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})}(ws)),ws.exports}var am=rm();const sm=or(am);class om{static worker=new Worker(new URL("/smeditor/assets/SafariFileWorker-C6T6cial.js",import.meta.url),{type:"module"});static workID=0;static map=new Map;static{this.worker.onmessage=e=>{const t=e.data;t.success?this.map.get(t.id)[0]():this.map.get(t.id)[1](t.reason),this.map.delete(t.id)}}static async writeHandle(e,t){const n=this.workID++,r=new Promise((o,l)=>this.map.set(n,[o,l])),a=new TextEncoder,s=typeof t=="string"?a.encode(t).buffer:await t.arrayBuffer();return this.worker.postMessage([n,e,s],[s]),r}}class lm{_root;async getRoot(){return this._root||(J0.adapter.native?await cc().then(e=>this._root=e):await cc(qe(()=>import("./memory-TENAsLGL.js"),__vite__mapDeps([0,1,2]))).then(e=>this._root=e)),this._root}async uploadHandle(e,t){let n;if(typeof t=="string"){const r=await this.getDirectoryHandle(t,{create:!0});if(!r)return;n=r}else n=t??await this.getRoot();if(e.kind=="file"){const r=await n.getFileHandle(e.name,{create:!0});await this.writeFile(r,await e.getFile())}else{const r=await n.getDirectoryHandle(e.name,{create:!0}),a=[];for await(const s of e.values())a.push(this.uploadHandle(s,r));await Promise.all(a)}}async uploadFiles(e,t){let n;if(typeof t=="string"){const r=await this.getDirectoryHandle(t,{create:!0});if(!r)return;n=r}else n=t??await this.getRoot();if(e.isFile){const r=e;if(r.name==".DS_Store")return;r.file(async a=>{const s=await n.getFileHandle(a.name,{create:!0});await this.writeHandle(s,a)})}else if(e.isDirectory){const r=e.createReader(),a=await n.getDirectoryHandle(e.name,{create:!0});for await(const s of a.values())await a.removeEntry(s.name,{recursive:!0});r.readEntries(async s=>{const o=[];for(let l=0;l<s.length;l++)o.push(this.uploadFiles(s[l],a));await Promise.all(o)})}}async handleDropEvent(e,t){e.stopPropagation(),e.preventDefault();const n=e.dataTransfer.items;if(!t){t="";for(let s=0;s<n.length;s++){const o=n[s].webkitGetAsEntry();if(o?.isFile&&(o.name.endsWith(".sm")||o.name.endsWith(".ssc"))){t="New Song";break}}}const r=[];for(let s=0;s<n.length;s++){const o=n[s].webkitGetAsEntry();o&&r.push(this.uploadFiles(o,t))}let a;return n.length==1&&n[0].webkitGetAsEntry().isDirectory&&(a=n[0].webkitGetAsEntry().name),await Promise.all(r),a}async uploadDir(e,t){let n;if(typeof t=="string"){const a=await this.getDirectoryHandle(t);if(!a)return;n=a}else n=t??await this.getRoot();const r=await n.getDirectoryHandle(e.name,{create:!0});for await(const a of e.values())if(a.kind=="file"){const s=await r.getFileHandle(a.name,{create:!0}),o=await a.getFile();await this.writeHandle(s,o)}else await this.uploadDir(a,r)}async getDirectoryHandle(e,t,n){if(n||=await this.getRoot(),e=this.resolvePath(...e.split("/")),e==""||e==".")return n;const r=e.split("/"),a=r.shift();try{const s=await n.getDirectoryHandle(a,t);return s?r.length==0?s:this.getDirectoryHandle(r.join("/"),t,s):void 0}catch(s){console.error(`Failed to get directory ${e} (${a}): `+s);return}}async hasFile(e){try{return await this.getFileHandle(e)!==void 0}catch{return!1}}async getFileHandle(e,t){try{const n=this.resolvePath(...e.split("/")).split("/"),r=n.pop(),a=await this.getDirectoryHandle(n.join("/"),t);return a?await a.getFileHandle(r,t):void 0}catch(n){console.error("Failed to get file "+e+": "+n);return}}async getFileHandleRelativeTo(e,t){try{return Tt(e)!=""&&(e=ot(e)),this.getFileHandle(this.resolvePath(e,"/",t))}catch(n){console.error("Failed to get relative file "+t+": "+n);return}}async getDirectoryFiles(e){try{let t;if(typeof e=="string"){if(t=await this.getDirectoryHandle(e),!t)return[]}else t=e;const n=[];for await(const r of t.values())r.kind=="file"&&n.push(r);return n}catch(t){return console.error(t),[]}}async getDirectoryFolders(e){try{let t;if(typeof e=="string"){if(t=await this.getDirectoryHandle(e),!t)return[]}else t=e;const n=[];for await(const r of t.values())r.kind=="directory"&&n.push(r);return n}catch(t){return console.error(t),[]}}async writeFile(e,t){let n;if(typeof e=="string"){if(n=await this.getFileHandle(e,{create:!0}),!n){ue.createFormatted("Failed to write to "+e+"!","error");return}}else n=e;await this.writeHandle(n,t)}async removeFile(e,t){try{const n=ot(e),r=await this.getDirectoryHandle(n);if(!r)return;await r.removeEntry(Lt(e),t)}catch(n){console.error(n);return}}async removeDirectory(e){return this.removeFile(e,{recursive:!0})}async remove(e){return Tt(e)==""?this.removeDirectory(e):this.removeFile(e)}resolvePath(...e){let t=e;for(t=t.filter(n=>n!="."&&n!="");t.indexOf("..")>-1;){const n=t.indexOf("..");if(n==0)throw Error("Path "+t.join("/")+" is invalid!");t.splice(n-1,2)}return t.join("/")}async zipDirectory(e,t){const n=t??new sm,r=Tt(e)==""?e:ot(e),a=await this.getDirectoryHandle(r);if(a){for(const s of await this.getDirectoryFiles(a))n.file(s.name,await s.getFile());for(const s of await this.getDirectoryFolders(a)){const o=n.folder(s.name);if(!o){console.error("Failed to zip folder "+r+"/"+s.name);continue}await this.zipDirectory(r+"/"+s.name,o)}return n}}async saveDirectory(e){const t=Tt(e)==""?e:ot(e);ue.create("Exporting "+t+".zip");const n=await Z0({_preferPolyfill:!1,suggestedName:`${t}.zip`,types:[{accept:{"application/zip":[".zip"]}}],excludeAcceptAllOption:!1}),r=await this.zipDirectory(e);r&&await r.generateAsync({type:"blob"}).then(async a=>{if(!window.showSaveFilePicker){console.log(a);const s=document.createElement("a"),o=URL.createObjectURL(a);document.body.appendChild(s),s.href=o,s.download=t+".zip",s.click(),s.remove(),window.URL.revokeObjectURL(o);return}await this.writeHandle(n,a)})}async renameFile(e,t){if(e!=t)try{const n=await this.getDirectoryHandle(ot(e)),r=await this.getDirectoryHandle(ot(t),{create:!0}),a=await this.getFileHandle(e);if(!n||!r||!a)return;await this.copyToHandle(r,a,Lt(t)),await n.removeEntry(Lt(e))}catch(n){console.error(n)}}async renameDirectory(e,t){if(!t.startsWith(e))try{const n=await this.getDirectoryHandle(ot(e)),r=await this.getDirectoryHandle(ot(t),{create:!0}),a=await this.getDirectoryHandle(e);if(!n||!r||!a)return;await this.copyToHandle(r,a,Lt(t)),await n.removeEntry(Lt(e),{recursive:!0})}catch(n){console.error(n)}}async copyToHandle(e,t,n){try{if(t.kind=="directory"){const r=await e.getDirectoryHandle(n??t.name,{create:!0}),a=[];for await(const s of t.values())a.push(this.copyToHandle(r,s));await Promise.all(a)}else{const r=await t.getFile(),a=await e.getFileHandle(n??t.name,{create:!0});await this.writeHandle(a,r)}}catch(r){console.error(r)}}getRelativePath(e,t){const n=e.split("/"),r=t.split("/"),a=Math.min(n.length,r.length);let s=a;for(let l=0;l<a;l++)if(n[l]!==r[l]){s=l;break}if(s==0)return t;let o=[];for(let l=s;l<n.length;l++)o.push("..");return o=o.concat(r.slice(s)),o.join("/")}async writeHandle(e,t){if(e.createWritable){const n=await e.createWritable();await n.write(t),await n.close()}else{const n=await(await this.getRoot()).resolve(e);if(!n)return;await om.writeHandle(n.join("/"),t)}}}class Ce{static standardHandler;static urlHandler;static async initFileSystem(){this.urlHandler=new nm,this.standardHandler=window.nw?new(await qe(async()=>{const{NodeFileHandler:e}=await import("./NodeFileHandler-DCs-8a02.js");return{NodeFileHandler:e}},__vite__mapDeps([6,1,2]))).NodeFileHandler:new lm}static getStandardHandler(){return this.standardHandler}static getHandler(e){return e!==void 0&&e.startsWith("https://")||e?.startsWith("http://")?this.urlHandler:this.standardHandler}static handleDropEvent(e,t){return this.getHandler().handleDropEvent(e,t)}static getDirectoryHandle(e,t){return Ce.getHandler(e).getDirectoryHandle(e,t)}static hasFile(e){return Ce.getHandler(e).hasFile(e)}static getFileHandle(e,t){return Ce.getHandler(e).getFileHandle(e,t)}static getFileHandleRelativeTo(e,t){return Ce.getHandler(e).getFileHandleRelativeTo(e,t)}static getDirectoryFiles(e){return Ce.getHandler(typeof e=="string"?e:void 0).getDirectoryFiles(e)}static getDirectoryFolders(e){return Ce.getHandler(typeof e=="string"?e:void 0).getDirectoryFolders(e)}static writeFile(e,t){return Ce.getHandler(typeof e=="string"?e:void 0).writeFile(e,t)}static removeFile(e){return Ce.getHandler(e).removeFile(e)}static getRelativePath(e,t){return Ce.getHandler().getRelativePath(e,t)}}class oa extends ht{app;dirOptions;fileDropPath="";draggedElement;draggedCopy;keyHandler;dropHandler;mouseHandler;dragHandler;constructor(e,t,n){super({title:t.title,width:500,height:400,disableClose:t.disableClose,win_id:"file_selector"+Math.random(),blocking:!0}),this.app=e,this.dirOptions=t,t.accepted_file_types||=[],this.keyHandler=this.handleKeyEvent.bind(this),this.dropHandler=this.handleDropEvent.bind(this),this.mouseHandler=this.handleMouseEvent.bind(this),this.dragHandler=this.handleDragEvent.bind(this),this.initView().then(()=>{n&&this.selectPath(n),t.onload?.()})}async initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("menu-options");const n=document.createElement("div");n.classList.add("menu-left");const r=document.createElement("div");r.classList.add("menu-right"),t.appendChild(n),t.appendChild(r);const a=document.createElement("button");a.innerText="Cancel",a.onclick=()=>{window.removeEventListener("keydown",this.keyHandler,!0),window.removeEventListener("drop",this.dropHandler,!0),this.closeWindow()};const s=document.createElement("button");s.innerText="Select",s.classList.add("confirm"),s.onclick=()=>this.confirmFile(),s.disabled=!0,n.appendChild(a),r.appendChild(s);const o=document.createElement("div");o.classList.add("dir-selector"),o.onclick=y=>{y.target==o&&this.selectElement(void 0)};const l=document.createElement("div");l.classList.add("file-options");const u=document.createElement("button"),f=be.getIcon("ADD_FILE",16);u.appendChild(f),u.appendChild(document.createTextNode("Upload files")),l.appendChild(u),u.onclick=async()=>{const y=this.fileDropPath,x=await Wu({_preferPolyfill:!0,excludeAcceptAllOption:!1,multiple:!0}),_=this.viewElement.querySelector(".info.selected")?.dataset.path??"",C=[];for(const F of x)C.push(Ce.getStandardHandler().uploadHandle(F,_));await Promise.all(C),await this.refreshDirectory(y),this.getAcceptableFile(y).then(F=>this.selectPath(F))};const c=document.createElement("button"),d=be.getIcon("FOLDER",16);c.appendChild(d),c.appendChild(document.createTextNode("Upload folder")),l.appendChild(c),c.onclick=async()=>{const y=this.fileDropPath,x=await X0({_preferPolyfill:!0}),_=this.viewElement.querySelector(".info.selected")?.dataset.path??"";await Ce.getStandardHandler().uploadHandle(x,_),await this.refreshDirectory(y),this.getAcceptableFile(y==""?x.name:y+"/"+x.name).then(C=>this.selectPath(C))};const h=document.createElement("button");h.classList.add("rename");const p=be.getIcon("EDIT",16);h.appendChild(p),h.appendChild(document.createTextNode("Rename")),h.disabled=!0,h.onclick=()=>{const y=this.viewElement.querySelector(".info.selected");y?.dataset.path&&this.startEditing(y.querySelector("textarea"))},l.appendChild(h);const m=document.createElement("button");m.classList.add("delete");const g=be.getIcon("TRASH",16);m.appendChild(g),m.appendChild(document.createTextNode("Delete")),m.disabled=!0,m.onclick=()=>{const y=this.viewElement.querySelector(".info.selected"),x=y?.dataset.path;if(!x)return;const w=y.parentElement.classList.contains("folder");Ce.getStandardHandler()[w?"removeDirectory":"removeFile"](x).then(()=>{const _=this.getElement(x);_&&(_.parentElement?.remove(),m.disabled=!0,h.disabled=!0)})},l.appendChild(m),e.appendChild(o),e.appendChild(l),e.appendChild(t),this.viewElement.appendChild(e),window.addEventListener("keydown",this.keyHandler,!0),window.addEventListener("drop",this.dropHandler,!0),window.addEventListener("mousemove",this.dragHandler,!0),this.viewElement.addEventListener("dragover",this.mouseHandler),await this.createDiv("").then(y=>o.replaceChildren(...y))}async expand(e){if(!e.parentElement.classList.contains("folder"))return;e.parentElement.classList.remove("collapsed");const t=e.nextSibling;await this.createDiv(e.dataset.path).then(n=>{t.replaceChildren(...n)})}collapse(e){if(!e.parentElement.classList.contains("folder"))return;e.parentElement.classList.add("collapsed"),e.nextSibling.replaceChildren()}selectElement(e){if(this.viewElement.querySelector(".info.selected")?.classList.remove("selected"),!e){this.viewElement.querySelector(".delete").disabled=!0,this.viewElement.querySelector(".rename").disabled=!0;return}e.classList.add("selected"),$n(e,{scrollMode:"if-needed",block:"nearest",inline:"nearest"});const t=this.viewElement.querySelector("button.confirm"),n=e.dataset.path;t.disabled=!0,n&&(t.disabled=!this.acceptableFileType(n),this.viewElement.querySelector(".delete").disabled=!1,this.viewElement.querySelector(".rename").disabled=!1)}async createDiv(e){const t=await Ce.getStandardHandler().getDirectoryFolders(e);let n=await Ce.getStandardHandler().getDirectoryFiles(e);return t.sort((r,a)=>r.name.toLowerCase().localeCompare(a.name.toLowerCase())),n.sort((r,a)=>r.name.toLowerCase().localeCompare(a.name.toLowerCase())),n=n.filter(r=>Tt(r.name)!=".crswap"),t.map(r=>this.createBaseElement(e,r)).concat(n.map(r=>this.createBaseElement(e,r)))}createBaseElement(e,t){e!=""&&(e+="/");const n=document.createElement("div");n.classList.add("item");const r=document.createElement("div");if(r.classList.add("info"),n.appendChild(r),t.kind=="directory"){const s=be.getIcon("CHEVRON",16);s.classList.add("folder-icon"),r.appendChild(s);const o=document.createElement("div");o.classList.add("children"),n.appendChild(o),n.classList.add("folder"),n.classList.add("collapsed"),r.addEventListener("click",l=>{const u=l.target;u?.classList.contains("options-icon")||u.tagName=="TEXTAREA"&&!u.disabled||(n.classList.contains("collapsed")?this.expand(r):this.collapse(r))})}else{this.acceptableFileType(t.name)||r.classList.add("disabled");const s=be.getIcon(this.getIconId(t.name),16);r.appendChild(s)}r.dataset.path=e+t.name;const a=document.createElement("textarea");return a.rows=1,a.disabled=!0,a.autocomplete="off",a.autocapitalize="off",a.spellcheck=!1,a.innerText=t.name,a.style.pointerEvents="none",a.classList.add("title"),r.appendChild(a),r.addEventListener("click",()=>this.selectElement(r)),r.addEventListener("mousedown",()=>this.startDragging(r)),r.ondblclick=()=>this.confirmFile(),n}confirmFile(){const t=this.viewElement.querySelector(".info.selected")?.dataset.path;t&&this.acceptableFileType(t)&&(this.dirOptions.callback?.(t),window.removeEventListener("keydown",this.keyHandler,!0),window.removeEventListener("drop",this.dropHandler,!0),window.removeEventListener("mousemove",this.dragHandler,!0),this.closeWindow())}acceptableFileType(e){return this.dirOptions.accepted_file_types.length==0||this.dirOptions.accepted_file_types.includes(Tt(e))}getIconId(e){const t=Tt(e);return t==""&&!e.startsWith(".")?"FOLDER":qi.includes(t)?"IMAGE_FILE":ea.includes(t)?"VOLUME":[".sm",".ssc"].includes(t)?"SM_FILE":"UNKNOWN_FILE"}startEditing(e){const t=e.value,n=!!e.parentElement?.parentElement?.classList.contains("folder"),r=e.parentElement?.dataset.path??"",a=ot(r);e.value=r.split("/").at(-1)??"",window.removeEventListener("keydown",this.keyHandler,!0),e.disabled=!1,e.style.pointerEvents="",e.focus(),e.addEventListener("keypress",s=>{s.code=="Enter"&&(s.preventDefault(),s.stopImmediatePropagation(),e.blur())},!0),e.addEventListener("blur",async()=>{if(window.addEventListener("keydown",this.keyHandler,!0),e.disabled=!0,e.style.pointerEvents="none",e.value.startsWith(".")){e.value=t;return}e.value=e.value.replaceAll("/","");const s=a==""?e.value:a+"/"+e.value;s!=r&&(e.parentElement.dataset.path=s,await Ce.getStandardHandler()[n?"renameDirectory":"renameFile"](r,s),this.refreshDirectory(a),e.value.length>32&&(e.value=e.value.slice(0,32)+"..."))})}async refreshDirectory(e){const t=this.viewElement.querySelector(".dir-selector");if(!t)return;let n=t.querySelector("div[data-path='"+this.escapeSelector(e)+"']")?.nextSibling;if(e==""&&(n=t),!n)return;const r=Array.from(n.parentElement.querySelectorAll(".folder:not(.collapsed)")).map(a=>a.children[0].dataset.path);await this.createDiv(e).then(a=>n.replaceChildren(...a)),await Promise.all(r.map(a=>this.expand(t.querySelector("div[data-path='"+this.escapeSelector(a)+"']"))))}getElement(e){const t=this.viewElement.querySelector(".dir-selector");return t?t.querySelector("div[data-path='"+this.escapeSelector(e)+"']"):null}async getAcceptableFile(e){const t=await Ce.getStandardHandler().getDirectoryHandle(e);if(!t)return;const n=[{path:e,handle:t}];for(;n.length>0;){const r=n.shift(),a=r.handle;for await(const s of a.values()){const o=r.path==""?"":r.path+"/";if(s.kind=="directory")n.push({path:o+s.name,handle:s});else if(this.acceptableFileType(s.name))return o+s.name}}}async selectPath(e){if(!e)return;const t=this.viewElement.querySelector(".dir-selector");if(!t)return;const n=e.split("/");n.pop();const r=[];for(;n.length>0;){r.push(n.shift());const s=t.querySelector("div[data-path='"+this.escapeSelector(r.join("/"))+"']");if(!s)return;await this.expand(s)}const a=t.querySelector("div[data-path='"+this.escapeSelector(e)+"']");a&&this.selectElement(a)}handleKeyEvent(e){if(!this.windowElement.classList.contains("focused"))return;const t=this.viewElement.querySelector(".info.selected");if(t==null){if(e.code.startsWith("Arrow")){const n=this.viewElement.querySelector(".info");n&&this.selectElement(n)}return}if(e.code=="ArrowUp"){e.preventDefault(),e.stopImmediatePropagation();const n=t.parentElement;let r=n.previousSibling?.querySelector(".info");r&&!r.parentElement.classList.contains("collapsed")&&r.parentElement.classList.contains("folder")&&(r=r.parentElement.querySelector(".children").lastChild.querySelector(".info")),!r&&n.parentElement.classList.contains("children")&&(r=n.parentElement.parentElement.querySelector(".info")),r&&(this.selectElement(r),$n(r,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}if(e.code=="ArrowDown"){e.preventDefault(),e.stopImmediatePropagation();const n=t.parentElement;let r;n.classList.contains("folder")&&!n.classList.contains("collapsed")&&(r=n.querySelector(".children").children[0].querySelector(".info")),r||(r=t.parentElement.nextSibling?.querySelector(".info")),!r&&n.parentElement.classList.contains("children")&&(r=n.parentElement.parentElement.nextSibling.querySelector(".info")),r&&(this.selectElement(r),$n(r,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}if(e.code=="ArrowLeft"&&(e.preventDefault(),e.stopImmediatePropagation(),this.collapse(t)),e.code=="ArrowRight"&&(e.preventDefault(),e.stopImmediatePropagation(),this.expand(t)),e.code=="Enter"&&(e.preventDefault(),e.stopImmediatePropagation(),t.parentElement?.querySelector(".title")&&this.startEditing(t.parentElement?.querySelector(".title"))),e.code=="Delete"||e.code=="Backspace"){const n=this.viewElement.querySelector(".info.selected"),r=n?.dataset.path;if(!r)return;const a=n.parentElement.classList.contains("folder");Ce.getStandardHandler()[a?"removeDirectory":"removeFile"](r).then(()=>{const s=this.getElement(r);s&&(s.parentElement?.remove(),this.viewElement.querySelector(".delete").disabled=!0,this.viewElement.querySelector(".rename").disabled=!0)})}}startDragging(e){const t=e;t.totalMovementX=0,t.totalMovementY=0,this.draggedElement=t;const n=()=>{this.stopDragging(),window.removeEventListener("mouseup",n)};window.addEventListener("mouseup",n)}handleDragEvent(e){if(this.draggedElement){if(this.draggedElement.totalMovementX+=e.movementX,this.draggedElement.totalMovementY+=e.movementY,!this.draggedCopy)if(Math.abs(this.draggedElement.totalMovementX)+Math.abs(this.draggedElement.totalMovementY)>8){this.viewElement.addEventListener("mousemove",this.mouseHandler),this.draggedCopy=this.draggedElement.parentElement.cloneNode(!0),this.draggedCopy.style.position="fixed";const t=this.draggedElement.getBoundingClientRect();this.draggedCopy.style.top=t.top+this.draggedElement.totalMovementY+"px",this.draggedCopy.style.left=t.left+this.draggedElement.totalMovementX+"px",this.draggedCopy.style.width=t.width+"px",this.draggedCopy.style.boxShadow="3px 3px 3px #222",this.draggedCopy.querySelector(".children")&&this.draggedCopy.removeChild(this.draggedCopy.querySelector(".children")),this.viewElement.appendChild(this.draggedCopy)}else return;this.draggedCopy.style.top=parseFloat(this.draggedCopy.style.top.slice(0,-2))+e.movementY+"px",this.draggedCopy.style.left=parseFloat(this.draggedCopy.style.left.slice(0,-2))+e.movementX+"px"}}async stopDragging(){if(this.draggedCopy){this.draggedCopy.remove(),this.viewElement.removeEventListener("mousemove",this.mouseHandler);const e=this.draggedCopy.classList.contains("folder"),t=this.draggedElement.dataset.path,n=this.fileDropPath==""?Lt(this.draggedElement.dataset.path):this.fileDropPath+"/"+Lt(this.draggedElement.dataset.path);t!=n&&await Ce.getStandardHandler()[e?"renameDirectory":"renameFile"](t,n),await this.refreshDirectory(ot(t)),await this.refreshDirectory(ot(n)),this.viewElement.querySelector(".outlined")?.classList.remove("outlined"),this.fileDropPath=""}this.draggedCopy=void 0,this.draggedElement=void 0}handleDropEvent(e){e.preventDefault(),e.stopImmediatePropagation(),this.viewElement.querySelector(".outlined")?.classList.remove("outlined"),e.target.closest(".dir-selector")&&Ce.getStandardHandler().handleDropEvent(e,this.fileDropPath).then(async t=>{await this.refreshDirectory(this.fileDropPath),this.getAcceptableFile(t??this.fileDropPath).then(n=>this.selectPath(n)),this.fileDropPath=""})}handleMouseEvent(e){const t=this.viewElement.querySelector(".dir-selector");let n=Array.from(t.querySelectorAll("div.item.folder"));const r=this.viewElement.querySelector(".outlined");n=n.filter(a=>!a.parentElement.closest(".collapsed")),n.reverse(),n.push(t);for(const a of n){const s=a.getBoundingClientRect();if(e.clientX>=s.x&&e.clientX<=s.x+s.width&&e.clientY>=s.y&&e.clientY<=s.y+s.height){r!=a&&r?.classList.remove("outlined");const o=a.querySelector(".info");this.fileDropPath=o?.dataset.path??"",a.classList.contains("dir-selector")&&(this.fileDropPath=""),a.classList.add("outlined");return}}this.viewElement.querySelector(".outlined")?.classList.remove("outlined"),this.fileDropPath=""}escapeSelector(e){return e.replaceAll(/'/g,"\\'")}}function ju(){const i=document.createElement("div");return i.spellcheck=!1,i.contentEditable="true",i.classList.add("inlineEdit"),i.onkeydown=e=>{e.key=="Enter"&&i.blur()},i}function wr(i,e){return{title:i,element:t=>{const n=ju();return n.onblur=()=>{const r=n.innerText,a=t[e];Dt.instance.run({action:()=>{t[e]=r,n.innerText=r},undo:()=>{t[e]=a,n.innerText=a}}),n.scrollLeft=0},n.innerText=t[e],n}}}const cm={name:wr("Name","chartName"),credit:wr("Artist","credit"),style:wr("Style","chartStyle"),description:wr("Description","description"),music:{title:"Music File",element:(i,e)=>{const t=document.createElement("div");t.classList.add("flex-row","flex-column-gap","flex-static","hide-buttons");const n=()=>{if(r.innerText==(i.music??e.chartManager.loadedSM.properties.MUSIC??""))return;const u=e.chartManager.chartAudio.isPlaying();if(r.innerText==""||r.innerText==e.chartManager.loadedSM.properties.MUSIC){i.music=void 0,r.innerText=e.chartManager.loadedSM.properties.MUSIC+"",e.chartManager.loadAudio(),u&&e.chartManager.chartAudio.play();return}const f=r.innerText==e.chartManager.loadedSM.properties.MUSIC?void 0:r.innerText,c=i.music;Dt.instance.run({action:()=>{i.music=f,r.innerText=f??e.chartManager.loadedSM.properties.MUSIC??"",e.chartManager.loadAudio(),u&&e.chartManager.chartAudio.play()},undo:()=>{i.music=c,r.innerText=c??e.chartManager.loadedSM.properties.MUSIC??"",e.chartManager.loadAudio(),u&&e.chartManager.chartAudio.play()}})},r=ju();r.style.flex="1",r.onblur=n,r.innerText=i.music??e.chartManager.loadedSM.properties.MUSIC??"";const a=document.createElement("button");a.onclick=()=>{const u=ot(e.chartManager.smPath);if(window.nw){const f=document.createElement("input");f.type="file",f.accept="audio/*",f.onchange=()=>{r.innerText=Ce.getRelativePath(u,f.value),n()},f.click()}else e.windowManager.openWindow(new oa(e,{title:"Select an audio file...",accepted_file_types:ea,disableClose:!0,callback:f=>{r.innerText=Ce.getRelativePath(u,f),n()}},u+"/"+(i.music??e.chartManager.loadedSM.properties.MUSIC??"")))};const s=be.getIcon("FOLDER",12);a.appendChild(s);const o=document.createElement("button");o.onclick=()=>{r.innerText!=(e.chartManager.loadedSM.properties.MUSIC??"")&&(r.innerText=e.chartManager.loadedSM.properties.MUSIC??"",n())};const l=be.getIcon("REVERT",12);return o.appendChild(l),t.appendChild(r),t.appendChild(a),t.appendChild(o),t}}};class vn extends ht{app;buttonOptions;message;detail;resolve;resolved=new Promise(e=>this.resolve=e);constructor(e,t,n,r,a){super({title:t,width:300,disableClose:!0,win_id:"confirm",blocking:!0}),this.app=e,this.message=n,this.detail=a,this.buttonOptions=r,this.initView()}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("confirmation");const e=document.createElement("div");e.classList.add("padding"),e.style.gap="0.3rem";const t=document.createElement("div");if(t.classList.add("label"),t.innerText=this.message,e.appendChild(t),this.detail){const r=document.createElement("div");r.classList.add("secondary"),r.innerText=this.detail,e.appendChild(r)}const n=document.createElement("div");n.classList.add("menu-options"),this.buttonOptions.forEach(r=>{const a=document.createElement("button");a.innerText=r.label,a.onclick=()=>{r.callback?.(),this.resolve?.(r.label),this.closeWindow()},r.type!="default"&&a.classList.add(r.type),n.append(a)}),e.appendChild(n),this.viewElement.appendChild(e)}}class $u extends ht{app;gameType;chartList;chartInfo;gameTypeDropdown;currentChart;smLoadHandler=()=>{this.gameTypeDropdown.setItems(wt.getPriority().map(e=>{const t=this.getCharts(e);return e.id+" ("+t.length+")"})),this.gameTypeDropdown.setSelected(this.gameType.id+" ("+this.getCharts(this.gameType).length+") "),this.gameType=this.app.chartManager.loadedChart?.gameType??this.gameType,this.loadCharts()};chartModifiedHandler=()=>{this.app.chartManager.loadedChart==this.currentChart&&this.loadChartDetails(this.app.chartManager.loadedChart)};constructor(e,t){super({title:"Chart List",width:500,height:400,win_id:"chart_list"}),this.app=e,this.gameType=t??e.chartManager.loadedChart?.gameType??wt.getPriority()[0],this.initView(),ee.on("smLoadedAfter",this.smLoadHandler),ee.on("chartModified",this.chartModifiedHandler),ee.on("parityModified",this.chartModifiedHandler)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("chart-view-type-wrapper");const n=document.createElement("div");n.classList.add("chart-view-type-label"),n.innerText="Game Type:",this.gameTypeDropdown=gi.create(wt.getPriority().map(a=>{const s=this.app.chartManager.loadedSM?.getChartsByGameType(a.id)??[];return a.id+" ("+s.length+")"}),this.gameType.id+" ("+(this.app.chartManager.loadedSM?.getChartsByGameType(this.gameType.id)??[]).length+") "),this.gameTypeDropdown.onChange(a=>{this.gameType=wt.getGameType(a.split(" ")[0])??this.gameType,this.loadCharts()}),t.appendChild(n),t.appendChild(this.gameTypeDropdown.view);const r=document.createElement("div");r.classList.add("chart-view-scroller"),e.appendChild(t),e.appendChild(r),this.chartList=document.createElement("div"),this.chartList.classList.add("chart-list"),this.chartInfo=document.createElement("div"),this.chartInfo.classList.add("chart-info"),r.appendChild(this.chartList),r.appendChild(this.chartInfo),this.viewElement.appendChild(e),this.loadCharts()}onClose(){ee.off("smLoadedAfter",this.smLoadHandler),ee.off("chartModified",this.chartModifiedHandler),ee.off("parityModified",this.chartModifiedHandler)}loadCharts(){const e=this.getCharts(this.gameType),t=[];this.gameTypeDropdown.setItems(wt.getPriority().map(s=>{const o=this.getCharts(s);return s.id+" ("+o.length+")"})),this.gameTypeDropdown.setSelected(this.gameType.id+" ("+this.getCharts(this.gameType).length+") "),e.forEach(s=>{const o=document.createElement("div");o.classList.add("chart-list-item"),o.chart=s,this.app.chartManager.loadedChart==s&&o.classList.add("selected"),o.onclick=()=>{o.chart!=this.app.chartManager.loadedChart&&(this.app.chartManager.loadChart(o.chart),this.chartList.querySelectorAll(".selected").forEach(d=>d.classList.remove("selected")),o.classList.add("selected"))},o.onmouseenter=()=>{this.loadChartDetails(o.chart)},o.onmouseleave=()=>{this.loadChartDetails()};const l=document.createElement("div");l.innerText=s.meter+"",l.classList.add("title",s.difficulty);const u=document.createElement("div");u.classList.add("chart-list-info");const f=document.createElement("div");f.innerText=s.credit,f.classList.add("title","chart-credit");const c=document.createElement("div");c.innerText=s.getNotedata().length+"",c.classList.add("title","chart-step-count"),u.appendChild(f),u.appendChild(c),o.appendChild(l),o.appendChild(u),t.push(o)});const n=document.createElement("div");n.classList.add("chart-list-item");const r=document.createElement("div");r.innerText="+",r.classList.add("title");const a=document.createElement("div");a.classList.add("chart-list-info"),a.innerText="New Blank Chart",n.appendChild(r),n.appendChild(a),n.onclick=()=>{const s=new fd(this.app.chartManager.loadedSM);s.gameType=this.gameType,this.app.chartManager.loadedSM.addChart(s),this.app.chartManager.loadChart(s),this.loadCharts()},this.chartList.replaceChildren(...t,n),this.loadChartDetails()}loadChartDetails(e){if(e=e??this.app.chartManager.loadedChart,e?.gameType.id!=this.gameType.id){this.chartInfo.replaceChildren();return}if(!e)return;this.currentChart=e;const t=document.createElement("div");t.classList.add("chart-info-scroller");const n=()=>this.getCharts(e.gameType).sort((y,x)=>Sn.indexOf(y.difficulty)==Sn.indexOf(x.difficulty)?y.meter-x.meter:Sn.indexOf(y.difficulty)-Sn.indexOf(x.difficulty)),r=document.createElement("div");r.classList.add("chart-info-main");const a=gi.create(Sn,e.difficulty);a.view.classList.add("no-border","white"),a.onChange(y=>{const x=e.difficulty;Dt.instance.run({action:()=>{e.difficulty=y,n(),this.loadCharts()},undo:()=>{e.difficulty=x,n(),this.loadCharts()}})});const s=document.createElement("div");s.spellcheck=!1,s.contentEditable="true",s.classList.add("inlineEdit","chart-meter"),s.onkeydown=y=>{y.key=="Enter"&&s.blur()},s.onblur=()=>{let y=Yn(s.innerText);if(y===null){s.innerText=e?.meter+"";return}y=Math.round(Se(1,y,2**31-1));const x=e.meter;Dt.instance.run({action:()=>{e.meter=y,e.meterF=y,n(),this.loadCharts()},undo:()=>{e.meter=x,e.meterF=x,n(),this.loadCharts()}}),s.scrollLeft=0},s.innerText=e.meter+"";const o=document.createElement("div");o.classList.add("chart-properties"),r.appendChild(a.view),r.appendChild(s),Object.values(cm).forEach(y=>{const x=document.createElement("div");x.classList.add("label"),x.innerText=y.title;const w=y.element(e,this.app);y.title=="Artist"&&w.addEventListener("blur",()=>this.loadCharts()),o.appendChild(x),o.appendChild(w)});const l=e.stats.noteCounts,u=document.createElement("div");u.classList.add("chart-info-grid-item");const f=document.createElement("div");f.innerText="Peak NPS",f.classList.add("title","chart-info-grid-label");const c=document.createElement("div");c.innerText=e.stats.getMaxNPS().toFixed(2)+"",c.classList.add("title","chart-info-grid-count"),u.appendChild(f),u.appendChild(c);const d=document.createElement("div");d.classList.add("chart-info-grid"),Object.entries(l).forEach(y=>{const x=document.createElement("div");x.classList.add("chart-info-grid-item");const w=document.createElement("div");w.innerText=y[0],w.classList.add("title","chart-info-grid-label");const _=document.createElement("div");_.innerText=y[1]+"",_.classList.add("title","chart-info-grid-count"),x.appendChild(w),x.appendChild(_),d.appendChild(x)});const h=document.createElement("div");if(h.classList.add("chart-info-grid"),h.style.marginTop="1rem",e.stats.parity)for(let y=0;y<e.stats.parity.techCounts.length;y++){const x=document.createElement("div");x.classList.add("chart-info-grid-item");const w=document.createElement("div");w.innerText=Nc[y],w.classList.add("title","chart-info-grid-label");const _=document.createElement("div");_.innerText=(e.stats.parity.techCounts[y]??0)+"",_.classList.add("title","chart-info-grid-count"),x.appendChild(w),x.appendChild(_),h.appendChild(x)}else h.style.display="none";const p=document.createElement("div");p.classList.add("menu-options");const m=document.createElement("button");m.innerText="Duplicate Chart",m.onclick=()=>{const y=Object.assign(Object.create(Object.getPrototypeOf(e)),e);y.setNotedata(e.getNotedata().map(x=>e.computeNote(x))??[]),this.app.chartManager.loadedSM.addChart(y),this.app.chartManager.loadChart(y),this.loadCharts()},p.append(m);const g=document.createElement("button");g.innerText="Delete Chart",g.onclick=()=>{this.app.windowManager.openWindow(new vn(this.app,"Delete chart","Are you sure you want to delete this chart?",[{type:"default",label:"Cancel"},{type:"delete",label:"Delete",callback:()=>{this.app.chartManager.loadedSM.removeChart(e)&&(this.app.chartManager.loadChart(),this.gameType=this.app.chartManager.loadedChart?.gameType??this.gameType,this.loadCharts())}}]))},g.classList.add("delete"),p.append(g),t.addEventListener("wheel",()=>{p.classList.toggle("bottom",t.clientHeight+t.scrollTop<t.scrollHeight-10),t.classList.toggle("top",t.scrollTop>10)},{passive:!0}),requestAnimationFrame(()=>p.classList.toggle("bottom",t.clientHeight+t.scrollTop<t.scrollHeight-10)),t.replaceChildren(r,o,u,d,h),this.chartInfo.replaceChildren(t,p)}getCharts(e){return this.app.chartManager.loadedSM?.getChartsByGameType(e.id)??[]}}var vs,pc;function um(){if(pc)return vs;pc=1;var i=4,e=.001,t=1e-7,n=10,r=11,a=1/(r-1),s=typeof Float32Array=="function";function o(m,g){return 1-3*g+3*m}function l(m,g){return 3*g-6*m}function u(m){return 3*m}function f(m,g,y){return((o(g,y)*m+l(g,y))*m+u(g))*m}function c(m,g,y){return 3*o(g,y)*m*m+2*l(g,y)*m+u(g)}function d(m,g,y,x,w){var _,C,F=0;do C=g+(y-g)/2,_=f(C,x,w)-m,_>0?y=C:g=C;while(Math.abs(_)>t&&++F<n);return C}function h(m,g,y,x){for(var w=0;w<i;++w){var _=c(g,y,x);if(_===0)return g;var C=f(g,y,x)-m;g-=C/_}return g}function p(m){return m}return vs=function(g,y,x,w){if(!(0<=g&&g<=1&&0<=x&&x<=1))throw new Error("bezier x values must be in [0, 1] range");if(g===y&&x===w)return p;for(var _=s?new Float32Array(r):new Array(r),C=0;C<r;++C)_[C]=f(C*a,g,x);function F(T){for(var R=0,N=1,j=r-1;N!==j&&_[N]<=T;++N)R+=a;--N;var ae=(T-_[N])/(_[N+1]-_[N]),L=R+ae*a,O=c(L,g,x);return O>=e?h(T,L,g,x):O===0?L:d(T,R,R+a,g,x)}return function(R){return R===0?0:R===1?1:f(F(R),y,w)}},vs}var dm=um();const mt=or(dm),hm=mt(0,0,1,1);function mc(i,e){const t=e?e.split("."):[];for(;t.length&&i;){const n=t.shift(),r=new RegExp("(.+)\\[([0-9]*)\\]").exec(n);if(r!==null&&r.length==3){const a={arrName:r[1],arrIndex:r[2]};i[a.arrName]!==void 0?i=i[a.arrName][a.arrIndex]:i=void 0;continue}i=i[n]}return i}function fm(i,e,t){const n=e?e.split("."):[];for(;n.length&&i;){const r=n.shift(),a=new RegExp("(.+)\\[([0-9]*)\\]").exec(r);if(a!==null&&a.length==3){const s={arrName:a[1],arrIndex:a[2]};i[s.arrName]!==void 0&&n.length===0&&(i[s.arrName][s.arrIndex]=t);continue}i[r]===void 0&&(i[r]={}),n.length===0&&(i[r]=t),i=i[r]}return i}class lt{static animations=new Map;static _id=0;static{xt.shared.add(e=>{for(const[t,n]of this.animations.entries())n.obj._destroyed?this.stop(t):(n.progress=Math.min(1,n.progress+n.seconds*e),this.updateObject(n.obj,n.animation,n.curve(n.progress)),n.progress>=1&&(n.onend(n.obj),this.stop(t,1)))})}static updateObject(e,t,n){const r=Object.keys(t).sort((o,l)=>parseFloat(o)-parseFloat(l));let a="0";for(let o=r.length-2;o>=0;o--)if(parseFloat(r[o])<=n){a=r[o];break}let s="1";for(let o=1;o<r.length;o++)if(parseFloat(r[o])>n){s=r[o];break}Object.keys(t[0]).forEach(o=>{let l=t[a][o],u=t[s][o];l==="inherit"&&(t[a][o]=mc(e,o),l=t[a][o]),u==="inherit"&&(t[s][o]=mc(e,o),u=t[s][o]);const f=l+(n-parseFloat(a))/(parseFloat(s)-parseFloat(a))*(u-l);fm(e,o,f)})}static stop(e,t=null){e!==void 0&&(t!==null&&this.animations.get(e)?.obj&&!this.animations.get(e).obj.destroyed&&this.updateObject(this.animations.get(e).obj,this.animations.get(e).animation,t),this.animations.delete(e))}static finish(e){e!==void 0&&this.stop(e,1)}static animate(e,t,n,r,a=()=>{},s){return s||=`${++this._id}`,this.animations.set(s,{obj:e,animation:t,seconds:1/(60*n),progress:0,curve:r!==void 0?r:hm,onend:a}),this.updateObject(e,t,0),s}}const xs=[{frequency:20,Q:.71},{frequency:75,gain:0},{frequency:100,gain:0,Q:.6},{frequency:250,gain:0,Q:.3},{frequency:1040,gain:0,Q:.41},{frequency:2500,gain:0,Q:.2},{frequency:7500,gain:0},{frequency:2e4,Q:.71}],gc=[{freq:20,label:"20"},{freq:30,label:"30"},{freq:40,label:"40"},{freq:50,label:"50"},{freq:60,label:"60"},{freq:70,label:""},{freq:80,label:"80"},{freq:90,label:""},{freq:100,label:"100"},{freq:200,label:"200"},{freq:300,label:"300"},{freq:400,label:"400"},{freq:500,label:"500"},{freq:600,label:"600"},{freq:700,label:""},{freq:800,label:"800"},{freq:900,label:""},{freq:1e3,label:"1k"},{freq:2e3,label:"2k"},{freq:3e3,label:"3k"},{freq:4e3,label:"4k"},{freq:5e3,label:"5k"},{freq:6e3,label:"6k"},{freq:7e3,label:""},{freq:8e3,label:"8k"},{freq:9e3,label:""},{freq:1e4,label:"10k"},{freq:15e3,label:""},{freq:2e4,label:"20k"}],pn=0,mn=0,en=1200,yt=400,Ur=new Array(en).fill(0).map((i,e)=>Mo(e)),pm=new Float32Array(Ur);function Wr(i){return Math.log(i/20)/Math.log(1102.5)*en}function Mo(i){return Math.pow(1102.5,i/en)*20}function Xi(i){return-i*6+yt/2}function bc(i){return-(i-yt/2)/6}class mm extends ht{app;cachedReponse=new Array(en).fill(0);onAudioLoad=this.onAudio.bind(this);onThemeChange=this.changeHTMLColors.bind(this);points=[];icons;info;trackedFilter=null;constructor(e){super({title:"Audio Equalizer",width:600,height:245,win_id:"audio-eq"}),this.app=e,this.initView(),this.onAudioLoad(),ee.on("audioLoaded",this.onAudioLoad),ee.on("themeChanged",this.onThemeChange)}destroy(){ee.off("audioLoaded",this.onAudioLoad),ee.off("themeChanged",this.onThemeChange)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("eq-container");const t=document.createElement("div");t.classList.add("icon-container"),this.app.chartManager.chartAudio.getFilters().forEach((w,_)=>{const C=be.getIcon(w.type.toUpperCase(),36,24,Ki[_]);C.classList.add("eq-icon"),C.style.backgroundColor=`${Ki[_]}40`,C.onclick=()=>{this.app.chartManager.chartAudio.getFilter(_).enabled?this.app.chartManager.chartAudio.disableFilter(_):this.app.chartManager.chartAudio.enableFilter(_),this.endTrack(),this.updateIcons()},C.onmouseenter=()=>this.points[_].highlight(),C.onmouseleave=()=>this.points[_].unhighlight(),t.appendChild(C)}),this.icons=t,this.updateIcons();const n=document.createElement("canvas");n.style.width="37.5rem",n.style.height="12.5rem",n.onmousedown=w=>{const _=this.points.filter(C=>C.hitTest(w.offsetX*2/b.general.uiScale,w.offsetY*2/b.general.uiScale)).at(-1);this.endTrack(),_?.mouseDown(w)};const r=document.createElement("div");r.classList.add("eq-info-container");const a=document.createElement("div");a.classList.add("eq-info");const s=document.createElement("div");s.innerText="Type",s.classList.add("eq-info-label");const o=document.createElement("div");o.classList.add("eq-info-value"),a.replaceChildren(s,o);const l=document.createElement("div");l.classList.add("eq-info");const u=document.createElement("div");u.innerText="Frequency",u.classList.add("eq-info-label");const f=document.createElement("div");f.contentEditable="false",f.classList.add("eq-info-value","inlineEdit"),l.replaceChildren(u,f),this.setupInput(f,"frequency",20,22050," Hz");const c=document.createElement("div");c.classList.add("eq-info");const d=document.createElement("div");d.innerText="Gain",d.classList.add("eq-info-label");const h=document.createElement("div");h.contentEditable="false",h.classList.add("eq-info-value","inlineEdit"),c.replaceChildren(d,h),this.setupInput(h,"gain",-24,24," dB",1);const p=document.createElement("div");p.classList.add("eq-info");const m=document.createElement("div");m.innerText="Q",m.classList.add("eq-info-label");const g=document.createElement("div");g.contentEditable="false",g.classList.add("eq-info-value","inlineEdit"),p.replaceChildren(m,g),this.setupInput(g,"Q",1e-4,1e3,"",4);const y=document.createElement("div");y.classList.add("eq-reset","disabled"),y.innerText="Reset",y.onclick=()=>{if(this.trackedFilter==null)for(let w=0;w<xs.length;w++)this.app.chartManager.chartAudio.updateFilter(w,xs[w]),this.app.chartManager.chartAudio.disableFilter(w),this.updateIcons(),this.points[w].refreshPoint();else this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,xs[this.trackedFilter]),this.app.chartManager.chartAudio.disableFilter(this.trackedFilter),this.updateIcons(),this.points[this.trackedFilter].refreshPoint(),this.trackFilter(this.trackedFilter)},r.replaceChildren(a,l,c,p,y),this.info=r,e.replaceChildren(t,n,r),this.viewElement.appendChild(e);const x=this.drawEQ(n);requestAnimationFrame(x),this.changeHTMLColors()}selectText(e){const t=window.getSelection(),n=document.createRange();!t||!n||n.selectNodeContents(e)}setupInput(e,t,n,r,a="",s=0){let o=0;e.onfocus=()=>{o=this.app.chartManager.chartAudio.getFilter(this.trackedFilter)[t].value,e.innerText=fe(o,s)+"",this.selectText(e)},e.onkeydown=l=>{if(l.key=="Enter"){e.blur();return}if(l.key=="Tab"){const f=[...e.parentElement.parentElement.children],c=f.indexOf(e.parentElement);for(let d=1;d<f.length;d++){const p=f[(d+c)%f.length].children[1];if(p.contentEditable==="true"){p.focus();break}}return}if(l.key=="Escape"){e.innerText=o+a,this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,{gain:Se(o,n,r)}),this.points[this.trackedFilter].refreshPoint(),this.getResponse(),e.blur();return}setTimeout(()=>{const u=Yn(e.innerText);u!==null&&(this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,{[t]:Se(u,n,r)}),this.points[this.trackedFilter].refreshPoint(),this.getResponse())})},e.onblur=()=>{Yn(e.innerText)===null&&(this.app.chartManager.chartAudio.updateFilter(this.trackedFilter,{[t]:Se(o,n,r)}),this.points[this.trackedFilter].refreshPoint(),this.getResponse()),e.innerText=fe(this.app.chartManager.chartAudio.getFilter(this.trackedFilter)[t].value,s)+a}}onAudio(){this.points=this.app.chartManager.chartAudio.getFilters().map((e,t)=>new gm(this,t)),this.getResponse(),this.updateIcons(),this.endTrack()}getResponse(){this.cachedReponse=this.app.chartManager.chartAudio.getFrequencyResponse(Ur)}drawEQ(e){const t=e.getContext("2d");t.canvas.width=1200,t.canvas.height=400;const n=()=>{if(!this.app.chartManager.chartAudio)return;const r=t.createRadialGradient(e.width/2,e.height/2,0,e.width/2,e.height/2,e.width/2);let a,s;const o=Fe.getColor("accent-color");Gs(Fe.getColor("primary-bg"))>.5?(a=new B("white"),s=new B("black")):(a=new B("black"),s=new B("white"));const l=Rt(o,a,.95);r.addColorStop(0,Rt(o,a,.9).toHexa()),r.addColorStop(1,l.toHexa()),t.fillStyle=r,t.fillRect(0,0,e.width,e.height),t.fillStyle=Rt(o,a,.2).toHex(),this.drawFrequencies(t,this.app.chartManager.chartAudio.getFrequencyData()),this.app.chartManager.chartAudio.hasFilters()&&(t.fillStyle=Rt(o,s,.2).toHex()+"50",this.drawFrequencies(t,this.app.chartManager.chartAudio.getFilteredFrequencyData())),t.fillStyle="rgba(200, 200, 200, 0.5)",this.drawResponse(t),t.fillStyle=Rt(o,s,.2).toHex()+"80",t.font="22px Assistant",this.drawGrid(t),this.points.forEach(u=>u.draw(t)),e.closest("#windows")&&requestAnimationFrame(n)};return n}drawFrequencies(e,t){for(let n=0;n<en;n++){const r=Mo(n)/this.app.chartManager.chartAudio.getSampleRate()*this.app.chartManager.chartAudio.getFFTSize(),a=t[Math.floor(r)]/255;e.fillRect(pn+n,mn+yt-a*yt,1,a*yt)}}drawResponse(e){for(let t=0;t<en;t++){const n=Math.log(this.cachedReponse[t])/.115241,r=Xi(n);e.fillRect(t+pn,Math.min(r,yt/2)+mn,1,Math.max(r,yt/2)-Math.min(r,yt/2))}}drawGrid(e){for(const t of gc)e.fillRect(pn+Wr(t.freq),mn,1,yt),e.fillText(t.label,pn+Wr(t.freq)-(t==gc.at(-1)?20:0),mn+yt/2);for(let t=-25;t<=25;t+=5){const n=mn+Xi(t);e.fillRect(0,n,1200,1),t!=0&&e.fillText(t+"",pn,n)}}changeHTMLColors(){let e;const t=Fe.getColor("accent-color");Gs(Fe.getColor("primary-bg"))>.5?e=new B("white"):e=new B("black");const n=Rt(t,e,.95),r=Rt(t,e,.5);this.icons.style.backgroundColor=n.toHexa(),this.icons.style.borderImageSource=`linear-gradient(to right, ${n.toHexa()}, ${r.toHexa()}, ${n.toHexa()})`,this.info.style.backgroundColor=n.toHexa(),this.info.style.borderImageSource=`linear-gradient(to right, ${n.toHexa()}, ${r.toHexa()}, ${n.toHexa()})`,this.info.style.color=t.toHexa()}updateIcons(){[...this.icons.children].forEach((e,t)=>{this.app.chartManager.chartAudio.getFilter(t).enabled?e.classList.remove("disabled"):e.classList.add("disabled")}),this.getResponse()}trackFilter(e){this.trackedFilter=e;const t=this.app.chartManager.chartAudio.getFilter(e),[n,r,a,s]=[...this.info.children].map(o=>o.children[1]);n.innerText=t.type,r.innerText=Math.round(t.frequency.value)+" Hz",a.innerText=t.type.endsWith("pass")?"-":fe(t.gain.value,1)+" dB",s.innerText=t.type.endsWith("shelf")?"-":fe(t.Q.value,2)+"",n.style.color=Ki[e],r.style.color=Ki[e],a.style.color=Ki[e],s.style.color=Ki[e],r.contentEditable="true",a.contentEditable=`${!t.type.endsWith("pass")}`,s.contentEditable=`${!t.type.endsWith("shelf")}`}endTrack(){setTimeout(()=>{this.trackedFilter=null,this.points.forEach(a=>a.unhighlight());const[e,t,n,r]=[...this.info.children].map(a=>a.children[1]);e.innerText="",t.innerText="",n.innerText="",r.innerText="",t.contentEditable="false",n.contentEditable="false",r.contentEditable="false"})}}const vr=16,Ki=["#a3001b","#a34f00","#d6d606","#19c402","#02c4ba","#022fc4","#5602c4","#c402b4"];class gm{filterIndex;window;dragging=!1;x=0;y=0;type;response=new Float32Array(Ur.length);_empty=new Float32Array(Ur.length);highlighted=!1;pointSize=.4;constructor(e,t){this.filterIndex=t,this.window=e,this.type=this.window.app.chartManager.chartAudio.getFilter(t).type,this.x=Wr(this.window.app.chartManager.chartAudio.getFilter(t).frequency.value??10),this.getY()}hitTest(e,t){return(e-this.x)*(e-this.x)+(t-this.y)*(t-this.y)<=vr*vr}canChangeGain(){return this.type=="lowshelf"||this.type=="highshelf"||this.type=="peaking"}canChangeQ(){return!this.type.endsWith("shelf")}getY(){this.type.endsWith("shelf")?this.y=Xi((this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).gain.value??0)/2):this.canChangeGain()?this.y=Xi(this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).gain.value??0):this.y=yt/2}getGain(){if(this.canChangeGain())return this.type.endsWith("shelf")?bc(this.y)*2:bc(this.y)}mouseDown(e){this.calcResponse(),this.dragging=!0,this.highlighted=!0,this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).enabled||(this.window.app.chartManager.chartAudio.enableFilter(this.filterIndex),this.window.updateIcons());const t=this.x,n=this.y,r=e.clientX,a=e.clientY,s=l=>{this.x=(l.clientX-r)*2+t,this.canChangeGain()?this.y=(l.clientY-a)*2+n:this.y=yt/2,this.x=Se(this.x,0,en),this.y=Se(this.y,this.type.endsWith("shelf")?yt/4:Xi(24),this.type.endsWith("shelf")?3*yt/4:Xi(-24)),this.window.app.chartManager.chartAudio.updateFilter(this.filterIndex,{frequency:Mo(this.x),gain:this.getGain()}),this.window.getResponse(),this.window.trackFilter(this.filterIndex),this.calcResponse()};this.window.trackFilter(this.filterIndex);const o=()=>{lt.animate(this,{0:{pointSize:"inherit"},1:{pointSize:.3}},.3,mt(.11,.71,.41,.86),()=>{},`eq-point${this.filterIndex}`),this.dragging=!1,window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",o)};lt.animate(this,{0:{pointSize:"inherit"},1:{pointSize:.9}},.3,mt(.11,.71,.41,.86),()=>{},`eq-point${this.filterIndex}`),window.addEventListener("mousemove",s),window.addEventListener("mouseup",o)}calcResponse(){this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).getFrequencyResponse(pm,this.response,this._empty)}draw(e){const t=this.highlighted||this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).enabled?Ki[this.filterIndex]:"#888888";if(e.fillStyle=t+"60",this.dragging)for(let n=0;n<this.response.length;n++){const r=Math.log(this.response[n])/.115241,a=Xi(r);e.fillRect(n+pn,Math.min(a,yt/2)+mn,1,Math.max(a,yt/2)-Math.min(a,yt/2))}e.fillStyle=t+"80",e.beginPath(),e.arc(this.x,this.y,vr,0,2*Math.PI),e.closePath(),e.fill(),e.beginPath(),e.arc(this.x,this.y,vr*this.pointSize,0,2*Math.PI),e.closePath(),e.fill()}refreshPoint(){this.x=Wr(this.window.app.chartManager.chartAudio.getFilter(this.filterIndex).frequency.value??10),this.getY()}highlight(){this.highlighted=!0}unhighlight(){this.highlighted=!1}}const Es={columnOneBased:{label:"1-indexed column numbers",tooltip:"Start counting column numbers from 0 instead of 1."},lengthAsNumberIndex:{label:"Store length in integer keys",tooltip:'Store the length of holds as the last item in each table, instead of using the "length" key.'},padNumbers:{label:"Pad numbers",tooltip:"Pad decimals with trailing zeros."},minify:{label:"Minify",tooltip:"Remove all newlines and spaces."},notitgNoteTypes:{label:"Use NotITG Note Types",tooltip:'Use NotITG note types. (Tap = 1, Hold = 2, Mine = "M")'}},yc={Tap:"1",Hold:"2",Roll:"4",Mine:'"M"',Lift:'"L"',Fake:'"F"'};class bm extends ht{app;selection;outputDiv;exportOptions={include:{Beat:!0,Second:!1,Column:!0,Type:!0,Quantization:!1,Length:!0},options:{columnOneBased:!1,lengthAsNumberIndex:!1,padNumbers:!1,minify:!1,notitgNoteTypes:!1}};constructor(e,t=[]){super({title:"Export Notedata",width:600,height:400,disableClose:!1,win_id:"export_notedata",blocking:!1}),this.app=e,t.length==0&&(t=this.app.chartManager.loadedChart.getNotedata()),this.selection=t,this.initView(),this.export()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("export-container");const n=document.createElement("div");n.classList.add("export-options");const r=document.createElement("pre");r.classList.add("export-output"),Ze(r,{content:"Click to copy to clipboard"}),Ze(r,{content:"Copied!",trigger:"click",onShow(o){o.setProps({trigger:"mouseenter"})},onHide(o){o.setProps({trigger:"click"})}}),r.addEventListener("click",()=>{navigator.clipboard.writeText(r.innerText)}),this.outputDiv=r;const a=document.createElement("div");a.classList.add("export-section-label"),a.innerText="Include",n.appendChild(a),Object.keys(this.exportOptions.include).forEach(o=>{const l=document.createElement("input");l.type="checkbox",l.id="en-i-"+o,l.checked=this.exportOptions.include[o],l.onchange=()=>{this.exportOptions.include[o]=l.checked,this.export()};const u=document.createElement("label");u.classList.add("export-label"),u.htmlFor=l.id,u.innerText=o;const f=document.createElement("div");f.replaceChildren(l,u),f.classList.add("export-option"),n.appendChild(f)});const s=document.createElement("div");s.classList.add("export-section-label"),s.innerText="Options",n.appendChild(s),Object.keys(this.exportOptions.options).forEach(o=>{const l=document.createElement("input");l.id="en-o-"+o,l.type="checkbox",l.checked=this.exportOptions.options[o],l.onchange=()=>{this.exportOptions.options[o]=l.checked,this.export()};const u=document.createElement("label");u.classList.add("export-label"),u.htmlFor=l.id,u.innerText=Es[o].label;const f=document.createElement("div");f.replaceChildren(l,u),f.classList.add("export-option"),n.appendChild(f),Es[o].tooltip!==void 0&&Ze(f,{content:Es[o].tooltip})}),t.replaceChildren(n,r),e.appendChild(t),this.viewElement.appendChild(e)}export(){let e=`{
`+this.selection.map(t=>{let n="	{";return this.exportOptions.include.Beat&&(n+=this.padNum(t.beat)+","),this.exportOptions.include.Second&&(n+=this.padNum(t.second)+","),this.exportOptions.include.Column&&(this.exportOptions.options.columnOneBased?n+=t.col+1+",":n+=t.col+","),this.exportOptions.include.Type&&(this.exportOptions.options.notitgNoteTypes&&yc[t.type]!==void 0?n+=yc[t.type]+",":n+='"'+t.type+'",'),this.exportOptions.include.Quantization&&(n+=t.quant+","),this.exportOptions.include.Length&&Oe(t)&&(this.exportOptions.options.lengthAsNumberIndex?n+=this.padNum(t.hold)+",":n+="length="+this.padNum(t.hold)+","),n.endsWith(",")&&(n=n.slice(0,-1)),n+="}",this.getNumIncludes()==1&&(n=n.replaceAll("{",""),n=n.replaceAll("}","")),n}).join(`,
`)+`
}`;this.exportOptions.options.minify&&(e=e.replaceAll(/\s/g,"")),this.outputDiv.innerText=e}getNumIncludes(){return Object.values(this.exportOptions.include).map(e=>+e).reduce((e,t)=>e+t,0)}padNum(e){return this.exportOptions.options.padNumbers?(Math.round(e*1e3)/1e3).toFixed(3):Math.round(e*1e3)/1e3}}class An extends ht{app;allowMods;callback;combo={mods:[],key:""};conflictCheck;listener;static active=!1;constructor(e,t,n,r){super({title:"",width:300,height:168,disableClose:!0,win_id:"keyComboSelector",blocking:!0}),this.app=e,this.allowMods=t,this.callback=n,this.conflictCheck=r??(()=>[]),this.initView(),An.active=!0}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("confirmation");const e=document.createElement("div");e.classList.add("padding"),e.style.gap="0.5rem";const t=document.createElement("div");t.classList.add("label"),t.innerText="Input a key combo and select Ok when finished.",e.appendChild(t);const n=document.createElement("input");n.type="text",n.disabled=!0,n.style.fontSize="1.25rem",n.style.height="1.5rem",n.style.flex="0",n.style.textAlign="center",e.appendChild(n);const r=document.createElement("div");r.classList.add("detail"),r.innerText="No conflicts",r.style.flex="1",e.appendChild(r);const a=document.createElement("div");a.classList.add("menu-options");const s=document.createElement("button");s.innerText="Ok",s.onclick=()=>{this.callback(this.combo),this.closeWindow()},s.classList.add("confirm"),s.disabled=!0;const o=document.createElement("button");o.innerText="Cancel",o.onclick=()=>{this.closeWindow()},a.append(o),a.append(s),e.appendChild(a),this.viewElement.appendChild(e),this.listener=l=>{if(["Meta","Control","Shift","Alt","Escape"].includes(l.key))return;if(this.combo.key=Ae.getKeyNameFromEvent(l),this.allowMods){const f=[];for(let c=0;c<Gr.length;c++)l[Gr[c]]&&f.push(Br[c]);this.combo.mods=f}n.value=Ae.getComboString(this.combo);const u=this.conflictCheck(this.combo);u=="self"?(r.innerText="Combo already binded for this keybind",s.disabled=!0):(s.disabled=!1,u.length>=3?r.innerText=`Conflicts with ${u.length} keybinds`:u.length>=1?r.innerText=`Conflicts with ${u.join(",")}`:r.innerText="No conflicts"),l.preventDefault()},window.addEventListener("keydown",this.listener,!0)}onClose(){window.removeEventListener("keydown",this.listener,!0),An.active=!1}}class ym extends ht{app;observer;conflictMap=this.calculateConflicts();constructor(e){super({title:"Gameplay Keybind Options",width:600,height:400,disableClose:!1,win_id:"gameplay_keybind_options",blocking:!1}),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-container");const n=document.createElement("div");n.classList.add("pref-scrollers");const r=document.createElement("div");r.classList.add("pref-section-scroller");const a=document.createElement("div");a.classList.add("pref-option-scroller"),n.replaceChildren(r,a),this.observer=new IntersectionObserver(s=>{s.forEach(o=>{const l=o.target.dataset.id,u=r.querySelector(`.pref-section[data-id=${l}]`);u&&(o.intersectionRatio>0?u.classList.add("selected"):u.classList.remove("selected"))})},{}),t.replaceChildren(n),r.replaceChildren(...this.createSections()),a.replaceChildren(...this.createOptions()),e.appendChild(t),this.viewElement.appendChild(e)}createSections(){return Object.keys(wt.getTypes()).map(e=>this.createEmptySection(e))}createOptions(){return Object.keys(wt.getTypes()).map(e=>{const t=new Array(wt.getTypes()[e].numCols).fill(null).map((a,s)=>this.createKeybindItem(e,s)),n=document.createElement("div");n.classList.add("pref-group"),n.dataset.id=e;const r=document.createElement("div");return r.classList.add("pref-group-label"),r.innerText=e,n.replaceChildren(r,...t),this.observer.observe(n),n})}createEmptySection(e){const t=document.createElement("div");return t.classList.add("pref-section"),t.dataset.id=e,t.innerText=e,t.onclick=()=>{t.parentElement.parentElement.querySelector(`.pref-group[data-id=${e}]`).scrollIntoView()},t}createKeybindItem(e,t){const n=document.createElement("div");n.classList.add("pref-keybind"),n.dataset.id=e+"-"+t,n.onclick=o=>{o.target.classList.contains("pref-keybind-combo")||n.querySelector(".icon")?.contains(o.target)||this.app.windowManager.openWindow(new An(this.app,!1,l=>{Ae.setGameplayKeybind(e,t,l.key),this.conflictMap=this.calculateConflicts(),n.replaceWith(this.createKeybindItem(e,t))},l=>{const u=this.conflictMap.get(e)?.get(l.key)?.map(f=>Bi[f[0]]?.[f[1]].label??"Column "+f[1])??[];return u.includes(Bi[e]?.[t].label??"Column "+t)?"self":u}))};const r=document.createElement("div");r.classList.add("pref-keybind-label"),r.innerText=Bi[e]?.[t].label??"Column "+t;const a=be.getIcon("REVERT");a.style.width="0.75rem",a.addEventListener("click",()=>{Ae.revertGameplayKeybind(e,t),this.conflictMap=this.calculateConflicts(),n.replaceWith(this.createKeybindItem(e,t))}),a.style.display=Ae.checkIsDefaultGameplay(e,t)?"none":"block";const s=document.createElement("div");return s.classList.add("pref-keybind-combos"),s.replaceChildren(...Ae.getKeysForGameType(e)[t].map(o=>{const l=document.createElement("button");return l.classList.add("pref-keybind-combo"),l.innerText=o,this.conflictMap.get(e).get(o).length>1&&l.classList.add("conflict"),l.onclick=()=>{Ae.removeGameplayKeybind(e,t,o),this.conflictMap=this.calculateConflicts(),n.replaceWith(this.createKeybindItem(e,t))},l})),n.replaceChildren(r,a,s),n}calculateConflicts(){const e=new Map;Object.keys(wt.getTypes()).forEach(t=>{const n=new Map;Ae.getKeysForGameType(t).forEach((r,a)=>{r.forEach((s,o)=>{n.has(s)||n.set(s,[]),n.get(s).push([t,a,o])})}),e.set(t,n)}),[...this.viewElement.querySelectorAll(".pref-keybind-combo.conflict")].forEach(t=>t.classList.remove("conflict"));for(const t of e.values())for(const n of t.values())n.length!=1&&n.forEach(r=>{const a=this.viewElement.querySelector(`.pref-keybind[data-id=${r[0]}-${r[1]}] .pref-keybind-combos`);a?.children[r[2]]&&a.children[r[2]].classList.add("conflict")});return e}onClose(){this.observer?.disconnect()}}class Yu{static _model;static async getModel(){return this._model||await this._load(),this._model}static async _load(){this._model=[];const e=localStorage.getItem("recentFiles");if(e){try{const t=JSON.parse(e);if(!Array.isArray(t))return;for(const n of t)typeof n!="object"||Array.isArray(n)||typeof n?.name!="string"||typeof n?.path!="string"||this._model.find(r=>r.path==n.path)||this._model.push({name:n.name,path:n.path})}catch{console.log("Failed to load recent file entries");return}await this.saveEntries()}}static async getRecents(){return await this.getModel()}static async addSM(e,t){const n=await this.getModel(),r=n.findIndex(a=>a.path==e);r!=-1&&n.splice(r,1),n.unshift({name:t.properties.TITLE??"Untitled Song",path:e}),this.saveEntries()}static async limitEntries(){(await this.getModel()).splice(15)}static async saveEntries(){this.limitEntries();const e=await Promise.all(this._model.map(t=>Ce.hasFile(t.path)));this._model=this._model.filter((t,n)=>e[n]),localStorage.setItem("recentFiles",JSON.stringify(this._model))}}const wm=`#TITLE:New Song;
#SUBTITLE:;
#ARTIST:;
#TITLETRANSLIT:;
#SUBTITLETRANSLIT:;
#ARTISTTRANSLIT:;
#GENRE:;
#CREDIT:;
#BANNER:;
#BACKGROUND:;
#LYRICSPATH:;
#CDTITLE:;
#MUSIC:;
#OFFSET:0;
#SAMPLESTART:0.000000;
#SAMPLELENGTH:10.000000;
#SELECTABLE:YES;
#BPMS:0.000=120.000;
#STOPS:;
#WARPS:;
#DELAYS:;
#SPEEDS:0.000=1.000=0.000=0;
#SCROLLS:0.000=1.000;
#TICKCOUNTS:;
#TIMESIGNATURES:0.000000=4=4;
#LABELS:;
#COMBOS:;
#BGCHANGES:;
#FGCHANGES:;
#KEYSOUNDS:;
#ATTACKS:;
`,Ku=[{title:"Metadata",items:[{title:"Title",propName:"TITLE",input:{type:"string"}},{title:"Subtitle",propName:"SUBTITLE",input:{type:"string"}},{title:"Artist",propName:"ARTIST",input:{type:"string"}},{title:"Credit",propName:"CREDIT",input:{type:"string"}},{title:"Genre",propName:"GENRE",input:{type:"string"}},{title:"Origin",propName:"ORIGIN",input:{type:"string"}}]},{title:"Resources",items:[{title:"Audio Track",propName:"MUSIC",input:{type:"file",typeName:"audio",accept:ea,onChange:i=>i.chartManager.loadAudio()}},{title:"Background Image",propName:"BACKGROUND",input:{type:"file",typeName:"image",accept:qi}},{title:"Banner Image",propName:"BANNER",input:{type:"file",typeName:"image",accept:qi}},{title:"CD Title",propName:"CDTITLE",input:{type:"file",typeName:"image",accept:qi}},{title:"CD Image",propName:"CDIMAGE",input:{type:"file",typeName:"image",accept:qi}},{title:"Jacket",propName:"JACKET",input:{type:"file",typeName:"image",accept:qi}},{title:"Disc Image",propName:"DISCIMAGE",input:{type:"file",typeName:"image",accept:qi}}]},{title:"Song",items:[{title:"Song Preview",propName:"SAMPLESTART",input:{type:"custom",create:(i,e,t)=>{const n=()=>{a.value<r.value&&(a.value=r.value);const l=e.properties.SAMPLESTART??"0",u=e.properties.SAMPLELENGTH??"10",f=r.value.toString(),c=(a.value-r.value).toString();t.run({action:()=>{e.properties.SAMPLESTART=f,e.properties.SAMPLELENGTH=c,r.value=parseFloat(f),a.value=parseFloat(f)+parseFloat(c)},undo:()=>{e.properties.SAMPLESTART=l,e.properties.SAMPLELENGTH=u,r.value=parseFloat(l),a.value=parseFloat(l)+parseFloat(u)}})},r=pt.create({value:parseFloat(e.properties.SAMPLESTART??"0"),precision:3,min:0});r.onchange=l=>{if(l===void 0){r.value=parseFloat(e.properties.SAMPLESTART??"0");return}n()};const a=pt.create({value:parseFloat(e.properties.SAMPLESTART??"0")+parseFloat(e.properties.SAMPLELENGTH??"10"),precision:3,min:0});a.onchange=l=>{if(l===void 0){a.value=parseFloat(e.properties.SAMPLESTART??"0")+parseFloat(e.properties.SAMPLELENGTH??"10");return}n()};const s=document.createElement("div"),o=document.createElement("div");return o.innerText="to",s.classList.add("flex-row","flex-column-gap"),s.replaceChildren(r.view,o,a.view),s}}}]}];function Xu(i,e,t,n){switch(n.input.type){case"custom":return n.input.create(i,e,t);case"string":{const r=document.createElement("input");return r.type="text",r.autocomplete="off",r.spellcheck=!1,r.onkeydown=a=>{a.key=="Enter"&&r.blur()},r.onblur=()=>{const a=e.properties[n.propName],s=r.value;t.run({action:()=>{e.properties[n.propName]=s,r.value=s},undo:()=>{e.properties[n.propName]=a,r.value=a??""}})},r.value=e.properties[n.propName]??"",r}case"number":{const r=n.input,a=pt.create({value:parseFloat(e.properties[n.propName]??"15"),...r});return a.onchange=s=>{if(s===void 0){a.value=parseFloat(e.properties[n.propName]??"0");return}const o=e.properties[n.propName],l=s.toString();t.run({action:()=>{e.properties[n.propName]=l,a.value=parseFloat(l)},undo:()=>{e.properties[n.propName]=o,a.value=parseFloat(o??"0")}})},a.view}case"file":{const r=n.input,a=n.input.onChange,s=document.createElement("div");s.classList.add("flex-row","flex-column-gap");const o=document.createElement("input");o.type="text",o.autocomplete="off",o.spellcheck=!1,o.placeholder="click to select a file",o.onclick=c=>{c.preventDefault(),o.blur();const d=ot(i.chartManager.smPath);if(window.nw){const h=document.createElement("input");h.type="file",h.accept=r.accept.join(","),h.nwworkingdir=d,h.onchange=()=>{const p=Ce.getRelativePath(d,h.value);f(p)},h.click()}else i.windowManager.openWindow(new oa(i,{title:`Select a${r.typeName.match(/^[aieouAIEOU].*/)?"n":""} ${r.typeName} file...`,accepted_file_types:r.accept,disableClose:!0,callback:h=>{const p=Ce.getRelativePath(d,h);f(p)}},e.properties[n.propName]?d+"/"+e.properties[n.propName]:i.chartManager.smPath))},o.value=e.properties[n.propName]??"",s.appendChild(o);const l=document.createElement("button");l.style.height="100%",l.classList.add("delete"),l.disabled=!e.properties[n.propName],l.onclick=()=>{f(void 0),l.disabled=!0};const u=be.getIcon("TRASH",12);l.appendChild(u),s.appendChild(l);const f=c=>{const d=e.properties[n.propName]??"";t.run({action:()=>{e.properties[n.propName]=c,o.value=c??"",l.disabled=o.value==""},undo:()=>{e.properties[n.propName]=d,o.value=d,l.disabled=o.value==""}}),a?.(i)};return s}}}class Zu extends ht{app;sm;history;fileTable={};constructor(e){super({title:"New Song",width:450,height:492,disableClose:!0,win_id:"sm_properties",blocking:!0});const t=new Blob([wm],{type:"text/plain"}),n=new File([t],"song.sm",{type:"text/plain"});this.sm=new Hc(n),this.history=new Dt(e),this.app=e,this.initView()}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("sm-properties");const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("label"),t.innerText="Apply to",Ku.forEach(l=>{const u=document.createElement("div");u.classList.add("sm-container");const f=document.createElement("div");f.classList.add("sm-title"),f.innerText=l.title;const c=document.createElement("div");c.classList.add("property-grid"),l.items.forEach(d=>{const h=document.createElement("div");h.classList.add("label"),h.innerText=d.title,c.appendChild(h),d.input.type=="file"?c.appendChild(this.createFileElement(d.propName,d.input.typeName)):c.appendChild(Xu(this.app,this.sm,this.history,d))}),u.appendChild(f),u.appendChild(c),e.appendChild(u)});const n=document.createElement("div");n.classList.add("menu-options");const r=document.createElement("div");r.classList.add("menu-left");const a=document.createElement("div");a.classList.add("menu-right"),n.appendChild(r),n.appendChild(a);const s=document.createElement("button");s.innerText="Cancel",s.onclick=()=>{this.closeWindow()};const o=document.createElement("button");o.innerText="Create",o.classList.add("confirm"),o.onclick=()=>{this.sm.properties.MUSIC===void 0||this.sm.properties.MUSIC===""?this.app.windowManager.openWindow(new vn(this.app,"No audio file uploaded","Are you sure you want to create a file with no audio?",[{type:"default",label:"No"},{type:"confirm",label:"Yes",callback:()=>{this.createSong(),this.closeWindow()}}])):(this.createSong(),this.closeWindow())},r.appendChild(s),a.appendChild(o),e.appendChild(n),this.viewElement.appendChild(e)}async createSong(){let e=this.sm.properties.TITLE;if(window.nw){const t=nw.require("path"),n=nw.require("process"),r=document.createElement("input");r.type="file",r.nwsaveas=e+".sm",r.onchange=async()=>{const a=t.basename(r.value,t.extname(r.value));e=t.dirname(r.value);const s=t.join(e,a+".sm");await Ce.writeFile(s,this.sm.serialize("sm")),await Promise.all(Object.entries(this.fileTable).map(o=>{const l=t.resolve(t.join(e,o[0])),u=t.resolve(o[1].path);if(!(n.platform=="win32"&&l.toLowerCase()===u.toLowerCase())&&l!==u)return Ce.writeFile(l,o[1])})),await this.app.chartManager.loadSM(s),this.app.windowManager?.getWindowById("select_sm_initial")?.closeWindow()},r.click()}else{if(await Ce.getDirectoryHandle(e)){let t=2;for(;await Ce.getDirectoryHandle(e);)e=`${this.sm.properties.TITLE} ${t++}`}await Ce.writeFile(e+"/song.sm",this.sm.serialize("sm")),await Promise.all(Object.entries(this.fileTable).map(t=>Ce.writeFile(e+`/${t[0]}`,t[1]))),await this.app.chartManager.loadSM(e+"/song.sm"),this.app.windowManager?.getWindowById("select_sm_initial")?.closeWindow()}}createFileElement(e,t){const n=document.createElement("div");n.classList.add("flex-row","flex-column-gap");const r=document.createElement("input");r.type="text",r.autocomplete="off",r.spellcheck=!1,r.placeholder="click to upload a file",r.readOnly=!0,r.onclick=o=>{o.preventDefault(),r.blur();const l=document.createElement("input");l.type="file",l.accept=t=="audio"?"audio/*":"image/*",l.onchange=()=>{const u=l.files?.[0];if(!u)return;this.sm.properties[e]&&this.fileTable[this.sm.properties[e]]&&delete this.fileTable[this.sm.properties[e]];let f=u.name;for(;this.fileTable[u.name]&&(this.fileTable[u.name].size!=u.size||this.fileTable[u.name].type!=u.type);)f="_"+f;this.fileTable[f]=u,r.value=f,this.sm.properties[e]=r.value,a.disabled=!1},l.click()},r.value=this.sm.properties[e]??"",n.appendChild(r);const a=document.createElement("button");a.style.height="100%",a.classList.add("delete"),a.disabled=!0,a.onclick=()=>{this.sm.properties[e]&&this.fileTable[this.sm.properties[e]]&&delete this.fileTable[this.sm.properties[e]],this.sm.properties[e]=void 0,r.value="",a.disabled=!0};const s=be.getIcon("TRASH",12);return a.appendChild(s),n.appendChild(a),n}}class Lo extends ht{app;keyHandler;constructor(e,t=!0){super({title:"Open a Song",width:400,height:320,disableClose:t,win_id:"select_sm_initial"}),this.app=e,this.keyHandler=this.handleKeyEvent.bind(this),window.addEventListener("keydown",this.keyHandler),this.initView(),ee.on("resize",()=>{this.center()})}onClose(){window.removeEventListener("keydown",this.keyHandler)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("open-container"),e.appendChild(t);const n=document.createElement("div");n.classList.add("top-container");const r=document.createElement("div");r.classList.add("separator"),r.style.margin="0.5rem";const a=document.createElement("div");a.classList.add("bottom-container"),t.appendChild(n),t.appendChild(r),t.appendChild(a);const s=document.createElement("button");s.style.display="flex",s.style.flexDirection="column",s.style.padding="0.5rem",s.style.backgroundColor="#414352",s.style.color="white",n.appendChild(s);const o=be.getIcon("UPLOAD",30);s.appendChild(o);const l=document.createElement("div");l.innerText=window.nw?"Open an existing song":"Import a song folder",s.appendChild(l),s.onclick=()=>{if(window.nw){const p=document.createElement("input");p.type="file",p.accept=".sm,.ssc",p.onchange=()=>{this.app.chartManager.loadSM(p.value),this.closeWindow()},p.click()}else this.app.windowManager.openWindow(new oa(this.app,{title:"Select an sm/ssc file...",accepted_file_types:[".sm",".ssc"],disableClose:!0,callback:p=>{this.app.chartManager.loadSM(p),this.closeWindow()}}))};const u=document.createElement("button");u.style.display="flex",u.style.flexDirection="column",u.style.padding="0.5rem",u.style.backgroundColor="#506352",u.style.color="white",n.appendChild(u);const f=be.getIcon("PLUS",30);u.appendChild(f);const c=document.createElement("div");c.innerText="New Song",u.appendChild(c),u.onclick=()=>{this.app.windowManager.openWindow(new Zu(this.app))};const d=document.createElement("div");d.innerText="Recently Opened",d.classList.add("title"),a.appendChild(d);const h=document.createElement("div");h.classList.add("recent-selector"),a.appendChild(h),Yu.getRecents().then(p=>p.forEach(m=>{const g=document.createElement("div");g.classList.add("recent-item");const y=document.createElement("div");y.classList.add("recent-name"),y.innerText=m.name;const x=document.createElement("div");x.classList.add("recent-path"),x.innerText=m.path,g.appendChild(y),g.appendChild(x),g.onclick=()=>{h.querySelectorAll(".selected").forEach(w=>w.classList.remove("selected")),g.classList.add("selected")},g.ondblclick=()=>{this.app.chartManager.loadSM(m.path),this.closeWindow()},h.appendChild(g)})),this.viewElement.appendChild(e)}handleKeyEvent(e){if(!this.windowElement.classList.contains("focused"))return;const t=this.viewElement.querySelector(".selected");if(t){if(e.code=="ArrowUp"){e.preventDefault(),e.stopImmediatePropagation();const n=t.previousElementSibling;n&&(t.parentElement.querySelectorAll(".selected").forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),$n(n,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}if(e.code=="ArrowDown"){e.preventDefault(),e.stopImmediatePropagation();const n=t.nextElementSibling;n&&(t.parentElement.querySelectorAll(".selected").forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),$n(n,{scrollMode:"if-needed",block:"nearest",inline:"nearest"}))}}}}const Qi={file:{type:"menu",title:"File",options:[{type:"selection",id:"newSong"},{type:"selection",id:"openSong"},{type:"selection",id:"newWindow"},{type:"separator"},{type:"selection",id:"previousSong"},{type:"selection",id:"nextSong"},{type:"separator"},{type:"selection",id:"save"},{type:"selection",id:"export"},{type:"separator"},{type:"selection",id:"capture"}]},edit:{type:"menu",title:"Edit",options:[{type:"selection",id:"cut"},{type:"selection",id:"copy"},{type:"selection",id:"paste"},{type:"selection",id:"pasteReplace"},{type:"separator"},{type:"selection",id:"undo"},{type:"selection",id:"redo"},{type:"separator"},{type:"checkbox",id:"mousePlacement",checked:()=>b.chart.mousePlacement}]},view:{type:"menu",title:"View",options:[{type:"dropdown",title:"Cursor",options:[{type:"selection",id:"cursorUp"},{type:"selection",id:"cursorDown"},{type:"separator"},{type:"selection",id:"previousNote"},{type:"selection",id:"nextNote"},{type:"separator"},{type:"selection",id:"previousMeasure"},{type:"selection",id:"nextMeasure"},{type:"separator"},{type:"selection",id:"previousStream"},{type:"selection",id:"nextStream"},{type:"separator"},{type:"selection",id:"jumpChartStart"},{type:"selection",id:"jumpChartEnd"},{type:"separator"},{type:"selection",id:"jumpSongStart"},{type:"selection",id:"jumpSongEnd"},{type:"separator"},{type:"selection",id:"jumpPreviousCandle"},{type:"selection",id:"jumpNextCandle"},{type:"separator"},{type:"selection",id:"jumpPreviousError"},{type:"selection",id:"jumpNextError"}]},{type:"dropdown",title:"Snap",options:[{type:"selection",id:"decreaseSnap"},{type:"selection",id:"increaseSnap"}]},{type:"dropdown",title:"Scroll",options:[{type:"checkbox",id:"XMod",checked:()=>!b.chart.CMod},{type:"checkbox",id:"CMod",checked:()=>b.chart.CMod},{type:"separator"},{type:"selection",id:"increaseScrollSpeed"},{type:"selection",id:"decreaseScrollSpeed"}]},{type:"dropdown",title:"Zoom",options:[{type:"selection",id:"zoomIn"},{type:"selection",id:"zoomOut"},{type:"separator"},{type:"selection",id:"zoomDefault"}]},{type:"separator"},{type:"selection",id:"playMode"},{type:"selection",id:"playModeStart"},{type:"separator"},{type:"selection",id:"recordMode"},{type:"selection",id:"recordModeStart"},{type:"separator"},{type:"checkbox",id:"reverse",checked:()=>b.chart.reverse},{type:"checkbox",id:"hideWarpedArrows",checked:()=>b.chart.hideWarpedArrows},{type:"checkbox",id:"hideFakedArrows",checked:()=>b.chart.hideFakedArrows},{type:"checkbox",id:"doSpeedChanges",checked:()=>b.chart.doSpeedChanges},{type:"separator"},{type:"dropdown",title:"Parity",options:[{type:"checkbox",id:"enableParity",checked:()=>b.chart.parity.enabled},{type:"separator"},{type:"checkbox",id:"showTechNotation",checked:()=>b.chart.parity.showTech},{type:"checkbox",id:"showTechErrors",checked:()=>b.chart.parity.showErrors},{type:"checkbox",id:"showFootHighlights",checked:()=>b.chart.parity.showHighlights},{type:"checkbox",id:"showCandles",checked:()=>b.chart.parity.showCandles},{type:"checkbox",id:"showDancingBot",checked:()=>b.chart.parity.showDancingBot}]}]},chart:{type:"menu",title:"Chart",options:[{type:"selection",id:"openChart"},{type:"separator"},{type:"selection",id:"previousChart"},{type:"selection",id:"nextChart"},{type:"separator"},{type:"selection",id:"songProperties"},{type:"separator"},{type:"selection",id:"timingDataRow"}]},selection:{type:"menu",title:"Selection",options:[{type:"dropdown",title:"Convert",options:[{type:"selection",id:"convertHoldsRolls"},{type:"selection",id:"convertRollsHolds"},{type:"selection",id:"swapHoldsRolls"},{type:"separator"},{type:"selection",id:"convertHoldsTaps"},{type:"selection",id:"convertTapsMines"},{type:"selection",id:"convertTapsLifts"},{type:"selection",id:"convertTapsFakes"}]},{type:"dropdown",title:"Mirror",options:[{type:"selection",id:"mirrorHorizontally"},{type:"selection",id:"mirrorVertically"},{type:"selection",id:"mirrorBoth"}]},{type:"dropdown",title:"Stretch",options:[{type:"selection",id:"expand2to1"},{type:"selection",id:"expand3to2"},{type:"selection",id:"expand4to3"},{type:"separator"},{type:"selection",id:"compress1to2"},{type:"selection",id:"compress2to3"},{type:"selection",id:"compress3to4"}]},{type:"dropdown",title:"Shift",options:[{type:"dropdown",title:"Up",options:[{type:"selection",id:"shiftUp4m"},{type:"selection",id:"shiftUp2m"},{type:"selection",id:"shiftUp1m"},{type:"selection",id:"shiftUp4th"},{type:"selection",id:"shiftUp8th"},{type:"selection",id:"shiftUp12th"},{type:"selection",id:"shiftUp16th"},{type:"selection",id:"shiftUp24th"},{type:"selection",id:"shiftUp32nd"},{type:"selection",id:"shiftUp48th"},{type:"selection",id:"shiftUp64th"},{type:"selection",id:"shiftUp96th"},{type:"selection",id:"shiftUp192nd"}]},{type:"dropdown",title:"Down",options:[{type:"selection",id:"shiftDown4m"},{type:"selection",id:"shiftDown2m"},{type:"selection",id:"shiftDown1m"},{type:"selection",id:"shiftDown4th"},{type:"selection",id:"shiftDown8th"},{type:"selection",id:"shiftDown12th"},{type:"selection",id:"shiftDown16th"},{type:"selection",id:"shiftDown24th"},{type:"selection",id:"shiftDown32nd"},{type:"selection",id:"shiftDown48th"},{type:"selection",id:"shiftDown64th"},{type:"selection",id:"shiftDown96th"},{type:"selection",id:"shiftDown192nd"}]}]},{type:"dropdown",title:"Quantize",options:[{type:"selection",id:"quantize4th"},{type:"selection",id:"quantize8th"},{type:"selection",id:"quantize12th"},{type:"selection",id:"quantize16th"},{type:"selection",id:"quantize24th"},{type:"selection",id:"quantize32nd"},{type:"selection",id:"quantize48th"},{type:"selection",id:"quantize64th"},{type:"selection",id:"quantize96th"}]},{type:"dropdown",title:"Timing",options:[{type:"selection",id:"convertSTOPS"},{type:"selection",id:"convertWARPS"},{type:"selection",id:"convertFAKES"},{type:"selection",id:"convertDELAYS"}]},{type:"dropdown",title:"Parity",options:[{type:"selection",id:"parityNone"},{type:"selection",id:"parityLeft"},{type:"selection",id:"parityRight"},{type:"separator"},{type:"selection",id:"parityL"},{type:"selection",id:"parityl"},{type:"selection",id:"parityR"},{type:"selection",id:"parityr"}]},{type:"separator"},{type:"selection",id:"setSongPreview"},{type:"separator"},{type:"selection",id:"exportNotedata"},{type:"separator"},{type:"selection",id:"selectBeforeCursor"},{type:"selection",id:"selectAfterCursor"},{type:"selection",id:"selectAll"}]},audio:{type:"menu",title:"Audio",options:[{type:"selection",id:"detectSync"},{type:"separator"},{type:"checkbox",id:"assistTick",checked:()=>b.audio.assistTick&&pe.assist},{type:"checkbox",id:"metronome",checked:()=>b.audio.metronome&&pe.assist},{type:"separator"},{type:"dropdown",title:()=>"Master Volume ("+Math.round(b.audio.masterVolume*100)+"%)",options:[{type:"selection",id:"volumeUp"},{type:"selection",id:"volumeDown"}]},{type:"dropdown",title:()=>"Song Volume ("+Math.round(b.audio.songVolume*100)+"%)",options:[{type:"selection",id:"songVolumeUp"},{type:"selection",id:"songVolumeDown"}]},{type:"dropdown",title:()=>"Effect Volume ("+Math.round(b.audio.soundEffectVolume*100)+"%)",options:[{type:"selection",id:"effectvolumeUp"},{type:"selection",id:"effectvolumeDown"}]},{type:"dropdown",title:()=>"Playback rate ("+Math.round(b.audio.rate*100)+"%)",options:[{type:"selection",id:"rateUp"},{type:"selection",id:"rateDown"},{type:"separator"},{type:"selection",id:"rateDefault"}]},{type:"separator"},{type:"selection",id:"showEq"}]},preferences:{type:"menu",title:"Preferences",options:[{type:"selection",id:"options"},{type:"selection",id:"themes"},{type:"selection",id:"keybinds"},{type:"selection",id:"gameplayKeybinds"},{type:"selection",id:"noteskinWindow"}]},help:{type:"menu",title:"Help",options:[{type:"selection",id:"about"},{type:"selection",id:"openGuide"},{type:"selection",id:"openChangelog"}]}},wc=["cut","copy","paste","pasteReplace"],vc={edit:[{ids:["delete"],after:"redo"},{ids:["toggleEditTiming","toggleAddTiming","previousNoteType","nextNoteType","noteTypeTap","noteTypeMine","noteTypeFake","noteTypeLift","quant4","quant8","quant12","quant16","quant24","quant32","quant48","quant64","quant96","quant192"],after:"mousePlacement"}],view:[{ids:["playback","selectRegion"]}],debug:[{ids:["showFPSCounter","showDebugTimers"]}]};class ci extends ht{static GROUPS;app;observer;searchDropdown;conflictMap=this.calculateConflicts();constructor(e){super({title:"Keybind Options",width:600,height:400,disableClose:!1,win_id:"keybind_options",blocking:!1}),this.app=e,ci.GROUPS||(ci.GROUPS=ci.createGroups()),this.initView()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-container");const n=document.createElement("div");n.classList.add("pref-search");const r=document.createElement("input");r.classList.add("pref-search-bar"),r.type="text",r.placeholder="Search for a keybind...",r.oninput=()=>{o.replaceChildren(...this.createSections(r.value)),l.replaceChildren(...this.createOptions(r.value))};const a=gi.create(["Name","Key"],"Name");a.onChange(()=>{o.replaceChildren(...this.createSections(r.value)),l.replaceChildren(...this.createOptions(r.value))}),this.searchDropdown=a,n.replaceChildren(r,a.view);const s=document.createElement("div");s.classList.add("pref-scrollers");const o=document.createElement("div");o.classList.add("pref-section-scroller");const l=document.createElement("div");l.classList.add("pref-option-scroller"),s.replaceChildren(o,l),this.observer=new IntersectionObserver(u=>{u.forEach(f=>{const c=f.target.dataset.id,d=o.querySelector(`.pref-section[data-id=${c}]`);d&&(f.intersectionRatio>0?d.classList.add("selected"):d.classList.remove("selected"))})},{}),t.replaceChildren(n,s),o.replaceChildren(...this.createSections()),l.replaceChildren(...this.createOptions()),e.appendChild(t),this.viewElement.appendChild(e)}createSections(e=""){return Object.keys(ci.GROUPS).filter(t=>ci.GROUPS[t].some(n=>this.filterID(e,n))).map(t=>this.createEmptySection(Qi[t]?.title??Ro(t),t))}createOptions(e=""){return Object.keys(ci.GROUPS).filter(t=>ci.GROUPS[t].some(n=>this.filterID(e,n))).map(t=>{const n=ci.GROUPS[t].filter(s=>this.filterID(e,s)).map(s=>this.createKeybindItem(s)),r=document.createElement("div");r.classList.add("pref-group"),r.dataset.id=t;const a=document.createElement("div");return a.classList.add("pref-group-label"),a.innerText=Qi[t]?.title??Ro(t),r.replaceChildren(a,...n),this.observer.observe(r),r})}static createGroups(){const e=Object.keys(Ne),t={};return Object.keys(Qi).forEach(n=>{t[n]=this.expandMenubarOptions(Qi[n]).map(r=>{const a=e.indexOf(r);return a!=-1&&e.splice(a,1),r}).filter(r=>!wc.includes(r))}),Object.keys(vc).forEach(n=>{t[n]===void 0&&(t[n]=[]),vc[n].forEach(r=>{let a=0;if(r.after){const s=t[n].findIndex(o=>r.after==o)+1;s!=0&&(a=s)}t[n].splice(a,0,...r.ids),r.ids.forEach(s=>{const o=e.indexOf(s);o!=-1&&e.splice(o,1)})})}),wc.forEach(n=>{const r=e.indexOf(n);r!=-1&&e.splice(r,1)}),e.length>0&&(console.warn("Missing keybinds not shown:"),console.warn(e)),t}filterID(e,t){if((this.searchDropdown?.value??"Name")=="Name")return(Ne[t].bindLabel??Ne[t].label).toLowerCase().includes(e.toLowerCase());{const n=Ae.getCombosForKeybind(t);if(n.some(a=>a.key.toLowerCase().includes(e.toLowerCase()))||n.some(a=>(Ju[a.key]??a.key).toLowerCase().includes(e.toLowerCase())))return!0;let r=e.split(" ").map(a=>a.toLowerCase());return n.some(a=>(r.includes("shift")||r.includes("⇧"))&&!a.mods.includes(On.SHIFT)||(r.includes("ctrl")||r.includes("control")||r.includes("⌃"))&&!a.mods.includes(On.CTRL)||(r.includes("meta")||r.includes("cmd")||r.includes("command")||r.includes("⌘"))&&!a.mods.includes(On.META)||(r.includes("alt")||r.includes("⌥"))&&!a.mods.includes(On.ALT)?!1:(r=r.filter(s=>!["shift","ctrl","control","meta","cmd","command","alt","⇧","⌃","⌘","⌥",""].includes(s)),r.length==0||r.length==1&&a.key.toLowerCase().includes(r[0])))}}static expandMenubarOptions(e){switch(e.type){case"menu":case"dropdown":return e.options.map(t=>this.expandMenubarOptions(t)).flat();case"selection":case"checkbox":return[e.id];case"separator":return[]}}createEmptySection(e,t){const n=document.createElement("div");return n.classList.add("pref-section"),n.dataset.id=t,n.innerText=e,n.onclick=()=>{n.parentElement.parentElement.querySelector(`.pref-group[data-id=${t}]`).scrollIntoView()},n}createKeybindItem(e){const t=document.createElement("div");t.classList.add("pref-keybind"),t.dataset.id=e,t.onclick=s=>{s.target.classList.contains("pref-keybind-combo")||t.querySelector(".icon")?.contains(s.target)||this.app.windowManager.openWindow(new An(this.app,!0,o=>{Ae.setKeybind(e,o),this.conflictMap=this.calculateConflicts(),t.replaceWith(this.createKeybindItem(e))},o=>{const l=this.conflictMap.get(Ae.getComboString(o))?.map(u=>u[0]).map(u=>Ne[u].bindLabel??Ne[u].label)??[];return l.includes(e)?"self":l}))};const n=document.createElement("div");n.classList.add("pref-keybind-label"),n.innerText=Ne[e].bindLabel??Ne[e].label;const r=be.getIcon("REVERT");r.style.width="0.75rem",r.addEventListener("click",()=>{Ae.revertKeybind(e),this.conflictMap=this.calculateConflicts(),t.replaceWith(this.createKeybindItem(e))}),r.style.display=Ae.checkIsDefault(e)?"none":"block";const a=document.createElement("div");return a.classList.add("pref-keybind-combos"),a.replaceChildren(...Ae.getCombosForKeybind(e).map(s=>{const o=document.createElement("button");return o.classList.add("pref-keybind-combo"),o.innerText=Ae.getComboString(s),this.conflictMap.get(Ae.getComboString(s)).length>1&&o.classList.add("conflict"),o.onclick=()=>{Ae.removeKeybind(e,s),this.conflictMap=this.calculateConflicts(),t.replaceWith(this.createKeybindItem(e))},o})),t.replaceChildren(n,r,a),t}calculateConflicts(){const e=new Map;Object.keys(Ne).forEach(t=>{Ae.getCombosForKeybind(t).forEach((n,r)=>{const a=Ae.getComboString(n);e.has(a)||e.set(a,[]),e.get(a).push([t,r])})}),[...this.viewElement.querySelectorAll(".pref-keybind-combo.conflict")].forEach(t=>t.classList.remove("conflict"));for(const t of e.values())t.length!=1&&t.forEach(n=>{const r=this.viewElement.querySelector(`.pref-keybind[data-id=${n[0]}] .pref-keybind-combos`);r?.children[n[1]]&&r.children[n[1]].classList.add("conflict")});return e}onClose(){this.observer?.disconnect()}}class nt{static noteskins=new Map;static register(e){for(const t of new Set(e.gameTypes))nt.noteskins.has(t)||nt.noteskins.set(t,new Map),nt.noteskins.get(t).set(e.id,e)}static async getNoteskin(e,t){const n=this.noteskins.get(e.id);if(!n||n.size==0)return;const r=n.get(t)??[...n.values()][0];return n.get(t)||ue.createFormatted(`Couldn't find the noteskin ${t}!`,"warn"),await r.load()}static getNoteskinData(e,t){const n=this.noteskins.get(e.id);return!n||n.size==0?void 0:n.get(t)??[...n.values()][0]}static getNoteskins(){return this.noteskins}static getPreviewUrl(e,t){return this.getNoteskinData(e,t).preview}}nt.register({id:"default",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-CR6HHWkZ.js");return{default:i}},__vite__mapDeps([7,1,2,8]))).default,preview:new URL("/smeditor/assets/preview-OxO8T-xD.png",import.meta.url).href,title:"Scalable",subtitle:"Pete-Lawrence"});nt.register({id:"cf-chrome",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-DSc9KGCH.js");return{default:i}},__vite__mapDeps([9,1,2,8]))).default,preview:new URL("/smeditor/assets/preview-Bd1omMHV.png",import.meta.url).href,title:"CF_CHROME",subtitle:"Pete-Lawrence"});nt.register({id:"ddr-note",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-D9_02-tj.js");return{default:i}},__vite__mapDeps([10,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-DdYrG22o.png",import.meta.url).href,title:"DDR-Note",subtitle:"Pete-Lawrence"});nt.register({id:"ddr-note-itg",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-DnReuYHF.js");return{default:i}},__vite__mapDeps([12,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-mEgpRzfG.png",import.meta.url).href,title:"DDR-Note (ITG quants)",subtitle:"Pete-Lawrence"});nt.register({id:"ddr-rainbow",gameTypes:["dance-single","dance-double","dance-couple"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-BA2AU3N9.js");return{default:i}},__vite__mapDeps([13,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-CSm_jZ6l.png",import.meta.url).href,title:"DDR-Rainbow",subtitle:"LemmaEOF"});nt.register({id:"ddr-rainbow-itg",gameTypes:["dance-single","dance-double","dance-couple"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-CNgOhnUG.js");return{default:i}},__vite__mapDeps([14,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-BIggbhNp.png",import.meta.url).href,title:"DDR-Rainbow (ITG quants)",subtitle:"LemmaEOF"});nt.register({id:"metal",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-DtoXnjwS.js");return{default:i}},__vite__mapDeps([15,1,2,8]))).default,preview:new URL("/smeditor/assets/preview-CGpd3Xps.png",import.meta.url).href,title:"Metal",subtitle:"Pete-Lawrence"});nt.register({id:"pastel",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-DSilrxY-.js");return{default:i}},__vite__mapDeps([16,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-D-gUhvzF.png",import.meta.url).href,title:"Pastel",subtitle:"halcyoniix"});nt.register({id:"dividebyzero",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-BvTgUoTH.js");return{default:i}},__vite__mapDeps([17,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-BveM7vOk.png",import.meta.url).href,title:"DivideByZero",subtitle:"MinaciousGrace"});nt.register({id:"subtractbyzero",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-DV03CRI5.js");return{default:i}},__vite__mapDeps([18,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-0QJpt-dz.png",import.meta.url).href,title:"SubtractByZero",subtitle:"qwertyzoro/Vague"});nt.register({id:"sm4",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-BX6w0wz_.js");return{default:i}},__vite__mapDeps([19,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-B57yH2sm.png",import.meta.url).href,title:"SM4",subtitle:"from SM4"});nt.register({id:"sm4-bold",gameTypes:["dance-single","dance-double","dance-couple","dance-solo","dance-solodouble","dance-threepanel","dance-threedouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-CzAs-Xul.js");return{default:i}},__vite__mapDeps([20,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-WAGM24LC.png",import.meta.url).href,title:"SM4 Bold",subtitle:"from SM4"});nt.register({id:"starlight-vivid",gameTypes:["dance-single","dance-double","dance-couple"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-xrz4C4VG.js");return{default:i}},__vite__mapDeps([21,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-Co7w1-gB.png",import.meta.url).href,title:"SLNEXXT-vivid",subtitle:"from STARLiGHT-NEXXT"});nt.register({id:"default",gameTypes:["pump-single","pump-double","pump-couple","pump-versus","pump-halfdouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-DdCjW-Ir.js");return{default:i}},__vite__mapDeps([22,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-ChWRgpap.png",import.meta.url).href,title:"Fiesta"});nt.register({id:"fourv2",gameTypes:["pump-single","pump-double","pump-couple","pump-versus","pump-halfdouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-CsCC7Tro.js");return{default:i}},__vite__mapDeps([23,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-BC8deddd.png",import.meta.url).href,title:"FourV2",subtitle:"Jousway"});nt.register({id:"prime",gameTypes:["pump-single","pump-double","pump-couple","pump-versus","pump-halfdouble"],load:async()=>(await qe(async()=>{const{default:i}=await import("./Noteskin-CyScyomH.js");return{default:i}},__vite__mapDeps([24,1,2,11,8]))).default,preview:new URL("/smeditor/assets/preview-CIFre-Xk.png",import.meta.url).href,title:"Prime"});const vm="/smeditor/assets/preview-CAPSxB0Y.png";class xm extends ht{app;grid;lastGameType=null;constructor(e){super({title:"Noteskin Selection",width:600,height:400,disableClose:!1,win_id:"noteskin-selection",blocking:!1}),this.app=e,this.initView(),this.loadGrid(),ee.on("chartLoaded",()=>{const t=e.chartManager.loadedChart.gameType.id;this.lastGameType!=t&&this.loadGrid()})}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("input");t.classList.add("pref-search-bar"),t.type="text",t.placeholder="Search for a noteskin...",t.oninput=()=>{this.filterGrid(t.value)};const n=document.createElement("div");n.classList.add("noteskin-grid"),this.grid=n,e.replaceChildren(t,n),this.viewElement.appendChild(e)}loadGrid(){if(this.grid.replaceChildren(),!this.app.chartManager.loadedChart)return;const e=this.app.chartManager.loadedChart.gameType;this.lastGameType=e.id;const t=nt.getNoteskins().get(e.id);if(t)for(const[n,r]of t.entries()){const a=document.createElement("div"),s=document.createElement("img"),o=document.createElement("div"),l=document.createElement("div"),u=document.createElement("div");a.classList.add("noteskin-cell"),o.classList.add("noteskin-label"),l.classList.add("noteskin-title"),u.classList.add("noteskin-subtitle"),l.innerText=r.title??n,u.innerText=r.subtitle??"",s.src=nt.getPreviewUrl(e,n),s.onerror=()=>{s.src=vm},a.replaceChildren(s,o),o.replaceChildren(l,u),this.grid.appendChild(a),n==b.chart.noteskin.name&&(a.classList.add("selected"),setTimeout(()=>{a.scrollIntoView({behavior:b.general.smoothAnimations?"smooth":"instant",block:"center"})})),a.dataset.id=n,a.dataset.title=r.title??"",a.dataset.subtitle=r.subtitle??"",a.onclick=()=>{b.chart.noteskin.name!=n&&(this.app.chartManager.chartView?.swapNoteskin(n),this.removeAllSelections(),a.classList.add("selected"))}}}removeAllSelections(){[...this.grid.querySelectorAll(".selected")].forEach(e=>e.classList.remove("selected"))}filterGrid(e){[...this.grid.children].forEach(t=>{if(!(t instanceof HTMLDivElement))return;const n=t,r=this.containsQuery(e,n.dataset.id)||this.containsQuery(e,n.dataset.title)||this.containsQuery(e,n.dataset.subtitle);n.style.display=r?"":"none"})}containsQuery(e,t){return t?t.toLowerCase().includes(e.trim().toLowerCase()):!1}}class Em extends ht{app;metronomeInterval;startTime;me_high=new Ps.Howl({src:Qc,volume:b.audio.soundEffectVolume});me_low=new Ps.Howl({src:Jc,volume:b.audio.soundEffectVolume});tickLines=[];resultLines=[];previousOffsets=[];keyHandler;constructor(e){super({title:"Offset Adjuster",width:300,height:200,win_id:"offset",blocking:!0}),this.app=e,this.initView(),this.startTime=performance.now();let t=this.startTime+500;this.tickLines.push({time:t+500,beat:0}),this.tickLines.push({time:t+500*2,beat:1}),this.tickLines.push({time:t+500*3,beat:2}),this.tickLines.push({time:t+500*4,beat:3});let n=0;this.metronomeInterval=setInterval(()=>{const r=performance.now();if(r-t>500){for(t=r,(n%4==0?this.me_high:this.me_low).play();this.tickLines[0]?.time+1e3<r;)this.tickLines.shift();this.tickLines.push({time:t+500*4,beat:n+4}),n++}this.resultLines=this.resultLines.filter(a=>r-a.startTime<8e3)},5),this.keyHandler=r=>{if(r.code.startsWith("Digit")||r.code.startsWith("Key")||r.code=="Space"){let a=this.tickLines[0];const s=performance.now();for(const l of this.tickLines)if(s-l.time+b.play.offset*1e3<300){a=l;break}r.preventDefault();const o=s-a.time+b.play.offset*1e3;o>-300&&(this.tickLines.splice(this.tickLines.indexOf(a),1),this.resultLines.push({startTime:performance.now(),offset:o}),this.previousOffsets.push(o),this.previousOffsets.length==16&&(zc(this.previousOffsets)<70&&(b.play.offset-=jr(this.previousOffsets)/1e3),this.previousOffsets=[]))}},window.addEventListener("keydown",this.keyHandler)}initView(){this.viewElement.replaceChildren();const e=document.createElement("canvas");this.viewElement.appendChild(e);const t=this.drawEQ(e);requestAnimationFrame(t)}drawEQ(e){const t=e.getContext("2d");t.canvas.width=250,t.canvas.height=100;const n=()=>{t.fillStyle="rgba(0, 0, 0, 1)",t.fillRect(0,0,e.width,e.height),t.fillStyle="rgb(255, 255, 255)",t.fillRect(e.width/2-1,8,2,e.height-16);const r=performance.now();for(const a of this.resultLines){t.fillStyle="rgba(255, 255, 255, 1)";const s=Math.min(1,4-(r-a.startTime)/2e3);if(a.offset<0&&(t.fillStyle=`rgba(160, ${Qe(160,0,-a.offset/250)}, ${Qe(160,0,-a.offset/250)}, ${s})`),a.offset>0&&(t.fillStyle=`rgba(${Qe(160,0,a.offset/250)}, ${Qe(160,0,a.offset/250)}, 160, ${s})`),t.fillRect(e.width/2-.5+a.offset/4,12,1,e.height-24),r-a.startTime<250){const o=(r-a.startTime)/250;t.globalAlpha=1-o,t.fillRect(e.width/2-.5-o*3+a.offset/4,12-o*10,1+o*6,e.height-24+o*20)}t.globalAlpha=1}for(const a of this.tickLines){const s=a.time-r-b.play.offset*1e3;t.fillStyle="rgba(255, 255, 255, 0.8)",a.beat%4!=0?t.fillRect(e.width/2-1-s/4,12,2,e.height-24):t.fillRect(e.width/2-2-s/4,12,4,e.height-24)}e.closest("#windows")&&requestAnimationFrame(n)};return n}onClose(){clearInterval(this.metronomeInterval),window.removeEventListener("keydown",this.keyHandler)}}class Cm extends ht{app;changeHandler=()=>this.initView();constructor(e){super({title:"Song Properties",width:450,height:486,disableClose:!1,win_id:"sm_properties",blocking:!1}),this.app=e,this.initView(),ee.on("smLoaded",this.changeHandler),ee.on("undo",this.changeHandler),ee.on("redo",this.changeHandler)}onClose(){ee.off("smLoaded",this.changeHandler),ee.off("undo",this.changeHandler),ee.off("redo",this.changeHandler)}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("sm-properties");const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("label"),t.innerText="Apply to",Ku.forEach(n=>{const r=document.createElement("div");r.classList.add("sm-container");const a=document.createElement("div");a.classList.add("sm-title"),a.innerText=n.title;const s=document.createElement("div");s.classList.add("property-grid"),n.items.forEach(o=>{const l=document.createElement("div");l.classList.add("label"),l.innerText=o.title,s.appendChild(l),s.appendChild(Xu(this.app,this.app.chartManager.loadedSM,Dt.instance,o))}),r.appendChild(a),r.appendChild(s),e.appendChild(r)}),this.viewElement.appendChild(e)}}var Cs,xc;function _m(){if(xc)return Cs;xc=1,Cs=s;var i=8192,e=65536,t=new ArrayBuffer(e*4),n=new Float64Array(t,e,i),r=new Float64Array(t,e*2,i/2),a=o({Math,Float64Array},null,t);function s(l){if(!l)throw Error("Input data is not provided, pass an array.");var u=l.length;if(u>i)throw Error("Input length is too big, must be under "+i);var f=Math.floor(Math.log(u)/Math.LN2);if(Math.pow(2,f)!==u)throw Error("Invalid array size, must be a power of 2.");return n.set(l),a(u,f),r.subarray(0,u/2)}function o(l,u,f){var c=6.283185307179586,d=l.Math.sqrt,h=l.Math.sin,p=l.Math.cos,m=l.Math.abs,g=l.Math.SQRT1_2,y=l.Math.imul,x=new l.Float64Array(f),w=new l.Float64Array(f),_=8192,C=16384;function F(R,N){R=R|0,N=N|0;var j=0,ae=0,L=0,O=0,v=0,S=0,Y=0,D=0,G=0,V=0,J=0,H=0,P=0,re=0,ne=0,te=0,Me=0,He=0,_e=0,ve=0,Le=0,Be=0,ct=0,ut=0,E=0,X=0,q=0,M=0,k=0,z=0,$=0,Q=0;for(j=R>>>1,L=2/+(R|0),T(R),z=0,Q=4;(z|0)<(R|0);Q=y(Q,4)){for($=z;($|0)<(R|0);$=$+Q|0)ve=w[$<<3>>3]-w[$+1<<3>>3],w[$<<3>>3]=w[$<<3>>3]+w[$+1<<3>>3],w[$+1<<3>>3]=ve;z=y(2,Q-1)}for(O=2,Y=R>>>1;Y=Y>>>1;){z=0,O=O<<1,Q=O<<1,v=O>>>2,S=O>>>3;do{if((v|0)!=1)for($=z;($|0)<(R|0);$=$+Q|0)H=$,P=H+v|0,re=P+v|0,ne=re+v|0,D=w[re<<3>>3]+w[ne<<3>>3],w[ne<<3>>3]=w[ne<<3>>3]-w[re<<3>>3],w[re<<3>>3]=w[H<<3>>3]-D,w[H<<3>>3]=w[H<<3>>3]+D,H=H+S|0,P=P+S|0,re=re+S|0,ne=ne+S|0,D=w[re<<3>>3]+w[ne<<3>>3],G=w[re<<3>>3]-w[ne<<3>>3],D=-D*g,G=G*g,ve=+w[P<<3>>3],w[ne<<3>>3]=D+ve,w[re<<3>>3]=D-ve,w[P<<3>>3]=w[H<<3>>3]-G,w[H<<3>>3]=w[H<<3>>3]+G;else for($=z;($|0)<(R|0);$=$+Q|0)H=$,P=H+v|0,re=P+v|0,ne=re+v|0,D=w[re<<3>>3]+w[ne<<3>>3],w[ne<<3>>3]=w[ne<<3>>3]-w[re<<3>>3],w[re<<3>>3]=w[H<<3>>3]-D,w[H<<3>>3]=w[H<<3>>3]+D;z=(Q<<1)-O|0,Q=Q<<2}while((z|0)<(R|0));for(E=c/+(O|0),ae=1;(ae|0)<(S|0);ae=ae+1|0){X=+(ae|0)*E,Be=h(X),Le=p(X),ct=4*Le*(Le*Le-.75),ut=4*Be*(.75-Be*Be),z=0,Q=O<<1;do{for($=z;($|0)<(R|0);$=$+Q|0)H=$+ae|0,P=H+v|0,re=P+v|0,ne=re+v|0,te=$+v-ae|0,Me=te+v|0,He=Me+v|0,_e=He+v|0,G=w[He<<3>>3]*Le-w[re<<3>>3]*Be,D=w[He<<3>>3]*Be+w[re<<3>>3]*Le,J=w[_e<<3>>3]*ct-w[ne<<3>>3]*ut,V=w[_e<<3>>3]*ut+w[ne<<3>>3]*ct,ve=G-J,G=G+J,J=ve,w[_e<<3>>3]=G+w[Me<<3>>3],w[re<<3>>3]=G-w[Me<<3>>3],ve=V-D,D=D+V,V=ve,w[ne<<3>>3]=V+w[P<<3>>3],w[He<<3>>3]=V-w[P<<3>>3],w[Me<<3>>3]=w[H<<3>>3]-D,w[H<<3>>3]=w[H<<3>>3]+D,w[P<<3>>3]=J+w[te<<3>>3],w[te<<3>>3]=w[te<<3>>3]-J;z=(Q<<1)-O|0,Q=Q<<2}while((z|0)<(R|0))}}for(;j=j-1|0;)q=+w[j<<3>>3],M=+w[R-j-1<<3>>3],k=L*d(q*q+M*M),x[C+j<<3>>3]=k;x[C+0<<3>>3]=m(L*w[0])}function T(R){R=R|0;var N=0,j=0,ae=1,L=0,O=0;N=R>>>1,j=R-1|0,w[0]=x[_+0<<3>>3];do{for(L=L+N|0,w[ae<<3>>3]=x[_+L<<3>>3],w[L<<3>>3]=x[_+ae<<3>>3],ae=ae+1|0,O=N<<1;O=O>>1,((L=L^O)&O)==0;);(L|0)>=(ae|0)&&(w[ae<<3>>3]=x[_+L<<3>>3],w[L<<3>>3]=x[_+ae<<3>>3],w[j-ae<<3>>3]=x[_+j-L<<3>>3],w[j-L<<3>>3]=x[_+j-ae<<3>>3]),ae=ae+1|0}while((ae|0)<(N|0));w[j<<3>>3]=x[_+j<<3>>3]}return F}return Cs}var Am=_m();const Ec=or(Am),Ut=800,tt=200,_s=3,Ln=125,Dn=250,xr=3,km=.02,un=6,As=800,Cc=15,Wt=32768,ks=[{frequency:20,weight:.4006009013520281},{frequency:25,weight:.4258037044922291},{frequency:31.5,weight:.4536690484291709},{frequency:40,weight:.4840856831659204},{frequency:50,weight:.5142710208279764},{frequency:63,weight:.5473453749315819},{frequency:80,weight:.5841121495327103},{frequency:100,weight:.6214074879602299},{frequency:125,weight:.6601749463607856},{frequency:160,weight:.7054673721340388},{frequency:200,weight:.7489234225800412},{frequency:250,weight:.7936507936507937},{frequency:315,weight:.8406893652795292},{frequency:400,weight:.889284126278346},{frequency:500,weight:.9291521486643438},{frequency:630,weight:.9675858732462506},{frequency:800,weight:.9985022466300548},{frequency:1e3,weight:.9997500624843789},{frequency:1250,weight:.9564801530368244},{frequency:1600,weight:.9409550693954364},{frequency:2e3,weight:1.0196278358399185},{frequency:2500,weight:1.0955902492467817},{frequency:3150,weight:1.1232799775344005},{frequency:4e3,weight:1.0914051841746248},{frequency:5e3,weight:.9997500624843789},{frequency:6300,weight:.8727907484180668},{frequency:8e3,weight:.7722007722007722},{frequency:1e4,weight:.7369196757553427},{frequency:12500,weight:.7768498737618955},{frequency:16e3,weight:.7698229407236336},{frequency:2e4,weight:.4311738708634257},{frequency:22550,weight:.2},{frequency:25e3,weight:0}];class Qu extends ht{app;onAudioLoad=this.reset.bind(this);onResize=this.resize.bind(this);windowStep=512;fftSize=1024;tempoFftSize=4096;tempoStep=2;monoAudioData;audioLength=0;sampleRate=44100;tempogram=[];tempogramGroups=[];spectrogram=[];spectrogramDifference=[];noveltyCurve=[];noveltyCurveIsolated=[];spectrogramCanvases=[];lowestFinishedBlock=0;numRenderedBlocks=0;peaks=[];_threshold=.3;spectroHeights=[];spectroWeights=[];placeNotesSelectionButton;toggleButton;resetButton;onsetResults;offsetTableLabel;offsetRows=[];bpmRows=[];covers=[];doAnalysis=!1;lastSecond=0;constructor(e){super({title:"Detect Audio Sync",width:400,height:450,win_id:"detect-sync"}),this.app=e,this.initView(),this.reset(),ee.on("audioLoaded",this.onAudioLoad),ee.on("resize",this.onResize)}onClose(){ee.off("audioLoaded",this.onAudioLoad),ee.off("resize",this.onResize),this.app.chartManager.chartAudio.offLoad(this.onAudioLoad)}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("sync-container"),e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center";const t=document.createElement("canvas");t.style.width=`${Ut/2/16}rem`,t.style.height=`${tt/16}rem`;const n=document.createElement("div");n.classList.add("sync-tab-container");const r=document.createElement("div");r.classList.add("sync-tab-option","active"),r.innerText="Analysis Options";const a=document.createElement("div");a.classList.add("sync-tab-option"),a.innerText="Tempo Results";const s=document.createElement("div");s.classList.add("sync-tab-option"),s.innerText="Onset Results",n.replaceChildren(r,a,s),[...n.children].forEach((m,g)=>{m.onclick=()=>{const y=parseFloat(getComputedStyle(document.body.parentElement).fontSize);l.scrollLeft=370*y/16*g,n.querySelectorAll(".active").forEach(x=>x.classList.remove("active")),m.classList.add("active")}});const o=document.createElement("div");o.classList.add("sync-tab-view");const l=document.createElement("div");l.classList.add("sync-tab-scroller");const u=this.createOptionsView(),f=this.createTempoView(),c=this.createOnsetsView(),d=(m,g)=>{const y=document.createElement("div");return y.classList.add("sync-cover"),y.innerText=m,y.style.left=`${g*370/16}rem`,y};this.covers=[d("Clear analysis results to edit",0),d("Start analysis to view",1),d("Start analysis to view",2)],o.appendChild(l),l.replaceChildren(u,this.covers[0],f,this.covers[1],c,this.covers[2]);const h=document.createElement("div");h.classList.add("sync-bottom-container"),this.resetButton=document.createElement("button"),this.resetButton.classList.add("delete"),this.resetButton.innerText="Clear results",this.resetButton.style.width="7.5rem",this.resetButton.disabled=!0,this.resetButton.onclick=()=>{this.resetButton.disabled=!0,r.click(),this.reset()},this.toggleButton=document.createElement("button"),this.toggleButton.innerText="Start analyzing",this.toggleButton.style.width="12.5rem",this.toggleButton.onclick=()=>{this.doAnalysis||a.click(),this.doAnalysis=!this.doAnalysis,this.toggleButton.innerText=this.doAnalysis?"Stop analyzing":this.hasData()?"Resume analyzing":"Start analyzing",this.resetButton.disabled=this.doAnalysis},h.replaceChildren(this.toggleButton,this.resetButton),e.replaceChildren(t,n,o,h),this.viewElement.appendChild(e);const p=this.windowLoop(t);requestAnimationFrame(p)}resize(){const e=this.viewElement.querySelector(".sync-tab-option.active");if(!e)return;const t=[...e.parentElement.children].indexOf(e);if(t<0)return;const n=parseFloat(getComputedStyle(document.body.parentElement).fontSize);this.viewElement.querySelector(".sync-tab-scroller").scrollLeft=370*n/16*t}createOptionsView(){const e=document.createElement("div");e.style.display="flex",e.style.position="relative",e.style.flexDirection="column",e.style.gap="0.2rem",e.style.height="100%";const t=(u,f,c)=>{const d=document.createElement("div");d.style.display="flex",d.style.flexDirection="row",d.style.justifyContent="space-between",d.style.alignItems="center";const h=document.createElement("div");return h.classList.add("label"),h.innerText=u,d.replaceChildren(h,f),Ze(d,{content:c}),d},n=document.createElement("div");n.innerText="Onsets",n.style.fontWeight="600";const r=Fi.create({min:Math.log2(128),max:Math.log2(8192),step:1,value:Math.log2(this.fftSize),transformer:u=>2**u,onChange:u=>{this.fftSize=2**u,this.windowStep>this.fftSize&&(this.windowStep=this.fftSize,a.setValue(u)),this.reset()}}),a=Fi.create({min:Math.log2(128),max:Math.log2(8192),step:1,value:Math.log2(this.windowStep),transformer:u=>2**u,onChange:u=>{this.windowStep=2**u,this.windowStep>this.fftSize&&(this.windowStep=this.fftSize,a.setValue(Math.log2(this.fftSize))),this.reset()}}),s=document.createElement("div");s.innerText="Tempo",s.style.fontWeight="600",s.style.marginTop="1rem";const o=Fi.create({min:Math.log2(128),max:Math.log2(8192),step:1,value:Math.log2(this.tempoFftSize),transformer:u=>2**u,onChange:u=>{this.tempoStep=2**u,this.tempoStep>this.tempoFftSize&&(this.tempoStep=this.tempoFftSize,l.setValue(u)),this.reset()}}),l=Fi.create({min:Math.log2(1),max:Math.log2(1024),step:1,value:Math.log2(this.tempoStep),transformer:u=>2**u,onChange:u=>{this.tempoStep=2**u,this.tempoStep>this.tempoFftSize&&(this.tempoStep=this.tempoFftSize,l.setValue(Math.log2(this.tempoFftSize))),this.reset()}});return e.replaceChildren(n,t("FFT Size",r.view,"Determines the amount of audio to analyze at every block. Higher values result in more accurate frequencies, while lower values result in more accurate timings. Defaults to 1024."),t("Window Step",a.view,"Determines the number of blocks per second. Lower values result in more time-accurate spectrograms, but may take more time and mess up tempo analysis. Defaults to 512 and must be lower than FFT Size."),s,t("FFT Size",o.view,"Determines the amount of the onset graph to analyze at every block. Higher values result in more accurate tempos, while lower values result in more accurate timings. Defaults to 4096."),t("Window Step",l.view,"Determines the number of blocks per second. Lower values result in more time-accurate tempograms, but may take more time. Defaults to 2 and must be lower than FFT Size.")),e}createTempoView(){const e=document.createElement("div");e.style.display="flex",e.style.position="relative",e.style.gap="0.625m";const t=document.createElement("div");t.style.flex="1";const n=document.createElement("div");n.classList.add("sync-table-label"),n.innerText="Offsets",this.offsetTableLabel=n;const r=document.createElement("table");r.classList.add("sync-table");const a=document.createElement("tr"),s=document.createElement("th");s.innerText="Offset";const o=document.createElement("th");o.innerText="Confidence",a.replaceChildren(s,o),r.appendChild(a),t.replaceChildren(n,r);const l=document.createElement("div");l.style.flex="1";const u=document.createElement("div");u.classList.add("sync-table-label"),u.innerText="Current Tempos";const f=document.createElement("table");f.classList.add("sync-table");const c=document.createElement("tr"),d=document.createElement("th");d.innerText="BPM";const h=document.createElement("th");h.innerText="Confidence",c.replaceChildren(d,h),f.appendChild(c);for(let p=0;p<5;p++){const m=document.createElement("tr");m.classList.add("empty");const g=document.createElement("td");g.innerText="-";const y=document.createElement("td");y.innerText="-",m.replaceChildren(g,y),r.appendChild(m),this.offsetRows.push(m);const x=m.cloneNode(!0);f.appendChild(x),this.bpmRows.push(x),m.onclick=()=>{let w;try{w=parseFloat(g.innerText)}catch{return}const _=this.app.chartManager.loadedChart.timingData;_.hasChartOffset()?_.setOffset(w):_.songTimingData.setOffset(w)},x.onclick=()=>{let w;try{w=parseFloat(x.firstElementChild.innerText)}catch{return}const _=this.app.chartManager.loadedChart.timingData,C=Math.round(this.app.chartManager.beat*48)/48;_.insertColumnEvents([{type:"BPMS",beat:C,value:w}])}}return l.replaceChildren(u,f),e.replaceChildren(t,l),e}createOnsetsView(){const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.gap="0.625rem",e.style.justifyContent="center",e.style.alignItems="center",e.style.position="relative";const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.style.width="100%",Ze(t,{content:"Adjust the threshold for a block to be considered an onset (red line)."});const n=document.createElement("div");n.innerText="Onset Threshold";const r=Fi.create({min:0,max:1,step:.01,value:.3,onChange:u=>{this.threshold=u}}),a=document.createElement("div");a.style.color="#888888",a.style.fontStyle="italic",a.style.fontSize="0.75rem",a.style.marginBottom="1rem",a.style.marginTop="-0.375rem",a.innerText="Found 0 onsets",this.onsetResults=a,t.replaceChildren(n,r.view);const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.width="100%";const o=document.createElement("button");o.innerText="Place onsets as notes",o.onclick=()=>this.placeOnsets();const l=document.createElement("button");return l.innerText="Place onsets as notes in selection",l.disabled=!0,l.onclick=()=>this.placeOnsets(!0),this.placeNotesSelectionButton=l,s.replaceChildren(o,l),e.replaceChildren(t,a,s),e}async reset(){this._threshold=.3,this.doAnalysis=!1,this.toggleButton.disabled=!1,this.toggleButton.style.background="",this.toggleButton.innerText="Start analyzing",this.app.chartManager.chartAudio.onLoad(this.onAudioLoad),await this.getMonoAudioData(),this.sampleRate=this.app.chartManager.chartAudio.getSampleRate(),this.spectroHeights=new Array(this.fftSize).fill(0).map((t,n)=>{const r=n/(this.fftSize/2)*this.sampleRate/2,a=(n+1)/(this.fftSize/2)*this.sampleRate/2,s=tt-Se(Math.log(r/20)/Math.log(this.sampleRate/40)*tt,0,tt),o=tt-Se(Math.log(a/20)/Math.log(this.sampleRate/40)*tt,0,tt);return{y:o,height:s-o}}),this.spectroWeights=new Array(this.fftSize).fill(0).map((t,n)=>{const r=n/(this.fftSize/2)*this.sampleRate/2,a=ks.findIndex(l=>l.frequency>r);if(a<1)return 0;const s=ks[a-1],o=ks[a];return Qe(s.weight,o.weight,Kt(Math.log(1+s.frequency),Math.log(1+o.frequency),Math.log(1+r)))});const e=Math.max(1,Math.ceil(this.audioLength/this.windowStep));this.spectrogramCanvases=[];for(let t=0;t<Math.ceil(e/Wt);t++){const n=new OffscreenCanvas(Math.min(Wt,e-t*Wt),tt*2);this.spectrogramCanvases.push(n)}this.spectrogram=[],this.lowestFinishedBlock=0,this.numRenderedBlocks=0,this.spectrogramDifference=[],this.noveltyCurve=[],this.noveltyCurveIsolated=[],this.peaks=[],this.tempogram=[],this.tempogramGroups=[],this.offsetTableLabel.innerText="Offsets",this.offsetRows.forEach(t=>{t.firstChild.innerText="-",t.lastChild.innerText="-",t.classList.add("empty")}),this.bpmRows.forEach(t=>{t.firstChild.innerText="-",t.lastChild.innerText="-",t.classList.add("empty")})}hasData(){return this.numRenderedBlocks>0}windowLoop(e){const t=e.getContext("2d");t.canvas.width=Ut,t.canvas.height=tt*2,t.imageSmoothingEnabled=!1;const n=()=>{if(this.placeNotesSelectionButton.disabled=this.app.chartManager.startRegion===void 0||this.app.chartManager.endRegion===void 0||this.app.chartManager.startRegion==this.app.chartManager.endRegion,this.covers[0].classList.toggle("active",this.hasData()),this.covers[1].classList.toggle("active",!this.hasData()),this.covers[2].classList.toggle("active",!this.hasData()),!this.app.chartManager.chartAudio)return;const r=Math.ceil(this.audioLength/this.windowStep);if(this.monoAudioData!==void 0&&this.doAnalysis){const d=performance.now();for(;performance.now()-d<Cc;){if(this.lowestFinishedBlock>=r){this.tempogram.length==0&&(this.toggleButton.disabled=!0,this.calcTempogram());break}this.spectrogram[this.lowestFinishedBlock]===void 0&&(this.renderBlock(this.lowestFinishedBlock),this.calcDifference(this.lowestFinishedBlock),this.calcIsolatedNovelty(this.lowestFinishedBlock),this.numRenderedBlocks++),this.lowestFinishedBlock++}this.lowestFinishedBlock<r&&(this.toggleButton.style.background=`linear-gradient(90deg, var(--accent-color) 0 ${this.lowestFinishedBlock/r*100}%, var(--input-bg) ${this.lowestFinishedBlock/r*100}% 100%)`,this.toggleButton.innerText=`Stop analyzing (${fe(this.lowestFinishedBlock/r*100,1)}%)`)}t.clearRect(0,0,e.width,e.height);const a=b.chart.speed/40,s=this.app.chartManager.time*this.sampleRate/this.windowStep-Ut*.2/a,o=this.app.chartManager.time*this.sampleRate/this.windowStep+Ut*.8/a;for(let d=Math.floor(s/Wt);d<=Math.floor(o/Wt);d++){const h=this.spectrogramCanvases[d];h&&t.drawImage(h,this.app.chartManager.time*this.sampleRate/this.windowStep-Ut*.2/a-Wt*d,0,Ut/a,tt*2,0,0,Ut,tt*2)}t.globalCompositeOperation="source-atop";let l;Gs(Fe.getColor("primary-bg"))>.5?l=new B("white"):l=new B("black"),t.fillStyle=Rt(Fe.getColor("accent-color"),l,.1).toHexa(),t.fillRect(0,0,e.width,e.height),t.globalCompositeOperation="destination-over",t.fillStyle=Rt(Fe.getColor("accent-color"),l,.9).toHexa(),t.fillRect(0,0,e.width,e.height),t.globalCompositeOperation="source-over";const u=s*this.windowStep/this.sampleRate,f=o*this.windowStep/this.sampleRate;if(this.app.chartManager.loadedChart){const d=this.app.chartManager.loadedChart.getBeatFromSeconds(u),h=this.app.chartManager.loadedChart.getBeatFromSeconds(Math.min(f,this.app.chartManager.chartAudio.getSongLength()));t.fillStyle="rgba(255, 255, 255, 0.2)";for(const[p,m]of this.app.chartManager.loadedChart.timingData.getMeasureBeats(d,h)){const g=this.app.chartManager.loadedChart.getSecondsFromBeat(p);t.fillRect(Kt(u,f,g)*Ut-(m?2:1),0,m?5:3,tt*1.5)}}t.fillStyle="rgba(255, 0, 0, 0.3)";for(let d=Math.floor(s);d<=Math.ceil(o);d++)this.peaks[d]&&t.fillRect(Kt(s,o,d)*Ut-.5,0,2,tt*1.5);t.fillStyle="rgba(50, 255, 20, 0.3)",t.fillRect(Ut*.2-1,0,3,tt*2),t.fillStyle="rgba(255, 0, 255, 0.5)",t.fillRect(0,tt*1.5-this._threshold*tt*.5,Ut,1);const c=Math.round(this.app.chartManager.time*this.sampleRate/this.windowStep/this.tempoStep);if(t.fillStyle=Fe.getColor("accent-color").toHex(),t.textAlign="right",t.textBaseline="top",t.font="22px Assistant",t.fillText(`${this.numRenderedBlocks}/${r} blocks rendered`,Ut-10,10),t.textAlign="right",t.textBaseline="middle",this.tempogramGroups[c]){const d=[];for(const h of this.tempogramGroups[c]){let p=0,m=0,g=0;for(let y=c-xr;y<=c+xr;y++){if(this.tempogramGroups[y]===void 0)continue;const x=this.tempogramGroups[y].find(w=>w.center<h.center+un&&w.center>h.center-un);x!==void 0&&(p+=x.groups[0].value,m+=x.avg,g++)}p/=g,m/=g,d.push({bpm:m,weight:h.groups[0].value,smoothedWeight:p})}d.sort((h,p)=>p.smoothedWeight-h.smoothedWeight);for(const h of d)h.weight<.01||(t.font=`${18+h.weight*300}px Assistant`,t.globalAlpha=Math.min(1,h.weight*100),t.fillText(fe(h.bpm,0)+"",200,Qe(tt*2,tt*1.5,Kt(Ln,Dn,h.bpm))));if(this.lastSecond!=this.app.chartManager.time){this.lastSecond=this.app.chartManager.time;const h=d.slice(0,5).reduce((p,m)=>p+m.smoothedWeight,0);for(let p=0;p<5;p++){const m=this.bpmRows[p],g=d[p]?.bpm,y=d[p]?.weight;m.classList.toggle("empty",g===void 0),m.firstChild.innerText=g===void 0?"-":Math.round(g).toString(),m.lastChild.innerText=y===void 0?"-":Math.round(y/h*100)+"%"}}}t.globalAlpha=1,t.font="22px Assistant",t.textAlign="left",t.textBaseline="top",t.fillText("Spectrogram",10,10),t.fillText("Onsets",10,tt+10),t.fillText("Tempogram",10,tt*1.5+10),e.closest("#windows")&&requestAnimationFrame(n)};return n}renderBlock(e){if(!this.monoAudioData)return;const t=new Float32Array(this.fftSize);t.set(this.monoAudioData.subarray(Math.max(0,e*this.windowStep-this.fftSize/2),e*this.windowStep+this.fftSize/2),-Math.min(0,e*this.windowStep-this.fftSize/2));for(let r=0;r<t.length;r++)t[r]*=.5*(1-Math.cos(Math.PI*2*(r/this.fftSize)));const n=Ec(t).slice(0);for(let r=0;r<n.length;r++)n[r]=Math.log(1+1*n[r]);this.storeResponse(e,n)}calcDifference(e){const t=this.spectrogram[e].slice(0),n=this.spectrogram[e-1]?.slice(0)??new Float64Array(this.fftSize);for(let r=0;r<t.length;r++)t[r]=Math.max(0,t[r]-n[r])*this.spectroWeights[r];this.storeDifferenceResponse(e,t)}storeResponse(e,t){this.spectrogram[e]=t;const n=this.spectrogramCanvases[Math.floor(e/Wt)].getContext("2d");n.fillStyle="white",t.forEach((r,a)=>{const s=this.spectroHeights[a],o=Se(r*2e3,0,255);n.globalAlpha=o/255,n.fillRect(e%Wt,s.y,1,s.height)}),n.globalAlpha=1}storeDifferenceResponse(e,t){this.spectrogramDifference[e]=t;const n=t.reduce((r,a)=>r+a,0);this.noveltyCurve[e]=n}calcIsolatedNovelty(e){for(let t=e-_s;t<=e;t++){if(t<0)continue;let n=0,r=0;for(let a=t-_s;a<=t+_s;a++)this.noveltyCurve[a]!==void 0&&(n+=this.noveltyCurve[a],r++);n/=r,this.storeIsolatedNovelty(t,Math.max(0,this.noveltyCurve[t]-n))}}storeIsolatedNovelty(e,t){this.noveltyCurveIsolated[e]=Math.log(1+t),Math.log(1+t)>this._threshold&&Math.log(1+t)>(this.noveltyCurveIsolated[e-1]??0)?(this.peaks[e-1]&&(this.peaks[e-1]=!1),this.peaks[e]=!0,this.onsetResults.innerText=`Found ${this.peaks.filter(a=>a).length} onsets`):this.peaks[e]=!1;const n=this.spectrogramCanvases[Math.floor(e/Wt)].getContext("2d"),r=Math.min(1,Math.log(1+t))*tt*.5;n.fillStyle="white",n.fillRect(e%Wt,tt*1.5-r,1,r)}async getMonoAudioData(){const e=this.app.chartManager.chartAudio;if(!e)return;const t=e.getBuffer(),n=new OfflineAudioContext(t.numberOfChannels,t.length,t.sampleRate),r=n.createBufferSource();r.buffer=t;const a=n.createChannelMerger(t.numberOfChannels);r.connect(a),a.connect(n.destination),r.start(),await n.startRendering().then(s=>{this.monoAudioData=s.getChannelData(0),this.audioLength=this.monoAudioData.length}).catch(()=>{ue.createFormatted("Failed to load audio: audio rendering failed","error")})}get threshold(){return this._threshold}set threshold(e){this._threshold=e,this.peaks=this.noveltyCurveIsolated.map((t,n)=>t>this._threshold&&(this.noveltyCurveIsolated[n-1]??0)<this._threshold),this.onsetResults.innerText=`Found ${this.peaks.filter(t=>t).length} onsets`}calculateOffset(){const e=new Map;let t=0,n=0,r=0;for(let u=0;u<this.tempogramGroups.length;u++){const c=this.tempogramGroups[u].filter(d=>d.groups[0].value>=km);if(c.length!=0&&(n=u,c.forEach(d=>{let h=0,p=0;for(let g=u-xr;g<=u+xr;g++){if(this.tempogramGroups[g]===void 0)continue;const y=this.tempogramGroups[g].find(x=>x.center<d.center+un&&x.center>d.center-un);y!==void 0&&(p+=y.avg,h++)}const m=Math.round(p/h);e.has(m)||e.set(m,0),e.set(m,e.get(m)+1),e.get(m)>t&&(t=e.get(m),r=m)}),t>50))break}if(r==0)return;const a=60/r*(this.sampleRate/this.windowStep),s=new Array(As).fill(0).map((u,f)=>{const c=f%a/a;let d=0,h=0;for(let p=1;p<=4;p++)h+=Math.max(1-Math.abs(Math.round(c*p)/p-c)*12,0)*1/p,d+=1/p;return h/d}),o=[];for(let u=n;u<n+a;u++){const f=this.noveltyCurveIsolated.slice(u,u+As).map((c,d)=>s[d]*c).reduce((c,d)=>c+d,0);o.push({block:u,offset:-(u*this.windowStep/this.sampleRate)%(60/r),response:f,curve:this.noveltyCurveIsolated.slice(u,u+As).map((c,d)=>s[d]*c)})}o.sort((u,f)=>f.response-u.response);const l=o.slice(0,5).reduce((u,f)=>u+f.response,0);this.offsetTableLabel.innerText=`Offsets (first BPM: ${r})`;for(let u=0;u<Math.min(o.length,5);u++){const f=this.offsetRows[u];f.classList.remove("empty"),f.firstChild.innerText=fe(o[u].offset,3).toString(),f.lastChild.innerText=Math.round(o[u].response/l*100)+"%"}}placeOnsets(e=!1){const t=this.peaks.map((n,r)=>{if(!n)return null;let a=this.app.chartManager.loadedChart.getBeatFromSeconds(r*this.windowStep/this.sampleRate);return a=Math.round(a*48)/48,a<0?null:{type:"Tap",beat:a,col:0}}).filter(n=>n!==null).filter(n=>e?n.beat>this.app.chartManager.startRegion&&n.beat<this.app.chartManager.endRegion:!0);this.app.chartManager.insertNotes(t)}calcTempogram(){let e=0;for(let s=0;s<this.noveltyCurveIsolated.length;s++)this.noveltyCurveIsolated[s]>e&&(e=this.noveltyCurveIsolated[s]);const t=new Float32Array(this.noveltyCurveIsolated.length);for(let s=0;s<this.noveltyCurveIsolated.length;s++)t[s]=this.noveltyCurveIsolated[s]/e;const n=Math.ceil(t.length/this.tempoStep);let r=performance.now();const a=s=>{const o=new Float32Array(this.tempoFftSize);o.set(t.subarray(Math.max(0,s*this.tempoStep-this.tempoFftSize/2),s*this.tempoStep+this.tempoFftSize/2),-Math.min(0,s*this.tempoStep-this.tempoFftSize/2));for(let u=0;u<o.length;u++)o[u]*=.5*(1-Math.cos(Math.PI*2*(u/this.tempoFftSize)));const l=Ec(o).slice(0);for(let u=0;u<l.length;u++)l[u]=Math.log(1+1*l[u]);this.storeTempogram(s,l),s<n?performance.now()-r<Cc?a(++s):(r=performance.now(),this.toggleButton.style.background=`linear-gradient(90deg, var(--accent-color) 0 ${s/n*100}%, var(--input-bg) ${s/n*100}% 100%)`,this.toggleButton.innerText=`Finding tempo (${fe(s/n*100,1)}%)`,setTimeout(()=>a(++s),1)):(this.calculateOffset(),this.spectrogram=[],this.noveltyCurve=[],this.tempogram=[],this.monoAudioData=void 0,this.toggleButton.innerText="Finished analyzing",this.resetButton.disabled=!1,this.doAnalysis=!1,this.toggleButton.style.background="var(--accent-color)")};a(0)}storeTempogram(e,t){const n=new Map,r=[];t.forEach((s,o)=>{let l=this.sampleRate*60/(this.windowStep*this.tempoFftSize)*o;if(!(l>Dn*4||l<Ln/4)){for(;l>Dn&&l!=1/0;)l/=2;for(;l<Ln&&l!=0;)l*=2;n.has(fe(l,3))||n.set(fe(l,3),0),n.set(fe(l,3),n.get(fe(l,3))+s)}}),this.tempogram[e]=[...n.entries()].map(([s,o])=>({bpm:s,value:o})).sort((s,o)=>o.value-s.value).filter(s=>s.value!=0);for(let s=0;s<Math.min(this.tempogram[e].length,10);s++){const o=this.tempogram[e][s],l=r.find(u=>u.center<o.bpm+un&&u.center>o.bpm-un);if(l===void 0){r.push({center:o.bpm,groups:[o]});continue}l.groups.push(o)}this.tempogramGroups[e]=r.map(s=>({...s,avg:s.groups.reduce((o,l)=>o+l.bpm*l.value,0)/s.groups.reduce((o,l)=>o+l.value,0)}));const a=this.spectrogramCanvases[Math.floor(e*this.tempoStep/Wt)].getContext("2d");a.fillStyle="white",this.tempogram[e].forEach(s=>{const o=Se(s.value*8e3,0,255);a.globalAlpha=o/255,a.fillRect(e*this.tempoStep%Wt,Qe(tt*2,tt*1.5,Kt(Ln,Dn,s.bpm)),1*this.tempoStep,tt*.5/(Dn-Ln))})}}class Ys extends ht{app;grid;actions={};constructor(e){super({title:"Themes",width:600,height:400,disableClose:!1,win_id:"theme-selection",blocking:!1}),this.app=e,this.initView(),this.loadGrid()}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-search");const n=document.createElement("input");n.classList.add("pref-search-bar"),n.type="text",n.placeholder="Search for a theme...",n.oninput=()=>{this.filterGrid(n.value)},t.appendChild(n);const r=document.createElement("div");r.classList.add("theme-grid"),this.grid=r;const a=this.createOptionTray();e.replaceChildren(t,r,a),this.viewElement.appendChild(e)}createOptionTray(){const e=document.createElement("div");e.classList.add("theme-tray");const t=document.createElement("button");t.appendChild(be.getIcon("PLUS",16)),t.appendChild(document.createTextNode("New")),t.onclick=()=>{const l=this.getNonConflictingName("new-theme");Fe.createUserTheme(l),Fe.loadTheme(l),this.loadGrid()},this.actions.add=t,e.appendChild(t);const n=document.createElement("button");n.appendChild(be.getIcon("COPY",16)),n.appendChild(document.createTextNode("Duplicate")),n.onclick=()=>{const l=this.getNonConflictingName(b.general.theme);Fe.createUserTheme(l,Fe.getCurrentTheme()),Fe.loadTheme(l),this.loadGrid()},n.disabled=!0,this.actions.copy=n,e.appendChild(n);const r=document.createElement("button");r.classList.add("confirm"),r.appendChild(be.getIcon("EDIT",16)),r.appendChild(document.createTextNode("Edit")),r.onclick=()=>{this.closeWindow(),this.app.windowManager.openWindow(new sr(this.app))},r.disabled=!0,this.actions.edit=r,e.appendChild(r);const a=document.createElement("button");a.classList.add("delete"),a.appendChild(be.getIcon("TRASH",16)),a.appendChild(document.createTextNode("Delete")),a.onclick=()=>{this.app.windowManager.openWindow(new vn(this.app,"Delete theme","Are you sure you want to delete this theme?",[{type:"default",label:"Cancel"},{type:"delete",label:"Delete",callback:()=>{Fe.deleteUserTheme(b.general.theme),this.loadGrid()}}]))},a.disabled=!0,this.actions.del=a,e.appendChild(a);const s=document.createElement("button");s.appendChild(be.getIcon("UPLOAD",16)),s.appendChild(document.createTextNode("Import")),s.onclick=async()=>{(await Wu({_preferPolyfill:!1,excludeAcceptAllOption:!1,multiple:!0,accepts:[{extensions:["txt"]}]})).forEach(u=>{u.getFile().then(f=>f.text()).then(f=>{const c=Fe.parseThemeText(f);let d=Lt(u.name,".txt");if(!c){ue.createFormatted("Failed to load theme "+d,"error");return}d=this.getNonConflictingName(d),Fe.createUserTheme(d,c),this.loadGrid()})})},this.actions.imp=s,e.appendChild(s);const o=document.createElement("button");return o.appendChild(be.getIcon("DOWNLOAD",16)),o.appendChild(document.createTextNode("Export")),o.onclick=()=>{const l=Fe.exportCurrentTheme({spaces:!0}),u=new File([l],b.general.theme+".txt",{type:"text/plain"}),f=document.createElement("a"),c=URL.createObjectURL(u);f.href=c,f.download=u.name,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(c)},this.actions.exp=o,o.disabled=!0,e.appendChild(o),e}loadGrid(){this.grid.replaceChildren();const e=Fe.getThemes();if(e)for(const[t,n]of Object.entries(e)){let r=t;const a=Yi[t]!==void 0,s=document.createElement("div"),o=document.createElement("div");if(o.classList.add("inlineEdit"),a)o.style.fontWeight="bold";else{o.contentEditable="true";let u=t;o.onfocus=()=>{u=o.innerText},o.onkeydown=f=>{f.key=="Enter"&&(o.blur(),f.preventDefault()),f.key=="Escape"&&(o.innerText=u,o.blur(),f.stopImmediatePropagation())},o.onblur=()=>{if(o.innerText==u)return;const f=this.getNonConflictingName(o.innerText);Fe.renameUserTheme(u,f),Fe.loadTheme(f),o.innerText=f,r=f,s.dataset.id=f}}const l=document.createElement("div");l.classList.add("theme-preview-grid");for(const u of of){const f=document.createElement("div");f.style.backgroundColor=n[u].toHex(),l.appendChild(f)}o.innerText=t,s.classList.add("theme-cell"),o.classList.add("theme-title"),s.replaceChildren(o,l),this.grid.appendChild(s),t==b.general.theme&&(s.classList.add("selected"),setTimeout(()=>{s.scrollIntoView({behavior:b.general.smoothAnimations?"smooth":"instant",block:"center"})}),this.actions.edit.disabled=a,this.actions.del.disabled=a,this.actions.copy.disabled=!1,this.actions.exp.disabled=!1),s.dataset.id=t,s.onclick=()=>{b.general.theme!=r&&(Fe.loadTheme(r),this.removeAllSelections(),s.classList.add("selected"),this.actions.edit.disabled=a,this.actions.del.disabled=a,this.actions.copy.disabled=!1,this.actions.exp.disabled=!1)}}}removeAllSelections(){[...this.grid.querySelectorAll(".selected")].forEach(e=>e.classList.remove("selected"))}filterGrid(e){[...this.grid.children].forEach(t=>{if(!(t instanceof HTMLDivElement))return;const n=t,r=this.containsQuery(e,n.dataset.id);n.style.display=r?"":"none"})}containsQuery(e,t){return t?t.toLowerCase().includes(e.trim().toLowerCase()):!1}getNonConflictingName(e){const t=Fe.getThemes();if(t[e]==null)return e;let n=2;const r=/([^]+)-(\d+)$/.exec(e);r&&(e=r[1],n=parseInt(r[2]));let a=`${e}-${n}`;for(;t[a]!==void 0;)a=`${e}-${n}`,n++;return a}}class sr extends ht{app;pickers={};handlers=[];linkBlacklist=new Set;static isOpen=!1;constructor(e){super({title:"Theme Color Editor",width:500,height:400,win_id:"theme-editor",disableClose:!0}),this.app=e,this.initView(),sr.isOpen=!0}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("theme-color-grid"),lf.forEach(l=>{t.appendChild(this.createGroup(l))});const n=document.createElement("div");n.classList.add("menu-options");const r=document.createElement("div");r.classList.add("menu-left");const a=document.createElement("div");a.classList.add("menu-right"),n.appendChild(r),n.appendChild(a);const s=document.createElement("button");s.innerText="Cancel",s.onclick=()=>{this.closeWindow(),Fe.loadTheme(b.general.theme),this.app.windowManager.openWindow(new Ys(this.app))},r.appendChild(s);const o=document.createElement("button");o.innerText="Save",o.classList.add("confirm"),o.onclick=()=>{Fe.setUserTheme(b.general.theme,Fe.getCurrentTheme()),Fe.loadTheme(b.general.theme),this.app.windowManager.openWindow(new Ys(this.app)),this.closeWindow()},a.appendChild(o),e.replaceChildren(t,n),this.viewElement.appendChild(e)}createGroup(e){const t=document.createElement("div");t.classList.add("theme-group");const n=document.createElement("div");n.classList.add("theme-group-label"),n.innerText=e.name;const r=document.createElement("div");return r.classList.add("theme-picker-grid"),e.ids.forEach(a=>{r.appendChild(this.createPicker(a))}),t.replaceChildren(n,r),t}createPicker(e){const t=()=>{const f=new B(Fe.getCurrentTheme()[e.id]);o.innerText=f.toHex()+" | "+Math.round(f.alpha*100)+"%",!l.isActive()&&(l.value=f)},n=f=>{const c=Fe.getCurrentTheme();c[e.id]=f,Fe._applyTheme(this.updateLinks(e.id,c))},r=document.createElement("div");r.classList.add("theme-color-cell"),Vl[e.id]!=""&&Ze(r,{content:Vl[e.id]});const a=as[e.id];a&&(r.onmouseover=()=>{Object.keys(a).forEach(f=>{this.linkBlacklist.has(f)||this.pickers[f].classList.add("linked")})},r.onmouseout=()=>{Object.keys(a).forEach(f=>{this.pickers[f].classList.remove("linked")})});const s=document.createElement("div");s.innerText=e.label;const o=document.createElement("div");o.classList.add("theme-color-detail");const l=ia.create({value:"white",width:30,height:30});l.onColorChange=n,r.replaceChildren(s,o,l);const u=this.getLink(e.id);if(u!==null){const f=document.createElement("div");f.classList.add("ico-checkbox");const c=be.getIcon("LINK",16),d=be.getIcon("LINK_BROKEN",16);let h=!0;const p=()=>{h?this.linkBlacklist.delete(e.id):this.linkBlacklist.add(e.id),c.style.display=h?"":"none",d.style.display=h?"none":""};f.onclick=()=>{h=!h,p()},Ze(f,{onShow(g){g.setContent(h?`Linked to ${u}`:"Unlinked")}}),Ze(f,{trigger:"click",onShow(g){g.setContent(h?`Linked to ${u}`:"Unlinked")}}),p(),f.replaceChildren(c,d),r.appendChild(f);const m=g=>{h&&(h=!1,p()),n(g)};l.onColorChange=m}return t(),ee.on("themeChanged",t),this.handlers.push(t),this.pickers[e.id]=r,r}getLink(e){for(const[t,n]of Object.entries(as))if(e in n)return t;return null}average(e){return(e.red+e.green+e.blue)/3}lighten(e,t){return new B(bo(new B(e).toNumber(),1+t/100))}add(e,t){return new B(cf(new B(e).toNumber(),t))}updateLinks(e,t){const n=new Set,r=[e];for(;r.length!=0;){const a=r.shift(),s=as[a];if(s)for(const[o,l]of Object.entries(s))this.linkBlacklist.has(o)||n.has(o)||(t[o]=l.bind(this)(t[a]),r.push(o),n.add(o))}return t}onClose(){sr.isOpen=!1}}const Dr={precision:Vc,minPrecision:Si,value:0};function dn(i){return{create:function(e){const t=pt.create({...Dr,value:0,min:i=="WARPS"?0:-Number.MAX_VALUE,onchange:n=>{const r=e.chartManager.loadedChart.timingData,a=Math.round(e.chartManager.beat*48)/48;if(n==null){r.deleteColumnEvents([{type:i,beat:a}]);return}r.insertColumnEvents([{type:i,beat:a,value:n}])}});return this.data=[t],t.view},update:function(e,t){const n=this.data[0];if(document.activeElement==n.input)return;n.value=e.getOffset();const r=e.getEventAtBeat(i,t);let a=r?.value??0;pd.getColumnType(i)=="instant"&&(!r||Math.abs(r.beat-t)>1/48)&&(a=0),n.value=a}}}const _c={offset:{title:"Offset",element:{create:function(i){const e=pt.create({...Dr,step:b.general.spinnerStep/100,onchange:t=>{const n=i.chartManager.loadedChart.timingData;t!=null&&(n.hasChartOffset()?n.setOffset(t):n.songTimingData.setOffset(t))}});return this.data.push(e),e.view},update:function(i){const e=this.data[0];document.activeElement!=e.input&&(e.value=i.getOffset())}}},bpm:{title:"BPM",element:dn("BPMS")},stop:{title:"Stop",element:dn("STOPS")},delay:{title:"Delay",element:dn("DELAYS")},warp:{title:"Warp",element:dn("WARPS")},timeSig:{title:"Time Sig.",element:{create:function(i){const e=document.createElement("div");e.classList.add("flex-column-gap");const t=pt.create({value:4,step:1,precision:0,min:1,onchange:r=>{const a=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(r==null){a.deleteColumnEvents([{type:"TIMESIGNATURES",beat:s}]);return}r<1||a.insertColumnEvents([{type:"TIMESIGNATURES",beat:s,upper:r,lower:n.value}])}}),n=pt.create({value:4,step:1,precision:0,min:1,onchange:r=>{const a=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(r==null){a.deleteColumnEvents([{type:"TIMESIGNATURES",beat:s}]);return}r<1||a.insertColumnEvents([{type:"TIMESIGNATURES",beat:s,upper:t.value,lower:r}])}});return e.appendChild(t.view),e.appendChild(n.view),this.data=[t,n],e},update:function(i,e){const t=this.data[0],n=this.data[1],r=i.getEventAtBeat("TIMESIGNATURES",e),a=r?.upper??4,s=r?.lower??4;document.activeElement!=t.input&&(t.value=Math.round(a)),document.activeElement!=n.input&&(n.value=Math.round(s))}}},tick:{title:"Tickcount",element:{create:function(i){const e=pt.create({value:4,step:1,precision:0,min:0,onchange:t=>{const n=i.chartManager.loadedChart.timingData,r=Math.round(i.chartManager.beat*48)/48;if(t==null){n.deleteColumnEvents([{type:"TICKCOUNTS",beat:r}]);return}t<0||n.insertColumnEvents([{type:"TICKCOUNTS",beat:r,value:t}])}});return this.data=[e],e.view},update:function(i,e){const t=this.data[0];if(document.activeElement==t.input)return;const n=i.getEventAtBeat("TICKCOUNTS",e)?.value??4;t.value=Math.round(n)}}},combo:{title:"Combo",element:{create:function(i){const e=document.createElement("div");e.classList.add("flex-column-gap");const t=pt.create({value:1,step:1,precision:0,min:0,onchange:r=>{const a=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(r==null){a.deleteColumnEvents([{type:"COMBOS",beat:s}]);return}r<0||a.insertColumnEvents([{type:"COMBOS",beat:s,hitMult:r,missMult:n.value}])}}),n=pt.create({value:1,step:1,precision:0,min:0,onchange:r=>{const a=i.chartManager.loadedChart.timingData,s=Math.round(i.chartManager.beat*48)/48;if(r==null){n.value=i.chartManager.loadedChart?.timingData.getEventAtBeat("COMBOS",s)?.missMult??1;return}r<0||a.insertColumnEvents([{type:"COMBOS",beat:s,hitMult:t.value,missMult:r}])}});return e.appendChild(t.view),e.appendChild(n.view),this.data=[t,n],e},update:function(i,e){const t=this.data[0],n=this.data[1],r=i.getEventAtBeat("COMBOS",e),a=r?.hitMult??1,s=r?.missMult??1;document.activeElement!=t.input&&(t.value=Math.round(a)),document.activeElement!=n.input&&(n.value=Math.round(s))}}},speed:{title:"Speed",element:{create:function(i){const e=document.createElement("div");e.classList.add("flex-column-gap");const t=()=>{const s=i.chartManager.loadedChart.timingData,o=Math.round(i.chartManager.beat*48)/48;s.insertColumnEvents([{type:"SPEEDS",beat:o,value:n.value,delay:r.value,unit:a.value=="Beats"?"B":"T"}])},n=pt.create({...Dr,value:1,step:.1,onchange:s=>{const o=i.chartManager.loadedChart.timingData,l=Math.round(i.chartManager.beat*48)/48;if(s==null){o.deleteColumnEvents([{type:"SPEEDS",beat:l}]);return}t()}}),r=pt.create({...Dr,value:1,step:.1,min:0,onchange:s=>{s==null||s<0||t()}}),a=gi.create(["Beats","Time"],"Beats");return a.onChange(t),e.appendChild(n.view),e.appendChild(r.view),e.appendChild(a.view),this.data=[n,r,a],e},update:function(i,e){const t=this.data[0],n=this.data[1],r=this.data[2],a=i.getEventAtBeat("SPEEDS",e),s=a?.value??1,o=a?.delay??0,l=a?.unit=="B"?"Beats":"Time";document.activeElement!=t.input&&(t.value=s),document.activeElement!=n.input&&(n.value=o);const u=a&&Math.abs(a.beat-e)<1/48;n.disabled=!u,r.value!=l&&r.setSelected(l),r.disabled=!u}}},scroll:{title:"Scroll",element:dn("SCROLLS")},fake:{title:"Fake",element:dn("FAKES")},label:{title:"Label",element:{create:function(i){const e=document.createElement("input");return e.type="text",e.autocomplete="off",e.spellcheck=!1,e.onkeydown=t=>{t.key=="Enter"&&e.blur()},e.onblur=()=>{const t=i.chartManager.loadedChart.timingData,n=Math.round(i.chartManager.beat*48)/48;if(e.value==""){t.deleteColumnEvents([{type:"LABELS",beat:n}]);return}t.insertColumnEvents([{type:"LABELS",beat:n,value:e.value}])},this.data=[e],e},update:function(i,e){const t=this.data[0];if(document.activeElement==t)return;const r=i.getEventAtBeat("LABELS",e)?.value??"";t.value!=r&&(t.value=r)}}}};class Tm extends ht{app;lastBeat;interval;changeHandler=()=>this.setData();data={};constructor(e){super({title:"Edit Timing Data",width:300,height:340,disableClose:!1,win_id:"timing_data",blocking:!1}),this.app=e,this.lastBeat=Math.round(this.app.chartManager.beat*1e3)/1e3,this.initView(),this.interval=setInterval(()=>{Math.round(this.app.chartManager.beat*1e3)/1e3!=this.lastBeat&&(this.lastBeat=Math.round(this.app.chartManager.beat*1e3)/1e3,this.setData())},17),ee.on("timingModified",this.changeHandler),ee.on("chartLoaded",this.changeHandler)}onClose(){ee.off("timingModified",this.changeHandler),clearInterval(this.interval)}initView(){this.viewElement.replaceChildren(),this.viewElement.classList.add("timing-data");const e=document.createElement("div");e.classList.add("padding"),Object.values(_c).forEach(t=>{const n=document.createElement("div");n.classList.add("label"),n.innerText=t.title,this.data[t.title]={data:[]};const r=t.element.create.bind(this.data[t.title])(this.app);e.appendChild(n),e.appendChild(r)}),this.viewElement.appendChild(e),this.setData()}setData(){this.app.chartManager.loadedChart&&Object.values(_c).forEach(e=>{e.element.update.bind(this.data[e.title])(this.app.chartManager.loadedChart.timingData,this.lastBeat)})}}const Ac=[{type:"group",id:"app",label:"App",disable:()=>window.nw===void 0,children:[{type:"subgroup",children:[{type:"item",label:"Window Width",id:"app.width",input:{type:"number",step:50,min:300,precision:0,onChange:(i,e)=>{const t=nw.Window.get();t.isFullscreen||(t.width=e)}}},{type:"item",label:"Window Height",id:"app.height",input:{type:"number",step:50,min:300,precision:0,onChange:(i,e)=>{const t=nw.Window.get();t.isFullscreen||(t.height=e)}}}]},{type:"subgroup",children:[{type:"item",label:"Fullscreen",id:"app.fullscreen",input:{type:"checkbox",onChange:(i,e)=>{const t=nw.Window.get();e?nw.Window.get().enterFullscreen():(t.hide(),nw.Window.get().leaveFullscreen(),t.show())}}}]}]},{type:"group",id:"general",label:"General",children:[{type:"subgroup",children:[{type:"item",label:"UI Scale",id:"general.uiScale",input:{type:"number",min:30,step:10,precision:0,max:200,transformers:{serialize:i=>i*100,deserialize:i=>i/100},onChange:(i,e)=>{document.body.parentElement.style.fontSize=e*100+"%"}}},{type:"item",label:"Smooth Animations",id:"general.smoothAnimations",input:{type:"checkbox",onChange:(i,e)=>{e?document.body.classList.add("animated"):document.body.classList.remove("animated")}}}]},{type:"subgroup",children:[{type:"item",label:"Auto-load SSC files",id:"general.loadSSC",input:{type:"dropdown",items:["Prompt","Always","Never"],advanced:!1},tooltip:"Automatically select .ssc files instead of .sm files when available."},{type:"item",label:"Autosave interval",id:"general.autosaveInterval",input:{type:"slider",min:30,step:5,max:600,hardMin:15,hardMax:2**31-1},tooltip:"Interval in seconds between autosaves"},{type:"item",label:"Warn before exit",id:"general.warnBeforeExit",input:{type:"checkbox"},tooltip:"Warn before exiting the editor if you have unsaved changes."}]},{type:"subgroup",children:[{type:"item",label:"Spinner step",id:"general.spinnerStep",input:{type:"slider",min:0,step:.1,max:5,hardMin:0,hardMax:2**31-1},tooltip:"The default increment for all number spinners."}]}]},{type:"group",id:"editing",label:"Editing",children:[{type:"subgroup",label:"Note Placement",children:[{type:"subgroup",children:[{type:"item",label:"Enable mouse placement",id:"chart.mousePlacement",input:{type:"checkbox"}},{type:"item",label:"Directional hold placement behavior",id:"chart.defaultHoldPlacement",input:{type:"checkbox"},tooltip:"Changes the hold placement behavior. By default, holds can only be extended in one direction when placed. Turn this off to mimic the behavior of AV/Stepmania."},{type:"item",label:"Force snap notes",id:"chart.forceSnapNotes",input:{type:"checkbox"},tooltip:"Placing a note when not on a snap will force the note to be placed on the next snap. Useful for placing notes when playing."}]}]},{type:"subgroup",label:"Parity",children:[{type:"item",label:"Enabled",id:"chart.parity.enabled",input:{type:"checkbox"}},{type:"item",label:"Show note highlights",id:"chart.parity.showHighlights",input:{type:"checkbox"}},{type:"item",label:"Show tech notation",id:"chart.parity.showTech",input:{type:"checkbox"}},{type:"item",label:"Highlight candles",id:"chart.parity.showCandles",input:{type:"checkbox"}},{type:"item",label:"Show tech errors",id:"chart.parity.showErrors",input:{type:"checkbox"}},{type:"item",label:"Show dancing bot",id:"chart.parity.showDancingBot",input:{type:"checkbox"}},{type:"subgroup",label:"Colors",children:[{type:"item",label:"Left (heel)",id:"chart.parity.leftHeelColor",input:{type:"color"}},{type:"item",label:"Left Toe",id:"chart.parity.leftToeColor",input:{type:"color"}},{type:"item",label:"Right (heel)",id:"chart.parity.rightHeelColor",input:{type:"color"}},{type:"item",label:"Right Toe",id:"chart.parity.rightToeColor",input:{type:"color"}}]}]}]},{type:"group",id:"view",label:"View",children:[{type:"subgroup",children:[{type:"item",label:"Zoom",id:"chart.zoom",input:{type:"slider",min:50,step:1,max:200,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},{type:"item",label:"Reverse playfield",id:"chart.reverse",input:{type:"checkbox"}}]},{type:"subgroup",children:[{type:"item",label:"Allow receptor dragging",id:"chart.allowReceptorDrag",input:{type:"checkbox"},tooltip:"Allows the receptors to be dragged to move the playfield."},{type:"item",label:"X position",id:"chart.receptorXPos",input:{type:"slider",min:-400,max:400,hardMin:-2147483647,hardMax:2**31-1}},{type:"item",label:"Y position",id:"chart.receptorYPos",input:{type:"slider",min:-400,max:0,hardMin:-2147483647,hardMax:2**31-1}}]},{type:"subgroup",children:[{type:"item",label:"Draw length",id:"chart.maxDrawBeats",input:{type:"slider",min:0,max:30,hardMax:2**31-1},tooltip:"Maximum number of beats to draw notes. Increasing this works well for songs with high bpm but can affect performance. Only applies to XMod."},{type:"item",label:"Draw length past receptors",id:"chart.maxDrawBeatsBack",input:{type:"slider",min:0,max:30,hardMax:2**31-1},tooltip:"Maximum number of beats to draw notes past the receptors. Increasing this can affect performance. Only applies to XMod."}]},{type:"subgroup",children:[{type:"item",label:"Draw noteflashes",id:"chart.drawNoteFlash",input:{type:"checkbox"}},{type:"item",label:"Draw note icons",id:"chart.drawIcons",input:{type:"checkbox"},tooltip:"Draw indicators above notes that some noteskins may not differentiate, like Fakes and Lifts."}]},{type:"subgroup",label:"Scrolling",children:[{type:"item",label:"Scroll sensitivity",id:"chart.scroll.scrollSensitivity",input:{type:"slider",min:0,step:1,max:200,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}},tooltip:"Adjust the scroll sensitivity when scrolling through the chart."},{type:"item",label:"Snap every scroll",id:"chart.scroll.scrollSnapEveryScroll",input:{type:"checkbox"},tooltip:"Whether each scroll movement corresponds to moving one snap unit when scrolling. Turning this on will have the same behavior as ArrowVortex. Recommended on for those using a mouse, off for those using trackpad."},{type:"item",label:"Invert scroll direction",id:"chart.scroll.invertScroll",input:{type:"checkbox"}},{type:"item",label:"Invert zoom in/out",id:"chart.scroll.invertZoomScroll",input:{type:"checkbox"},tooltip:"Inverts the zoom in/out control when scrolling."},{type:"item",label:"Invert scroll direction when in reverse",id:"chart.scroll.invertReverseScroll",input:{type:"checkbox"}}]},{type:"subgroup",label:"Waveform",children:[{type:"item",label:"Draw waveform",id:"chart.waveform.enabled",input:{type:"checkbox"}},{type:"subgroup",children:[{type:"item",label:"Color",id:"chart.waveform.color",input:{type:"color"}}]},{type:"subgroup",children:[{type:"item",label:"Draw filtered waveform",id:"chart.waveform.allowFilter",input:{type:"checkbox"}},{type:"item",label:"Filtered color",id:"chart.waveform.filteredColor",input:{type:"color"}}]},{type:"item",label:"Line height",id:"chart.waveform.lineHeight",input:{type:"slider",min:1,max:3,step:.1,hardMax:100},tooltip:"The height of each line of the waveform. Increasing this can help performance."},{type:"item",label:"Antialiasing",id:"chart.waveform.antialiasing",input:{type:"checkbox"}},{type:"item",label:"Allow speed changes",id:"chart.waveform.speedChanges",input:{type:"checkbox"},tooltip:"Allows the waveform to be affected by SPEEDS and SCROLLS."}]}]},{type:"group",id:"timelines",label:"Timelines",children:[{type:"item",label:"Follow current position",id:"chart.layoutFollowPosition",input:{type:"checkbox"},tooltip:"Change whether layouts show the entire song or range around the cursor."},{type:"subgroup",label:"Notes",children:[{type:"item",label:"Enabled",id:"chart.noteLayout.enabled",input:{type:"checkbox"}}]},{type:"subgroup",label:"Player Direction",children:[{type:"item",label:"Enabled",id:"chart.facingLayout.enabled",input:{type:"checkbox"}}]},{type:"subgroup",label:"Density",children:[{type:"item",label:"Enabled",id:"chart.npsGraph.enabled",input:{type:"checkbox"}},{type:"subgroup",children:[{type:"item",label:"Start Color",id:"chart.npsGraph.color1",input:{type:"color"}},{type:"item",label:"End Color",id:"chart.npsGraph.color2",input:{type:"color"}}]}]}]},{type:"group",id:"audio",label:"Audio",children:[{type:"subgroup",children:[{type:"item",label:"Master volume",id:"audio.masterVolume",input:{type:"slider",min:0,step:1,max:100,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},{type:"item",label:"Song volume",id:"audio.songVolume",input:{type:"slider",min:0,step:1,max:100,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}},{type:"item",label:"Sound effect volume",id:"audio.soundEffectVolume",input:{type:"slider",min:0,step:1,max:100,hardMax:2**31-1,transformers:{serialize:i=>i*100,deserialize:i=>i/100}}}]},{type:"subgroup",children:[{type:"item",label:"Enable assist tick",id:"audio.assistTick",input:{type:"checkbox"},tooltip:"Plays a sound when a note passes the receptors"},{type:"item",label:"Enable metronome",id:"audio.metronome",input:{type:"checkbox"}}]},{type:"subgroup",children:[{type:"item",label:"Allow filters to affect audio",id:"audio.allowFilter",input:{type:"checkbox",onChange:i=>{i.chartManager.chartAudio.reload()}}}]}]},{type:"group",id:"play",label:"Playtesting",children:[{type:"subgroup",label:"Calibration",children:[{type:"item",label:"Global offset",id:"play.offset",input:{type:"slider",min:-1,step:.001,max:1,hardMin:-2147483647,hardMax:2**31-1},tooltip:"Offset in seconds when playing a chart. Set to positive if you are hitting early and negative if you are hitting late."},{type:"item",label:"Sound effect offset",id:"play.effectOffset",input:{type:"slider",min:-1,step:.001,max:1,hardMin:-2147483647,hardMax:2**31-1},tooltip:"Offset in seconds when playing sound effects like assist tick and metronome."},{type:"item",label:"Visual offset",id:"play.visualOffset",input:{type:"slider",min:-1,step:.001,max:1,hardMin:-2147483647,hardMax:2**31-1},tooltip:"Offset in seconds when displaying notes."}]},{type:"subgroup",children:[{type:"item",label:"Judgement tilt",id:"play.judgementTilt",input:{type:"checkbox"},tooltip:"Tilts the judgement text left if you are hitting early and right if you are hitting late."},{type:"item",label:"Hide edit GUI during play",id:"play.hideBarlines",input:{type:"checkbox"}}]},{type:"subgroup",label:"Timing windows",children:[{type:"item",id:"play.timingCollection",label:"Timing window collection",input:{type:"dropdown",advanced:!1,get items(){return Object.keys(kt.getCollections())},onChange(i,e){const t=i.chartManager.loadedChart?.gameType.id;if(t)for(const n of Object.keys(b.play.defaultTimingCollections))t.startsWith(n)&&(b.play.defaultTimingCollections[n]=e)}}},{type:"item",id:"play.timingWindowScale",label:"Timing window scale",input:{type:"slider",min:0,step:.001,max:2,hardMax:2**31-1},tooltip:"Scales all timing windows by the given amount."},{type:"item",id:"play.timingWindowAdd",label:"Timing window add",input:{type:"slider",min:0,step:.001,max:1,hardMax:2**31-1},tooltip:"Adds this value (in seconds) to all timing windows."}]}]},{type:"group",id:"performance",label:"Performance",children:[{type:"item",label:"Antialiasing",id:"performance.antialiasing",input:{type:"checkbox"}},{type:"item",label:"Resolution",id:"performance.resolution",input:{type:"slider",min:1,step:1,max:4,hardMin:0,hardMax:2**31-1},tooltip:"Requires a reload."}]},{type:"group",id:"debug",label:"Debug",children:[{type:"item",label:"Show FPS",id:"debug.showFPS",input:{type:"checkbox"}},{type:"item",label:"Show rendering timers",id:"debug.showTimers",input:{type:"checkbox"}},{type:"item",label:"Show noteskin errors",id:"debug.showNoteskinErrors",input:{type:"checkbox"}},{type:"item",label:"Show scrolls/speeds debug visual",id:"debug.showScroll",input:{type:"checkbox"}},{type:"subgroup",label:"Parity",children:[{type:"item",label:"Show parity graph",id:"debug.parity.showGraph",input:{type:"checkbox"}},{type:"item",label:"Show debug stats",id:"debug.parity.showDebug",input:{type:"checkbox"}},{type:"item",label:"Limit graph nodes",tooltip:"Limits the number of nodes in each row of the parity graph to 8.",id:"debug.parity.limitGraph",input:{type:"checkbox"}}]}]}];class Sm extends ht{app;observer;sectionContainer;constructor(e){super({title:"Options",width:600,height:400,disableClose:!1,win_id:"user_options",blocking:!1}),this.app=e,this.initView(),ee.on("resize",()=>{this.center()})}initView(){this.viewElement.replaceChildren();const e=document.createElement("div");e.classList.add("padding");const t=document.createElement("div");t.classList.add("pref-container");const n=document.createElement("div");n.classList.add("pref-search");const r=document.createElement("input");r.classList.add("pref-search-bar"),r.type="text",r.placeholder="Search for an option...",r.oninput=()=>{s.replaceChildren(),o.replaceChildren(...this.createOptions(this.filterOptions(r.value)))},n.appendChild(r);const a=document.createElement("div");a.classList.add("pref-scrollers");const s=document.createElement("div");s.classList.add("pref-section-scroller"),this.sectionContainer=s;const o=document.createElement("div");o.classList.add("pref-option-scroller"),a.replaceChildren(s,o),this.observer=new IntersectionObserver(l=>{l.forEach(u=>{const f=u.target.dataset.id,c=s.querySelector(`.pref-section[data-id=${f}]`);c&&(u.intersectionRatio>0?c.classList.add("selected"):c.classList.remove("selected"))})},{}),t.replaceChildren(n,a),s.replaceChildren(),o.replaceChildren(...this.createOptions(Ac)),e.appendChild(t),this.viewElement.appendChild(e)}createOptions(e){return e.filter(t=>!t.disable?.(this.app)).map(t=>{const n=this.makeOption(t);return t.type=="group"&&(this.observer.observe(n),this.sectionContainer?.appendChild(this.createEmptyGroup(t))),n})}makeOption(e){const t=document.createElement("div");t.classList.add("pref-"+e.type),(e.type=="group"||e.type=="item")&&(t.dataset.id=e.id);const n=document.createElement("div");n.classList.add(`pref-${e.type}-label`,"label"),e.label!==void 0&&(n.innerText=e.label,t.appendChild(n));const r=be.getIcon("REVERT",12);if(e.type=="item"&&(r.addEventListener("click",()=>{b.applyOption([e.id,b.getDefaultOption(e.id)]);const a=e.input.onChange;a?.(this.app,b.getDefaultOption(e.id)),t.replaceWith(this.makeOption(e))}),r.style.display=b.getDefaultOption(e.id)===b.getOption(e.id)?"none":"block",t.appendChild(r)),e.type=="item"){if(n.innerText=e.label,!e.input)return t;const a=b.getOption(e.id),s={...e.input},o=s.onChange;s.onChange=(u,f)=>{b.applyOption([e.id,f]),r.style.display=b.getDefaultOption(e.id)===b.getOption(e.id)?"none":"block",o?.(u,f)};const l=gu(this.app,s,a);e.input.type=="checkbox"&&l.classList.add("pref-input","right"),e.input.type=="dropdown"&&l.classList.add("pref-input","dropdown-right"),l.classList.add("pref-item-input"),t.appendChild(l)}else{const a=document.createElement("div");a.classList.add("pref-children"),t.appendChild(a),a.replaceChildren(...this.createOptions(e.children))}return e.type=="item"&&e.tooltip!==void 0&&Ze(t,{content:e.tooltip}),t}filterOptions(e,t=Ac){const n=[];return t.forEach(r=>{if(r.label&&r.label.toLowerCase().includes(e.toLowerCase())){n.push(r);return}if(r.type=="group"||r.type=="subgroup"){const a=this.filterOptions(e,r.children);a.length!=0&&n.push({...r,children:a})}}),n}createEmptyGroup(e){const t=document.createElement("div");return t.classList.add("pref-section"),t.dataset.id=e.id,t.innerText=e.label,t.onclick=()=>{t.parentElement.parentElement.querySelector(`.pref-group[data-id=${e.id}]`).scrollIntoView()},t}onClose(){this.observer?.disconnect()}}var On=(i=>(i.SHIFT="Shift",i.CTRL="Ctrl",i.ALT="Alt",i.META="Command",i))(On||{});const at=ii?"Command":"Ctrl",Mm={Shift:ii?"⇧":"Shift",Ctrl:ii?"⌃":"Ctrl",Alt:ii?"⌥":"Alt",Command:"⌘"},kc={ArrowLeft:"Left",ArrowUp:"Up",ArrowRight:"Right",ArrowDown:"Down",BracketLeft:"[",BracketRight:"]",Semicolon:";",Quote:"'",Backslash:"\\",Slash:"/",Period:".",Comma:",",Backquote:"`",Minus:"-",Equal:"+"},Ju={Home:ii?"fn Left":"Home",End:ii?"fn Right":"End",PageUp:ii?"fn Up":"PageUp",PageDown:ii?"fn Down":"PageDown"},Gr=["ctrlKey","altKey","shiftKey","metaKey"],Br=["Ctrl","Alt","Shift","Command"],Ne={playback:{label:"Play/Pause",combos:[{key:"Space",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.playPause()},decreaseSnap:{label:"Decrease snap",combos:[{key:"Left",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.previousSnap()},increaseSnap:{label:"Increase snap",combos:[{key:"Right",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.nextSnap()},cursorUp:{label:"Move cursor up",combos:[{key:"Up",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>{b.chart.scroll.invertReverseScroll&&b.chart.reverse?i.chartManager.snapToNextTick():i.chartManager.snapToPreviousTick()}},cursorDown:{label:"Move cursor down",combos:[{key:"Down",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>{b.chart.scroll.invertReverseScroll&&b.chart.reverse?i.chartManager.snapToPreviousTick():i.chartManager.snapToNextTick()}},increaseScrollSpeed:{label:"Increase scroll speed",combos:[{key:"Up",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView,callback:()=>b.chart.speed=Math.max(10,b.chart.speed*Math.pow(1.01,30))},decreaseScrollSpeed:{label:"Decrease scroll speed",combos:[{key:"Down",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView,callback:()=>b.chart.speed=Math.max(10,b.chart.speed*Math.pow(1.01,-30))},zoomIn:{label:"Zoom in",combos:[{key:"+",mods:[at]}],disabled:i=>!i.chartManager.chartView,callback:()=>{b.chart.zoom+=.1,ue.create("Zoom: "+Math.round(b.chart.zoom*100)+"%")}},zoomOut:{label:"Zoom out",combos:[{key:"-",mods:[at]}],disabled:i=>!i.chartManager.chartView,callback:()=>{b.chart.zoom=Math.max(.1,b.chart.zoom-.1),ue.create("Zoom: "+Math.round(b.chart.zoom*100)+"%")}},zoomDefault:{label:"Reset zoom",combos:[{key:"0",mods:[at]}],disabled:i=>!i.chartManager.chartView,callback:()=>{b.chart.zoom=1,ue.create("Zoom: "+Math.round(b.chart.zoom*100)+"%")}},newSong:{label:"New song...",bindLabel:"New song",combos:[{key:"N",mods:[at]}],disabled:i=>!i.chartManager.loadedSM||!pe.openWindows,callback:i=>{i.windowManager.openWindow(new Zu(i))}},openSong:{label:"Open song...",bindLabel:"Open song",combos:[{key:"O",mods:[at]}],disabled:i=>!i.chartManager.loadedSM||!pe.openWindows,callback:i=>{if(window.nw){const e=document.createElement("input");e.type="file",e.accept=".sm,.ssc",e.onchange=()=>i.chartManager.loadSM(e.value),e.click()}else i.windowManager.openWindow(new Lo(i,!1))}},songProperties:{label:"Song properties...",bindLabel:"Open song properties",combos:[{key:"O",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedSM||!pe.openWindows,callback:i=>i.windowManager.openWindow(new Cm(i))},save:{label:"Save...",bindLabel:"Save",combos:[{key:"S",mods:[at]}],disabled:i=>!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>i.chartManager.save()},export:{label:"Save and export current song",combos:[{key:"E",mods:[at]}],visible:()=>!window.nw,disabled:i=>!!window.nw||!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>{i.chartManager.save(),Ce.getStandardHandler().saveDirectory(i.chartManager.smPath)}},exportNotedata:{label:"Export to notedata...",bindLabel:"Export to notedata",combos:[{key:"E",mods:[at,"Shift"]}],disabled:i=>!i.chartManager.loadedSM||!pe.openWindows,callback:i=>i.windowManager.openWindow(new bm(i,i.chartManager.selection.notes))},capture:{label:"Export video...",combos:[],disabled:i=>!i.chartManager.loadedSM||!pe.openWindows,callback:i=>{i.windowManager.openWindow(new uf(i))}},previousSong:{label:"Previous song in pack",combos:[{key:"F5",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>{const e=Ce.getStandardHandler();if(!e)return;const t=e.resolvePath(ot(i.chartManager.smPath),"..");async function n(){const r=await e.getDirectoryFolders(t);r.sort((s,o)=>s.name.localeCompare(o.name));let a=r.findIndex(s=>s.name==Lt(ot(i.chartManager.smPath)));if(a==-1){ue.createFormatted("An error occured while finding the song pack!","error"),console.error(`Couldn't find the current song idx in parent folder! Path: ${Lt(ot(i.chartManager.smPath))}, Folders`,r);return}for(a--;a>=0;){const s=r[a],o=await e.getDirectoryFiles(s),l=o.find(u=>u.name.endsWith(".ssc"))??o.find(u=>u.name.endsWith(".sm"));if(l){const u=e.resolvePath(t,s.name,l.name);ue.create(`Loading ${s.name}/${l.name}`),i.chartManager.loadSM(u);return}a--}ue.create("No previous song in pack")}try{n()}catch(r){ue.createFormatted("No songs found!","error"),console.error(r)}}},nextSong:{label:"Next song in pack",combos:[{key:"F6",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedSM||i.chartManager.smPath.startsWith("https://")||i.chartManager.smPath.startsWith("http://"),callback:i=>{const e=Ce.getStandardHandler();if(!e)return;const t=e.resolvePath(ot(i.chartManager.smPath),"..");async function n(){const r=await e.getDirectoryFolders(t);r.sort((s,o)=>s.name.localeCompare(o.name));let a=r.findIndex(s=>s.name==Lt(ot(i.chartManager.smPath)));if(a==-1){ue.createFormatted("An error occured while finding the song pack!","error"),console.error(`Couldn't find the current song idx in parent folder! Path: ${Lt(ot(i.chartManager.smPath))}, Folders`,r);return}for(a++;a<r.length;){const s=r[a],o=await e.getDirectoryFiles(s),l=o.find(u=>u.name.endsWith(".ssc"))??o.find(u=>u.name.endsWith(".sm"));if(l){const u=e.resolvePath(t,s.name,l.name);ue.create(`Loading ${s.name}/${l.name}`),i.chartManager.loadSM(u);return}a++}ue.create("No next song in pack")}try{n()}catch(r){ue.createFormatted("No songs found!","error"),console.error(r)}}},openChart:{label:"Chart list",bindLabel:"Open chart list",combos:[{key:"O",mods:[at,"Shift"]}],disabled:i=>!i.chartManager.loadedSM||!pe.openWindows,callback:i=>i.windowManager.openWindow(new $u(i))},timingDataRow:{label:"Edit timing data at row",combos:[{key:"T",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView||!pe.openWindows,callback:i=>i.windowManager.openWindow(new Tm(i))},selectRegion:{label:"Select region",combos:[{key:"Tab",mods:[]}],disabled:i=>!i.chartManager.loadedChart&&i.chartManager.getMode()!=U.Edit,callback:i=>i.chartManager.selectRegion()},volumeUp:{label:"Increase master volume",combos:[{key:"Up",mods:["Alt"]}],disabled:!1,callback:()=>{b.audio.masterVolume=Math.min(b.audio.masterVolume+.05,1),ue.create("Master volume: "+Math.round(b.audio.masterVolume*100)+"%")}},volumeDown:{label:"Decrease master volume",combos:[{key:"Down",mods:["Alt"]}],disabled:!1,callback:()=>{b.audio.masterVolume=Math.max(b.audio.masterVolume-.05,0),ue.create("Master volume: "+Math.round(b.audio.masterVolume*100)+"%")}},songVolumeUp:{label:"Increase song volume",combos:[{key:"Up",mods:["Shift","Alt"]}],disabled:!1,callback:()=>{b.audio.songVolume=Math.min(b.audio.songVolume+.05,1),ue.create("Song volume: "+Math.round(b.audio.songVolume*100)+"%")}},songVolumeDown:{label:"Decrease song volume",combos:[{key:"Down",mods:["Shift","Alt"]}],disabled:!1,callback:()=>{b.audio.songVolume=Math.max(b.audio.songVolume-.05,0),ue.create("Song volume: "+Math.round(b.audio.songVolume*100)+"%")}},effectvolumeUp:{label:"Increase tick/metronome volume",combos:[{key:"Up",mods:["Shift",at,"Alt"]}],disabled:!1,callback:()=>{b.audio.soundEffectVolume=Math.min(b.audio.soundEffectVolume+.05,1),ue.create("Effect volume: "+Math.round(b.audio.soundEffectVolume*100)+"%")}},effectvolumeDown:{label:"Decrease tick/metronome volume",combos:[{key:"Down",mods:["Shift",at,"Alt"]}],disabled:!1,callback:()=>{b.audio.soundEffectVolume=Math.max(b.audio.soundEffectVolume-.05,0),ue.create("Effect Volume: "+Math.round(b.audio.soundEffectVolume*100)+"%")}},rateUp:{label:"Increase playback rate",combos:[{key:"Right",mods:["Shift"]}],disabled:i=>i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:()=>{b.audio.rate+=.05,ue.create("Playback Rate: "+Math.round(b.audio.rate*100)+"%")}},rateDown:{label:"Decrease playback rate",combos:[{key:"Left",mods:["Shift"]}],disabled:i=>i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:()=>{b.audio.rate=Math.max(b.audio.rate-.05,.1),ue.create("Playback Rate: "+Math.round(b.audio.rate*100)+"%")}},rateDefault:{label:"Reset playback rate",combos:[],disabled:!1,callback:()=>{b.audio.rate=1,ue.create("Playback Rate: "+Math.round(b.audio.rate)+"%")}},previousStream:{label:"Previous stream",combos:[{key:"Up",mods:[at]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>{const e=[];for(const n of i.chartManager.loadedChart.stats.streams)e.at(-1)==n.startBeat&&e.pop(),e.push(n.startBeat),e.push(n.endBeat);const t=kr(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},nextStream:{label:"Next stream",combos:[{key:"Down",mods:[at]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>{const e=[];for(const n of i.chartManager.loadedChart.stats.streams)e.at(-1)==n.startBeat&&e.pop(),e.push(n.startBeat),e.push(n.endBeat);const t=Ar(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},previousMeasure:{label:"Previous measure",combos:[{key:"PageUp",mods:[]},{key:";",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>{const e=i.chartManager.beat;if(b.chart.scroll.invertReverseScroll&&b.chart.reverse){const t=i.chartManager.loadedChart.timingData.getMeasureLength(e);i.chartManager.snapToNearestTick(Math.max(0,e+t))}else{const t=i.chartManager.loadedChart.timingData.getMeasureLength(e-.001);i.chartManager.snapToNearestTick(Math.max(0,e-t))}}},nextMeasure:{label:"Next measure",combos:[{key:"PageDown",mods:[]},{key:"'",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>{const e=i.chartManager.beat;if(b.chart.scroll.invertReverseScroll&&b.chart.reverse){const t=i.chartManager.loadedChart.timingData.getMeasureLength(e-.001);i.chartManager.snapToNearestTick(Math.max(0,e-t))}else{const t=i.chartManager.loadedChart.timingData.getMeasureLength(e);i.chartManager.snapToNearestTick(Math.max(0,e+t))}}},previousNote:{label:"Previous note",combos:[{key:",",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.previousNote()},nextNote:{label:"Next note",combos:[{key:".",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.nextNote()},jumpChartStart:{label:"Jump to first note",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.firstNote()},jumpChartEnd:{label:"Jump to last note",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.lastNote()},jumpSongStart:{label:"Jump to song start",combos:[{key:"Home",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.beat=Math.max(0,i.chartManager.loadedChart.getBeatFromSeconds(0))},jumpSongEnd:{label:"Jump to song end",combos:[{key:"End",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.beat=i.chartManager.loadedChart.getBeatFromSeconds(i.chartManager.chartAudio.getSongLength())},jumpPreviousCandle:{label:"Jump to previous candle",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.stats.parity,t=e.candles.keys().map(r=>e.rowTimestamps[r].beat).toArray().sort((r,a)=>r-a),n=kr(t,i.chartManager.beat);n!==null&&(i.chartManager.beat=n)}},jumpNextCandle:{label:"Jump to next candle",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.stats.parity,t=e.candles.keys().map(r=>e.rowTimestamps[r].beat).toArray().sort((r,a)=>r-a),n=Ar(t,i.chartManager.beat);n!==null&&(i.chartManager.beat=n)}},jumpPreviousError:{label:"Jump to previous error",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.getTechErrors().map(n=>n.beat),t=kr(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},jumpNextError:{label:"Jump to next error",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record||!i.chartManager.loadedChart?.stats.parity||!b.chart.parity.enabled,callback:i=>{const e=i.chartManager.loadedChart.getTechErrors().map(n=>n.beat),t=Ar(e,i.chartManager.beat);t!==null&&(i.chartManager.beat=t)}},assistTick:{label:"Assist tick",combos:[{key:"F7",mods:[]}],disabled:()=>!pe.assist,callback:()=>{b.audio.assistTick=!b.audio.assistTick,ue.create("Assist Tick: "+(b.audio.assistTick?"on":"off"))}},metronome:{label:"Metronome",combos:[{key:"F7",mods:["Alt"]}],disabled:()=>!pe.assist,callback:()=>{b.audio.metronome=!b.audio.metronome,ue.create("Metronome: "+(b.audio.metronome?"on":"off"))}},XMod:{label:"XMod (Beat-based)",combos:[{key:"X",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.CMod=!1,ue.create("Switched to XMod")}},CMod:{label:"CMod (Time-based)",combos:[{key:"C",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.CMod=!0,ue.create("Switched to CMod")}},reverse:{label:"Reverse playfield",combos:[],disabled:!1,callback:()=>{b.chart.reverse=!b.chart.reverse,ue.create("Reverse Playfield: "+(b.chart.reverse?"on":"off"))}},hideWarpedArrows:{label:"Hide warped notes (CMod only)",combos:[{key:"W",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.hideWarpedArrows=!b.chart.hideWarpedArrows,ue.create("Hide Warped Arrows: "+(b.chart.hideWarpedArrows?"on":"off"))}},hideFakedArrows:{label:"Hide faked notes (CMod only)",combos:[{key:"F",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.hideFakedArrows=!b.chart.hideFakedArrows,ue.create("Hide Faked Arrows: "+(b.chart.hideFakedArrows?"on":"off"))}},doSpeedChanges:{label:"Do speed changes (XMod only)",combos:[{key:"S",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.doSpeedChanges=!b.chart.doSpeedChanges,ue.create("Speed Changes: "+(b.chart.doSpeedChanges?"on":"off"))}},showEq:{label:"Equalizer",combos:[{key:"E",mods:["Shift"]}],disabled:i=>!i.chartManager.chartAudio||!pe.openWindows,callback:i=>i.windowManager.openWindow(new mm(i))},detectSync:{label:"Detect audio sync",combos:[{key:"L",mods:["Shift"]}],disabled:i=>!i.chartManager.chartAudio||!pe.openWindows,callback:i=>i.windowManager.openWindow(new Qu(i))},previousNoteType:{label:"Previous note type",combos:[{key:"N",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.previousNoteType()},nextNoteType:{label:"Next note type",combos:[{key:"M",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.Record,callback:i=>i.chartManager.nextNoteType()},undo:{label:"Undo",combos:[{key:"Z",mods:[at]}],disabled:i=>!i.actionHistory.canUndo()||i.chartManager.getMode()!=U.Edit,callback:i=>i.actionHistory.undo()},redo:{label:"Redo",combos:[{key:"Y",mods:[at]},{key:"Z",mods:[at,"Shift"]}],disabled:i=>!i.actionHistory.canRedo()||i.chartManager.getMode()!=U.Edit,callback:i=>i.actionHistory.redo()},mousePlacement:{label:"Enable Mouse Note Placement",combos:[{key:"M",mods:["Shift"]}],disabled:!1,callback:()=>{b.chart.mousePlacement=!b.chart.mousePlacement,ue.create("Mouse Note Placement: "+(b.chart.mousePlacement?"on":"off"))}},playMode:{label:"Enter/Exit Play Mode",combos:[{key:"P",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Record||!pe.playMode,callback:i=>i.chartManager.setMode(U.Play)},recordMode:{label:"Enter/Exit Record Mode",combos:[{key:"R",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.View||!pe.recordMode,callback:i=>i.chartManager.setMode(U.Record)},playModeStart:{label:"Play from start",combos:[{key:"P",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Record||!pe.playMode,callback:i=>{i.chartManager.beat=0,i.chartManager.setMode(U.Play)}},recordModeStart:{label:"Record from start",combos:[{key:"R",mods:["Shift"]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()==U.Play||i.chartManager.getMode()==U.View||!pe.recordMode,callback:i=>i.chartManager.setMode(U.Record)},options:{label:"Options...",bindLabel:"Edit options",combos:[{key:",",mods:[at]}],disabled:()=>!pe.openWindows||!pe.openWindows,callback:i=>{i.windowManager.openWindow(new Sm(i))}},keybinds:{label:"Keybinds...",bindLabel:"Edit keybinds",combos:[],disabled:()=>!pe.openWindows||!pe.openWindows,callback:i=>{i.windowManager.openWindow(new ci(i))}},gameplayKeybinds:{label:"Gameplay keybinds...",bindLabel:"Edit gameplay keybinds",combos:[],disabled:()=>!pe.openWindows||!pe.openWindows,callback:i=>{i.windowManager.openWindow(new ym(i))}},themes:{label:"Themes...",bindLabel:"Edit themes",combos:[],disabled:()=>!pe.openWindows||!pe.openWindows||sr.isOpen,callback:i=>{i.windowManager.openWindow(new Ys(i))}},convertHoldsRolls:{label:"Holds to rolls",bindLabel:"Convert holds to rolls",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Hold"&&(e.type="Roll"),e))}},convertRollsHolds:{label:"Rolls to holds",bindLabel:"Convert rolls to holds",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Roll"&&(e.type="Hold"),e))}},swapHoldsRolls:{label:"Swap holds and rolls",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Hold"?e.type="Roll":e.type=="Roll"&&(e.type="Hold"),e))}},convertHoldsTaps:{label:"Holds/rolls to taps",bindLabel:"Convert holds/rolls to taps",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>((e.type=="Hold"||e.type=="Roll")&&(e.type="Tap"),e))}},convertTapsMines:{label:"Taps to mines",bindLabel:"Convert taps to mines",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Tap"&&(e.type="Mine"),e))}},convertTapsLifts:{label:"Taps to lifts",bindLabel:"Convert taps to lifts",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Tap"&&(e.type="Lift"),e))}},convertTapsFakes:{label:"Taps to fakes",bindLabel:"Convert taps to fakes",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.type=="Tap"&&(e.type="Fake"),e))}},mirrorHorizontally:{label:"Horizontally",bindLabel:"Mirror horizontally",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.col=i.chartManager.loadedChart.gameType.flipColumns.horizontal[e.col],e))}},mirrorVertically:{label:"Vertically",bindLabel:"Mirror vertically",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.col=i.chartManager.loadedChart.gameType.flipColumns.vertical[e.col],e))}},mirrorBoth:{label:"Both",bindLabel:"Mirror both",combos:[],disabled:i=>i.chartManager.selection.notes.length==0||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.modifySelection(e=>(e.col=i.chartManager.loadedChart.gameType.flipColumns.horizontal[e.col],e.col=i.chartManager.loadedChart.gameType.flipColumns.vertical[e.col],e))}},selectBeforeCursor:{label:"Select before cursor",combos:[{key:"Home",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedChart,callback:i=>{i.chartManager.editTimingMode==Te.Off?i.chartManager.setNoteSelection(i.chartManager.loadedChart.getNotedata().filter(e=>e.beat<i.chartManager.beat)):i.chartManager.setEventSelection(i.chartManager.loadedChart.timingData.getTimingData().filter(e=>e.beat<i.chartManager.beat))}},selectAfterCursor:{label:"Select after cursor",combos:[{key:"End",mods:["Shift"]}],disabled:i=>!i.chartManager.loadedChart,callback:i=>{i.chartManager.editTimingMode==Te.Off?i.chartManager.setNoteSelection(i.chartManager.loadedChart.getNotedata().filter(e=>e.beat>i.chartManager.beat)):i.chartManager.setEventSelection(i.chartManager.loadedChart.timingData.getTimingData().filter(e=>e.beat>i.chartManager.beat))}},selectAll:{label:"Select all",combos:[{key:"A",mods:[at]}],disabled:i=>!i.chartManager.loadedChart,callback:i=>{i.chartManager.editTimingMode==Te.Off?i.chartManager.setNoteSelection(i.chartManager.loadedChart.getNotedata()):i.chartManager.setEventSelection(i.chartManager.loadedChart.timingData.getTimingData())}},expand2to1:{label:"Expand 2:1 (8th to 4th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=U.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*2+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=2,t.hold=Math.round(t.hold*48)/48),t))}},expand3to2:{label:"Expand 3:2 (12th to 8th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=U.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*1.5+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=1.5,t.hold=Math.round(t.hold*48)/48),t))}},expand4to3:{label:"Expand 4:3 (16th to 2th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=U.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*4/3+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=4/3,t.hold=Math.round(t.hold*48)/48),t))}},compress1to2:{label:"Compress 1:2 (4th to 8th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=U.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)/2+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold/=2,t.hold=Math.round(t.hold*48)/48),t))}},compress2to3:{label:"Compress 2:3 (8th to 12th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=U.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)/1.5+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold/=1.5,t.hold=Math.round(t.hold*48)/48),t))}},compress3to4:{label:"Compress 3:4 (12th to 16th)",combos:[],disabled:i=>i.chartManager.selection.notes.length<2||i.chartManager.getMode()!=U.Edit,callback:i=>{const e=Math.min(...i.chartManager.selection.notes.map(t=>t.beat));i.chartManager.modifySelection(t=>(t.beat=(t.beat-e)*.75+e,t.beat=Math.round(t.beat*48)/48,Oe(t)&&(t.hold*=.75,t.hold=Math.round(t.hold*48)/48),t))}},delete:{label:"Delete",combos:[{key:"Backspace",mods:[]},{key:"Delete",mods:[]}],disabled:i=>i.chartManager.getMode()!=U.Edit||i.chartManager.selection.notes.length==0&&i.chartManager.eventSelection.timingEvents.length==0,callback:i=>{i.chartManager.deleteSelection(),i.chartManager.deleteEventSelection()}},paste:{label:"Paste",combos:[{mods:[at],key:"V"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:async i=>{const e=await navigator.clipboard.readText();i.chartManager.paste(e)}},pasteReplace:{label:"Clear and paste",combos:[{mods:[at,"Shift"],key:"V"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:async i=>{const e=await navigator.clipboard.readText();i.chartManager.paste(e,!0)}},copy:{label:"Copy",combos:[{mods:[at],key:"C"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit||!i.chartManager.hasSelection(),callback:async i=>{const e=i.chartManager.copy();e&&await navigator.clipboard.writeText(e)}},cut:{label:"Cut",combos:[{mods:[at],key:"X"}],preventDefault:!1,disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit||!i.chartManager.hasSelection(),callback:async i=>{const e=i.chartManager.copy();e&&await navigator.clipboard.writeText(e),i.chartManager.deleteSelection()}},adjustOffset:{label:"Adjust offset",combos:[],disabled:()=>!pe.openWindows,callback:i=>i.windowManager.openWindow(new Em(i))},setSongPreview:{label:"Set as song preview",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit||!i.chartManager.hasRange(),callback:i=>{const e=i.chartManager.loadedChart,t=i.chartManager.loadedSM.properties.SAMPLESTART??"0",n=i.chartManager.loadedSM.properties.SAMPLELENGTH??"10";let r="",a="";if(i.chartManager.startRegion!==void 0&&i.chartManager.endRegion!==void 0){const s=e.getSecondsFromBeat(i.chartManager.startRegion),o=e.getSecondsFromBeat(i.chartManager.endRegion);r=fe(s,3).toString(),a=fe(o-s,3).toString()}else{const o=(i.chartManager.selection.notes.length>0?i.chartManager.selection.notes:i.chartManager.eventSelection.timingEvents).map(f=>f.beat),l=e.getSecondsFromBeat(xn(o)),u=e.getSecondsFromBeat($r(o));r=fe(l,3).toString(),a=fe(u-l,3).toString()}Dt.instance.run({action:s=>{s.chartManager.loadedSM.properties.SAMPLESTART=r,s.chartManager.loadedSM.properties.SAMPLELENGTH=a},undo:s=>{s.chartManager.loadedSM.properties.SAMPLESTART=t,s.chartManager.loadedSM.properties.SAMPLELENGTH=n}})}},showDebugTimers:{label:"Toggle Debug Timers",combos:[{key:"F3",mods:["Shift"]}],disabled:!1,callback:()=>{b.debug.showTimers=!b.debug.showTimers}},showFPSCounter:{label:"Toggle FPS Counter",combos:[{key:"F3",mods:[]}],disabled:!1,callback:()=>{b.debug.showFPS=!b.debug.showFPS}},noteTypeTap:{label:"Switch to Taps",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.setEditingNoteType("Tap")}},noteTypeLift:{label:"Switch to Lifts",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.setEditingNoteType("Lift")}},noteTypeMine:{label:"Switch to Mines",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.setEditingNoteType("Mine")}},noteTypeFake:{label:"Switch to Fakes",combos:[],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.setEditingNoteType("Fake")}},openGuide:{label:"Open Help Guide",combos:[],disabled:!1,callback:()=>{window.open("/smeditor/guide/")}},openChangelog:{label:"Open Changelog",combos:[],disabled:()=>!pe.openWindows,callback:i=>{i.windowManager.openWindow(new Uu(i))}},noteskinWindow:{label:"Noteskins...",bindLabel:"Open Noteskin Window",combos:[{mods:["Shift"],key:"N"}],disabled:i=>!i.chartManager.chartView||!pe.openWindows,callback:i=>i.windowManager.openWindow(new xm(i))},previousChart:{label:"Previous chart",combos:[{key:"F5",mods:[]}],disabled:i=>!i.chartManager.chartView,callback:i=>{if(!i.chartManager.loadedSM?.charts||!i.chartManager.loadedChart)return;const e=i.chartManager.loadedSM?.getChartsByGameType(i.chartManager.loadedChart.gameType.id),t=e.indexOf(i.chartManager.loadedChart);e[t-1]?i.chartManager.loadChart(e[t-1]):ue.create("No previous chart")}},nextChart:{label:"Next chart",combos:[{key:"F6",mods:[]}],disabled:i=>!i.chartManager.chartView,callback:i=>{if(!i.chartManager.loadedSM?.charts||!i.chartManager.loadedChart)return;const e=i.chartManager.loadedSM?.getChartsByGameType(i.chartManager.loadedChart.gameType.id),t=e.indexOf(i.chartManager.loadedChart);e[t+1]?i.chartManager.loadChart(e[t+1]):ue.create("No next chart")}},toggleEditTiming:{label:"Toggle Edit Timing",combos:[{key:"T",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.editTimingMode!=Te.Off?i.chartManager.editTimingMode=Te.Off:i.chartManager.editTimingMode=Te.Edit}},toggleAddTiming:{label:"Toggle Add Timing",combos:[{key:"T",mods:["Alt"]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:i=>{i.chartManager.editTimingMode!=Te.Add?i.chartManager.editTimingMode=Te.Add:i.chartManager.editTimingMode=Te.Edit}},about:{label:"About",combos:[],disabled:()=>!pe.openWindows,callback:i=>{i.windowManager.openWindow(new uh(i))}},enableParity:{label:"Enable parity checking",combos:[{key:"E",mods:[]}],disabled:i=>!i.chartManager.chartView||i.chartManager.getMode()!=U.Edit,callback:()=>{b.chart.parity.enabled=!b.chart.parity.enabled,ue.create("Parity Checking: "+(b.chart.parity.enabled?"on":"off"))}},showTechErrors:{label:"Show tech errors",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showErrors=!b.chart.parity.showErrors,ue.create("Tech Errors: "+(b.chart.parity.showErrors?"on":"off"))}},showFootHighlights:{label:"Show foot highlights",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showHighlights=!b.chart.parity.showHighlights,ue.create("Foot Highlights: "+(b.chart.parity.showHighlights?"on":"off"))}},showDancingBot:{label:"Show dancing bot",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showDancingBot=!b.chart.parity.showDancingBot,ue.create("Dancing Bot: "+(b.chart.parity.showDancingBot?"on":"off"))}},showTechNotation:{label:"Show tech notation",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showTech=!b.chart.parity.showTech,ue.create("Tech Notation: "+(b.chart.parity.showTech?"on":"off"))}},showCandles:{label:"Show candles",combos:[],disabled:()=>!b.chart.parity.enabled,callback:()=>{b.chart.parity.showCandles=!b.chart.parity.showCandles,ue.create("Candles: "+(b.chart.parity.showCandles?"on":"off"))}},newWindow:{label:"New window",combos:[{mods:["Shift",at],key:"N"}],visible:()=>!!window.nw,disabled:()=>!window.nw,callback:()=>{window.nw.Window.open(window.location.href)}}};for(const i of[4,2,1])Ne[`shiftUp${i}m`]={label:`${i} measure`+(i==1,""),bindLabel:`Shift up by ${i} measure`+(i==1,""),combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>{const t=e.chartManager.selection.notes[0].beat,n=e.chartManager.loadedChart.timingData.getMeasureLength(t);e.chartManager.modifySelection(r=>(r.beat-=n*i,r),!0)}},Ne[`shiftDown${i}m`]={label:`${i} measure`+(i==1,""),bindLabel:`Shift down by ${i} measure`+(i==1,""),combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>{const t=e.chartManager.selection.notes[0].beat,n=e.chartManager.loadedChart.timingData.getMeasureLength(t);e.chartManager.modifySelection(r=>(r.beat+=n*i,r),!0)}};for(let i=0;i<Mn.length;i++)Ne["quant"+Oo[i]]={label:`Switch to ${oi[i]}s`,combos:[],disabled:e=>!e.chartManager.chartView,callback:()=>{b.chart.snap=Mn[i]}},Ne[`shiftUp${oi[i]}`]={label:`${oi[i]}`,bindLabel:`Shift up by ${oi[i]}`,combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>e.chartManager.modifySelection(t=>(t.beat-=Mn[i],t),!0)},Ne[`shiftDown${oi[i]}`]={label:`${oi[i]}`,bindLabel:`Shift down by ${oi[i]}`,combos:[],disabled:e=>!e.chartManager.chartView,callback:e=>e.chartManager.modifySelection(t=>(t.beat+=Mn[i],t),!0)},i!=Mn.length-1&&(Ne["quantize"+oi[i]]={label:`${oi[i]}s`,bindLabel:`Quantize to ${oi[i]}s`,combos:[],disabled:e=>e.chartManager.selection.notes.length==0||e.chartManager.getMode()!=U.Edit,callback:e=>{e.chartManager.modifySelection(t=>(t.beat=e.chartManager.getClosestTick(t.beat,Oo[i]),t.beat=Math.round(t.beat*48)/48,t))}});for(const i of["STOPS","DELAYS"])Ne[`convert${i}`]={label:`Convert to ${i[0]}${i.slice(1).toLowerCase()}`,combos:[],disabled:e=>!e.chartManager.chartView||e.chartManager.getMode()!=U.Edit||!e.chartManager.hasRange(),callback:e=>{const t=e.chartManager.loadedChart;let n=0,r=0;if(e.chartManager.startRegion!==void 0&&e.chartManager.endRegion!==void 0){const a=t.getSecondsFromBeat(e.chartManager.startRegion),s=t.getSecondsFromBeat(e.chartManager.endRegion);n=e.chartManager.startRegion,r=s-a}else{const s=(e.chartManager.selection.notes.length>0?e.chartManager.selection.notes:e.chartManager.eventSelection.timingEvents).map(u=>u.beat),o=t.getSecondsFromBeat(xn(s)),l=t.getSecondsFromBeat($r(s));n=xn(s),r=l-o}e.chartManager.loadedChart.timingData.insertColumnEvents([{type:i,beat:n,value:r}])}};for(const i of["WARPS","FAKES"])Ne[`convert${i}`]={label:`Convert to ${i[0]}${i.slice(1).toLowerCase()}`,combos:[],disabled:e=>!e.chartManager.chartView||e.chartManager.getMode()!=U.Edit||!e.chartManager.hasRange(),callback:e=>{let t=0,n=0;if(e.chartManager.startRegion!==void 0&&e.chartManager.endRegion!==void 0)t=e.chartManager.startRegion,n=e.chartManager.endRegion-e.chartManager.startRegion;else{const a=(e.chartManager.selection.notes.length>0?e.chartManager.selection.notes:e.chartManager.eventSelection.timingEvents).map(s=>s.beat);t=xn(a),n=$r(a)-xn(a)}e.chartManager.loadedChart.timingData.insertColumnEvents([{type:i,beat:t,value:n}])}};function ed(i){return e=>{const t=e.chartManager.selection.notes.filter(s=>s.type!="Mine"&&s.type!="Fake"&&!s.fake&&!s.warped);let n=Number.MAX_VALUE,r=-Number.MAX_VALUE;t.forEach(s=>{s.beat<n&&(n=s.beat),Ni(s)>r&&(r=Ni(s))});const a=[];Dt.instance.run({action:()=>{t.forEach(s=>{s.parity||(s.parity={}),a.push(s.parity.override),s.parity.override=i=="None"?void 0:i}),e.chartManager.loadedChart.recalculateStats(n,r),ee.emit("chartModified")},undo:()=>{t.forEach((s,o)=>{s.parity||(s.parity={}),s.parity.override=a[o]}),e.chartManager.loadedChart.recalculateStats(n,r),ee.emit("chartModified")},redo:()=>{t.forEach(s=>{s.parity||(s.parity={}),s.parity.override=i=="None"?void 0:i}),e.chartManager.loadedChart.recalculateStats(n,r),ee.emit("chartModified")}})}}for(const i of["None","Left","Right"])Ne[`parity${i}`]={label:`Mark as ${i}`,combos:[],disabled:e=>!e.chartManager.chartView||e.chartManager.getMode()!=U.Edit||!e.chartManager.hasNoteSelection(),callback:ed(i)};for(const i of[ce.LEFT_HEEL,ce.LEFT_TOE,ce.RIGHT_HEEL,ce.RIGHT_TOE])Ne[`parity${Uc[i]}`]={label:`Mark as ${md[i]}`,combos:[],disabled:e=>!e.chartManager.chartView||e.chartManager.getMode()!=U.Edit||!e.chartManager.hasNoteSelection(),callback:ed(i)};class Do{static popup;static build(e){const t=document.createElement("div");t.classList.add("update-popup");const n=document.createElement("div");n.classList.add("title"),n.innerText=e.title;const r=document.createElement("div");r.classList.add("desc"),r.innerText=e.desc;const a=document.createElement("div");if(a.classList.add("update-options"),t.replaceChildren(n,r),e.options.length>0){for(const s of e.options){const o=document.createElement("button");o.innerText=s.label,o.onclick=()=>{s.callback?.(this)},o.classList.add(s.type),a.appendChild(o)}t.appendChild(a)}this.popup=t,document.getElementById("popups")?.appendChild(this.popup)}static close(){this.popup&&(this.popup.classList.add("exiting"),this.popup.style.pointerEvents="none",setTimeout(()=>this.popup.remove(),300))}}class td extends Do{static open(e,t){super.build({title:`A new version of the desktop app is available! (${e})`,desc:"Click here to download the new version.",options:[{label:"Close",type:"default",callback:()=>this.close()},{label:"Download",type:"confirm",callback:()=>{localStorage.setItem("downloadedVersion",e),nw.require("nw.gui").Shell.openExternal(t),this.close()}}]})}}class id extends Do{static open(e){super.build({title:"A new version of the app is available!",desc:"Refresh the page to get the new version.",options:[{label:"Close",type:"default",callback:()=>this.close()},{label:"Refresh",type:"confirm",callback:()=>{e(),window.location.reload()}}]})}}class Lm extends Do{static open(){super.build({title:"SMEditor was loaded offline!",desc:"You can now use SMEditor without an internet connection.",options:[]}),setTimeout(()=>this.close(),5e3)}}class dt extends jc{static graphics=new Hi;static textures={default:ti.create({width:50,height:50}),noBorder:ti.create({width:50,height:50}),onlyBorder:ti.create({width:50,height:50})};static init(e){this.textures.default=ti.create({width:50,height:50,resolution:e.resolution}),this.textures.noBorder=ti.create({width:50,height:50,resolution:e.resolution}),this.textures.onlyBorder=ti.create({width:50,height:50,resolution:e.resolution}),this.graphics.beginFill(16777215,1),this.graphics.lineStyle(1,0),this.graphics.drawRoundedRect(0,0,50,50,5),this.graphics.endFill(),e.render(this.graphics,{renderTexture:this.textures.default}),this.graphics.clear(),this.graphics.beginFill(16777215,1),this.graphics.lineStyle(0,16777215),this.graphics.drawRoundedRect(0,0,50,50,5),this.graphics.endFill(),e.render(this.graphics,{renderTexture:this.textures.noBorder}),this.graphics.clear(),this.graphics.beginFill(16777215,0),this.graphics.lineStyle(2,16777215),this.graphics.drawRoundedRect(0,0,50,50,5),this.graphics.endFill(),e.render(this.graphics,{renderTexture:this.textures.onlyBorder})}constructor(e){super(dt.textures[e??"default"],5,5,5,5)}}const Nn=[];function Tc(){return Nn.length}function Dm(){for(Nn.push(Date.now());Nn.length>0&&Nn[0]<Date.now()-1e3;)Nn.shift()}const Hn=[];function Sc(){return Hn.length}function Bm(){for(Hn.push(Date.now());Hn.length>0&&Hn[0]<Date.now()-1e3;)Hn.shift()}class an extends he{manager;constructor(e){super(),this.manager=e}startPlay(){}endPlay(){}}const ei=50;class tn extends an{static instance;frameTimeGraph=new Bn({width:300,height:ei,color:1525027,min:0,unit:"ms",label:"Draw",precision:1,sublabel:()=>Tc()+" FPS"});drawUpdateTimeGraph=new Bn({width:300,height:ei,color:6034982,min:0,unit:"ms",label:"DrawUpdate",precision:1});updateTimeGraph=new Bn({width:300,height:ei,color:1516101,min:0,unit:"ms",label:"Update",precision:1,sublabel:()=>Sc()+" TPS"});memoryTimeGraph=new Bn({width:300,height:ei,color:6626406,min:0,formatter:e=>Math.round(e/1048576)+" MB",label:"Memory"});cpuGraph=new Bn({width:300,height:ei,color:5190685,min:0,label:"CPU"});graphs=new he;fpsCounter=new he;fpsBg=new dt("noBorder");fpsText=new ge("",{fontName:"Main",fontSize:12});lastFrameTime=0;properties=new Map;constructor(e){super(e),this.drawUpdateTimeGraph.y+=ei+5,this.updateTimeGraph.y+=(ei+5)*2,this.memoryTimeGraph.y+=(ei+5)*3,this.cpuGraph.y+=(ei+5)*4,tn.instance=this,this.fpsText.x=5,this.fpsBg.y=-5,Ue(this.fpsBg,"widget-bg"),Ue(this.fpsText,"text-color"),this.graphs.addChild(this.frameTimeGraph,this.drawUpdateTimeGraph,this.updateTimeGraph),performance.memory&&this.graphs.addChild(this.memoryTimeGraph),this.fpsCounter.addChild(this.fpsBg,this.fpsText),this.graphs.visible=b.debug.showTimers,this.fpsCounter.visible=b.debug.showFPS,this.addChild(this.graphs,this.fpsCounter)}update(){this.x=-this.manager.app.STAGE_WIDTH/2+20,this.y=-this.manager.app.STAGE_HEIGHT/2+20,this.graphs.children.forEach(e=>e.update()),this.graphs.visible=b.debug.showTimers,this.fpsCounter.visible=b.debug.showFPS,this.fpsText.text=`${Tc()} FPS
${Sc()} TPS
${this.lastFrameTime.toFixed(2)} ms
`,b.debug.showDebugVariables&&this.properties.forEach((e,t)=>{this.fpsText.text+=`${t}: ${e}
`}),this.fpsBg.width=this.fpsText.width+10,this.fpsBg.height=this.fpsText.height+10,b.debug.showTimers?(this.fpsBg.y=(ei+5)*this.graphs.children.length-5,this.fpsText.y=(ei+5)*this.graphs.children.length):(this.fpsBg.y=-5,this.fpsText.y=0)}addMemoryTimeValue(e){this.memoryTimeGraph.addValue(e)}addFrameTimeValue(e){this.lastFrameTime=e,this.frameTimeGraph.addValue(e)}addUpdateTimeValue(e){this.updateTimeGraph.addValue(e)}addDrawUpdateTimeValue(e){this.drawUpdateTimeGraph.addValue(e)}setProperty(e,t){this.properties.set(e,t)}clearProperty(e){this.properties.delete(e)}clearProperties(){this.properties.clear()}}class Bn extends he{graphWidth;graphHeight;color;unit;precision;formatter;sublabel;maxEase=1;targetMax=1;minEase=1;targetMin=1;constrainedMin=null;constrainedMax=null;dataPoints=[];linePool=[];lineContainer;labelText;sublabelText;topText;bottomText;constructor(e){super();const{width:t,height:n,color:r=16777215,unit:a="",label:s="",min:o=null,max:l=null,precision:u=0,formatter:f=null,sublabel:c=()=>""}=e;this.graphWidth=t,this.graphHeight=n,this.color=r,this.unit=a,this.constrainedMax=l,this.constrainedMin=o,this.precision=u,this.formatter=f,this.sublabel=c,this.lineContainer=new Yr(t,{position:!0},16384,!0);const d=new dt("noBorder");d.tint=0,d.alpha=.3,d.width=this.graphWidth,d.height=this.graphHeight,Ue(d,"widget-bg"),this.labelText=new ge(s,{fontName:"Main",fontSize:Math.min(n/5,16)}),this.labelText.alpha=.8,this.sublabelText=new ge("",{fontName:"Main",fontSize:Math.min(n/5,16)}),this.topText=new ge("",{fontName:"Main",fontSize:Math.min(n/7,12)}),this.topText.anchor.x=1,this.topText.alpha=.5,this.topText.x=this.graphWidth,this.bottomText=new ge("",{fontName:"Main",fontSize:Math.min(n/7,12)}),this.bottomText.anchor.x=1,this.bottomText.anchor.y=1,this.bottomText.alpha=.5,this.bottomText.x=this.graphWidth,this.bottomText.y=this.graphHeight,this.sublabelText.y=this.graphHeight,this.sublabelText.anchor.y=1,this.sublabelText.alpha=.5,this.addChild(d,this.lineContainer,this.labelText,this.sublabelText,this.topText,this.bottomText)}addValue(e){if(this.lineContainer.children[0]?.x+this.lineContainer.x<0){const n=this.lineContainer.children[0];this.dataPoints.shift(),this.removeChild(n),this.linePool.push(n)}this.lineContainer.x-=1,this.lineContainer.x<-1e7&&(this.lineContainer.children.forEach(n=>{n.x-=1e7}),this.lineContainer.x+=1e7);const t=this.linePool.shift()??new ye(xe.WHITE);t.width=1,t.anchor.x=.5,t.anchor.y=1,t.tint=this.color,t.alpha=.6,t.x=this.graphWidth-this.lineContainer.x,t.y=this.graphHeight,t.value=e,this.dataPoints.push(e),this.targetMax=this.constrainedMax!==null?this.constrainedMax:Math.max(...this.dataPoints),this.targetMin=this.constrainedMin!==null?this.constrainedMin:Math.min(...this.dataPoints),this.lineContainer.addChild(t)}update(){this.dataPoints.length!=0&&(this.maxEase=(this.maxEase-this.targetMax)*.1+this.targetMax,this.minEase=(this.minEase-this.targetMin)*.1+this.targetMin,this.lineContainer.children.forEach(e=>{e.height=Se((e.value-this.minEase)/this.maxEase,0,1)*this.graphHeight}),this.topText.text=this.formatter?.(this.maxEase)??`${fe(this.maxEase,this.precision)} ${this.unit}`,this.bottomText.text=this.formatter?.(this.minEase)??`${fe(this.minEase,this.precision)} ${this.unit}`,this.sublabelText.text=this.sublabel())}}class Fm extends an{timeText;beatText;measureText;constructor(e){super(e);const t=new dt("noBorder");t.width=330,t.height=48,t.tint=16711680,t.pivot.set(t.width/2,t.height),this.addChild(t),Ue(t,"widget-bg"),this.timeText=this.createCounter("Time",{x:-110,y:-32}),this.createLine({x:-55,y:-40}),this.beatText=this.createCounter("Beat",{x:0,y:-32}),this.createLine({x:55,y:-40}),this.measureText=this.createCounter("Measure",{x:110,y:-32})}createCounter(e,t){const n=new ge("",{fontSize:32,fontName:"Main"});n.scale.set(16*1.1/32),n.anchor.set(.5,.5),n.position.set(t.x,t.y),this.addChild(n),Ue(n,"text-color");const r=new ge(e,{fontSize:32,fontName:"Main"});return r.scale.set(16*.6/32),r.anchor.set(.5,.5),r.position.set(t.x,t.y+16),this.addChild(r),Ue(r,"text-color-secondary"),n}createLine(e){const t=new ye(xe.WHITE);t.width=1,t.height=32,t.position.set(e.x,e.y),t.tint=8816262,t.alpha=.5,this.addChild(t)}update(){if(!this.manager.app.capturing){this.visible=!1;return}this.visible=!0,this.scale.set(b.performance.resolution*b.general.uiScale*.7),this.position.y=this.manager.app.STAGE_HEIGHT/2-32*b.performance.resolution*b.general.uiScale*.7;const e=this.manager.chartManager.loadedChart?.timingData?.getMeasure(this.manager.chartManager.beat)??this.manager.chartManager.beat/4,t=this.manager.chartManager.time;this.measureText.text=fe(e,3).toFixed(3),this.beatText.text=fe(this.manager.chartManager.beat,3).toFixed(3);let n="";n+=(t<0?"-":"")+Math.floor(Math.abs(t)/60).toString().padStart(2,"0"),n+=":",n+=Math.floor(Math.abs(t)%60).toString().padStart(2,"0"),n+=".",n+=(fe(Math.abs(t)%1,3)*1e3).toString().padStart(3,"0"),this.timeText.text=n}}function Mc(i,e,t,n){return i!=-1&&(i==t||i==n)||e!=-1&&(e==t||e==n)}class Lc{name;layout;columnCount;upArrows;downArrows;sideArrows;constructor(e,t,n,r,a){this.name=e,this.layout=t,this.columnCount=t.length,this.upArrows=n,this.downArrows=r,this.sideArrows=a}getFacingDirectionCosine(e,t){if(e==t)return 0;let n=this.layout[t].x-this.layout[e].x;const r=this.layout[t].y-this.layout[e].y,a=Math.sqrt(n*n+r*r);return n/=a,n}getYDifference(e,t){if(e==t)return 0;const n=this.layout[t].x-this.layout[e].x;let r=this.layout[t].y-this.layout[e].y;const a=Math.sqrt(n*n+r*r);r/=a;const s=r<=0;return r=Math.pow(r,4),s&&(r=-r),r}averagePoint(e,t){return e==-1&&t==-1?{x:0,y:0}:e==-1?this.layout[t]:t==-1?this.layout[e]:{x:(this.layout[e].x+this.layout[t].x)/2,y:(this.layout[e].y+this.layout[t].y)/2}}getDistanceSq(e,t){const n=this.layout[e],r=this.layout[t];return(n.y-r.y)*(n.y-r.y)+(n.x-r.x)*(n.x-r.x)}getDistanceSqPoints(e,t){return(e.y-t.y)*(e.y-t.y)+(e.x-t.x)*(e.x-t.x)}bracketCheck(e,t){return this.getDistanceSq(e,t)<=2}getPlayerAngle(e,t){const n=this.layout[e],r=this.layout[t],a=r.x-n.x,s=r.y-n.y,o=1,l=0,u=a*o+s*l,f=a*l-s*o;return Math.atan2(f,u)}getPlacementData(e,t,n,r){const a=[],s=[];for(let T=0;T<this.layout.length;T++)n&&n.holds[T]===void 0&&e.action[T]!=ce.NONE&&(a[e.action[T]]=!0),r.holds[T]===void 0&&t.action[T]!=ce.NONE&&(s[t.action[T]]=!0);const o=a[ce.LEFT_HEEL]||a[ce.LEFT_TOE],l=a[ce.RIGHT_HEEL]||a[ce.RIGHT_TOE],u=s[ce.LEFT_HEEL]||s[ce.LEFT_TOE],f=s[ce.RIGHT_HEEL]||s[ce.RIGHT_TOE],c=s[ce.LEFT_HEEL]&&s[ce.LEFT_TOE],d=s[ce.RIGHT_HEEL]&&s[ce.RIGHT_TOE],h=a[ce.LEFT_HEEL]&&a[ce.RIGHT_HEEL],p=s[ce.LEFT_HEEL]&&s[ce.RIGHT_HEEL],m=!p&&Mc(e.leftHeel,e.leftToe,t.leftHeel,t.leftToe)&&o&&u,g=!p&&Mc(e.rightHeel,e.rightToe,t.rightHeel,t.rightToe)&&l&&f,y=o&&u&&!p&&!m&&!h,x=l&&f&&!p&&!g&&!h,w=this.averagePoint(e.leftHeel,e.leftToe),_=this.averagePoint(e.rightHeel,e.rightToe),C=this.averagePoint(t.leftHeel,t.leftToe),F=this.averagePoint(t.rightHeel,t.rightToe);return{previousLeftPos:w,previousRightPos:_,leftPos:C,rightPos:F,movedLeft:u,movedRight:f,leftBracket:c,rightBracket:d,previousJumped:h,jumped:p,leftJack:m,rightJack:g,leftDoubleStep:y,rightDoubleStep:x,initialState:e,resultState:t}}}const Im={"dance-single":new Lc("dance-single",[{x:-1,y:0,rotation:0},{x:0,y:-1,rotation:Math.PI/2*3},{x:0,y:1,rotation:Math.PI/2},{x:1,y:0,rotation:Math.PI}],[2],[1],[0,3]),"dance-double":new Lc("dance-double",[{x:-2.5,y:0,rotation:0},{x:-1.5,y:-1,rotation:Math.PI/2*3},{x:-1.5,y:1,rotation:Math.PI/2},{x:-.5,y:0,rotation:Math.PI},{x:.5,y:0,rotation:0},{x:1.5,y:-1,rotation:Math.PI/2*3},{x:1.5,y:1,rotation:Math.PI/2},{x:2.5,y:0,rotation:Math.PI}],[2,6],[1,5],[0,3,4,7])},Pm="/smeditor/assets/foot-Cb_UZIxu.png",Rm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIoAAACKCAYAAAB1h9JkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFXElEQVR4nO3dTW7qSBiF4UN3CzFkwsyDjBFZA14Eq8gmgP2wCLyGSMyRmDFBbIAepIt2fA02uMr+fs4rRQpcSCzx3CqnsM3odruBsab+GnoDmI7+qbtzNBr1vR3iyrJsDQCn02k79Lb01bPZpRaK97IsW0+n00247QnLozj1VKoimU6nmzC6eI5QSlWRhIiFUO49QhLyjoVQUI9ktVphtVr9epxnLO53Zh8hWa//97Db7e7fh8d628F1PaK0QbJerzmywDGUNkhCxOIUyitIQt6xuIPyDpKQZyyuoHRBEvKKxQ2UGEhCHrG4gBITScgbFvNQUiAJecJiGkpKJCEvWMxC6Ypkv99jv9+3eqwHLCaX8GMgKYrifjvP88bnhJ9tdbnf3IgSG0lRFBxZYAxKTCSHwwGHwwEAsQCGpp5USABgPp/f/83rNGRiREmJhCPLT+qhpEQSIhblUPpAEvKORS2UPpGEPGNRCWUIJCGvWNRBGRJJyCMWVVAkIAl5w6IGiiQkXdOIRQUUiUjm8znm8zkAYLlctlqI05x4KBaRbLfbX6u2AHC5XDaSV21FQyESOYmFQiSyEgmFSOQlDgqRyEwUFCKRmxgoRCI7EVCIRH6DQyESHQ0KhUj0NBgUItHVIFCIRF+9QyESnfUKhUj0Nqq7/nmKa+F7QaK57+/vhy98LyMKkegvORQisVFSKERip2T7KBaRWOvz8/PX7d73UYjEXtGhEInNokIhErtFg0IktosChUjs1xkKkfioExQi8dPb6yjSkTA0vhbJ11GIxF8vXxVSIpLYP0t71SslxOilEUUqEpa+1lCIxHetoBAJa4RCJAxogEIkLPQQCpGwcrVQiIRVq4VCJKza4CepMx3VQrlcLpvy7d1uh+223flMeZ5juVwC4LK6pWqhnE6nLbGwcg+nHmJh5Z7uoxALCzXuzBILA1r+1UMsrPWfx8Tiu5fWUYjFby8f4RYuEFNevQ0nbbdZvQ0HOxdFcYfCQyHl99bKrMSRhW8XpO3tT1KXOLKE5/N0jfh1eq9H+sjyymf9sed1flOQWHwU5d1jYrFftMMMiMV2UY9HIRa7RT9wiVhsluQIN2Kx19vrKE1JX2cJx/Xy8qHt+nuz2fxxZ9v/+U1dr9diPB5jMpnk4b7D4YDz+dzqBfr4+AAAHI9HzGYzAMD5fO60TeH5s9kMx+Px1+9pU57nOJ/PJleBv76+Hr7wSaEAxKKpQaEAxKKlZ1CS7aNUs7jPErbbw8ew9DKihLyMLJPJJB+Px7her0Wnjeu5OguhXqEAxCI5UVAAYpGaOCgAsUhMJBSAWKQlFgpALJISDQUgFimJhwIQi4RUQAGIZejUQAGIZchUQQGIZajUQQGIZYhUQgGIpe/UQgGIpc+eQVFxVUgegzt8KqAAMrG8W91xt9KPYVEDBZCF5d3PLtSIBFAGBZCBxRsSQCEUYFgsHpEASqEAw2DxigRQDAXoF4tnJIByKEA/WLwjAQxAAdJiIZKfejuvJ3UpzhsC3rsenDUkADC63W5/3jkaDbApcYr56WUhL0jqLIRMTD3lYk5DgB8kTZmZesrFmoaq3z/LMhLA4NRTrus01DYrSFxNPeW6TkNtsoKkKdNQgLRYvCABHEAB0mDxhARwAgWIi8UbEsARFCAOFo9IAGdQgG5YvCIBHEIB3sPiGQngFArwGhbvSADHUIB2WIjkJ5NL+K/0bLm/+j3gEwlgfAn/leqW+6tZR+J2Cf+V6qahctaRNEUopR5h8Y4EwM9wU/3yXpZl68VicVssFrcsy+K+1Sy4Ogvhy/3ObF3l0cP9SPJftTuzjFXjPgpr1b/As72zHGkAugAAAABJRU5ErkJggg==";class Ht extends he{pool=[];options;constructor(e){super(),this.options=e}createChild(){if(this.pool.length==0&&this.options.maxPoolSize!==void 0&&this.children.length>=this.options.maxPoolSize)return;const e=this.pool.pop()??this.options.create();return this.addChild(e),e._disabledTime=Date.now(),e}destroyChild(e){this.children.includes(e)&&(e.removeFromParent(),e.removeAllListeners(),e.eventMode="auto",e._disabledTime=Date.now(),this.pool.push(e))}destroyAll(){this.children.forEach(e=>e._disabledTime=Date.now()),this.pool.push(...this.children),this.children.forEach(e=>{e.emit("removed",e.parent),e.removeAllListeners(),e.eventMode="auto"}),this.removeChildren()}_render(e){super._render(e);const t=Date.now();for(;t-this.pool[0]?._disabledTime>(this.options.destroyTimer??5e3);)this.pool.shift().destroy()}}const Ts=10,Ss=16;class Vi extends an{backing=new dt("noBorder");overlay=new ye(xe.WHITE);receptor=new ye(xe.WHITE);selectionOverlay=new ye(xe.WHITE);container=new he;errors=new Ht({create:()=>{const e=new ye(xe.WHITE);return e.tint=16711680,e.alpha=.3,e}});errorMap=new Map;lastHeight=0;lastBeat=-1;mouseDown=!1;queued=!1;verticalMargin=40;backingVerticalPadding=10;backingWidth=32;xOffset=20;dragStartT=0;dragEndT=0;_order=0;static widgets=[];static xGap=10;static xMargin=20;constructor(e,t={}){super(e),t={backingWidth:32,order:0,trigger:"chart",...t},this.backingWidth=t.backingWidth,this.sortableChildren=!0,this._order=t.order,this.addChild(this.backing),this.addChild(this.container),this.visible=!1,Ue(this.backing,"widget-bg"),this.receptor.anchor.x=.5,this.receptor.anchor.y=0,this.receptor.alpha=.3,this.receptor.zIndex=10,this.receptor.height=2,this.addChild(this.receptor),this.overlay.anchor.x=.5,this.overlay.anchor.y=0,this.overlay.alpha=.3,this.overlay.zIndex=10,this.addChild(this.overlay),this.selectionOverlay.anchor.x=.5,this.selectionOverlay.anchor.y=0,this.selectionOverlay.tint=5140387,this.selectionOverlay.alpha=.3,this.selectionOverlay.zIndex=10,this.addChild(this.selectionOverlay),this.errors.zIndex=10,this.addChild(this.errors),this.x=this.manager.app.STAGE_WIDTH/2-this.xOffset,ee.on("chartLoaded",()=>{this.queued=!1,this.populateRange()}),ee.on("parityIgnoresModified",()=>{this.queued||this.populateRange(),this.queued=!0}),ee.on(t.trigger=="chart"?"chartModifiedAfter":"parityModified",()=>{this.queued||this.populateRange(),this.queued=!0}),ee.on("userOptionUpdated",r=>{(r=="chart.CMod"||r=="chart.layoutFollowPosition"||r=="chart.hideWarpedArrows"||r=="chart.hideFakedArrows")&&this.populateRange()});const n=setInterval(()=>{this.queued&&(this.queued=!1,this.populateRange())},3e3);this.on("destroyed",()=>clearInterval(n)),this.eventMode="static",this.on("mousedown",r=>{this.mouseDown=!0,this.handleMouse(r)}),this.on("mousemove",r=>{this.mouseDown&&this.handleMouse(r,!0)}),this.on("mouseup",()=>{this.mouseDown=!1}),this.on("mouseleave",()=>{this.mouseDown=!1}),this.pivot.x=this.backing.width/2,Vi.register(this)}handleMouse(e,t=!1){if(this.manager.chartManager.getMode()==U.Play||!this.getChart())return;const n=this.manager.app.STAGE_HEIGHT-this.verticalMargin;let r=(this.container.toLocal(e.global).y+n/2)/n;if(r=Se(r,0,1),t||(this.dragStartT=r),this.dragEndT=r,!this.getChart().getNotedata().at(-1)||t&&b.chart.layoutFollowPosition)return;const s=this.getSongPositionFromT(r);b.chart.CMod?this.manager.chartManager.time=s.second:this.manager.chartManager.beat=s.beat}update(){this.scale.y=b.chart.reverse?-1:1;const e=this.manager.app.STAGE_HEIGHT-this.verticalMargin;this.backing.height=e+this.backingVerticalPadding,this.backing.position.y=-this.backing.height/2,this.backing.position.x=-this.backing.width/2,this.x=this.manager.app.STAGE_WIDTH/2-this.xOffset;const t=this.getChart(),n=this.manager.chartManager.chartView;if(!t||!n||!pe.layout){this.visible=!1;return}if(this.visible=!0,!t.getNotedata().at(-1)){this.overlay.height=0,this.selectionOverlay.height=0;return}if(this.mouseDown&&b.chart.layoutFollowPosition){const f=this.dragEndT-this.dragStartT;b.chart.CMod?this.manager.chartManager.time=Math.max(-t.timingData.getOffset(),this.manager.chartManager.time+f*xt.shared.deltaMS*Ts/100):this.manager.chartManager.beat=Math.max(0,this.manager.chartManager.beat+f*xt.shared.deltaMS*Ss/100)}const a=n.getBeatFromYPos(-this.manager.app.STAGE_HEIGHT/2,!0),s=n.getBeatFromYPos(this.manager.app.STAGE_HEIGHT/2,!0);let o=this.getYFromBeat(a),l=this.getYFromBeat(s);o>l&&([o,l]=[l,o]),this.overlay.y=o-this.backing.height/2,this.overlay.height=l-o,this.overlay.height=Math.max(2,this.overlay.height);const u=this.manager.chartManager.selection.notes;if(u.length<1)this.selectionOverlay.visible=!1;else{this.selectionOverlay.visible=!0;const f=xn(u.map(p=>p.beat)),c=$r(u.map(p=>Ni(p)));let d=this.getYFromBeat(f),h=this.getYFromBeat(c);d>h&&([d,h]=[h,d]),this.selectionOverlay.y=d-this.backing.height/2,this.selectionOverlay.height=h-d,this.selectionOverlay.height=Math.max(2,this.selectionOverlay.height)}if(this.receptor.y=b.chart.CMod?this.getYFromSecond(n.getVisualTime())-this.backing.height/2:this.getYFromBeat(n.getVisualBeat())-this.backing.height/2,this.manager.app.STAGE_HEIGHT!=this.lastHeight&&(this.lastHeight=this.manager.app.STAGE_HEIGHT,this.updateDimensions(),this.populate()),b.chart.layoutFollowPosition&&n.getVisualBeat()!=this.lastBeat){this.lastBeat=n.getVisualBeat();const f=b.chart.CMod?t.getBeatFromSeconds(this.getTopSecond()):this.getTopBeat(),c=b.chart.CMod?t.getBeatFromSeconds(this.getBottomSecond()):this.getBottomBeat();this.populate(f,c)}this.errors.visible=b.chart.parity.showErrors}populateRange(){const e=this.getChart();if(b.chart.layoutFollowPosition||this.populate(),!e)return;const t=b.chart.CMod?e.getBeatFromSeconds(this.getTopSecond()):this.getTopBeat(),n=b.chart.CMod?e.getBeatFromSeconds(this.getBottomSecond()):this.getBottomBeat();this.populate(t,n)}updateDimensions(){if(!this.getChart())return;const t=this.manager.app.STAGE_HEIGHT-this.verticalMargin;this.backing.height=t+this.backingVerticalPadding,this.backing.width=this.backingWidth,this.overlay.width=this.backingWidth,this.receptor.width=this.backingWidth,this.selectionOverlay.width=this.backingWidth,this.pivot.x=this.backing.width/2}getYFromBeat(e){const n=this.getChart().getSecondsFromBeat(e);let r=0;if(b.chart.CMod){const a=this.getTopSecond(),s=this.getBottomSecond();r=Kt(a,s,n)}else{const a=this.getTopBeat(),s=this.getBottomBeat();r=Kt(a,s,e)}return r=Se(r,0,1),r*(this.manager.app.STAGE_HEIGHT-this.verticalMargin)}getYFromSecond(e){const n=this.getChart().timingData.getBeatFromSeconds(e);return this.getYFromBeat(n)}getSongPositionFromT(e){const t=this.getChart();if(b.chart.CMod){const n=this.getTopSecond(),r=this.getBottomSecond();return{second:Math.max(-t.timingData.getOffset(),Qe(n,r,e)),beat:t.timingData.getBeatFromSeconds(Math.max(-t.timingData.getOffset(),Qe(n,r,e)))}}else{const n=this.getTopBeat(),r=this.getBottomBeat();return{beat:Math.max(0,Qe(n,r,e)),second:t.getSecondsFromBeat(Math.max(0,Qe(n,r,e)))}}}getTopSecond(){const e=this.getChart(),t=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?t.getVisualTime()-Ts:e.timingData.getOffset()}getBottomSecond(){const e=this.getChart(),t=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?t.getVisualTime()+Ts:e.getLastSecond()}getTopBeat(){const e=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?e.getVisualBeat()-Ss:0}getBottomBeat(){const e=this.getChart(),t=this.manager.chartManager.chartView;return b.chart.layoutFollowPosition?t.getVisualBeat()+Ss:e.getLastBeat()}populate(e,t){const n=this.getChart();if(n)if(n.stats.parity){const r=e??this.getTopBeat(),a=t??this.getBottomBeat();for(const s of n.stats.parity.techErrors.keys()){const o=n.stats.parity.rowTimestamps[s];if(o.beat<r||o.beat>a||this.errorMap.has(s))continue;const l=this.errors.createChild();l&&(l.height=1,l.anchor.set(.5,0),this.errorMap.set(s,l))}if(b.chart.parity.showErrors)for(const[s,o]of this.errorMap.entries()){const l=n.stats.parity.rowTimestamps[s],u=n.stats.parity.techErrors.get(s);if(!l||l.beat<r||l.beat>a||!u?.size){this.errorMap.delete(s),this.errors.destroyChild(o);continue}const f=n.getErrorIgnoresAtBeat(l.beat)?.size??0;u.size-f>0?o.tint=16711680:o.tint=8947848,o.y=this.getYFromBeat(l.beat)-this.backing.height/2,o.width=this.backingWidth}}else this.errorMap.clear(),this.errors.destroyAll()}getChart(){return this.manager.chartManager.loadedChart}get order(){return this._order}set order(e){this._order=e,Vi.resort()}static register(e){this.widgets.includes(e)||(this.widgets.length==0&&xt.shared.add(()=>{let t=this.xMargin;this.widgets.forEach(n=>{n.visible&&(n.xOffset=t,t+=n.backingWidth+this.xGap)})}),this.widgets.push(e),this.resort())}static resort(){this.widgets.sort((e,t)=>e.order-t.order)}static getTotalWidgetWidth(){return this.widgets.filter(e=>e.visible).reduce((e,t)=>e+t.backingWidth,0)+this.xGap*(this.widgets.length-1)+this.xMargin}}const st=80;class Om extends an{panels=[];currentRow=-1;lastBeat=0;lastSecond=0;leftFoot;rightFoot;layout;dirty=!1;constructor(e){super(e),this.sortableChildren=!0,ee.on("chartLoaded",()=>this.build()),ee.on("parityModified",()=>this.reindex())}async build(){if(this.removeChildren(),this.panels=[],!this.manager.app.chartManager.loadedChart||(this.layout=Im[this.manager.app.chartManager.loadedChart.gameType.id],!this.layout))return;const e=await Is.load(Rm);let t=0,n=0;this.layout.layout.forEach(d=>{const h=new he,p=new ye(xe.WHITE);p.alpha=.1,p.anchor.set(.5),p.width=st,p.height=st;const m=new ye(xe.WHITE);m.anchor.set(.5),m.width=st,m.height=st,m.blendMode=Fs.COLOR_BURN,Ue(m,"primary-bg-active"),h.addChild(m);const g=new ye(e);g.anchor.set(.5),g.x=d.x,g.y=d.y*-1,g.alpha=.3,g.width=st*.75,g.height=st*.75,g.blendMode=Fs.MULTIPLY,g.rotation=d.rotation,h.bg=p,h.arrow=g,h.x=d.x*st,h.y=d.y*-st,h.addChild(p,g),this.addChild(h),this.panels.push(h),t=Math.max(t,Math.abs(h.x)),n=Math.max(n,Math.abs(h.y))});const r=await Is.load(Pm),a=new he,s=new he,o=new ye(r),l=new ye(r);o.scale.set(st/4*3/o.height),l.scale.set(st/4*3/l.height),o.tint=At(ce.LEFT_HEEL),l.tint=At(ce.RIGHT_HEEL),o.anchor.set(.5),l.anchor.set(.5),l.scale.x*=-1;const u=new ge("L",{fontSize:25,fontName:"Fancy",tint:At(ce.LEFT_HEEL)}),f=new ge("R",{fontSize:25,fontName:"Fancy",tint:At(ce.RIGHT_HEEL)});u.anchor.set(.5),f.anchor.set(.5),a.addChild(o,u),s.addChild(l,f),this.leftFoot=a,this.rightFoot=s,this.leftFoot.zIndex=50,this.rightFoot.zIndex=50,this.addChild(this.leftFoot,this.rightFoot),this.lastBeat=-1,this.pivot.set(t+st/2,n+st/2);const c=d=>{["chart.parity.leftHeelColor","chart.parity.leftToeColor","chart.parity.rightHeelColor","chart.parity.rightToeColor"].includes(d)&&(o.tint=At(ce.LEFT_HEEL),l.tint=At(ce.RIGHT_HEEL),u.tint=At(ce.LEFT_HEEL),f.tint=At(ce.RIGHT_HEEL))};ee.on("userOptionUpdated",c)}reindex(){const e=this.manager.app.chartManager.loadedChart?.stats.parity;if(!e||!this.manager.app.chartManager.chartView)return;const t=this.manager.app.chartManager.chartView.getVisualBeat();let n=hi(e.rowTimestamps,t,r=>r.beat);for(;e.rowTimestamps[n]?.beat<t;)n++;if(n==0&&t<e.rowTimestamps[0].beat){this.currentRow=-1;return}this.currentRow=n,this.dirty=!0}update(){const e=this.manager.app.chartManager.loadedChart?.stats.parity?.states,t=this.manager.chartManager.app.STAGE_WIDTH/2-Vi.getTotalWidgetWidth();if(this.x=t-16,this.y=this.manager.app.STAGE_HEIGHT/2-16,!e||!this.manager.app.chartManager.chartView||!this.layout||!b.chart.parity.enabled||!b.chart.parity.showDancingBot){this.visible=!1;return}this.visible=!0;const n=this.manager.app.chartManager.chartView.getVisualBeat(),r=this.manager.app.chartManager.chartView.getVisualTime();if(!(this.lastSecond==r&&!this.dirty)){if(this.dirty=!1,this.panels.forEach(a=>{const s=(n%1+1)%1;a.arrow.alpha=.3+Se(1-s,.5,1)*.8}),n<this.lastBeat)this.reindex();else for(;e[this.currentRow+1]?.beat<=n;){this.currentRow++;const a=e[this.currentRow];a.action.forEach((s,o)=>{a.holdFeet.has(s)||!s||this.flashPanel(o)})}if(this.lastBeat=n,this.lastSecond=r,this.leftFoot&&this.rightFoot){let a=e[this.currentRow];const s=e[this.currentRow+1]??e.at(-2);if(e.at(-1)==a&&(a=e.at(-2)),a){const o=this.getFeetPosition(a),l=this.getFeetPosition(s);let u=Se(Kt(Math.max(a.second,s.second-.3),s.second,r),0,1);isNaN(u)&&(u=1);const f=this.lerpPositions(o,l,u,s);let c=1,d=1;const h=a.movedFeet.has(ce.LEFT_HEEL),p=a.movedFeet.has(ce.RIGHT_HEEL),m=s.movedFeet.has(ce.LEFT_HEEL),g=s.movedFeet.has(ce.RIGHT_HEEL);if(r>s.second-.1){const y=Se(Kt(s.second-.1,s.second,r),0,1);m&&(c*=Qe(1,.9,y)),g&&(d*=Qe(1,.9,y))}if(r<a.second+.1){const y=Se(Kt(a.second,a.second+.1,r),0,1);h&&(c*=Qe(.9,1,y)),p&&(d*=Qe(.9,1,y))}this.leftFoot.scale.set(c),this.rightFoot.scale.set(d),this.leftFoot.x=f.left.x,this.leftFoot.y=f.left.y,this.leftFoot.rotation=f.left.angle,this.rightFoot.x=f.right.x,this.rightFoot.y=f.right.y,this.rightFoot.rotation=f.right.angle}}}}getFeetPosition(e){const t={x:this.panels[e.footColumns[ce.LEFT_HEEL]]?.position.x??0,y:this.panels[e.footColumns[ce.LEFT_HEEL]]?.position.y??0},n={x:this.panels[e.footColumns[ce.RIGHT_HEEL]]?.position.x??0,y:this.panels[e.footColumns[ce.RIGHT_HEEL]]?.position.y??0};e.footColumns[ce.LEFT_TOE]!=-1&&(t.x=(t.x+this.panels[e.footColumns[ce.LEFT_TOE]].position.x)/2,t.y=(t.y+this.panels[e.footColumns[ce.LEFT_TOE]].position.y)/2),e.footColumns[ce.RIGHT_TOE]!=-1&&(n.x=(n.x+this.panels[e.footColumns[ce.RIGHT_TOE]].position.x)/2,n.y=(n.y+this.panels[e.footColumns[ce.RIGHT_TOE]].position.y)/2),this.layout.name=="dance-single"&&(Math.abs(t.x)<=st/4&&(t.x-=st/4,t.y*=.5),Math.abs(n.x)<=st/4&&(n.x+=st/4,n.y*=.5),n.x<-st/4*3&&(n.y-=st/4*Math.sign(t.y),n.x+=st/4),t.x>st/4*3&&(t.y-=st/4*Math.sign(t.y),t.x-=st/4));let r=this.getPlayerAngle(t,n)/5,a=r;return e.footColumns[ce.LEFT_TOE]!=-1&&(r=-this.getPlayerAngle({x:this.panels[e.footColumns[ce.LEFT_HEEL]].position.x,y:this.panels[e.footColumns[ce.LEFT_HEEL]].position.y},{x:this.panels[e.footColumns[ce.LEFT_TOE]].position.x,y:this.panels[e.footColumns[ce.LEFT_TOE]].position.y})+Math.PI/2),e.footColumns[ce.RIGHT_TOE]!=-1&&(a=-this.getPlayerAngle({x:this.panels[e.footColumns[ce.RIGHT_HEEL]].position.x,y:this.panels[e.footColumns[ce.RIGHT_HEEL]].position.y},{x:this.panels[e.footColumns[ce.RIGHT_TOE]].position.x,y:this.panels[e.footColumns[ce.RIGHT_TOE]].position.y})+Math.PI/2),{left:{x:t.x,y:t.y,angle:r},right:{x:n.x,y:n.y,angle:a}}}getPlayerAngle(e,t){const n=t.x-e.x,r=t.y-e.y,a=1,s=0,o=n*a+r*s,l=n*s-r*a;return Math.atan2(l,o)}lerpPositions(e,t,n,r){const a=r.movedFeet.has(ce.LEFT_HEEL),s=r.movedFeet.has(ce.RIGHT_HEEL);return{left:{x:Qe(e.left.x,t.left.x,n),y:Qe(e.left.y,t.left.y,n),angle:a?Qe(e.left.angle,t.left.angle,n):e.left.angle},right:{x:Qe(e.right.x,t.right.x,n),y:Qe(e.right.y,t.right.y,n),angle:s?Qe(e.right.angle,t.right.angle,n):e.right.angle}}}flashPanel(e){const t=this.panels[e];t&&lt.animate(t.bg,{0:{alpha:.6},1:{alpha:.1}},.4,mt(.19,1.15,.55,.96),void 0,"panel-"+e)}}function Zt(i,e){let t=i.length;if(i.length!=0)for(;t--;)e(i[t],t)&&i[t].destroy()}function qr(i){return i.button==2||i.getModifierState("Control")&&ii}function Zg(i,e,t,n,r){const a=[];for(let s=0;s<t;s++){const o=[];for(let l=0;l<e;l++)o.push(new xe(i.baseTexture,new Kn(n*l,r*s,n,r)));a.push(o)}return a}async function Qg(i){const e=i.split(`
`),t=parseInt(e[0]),n=parseInt(e[t+1]),r=[],a=[],s=[];for(let o=0;o<t;o++){const l=/(-?[0-9.]+)\s+(-?[0-9.]+)\s+(-?[0-9.]+)\s+(-?[0-9.]+)/.exec(e[o+1]);if(l)r.push(parseFloat(l[1])),r.push(parseFloat(l[2])),a.push(parseFloat(l[3])),a.push(parseFloat(l[4]));else return console.error("Failed to load vertex "+e[o+1]),new ca}for(let o=0;o<n;o++){const l=/(-?[0-9.]+)\s+(-?[0-9.]+)\s+(-?[0-9.]+)/.exec(e[o+2+t]);if(l)s.push(parseFloat(l[1])),s.push(parseFloat(l[2])),s.push(parseFloat(l[3]));else return console.error("Failed to load triangle "+e[o+2+t]),new ca}return new ca().addAttribute("aVertexPosition",r,2).addAttribute("aUvs",a,2).addIndex(s)}const Ve=300,rt=150,Dc=[.045,.09,.18,.37,.18,.09,.045];class Nm extends an{max=0;barlines=new he;backgroundRect=new dt("noBorder");background=new he;backgroundLines=new he;statText=new he;meanText;medianText;modeText;stddevText;errorMS=[];texts=new he;showEase=0;toggled=!1;drag=!1;dragStart=0;lastMode=this.manager.chartManager.getMode();constructor(e){super(e),this.visible=!1,this.background.addChild(this.backgroundRect),Ue(this.backgroundRect,"widget-bg"),this.addChild(this.background),this.addChild(this.backgroundLines),this.eventMode="static",this.on("mousedown",()=>{this.manager.chartManager.getMode()!=U.Play&&(this.drag=!0,this.dragStart=Date.now(),lt.stop("play-widget"))}),window.addEventListener("mousemove",p=>{this.drag&&(this.showEase+=p.movementY/-400)}),window.addEventListener("mouseup",()=>{this.drag&&(Date.now()-this.dragStart>400?this.toggled=this.showEase>.5:this.toggled=!this.toggled,lt.animate(this,{0:{showEase:"inherit"},1:{showEase:this.toggled?1:0}},.6,mt(.11,.71,.33,1.39),()=>{},"play-widget")),this.drag=!1}),this.on("mouseenter",()=>{!this.toggled&&this.manager.chartManager.getMode()!=U.Play&&lt.animate(this,{0:{showEase:"inherit"},1:{showEase:.05}},.6,mt(.11,.71,.33,1.39),()=>{},"play-widget")}),this.on("mouseleave",()=>{!this.toggled&&this.manager.chartManager.getMode()!=U.Play&&lt.animate(this,{0:{showEase:"inherit"},1:{showEase:0}},.6,mt(.11,.71,.33,1.39),()=>{},"play-widget")});const t=new ge("Early",{fontName:"Main",fontSize:15});t.x=-Ve/2+5,t.y=-rt-40,t.alpha=.3,this.background.addChild(t),Ue(t,"text-color");const n=new ge("Late",{fontName:"Main",fontSize:15});n.anchor.x=1,n.x=Ve/2-5,n.y=-rt-40,n.alpha=.3,this.background.addChild(n),Ue(n,"text-color"),this.meanText=new ge("-",{fontName:"Main",fontSize:15}),this.meanText.anchor.x=.5,this.meanText.x=Ve/4*-1.5,this.meanText.y=-rt-70,this.statText.addChild(this.meanText),this.medianText=new ge("-",{fontName:"Main",fontSize:15}),this.medianText.anchor.x=.5,this.medianText.x=Ve/4*-.5,this.medianText.y=-rt-70,this.statText.addChild(this.medianText),this.modeText=new ge("-",{fontName:"Main",fontSize:15}),this.modeText.anchor.x=.5,this.modeText.x=Ve/4*.5,this.modeText.y=-rt-70,this.statText.addChild(this.modeText),this.stddevText=new ge("-",{fontName:"Main",fontSize:15}),this.stddevText.anchor.x=.5,this.stddevText.x=Ve/4*1.5,this.stddevText.y=-rt-70,this.statText.addChild(this.stddevText);const r=new ge("Mean",{fontName:"Main",fontSize:10});r.anchor.x=.5,r.x=Ve/4*-1.5,r.y=-rt-80,this.statText.addChild(r);const a=new ge("Median",{fontName:"Main",fontSize:10});a.anchor.x=.5,a.x=Ve/4*-.5,a.y=-rt-80,this.statText.addChild(a);const s=new ge("Mode",{fontName:"Main",fontSize:10});s.anchor.x=.5,s.x=Ve/4*.5,s.y=-rt-80,this.statText.addChild(s);const o=new ge("Std Dev.",{fontName:"Main",fontSize:10});o.anchor.x=.5,o.x=Ve/4*1.5,o.y=-rt-80,this.statText.addChild(o),this.statText.children.forEach(p=>{Ue(p,"text-color")});const l=new he,u=new dt("noBorder");u.tint=3355443,u.alpha=.3,u.width=Ve/2-10,u.height=30,u.y=-25,u.x=-Ve/4,u.pivot.x=(Ve/2-10)/2,u.pivot.y=15;const f=new ge("Adjust song offset",{fontName:"Main",fontSize:12});f.anchor.set(.5),f.x=-Ve/4,f.y=-25,l.addChild(u,f),l.eventMode="static",l.addEventListener("mouseenter",()=>{u.alpha=.6}),l.addEventListener("mousedown",p=>{p.stopImmediatePropagation(),this.adjustOffset("song")}),l.addEventListener("mouseleave",()=>{u.alpha=.3}),this.statText.addChild(l),Ue(f,"text-color");const c=new he,d=new dt("noBorder");d.tint=3355443,d.alpha=.3,d.width=Ve/2-10,d.height=30,d.y=-25,d.x=Ve/4,d.pivot.x=(Ve/2-10)/2,d.pivot.y=15,d.eventMode="static",c.addEventListener("mouseenter",()=>{d.alpha=.6}),c.addEventListener("mouseleave",()=>{d.alpha=.3});const h=new ge("Adjust global offset",{fontName:"Main",fontSize:12});h.anchor.set(.5),h.x=Ve/4,h.y=-25,c.addChild(d,h),Ue(h,"text-color"),c.eventMode="static",c.addEventListener("mouseenter",()=>{d.alpha=.6}),c.addEventListener("mousedown",p=>{p.stopImmediatePropagation(),this.adjustOffset("global")}),c.addEventListener("mouseleave",()=>{d.alpha=.3}),this.statText.addChild(c),this.addChild(this.background),this.addChild(this.backgroundLines),this.eventMode="static",this.addChild(this.statText),this.addChild(this.barlines),this.addChild(this.texts)}update(){this.visible=!!this.manager.chartManager.gameStats,this.x=-this.manager.chartManager.app.STAGE_WIDTH/2+20+Ve/2,this.y=this.manager.chartManager.app.STAGE_HEIGHT/2-20,this.backgroundRect.width=Ve+10,this.backgroundRect.height=rt+260,this.backgroundRect.x=-Ve/2-5,this.backgroundRect.y=-rt-260,this.visible=!!this.manager.chartManager.gameStats;for(const e of this.barlines.children)b.general.smoothAnimations?e.height=(e.targetHeight-e.height)*.2+e.height:e.height=e.targetHeight;this.lastMode!=this.manager.chartManager.getMode()&&(this.lastMode=this.manager.chartManager.getMode(),lt.animate(this,{0:{showEase:"inherit"},1:{showEase:this.manager.chartManager.getMode()==U.Play?1:0}},.6,mt(.11,.71,.33,1.39),()=>{},"play-widget")),b.general.smoothAnimations?this.y+=(1-Math.abs(this.showEase))*400:this.manager.chartManager.getMode()!=U.Play&&(this.y+=400)}newLine(){const e=new ye(xe.WHITE);return e.smoothCount=0,e.targetHeight=0,e.anchor.y=1,e.anchor.x=.5,e.height=0,e.visible=!1,e}startPlay(){const e=this.manager.chartManager.gameStats;this.max=0,this.errorMS=[],this.meanText.text="-",this.medianText.text="-",this.modeText.text="-",this.stddevText.text="-",Zt(this.barlines.children,()=>!0),Zt(this.backgroundLines.children,()=>!0),Zt(this.texts.children,()=>!0);const t=kt.getCollection(b.play.timingCollection),n=t.getStandardWindows().length+1,r=Math.round(t.maxWindowMS());for(let p=0;p<r*2;p++){const m=this.newLine();m.width=Ve/r/2,m.x=(p-r)*m.width,m.y=-50,this.barlines.addChild(m)}let a=0;for(const p of t.getStandardWindows().reverse()){const m=Math.round(p.getTimingWindowMS());if(m!=0){for(let g=-1;g<=1;g+=2){const y=new ye(xe.WHITE);y.anchor.y=1,y.anchor.x=.5,y.height=rt,y.tint=p.color,y.alpha=.2,y.width=1,y.x=m*g*Ve/r/2,y.y=-50,this.backgroundLines.addChild(y)}for(let g=-m+r;g<m+r;g++)this.barlines.children[Math.round(g)].tint=p.color}}const s=new ye(xe.WHITE);s.anchor.y=1,s.anchor.x=.5,s.height=rt,s.alpha=.2,s.width=1,s.tint=8947848,s.y=-50,this.backgroundLines.addChild(s);for(const p of[...t.getStandardWindows(),t.getMissJudgement()]){const m=new ge(p.name,{fontName:"Main",fontSize:15}),g=new ge("0",{fontName:"Main",fontSize:15});m.tint=p.color,g.tint=p.color,g.name=p.id,this.texts.addChild(m),this.texts.addChild(g),m.x=-Ve/2+10,g.x=-Ve/2+140,m.y=130/n*a-rt-220,g.y=130/n*a++-rt-220,m.anchor.y=.5,g.anchor.y=.5,g.anchor.x=1}const o=this.manager.chartManager.loadedChart?.gameType.gameLogic.usesHoldTicks??!1,l=(o?0:t.getHoldWindows().length)+2;a=0;for(const p of o?[t.getMineJudgement()]:[...t.getHoldWindows(),t.getMineJudgement()]){const m=yn(p)?p.noteType:"Mine",g=new ge(m,{fontName:"Main",fontSize:15}),y=new ge("0",{fontName:"Main",fontSize:15});Ue(g,"text-color"),Ue(y,"text-color"),m!="Mine"&&(y.text="0 / "+this.manager.chartManager.loadedChart.getNotedata().filter(x=>x.type==m&&!x.fake).length),g.alpha=.8,y.alpha=.8,y.name=m,this.texts.addChild(g),this.texts.addChild(y),g.x=-Ve/2+160,y.x=-Ve/2+290,g.y=80/l*a-rt-220,y.y=80/l*a++-rt-220,g.anchor.y=.5,y.anchor.y=.5,y.anchor.x=1}const u=new ge("Max Combo",{fontName:"Main",fontSize:15});Ue(u,"text-color");const f=new ge("0",{fontName:"Main",fontSize:15});Ue(f,"text-color"),u.alpha=.8,f.alpha=.8,f.name="Combo",this.texts.addChild(u),this.texts.addChild(f),u.x=-Ve/2+160,f.x=-Ve/2+290,u.y=80/l*a-rt-220,f.y=80/l*a++-rt-220,u.anchor.y=.5,f.anchor.y=.5,f.anchor.x=1;const c=new ge("0.00 / 0.00",{fontName:"Main",fontSize:20});Ue(c,"text-color"),c.alpha=.8,c.x=-Ve/2+225,c.y=-rt-112,c.name="Score",this.texts.addChild(c),c.anchor.set(.5);const d=new ge("Score / Current Score",{fontName:"Main",fontSize:13});Ue(d,"text-color"),d.alpha=.5,d.x=-Ve/2+225,d.y=-rt-135,this.texts.addChild(d),d.anchor.set(.5);const h=new ge("Play Statistics",{fontName:"Main",fontSize:13});h.y=-rt-245,h.anchor.set(.5),Ue(h,"text-color"),this.texts.addChild(h),e.onJudge((p,m)=>{let g="";(mi(m)||xi(m))&&(g=m.id),yn(m)&&(g=m.noteType),eo(m)&&(g="Mine");const y=this.texts.getChildByName(g);if(yn(m)){const w=y.text.split(" / ")[1];y.text=e.getCount(m)+" / "+w}else Xn(m)||(y.text=e.getCount(m)+"");if(this.texts.getChildByName("Combo").text=e.getMaxCombo()+"",this.texts.getChildByName("Score").text=fe(e.getScore()*100,2).toFixed(2)+" / "+fe(e.getCumulativeScore()*100,2).toFixed(2),mi(m)||!xi(m)||p==null)return;const x=Math.round(p*1e3);for(let w=-3;w<=3;w++)this.barlines.children[x+r+w]&&(this.barlines.children[x+r+w].smoothCount+=Dc[w+3],this.barlines.children[x+r+w].visible=!0,this.barlines.children[x+r+w].smoothCount>this.max&&(this.modeText.text=x+"ms",this.max=this.barlines.children[x+r+w].smoothCount));this.errorMS.push(p*1e3),this.meanText.text=gd(this.errorMS).toFixed(2)+"ms",this.medianText.text=jr(this.errorMS).toFixed(2)+"ms",this.stddevText.text=zc(this.errorMS).toFixed(2)+"ms",this.redraw()})}redraw(){for(const e of this.barlines.children)e.targetHeight=e.smoothCount*(rt-20)/this.max}adjustOffset(e){const t=this.manager.chartManager.gameStats;if(!t)return;const n=Math.round(t.getMedian()*1e3)/1e3;if(n==0)return;t.applyOffset(-n),this.barlines.children.forEach(o=>{o.smoothCount=0});const r=kt.getCollection(b.play.timingCollection),a=Math.round(r.maxWindowMS());t.getDataPoints().forEach(o=>{if(mi(o.judgement)||!xi(o.judgement)||o.error===null)return;const l=Math.round(o.error*1e3);for(let u=-3;u<=3;u++)this.barlines.children[l+a+u]&&(this.barlines.children[l+a+u].smoothCount+=Dc[u+3],this.barlines.children[l+a+u].visible=!0,this.barlines.children[l+a+u].smoothCount>this.max&&(this.modeText.text=l+"ms",this.max=this.barlines.children[l+a+u].smoothCount))}),this.redraw();const s=e=="global"?b.play.offset:this.manager.app.chartManager.loadedChart.timingData.getOffset();if(e=="global")b.play.offset=fe(b.play.offset-n,3);else if(e=="song"){const o=this.manager.app.chartManager.loadedChart.timingData.hasChartOffset()?this.manager.app.chartManager.loadedChart.timingData:this.manager.app.chartManager.loadedSM.timingData;o.setOffset(fe(o.getOffset()-n,3))}ue.create(`Adjusted ${e} offset from ${fe(s,3).toFixed(3)} to ${fe(s-n,3).toFixed(3)}`)}}class Hm extends an{registeredSpinners=[];registeredToggles=[];registeredCheckboxes=[];changeRow;warpRow;fakeRow;view;collapseButton;lastSpeedMod=b.chart.CMod;rateSpinner;enteredMain=!1;constructor(e){super(e),this.visible=!1;const t=document.createElement("div");t.id="playback-options",b.general.showPlaybackOptions||t.classList.add("collapsed"),t.style.height="0px",ee.on("resize",()=>{this.registeredToggles.forEach(G=>{G.update(!1)})}),document.getElementById("menubar")?.insertAdjacentElement("afterend",t),this.view=t;const n=document.createElement("button");n.classList.add("po-collapse"),n.tabIndex=-1;const r=be.getIcon("CHEVRON",18);n.appendChild(r),b.general.showPlaybackOptions&&n.classList.add("toggled"),this.collapseButton=n,n.onclick=()=>{b.general.showPlaybackOptions=!b.general.showPlaybackOptions,t.classList.toggle("collapsed"),n.classList.toggle("toggled",!t.classList.contains("collapsed")),n.blur()},n.style.display="none",Ze(n,{onShow(G){G.setContent((t.classList.contains("collapsed")?"Show ":"Hide ")+"playback options")}});const a=this.createRow("Zoom"),s=this.createSpinner({value:b.chart.zoom*100,step:10,altStep:2,min:10,hardMin:0,onChange:G=>b.chart.zoom=G/100,getValue:()=>b.chart.zoom*100});a.appendChild(s),t.appendChild(a);const o=document.createElement("div"),l=document.createElement("h1");l.innerText="a",o.appendChild(l),Ae.createKeybindTooltip(a)`Adjust playfield size ${"zoomOut"}/${"zoomIn"}`,t.appendChild(this.createSeparator());const u=this.createRow("Playback"),f=this.createSpinner({value:b.audio.rate*100,step:10,altStep:2,min:10,hardMin:0,onChange:G=>b.audio.rate=G/100,getValue:()=>b.audio.rate*100});u.appendChild(f),t.appendChild(u),this.rateSpinner=this.registeredSpinners.at(-1),Ae.createKeybindTooltip(u)`Adjust audio playback rate  ${"rateDown"}/${"rateUp"}`;const c=document.createElement("div");c.style.gap="0.25rem",c.style.display="flex",c.style.alignItems="center";const d=this.createCheckbox({getValue:()=>b.audio.assistTick,value:b.audio.assistTick,onEl:be.getIcon("CLAP",18),offEl:be.getIcon("X_CLAP",18),onChange:G=>b.audio.assistTick=G});c.appendChild(d),Ae.createKeybindTooltip(d)`Toggle assist tick ${"assistTick"}`;const h=this.createCheckbox({getValue:()=>b.audio.metronome,value:b.audio.metronome,onEl:be.getIcon("METRONOME",18),offEl:be.getIcon("X_METRONOME",18),onChange:G=>b.audio.metronome=G});c.appendChild(h),t.appendChild(c),Ae.createKeybindTooltip(h)`Toggle metronome ${"metronome"}`,t.appendChild(this.createSeparator());const p=this.createRow("Scroll"),m=be.getIcon("DBL_CHEVRON",16);m.style.padding="0.125rem";const g=be.getIcon("DBL_CHEVRON",16);g.style.padding="0.125rem",g.style.transform="rotate(180deg)";const y=this.createToggle({values:[m,g],value:b.chart.reverse?1:0,getValue:()=>b.chart.reverse?1:0,onChange:(G,V)=>b.chart.reverse=V!=0});p.appendChild(y),t.appendChild(p),Ae.createKeybindTooltip(p)`Change scroll direction ${"reverse"}`;const x=this.createRow("Speedmod"),w=this.createToggle({values:["X","C"],value:b.chart.CMod?1:0,getValue:()=>b.chart.CMod?1:0,onChange:G=>b.chart.CMod=G!="X"});Ae.createKeybindTooltip(w)`Change speedmod type ${"XMod"}/${"CMod"}`;const _=this.createSpinner({value:b.chart.speed,step:25,altStep:5,min:10,hardMin:10,hardMax:35e3,onChange:G=>b.chart.speed=G,getValue:()=>b.chart.speed});x.appendChild(w),x.appendChild(_),t.appendChild(x),Ae.createKeybindTooltip(_)`Adjust scroll speed ${"increaseScrollSpeed"}/${"decreaseScrollSpeed"}`,t.appendChild(this.createSeparator());const C=this.createRow("Speed Changes"),F=this.createToggle({values:["On","Off"],value:b.chart.doSpeedChanges?0:1,getValue:()=>b.chart.doSpeedChanges?0:1,onChange:G=>b.chart.doSpeedChanges=G=="On"});C.appendChild(F),t.appendChild(C),Ae.createKeybindTooltip(C)`Allow scroll/speed events (XMod only) ${"doSpeedChanges"}`,this.changeRow=C;const T=this.createRow("Warped Notes"),R=this.createCheckbox({getValue:()=>b.chart.hideWarpedArrows,value:b.chart.hideWarpedArrows,onEl:be.getIcon("X_EYE",18),offEl:be.getIcon("EYE",18),onChange:G=>b.chart.hideWarpedArrows=G});T.appendChild(R),t.appendChild(T),Ae.createKeybindTooltip(T)`Show/hide warped notes (CMod only) ${"hideWarpedArrows"}`,this.warpRow=T;const N=this.createRow("Faked Notes"),j=this.createCheckbox({getValue:()=>b.chart.hideFakedArrows,value:b.chart.hideFakedArrows,onEl:be.getIcon("X_EYE",18),offEl:be.getIcon("EYE",18),onChange:G=>b.chart.hideFakedArrows=G});N.appendChild(j),t.appendChild(N),Ae.createKeybindTooltip(N)`Show/hide faked notes (CMod only) ${"hideFakedArrows"}`,this.fakeRow=N;const ae=be.getIcon("VOLUME",22);ae.style.marginLeft="auto",ae.style.marginRight="-1rem",ae.style.height="1.375rem",ae.style.width="1.375rem",ae.style.alignSelf="center",t.appendChild(ae);const L=this.createRow("Master"),O=this.createSpinner({value:b.audio.masterVolume*100,step:5,altStep:1,min:0,max:200,hardMin:0,hardMax:200,onChange:G=>b.audio.masterVolume=G/100,getValue:()=>b.audio.masterVolume*100});L.appendChild(O),t.appendChild(L);const v=this.createRow("Song"),S=this.createSpinner({value:b.audio.songVolume*100,step:5,altStep:1,min:0,max:200,hardMin:0,hardMax:200,onChange:G=>b.audio.songVolume=G/100,getValue:()=>b.audio.songVolume*100});v.appendChild(S),t.appendChild(v);const Y=this.createRow("FX"),D=this.createSpinner({value:b.audio.soundEffectVolume*100,step:5,altStep:1,min:0,max:200,hardMin:0,hardMax:200,onChange:G=>b.audio.soundEffectVolume=G/100,getValue:()=>b.audio.soundEffectVolume*100});Y.appendChild(D),t.appendChild(Y),this.changeRow.style.setProperty("--w",this.changeRow.offsetWidth/16+"rem"),this.warpRow.style.setProperty("--w",this.warpRow.offsetWidth/16+"rem"),this.fakeRow.style.setProperty("--w",this.fakeRow.offsetWidth/16+"rem"),this.changeRow.classList.toggle("hidden",b.chart.CMod),this.warpRow.classList.toggle("hidden",!b.chart.CMod),this.fakeRow.classList.toggle("hidden",!b.chart.CMod),pe.playbackOptions||(t.style.display="none",n.style.display="none")}createRow(e){const t=document.createElement("div");t.classList.add("playback-options-row");const n=document.createElement("div");return n.classList.add("playback-options-label"),n.innerText=e,t.appendChild(n),t}createSeparator(){const e=document.createElement("div");return e.classList.add("po-separator"),e}createSpinner(e){const t=document.createElement("div");t.classList.add("po-spinner");const n=u=>{let f=b.general.spinnerStep;return u.getModifierState("Shift")?f=e.altStep??(e.step!==void 0?e.step/10:b.general.spinnerStep):f=e.step??b.general.spinnerStep,f},r=document.createElement("button");r.classList.add("po-spinner-btn"),r.innerText="-",r.onclick=u=>{l.currentValue-=n(u),e.min!==void 0&&l.currentValue<e.min&&(l.currentValue=e.min),o(!0)};const a=document.createElement("button");a.classList.add("po-spinner-btn"),a.innerText="+",a.onclick=u=>{l.currentValue+=n(u),e.max!==void 0&&l.currentValue>e.max&&(l.currentValue=e.max),o(!0)};const s=document.createElement("input");s.classList.add("po-spinner-input"),s.type="text";const o=(u=!0)=>{e.hardMin!==void 0&&l.currentValue<e.hardMin&&(l.currentValue=e.hardMin),e.hardMax!==void 0&&l.currentValue>e.hardMax&&(l.currentValue=e.hardMax),u&&e.onChange(l.currentValue),s.value=l.currentValue.toFixed()};s.addEventListener("wheel",u=>{u.preventDefault(),l.currentValue+=n(u)*u.deltaY/100*(b.chart.scroll.invertZoomScroll?-1:1)*b.chart.scroll.scrollSensitivity,e.max!==void 0&&l.currentValue>e.max&&(l.currentValue=e.max),e.min!==void 0&&l.currentValue<e.min&&(l.currentValue=e.min),o(!0)});const l={btnMinus:r,btnPlus:a,input:s,options:e,currentValue:e.value??0,update:o};return o(),t.replaceChildren(r,s,a),s.spellcheck=!1,s.onkeydown=u=>{u.key=="Enter"&&s.blur(),u.key=="Escape"&&(l.currentValue=e.getValue(),o(!1))},s.onfocus=()=>{s.select()},s.onblur=()=>{const u=this.parseString(s);if(u==null){l.currentValue=e.getValue(),o(!1);return}l.currentValue=u,o()},s.ondragstart=u=>u.preventDefault(),this.registeredSpinners.push(l),t}createToggle(e){const t=document.createElement("div");if(t.classList.add("po-toggle"),e.values.length==0)return t;const n=document.createElement("div");n.classList.add("po-toggle-highlight");const r=e.values.map((l,u)=>{if(typeof l=="string"){const f=document.createElement("div");return f.classList.add("po-toggle-item"),f.innerText=l,t.appendChild(f),f.onclick=()=>{o.currentValue!=u&&(o.currentValue=u,s())},f}else return l.onclick=()=>{o.currentValue!=u&&(o.currentValue=u,s())},t.appendChild(l),l});t.style.visibility="hidden",document.body.appendChild(t);const a=l=>{n.style.left=r[l].getBoundingClientRect().left-r[0].getBoundingClientRect().left+"px",n.style.width=r[l].getBoundingClientRect().width+"px",n.style.height=r[l].getBoundingClientRect().height+"px"},s=(l=!0)=>{l&&e.onChange(e.values[o.currentValue],o.currentValue),[...t.querySelectorAll(".active")].forEach(u=>u.classList.remove("active")),a(o.currentValue),r[o.currentValue].classList.add("active")},o={currentValue:e.value??0,options:e,update:s};return this.registeredToggles.push(o),s(!1),t.remove(),t.style.visibility="",t.appendChild(n),t}createCheckbox(e){const t=document.createElement("div");t.classList.add("ico-checkbox");const n=(a=!0)=>{a&&e.onChange(r.currentValue),r.options.onEl.style.display=r.currentValue?"":"none",r.options.offEl.style.display=r.currentValue?"none":""},r={currentValue:e.value??!0,options:e,update:n};return t.onclick=()=>{r.currentValue=!r.currentValue,n()},this.registeredCheckboxes.push(r),n(!1),t.replaceChildren(r.options.onEl,r.options.offEl),t}update(){!this.enteredMain&&this.manager.chartManager.loadedChart!==void 0&&pe.menuBar&&(this.enteredMain=!0,this.view.style.height="",this.collapseButton.style.display="",document.getElementById("menubar")?.appendChild(this.collapseButton));for(const t of this.registeredSpinners)t.currentValue!=t.options.getValue()&&document.activeElement!=t.input&&(t.currentValue=t.options.getValue(),t.update(!1));for(const t of this.registeredToggles)t.currentValue!=t.options.getValue()&&(t.currentValue=t.options.getValue(),t.update(!1));for(const t of this.registeredCheckboxes)t.currentValue!=t.options.getValue()&&(t.currentValue=t.options.getValue(),t.update(!1));const e=this.manager.chartManager.getMode()==U.Play||this.manager.chartManager.getMode()==U.Record;this.rateSpinner.btnMinus.disabled=e,this.rateSpinner.btnPlus.disabled=e,this.rateSpinner.input.disabled=e,b.chart.CMod!=this.lastSpeedMod&&(this.lastSpeedMod=b.chart.CMod,this.changeRow.classList.toggle("hidden",b.chart.CMod),this.warpRow.classList.toggle("hidden",!b.chart.CMod),this.fakeRow.classList.toggle("hidden",!b.chart.CMod))}parseString(e){try{const t=Wc.evaluate(e.value);return isFinite(t)?t:0}catch{return null}}}const Ei={BPMS:9182254,STOPS:4934913,DELAYS:217453,WARPS:9243998,FAKES:4868682,COMBOS:939078,SPEEDS:2968693,LABELS:7747359,SCROLLS:3557006,TIMESIGNATURES:5392684,TICKCOUNTS:1594906,BGCHANGES:8460415,FGCHANGES:8857115,ATTACKS:1856083};class zm extends he{isEditGUI=!0;renderer;areaPool=new Ht({create:()=>{const e=new ye(xe.WHITE);return Object.assign(e,{alpha:.2,width:this.renderer.chart.gameType.notefieldWidth+128}),e.anchor.set(.5,0),e}});timingAreaMap=new Map;timingEvents=[];timingDirty=!0;constructor(e){super(),this.renderer=e,this.addChild(this.areaPool);const t=()=>this.timingDirty=!0;ee.on("timingModified",t),this.on("destroyed",()=>ee.off("timingModified",t))}update(e,t){this.timingDirty&&(this.timingAreaMap.clear(),this.areaPool.destroyAll(),this.timingDirty=!1,this.timingEvents=this.renderer.chart.timingData.getTimingData("STOPS","WARPS","DELAYS","FAKES"));for(const n of this.timingEvents){if(n.beat>t)break;if(this.shouldDrawEvent(n,e,t)&&!this.timingAreaMap.has(n)){const r=this.areaPool.createChild();if(!r)break;r.tint=Ei[n.type],this.timingAreaMap.set(n,r)}}for(const[n,r]of this.timingAreaMap.entries()){if(!this.shouldDrawEvent(n,e,t)){this.timingAreaMap.delete(n),this.areaPool.destroyChild(r);continue}let a=b.chart.CMod?this.renderer.getYPosFromSecond(n.second):this.renderer.getYPosFromBeat(n.beat),s=a;switch(n.type){case"STOPS":case"DELAYS":{b.chart.CMod&&n.value>0?s=this.renderer.getYPosFromSecond(n.second+n.value):n.value<0&&(s=this.renderer.getYPosFromBeat(this.renderer.chart.getBeatFromSeconds(n.second+1e-4)));break}case"FAKES":{s=this.renderer.getYPosFromBeat(n.beat+n.value);break}case"WARPS":{b.chart.CMod||(s=this.renderer.getYPosFromBeat(n.beat+n.value));break}}s<a&&([s,a]=[a,s]);const o=s-a;r.y=a,r.height=o}}shouldDrawEvent(e,t,n){return(e.type=="STOPS"||e.type=="DELAYS")&&e.second+Math.abs(e.value)<=this.renderer.chart.timingData.getSecondsFromBeat(t)||(e.type=="WARPS"||e.type=="FAKES")&&e.beat+e.value<t||(e.type=="STOPS"||e.type=="DELAYS")&&!(!b.chart.CMod&&e.value<0||b.chart.CMod&&e.value>0)||e.type=="WARPS"&&b.chart.CMod?!1:e.beat<=n}}const Ye={chart:{title:"Chart Timing Column",desc:"Events in this column are only used by this difficulty",convertText:"Convert to song timing",buttonOne:{text:"Copy chart events",tooltip:"Copies chart events from this column to song timing",tooltipAll:"Copies offset and chart events from all columns to song timing",action:(i,e)=>{i.copyColumnsToSimfile([e])},actionAll:i=>{i.copyAllToSimfile()}},buttonTwo:{text:"Delete chart events",tooltip:"Reverts this column to the events in song timing, deleting any difficulty-specific events",tooltipAll:"Reverts offset and all columns to the events in song timing, deleting any difficulty-specific events",action:(i,e)=>{i.deleteColumns([e])},actionAll:i=>{i.deleteAllChartSpecific()}}},song:{title:"Song Timing Column",desc:"Events in this column are used by all difficulties (unless overridden)",convertText:"Convert to chart timing",buttonOne:{text:"Copy song events",tooltip:"Copies song events from this column to chart timing",tooltipAll:"Copies offset and song events from all columns to chart timing",action:(i,e)=>{i.copyColumnsFromSimfile([e])},actionAll:i=>{i.copyAllFromSimfile()}},buttonTwo:{text:"Don't copy song events",tooltip:"Converts this column to chart timing without copying any song events",tooltipAll:"Converts offset and all columns to chart timing without copying any song events",action:(i,e)=>{i.createChartColumns([e])},actionAll:i=>{i.createEmptyData()}}}},Wi={chart:{title:"Chart Specific Offset",desc:"This offset is only used by this difficulty",convertText:"Convert to song timing",buttonOne:{text:"Copy chart offset",tooltip:"Sets the song offset to this chart offset",action:i=>{i.copyOffsetToSimfile()}},buttonTwo:{text:"Revert to song offset",tooltip:"Reverts to the song offset, removing the chart-specific offset",action:i=>{i.removeChartOffset()}}},song:{title:"Song Specific Offset",desc:"This offset is used by all difficulties (unless overridden)",convertText:"Convert to chart timing",buttonOne:{text:"Copy song offset",tooltip:"Copies song offset to the chart offset",action:i=>{i.setOffset(i.getOffset())}},buttonTwo:{text:"Don't copy song offset",tooltip:"Sets the new chart offset to 0",action:i=>{i.setOffset(0)}}}},Bc=150;class Ui{static active=!1;static persistent=!1;static options;static popup;static view;static title;static desc;static editText;static clickOutside;static moveInterval;static updateInterval;static _open(e){if(!this.active){if(this.options=e,this._build(),!document.getElementById("popups")){console.error("Failed to open popup!","error");return}document.getElementById("popups")?.appendChild(this.popup),this.clickOutside&&window.removeEventListener("click",this.clickOutside,!0),this.clickOutside=this.options.clickHandler??(t=>{this.popup?.contains(t.target)||this.close()}),this.popup.style.transitionDuration="0s",this.movePosition(),this.moveInterval=setInterval(()=>this.movePosition(),Bc),this.active=!0,this.options.cancelableOnOpen&&setTimeout(()=>window.addEventListener("click",this.clickOutside,!0),200)}}static cloneRect(e){return{top:e.top,bottom:e.bottom,left:e.left,right:e.right,width:e.width,height:e.height}}static movePosition(){const e=this.options.attach instanceof HTMLElement?this.options.attach.getBoundingClientRect():this.cloneRect(this.options.attach.getBounds());this.options.attach instanceof HTMLElement||(e.top+=document.getElementById("pixi").offsetTop+9);const t=e.left+e.width/2,n=this.popup.clientWidth,r=n/2+15,a=window.innerWidth-n/2-15;this.popup.style.left=`${Se(t,r,a)}px`;const s=e.top+e.height/2+15;this.popup.style.top=`${s}px`,s+this.popup.clientHeight>window.innerHeight-15?(this.popup.style.transform="translate(-50%, -100%)",this.view.style.transformOrigin="bottom",this.popup.style.top=`${e.top-15}px`):(this.popup.style.transform="",this.view.style.transformOrigin=""),requestAnimationFrame(()=>this.popup.style.transitionDuration="")}static _build(){const e=document.createElement("div");e.classList.add("popup"),this.popup=e;const t=document.createElement("div");t.classList.add("popup-zoomer"),this.options.width&&(t.style.width=`${this.options.width/16}rem`),t.style.backgroundColor=this.options.background??"",t.style.color=this.options.textColor??"",e.appendChild(t),this.view=t;const n=document.createElement("div");if(n.innerText=this.options.title,n.classList.add("popup-title"),t.appendChild(n),this.title=n,this.options.description!==void 0){const r=document.createElement("div");r.innerText=this.options.description,r.classList.add("popup-desc"),t.appendChild(r),this.desc=r}if(this.buildContent(),this.options.editable){const r=document.createElement("div");r.innerText="click to edit",r.style.marginTop="4px",r.style.height="10px",t.appendChild(r),r.classList.add("popup-desc"),this.editText=r}if(this.options.options){const r=document.createElement("div");r.classList.add("popup-options"),this.options.options.forEach(a=>{const s=document.createElement("button");s.innerText=a.label,s.onclick=()=>{a.callback?.()},s.classList.add(a.type),r.appendChild(s)}),this.view.append(r)}}static buildContent(){}static close(){if(!this.popup||!this.active)return;window.removeEventListener("click",this.clickOutside,!0),this.popup.classList.add("exiting");const e=this.popup;setTimeout(()=>e.remove(),200),this.active=!1,this.persistent=!1,clearInterval(this.moveInterval),clearInterval(this.updateInterval)}static select(){!this.popup||!this.options.editable||(this.persistent=!0,this.view.classList.add("selected"),this.editText.style.transform="scale(0)",this.editText.style.height="0px",this.options.cancelableOnOpen||setTimeout(()=>window.addEventListener("click",this.clickOutside,!0),200))}static detach(){clearInterval(this.moveInterval)}static attach(e){clearInterval(this.moveInterval),this.moveInterval=setInterval(()=>this.movePosition(),Bc),this.options.attach=e}}class Ms extends Ui{static app;static timingGrid;static onTimingChange=this.updateValues.bind(this);static open(e){this.active||(this.app=e,super._open({title:"Manage Split Timing",editable:!1,attach:document.getElementById("split-timing"),cancelableOnOpen:!0,clickHandler:t=>{!this.popup?.contains(t.target)&&!document.getElementById("split-timing")?.contains(t.target)&&this.close()}}),ee.on("timingModified",this.onTimingChange))}static buildContent(){this.popup.id="split-timing";const e=document.createElement("div");e.classList.add("split-timing-grid"),this.timingGrid=e;const t=this.buildModifyGrid();this.updateValues(),this.view.appendChild(e),this.view.appendChild(t)}static updateValues(){this.timingGrid.replaceChildren();const e=document.createElement("div");e.classList.add("split-timing-row"),e.style.backgroundColor="rgba(0, 0, 0, 0.3";const t=document.createElement("div");t.innerText="OFFSET";const n=this.app.chartManager.loadedChart.timingData.hasChartOffset(),r=n?"chart":"song",a=document.createElement("div");a.innerText=n?"C":"S",Ze(a,{content:Wi[r].desc});const s=document.createElement("button");s.innerText=Wi[r].buttonOne.text,Ze(s,{content:Wi[r].buttonOne.tooltip}),s.onclick=()=>{Wi[r].buttonOne.action(this.app.chartManager.loadedChart.timingData)};const o=document.createElement("button");o.innerText=Wi[r].buttonTwo.text,o.classList.toggle("delete",n),Ze(o,{content:Wi[r].buttonTwo.tooltip}),o.onclick=()=>{Wi[r].buttonTwo.action(this.app.chartManager.loadedChart.timingData)},e.replaceChildren(t,a,s,o),this.timingGrid.appendChild(e);for(const l of Ir)this.timingGrid.appendChild(this.buildRow(l));return e}static buildRow(e){const t=document.createElement("div");t.classList.add("split-timing-row"),t.style.backgroundColor=En(Ei[e].toString(16).padStart(6,"0"),"#333333",.75);const n=document.createElement("div");n.innerText=e;const r=this.app.chartManager.loadedChart.timingData.isPropertyChartSpecific(e),a=r?"chart":"song",s=document.createElement("div");s.innerText=r?"C":"S",Ze(s,{content:Ye[a].desc});const o=document.createElement("button");o.innerText=Ye[a].buttonOne.text,Ze(o,{content:Ye[a].buttonOne.tooltip}),o.onclick=()=>{Ye[a].buttonOne.action(this.app.chartManager.loadedChart.timingData,e)};const l=document.createElement("button");return l.innerText=Ye[a].buttonTwo.text,l.classList.toggle("delete",r),Ze(l,{content:Ye[a].buttonTwo.tooltip}),l.onclick=()=>{Ye[a].buttonTwo.action(this.app.chartManager.loadedChart.timingData,e)},t.replaceChildren(n,s,o,l),t}static buildModifyGrid(){const e=document.createElement("div");e.classList.add("split-timing-grid");const t=document.createElement("div");t.classList.add("split-timing-modify-row"),t.style.backgroundColor="rgba(0, 0, 0, 0.3";const n=document.createElement("div");n.innerText="Convert all to chart timing";const r=document.createElement("button");r.innerText=Ye.song.buttonOne.text,Ze(r,{content:Ye.song.buttonOne.tooltipAll}),r.onclick=()=>{Ye.song.buttonOne.actionAll(this.app.chartManager.loadedChart.timingData),r.blur()};const a=document.createElement("button");a.innerText=Ye.song.buttonTwo.text,a.classList.add("delete"),Ze(a,{content:Ye.song.buttonTwo.tooltipAll}),a.onclick=()=>{Ye.song.buttonTwo.actionAll(this.app.chartManager.loadedChart.timingData),a.blur()},t.replaceChildren(n,r,a);const s=document.createElement("div");s.classList.add("split-timing-modify-row"),s.style.backgroundColor="rgba(0, 0, 0, 0.3";const o=document.createElement("div");o.innerText="Convert all to song timing";const l=document.createElement("button");l.innerText=Ye.chart.buttonOne.text,Ze(l,{content:Ye.chart.buttonOne.tooltipAll}),l.onclick=()=>{Ye.chart.buttonOne.actionAll(this.app.chartManager.loadedChart.timingData),l.blur()};const u=document.createElement("button");return u.innerText=Ye.chart.buttonTwo.text,Ze(u,{content:Ye.chart.buttonTwo.tooltipAll}),u.onclick=()=>{Ye.chart.buttonTwo.actionAll(this.app.chartManager.loadedChart.timingData),u.blur()},s.replaceChildren(o,l,u),e.replaceChildren(t,s),e}static close(){!this.popup||!this.active||super.close()}}class Ls extends Ui{static draggedElement;static dragOffsetX=0;static dragOffsetY=0;static grid;static leftovers;static boundaryCache=[];static open(){this.active||super._open({title:"Reorder Timing Tracks",editable:!1,attach:document.getElementById("toggle-tracks"),cancelableOnOpen:!0,clickHandler:e=>{!this.popup?.contains(e.target)&&!this.draggedElement?.contains(e.target)&&!document.getElementById("toggle-tracks")?.contains(e.target)&&this.close()}})}static buildContent(){this.popup.id="timing-track-order";const e=document.createElement("div");e.classList.add("track-grid-options");const t=document.createElement("button");t.classList.add("delete"),t.innerText="Reset",t.onclick=()=>{b.chart.timingEventOrder.left=structuredClone(No.chart.timingEventOrder.left),b.chart.timingEventOrder.right=structuredClone(No.chart.timingEventOrder.right),this.clearBoundaries(),this.grid?.replaceChildren(),this.leftovers?.replaceChildren();const a=[...Ir];for(const o of b.chart.timingEventOrder.left){const l=this.makeDraggableTrack(o);l.classList.add("left"),this.grid?.appendChild(l),a.splice(a.indexOf(o),1)}const s=document.createElement("div");s.classList.add("draggable-track"),s.innerText="PLAYFIELD",s.style.backgroundColor="#2D2D2D",s.style.padding="1.25rem 0.625rem",s.style.writingMode="horizontal-tb",s.addEventListener("mousedown",o=>this.startDragging(o,s)),s.dataset.type="PLAYFIELD",this.grid?.appendChild(s);for(const o of b.chart.timingEventOrder.right){const l=this.makeDraggableTrack(o);l.classList.add("right"),this.grid?.appendChild(l),a.splice(a.indexOf(o),1)}for(const o of a)this.leftovers?.appendChild(this.makeLeftoverTrack(o))},this.grid=document.createElement("div"),this.grid.classList.add("track-grid"),this.view.appendChild(this.grid),this.view.appendChild(e);const n=[...Ir];for(const a of b.chart.timingEventOrder.left){const s=this.makeDraggableTrack(a);s.classList.add("left"),this.grid.appendChild(s),n.splice(n.indexOf(a),1)}const r=document.createElement("div");r.classList.add("draggable-track"),r.innerText="PLAYFIELD",r.style.backgroundColor="#2D2D2D",r.style.padding="1.25rem 0.625rem",r.style.writingMode="horizontal-tb",r.addEventListener("mousedown",a=>this.startDragging(a,r)),r.dataset.type="PLAYFIELD",this.grid.appendChild(r);for(const a of b.chart.timingEventOrder.right){const s=this.makeDraggableTrack(a);s.classList.add("right"),this.grid.appendChild(s),n.splice(n.indexOf(a),1)}this.leftovers=document.createElement("div"),this.leftovers.classList.add("track-selector"),e.appendChild(this.leftovers),e.appendChild(t);for(const a of n)this.leftovers.appendChild(this.makeLeftoverTrack(a))}static makeDraggableTrack(e){const t=document.createElement("div");t.classList.add("draggable-track");const n=document.createElement("div");n.classList.add("draggable-track-text"),n.innerText=e,t.style.backgroundColor=En(Ei[e].toString(16).padStart(6,"0"),"#333333",.7),t.appendChild(n);let r=!0;const a=be.getIcon("TRASH",16);return a.addEventListener("click",()=>{if(!r)return;r=!1,this.deleteTrack(e),t.classList.add("exiting"),setTimeout(()=>t.remove(),400);const s=this.makeLeftoverTrack(e);s.classList.add("entering"),setTimeout(()=>s.classList.remove("entering"),400),this.leftovers?.appendChild(s),this.clearBoundaries()}),t.appendChild(a),t.addEventListener("mousedown",s=>{r&&(a.contains(s.target)||this.startDragging(s,t))}),t.dataset.type=e,t}static makeLeftoverTrack(e){const t=document.createElement("div");t.classList.add("leftover-track");const n=be.getIcon("PLUS",8);t.append(n);const r=document.createElement("div");r.classList.add("leftover-track-text"),r.innerText=e,t.style.backgroundColor=En(Ei[e].toString(16).padStart(6,"0"),"#333333",.7),t.appendChild(r);let a=0,s=0,o=!1,l=!1;return t.addEventListener("mousedown",()=>{o=!0}),t.addEventListener("mousemove",u=>{if(!(!o||l)&&(a+=u.movementX,s+=u.movementY,a*a+s*s>15)){l=!0;const f=this.makeDraggableTrack(e);this.grid?.appendChild(f),this.clearBoundaries();const c=t.getBoundingClientRect(),d=this.getClosestSlot(c.left),h=b.chart.timingEventOrder.left.concat(["PLAYFIELD"],b.chart.timingEventOrder.right);h.splice(d,0,e),this.saveOptions(h),h.forEach(p=>{const m=this.grid?.querySelector(`div[data-type=${p}]`);this.grid?.appendChild(m),p!="PLAYFIELD"&&(m?.classList.remove("left","right"),b.chart.timingEventOrder.left.includes(p)&&m?.classList.add("left"),b.chart.timingEventOrder.right.includes(p)&&m?.classList.add("right"))}),this.startDragging(u,f,u.clientX,u.clientY),b.general.smoothAnimations?(t.style.width=t.clientWidth+"px",t.style.transition="0.4s cubic-bezier(0, 0.91, 0.34, 1.05)",setTimeout(()=>{t.style.width="0px",t.style.opacity="0",t.style.padding="0",t.style.fontSize="0"},10),setTimeout(()=>t.remove(),400)):t.remove()}}),t.addEventListener("mouseup",()=>{if(!o||l)return;l=!0,b.chart.timingEventOrder.right.push(e),b.general.smoothAnimations?(t.style.width=t.clientWidth+"px",t.style.transition="0.4s cubic-bezier(0, 0.91, 0.34, 1.05)",setTimeout(()=>{t.style.width="0px",t.style.opacity="0",t.style.padding="0",t.style.fontSize="0"},10),setTimeout(()=>t.remove(),400)):t.remove();const u=this.makeDraggableTrack(e);u.classList.add("entering"),u.classList.add("right"),setTimeout(()=>u.classList.remove("entering"),400),this.grid?.appendChild(u),this.clearBoundaries()}),t}static startDragging(e,t,n,r){if(!this.popup)return;this.draggedElement=t.cloneNode(!0),this.draggedElement.style.position="fixed";const a=t.getBoundingClientRect(),s=this.popup.getBoundingClientRect();!n||!r?(this.dragOffsetX=e.clientX-a.left,this.dragOffsetY=e.clientY-a.top,this.draggedElement.style.left=a.left-s.left+"px",this.draggedElement.style.top=a.top-s.top+"px"):(this.dragOffsetX=a.width/2,this.dragOffsetY=a.height/4*3,this.draggedElement.style.left=n-a.width/2-s.left+"px",this.draggedElement.style.top=r-a.height/4*3-s.top+"px",this.draggedElement.classList.add("entering")),this.draggedElement.style.boxShadow="6px 6px 6px #222",this.draggedElement.style.transition="none",t.style.opacity="0.03",this.popup.appendChild(this.draggedElement);const o=b.chart.timingEventOrder.left.concat(["PLAYFIELD"],b.chart.timingEventOrder.right),l=t.dataset.type;let u=o.indexOf(l);const f=o.indexOf(l),c=h=>{this.draggedElement.style.left=h.clientX-this.dragOffsetX-s.left+"px",this.draggedElement.style.top=h.clientY-this.dragOffsetY-s.top+"px";let p=this.getClosestSlot(h.clientX-this.dragOffsetX);Math.abs(h.clientY-this.dragOffsetY-s.top-(a.top-s.top))>140&&(p=f),u!=p&&(o.splice(u,1),o.splice(p,0,l),this.saveOptions(o),o.forEach(m=>{const g=this.grid?.querySelector(`div[data-type=${m}]`);this.grid?.appendChild(g),m!="PLAYFIELD"&&(g?.classList.remove("left","right"),b.chart.timingEventOrder.left.includes(m)&&g?.classList.add("left"),b.chart.timingEventOrder.right.includes(m)&&g?.classList.add("right"))}),l!="PLAYFIELD"&&(this.draggedElement?.classList.remove("left","right"),b.chart.timingEventOrder.left.includes(l)&&this.draggedElement?.classList.add("left"),b.chart.timingEventOrder.right.includes(l)&&this.draggedElement?.classList.add("right")),u=p)};window.addEventListener("mousemove",c);const d=()=>{this.draggedElement?.remove(),this.draggedElement=void 0,window.removeEventListener("mousemove",c),t.style.opacity="",this.clearBoundaries(),window.removeEventListener("mouseup",d)};window.addEventListener("mouseup",d)}static saveOptions(e){const t=e.indexOf("PLAYFIELD");t!=-1&&(b.chart.timingEventOrder.left=e.slice(0,t),b.chart.timingEventOrder.right=e.slice(t+1))}static deleteTrack(e){const t=b.chart.timingEventOrder.left.indexOf(e);t!=-1&&b.chart.timingEventOrder.left.splice(t,1);const n=b.chart.timingEventOrder.right.indexOf(e);n!=-1&&b.chart.timingEventOrder.right.splice(n,1),b.chart.timingEventOrder.left=[...b.chart.timingEventOrder.left],b.chart.timingEventOrder.right=[...b.chart.timingEventOrder.right]}static getClosestSlot(e){this.boundaryCache.length==0&&this.getBoundaries();let t=-1,n=999999,r=999999;for(let a=0;a<this.boundaryCache.length;a++){const s=Math.abs(e-this.boundaryCache[a][1].left);if(s<n&&(n=s,t=a),s>r)break;r=s}return t}static getBoundaries(){if(this.grid){for(const e of this.grid.children)this.boundaryCache.push([e,e.getBoundingClientRect()]);this.boundaryCache.sort((e,t)=>e[1].left-t[1].left)}}static clearBoundaries(){this.boundaryCache=[]}static close(){!this.popup||!this.active||(super.close(),this.clearBoundaries())}}class Vm extends an{view;playbackBar;skipStart;skipEnd;play;playIcon;stopIcon;record;playtest;timeCounter;beatCounter;min;sec;millis;beat;beatDropdown;editBar;editSteps;editTiming;stepsContainer;timingContainer;editChoiceContainer;addTimingEvent;splitTiming;toggleTimingTracks;detectSync;offsetCounter;offset;noteArrows=[];noteArrowMask;lastTime=null;lastBeat=null;lastOffset=null;lastMode=U.Edit;lastTimingMode=Te.Off;lastHover=0;lastPlaying=!1;hovering=!1;trackingMovement=!0;idleFrames=0;lastBounds;constructor(e){super(e);const t=document.createElement("div");t.id="status-widget",document.getElementById("view-wrapper")?.appendChild(t),pe.viewMode&&t.classList.add("collapsed"),this.playbackBar=document.createElement("div"),this.playbackBar.classList.add("playback-bar"),this.editBar=document.createElement("div"),this.editBar.classList.add("edit-bar"),this.skipStart=document.createElement("button"),this.skipStart.tabIndex=-1;const n=be.getIcon("SKIP_START",36);this.skipStart.appendChild(n),this.skipStart.onclick=()=>{this.manager.chartManager.beat=Math.max(0,this.manager.chartManager.loadedChart.getBeatFromSeconds(0)),this.skipStart.blur()},Ae.createKeybindTooltip(this.skipStart)`Skip to start ${"jumpSongStart"}`,this.skipEnd=document.createElement("button"),this.skipEnd.tabIndex=-1;const r=be.getIcon("SKIP_END",36);this.skipEnd.appendChild(r),this.skipEnd.onclick=()=>{this.manager.chartManager.beat=this.manager.chartManager.loadedChart.getBeatFromSeconds(this.manager.chartManager.chartAudio.getSongLength()),this.skipEnd.blur()},Ae.createKeybindTooltip(this.skipEnd)`Skip to end ${"jumpSongEnd"}`,this.play=document.createElement("button"),this.play.tabIndex=-1;const a=be.getIcon("PLAY",40);this.play.appendChild(a),this.playIcon=a;const s=be.getIcon("STOP",32);this.play.appendChild(s),this.stopIcon=s,this.stopIcon.style.display="none",this.play.onclick=()=>{(this.manager.chartManager.getMode()==U.Record||this.manager.chartManager.getMode()==U.Play)&&this.manager.chartManager.setMode(U.Edit),this.manager.chartManager.playPause(),this.play.blur()},Ae.createKeybindTooltip(this.play)`Play/Pause ${"playback"}`,this.record=document.createElement("button"),this.record.tabIndex=-1;const o=be.getIcon("RECORD",36,void 0,"red");this.record.appendChild(o),this.record.onclick=()=>{this.manager.chartManager.setMode(U.Record),this.record.blur()},Ae.createKeybindTooltip(this.record)`Record ${"recordMode"}`,(pe.viewMode||!pe.recordMode)&&(this.record.style.display="none"),this.playtest=document.createElement("button"),this.playtest.tabIndex=-1;const l=be.getIcon("PLAYTEST",30);this.playtest.appendChild(l),this.playtest.onclick=()=>{this.manager.chartManager.setMode(U.Play),this.playtest.blur()},Ae.createKeybindTooltip(this.playtest)`Playtest ${"playMode"}`,pe.playMode||(this.playtest.style.display="none");const u=document.createElement("div");u.classList.add("playback-separator"),this.timeCounter=document.createElement("div"),this.timeCounter.classList.add("playback-counter");const f=document.createElement("div");f.style.display="flex",f.classList.add("playback-counter-main");const c=document.createElement("div");c.classList.add("inlineEdit"),c.innerText="00",c.spellcheck=!1,c.contentEditable="true",c.style.maxWidth=`${27/16}rem`,c.onkeydown=S=>{S.key=="Enter"&&c.blur(),S.key=="Escape"&&(c.innerText=Math.floor(Math.abs(this.manager.chartManager.time)/60).toString().padStart(2,"0"),c.blur())},c.onfocus=()=>setTimeout(()=>this.selectText(c),25),c.onblur=()=>this.updateTime(),c.ondragstart=S=>S.preventDefault();const d=document.createElement("div");d.classList.add("inlineEdit"),d.innerText="00",d.spellcheck=!1,d.contentEditable="true",d.style.maxWidth=`${18/16}rem`,d.onkeydown=S=>{S.key=="Enter"&&d.blur(),S.key=="Escape"&&(d.innerText=Math.floor(Math.abs(this.manager.chartManager.time)%60).toString().padStart(2,"0"),d.blur())},d.onfocus=()=>setTimeout(()=>this.selectText(d),25),d.onblur=()=>this.updateTime(),d.ondragstart=S=>S.preventDefault();const h=document.createElement("div");h.classList.add("inlineEdit"),h.innerText="000",h.spellcheck=!1,h.contentEditable="true",h.style.maxWidth=`${27/16}rem`,h.onkeydown=S=>{S.key=="Enter"&&h.blur(),S.key=="Escape"&&(h.innerText=(fe(Math.abs(this.manager.chartManager.time)%1,3)*1e3).toString().padStart(3,"0"),h.blur())},h.onfocus=()=>setTimeout(()=>this.selectText(h),25),h.onblur=()=>this.updateTime(),h.ondragstart=S=>S.preventDefault(),this.min=c,this.sec=d,this.millis=h;const p=document.createElement("div");p.classList.add("playback-counter-label"),p.innerText="Time",f.appendChild(c),f.appendChild(document.createTextNode(":")),f.appendChild(d),f.appendChild(document.createTextNode(".")),f.appendChild(h),this.timeCounter.appendChild(f),this.timeCounter.appendChild(p);const m=document.createElement("div");m.classList.add("playback-separator"),this.beatCounter=document.createElement("div"),this.beatCounter.classList.add("playback-counter");const g=document.createElement("div");g.style.display="flex",g.classList.add("playback-counter-main");const y=document.createElement("div");y.classList.add("inlineEdit"),y.innerText="0.000",y.spellcheck=!1,y.contentEditable="true",y.onkeydown=S=>{if(S.key=="Enter"&&y.blur(),S.key=="Escape"){if(this.beatDropdown.value=="Measure"){const Y=this.manager.chartManager.loadedChart?.timingData?.getMeasure(this.manager.chartManager.beat)??this.manager.chartManager.beat/4;y.innerText=fe(Y,3).toFixed(3)}else y.innerText=fe(this.manager.chartManager.beat,3).toFixed(3);y.blur()}},y.onfocus=()=>{setTimeout(()=>this.selectText(y),25)},y.onblur=()=>this.updateBeat(),y.ondragstart=S=>S.preventDefault(),this.beat=y,this.beatDropdown=gi.create(["Beat","Measure"],"Beat"),this.beatDropdown.view.querySelector(".dropdown-selected").classList.add("playback-counter-label"),this.beatCounter.appendChild(g),g.appendChild(y),this.beatCounter.appendChild(this.beatDropdown.view),this.beatDropdown.onChange(()=>{if(this.beatDropdown.value=="Measure"){const S=this.manager.chartManager.loadedChart?.timingData?.getMeasure(this.manager.chartManager.beat)??this.manager.chartManager.beat/4;y.innerText=fe(S,3).toFixed(3)}else y.innerText=fe(this.manager.chartManager.beat,3).toFixed(3)}),this.playbackBar.appendChild(this.skipStart),this.playbackBar.appendChild(this.skipEnd),this.playbackBar.appendChild(this.play),this.playbackBar.appendChild(this.record),this.playbackBar.appendChild(this.playtest),this.playbackBar.appendChild(u),this.playbackBar.appendChild(this.timeCounter),this.playbackBar.appendChild(m),this.playbackBar.appendChild(this.beatCounter),this.editSteps=document.createElement("button"),this.editSteps.tabIndex=-1,this.editSteps.classList.add("edit-fancy-button");const x=be.getIcon("FEET",24);x.style.marginBottom=`${2/16}rem`,this.editSteps.appendChild(x),this.editSteps.appendChild(document.createTextNode("Edit Steps")),this.editSteps.onclick=()=>{this.manager.chartManager.editTimingMode=Te.Off,this.editSteps.blur()},this.editSteps.classList.add("active"),this.editTiming=document.createElement("button"),this.editTiming.tabIndex=-1,this.editTiming.classList.add("edit-fancy-button");const w=be.getIcon("METRONOME",24);w.style.marginBottom=`${2/16}rem`,this.editTiming.appendChild(w),this.editTiming.appendChild(document.createTextNode("Edit Timing")),this.editTiming.onclick=()=>{this.manager.chartManager.editTimingMode=Te.Edit,this.editTiming.blur()};const _=document.createElement("div");_.classList.add("playback-separator");const C=document.createElement("div");C.classList.add("edit-bar-left"),C.appendChild(this.editSteps),C.appendChild(this.editTiming),C.appendChild(_),this.editBar.appendChild(C),this.editChoiceContainer=document.createElement("div"),this.editChoiceContainer.classList.add("edit-choice-container"),this.stepsContainer=document.createElement("div"),this.stepsContainer.classList.add("edit-steps-container"),this.timingContainer=document.createElement("div"),this.timingContainer.classList.add("edit-timing-container"),this.editChoiceContainer.appendChild(this.stepsContainer),this.editChoiceContainer.appendChild(this.timingContainer),this.addTimingEvent=document.createElement("button"),this.addTimingEvent.tabIndex=-1;const F=be.getIcon("ADD_EVENT",32);this.addTimingEvent.appendChild(F),this.addTimingEvent.onclick=()=>{this.manager.chartManager.editTimingMode==Te.Add?this.manager.chartManager.editTimingMode=Te.Edit:this.manager.chartManager.editTimingMode=Te.Add,this.addTimingEvent.blur()},this.timingContainer.appendChild(this.addTimingEvent),Ae.createKeybindTooltip(this.addTimingEvent)`Add timing events ${"toggleAddTiming"}`;const T=document.createElement("div");T.classList.add("playback-separator"),this.timingContainer.appendChild(T),this.splitTiming=document.createElement("button"),this.splitTiming.tabIndex=-1;const R=be.getIcon("SPLIT_TIMING",32);this.splitTiming.appendChild(R),this.splitTiming.onclick=()=>{Ms.active?Ms.close():Ms.open(this.manager.app),this.splitTiming.blur()},this.splitTiming.id="split-timing",this.timingContainer.appendChild(this.splitTiming),Ze(this.splitTiming,{content:"Manage split timing"}),this.toggleTimingTracks=document.createElement("button"),this.toggleTimingTracks.tabIndex=-1;const N=be.getIcon("EYE",32);this.toggleTimingTracks.appendChild(N),this.toggleTimingTracks.onclick=()=>{Ls.active?Ls.close():Ls.open(),this.toggleTimingTracks.blur()},this.toggleTimingTracks.id="toggle-tracks",this.timingContainer.appendChild(this.toggleTimingTracks),Ze(this.toggleTimingTracks,{content:"Toggle timing track visibility"}),this.detectSync=document.createElement("button"),this.detectSync.tabIndex=-1;const j=be.getIcon("DETECT_SYNC",32);this.detectSync.appendChild(j),this.detectSync.onclick=()=>{this.manager.app.windowManager.openWindow(new Qu(this.manager.app)),this.detectSync.blur()},this.detectSync.id="detect-sync",this.timingContainer.appendChild(this.detectSync),Ae.createKeybindTooltip(this.detectSync)`Detect audio sync ${"detectSync"}`;const ae=document.createElement("div");ae.classList.add("playback-separator"),this.timingContainer.appendChild(ae),this.offsetCounter=document.createElement("div"),this.offsetCounter.classList.add("playback-counter");const L=document.createElement("div");L.classList.add("playback-counter-label"),L.innerText="Offset";const O=document.createElement("div");O.classList.add("playback-counter-main","inlineEdit"),O.innerText="0.000",O.spellcheck=!1,O.contentEditable="true",O.onkeydown=S=>{S.key=="Enter"&&O.blur(),S.key=="Escape"&&(O.innerText=fe(this.manager.chartManager.loadedChart?.timingData.getOffset()??0,3).toFixed(3),O.blur())},O.tabIndex=-1,O.onfocus=()=>{setTimeout(()=>this.selectText(O),25)},O.onblur=()=>this.updateOffset(),O.ondragstart=S=>S.preventDefault(),this.offset=O,this.offsetCounter.appendChild(O),this.offsetCounter.appendChild(L),this.timingContainer.appendChild(this.offsetCounter),this.editBar.appendChild(this.editChoiceContainer);const v=document.createElement("div");v.classList.add("note-placeholder-right"),this.stepsContainer.appendChild(v),ee.on("resize",()=>{this.trackingMovement=!0,this.idleFrames=5}),ee.on("noteskinLoaded",()=>{this.stepsContainer.replaceChildren(),this.noteArrows.forEach(Y=>{this.removeChild(Y.sprite),this.removeChild(Y.bg),this.removeChild(Y.highlight)}),this.noteArrows=[];const S=document.createElement("div");if(S.classList.add("note-placeholder-right"),this.stepsContainer.appendChild(S),!!this.manager.chartManager.loadedChart){for(const Y of this.manager.chartManager.loadedChart.gameType.editNoteTypes){if(bd.includes(Y))continue;const D=this.manager.chartManager.chartView.getNotefield().createNote({type:Y,beat:0,col:0,quant:4,second:0,warped:!1,fake:!1});D.scale.set(.5);const G=new ye(xe.WHITE);Ue(G,"widget-bg"),G.width=48,G.height=48,G.anchor.set(.5);const V=new dt("noBorder");V.alpha=0,V.width=48,V.height=48,V.pivot.x=24,V.pivot.y=24;const J=document.createElement("button");J.tabIndex=-1,J.style.height="3rem",J.style.width="3rem",J.classList.add("note-placeholder"),J.onclick=()=>{this.manager.chartManager.setEditingNoteType(Y),J.blur()},Ae.createKeybindTooltip(J)`${"\\"+Y} ${"noteType"+Y}`;const H={element:J,sprite:D,type:Y,bg:G,highlight:V,hovered:!1};J.onmouseover=()=>{H.hovered=!0},J.onmouseleave=()=>{H.hovered=!1},this.addChild(G),this.addChild(D),this.addChild(V);const P=J.getBoundingClientRect();D.position.y=P.top-this.manager.app.view.clientHeight/2-this.manager.app.view.getBoundingClientRect().top+24,D.position.x=P.left-this.manager.app.view.clientWidth/2+24,G.position=D.position,this.noteArrows.push(H)}this.stepsContainer.replaceChildren(...this.noteArrows.map(Y=>Y.element),S),this.trackingMovement=!0,this.idleFrames=5}}),this.noteArrowMask=new ye(xe.WHITE),this.noteArrowMask.height=48,this.noteArrowMask.width=2500,this.noteArrowMask.anchor.y=1,this.noteArrowMask.anchor.x=.5,this.addChild(this.noteArrowMask),this.mask=this.noteArrowMask,t.onmouseenter=()=>{this.lastHover=Date.now(),this.hovering=!0,this.view.style.opacity="",this.view.style.transition=""},t.onmouseleave=()=>this.hovering=!1,t.appendChild(this.playbackBar),t.appendChild(this.editBar),this.view=t,t.style.display="none"}update(){this.view.style.display=this.manager.chartManager.loadedSM&&pe.status&&!this.manager.app.capturing?"":"none",this.scale.set(1/this.manager.chartManager.app.stage.scale.x);const e=this.manager.chartManager.time;this.lastTime!=e&&(document.activeElement!=this.min&&(this.min.innerText=(e<0?"-":"")+Math.floor(Math.abs(e)/60).toString().padStart(2,"0")),document.activeElement!=this.sec&&(this.sec.innerText=Math.floor(Math.abs(e)%60).toString().padStart(2,"0")),document.activeElement!=this.millis&&(this.millis.innerText=(fe(Math.abs(e)%1,3)*1e3).toString().padStart(3,"0")),this.lastTime=e);const t=this.manager.chartManager.beat;if(this.lastBeat!=t){if(document.activeElement!=this.beat)if(this.beatDropdown.value=="Measure"){const c=this.manager.chartManager.loadedChart?.timingData?.getMeasure(t)??t/4;this.beat.innerText=fe(c,3).toFixed(3)}else this.beat.innerText=fe(t,3).toFixed(3);this.lastBeat=t}const n=this.manager.chartManager.loadedChart?.timingData.getOffset()??0;this.lastOffset!=n&&document.activeElement!=this.offset&&(this.offset.innerText=fe(n,3).toFixed(3));const r=this.manager.chartManager.getMode(),a=this.manager.chartManager.editTimingMode;if(this.lastMode!=r){switch(r){case U.Edit:this.skipStart.disabled=!1,this.skipEnd.disabled=!1,this.record.disabled=!1,this.playtest.disabled=!1,this.min.contentEditable="true",this.sec.contentEditable="true",this.millis.contentEditable="true",this.beat.contentEditable="true",this.offset.contentEditable="true",this.record.style.background="",this.playtest.style.background="",this.view.style.opacity="",this.view.style.transition="",this.view.classList.remove("collapsed"),this.beatDropdown.disabled=!1;break;case U.Record:this.lastHover=Date.now(),this.skipStart.disabled=!0,this.skipEnd.disabled=!0,this.record.disabled=!1,this.record.style.background="rgba(170, 0, 0, 0.35)",this.playtest.disabled=!0,this.min.contentEditable="false",this.sec.contentEditable="false",this.millis.contentEditable="false",this.beat.contentEditable="false",this.offset.contentEditable="false",a!=Te.Off&&(this.visible=!1),this.view.classList.add("collapsed"),this.beatDropdown.closeDropdown(),this.beatDropdown.disabled=!0;break;case U.Play:this.lastHover=Date.now(),this.skipStart.disabled=!0,this.skipEnd.disabled=!0,this.record.disabled=!0,this.playtest.disabled=!1,this.playtest.style.background="rgba(12, 97, 31, 0.35)",this.min.contentEditable="false",this.sec.contentEditable="false",this.millis.contentEditable="false",this.beat.contentEditable="false",this.offset.contentEditable="false",a!=Te.Off&&(this.visible=!1),this.view.classList.add("collapsed"),this.beatDropdown.closeDropdown(),this.beatDropdown.disabled=!0;break;case U.View:this.lastHover=Date.now(),this.skipStart.disabled=!1,this.skipEnd.disabled=!1,this.record.disabled=!0,this.playtest.disabled=!1,this.min.contentEditable="true",this.sec.contentEditable="true",this.millis.contentEditable="true",this.beat.contentEditable="true",this.offset.contentEditable="true",a!=Te.Off&&(this.visible=!1),this.view.classList.add("collapsed"),this.beatDropdown.closeDropdown(),this.beatDropdown.disabled=!0}this.trackingMovement=!0,this.idleFrames=5,this.lastMode=r}if(this.lastTimingMode!=a){switch(a){case Te.Off:this.visible=!0,this.stepsContainer.style.transform="",this.timingContainer.style.transform="",this.editSteps.classList.add("active"),this.editTiming.classList.remove("active"),this.offset.tabIndex=-1;break;case Te.Add:this.addTimingEvent.classList.add("active");break;case Te.Edit:this.addTimingEvent.classList.remove("active"),this.offset.tabIndex=0}(this.lastTimingMode==Te.Off&&a!=Te.Off||this.lastTimingMode!=Te.Off&&a==Te.Off)&&this.manager.chartManager.clearSelections(),this.trackingMovement=!0,this.idleFrames=5,this.lastTimingMode=a,this.stepsContainer.style.transform=a==Te.Off?"":"translateY(-3rem)",this.timingContainer.style.transform=a==Te.Off?"":"translateY(-3rem)",this.editSteps.classList.toggle("active",a==Te.Off),this.editTiming.classList.toggle("active",a!=Te.Off)}const s=this.manager.chartManager.chartAudio.isPlaying();if(this.lastPlaying!=s&&(this.playIcon.style.display=s?"none":"",this.stopIcon.style.display=s?"":"none",this.lastPlaying=s),(r==U.Play||r==U.Record)&&this.view.style.opacity==""&&!this.hovering&&Date.now()-this.lastHover>3e3&&(this.view.style.opacity="0.2",this.view.style.transition="2s cubic-bezier(.11,.72,.51,1.14)"),this.trackingMovement){let c=48;const d=this.noteArrows[0];if(d){const p=d.element.getBoundingClientRect();c=p.width,this.noteArrows.forEach((m,g)=>{m.sprite.position.y=p.top-this.manager.app.view.clientHeight/2-this.manager.app.view.getBoundingClientRect().top+c/2,m.sprite.position.x=p.left-this.manager.app.view.clientWidth/2+c/2+g*c,m.sprite.scale.set(c/96),m.bg.width=c,m.bg.height=c,m.bg.position=m.sprite.position,m.highlight.width=c,m.highlight.height=c,m.highlight.position=m.sprite.position,m.highlight.pivot.set(c/2)}),this.lastBounds&&Math.abs(this.lastBounds.top-p.top)+Math.abs(this.lastBounds.left-p.left)==0&&(this.idleFrames--,this.idleFrames<0&&(this.trackingMovement=!1,this.lastBounds=void 0,a!=Te.Off&&(this.visible=!1))),this.lastBounds=p}const h=this.view.getBoundingClientRect();this.noteArrowMask.y=h.bottom-this.manager.app.view.clientHeight/2-this.manager.app.view.getBoundingClientRect().top,this.noteArrowMask.height=c}const o=this.manager.chartManager.getEditingNoteType(),l=Fe.getColor("editable-overlay-hover"),u=Fe.getColor("editable-overlay-active"),f=new B(l).setAlpha(0);this.noteArrows.forEach(c=>{let d=o==c.type?u:c.hovered?l:f;b.general.smoothAnimations&&(d=new B(Rt(new B(c.highlight.tint).setAlpha(c.highlight.alpha),d,.3))),c.highlight.tint=d.toNumber(),c.highlight.alpha=d.alpha})}selectText(e){const t=window.getSelection(),n=document.createRange();!t||!n||(n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n))}updateTime(){this.millis.innerText=this.millis.innerText.padEnd(3,"0").slice(0,3);const e=this.parseString(this.min),t=this.parseString(this.sec),n=this.parseString(this.millis);if(e===null||t===null||n===null){this.lastTime=null;return}let r=e*60+t+n/1e3;r>9999999&&(r=9999999),r<0&&(r=0),this.manager.chartManager.time=r,this.lastTime=null}updateBeat(){let e=this.parseString(this.beat);if(e===null){this.lastBeat=null;return}this.beatDropdown.value=="Measure"&&(e=this.manager.chartManager.loadedChart?.timingData?.getBeatFromMeasure(e)??e*4),e>9999999&&(e=9999999),e<0&&(e=0),this.manager.chartManager.beat=e,this.lastBeat=null}updateOffset(){let e=this.parseString(this.offset);if(e===null){this.lastOffset=null;return}e>9999999&&(e=9999999),e<-9999999&&(e=-9999999),this.lastOffset=null,!(!this.manager.chartManager.loadedChart||!this.manager.chartManager.loadedSM)&&(this.manager.chartManager.loadedChart.timingData.hasChartOffset()?this.manager.chartManager.loadedChart.timingData:this.manager.chartManager.loadedSM.timingData).setOffset(e)}parseString(e){try{const t=Wc.evaluate(e.innerText);return isFinite(t)?t:0}catch{return null}}}class Um extends Vi{npsGraph;graphGradient=null;graphWidth=40;npsText=new ge("",{fontName:"Main",fontSize:12});constructor(e){super(e,{backingWidth:60,order:9}),this.graphWidth=40,this.graphGradient=this.makeGradient(),this.npsGraph=new Hi,this.container.addChild(this.npsGraph),this.name="density",this.npsText.visible=!1,this.npsText.anchor.x=1,this.npsText.anchor.y=.5,Ue(this.npsText,"text-color"),this.addChild(this.npsText),ee.on("userOptionUpdated",n=>{(n=="chart.npsGraph.color1"||n=="chart.npsGraph.color2")&&(this.graphGradient=this.makeGradient(),this.populate())}),this.on("mouseleave",()=>{this.hideNpsDisplay()}),this.on("mouseenter",()=>{this.showNpsDisplay()}),this.on("mousemove",n=>{this.updateNpsDisplay(n)}),this.populate()}updateNpsDisplay(e){const t=this.getChart();if(!t){this.npsText.visible=!1;return}if(!t.getNotedata().at(-1)){this.npsText.visible=!1;return}const r=t.stats.npsGraph,a=this.manager.app.STAGE_HEIGHT-this.verticalMargin;let s=this.npsGraph.toLocal(e.global).y/a;s=Se(s,0,1);const o=this.getSongPositionFromT(s),l=Math.floor(t.timingData.getMeasure(o.beat)),u=r[l]??0;this.npsText.text=u.toFixed(1)+" nps",this.npsText.position.y=this.npsGraph.toLocal(e.global).y-a/2,this.npsText.position.x=-this.backing.width/2-10,this.npsText.visible=!0}hideNpsDisplay(){this.npsText.visible=!1}showNpsDisplay(){const e=this.getChart();if(!e){this.npsText.visible=!1;return}if(!e.getNotedata().at(-1)){this.npsText.visible=!1;return}this.npsText.visible=!0}update(){if(!b.chart.npsGraph.enabled){this.visible=!1;return}this.visible=!0,this.npsText.scale.y=b.chart.reverse?-1:1,super.update()}populate(e,t){super.populate(e,t);const n=this.getChart();if(!n)return;const r=n.stats.getMaxNPS(),a=n.stats.npsGraph,s=n.getLastBeat();if(this.npsGraph.clear(),n.getNotedata().length==0)return;this.graphGradient?this.npsGraph.beginTextureFill({texture:this.graphGradient}):this.npsGraph.beginFill(0,1),this.npsGraph.pivot.x=this.backing.width/2,this.npsGraph.pivot.y=(this.manager.app.STAGE_HEIGHT-this.verticalMargin)/2;const o=Math.floor(this.getChart().timingData.getMeasure(s)),l=this.getYFromBeat(this.getSongPositionFromT(0).beat),u=this.getYFromBeat(this.getSongPositionFromT(1).beat);this.npsGraph.moveTo(0,l);for(let h=0;h<=o;h++){const p=a[h]??0,m=n.timingData.getBeatFromMeasure(h),g=Math.min(s,n.timingData.getBeatFromMeasure(h+1));if(e!==void 0&&g<e)continue;if(t!==void 0&&m>t)break;const y=Kt(0,r,p)*this.graphWidth,x=Se(this.getYFromBeat(m),l,u),w=Se(this.getYFromBeat(g),l,u);this.npsGraph.lineTo(y,x),this.npsGraph.lineTo(y,w)}const f=a.at(-1)??0,c=Kt(0,r,f)*this.graphWidth,d=Se(this.getYFromBeat(s),l,u);this.npsGraph.lineTo(c,d),this.npsGraph.lineTo(0,d),this.npsGraph.endFill()}makeGradient(){const e=this.graphWidth,t=document.createElement("canvas");t.width=e,t.height=e;const n=t.getContext("2d");if(n==null)return null;const r=n.createLinearGradient(0,0,e,0);return r.addColorStop(0,er(b.chart.npsGraph.color1).toHexa()),r.addColorStop(.8,er(b.chart.npsGraph.color2).toHexa()),n.fillStyle=r,n.fillRect(0,0,e,e),xe.from(t)}}class Wm extends Vi{barContainer=new Yr(1500,{position:!0,scale:!0,tint:!0},16384,!0);bars;barTexture;middleLine;colorCache=new Map;constructor(e){super(e,{backingWidth:48,order:1,trigger:"parity"}),this.visible=!1,this.name="facing",this.backing.tint=0,this.backing.alpha=.3,this.middleLine=new ye(xe.WHITE),this.middleLine.anchor.set(.5),this.middleLine.width=1,this.middleLine.alpha=.2,this.middleLine.height=this.manager.app.STAGE_HEIGHT,this.addChild(this.middleLine),this.barTexture=ti.create({resolution:this.manager.app.renderer.resolution}),this.bars=new ye(this.barTexture),this.bars.anchor.set(.5),this.container.addChild(this.bars),this.container.addChild(this.barContainer),this.populate(),ee.on("userOptionUpdated",t=>{t=="chart.parity.showCandles"&&this.populate(),["chart.parity.leftHeelColor","chart.parity.leftToeColor","chart.parity.rightHeelColor","chart.parity.rightToeColor"].includes(t)&&(this.colorCache.clear(),this.queued||this.populateRange(),this.queued=!0)})}update(){if(!b.chart.facingLayout.enabled||!b.chart.parity.enabled){this.visible=!1;return}this.visible=!0,this.middleLine.height=this.backing.height,b.chart.layoutFollowPosition?(this.bars.visible=!1,this.barContainer.visible=!0):(this.bars.visible=!0,this.barContainer.visible=!1),super.update()}populate(e,t){super.populate(e,t);const n=this.getChart();if(!n||!n.stats.parity||n.stats.parity.rowTimestamps.length==0){Zt(this.barContainer.children,()=>!0),this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture});return}let r=0;const a=this.manager.app.STAGE_HEIGHT-this.verticalMargin;b.chart.layoutFollowPosition?(this.barContainer.y=-a/2,this.barContainer.x=-16):(this.barContainer.position.set(0),this.barTexture.resize(32,a)),this.updateDimensions();const s=Fn(n.stats.parity.rowTimestamps,e??0,o=>o.beat);for(let o=s;o<n.stats.parity.facingRows.length;o++){if(e!==void 0&&n.stats.parity.rowTimestamps[o].beat<e)continue;if(t!==void 0&&n.stats.parity.rowTimestamps[o].beat>t)break;if(n.stats.parity.candles.has(o)&&b.chart.parity.showCandles){let c=this.barContainer.children[r];c||(c=new ye(xe.WHITE),this.barContainer.addChild(c)),c.anchor.set(.5),c.height=3,c.width=32,c.alpha=.4,c.tint=At(n.stats.parity.candles.get(o)),c.x=16,c.y=this.getYFromBeat(n.stats.parity.rowTimestamps[o].beat),r++}let l=this.barContainer.children[r];l||(l=new ye(xe.WHITE),l.width=6,this.barContainer.addChild(l));let u=n.stats.parity.facingRows[o];if(u=Se(u,-2,2),this.colorCache.has(u))l.tint=this.colorCache.get(u);else{let c;n.stats.parity.facingRows[o]<0?c=En("#ffffff",new B(At(ce.LEFT_HEEL)).toHex(),u/-2):c=En("#ffffff",new B(At(ce.RIGHT_HEEL)).toHex(),u/2),this.colorCache.set(u,c)}l.anchor.set(.5),l.height=1,l.width=6,l.alpha=1,Math.abs(u)>1.6&&(l.height=2,l.width=8);const f=Math.sign(u)*Math.pow(Math.abs(u),1.5)/2;l.x=16+f*8,l.y=this.getYFromBeat(n.stats.parity.rowTimestamps[o].beat),r++}Zt(this.barContainer.children,(o,l)=>l>=r),b.chart.layoutFollowPosition||(this.barContainer.visible=!0,this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture}),this.barContainer.visible=!1)}}class Er extends Ui{static onSnapChange=this.updateValues.bind(this);static divInput;static divLabel;static beatInput;static open(e){this.active||(super._open({attach:e,title:"Snap Options",width:200,editable:!0,cancelableOnOpen:!1}),ee.on("snapChanged",this.onSnapChange))}static buildContent(){const e=document.createElement("div");e.classList.add("popup-flex"),this.view.appendChild(e);const t=document.createElement("div");t.classList.add("popup-row");const n=document.createElement("div");n.innerText="Snap to nearest ";const r=pt.create({value:b.chart.snap==0?0:Math.round(4/b.chart.snap),step:1,precision:0,min:0,max:1e3});r.onchange=f=>{if(f===void 0){this.updateValues();return}f==0?b.chart.snap=0:b.chart.snap=4/f,this.updateValues()};const a=document.createElement("div");a.innerText=this.suffixSnap()+" note",t.replaceChildren(n,r.view,a);const s=document.createElement("div");s.classList.add("popup-row");const o=document.createElement("div");o.innerText="Snap every";const l=pt.create({value:b.chart.snap,step:.001,precision:3,min:0});l.onchange=f=>{if(f===void 0){this.updateValues();return}f==0?b.chart.snap=0:b.chart.snap=f,this.updateValues()};const u=document.createElement("div");u.innerText=" beats",s.replaceChildren(o,l.view,u),e.replaceChildren(t,s),this.beatInput=l,this.divInput=r,this.divLabel=a}static updateValues(){document.activeElement==this.divInput.input||document.activeElement==this.beatInput.input||(this.divInput.value=b.chart.snap==0?0:Math.round(4/b.chart.snap),this.divLabel.innerText=this.suffixSnap()+" note",this.beatInput.value=b.chart.snap)}static suffixSnap(){const e=b.chart.snap==0?0:Math.round(4/b.chart.snap);return e%10==1&&e!=11?"st":e%10==2&&e!=12?"nd":e%10==3&&e!=13?"rd":"th"}static close(){!this.popup||!this.active||(super.close(),ee.off("timingModified",this.onSnapChange))}}const Gm={fontName:"Main",fontSize:10,fill:["#ffffff"]},nd={4:15157287,8:4033015,12:11152884,16:8577607,24:14167723,32:15376696,48:15699179,64:7071886,96:8553090,192:8553090};class qm extends he{isEditGUI=!0;renderer;children=[];constructor(e){super(),this.renderer=e;for(let t=0;t<2;t++){const n=new he,r=new Hi,a=new ge("4",Gm);n.x=(t-.5)*(this.renderer.chart.gameType.notefieldWidth+48),r.rotation=Math.PI/4,r.lineStyle(1,0,1),r.beginFill(16777215),r.drawRect(-12,-12,24,24),r.endFill(),a.anchor.set(.5),n.addChild(r,a),this.addChild(n),n.eventMode="static",n.cursor="pointer",n.on("mouseenter",()=>Er.open(r)),n.on("mousedown",()=>Er.select()),n.on("mouseleave",()=>{Er.persistent||Er.close()})}}update(){this.y=this.renderer.getActualReceptorYPos();for(let e=0;e<2;e++){const t=this.children[e],n=t.children[0];n.tint=nd[4/b.chart.snap]??7368816;const r=t.children[1];r.text=""+(b.chart.snap==0||4/b.chart.snap%1!=0?"":4/b.chart.snap)}}}class jm extends Vi{barContainer=new Yr(1500,{position:!0,scale:!0,tint:!0},16384,!0);bars;barTexture;constructor(e){super(e),this.visible=!1,this.name="note-layout",this.backing.tint=0,this.backing.alpha=.3,this.barTexture=ti.create({resolution:this.manager.app.renderer.resolution}),this.bars=new ye(this.barTexture),this.bars.anchor.set(.5),this.container.addChild(this.bars),this.container.addChild(this.barContainer),this.populate()}update(){if(!b.chart.noteLayout.enabled){this.visible=!1;return}this.visible=!0,b.chart.layoutFollowPosition?(this.bars.visible=!1,this.barContainer.visible=!0):(this.bars.visible=!0,this.barContainer.visible=!1),super.update()}populate(e,t){super.populate(e,t);const n=this.getChart();if(!n){Zt(this.barContainer.children,()=>!0),this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture});return}let r=0;const a=n.gameType.numCols,s=n.getNotedata().at(-1),o=this.manager.app.STAGE_HEIGHT-this.verticalMargin;if(this.barTexture.resize(a*6,o),this.backingWidth=a*6+8,b.chart.layoutFollowPosition?(this.barContainer.y=-o/2,this.barContainer.x=-a*3):(this.barContainer.position.set(0),this.barTexture.resize(a*6,o)),this.updateDimensions(),!s){Zt(this.barContainer.children,()=>!0),this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture});return}for(const l of n.getNotedataInRange(e??0,t??n.getLastBeat())){if(!this.shouldDisplayNote(l))continue;let u=this.barContainer.children[r];if(u||(u=new ye(xe.WHITE),u.width=4,this.barContainer.addChild(u)),u.anchor.set(.5),u.height=1,u.x=(l.col+.5)*6,u.y=this.getYFromBeat(l.beat),u.tint=nd[l.quant],l.type=="Mine"&&(u.tint=8421504),r++,Oe(l)){let f=this.barContainer.children[r];f||(f=new ye(xe.WHITE),f.width=4,f.height=2,this.barContainer.addChild(f)),f.anchor.x=.5,f.anchor.y=0,f.x=(l.col+.5)*6;const c=this.getYFromBeat(l.beat+l.hold)+1;f.y=u.y,f.height=c-u.y,l.type=="Hold"&&(f.tint=10526880),l.type=="Roll"&&(f.tint=11379586),r++}}Zt(this.barContainer.children,(l,u)=>u>=r),b.chart.layoutFollowPosition||(this.barContainer.visible=!0,this.manager.app.renderer.render(this.barContainer,{renderTexture:this.barTexture}),this.barContainer.visible=!1)}shouldDisplayNote(e){return!(b.chart.CMod&&e.fake&&b.chart.hideFakedArrows||b.chart.CMod&&b.chart.hideWarpedArrows&&e.warped)}}class $m extends he{app;chartManager;children=[];constructor(e){super(),this.app=e.app,this.chartManager=e,this.addChild(new jm(this)),this.addChild(new Nm(this)),this.addChild(new Vm(this)),this.addChild(new tn(this)),this.addChild(new Um(this)),this.addChild(new Hm(this)),this.addChild(new Wm(this)),this.addChild(new Fm(this)),this.addChild(new Om(this)),this.zIndex=2}update(){this.children.forEach(e=>e.update())}startPlay(){this.children.forEach(e=>e.startPlay())}endPlay(){this.children.forEach(e=>e.endPlay())}}const Ks=Array(85).fill(void 0).map((i,e)=>33+e),rd=[];for(const i of Ks)for(const e of Ks)rd.push([i,e]);const Xs="<~".split("").map(i=>i.charCodeAt(0)),Zs="~>".split("").map(i=>i.charCodeAt(0));function Ym(i,e,t,n=!1,r=!1,a=!1){let s;typeof i=="string"?s=i.split("").map(c=>c.charCodeAt(0)):s=[...new Uint8Array(i)];const o=4-s.length%4;for(let c=0;c<o;c++)s.push(0);const l=new Uint8Array(s),u=new DataView(l.buffer);let f=[];for(let c=0;c<s.length;c+=4){const d=u.getUint32(c);r&&!d?f.push(122):a&&d==538976288?f.push(121):(f=f.concat(t[Math.floor(d/614125)],t[Math.floor(d/85)%7225]),f.push(e[d%85]))}if(o&&!n){if(f.at(-1)==122){f.pop();for(let c=0;c<5;c++)f.push(e[0])}for(let c=0;c<o;c++)f.pop()}return f}function Bo(i,e=!1,t=!1,n=!1){let r=Ym(i,Ks,rd,t,!0,e);return n&&(r=Xs.concat(r).concat(Zs)),r}function Fo(i,e=!1,t=` 	
\r\v`){let n;if(typeof i=="string"?n=i.split("").map(o=>o.charCodeAt(0)):n=[...new Uint8Array(i)],e){if(n.at(-1)!=Zs.at(-1)||n.at(-2)!=Zs.at(-2))return!1;n.at(0)==Xs.at(0)&&n.at(1)==Xs.at(1)?n=n.slice(2,-2):n=n.slice(void 0,-2)}for(let o=0;o<4;o++)n.push(117);let r=[],a=[];for(const o of n)if(o>=33&&117>=o){if(a.push(o),a.length==5){let l=0;for(const u of a)l=85*l+(u-33);if(l>2**32-1)return!1;r.push(l>>24&255),r.push(l>>16&255),r.push(l>>8&255),r.push(l&255),a=[]}}else if(o==122){if(a.length!=0)return!1;r.push(0),r.push(0),r.push(0),r.push(0)}else if(o==121){if(a.length!=0)return!1;r.push(32),r.push(32),r.push(32),r.push(32)}else if(!t.includes(String.fromCharCode(o)))return!1;const s=4-a.length;return s&&(r=r.slice(void 0,-s)),r}function $t(i){let e=0,t=0,n=129;for(;(n&128)!=0;){const r=i.shift();if(!r)break;e=e|(r&127)<<7*t++,n=r}return e}function Yt(i){const e=[];let t=!1;for(;!t;){let n=i&127;i=i>>7,t=i==0,t||(n=n|128),e.push(n)}return e}const Km=["Hold","Mine","Roll","Lift","Fake"];function Xm(i){if(i.startsWith("ArrowVortex:notes:")){const e=Fo(i.slice(18));if(e!==!1){const t=Array.from(e);if(t.shift()!=0)return;const n=$t(t),r=[];for(let a=0;a<n;a++){const s=t.shift();if(s==null)return;const o=s&127;if((s&128)!=0){const l=$t(t),u=$t(t),f=t.shift();if(f==null||f>4)continue;const c=Km[f];if(l==u){if(c=="Hold"||c=="Roll")continue;r.push({type:c,beat:l/48,col:o})}else{if(c=="Mine"||c=="Fake"||c=="Lift")continue;r.push({type:c,beat:l/48,hold:(u-l)/48,col:o})}}else r.push({type:"Tap",beat:$t(t)/48,col:o})}return r}}}function Zm(i){const e=[0];e.push(...Yt(i.length));for(const t of i)if(t.type=="Tap"){const n=Math.round(t.beat*48);e.push(t.col),e.push(...Yt(n))}else{e.push(t.col+128);const n=Math.round(t.beat*48);let r=0;Oe(t)&&(r=t.hold);const a=Math.round(r*48)+n;e.push(...Yt(n)),e.push(...Yt(a)),e.push(["Hold","Mine","Roll","Lift","Fake"].indexOf(t.type))}return"ArrowVortex:notes:"+Bo(e).map(t=>String.fromCharCode(t)).join("")}const la=["BPMS","STOPS","DELAYS","WARPS","TIMESIGNATURES","TICKCOUNTS","COMBOS","SPEEDS","SCROLLS","FAKES","LABELS","ATTACKS","BGCHANGES","FGCHANGES"];function _i(i){const e=new ArrayBuffer(4);return new DataView(e).setUint32(0,i,!0),Array.from(new Uint8Array(e))}function Ai(i){const e=new Uint8Array(i.splice(0,4));return new DataView(e.buffer).getUint32(0,!0)}function Pi(i){const e=new ArrayBuffer(8);return new DataView(e).setFloat64(0,i,!0),Array.from(new Uint8Array(e))}function Ri(i){const e=new Uint8Array(i.splice(0,8)),t=new DataView(e.buffer);return fe(t.getFloat64(0,!0),3)}function Qm(i){return[i.length,...i.split("").map(e=>e.charCodeAt(0))]}function Jm(i){const e=i.shift();if(!e)return"";let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(i.shift());return t}function ki(i){return Yt(i.length).concat(i.split("").map(e=>e.charCodeAt(0)))}function Ti(i){const e=$t(i);if(!e)return"";let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(i.shift());return t}function eg(i){return i.some(e=>{if(e.type=="ATTACKS"||e.type=="BGCHANGES"||e.type=="FGCHANGES")return!0;const t=Math.round(e.beat*48)/48;if(Math.abs(t-e.beat)>5e-4)return!0;if(e.type=="FAKES"||e.type=="WARPS"){const n=Math.round(e.value*48)/48;if(Math.abs(n-e.value)>5e-4)return!0}return e.type=="LABELS"&&e.value.length>255||e.type=="TIMESIGNATURES"&&(e.upper>2**32-1||e.lower>2**32-1)||e.type=="COMBOS"&&(e.hitMult>2**32-1||e.missMult>2**32-1)?!0:e.type=="TICKCOUNTS"&&e.value>2**32-1})?ig(i):tg(i)}function tg(i){const e=[],t=new Map;i.forEach(n=>{t.has(n.type)||t.set(n.type,[]),t.get(n.type)?.push(n)});for(const[n,r]of t.entries())if(!(n=="ATTACKS"||n=="BGCHANGES"||n=="FGCHANGES")){e.push(r.length),e.push(la.indexOf(n));for(const a of r)switch(e.push(..._i(Math.round(a.beat*48))),a.type){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":e.push(...Pi(a.value));break;case"FAKES":case"WARPS":e.push(..._i(Math.round(a.value*48)));break;case"TIMESIGNATURES":e.push(..._i(Math.round(a.upper))),e.push(..._i(Math.round(a.lower)));break;case"COMBOS":e.push(..._i(Math.round(a.hitMult))),e.push(..._i(Math.round(a.missMult)));break;case"TICKCOUNTS":e.push(..._i(Math.round(a.value)));break;case"SPEEDS":e.push(...Pi(a.value)),e.push(...Pi(a.delay)),e.push(..._i(a.unit=="B"?0:1));break;case"LABELS":e.push(...Qm(a.value))}}return e.push(0),"ArrowVortex:tempo:"+Bo(e).map(n=>String.fromCharCode(n)).join("")}function ig(i){const e=[],t=new Map;i.forEach(n=>{t.has(n.type)||t.set(n.type,[]),t.get(n.type)?.push(n)});for(const[n,r]of t.entries()){e.push(...Yt(r.length)),e.push(la.indexOf(n));for(const a of r)switch(e.push(...Yt(Math.round((a.type=="ATTACKS"?a.second:a.beat)*1e3))),a.type){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":case"FAKES":case"WARPS":e.push(...Pi(a.value));break;case"TIMESIGNATURES":e.push(...Yt(Math.round(a.upper))),e.push(...Yt(Math.round(a.lower)));break;case"COMBOS":e.push(...Yt(Math.round(a.hitMult))),e.push(...Yt(Math.round(a.missMult)));break;case"TICKCOUNTS":e.push(...Yt(Math.round(a.value)));break;case"SPEEDS":e.push(...Pi(a.value)),e.push(...Pi(a.delay)),e.push(a.unit=="B"?0:1);break;case"LABELS":e.push(...ki(a.value));break;case"ATTACKS":e.push(...Pi(a.value)),e.push(a.endType=="LEN"?0:1),e.push(...ki(a.mods));break;case"BGCHANGES":case"FGCHANGES":e.push((a.crossFade?1:0)+((a.stretchRewind?1:0)<<1)+((a.stretchNoLoop?1:0)<<2)),e.push(...ki(a.file)),e.push(...Pi(a.updateRate)),e.push(...ki(a.effect)),e.push(...ki(a.file2)),e.push(...ki(a.transition)),e.push(...ki(a.color1)),e.push(...ki(a.color2))}}return"SMEditor:tempo:"+Bo(e).map(n=>String.fromCharCode(n)).join("")}function ng(i){if(i.startsWith("SMEditor:tempo:"))return ag(i);if(i.startsWith("ArrowVortex:tempo:"))return rg(i)}function rg(i){if(!i.startsWith("ArrowVortex:tempo:"))return;const e=Fo(i.slice(18)),t=[];if(e===!1)return;const n=Array.from(e);try{for(;;){const r=n.shift();if(r===void 0)return;if(r==0)break;const a=n.shift();if(a===void 0)return;const s=la[a];for(let o=0;o<r;o++){const l=Ai(n)/48;switch(s){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":t.push({type:s,beat:l,value:Ri(n)});break;case"FAKES":case"WARPS":t.push({type:s,beat:l,value:Ai(n)/48});break;case"TIMESIGNATURES":t.push({type:s,beat:l,upper:Ai(n),lower:Ai(n)});break;case"COMBOS":t.push({type:s,beat:l,hitMult:Ai(n),missMult:Ai(n)});break;case"TICKCOUNTS":t.push({type:s,beat:l,value:Ai(n)});break;case"SPEEDS":t.push({type:s,beat:l,value:Ri(n),delay:Ri(n),unit:Ai(n)==1?"T":"B"});break;case"LABELS":t.push({type:s,beat:l,value:Jm(n)})}}}}catch{return}return t}function ag(i){if(!i.startsWith("SMEditor:tempo:"))return;const e=Fo(i.slice(15)),t=[];if(e===!1)return;const n=Array.from(e);try{for(;;){const r=$t(n);if(r===void 0)return;if(r==0)break;const a=n.shift();if(a===void 0)return;const s=la[a];for(let o=0;o<r;o++){const l=$t(n)/1e3;switch(s){case"BPMS":case"STOPS":case"DELAYS":case"SCROLLS":case"FAKES":case"WARPS":t.push({type:s,beat:l,value:Ri(n)});break;case"TIMESIGNATURES":t.push({type:s,beat:l,upper:$t(n),lower:$t(n)});break;case"COMBOS":t.push({type:s,beat:l,hitMult:$t(n),missMult:$t(n)});break;case"TICKCOUNTS":t.push({type:s,beat:l,value:$t(n)});break;case"SPEEDS":t.push({type:s,beat:l,value:Ri(n),delay:Ri(n),unit:n.shift()==0?"B":"T"});break;case"LABELS":t.push({type:s,beat:l,value:Ti(n)});break;case"ATTACKS":t.push({type:s,second:l,value:Ri(n),endType:n.shift()==0?"LEN":"END",mods:Ti(n)});break;case"BGCHANGES":case"FGCHANGES":{const u=n.shift();t.push({type:s,beat:l,file:Ti(n),updateRate:Ri(n),crossFade:(u&1)>0,stretchRewind:(u&2)>0,stretchNoLoop:(u&4)>0,effect:Ti(n),file2:Ti(n),transition:Ti(n),color1:Ti(n),color2:Ti(n)})}}}}}catch{return}return t}let sg=class ad extends AudioBufferSourceNode{started=!1;start(e,t,n){this.started||super.start(e,t,n),this.started=!0}stop(e){this.started&&super.stop(e),this.started=!1}static create(e){const t=e;return t.started=!1,Object.setPrototypeOf(t,ad.prototype),t}};class Ds{_gainNode;_audioContext=new AudioContext;_sources=[];_rate=1;_buffer;_volume=1;_destroyed=!1;loaded;constructor(e){this._gainNode=this._audioContext.createGain(),this._gainNode.connect(this._audioContext.destination),e.volume!==void 0&&this.volume(e.volume),e.rate!==void 0&&this.rate(e.rate),this._buffer=this._audioContext.createBuffer(2,1,44100),this.loaded=new Promise(t=>{fetch(e.src).then(n=>n.arrayBuffer()).then(n=>this.decodeData(n)).then(n=>{n&&(this._buffer=n)}).catch(n=>{ue.createFormatted("Failed to load sound effect: "+n.message,"error")}).finally(()=>{t()})})}destroy(){this._destroyed||(this.stop(),this._buffer=this._audioContext.createBuffer(2,1,44100),this._destroyed=!0)}async decodeData(e){return new Promise((t,n)=>{if(!e){t();return}(async()=>{try{t(await this._audioContext.decodeAudioData(e))}catch(r){n(r)}})()})}volume(e){this._destroyed||this._volume!=e&&(this._volume=e,this._gainNode.gain.setValueAtTime(e,this._audioContext.currentTime))}rate(e){if(!this._destroyed&&this._rate!=e){this._rate=e;for(const t of this._sources)t.playbackRate.value=e}}play(e){if(this._destroyed)return;const t=sg.create(this._audioContext.createBufferSource());t.buffer=this._buffer,t.connect(this._gainNode),this._gainNode.connect(this._audioContext.destination),t.start(e+this._audioContext.currentTime,0),t.playbackRate.value=this._rate,this._sources.push(t),t.onended=()=>{t.disconnect(),this._sources=this._sources.filter(n=>n!=t)}}stop(){if(!this._destroyed){for(const e of this._sources)e.stop(),e.disconnect();this._sources=[]}}getBuffer(){return this._buffer}}class Qs{static menuElement;static closeTimeout;static open(e,t){e.chartManager.getMode()!=U.View&&(this.buildMenu(e),this.menuElement.style.display="none",setTimeout(()=>this.fitContextMenu(t)),this.menuElement.classList.add("entering"),clearTimeout(this.closeTimeout),setTimeout(()=>this.menuElement?.classList.remove("entering"),300),this.menuElement.style.left=t.clientX+"px",this.menuElement.style.top=t.clientY+"px")}static fitContextMenu(e){this.menuElement.style.display="";const t=this.menuElement.getBoundingClientRect(),n=window.innerHeight-t.bottom-20,r=window.innerWidth-t.right-20;n<0&&(this.menuElement.style.top=e.clientY+n+"px"),r<0&&(this.menuElement.style.left=e.clientX+r+"px"),this.menuElement.style.transformOrigin=`${Math.max(0,-r)}px ${Math.max(0,-n)}px`}static close(){this.menuElement&&(this.menuElement.classList.add("exiting"),this.closeTimeout=setTimeout(()=>this.menuElement.replaceChildren(),300))}static buildMenu(e){const t=document.createElement("div");if(t.appendChild(this.createElement(e,{type:"selection",id:"cut"})),t.appendChild(this.createElement(e,{type:"selection",id:"copy"})),t.appendChild(this.createElement(e,{type:"selection",id:"paste"})),t.appendChild(this.createElement(e,{type:"selection",id:"pasteReplace"})),e.chartManager.getMode()==U.Edit&&e.chartManager.hasNoteSelection()){const n=document.createElement("div");n.classList.add("separator"),t.appendChild(n),Qi.selection.options.slice(0,-4).forEach(r=>{t.appendChild(this.createElement(e,r))})}this.menuElement=t,t.id="context-menu",document.getElementById("context-menu")?.replaceWith(this.menuElement)}static createElement(e,t){if(t.type=="separator"){const n=document.createElement("div");return n.classList.add("separator"),n}if(t.type=="selection"||t.type=="checkbox"||t.type=="dropdown"){const n=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");let s;if(t.type=="selection"||t.type=="checkbox"){const o=Ne[t.id];s=document.createElement("div"),s.innerText=Ae.getKeybindString(t.id),s.classList.add("keybind","unselectable"),a.innerText=o?.label??t.id;let l=o?.disabled??!0;typeof l=="function"&&(l=l(e)),l&&n.classList.add("disabled"),n.addEventListener("click",()=>{l||(o?.callback(e),this.close())})}else s=be.getIcon("CHEVRON",16),s.style.transform="rotate(-90deg)",a.innerText=typeof t.title=="function"?t.title(e):t.title;if(r.appendChild(a),r.appendChild(s),n.appendChild(r),n.classList.add("menu-item"),r.classList.add("menu-item-title","menu-hover"),a.classList.add("title","unselectable"),r.onmouseenter=()=>{n.parentElement.querySelectorAll(".menu-item").forEach(o=>{o!=n&&o.classList.remove("selected")})},t.type=="dropdown"){const o=document.createElement("div");n.appendChild(o),o.classList.add("menubar-dropdown"),t.options.map(l=>this.createElement(e,l)).forEach(l=>o.appendChild(l)),r.onmouseenter=()=>{n.parentElement.querySelectorAll(".menu-item").forEach(l=>{l!=n&&l.classList.remove("selected")}),n.classList.add("selected")}}if(t.type=="checkbox"){let o=t.checked;typeof o=="function"&&(o=o(e)),o&&(a.innerText="✓ "+a.innerText)}return n}if(t.type=="menu")throw Error("no menu allowed in context menu");return document.createElement("div")}}const og={fontName:"Main",fontSize:20,fill:["#ffffff"]};class lg extends he{isEditGUI=!0;renderer;barlineMap=new Map;barlineLabelMap=new Map;barlinePool=new Ht({create:()=>{const e=new ye(xe.WHITE);return Ue(e,"text-color"),e}});barlineLabelPool=new Ht({create:()=>{const e=new ge("",og);return Ue(e,"text-color"),e}});constructor(e){super(),this.renderer=e;const t=()=>{this.barlineMap.clear(),this.barlineLabelMap.clear(),this.barlinePool.destroyAll(),this.barlineLabelPool.destroyAll()};ee.on("timeSigChanged",t),this.on("destroyed",()=>ee.off("timeSigChanged",t)),this.addChild(this.barlinePool,this.barlineLabelPool)}update(e,t){for(const[n,r]of this.renderer.chart.timingData.getMeasureBeats(e,t)){if(!this.barlineMap.has(n)){const a=this.barlinePool.createChild();if(!a)continue;Object.assign(a,{width:this.renderer.chart.gameType.notefieldWidth+128,height:r?4:1,visible:!0}),a.anchor.set(.5),this.barlineMap.set(n,a)}if(r&&!this.barlineLabelMap.has(n)){const a=this.barlineLabelPool.createChild();if(!a)continue;Object.assign(a,{x:(this.renderer.chart.gameType.notefieldWidth+128)/-2-16,text:`${Math.round(this.renderer.chart.timingData.getMeasure(n))}`,visible:!0}),a.anchor.set(1,.5),this.barlineLabelMap.set(n,a)}}for(const[n,r]of this.barlineMap.entries()){if(n<e||n>t){this.barlineMap.delete(n),this.barlinePool.destroyChild(r);continue}r.y=this.renderer.getYPosFromBeat(n)}for(const[n,r]of this.barlineLabelMap.entries()){if(n<e||n>t){this.barlineLabelMap.delete(n),this.barlineLabelPool.destroyChild(r);continue}r.y=this.renderer.getYPosFromBeat(n)}}}class Gi extends Ui{static box;static open(e,t){this.active||(this.box=e,super._open({attach:e,title:"Candle",description:`The ${t==ce.LEFT_HEEL?"left":"right"} foot is used to vertically cross the center panel.`,width:150,editable:!1,cancelableOnOpen:!1,background:Rt(new B(At(t)),new B("black"),.8).toHex(),textColor:"#ffffff",options:[]}))}static close(){this.active&&(super.close(),this.box=void 0)}}class Xt{static instance;renderer;rows=new Map;objectMap=new Map;constructor(e){this.renderer=e,Xt.instance=this}register(e,t,n,r,a,s=!1){const o=Math.round(t*48)+":"+n.toFixed(3);this.rows.has(o)||this.rows.set(o,{left:{items:[]},right:{items:[]}});const l=this.rows.get(o);r==="left"?(l.left.items.push({object:e,priority:a,x:s?0:null,beat:t,second:n,registerTime:s?void 0:Date.now()}),l.left.items.sort((u,f)=>u.priority-f.priority)):(l.right.items.push({object:e,priority:a,x:s?0:null,beat:t,second:n,registerTime:s?void 0:Date.now()}),l.right.items.sort((u,f)=>u.priority-f.priority)),this.objectMap.set(e,{key:o,align:r}),e.on("destroyed",()=>{this.deregister(e)}),e.on("removed",()=>{this.deregister(e)}),this.updateX(o)}deregister(e){const t=this.objectMap.get(e);if(!t?.key)return;lt.stop(t.animationId),this.objectMap.delete(e);const n=this.rows.get(t.key);n&&(n.left.items=n.left.items.filter(r=>r.object!=e),n.right.items=n.right.items.filter(r=>r.object!=e),this.updateX(t.key))}updatePriority(e,t){const n=this.objectMap.get(e);if(!n?.key)return;const r=this.rows.get(n.key);if(r){for(const a of[r.left,r.right]){for(const s of a.items)if(s.object==e){if(s.priority==t)return;s.priority=t}a.items.sort((s,o)=>s.priority-o.priority)}this.updateX(n.key)}}updateAlign(e,t){const n=this.objectMap.get(e);if(!n?.key||n.align==t)return;const r=this.rows.get(n.key);if(r)for(const a of[r.left,r.right]){const s=a.items.findIndex(l=>l.object==e);if(s==-1)continue;const o=a.items.splice(s,1)[0];t=="left"?(r.left.items.push(o),r.left.items.sort((l,u)=>l.priority-u.priority)):(r.right.items.push(o),r.right.items.sort((l,u)=>l.priority-u.priority)),this.updateX(n.key)}}updateX(e){const t=this.rows.get(e);if(!t)return;let n=-this.renderer.chart.gameType.notefieldWidth*.5-80-30;for(const r of t.left.items)r.object.x!=n&&r.x!=null&&(r.registerTime===void 0||Date.now()-r.registerTime>100)?this.objectMap.get(r.object).animationId=lt.animate(r.object,{0:{x:"inherit","pivot.x":"inherit"},1:{x:n,"pivot.x":r.object.width/2}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},this.objectMap.get(r.object)?.animationId):(r.object.x=n,r.object.pivot.x=r.object.width/2),r.x=n,n-=r.object.width+5;n=this.renderer.chart.gameType.notefieldWidth*.5+80;for(const r of t.right.items)r.object.x!=n&&r.x!=null&&(r.registerTime===void 0||Date.now()-r.registerTime>100)?this.objectMap.get(r.object).animationId=lt.animate(r.object,{0:{x:"inherit","pivot.x":"inherit"},1:{x:n,"pivot.x":-r.object.width/2}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},this.objectMap.get(r.object)?.animationId):(r.object.x=n,r.object.pivot.x=-r.object.width/2),r.x=n,n+=r.object.width+5}update(){for(const[e,t]of this.rows.entries()){let n=!1;for(const r of t.left.items)r.width!=r.object.width&&(r.width=r.object.width,n||this.updateX(e),n=!0),r.object.y=b.chart.CMod?this.renderer.getYPosFromSecond(r.second):this.renderer.getYPosFromBeat(r.beat);for(const r of t.right.items)r.width!=r.object.width&&(r.width=r.object.width,n||this.updateX(e),n=!0),r.object.y=b.chart.CMod?this.renderer.getYPosFromSecond(r.second):this.renderer.getYPosFromBeat(r.beat)}}}class cg extends he{isEditGUI=!0;renderer;parityDirty=!1;boxPool=new Ht({create:()=>this.createBox()});highlightPool=new Ht({create:()=>{const e=new ye(xe.WHITE);return e.height=16,e.alpha=.6,e.anchor.set(.5,.5),e}});rowMap=new Map;constructor(e){super(),this.renderer=e,this.addChild(this.highlightPool),this.addChild(this.boxPool);const t=()=>{Gi.close(),this.parityDirty=!0},n=r=>{["chart.parity.leftHeelColor","chart.parity.leftToeColor","chart.parity.rightHeelColor","chart.parity.rightToeColor"].includes(r)&&(this.parityDirty=!0)};ee.on("userOptionUpdated",n),ee.on("parityModified",t),this.on("destroyed",()=>{ee.off("userOptionUpdated",n),ee.off("parityModified",t)})}update(e,t){const n=this.renderer.chart.stats.parity;if(!n||!b.chart.parity.enabled||!b.chart.parity.showCandles){this.visible=!1;return}this.visible=!0,this.parityDirty&&(this.rowMap.clear(),this.boxPool.destroyAll(),this.highlightPool.destroyAll(),this.parityDirty=!1);for(const r of n.candles.keys()){const a=n.rowTimestamps[r];if(!(t<a.beat)&&!(e>a.beat)&&!this.rowMap.has(r)){const s=n.candles.get(r),o=this.boxPool.createChild(),l=this.highlightPool.createChild();if(!o||!l)break;Xt.instance.register(o,a.beat,a.second,"left",30),o.textObj.text=(s==ce.LEFT_HEEL,"C");const u=Rt(new B(At(s)),new B("black"),.5);o.bg.tint=u,o.on("mouseenter",()=>{this.renderer.isDragSelecting()||(Gi.active&&Gi.close(),this.renderer.chartManager.getMode()==U.Edit&&Gi.open(o,s))}),o.on("mouseleave",()=>{Gi.close()}),o.eventMode="static",l.width=this.renderer.chart.gameType.notefieldWidth+80,l.tint=u,this.rowMap.set(r,{box:o,highlight:l})}}for(const[r,a]of this.rowMap.entries()){const s=n.rowTimestamps[r];if(!s)continue;if(s.beat<e||s.beat>t){this.rowMap.delete(r),this.boxPool.destroyChild(a.box),this.highlightPool.destroyChild(a.highlight),Gi.box==a.box&&Gi.close();continue}const o=this.renderer.getYPosFromBeat(s.beat);a.highlight.y=o}}createBox(){const e=new he;e.textObj=new ge("",{fontName:"Fancy",fontSize:15});const t=new dt("noBorder");return e.bg=t,e.addChild(t,e.textObj),e.textObj.anchor.set(.5,.55),e.bg.width=e.textObj.width+18,e.bg.height=25,e.bg.position.x=-e.bg.width/2,e.bg.position.y=-25/2,e}}const li={fakeMines:{boxTint:5723991,boxOpacity:.5,textTint:14211288,text:"FM"},mines:{boxTint:6893616,boxOpacity:.3,textTint:14693428,text:"M"},holds:{boxTint:2050583,boxOpacity:.6,textTint:5494332,text:"H"},holdTails:{boxTint:1132131,boxOpacity:.6,textTint:11655162,text:"HT"}};ce.NONE+"",ce.LEFT_HEEL+"",ce.LEFT_TOE+"",ce.RIGHT_HEEL+"",ce.RIGHT_TOE+"";class ug extends he{isEditGUI=!1;renderer;chartDirty=!1;lastVisible=!1;debugTexts=[];debugContainer=new he;debugBG=new ye(xe.WHITE);connections=new Hi;rowMap=new Map;rowPool=new Ht({create:()=>{const e=new he,t=new he,n=new Ht({create:()=>{const o=new he,l=new dt;o.addChild(l),o.bg=l,o.letters=[];let u=0,f=0;for(let h=0;h<this.renderer.chart.getColumnCount();h++){const p=new ge("",{fontName:"Mono",fontSize:13});p&&(p.alpha=0,p.anchor.set(0,.5),p.x=u,o.addChild(p),u+=p.width,f=Math.max(f,p.height),o.letters.push(p))}l.width=u+10,l.height=f+5,l.pivot.set(l.width/2,l.height/2),o.letters.forEach(h=>{h.x-=u/2});const c=new ge("",{fontName:"Mono",fontSize:10});c.anchor.set(.5,1),c.y-=l.height/2+5,c.visible=!1,o.detail=c,o.addChild(c),o.alpha=.8;const d=new he;return o.connections=d,o.addChild(d),o}});n.sortableChildren=!0;const r=new ge("",{fontName:"Main",fontSize:35});r.tint=16745938,r.anchor.set(1,.5);const a=new ge("",{fontName:"Main",fontSize:15});a.tint=16745938,a.anchor.set(1,.5),a.align="right",a.eventMode="none",a.visible=!1,a.text="";const s=new ye(xe.WHITE);s.tint=16777215,s.anchor.set(1,.5),s.width=r.width+10,s.height=r.height+10,s.alpha=0,s.eventMode="static",t.addChild(s,r,a),e.addChild(t,n),e.hitbox=s,e.text=r,e.i=0,e.detail=a,e.sideContainer=t,e.nodePool=n,e.highlights=[],e.statusRows=[];for(let o=0;o<Object.keys(li).length-1;o++){const l=[];for(let u=0;u<this.renderer.chart.getColumnCount();u++){const f=new ye(xe.WHITE);f.width=10,f.height=10,f.anchor.set(1,.5),f.y=(o-(Object.keys(li).length-1)/2)*12+5,f.visible=!0,t.addChild(f),l.push(f)}e.statusRows.push(l)}return e}});activeNode;constructor(e){super(),this.visible=!0,this.renderer=e,this.addChild(this.connections),this.addChild(this.rowPool),this.debugBG.anchor.set(0,1),this.debugBG.alpha=.6,this.debugBG.tint=0,this.addChild(this.debugBG),this.addChild(this.debugContainer),this.rowPool.sortableChildren=!0;const t=()=>{this.debugTexts.forEach(a=>{const s=this.renderer.chart.stats.parity?.debug;s&&(a.text.text=a.update(s))}),this.chartDirty=!0},n=a=>{a=="debug.parity.limitGraph"&&(this.chartDirty=!0)},r=()=>{this.activeNode&&(this.activeNode.deactivate(),this.activeNode=void 0)};this.createDebugObject(16745938,a=>`Updated ${a.stats.lastUpdatedRowEnd-a.stats.lastUpdatedRowStart} rows in ${a.stats.rowUpdateTime.toFixed(3)}ms`),this.createDebugObject(11075438,a=>`Created ${a.stats.createdNodes} nodes and ${a.stats.createdEdges} edges in ${a.stats.nodeUpdateTime.toFixed(3)}ms`),this.createDebugObject(6539775,a=>`Calculated ${a.stats.calculatedEdges} costs (${a.stats.cachedEdges} cached) in ${a.stats.edgeUpdateTime.toFixed(3)}ms (cache size ${a.edgeCacheSize})`),this.createDebugObject(16751196,a=>`Found best path in ${a.stats.pathUpdateTime.toFixed(3)}ms (cached ${a.stats.cachedBestRows} rows)`),this.createDebugObject(15662955,a=>`Calculated row states in ${a.stats.rowStatsUpdateTime.toFixed(3)}ms`),this.createDebugObject(16777215,a=>`Total calculation time: ${(a.stats.rowUpdateTime+a.stats.nodeUpdateTime+a.stats.edgeUpdateTime+a.stats.pathUpdateTime+a.stats.rowStatsUpdateTime).toFixed(3)}ms`),this.createDebugObject(15417396,a=>`Debug data serialization time: ${(this.renderer.chart.stats.parity.debugTime-(a.stats.rowUpdateTime+a.stats.nodeUpdateTime+a.stats.edgeUpdateTime+a.stats.pathUpdateTime)).toFixed(3)}ms`),ee.on("parityModified",t),ee.on("userOptionUpdated",n),this.renderer.on("pointerdown",r),this.on("destroyed",()=>{ee.off("parityModified",t),ee.off("userOptionUpdated",n),this.renderer.off("pointerdown",r)})}update(e,t){const n=this.renderer.chart.stats.parity;if(this.visible=!!n&&(b.debug.parity.showGraph||b.debug.parity.showDebug),!this.visible){this.lastVisible!=this.visible&&(this.rowMap.clear(),this.rowPool.destroyAll(),this.lastVisible=this.visible);return}this.lastVisible=this.visible,this.chartDirty&&(this.rowMap.clear(),this.rowPool.destroyAll(),this.chartDirty=!1);const r=-this.renderer.chartManager.app.STAGE_WIDTH/2,a=-this.renderer.chart.gameType.notefieldWidth/2+b.chart.receptorXPos,s=this.renderer.chart.gameType.notefieldWidth/2+b.chart.receptorXPos,o=this.renderer.chartManager.app.STAGE_WIDTH/2-Vi.getTotalWidgetWidth(),l=a-r,u=o-s,f=l>u+100?"left":"right";for(let h=0;h<n.debug.notedataRows.length&&!(t<n.debug.notedataRows[h-1]?.beat);h++){if(e>n.debug.notedataRows[h+1]?.beat)continue;const p=n.debug.notedataRows[h],m=p.overrides.some(g=>g);if(!this.rowMap.has(p)){const g=this.rowPool.createChild();if(!g)break;let y=h>=n.debug.stats.lastUpdatedRowStart&&h<n.debug.stats.lastUpdatedRowEnd?16745938:11499473;m&&(y=Rt(new B(y),new B(16711680),.4).toNumber()),g.text.tint=y,g.i=h,g.text.text=h+"",g.hitbox.width=g.text.width+10,g.hitbox.height=g.text.height+10,g.detail.text="Second: "+p.second.toFixed(3)+`
Key: `+p.id,g.detail.tint=g.text.tint,g.detail.visible=!1,g.highlights.forEach(w=>{w.box.destroy()}),g.nodePool.children.forEach(w=>{w.deactivate()}),g.nodePool.destroyAll(),g.highlights=[],g.hitbox.removeAllListeners();const x=n.debug.nodeRows[h];if(!x||x.nodes.length===0)console.warn(`No permutations found for row ${h} at beat ${p.beat} (${p.id})`);else{let w=x.nodes;b.debug.parity.limitGraph&&(w=w.slice(0,8));for(const F of w){const T=g.nodePool.createChild();if(!T)continue;T.name=F.key;const R=T.bg,N=()=>{let O=11499473;R.alpha=.2,h>=n.debug.stats.lastUpdatedNodeStart&&h<n.debug.stats.lastUpdatedNodeEnd&&(O=2251008,R.alpha=.6),n.debug.bestPathSet?.has(F.key)&&(O=12536064,R.alpha=.6),m&&(O+=3473408,R.alpha+=.3),j&&(O=6539775,R.alpha=.2),R.tint=O};for(let O=0;O<F.state.combinedColumns.length;O++){const v=F.state.combinedColumns[O],S=T.letters[O];S&&(S.text=Uc[v],S.alpha=.3,F.state.action[O]==F.state.combinedColumns[O]&&(S.alpha=1),S.tint=v==ce.NONE?6710886:At(v))}T.detail.text=JSON.stringify(F.state,null,2)+`
Key: `+F.key;let j=!1;N();const ae=()=>{if(!j){j=!0,T.alpha=3,T.detail.visible=!0;for(const[O,v]of F.children.entries()){const S=this.rowMap.get(n.debug.notedataRows[h+1]);if(!S||!S.nodePool.getChildByName(O))return;const D=new he;D.text=new ge(v.TOTAL.toFixed(2),{fontName:"Mono",fontSize:10}),D.text.anchor.set(.5,1),D.text.tint=16777215,D.text.y=-R.height/2-5,D.bg=new dt,D.bg.visible=!1,D.bg.eventMode="none",D.bg.tint=3683671,D.name=O,D.addChild(D.bg,D.text),T.connections.addChild(D),D.on("pointerover",()=>{D.text.text=JSON.stringify(v,null,2)+`
`,D.scale.set(1.2),D.bg.visible=!0,D.bg.width=D.text.width+10,D.bg.height=D.text.height+10,D.bg.alpha=.3,D.bg.x=-D.bg.width/2,D.bg.y=-D.bg.height-R.height/2-10}),D.on("pointerout",()=>{D.text.text=v.TOTAL.toFixed(2),D.scale.set(1),D.bg.visible=!1}),D.text.hitArea=new Kn(-D.text.width/2,-D.text.height,D.text.width,D.text.height),D.zIndex=1,T.zIndex=1,g.zIndex=1}N()}},L=()=>{j&&(j=!1,T.alpha=.8,T.zIndex=0,T.detail.visible=!1,T.connections.children.forEach(O=>{O.destroy()}),T.connections.removeChildren(),N(),g.zIndex=0)};T.activate=ae,T.deactivate=L,T.eventMode="static",T.on("pointerover",()=>{ae()}),T.on("pointerout",()=>{this.activeNode!=T&&L()}),T.on("pointerdown",O=>{this.activeNode==T?this.activeNode=void 0:(this.activeNode?.deactivate(),this.activeNode=T,T.connections.children.forEach(v=>{v.eventMode="static"})),O.stopImmediatePropagation()}),T.cursor="pointer"}const _=g.nodePool.children[0].bg.width+5,C=_*w.length;g.nodePool.children.forEach((F,T)=>{F.x=T*_-C/2,F.y=0})}for(let w=0;w<this.renderer.chart.getColumnCount();w++)g.statusRows[0][w].tint=li.fakeMines.textTint,g.statusRows[1][w].tint=li.mines.textTint,g.statusRows[0][w].visible=p.fakeMines[w]!==void 0,g.statusRows[1][w].visible=p.mines[w]!==void 0,g.statusRows[2][w].visible=!0,p.holdTails.has(w)?g.statusRows[2][w].tint=li.holdTails.textTint:p.holds[w]!==void 0?g.statusRows[2][w].tint=li.holds.textTint:g.statusRows[2][w].visible=!1;g.hitbox.on("pointerover",()=>{g.detail.visible=!0,p.fakeMines.forEach((w,_)=>{if(w===void 0)return;const C=this.createBoxWithText(li.fakeMines);g.highlights.push({col:_,second:w,box:C}),g.addChild(C)}),p.mines.forEach((w,_)=>{if(w===void 0)return;const C=this.createBoxWithText(li.mines);g.highlights.push({col:_,second:w,box:C}),g.addChild(C)}),p.holds.forEach((w,_)=>{if(w===void 0||p.holdTails.has(_))return;const C=this.createBoxWithText(li.holds);g.highlights.push({col:_,second:p.second,box:C}),g.addChild(C)}),p.holdTails.forEach(w=>{const _=this.createBoxWithText(li.holdTails);g.highlights.push({col:w,second:p.second,box:_}),g.addChild(_)}),g.statusRows.forEach(w=>{w.forEach(_=>{_.alpha=0})})}),g.hitbox.on("pointerout",()=>{g.detail.visible=!1,g.highlights.forEach(w=>{w.box.destroy()}),g.highlights=[],g.statusRows.forEach(w=>{w.forEach(_=>{_.alpha=1})})}),this.rowMap.set(p,g)}}let c=0;const d=[...this.rowMap.entries()];for(const[h,p]of d){if(h.beat<e&&d[c+1]?.[0].beat<e||h.beat>t&&d[c-1]?.[0].beat>t){this.rowMap.delete(h),this.rowPool.destroyChild(p),this.activeNode&&this.activeNode.parent===p.nodePool&&(this.activeNode.deactivate(),this.activeNode=void 0),c++;continue}c++,p.text.text=p.i+" "+(n.techErrors.has(p.i)?n.techErrors.get(p.i).values().toArray().map(m=>Gc[m]).join(", "):""),p.visible=b.debug.parity.showGraph,p.highlights.forEach(m=>{const g=this.renderer.getXPosFromColumn(m.col),y=this.renderer.getYPosFromSecond(m.second),x=m.box;x.x=g,x.y=y-this.renderer.getYPosFromBeat(h.beat)}),p.y=this.renderer.getYPosFromBeat(h.beat),f=="left"?p.nodePool.x=(a-r)/2+r-b.chart.receptorXPos:p.nodePool.x=(o-s)/2+s-b.chart.receptorXPos;for(let m=0;m<this.renderer.chart.getColumnCount();m++)for(let g=0;g<3;g++)f=="right"?p.statusRows[g][m].x=(m-this.renderer.chart.getColumnCount())*12-p.text.width-12:p.statusRows[g][m].x=m*12+p.text.width+18;p.sideContainer.x=(-this.renderer.chart.gameType.notefieldWidth/2-128)*(f=="left"?-1:1),p.text.anchor.x=f=="left"?0:1,p.hitbox.anchor.x=p.text.anchor.x,p.nodePool.x/=b.chart.zoom,p.detail.x=(p.text.width+10)*(f=="left"?1:-1),p.detail.anchor.x=f=="left"?0:1,p.detail.align=f}if(b.debug.parity.showDebug?(this.debugTexts.forEach((h,p)=>{h.x=(-this.renderer.chartManager.app.STAGE_WIDTH/2+10-b.chart.receptorXPos)/b.chart.zoom,h.y=(this.renderer.chartManager.app.STAGE_HEIGHT/2-10)/b.chart.zoom+(p-this.debugTexts.length+1)*30}),this.debugBG.x=(-this.renderer.chartManager.app.STAGE_WIDTH/2-b.chart.receptorXPos)/b.chart.zoom,this.debugBG.y=this.renderer.chartManager.app.STAGE_HEIGHT/2/b.chart.zoom,this.debugBG.width=this.debugContainer.width+20/b.chart.zoom,this.debugBG.height=this.debugContainer.height+15/b.chart.zoom,this.debugContainer.visible=!0,this.debugBG.visible=!0):(this.debugContainer.visible=!1,this.debugBG.visible=!1),this.connections.clear(),b.debug.parity.showGraph)for(let h=0;h<n.debug.notedataRows.length&&!(t<n.debug.notedataRows[h-1]?.beat);h++){if(e>n.debug.notedataRows[h+1]?.beat)continue;const p=n.debug.notedataRows[h],m=n.debug.nodeRows[h].nodes,g=this.rowMap.get(p),y=this.rowMap.get(n.debug.notedataRows[h+1]);if(!(!g||!y))for(const x of m){const w=g.nodePool.getChildByName(x.key);if(w)for(const[_,C]of x.children.entries()){const F=y.nodePool.getChildByName(_);if(!F)continue;let T=11499473,R=1.5;h>=n.debug.stats.lastUpdatedNodeStart&&h<n.debug.stats.lastUpdatedNodeEnd&&(T=65280);let N=.5-Math.min(.45,Math.log1p(C.TOTAL)/15);if(w.connections.getChildByName(_)){const j=w.connections.getChildByName(_);j.x=F.x+y.nodePool.x-(w.x+g.nodePool.x),j.y=y.y-g.y,N+=.3,T=6539775,R=2.5}n.debug.bestPathSet?.has(x.key)&&n.debug.bestPathSet.has(_)&&(T=12536064,N+=.4,R=4),this.connections.lineStyle(R,T,N),this.connections.moveTo(w.x+g.nodePool.x,g.y),this.connections.lineTo(F.x+y.nodePool.x,y.y)}}}}createBoxWithText(e){const t=new he;return t.background=new ye(xe.WHITE),t.background.width=e.boxWidth||64,t.background.height=e.boxHeight||64,t.background.tint=e.boxTint||16777215,t.background.alpha=e.boxOpacity||.5,t.background.anchor.set(.5,.5),t.addChild(t.background),t.text=new ge(e.text,{fontName:"Main",fontSize:25}),t.text.tint=e.textTint||16777215,t.text.alpha=e.textOpacity||1,t.text.anchor.set(.5,.5),t.addChild(t.text),t}createDebugObject(e,t){const n=new he;return n.text=new ge("",{fontName:"Main",fontSize:20}),n.text.tint=e,n.text.anchor.set(0,1),n.addChild(n.text),n.update=t,this.debugTexts.push(n),this.debugContainer.addChild(n),n}}class dg extends he{isEditGUI=!0;previewArea=new ye(xe.WHITE);previewText=new ge("SONG PREVIEW",{fontName:"Main",fontSize:13});renderer;constructor(e){super(),this.renderer=e,Object.assign(this.previewArea,{alpha:.2,tint:11052482,width:this.renderer.chart.gameType.notefieldWidth+96,height:64}),this.previewText.x=-this.previewArea.width/2+5,this.previewArea.anchor.x=.5,Ue(this.previewText,"text-color"),this.addChild(this.previewArea,this.previewText)}update(e,t){const n=Number(this.renderer.chart.sm.properties.SAMPLESTART),r=Number(this.renderer.chart.sm.properties.SAMPLELENGTH);if(Number.isNaN(n)||Number.isNaN(r)||this.renderer.chart.timingData.getBeatFromSeconds(n+r)<e||this.renderer.chart.timingData.getBeatFromSeconds(n)>t){this.visible=!1;return}this.visible=!0;let a=this.renderer.getYPosFromSecond(n),s=this.renderer.getYPosFromSecond(n+r);s<a&&([s,a]=[a,s]),this.previewArea.y=a,this.previewArea.height=s-a,this.previewText.anchor.y=b.chart.reverse?1:0,b.chart.reverse?this.previewText.y=Se(this.renderer.getUpperBound()-35,this.previewArea.y+15,this.previewArea.y+this.previewArea.height-5):this.previewText.y=Se(this.renderer.getUpperBound()+35,this.previewArea.y+5,this.previewArea.y+this.previewArea.height-15)}}class hg extends he{isEditGUI=!1;renderer;scrollMap=new Map;receptors;topBound;bottomBound;topBoundBeat;bottomBoundBeat;topScreenBeat;bottomScreenBeat;topScreenBeatText;bottomScreenBeatText;children=[];constructor(e){super(),this.visible=!1,this.renderer=e,this.receptors=this.createBar(7829503),this.receptors.width=300,this.addChild(this.receptors),this.topBound=this.createBar(16711680),this.addChild(this.topBound),this.bottomBound=this.createBar(16711680),this.addChild(this.bottomBound),this.topBoundBeat=this.createBar(16777096),this.addChild(this.topBoundBeat),this.bottomBoundBeat=this.createBar(8978431),this.addChild(this.bottomBoundBeat),this.topScreenBeat=this.createBar(16746751),this.topScreenBeat.width=300,this.addChild(this.topScreenBeat),this.topScreenBeatText=new ge("",{fontName:"Fancy",fontSize:50}),this.topScreenBeatText.anchor.x=.5,this.topScreenBeatText.anchor.y=.5,this.topScreenBeatText.tint=16746751,this.addChild(this.topScreenBeatText),this.bottomScreenBeat=this.createBar(16724991),this.bottomScreenBeat.width=300,this.addChild(this.bottomScreenBeat),this.bottomScreenBeatText=new ge("",{fontName:"Fancy",fontSize:50}),this.bottomScreenBeatText.anchor.x=.5,this.bottomScreenBeatText.anchor.y=.5,this.bottomScreenBeatText.tint=16724991,this.addChild(this.bottomScreenBeatText),this.scale.x=.4,this.scale.y=.4}createBar(e){const t=new ye(xe.WHITE);return Object.assign(t,{width:750,height:15,tint:e,opacity:.5}),t.anchor.set(.5),t}update(){if(this.visible=b.debug.showScroll,!this.visible)return;const e=this.renderer.chart.timingData.getTimingData("SCROLLS");this.x=this.renderer.chartManager.app.STAGE_WIDTH/4;for(const a of this.scrollMap.values())a.marked=!1;for(const a of e){if(a==e.at(-1))continue;if(this.scrollMap.has(a)){this.scrollMap.get(a).marked=!0;continue}const s=new he,o=new ye(xe.WHITE),l=new ge("",{fontName:"Main",fontSize:25});o.alpha=.2,o.width=150,o.anchor.x=.5,l.anchor.x=.5,s.text=l,s.marked=!0,s.box=o,this.scrollMap.set(a,s),s.addChild(o,l),this.addChild(s)}const t=this.renderer.chartManager.beat;for(let a=0;a<e.length-1;a++){let s=this.renderer.getYPosFromBeat(e[a].beat),o=this.renderer.getYPosFromBeat(e[a+1].beat);const l=this.scrollMap.get(e[a]);if(!this.inBounds(o)&&!this.inBounds(s)&&s*o>=0){l.visible=!1;continue}if(Math.abs(e[a].beat-t)>20&&Math.abs(e[a+1].beat-t)>20&&!(t>e[a].beat&&t<e[a+1].beat)){l.visible=!1;continue}l.text.text=`yStart:${fe(s,1)}
yEnd:${fe(o,1)}
val:${e[a].value}
h:${fe(o-s,1)}`,o<s&&([s,o]=[o,s]),l.visible=!0,l.y=s,l.box.height=o-s,l.box.tint=16777215,l.text.tint=16777215,t>e[a].beat&&t<e[a+1].beat&&(l.text.y=Math.max(this.renderer.getActualReceptorYPos()-s,0),l.box.tint=8978312),t<e[a].beat&&(l.text.y=0),t>e[a+1].beat&&(l.text.y=l.box.height),l.x=(a%4-1.5)*150}for(const[a,s]of this.scrollMap.entries())if(!s.marked){this.scrollMap.delete(a),s.destroy();continue}const n=this.renderer.findFirstOnScreenScroll(),r=this.renderer.findLastOnScreenScroll();{const a=this.scrollMap.get(n);a&&(a.text.text+=`
start`,a.box.tint==16777215&&(a.box.tint=16777096),a.text.tint=16777096)}{const a=this.scrollMap.get(r);a&&(a.text.text+=`
end`,a.box.tint==16777215&&(a.box.tint=8978431),a.text.tint=8978431)}this.receptors.y=this.renderer.getActualReceptorYPos(),this.topBound.y=this.renderer.getUpperBound(),this.bottomBound.y=this.renderer.getLowerBound(),this.topBoundBeat.y=this.renderer.getYPosFromBeat(this.renderer.getVisualBeat()-b.chart.maxDrawBeatsBack),this.bottomBoundBeat.y=this.renderer.getYPosFromBeat(this.renderer.getVisualBeat()+b.chart.maxDrawBeats),this.topScreenBeat.y=this.renderer.getYPosFromBeat(this.renderer.getTopOnScreenBeat()),this.bottomScreenBeat.y=this.renderer.getYPosFromBeat(this.renderer.getBottomOnScreenBeat()),this.topScreenBeatText.y=this.topScreenBeat.y,this.topScreenBeatText.text=fe(this.renderer.getTopOnScreenBeat(),3)+"",this.bottomScreenBeatText.y=this.bottomScreenBeat.y,this.bottomScreenBeatText.text=fe(this.renderer.getBottomOnScreenBeat(),3)+""}inBounds(e){const t=this.renderer.chartManager.app.STAGE_HEIGHT/this.scale.y;return Math.abs(e)<t}}class fg extends he{isEditGUI=!0;startMarker=new ye(xe.WHITE);selectionArea=new ye(xe.WHITE);renderer;constructor(e){super(),this.renderer=e,Object.assign(this.startMarker,{alpha:0,width:this.renderer.chart.gameType.notefieldWidth,height:64}),Object.assign(this.selectionArea,{alpha:0,tint:5140387,width:this.renderer.chart.gameType.notefieldWidth,height:64}),this.startMarker.anchor.set(.5),this.selectionArea.anchor.x=.5,this.addChild(this.selectionArea,this.startMarker)}update(){if(this.renderer.chartManager.getMode()==U.Play||this.renderer.chartManager.app.capturing){this.visible=!1;return}this.visible=!0;const e=this.renderer.chartManager.startRegion,t=this.renderer.chartManager.endRegion;e!==void 0&&t===void 0?(this.startMarker.alpha=Math.sin(Date.now()/320)*.1+.3,this.startMarker.y=this.renderer.getYPosFromBeat(e)):this.startMarker.alpha=0,e!==void 0&&t!==void 0?(this.selectionArea.alpha=Math.sin(Date.now()/320)*.1+.3,this.selectionArea.y=this.renderer.getYPosFromBeat(Math.min(e,t)),this.selectionArea.height=this.renderer.getYPosFromBeat(Math.max(e,t))-this.selectionArea.y):this.selectionArea.alpha=0}}class pg extends ye{isEditGUI=!0;renderer;constructor(e){super(xe.WHITE),this.renderer=e,this.visible=!1,this.alpha=.2,this.eventMode="none"}update(){const e=this.renderer.getSelectionBounds();if(this.visible=!!e,e){const t=this.renderer.getYPosFromBeat(e?.startBeat),n=this.renderer.getYPosFromBeat(e?.endBeat);this.position.x=Math.min(e.startX,e.endX),this.position.y=Math.min(t,n),this.width=Math.abs(e.endX-e.startX),this.height=Math.abs(n-t)}}}class It extends Ui{static options;static cachedError;static editText;static onParityChange;static open(e){if(this.active)return;this.cachedError={beat:e.beat,error:e.error};const t=e.chart.isErrorIgnored(this.cachedError.error,this.cachedError.beat);super._open({...e,attach:e.box,title:Ho[e.error].title,description:Ho[e.error].description,width:150,editable:!1,cancelableOnOpen:!1,background:t?"#404040":"#41031c",textColor:"#ffffff",options:[]}),this.onParityChange=this.updateValues.bind(this),ee.on("parityIgnoresModified",this.onParityChange),ee.on("parityModified",this.onParityChange),this.updateValues()}static buildContent(){const e=document.createElement("div");e.innerText="click to ignore",e.style.marginTop="4px",e.style.height="10px",e.classList.add("popup-desc"),this.editText=e,this.view.appendChild(e)}static updateValues(){if(!this.active||!this.cachedError)return;const e=this.options.chart.isErrorIgnored(this.cachedError.error,this.cachedError.beat);this.editText.innerText=e?"click to unignore":"click to ignore",this.view.style.backgroundColor=e?"#404040":"#41031c"}static close(){this.active&&(super.close(),ee.off("parityIgnoresModified",this.onParityChange),ee.off("parityModified",this.onParityChange),this.cachedError=void 0)}static getError(){return this.cachedError}}class mg extends he{isEditGUI=!0;renderer;parityDirty=!1;errorIconTexture;errorIconIgnoredTexture;boxPool=new Ht({create:()=>this.createErrorBox()});highlightPool=new Ht({create:()=>{const e=new ye(xe.WHITE);return e.height=16,e.alpha=.6,e.anchor.set(.5,.5),e}});reposition=!1;topCounter;bottomCounter;previousTopVisible=!1;previousBottomVisible=!1;rowMap=new Map;children=[];constructor(e){super(),this.renderer=e,this.addChild(this.highlightPool),this.addChild(this.boxPool);const t=()=>{this.parityDirty=!0},n=c=>{(c=="chart.zoom"||c=="chart.reverse"||c=="general.uiScale")&&(this.reposition=!0)};ee.on("parityModified",t),ee.on("parityIgnoresModified",t),ee.on("userOptionUpdated",n),this.on("destroyed",()=>{ee.off("parityModified",t),ee.off("parityIgnoresModified",t),ee.off("userOptionUpdated",n)});const r=new Hi;r.beginFill(11341390),r.drawCircle(0,0,12),r.endFill(),r.lineStyle(.5,0),r.drawCircle(0,0,12),r.lineStyle(.5,16777215),r.drawCircle(0,0,10);const a=new ge("!",{fontName:"Fancy",fontSize:15});a.anchor.set(.5,.5),a.y-=2,a.x+=.3;const s=new he;s.addChild(r,a),s.x=16,s.y=16,this.errorIconTexture=ti.create({resolution:b.performance.resolution,width:32,height:32}),this.renderer.chartManager.app.renderer.render(s,{renderTexture:this.errorIconTexture}),r.clear(),r.beginFill(4473924),r.drawCircle(0,0,12),r.endFill(),r.lineStyle(.5,0),r.drawCircle(0,0,12),r.lineStyle(.5,16777215),r.drawCircle(0,0,10),this.errorIconIgnoredTexture=ti.create({resolution:b.performance.resolution,width:32,height:32}),this.renderer.chartManager.app.renderer.render(s,{renderTexture:this.errorIconIgnoredTexture}),this.topCounter=this.createErrorBox(),this.bottomCounter=this.createErrorBox();const o=new Hi;o.beginFill(16777215),o.moveTo(6,0),o.lineTo(0,-6),o.lineTo(-6,0),o.endFill(),o.y=-15,this.topCounter.addChild(o);const l=this.topCounter.setText.bind(this.topCounter);this.topCounter.setText=c=>{l(c),o.x=-this.topCounter.textObj.width/2+16};const u=new Hi;u.beginFill(16777215),u.moveTo(6,0),u.lineTo(0,6),u.lineTo(-6,0),u.endFill(),this.bottomCounter.addChild(u),u.y=15;const f=this.bottomCounter.setText.bind(this.bottomCounter);this.bottomCounter.setText=c=>{f(c),u.x=-this.bottomCounter.textObj.width/2+16},this.topCounter.y=b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT/2+50:-this.renderer.chartManager.app.STAGE_HEIGHT/2-50,this.topCounter.y/=b.chart.zoom,this.bottomCounter.y=b.chart.reverse?-this.renderer.chartManager.app.STAGE_HEIGHT/2-50:this.renderer.chartManager.app.STAGE_HEIGHT/2+50,this.bottomCounter.y/=b.chart.zoom,this.addChild(this.topCounter,this.bottomCounter),this.topCounter.on("pointerover",()=>{lt.animate(this.topCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.4,y:1.4}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},"te-top-hover")}),this.topCounter.on("pointerout",()=>{lt.animate(this.topCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.25,y:1.25}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},"te-top-hover")}),this.topCounter.on("pointerdown",c=>{if(!this.renderer.chart.stats.parity)return;const d=this.renderer.chart.getTechErrors(c.shiftKey).map(p=>p.beat),h=kr(d,this.renderer.chartManager.beat);h!==null&&(c.stopImmediatePropagation(),this.renderer.chartManager.beat=h)}),this.topCounter.eventMode="static",this.topCounter.cursor="pointer",this.bottomCounter.on("pointerover",()=>{lt.animate(this.bottomCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.4,y:1.4}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},"te-bottom-hover")}),this.bottomCounter.on("pointerout",()=>{lt.animate(this.bottomCounter.scale,{0:{x:"inherit",y:"inherit"},1:{x:1.25,y:1.25}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},"te-bottom-hover")}),this.bottomCounter.on("pointerdown",c=>{if(!this.renderer.chart.stats.parity)return;const d=this.renderer.chart.getTechErrors(c.shiftKey).map(p=>p.beat),h=Ar(d,this.renderer.chartManager.beat);h!==null&&(c.stopImmediatePropagation(),this.renderer.chartManager.beat=h)}),this.bottomCounter.eventMode="static",this.bottomCounter.cursor="pointer",this.topCounter.scale.set(1.25),this.bottomCounter.scale.set(1.25)}update(e,t){const n=this.renderer.chart.stats.parity,r=this.renderer.chart;if(!n||!b.chart.parity.enabled||!b.chart.parity.showErrors){this.visible=!1;return}this.topCounter.visible=this.renderer.chartManager.getMode()==U.Edit,this.bottomCounter.visible=this.renderer.chartManager.getMode()==U.Edit,this.visible=!0,this.parityDirty&&(this.rowMap.clear(),this.boxPool.destroyAll(),this.highlightPool.destroyAll(),this.parityDirty=!1);let a=0,s=0;for(const o of n.techErrors.keys()){const l=n.rowTimestamps[o];if(t<l.beat){r.getTechErrorsAtRow(o).size!=0&&(s+=r.getTechErrorsAtRow(o).size);continue}if(e>l.beat){r.getTechErrorsAtRow(o).size!=0&&(a+=r.getTechErrorsAtRow(o).size);continue}if(!this.rowMap.has(o)){const u=n.techErrors.get(o).values().toArray().sort(),f=[],c=this.highlightPool.createChild();if(!c)break;c.width=this.renderer.chart.gameType.notefieldWidth+80,c.tint=11341390;for(const d of u){const h=this.boxPool.createChild();if(!h)break;Xt.instance.register(h,l.beat,l.second,"left",40+d),f.push(h),h.setText(Gc[d]),r.isErrorIgnored(d,l.beat)?h.ignore():h.unignore(),It.getError()?.beat==l.beat&&It.getError()?.error==d&&It.attach(h),h.cursor="pointer",h.on("mouseenter",()=>{this.renderer.isDragSelecting()||It.getError()?.beat==l.beat&&It.getError()?.error==d||(It.active&&It.close(),this.renderer.chartManager.getMode()==U.Edit&&It.open({box:h,beat:l.beat,error:d,ignored:!1,chart:r}))}),h.on("mouseleave",()=>{It.getError()?.beat!=l.beat||It.getError()?.error!=d||It.close()}),h.on("pointerdown",p=>{qr(p)||(p.stopImmediatePropagation(),r.isErrorIgnored(d,l.beat)?r.deleteErrorIgnore(d,l.beat):r.addErrorIgnore(d,l.beat))}),h.eventMode="static"}this.rowMap.set(o,{boxes:f,highlight:c})}}for(const[o,{boxes:l,highlight:u}]of this.rowMap.entries()){const f=n.rowTimestamps[o];if(!f)continue;if(f.beat<e||f.beat>t){this.rowMap.delete(o),l.forEach(d=>{this.boxPool.destroyChild(d)}),It.getError()?.beat==f.beat&&It.close(),this.highlightPool.destroyChild(u);continue}const c=this.renderer.getYPosFromBeat(f.beat);u.y=c,u.visible=r.getTechErrorsAtRow(o).size!=0}if(this.topCounter.setText(a+""),this.bottomCounter.setText(s+""),this.previousTopVisible!=a>0||this.reposition){this.previousTopVisible=a>0;let o=b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT/2-40:-this.renderer.chartManager.app.STAGE_HEIGHT/2+40;a==0&&(b.chart.reverse?o+=90:o-=90),lt.animate(this.topCounter,{0:{y:"inherit"},1:{y:o/b.chart.zoom}},b.general.smoothAnimations&&!this.reposition?.3:0,mt(0,0,.16,1.01),()=>{},"te-top-counter")}if(this.previousBottomVisible!=s>0||this.reposition){this.previousBottomVisible=s>0;let o=b.chart.reverse?-this.renderer.chartManager.app.STAGE_HEIGHT/2+40:this.renderer.chartManager.app.STAGE_HEIGHT/2-40;s==0&&(b.chart.reverse?o-=90:o+=90),lt.animate(this.bottomCounter,{0:{y:"inherit"},1:{y:o/b.chart.zoom}},b.general.smoothAnimations&&!this.reposition?.3:0,mt(0,0,.16,1.01),()=>{},"te-bottom-counter")}this.topCounter.x=-this.renderer.chart.gameType.notefieldWidth/2-160,this.bottomCounter.x=-this.renderer.chart.gameType.notefieldWidth/2-160,this.reposition=!1}createErrorBox(){const e=new he;e.textObj=new ge("",{fontName:"Main",fontSize:15});const t=new ye(this.errorIconTexture);t.anchor.y=.5,t.anchor.x=.5,e.icon=t;const n=new dt("noBorder");n.tint=11341390,e.bg=n,e.addChild(n,e.textObj,t);let r="-";const a=l=>{l!==r&&(r=l,e.textObj.text=l,e.textObj.anchor.set(.5,.55),e.textObj.x=13,e.bg.width=e.textObj.width+17,e.bg.height=20,e.bg.position.x=-e.bg.width/2+8,e.bg.position.y=-20/2,e.icon.position.x=-e.bg.width/2-2+8)};e.setText=a,a("");const s=()=>{n.tint=4473924,e.textObj.alpha=.5,t.texture=this.errorIconIgnoredTexture},o=()=>{n.tint=11341390,e.textObj.alpha=1,t.texture=this.errorIconTexture};return e.ignore=s,e.unignore=o,e}}class hn extends Ui{static box;static open(e,t){this.active||(this.box=e,super._open({attach:e,title:zo[t].title,description:zo[t].description,width:150,editable:!1,cancelableOnOpen:!1,background:"#404040",textColor:"#ffffff",options:[]}))}static close(){this.active&&(super.close(),this.box=void 0)}}class gg extends he{isEditGUI=!0;renderer;parityDirty=!1;boxPool=new Ht({create:()=>{const e=new he;return e.textObj=new ge("",{fontName:"Main",fontSize:20}),e.addChild(e.textObj),e}});rowMap=new Map;children=[];constructor(e){super(),this.renderer=e,this.addChild(this.boxPool);const t=()=>{this.parityDirty=!0};ee.on("parityModified",t),this.on("destroyed",()=>ee.off("parityModified",t))}update(e,t){const n=this.renderer.chart.stats.parity;if(!n||!b.chart.parity.enabled||!b.chart.parity.showTech){this.visible=!1;return}this.visible=!0,this.parityDirty&&(this.rowMap.clear(),this.boxPool.destroyAll(),this.parityDirty=!1);for(let r=0;r<n.techRows.length;r++){const a=n.rowTimestamps[r];if(n.techRows[r]!==void 0){if(t<a.beat)break;if(!(e>a.beat)&&!this.rowMap.has(r)){const s=n.techRows[r].values().toArray().sort(),o=[];for(const l of s){const u=this.boxPool.createChild();if(!u)break;Xt.instance.register(u,a.beat,a.second,"right",20+l),o.push(u),u.textObj.text=Nc[l],u.textObj.anchor.set(.5,.55),u.on("mouseenter",()=>{this.renderer.isDragSelecting()||(hn.active&&hn.close(),this.renderer.chartManager.getMode()==U.Edit&&hn.open(u,l))}),u.on("mouseleave",()=>{hn.close()}),u.eventMode="static"}this.rowMap.set(r,o)}}}for(const[r,a]of this.rowMap.entries()){const s=n.rowTimestamps[r];if(s&&(s.beat<e||s.beat>t)){this.rowMap.delete(r),a.forEach(o=>{this.boxPool.destroyChild(o),hn.box==o&&hn.close()});continue}}}}const bg=3500;class yg extends ye{isEditGUI=!0;lineContainer=new Yr(1500,{position:!0,scale:!0,tint:!0,alpha:!0},16384,!0);waveformTex;renderer;rawData=[];filteredRawData=[];speed;lastSpeed;lastSpeedTimeout;sampleRate=44100;poolSearch=0;trackedVariables=new Map;drawDirty=!0;blockCache=new Map;colorCache=new B("black");filteredColorCache=new B("black");constructor(e){super(),this.renderer=e,this.waveformTex=ti.create({resolution:Math.min(1,b.performance.resolution)}),this.texture=this.waveformTex,this.speed=this.getSpeed(),this.lastSpeed=this.getSpeed(),this.trackVariable(()=>this.renderer.getVisualBeat()),this.trackVariable(()=>this.renderer.getVisualTime()),this.trackVariable(()=>b.chart.speed),this.trackVariable(()=>this.getSpeed(),a=>{this.speed=a,clearTimeout(this.lastSpeedTimeout),this.lastSpeedTimeout=setTimeout(()=>{this.blockCache.clear(),this.lastSpeed=this.speed,this.drawDirty=!0},200)}),this.trackVariable(()=>b.chart.zoom),this.trackVariable(()=>b.chart.CMod),this.trackVariable(()=>b.chart.doSpeedChanges),this.trackVariable(()=>b.chart.waveform.allowFilter),this.trackVariable(()=>b.chart.reverse),this.trackVariable(()=>b.chart.waveform.antialiasing,a=>{this.filters=a?[new Vo]:[]}),this.trackVariable(()=>this.renderer.chartManager.app.STAGE_WIDTH,()=>this.resizeWaveform()),this.trackVariable(()=>this.renderer.chartManager.app.STAGE_HEIGHT,()=>this.resizeWaveform()),this.trackVariable(()=>b.chart.waveform.filteredColor),this.trackVariable(()=>b.chart.waveform.color),this.trackVariable(()=>b.chart.waveform.speedChanges),this.trackVariable(()=>b.chart.receptorYPos),this.trackVariable(()=>b.chart.waveform.lineHeight,()=>{b.chart.waveform.lineHeight<=0&&(b.chart.waveform.lineHeight=1),this.updateLineHeight()}),this.trackVariable(()=>b.chart.zoom,()=>this.resizeWaveform()),this.trackVariable(()=>this.renderer.chartManager.chartAudio.hasFilters());const t=()=>this.getData();this.anchor.set(.5),this.renderer.chartManager.chartAudio.onUpdate(t),this.getData(),this.resizeWaveform(),this.filters=b.chart.waveform.antialiasing?[new Vo]:[];const n=()=>this.drawDirty=!0,r=()=>{this.getData(),this.resizeWaveform(),this.renderer.chartManager.chartAudio.onUpdate(t)};ee.on("timingModified",n),this.on("destroyed",()=>{ee.off("timingModified",n)}),ee.on("audioLoaded",r),this.on("destroyed",()=>{ee.off("audioLoaded",r),this.renderer.chartManager.chartAudio.offUpdate(t)})}getData(){this.rawData=this.renderer.chartManager.chartAudio.getRawData(),this.filteredRawData=this.renderer.chartManager.chartAudio.getFilteredRawData(),this.sampleRate=this.renderer.chartManager.chartAudio.getSampleRate(),this.blockCache.clear(),this.drawDirty=!0}resizeWaveform(){this.waveformTex.resize(Se((this.rawData?.length??0)*288*b.chart.zoom,1,this.renderer.chartManager.app.STAGE_WIDTH),this.renderer.chartManager.app.STAGE_HEIGHT)}update(){this.visible=b.chart.waveform.enabled,b.chart.waveform.enabled&&((this.drawDirty||this.variableChanged())&&(this.colorCache.toHexa()!=b.chart.waveform.color&&(this.colorCache=er(b.chart.waveform.color)),this.filteredColorCache.toHexa()!=b.chart.waveform.filteredColor&&(this.filteredColorCache=er(b.chart.waveform.filteredColor)),this.drawDirty=!1,this.renderData(),this.renderer.chartManager.app.renderer.render(this.lineContainer,{renderTexture:this.waveformTex})),this.scale.set(1/b.chart.zoom))}trackVariable(e,t){this.trackedVariables.set(e,{value:e(),cb:t})}variableChanged(){let e=!1;for(const[t,n]of this.trackedVariables.entries())t()!=n.value&&(this.trackedVariables.get(t).value=t(),this.trackedVariables.get(t).cb?.(t()),e=!0);return e}getSample(e,t,n){if(t<0)return 0;const r=this.sampleRate/(this.lastSpeed*4),a=Math.floor(t*this.lastSpeed*4);if(this.blockCache.get(n)?.[a]!==void 0)return this.blockCache.get(n)[a];const s=Math.floor(a*r),o=e.slice(s,Math.floor(s+r)).reduce((l,u)=>l+Math.abs(u),0)/r;return this.blockCache.has(n)||this.blockCache.set(n,[]),this.blockCache.get(n)[a]=o,o}renderData(){this.resetPool();const e=b.chart.waveform.allowFilter&&this.renderer.chartManager.chartAudio.hasFilters(),t={data:{bpms:[],bpmIndex:0,timing:[],timingIndex:0,offset:0,lastBeat:-999,timingData:null},init(r){if(this.data.bpms=r.getTimingData("BPMS"),this.data.timing=r.getBeatTiming(),this.data.offset=r.getOffset(),this.data.bpms[0]?.beat!==0){const a=structuredClone(this.data.bpms[0])??{value:120,type:"BPMS",beat:0};a.beat=0,this.data.bpms.unshift(a)}this.data.timing.length==0&&this.data.timing.unshift({beat:0,secondBefore:-this.data.offset,secondAfter:-this.data.offset,secondClamp:-this.data.offset,secondOf:-this.data.offset,warped:!1,bpm:120}),this.data.timingData=r},getBPM(r){for(;r>this.data.bpms[this.data.bpmIndex+1]?.beat;)this.data.bpmIndex++;return this.data.bpms[this.data.bpmIndex].value},getSecond(r){const a=Math.floor(r*48)/48;if(r<=0)return-this.data.offset+r*60/this.getBPM(r);if(a>=this.data.timing[this.data.timingIndex+1]?.beat){for(;a>=this.data.timing[this.data.timingIndex+1]?.beat;)this.data.timingIndex++;return this.data.timingData.getSecondsFromBeat(r)}else{const s=this.data.timing[this.data.timingIndex];let l=(r-s.beat)*60/s.bpm;return s.warped&&(l=0),Math.max(s.secondClamp,s.secondAfter+l)}}},n=this.renderer.chartManager.app.STAGE_HEIGHT;if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const r=b.chart.speed,a=this.renderer.getCurrentSpeedMult(),s=this.renderer.getTopOnScreenBeat(),o=this.renderer.getBottomOnScreenBeat(),l=Math.min(s,o),u=Math.max(s,o),f=this.renderer.findFirstOnScreenScroll(),c=this.renderer.findLastOnScreenScroll(),d=[...this.renderer.chart.timingData.getTimingData("SCROLLS")];d[0]?.beat!=0&&d.unshift({type:"SCROLLS",beat:0,value:d[0]?.value??1}),t.init(this.renderer.chart.timingData);const h=d.findIndex(w=>w.beat==f.beat),p=d.findIndex(w=>w.beat==c.beat),m=100/r/Math.abs(a)/64/b.chart.zoom;let g=l,y=Math.round(this.renderer.getYPosFromBeat(g)*b.chart.zoom+n/2),x=this.renderer.chart.getSecondsFromBeat(g);for(const w of d.slice(h,p+1)){if(w.value==0)continue;const _=m/Math.abs(w.value);w.beat!=f.beat?g=w.beat:g=Math.round((g-w.beat)/_)*_+w.beat,y=Math.round(this.renderer.getYPosFromBeat(g)*b.chart.zoom+n/2),x=this.renderer.chart.getSecondsFromBeat(g);const C=this.renderer.getScrollDirection(w.value),F=d[d.indexOf(w)+1]?.beat??Number.MAX_VALUE;for(;g<Math.min(F,u);){if(y<0){if(C<0){g=F;break}g+=_*-y,y=0;continue}if(y>n){if(C>0){g=F;break}g+=_*(y-n),y=n;continue}g+=_*b.chart.waveform.lineHeight,y+=C*b.chart.waveform.lineHeight,x=t.getSecond(g),this.drawLine(x,y,e)}}}else if(b.chart.CMod){let r=this.renderer.getSecondFromYPos((-n/2+(b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT:0))/b.chart.zoom);const a=this.renderer.getPixelsToSecondsRatio()/b.chart.zoom;r=Math.floor(r/a)*a;const s=o=>{r+=a*b.chart.waveform.lineHeight,this.drawLine(r,o,e)};if(b.chart.reverse)for(let o=this.renderer.chartManager.app.STAGE_HEIGHT;o>=0;o-=b.chart.waveform.lineHeight)s(o);else for(let o=0;o<=this.renderer.chartManager.app.STAGE_HEIGHT;o+=b.chart.waveform.lineHeight)s(o)}else{let r=this.renderer.getBeatFromYPos((-n/2+(b.chart.reverse?this.renderer.chartManager.app.STAGE_HEIGHT:0))/b.chart.zoom);t.init(this.renderer.chart.timingData);const a=this.renderer.getPixelsToEffectiveBeatsRatio()/b.chart.zoom;r=Math.floor(r/a)*a;let s=this.renderer.chart.getSecondsFromBeat(r);const o=l=>{r+=a*b.chart.waveform.lineHeight,s=t.getSecond(r),this.drawLine(s,l,e)};if(b.chart.reverse)for(let l=this.renderer.chartManager.app.STAGE_HEIGHT;l>=0;l-=b.chart.waveform.lineHeight)o(l);else for(let l=0;l<=this.renderer.chartManager.app.STAGE_HEIGHT;l+=b.chart.waveform.lineHeight)o(l)}this.purgePool()}drawLine(e,t,n){if(!(e<0))for(let r=0;r<this.rawData.length;r++){const a=this.getLine();if(a.scale.x=this.getSample(this.rawData[r],e,"main")*16*b.chart.zoom,a.y=t,a.tint=this.colorCache,a.alpha=this.colorCache.alpha,a.x=this.waveformTex.width/2+288*(r+.5-this.rawData.length/2)*b.chart.zoom,!n)continue;const s=this.getLine();s.scale.x=this.getSample(this.filteredRawData[r],e,"filter")*16*b.chart.zoom,s.tint=this.filteredColorCache,s.alpha=this.filteredColorCache.alpha,s.y=t,s.x=this.waveformTex.width/2+288*(r+.5-this.filteredRawData.length/2)*b.chart.zoom}}resetPool(){this.poolSearch=0}purgePool(){Zt(this.lineContainer.children,(e,t)=>t>=this.poolSearch)}updateLineHeight(){for(const e of this.lineContainer.children){const t=e;t.height=b.chart.waveform.lineHeight}}getLine(){if(this.lineContainer.children[this.poolSearch]){const t=this.lineContainer.children[this.poolSearch];return t.visible=!0,this.poolSearch++,t}const e=new ye(xe.WHITE);return e.height=b.chart.waveform.lineHeight,e.anchor.set(.5),e.visible=!0,this.poolSearch++,this.lineContainer.addChild(e),e}getSpeed(){return Math.min(b.chart.speed,bg)}}const wg="/smeditor/assets/missing-Dwhls35X.png",sd=xe.from(wg),vg={HoldBodyTopOffset:0,HoldBodyBottomOffset:0,RollBodyTopOffset:0,RollBodyBottomOffset:0};class xg{renderer;options;objects=[];updateHooks=new Set;hooks={};metrics;constructor(e,t){this.renderer=e,this.options=t,this.options.init?.(e),this.metrics={...vg,...this.options.metrics}}update(e){this.options.update?.(e),this.updateHooks.forEach(({item:t,cb:n})=>{t.destroyed||n(e)})}getPlaceholderSprite(){const e=new ye(sd);return e.anchor.set(.5),e}getBlankSprite(){return new ye(xe.EMPTY)}getElement(e,t={}){try{return this.options.load?this.options.load.bind(this)(e,{noteskin:this,columnName:e.columnName,columnNumber:e.columnNumber,...t})??this.getPlaceholderSprite():this.loadElement(e,t)??this.getPlaceholderSprite()}catch(n){return console.error(n),b.debug.showNoteskinErrors&&ue.createFormatted("Noteskin Error: "+n,"error"),this.getPlaceholderSprite()}}loadElement(e,t={}){const n=this.followRedirs(e);return n===void 0?(b.debug.showNoteskinErrors&&ue.createFormatted(`Noteskin element ${e.columnName} ${e.element} failed to load for noteskin: Redirect loop`,"error"),this.getPlaceholderSprite()):n({noteskin:this,columnName:e.columnName,columnNumber:e.columnNumber,...t})}followRedirs(e){const t=[e];let n=e;for(;;){const r=this.options.elements[n.columnName]?.[n.element];if(r===void 0)return;if(typeof r=="function")return r;if(n={columnName:r.columnName??n.columnName,columnNumber:r.columnNumber??n.columnNumber,element:r.element},t.some(a=>n.columnName==a.columnName&&n.element==a.element))return;t.push(n)}}on(e,t,n){this.hooks[t]===void 0&&(this.hooks[t]=new Set);const r={item:e,cb:n};this.hooks[t].add(r),e.once("destroyed",()=>this.hooks[t].delete(r))}onUpdate(e,t){const n={item:e,cb:t};this.updateHooks.add(n),e.once("destroyed",()=>this.updateHooks.delete(n))}broadcast(e){if(this.hooks[e.type]===void 0)return;this.hooks[e.type].forEach(({item:n,cb:r})=>{n.destroyed||r(e)})}}const Eg="/smeditor/assets/hold_judgement-BL12d-N2.png";class Zi extends he{children=[];static held_tex;static dropped_tex;notefield;constructor(e){super(),Zi.held_tex||this.loadTex(),this.notefield=e}async loadTex(){const e=await Is.load(Eg),t=e.height,n=e.width;Zi.held_tex=new xe(e,new Kn(0,0,n,t/2)),Zi.dropped_tex=new xe(e,new Kn(0,t/2,n,t/2))}update(){this.y=this.notefield.renderer.getActualReceptorYPos()+(b.chart.reverse?-48:48);for(const e of this.children){const t=(Date.now()-e.createTime)/1e3;if(t<.1){const n=1-(1-t/.1)*(1-t/.1);e.scale.set(.3*n)}else if(t>.6&&t<.8){const n=(t-.6)/.2*(t-.6)/.2;e.scale.set(.3*(1-n))}}Zt(this.children,e=>Date.now()-e.createTime>800)}addJudge(e,t){if(!Xn(t)&&!yn(t))return;const n=new ye(Xn(t)?Zi.dropped_tex:Zi.held_tex);n.anchor.set(.5),n.x=this.notefield.getColumnX(e),n.createTime=Date.now(),n.scale.set(0),this.addChild(n)}}class Cg extends he{notefield;arrowMap=new Map;notesDirty=!1;children=[];constructor(e){super(),this.notefield=e,this.sortableChildren=!0;const t=()=>{this.arrowMap.clear(),this.removeChildren()},n=()=>this.notesDirty=!0;ee.on("timeSigChanged",t),ee.on("chartModified",n),this.on("destroyed",()=>{ee.off("timeSigChanged",t),ee.off("chartModified",n)})}update(e,t){const n=this.notefield.renderer.chart.getNotedata();if(this.notesDirty){for(const[r,a]of this.arrowMap.entries())n.includes(r)||(a.destroy(),this.arrowMap.delete(r));this.notesDirty=!1}for(const r of n){if(r.beat>t)break;if(this.shouldDisplayNote(r,e,t)&&!this.arrowMap.has(r)){const a=new he,s=this.notefield.createNote(r);Object.assign(a,{x:this.notefield.getColumnX(r.col),zIndex:r.beat});const o=new ye(xe.WHITE),l=s.getLocalBounds();o.x=l.x,o.y=l.y,o.width=l.width,o.height=l.height,o.alpha=0;const u=new ye(xe.WHITE);u.x=l.x,u.y=l.y,u.width=l.width,u.height=l.height,u.alpha=0;const f=new ye(xe.WHITE);f.x=l.x,f.y=l.y,f.width=l.width,f.height=5,f.tint=16711680,f.alpha=0,this.notefield.renderer.registerDragNote(a,r),a.wrapper=s,a.selection=o,a.parity=u,a.parityOverride=f,a.lastActive=!1,this.arrowMap.set(r,a),a.addChild(s,o,u,f),this.addChild(a)}}for(const[r,a]of this.arrowMap.entries()){if(!this.shouldDisplayNote(r,e,t)){a.destroy(),this.arrowMap.delete(r);continue}if(a.y=this.notefield.renderer.getActualReceptorYPos(),(!Oe(r)||!r.gameplay?.lastHoldActivation||this.notefield.renderer.getVisualBeat()<r.beat)&&(a.y=this.notefield.renderer.getYPosFromBeat(r.beat)),Oe(r)&&r.gameplay?.droppedHoldBeat&&(a.y=this.notefield.renderer.getYPosFromBeat(r.gameplay.droppedHoldBeat)),Oe(r)){const s=this.notefield.renderer.getYPosFromBeat(Ni(r))-a.y,o=a.wrapper.object;if(o.setLength(s),r.gameplay?.lastHoldActivation){let u=(Date.now()-r.gameplay.lastHoldActivation)/kt.getCollection(b.play.timingCollection).getHeldJudgement(r).getTimingWindowMS();u=Math.min(1.2,u),o.setBrightness(1-u*.7)}else o.setBrightness(1);r.gameplay?o.setActive(!(r.gameplay.lastHoldActivation===void 0||r.gameplay.droppedHoldBeat!==void 0)):o.setActive(!1);const l=a.wrapper.getLocalBounds();a.parity.x=l.x,a.parity.y=l.y,a.parity.width=l.width,a.parity.height=l.height,a.parityOverride.x=l.x,a.parityOverride.y=l.y,a.parityOverride.width=l.width}if(this.notefield.renderer.chartManager.editTimingMode==Te.Off){const s=this.notefield.renderer.shouldDisplayNoteSelection(r);if(a.selection.alpha=s?Math.sin(Date.now()/320)*.1+.3:0,s&&a.wrapper.object.type=="hold"){const l=a.wrapper.getLocalBounds();a.selection.x=l.x,a.selection.y=l.y,a.selection.width=l.width,a.selection.height=l.height}a.visible=!s||!this.notefield.renderer.chartManager.selection.shift;const o=this.notefield.renderer.selectionTest(a.wrapper);!s&&o&&this.notefield.renderer.chartManager.addNoteToDragSelection(r),s&&!o&&this.notefield.renderer.chartManager.removeNoteFromDragSelection(r)}if(b.chart.parity.enabled&&b.chart.parity.showHighlights&&this.notefield.renderer.chartManager.getMode()==U.Edit){const s=At(r.parity?.foot);a.parity.alpha=r.parity?s.alpha:0,a.parity.tint=s,r.parity?.override?a.parityOverride.alpha=.4:a.parityOverride.alpha=0}else a.parity.alpha=0,a.parityOverride.alpha=0}}shouldDisplayNote(e,t,n){return e.gameplay?.hideNote||b.chart.CMod&&e.fake&&b.chart.hideFakedArrows||b.chart.CMod&&b.chart.hideWarpedArrows&&e.warped||Ni(e)<t?!1:e.beat<=n}}class _g extends he{notefield;children=[];constructor(e){super(),this.notefield=e,this.eventMode="none";for(let t=0;t<this.notefield.gameType.numCols;t++){const n=this.notefield.getElement({element:"NoteFlash",columnName:this.notefield.getColumnName(t),columnNumber:t});n.x=this.notefield.getColumnX(t),this.addChild(n)}}update(){this.y=this.notefield.renderer.getActualReceptorYPos()}}class Ag extends he{notefield;children=[];dragStart=null;dragOptionsStart=null;optionUpdate=e=>{e=="chart.allowReceptorDrag"&&(this.eventMode=b.chart.allowReceptorDrag?"static":"passive")};constructor(e){super(),this.notefield=e,this.cursor="grab";for(let r=0;r<this.notefield.gameType.numCols;r++){const a=this.notefield.getElement({element:"Receptor",columnName:this.notefield.getColumnName(r),columnNumber:r});a.x=this.notefield.getColumnX(r),this.addChild(a)}const t=r=>{!this.dragStart||!this.dragOptionsStart||(b.chart.receptorXPos=Math.round(this.dragOptionsStart[0]+r.global.x-this.dragStart.x),b.chart.receptorYPos=Math.round(this.dragOptionsStart[1]+(r.global.y-this.dragStart.y)*(b.chart.reverse?-1:1)))},n=()=>{this.cursor="grab",this.notefield.renderer.off("pointermove",t),window.removeEventListener("pointerup",n)};this.on("pointerdown",r=>{this.cursor="grabbing",this.dragStart=new yd(r.globalX,r.globalY),this.dragOptionsStart=[b.chart.receptorXPos,b.chart.receptorYPos],r.preventDefault(),r.stopImmediatePropagation(),this.notefield.renderer.on("pointermove",t),window.addEventListener("pointerup",n)}),ee.on("userOptionUpdated",this.optionUpdate),this.optionUpdate("chart.allowReceptorDrag")}destroy(){ee.off("userOptionUpdated",this.optionUpdate)}update(){this.y=this.notefield.renderer.getActualReceptorYPos()}}class kg extends he{notefield;arrowMap=new Map;children=[];lastBeatShift=0;lastColShift=0;constructor(e){super(),this.notefield=e,this.sortableChildren=!0}update(e,t){if(!this.notefield.renderer.chartManager.selection.shift){this.removeChildren(),this.arrowMap.clear();return}const n=this.notefield.renderer.chartManager.selection.shift.beatShift,r=this.notefield.renderer.chartManager.selection.shift.columnShift;if(this.lastBeatShift!=n||this.lastColShift!=r){this.lastBeatShift=n,this.lastColShift=r;for(const[a,s]of this.arrowMap.entries()){const o=this.notefield.renderer.chartManager.loadedChart.computeNote({...a,beat:a.beat+n,col:a.col+r});s.x=this.notefield.getColumnX(o.col),s.wrapper.destroy(),s.wrapper.alpha=.4,s.wrapper=this.notefield.createNote(o);const l=s.wrapper.getBounds();s.selection.x=l.x,s.selection.y=l.y,s.selection.width=l.width,s.selection.height=l.height,s.addChild(s.wrapper,s.selection)}}for(const a of this.notefield.renderer.chartManager.selection.notes)if(!(a.beat+n+(Oe(a)?a.hold:0)<e)&&!(a.beat+n>t)&&!this.arrowMap.has(a)){const s={...a,beat:a.beat+n,col:a.col+r},o=new he,l=this.notefield.createNote(s);Object.assign(o,{x:this.notefield.getColumnX(s.col),zIndex:s.beat,alpha:.4});const u=new ye(xe.WHITE),f=l.getBounds();u.x=f.x,u.y=f.y,u.width=f.width,u.height=f.height,u.alpha=0,this.notefield.renderer.registerDragNote(l,s),o.wrapper=l,o.selection=u,this.arrowMap.set(a,o),o.addChild(l,u),this.addChild(o)}for(const[a,s]of this.arrowMap.entries()){if(a.beat+n+(Oe(a)?a.hold:0)<e||a.beat+n>t){s.destroy(),this.arrowMap.delete(a);continue}const o=a.beat+n;if(s.y=this.notefield.renderer.getYPosFromBeat(o),s.selection.alpha=Math.sin(Date.now()/320)*.1+.3,Oe(a)){const l=this.notefield.renderer.getYPosFromBeat(o+(Oe(a)?a.hold:0))-s.y,u=s.wrapper.object;u.setLength(l),u.setBrightness(1);const f=s.wrapper.getLocalBounds();s.selection.x=f.x,s.selection.y=f.y,s.selection.width=f.width,s.selection.height=f.height}}}}const Tg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAZ5QTFRFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8fHx9vb29PT0AAAA+fn5/////f39AAAAAAAAAAAAAAAA/v7+AAAAAAAA9vb2AAAAAAAA8/PzAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAv401VgAAAIp0Uk5TABZHbpW80t3u+bttRhUKT5H+/9GQTgkCPJnxok0DCGreaQd05nLf41Qgs7EeUFYTx8QSGtYdKOLhJxvg5B/VxZRS8O+ysHVw5fv28fRn7v/qvtwBQeo+nvKb8vRLwr2Mz/0URGuSudPt6/jOSp2aQD3bZnNJrkxRjgYP0NQmGREEiFVvM+yNRZO6TR9aLAAABG9JREFUeJzt2VloFEkYAOD/T2aSzJh0gmSM7kbFQYOJGWJWNB6oefBYjAdeeBCMB3iB7IPHgw/isoIu6y6yeIDZNQaVhYjghSd44IO6G6IxwSsq4n2GGE2Midr2SI4+/uqq6h5lhfkfcnRX1dfddXRVNcJXCIwiUSSKfGsItgWoquppjkd8HVlEQWzsZE6qxmjiswghaVpZTYxzCdq5++6RHoj1tgkavsM77hAlgLW8y4DO+NT+OuyRdP8LLhGOAF53imTiEyEiHN2w2hESqvELG1oTSL0ijwRrYySIcMT7WA2AheTgPUkDoCdWSCEDqhKlDe3u8T8JZBDWODAAMvC8MDIUrzkyALLwnCCS4+V1YXZkvyHqhUCCinydd0TovvUKCSSf3eBF4mOdANJXaPS2iZzTXCSz22WXSG6zufItyChGh5KIASc5SOihawPA/8AWUUJOe4ihlEZjvZqQMeURMAAGHrdBghn/RgTp3GzoakakJzXLydMmC+9pPCtFmx5dJE4MO8RE0nzEuzrPi+FJ11miqJGqqs2MWgglH/exkGmniJIGe8M/495blZGe5vCvlgtErlFlLGSGuYGHY4gHaKXVAN8JItfYfxiIMv4YkXxoLJBKmwGJR4lc/at1rViPJMcSqSErVaWUdgOryZnZuN00kkJPHQqaWouL259EHPQdJnNNKKWROMZ7nVC4BkzcSSKYwpq6tD+atidmOWCNSbiDQmJSGOkt98K/Dy0m/00hscnMDEZFyIApf1GIR2Hn0CszhQyYWkwh/gSbLLpqAG59fI5p2ylk0V67PB330hr296GV/JJChnHeV0aFZ4Byl0IWl1lTMhWuATO2UYjPx8mmU/gGzNzqGtGNMFKI3OPiKvTjkqx4nkJXvGwT5ih0E/4qnVFwWPGp1PvFGvSwIjZAam2XfItZgh4ghYb6z/1DSKGH+iRPRF9aFZUUIvD6be/n/HuZtaXjbz2S+lHUEFBYE4nAByo1d0rURM6TZ2+mESWR2qBzNrnLrdHN6w11vWwPkdzZNLXwT90/BuSnXURyZxPuOZtYSFpdJ2tyR0uHonvMpQP0ekUUlYfKG8YiaJAnsZ5cBM39Q//fl1nOBVoMex+mTr68JCLIK2NnMC+xu4ptn9pHfrlxC8g8XK3YAe5DvzahEOj32LWx4DfTAQuSnXbJpdEYMu9EWkf3VcXuvqmoC381HyIKZKzqRGPhBsshanuwe5ULoyB9vQgCq3EbcVQslh4R2+h0s2Ub8FLfBehKHqLedGRkjP6FOsxoSWu2qA6M7Lcy2+gAPyTJ135B8Gf6BLNPrMVNcv1FVZdY2xUHAUh+J/WRZvEa5jm7qx1eKz6OLThDVwcX0YaYMvvPbm3RMH233WnOc++S23CVSwQKi+0/IXArN9jPe8Y2QRHGsypcGNFi3caVvzNO9b/xY90+xjk5BKDHiPQneMB0cJL/+0cHhT61iPeF+X1u98b6jfNKoahkxfPgLbW8kp9JFnERUSSKRJH/CfIJY3BkdLZ23K0AAAAASUVORK5CYII=",Sg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAapQTFRFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/v7+/v7+AAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAA+Pj4AAAAAAAA+fn5////AAAAAAAAAAAAAAAAAAAA/Pz8AAAAAAAAAAAAAAAAAAAAAAAA+Pj4AAAA////AAAA9fX19PT0+/v7AAAA+fn5/v7+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAE+ClvgAAAI50Uk5TABZHbpW80t3u+bttRhUKT5H+/9GQTgkCPJnxok0DCGreaQd05nLf41Qgs7EeUFYTx8QSGtYdKOLhJxvg5B/VxZRS8O+ysHVw5f/+Z//cAUE+nptL+IzP+P79FOxEa/SS7bnT6/j55/Lo+/328vfzzkqdmkA922ZzSa5MUY7CBg/Q1CYZEQSIVW8zjUWTutnbD5QAAARSSURBVHic7dlpSBRRHADw918tz1axVjNTyQ+S6WIWnVKoWUInHWAKRRcERUX0oYMo6EA6iOpDQQcihV0UJYREQUREJ5UZlgVR2U1JnpWV02y17s6b/7t2pijY/wdx33s7v5l99xsgfyEgiASRIPK/IeANomlaaEcYQIu9iBOgPYouqjl08Z1NSIJ+rc+MvHA9r8E6kgLQzC3Q1geeWEOcLmgU3QaJg7f8++AjfSPfCwlPuOBhoEgGvJEiPJEI9wNC3I8jpQ29CfS6p46kNToUCE+ERbAaAAvJhueKBiGpcFsJGVwbrWzoTw83FZCh8DgAg5B0uCqNjIQHARmEDIDLkkh2N1EXZkdWK1IvCJLmVK9zX7gbzHeIIHnsBi8TnR8lkP5Sozcnsi8KkYzEuxaRnA668k1IIaNDKcTg8wLE/dKyQUjkCy7idAfaQwxXaTfWK4WMu2WDQciQcxwkLf2GLUhch6GrGZFU8SpnmL4kui4sNeIsE0mI4M/Vegz3zDKd10TFcqGKhUzBRjezIaOMPs1Cpl6SMySUvFMMJD5L0NmH+2ZkkRL+za8V+yMxIdKGWMk/iSOx/KVDgXGtKlDGnMCR7tx5vYBeD/OVwuMoArG8ld7Ytt//RJNWGaUIKjHEEcv5TtdzRIe8cUkp4w9jSEiMlFFNcqSUCYcwJNQpNuK+V+t/pZRJFRgSGc4q31UfcY5fo8Xkz14lip6gumJKOYbMO40U9QT1HJ7wPQtTgQ8YksuYrxBDRnE+xZA5VeaSLENCmXoQQyIiFAxdSfJu9HBl2gFphGkIFRzBfi6OIVLwnwupeK4hUPCKNzdhgcFX8CZs6ozTX3sNB97w9F7Z6VUST1JZeGekV/Mz4KXI8FOS4LgxBx9WosKMpYobxIafknzMmIEPkNHdjaVmPpcwfErKUWM6PtT3CKUmrZJnEoZXST1iTC2qq8EQ0lMzliv9eYBWSUSBlpu1y/e/P9KrU3g9+WAtJFzfbURm78QR4eJOIQbeZyzuyPIKumzAMWeH3wcDsqKc2BXztrOQhI9RNhnz65lbB9KvySZkwVb/T39mO+f6ajj7oDr5yv22IE3GzkBvsXvLHZ/yI7fGeAREr7FX7bMByafmFtNCPvM1naIcC8uoBBOSlXDHotHupk8izVuSNXutvVPRFm2mk5ALCnZ1oli0yZSEHQ8m11owFsMGGYSsh90BG8vOyB10WjmydXXD3gvglTxCexSQkT5+HZbMaEkbd2p4BjeyPqkcoxMyqId67S8OW4tnMPvEZtim1l80bam5XQkQQmK+KL2kWbKamce721GN8uPYwgt4dQgRfYipFB7l/Yy2ifSaXgEh8TltdULCNXcP/xWCsHLTMhxXuAXmQzirwqURPbaUTcA3Wvoarj6/WbQgl33BnDIk41HIOSqxKD7p1SmpVy3yfaE05142tJSVHCPFR1Y/y6zRamvEX1JFLEQQCSJB5B9BfgCwNDJ0if9eSgAAAABJRU5ErkJggg==";class Mg extends jc{offsetY=0;setY=0;_last=0;_lastTop=!1;constructor(e){super(e,0,0,0,0),this.scale.cb=()=>{this.refresh()}}cropBottom(e,t=!1){this._last==e&&!this._lastTop&&!t||(this._last=e,this._lastTop=!1,this._height=this.texture.height-e/Math.abs(this.scale.y),this._bottomHeight=0,this.offsetY=0,this.topHeight=this.texture.height-e/Math.abs(this.scale.y),this._updateY())}cropTop(e,t=!1){this._last==e&&this._lastTop&&!t||(this._last=e,this._lastTop=!0,this._height=this.texture.height-e/Math.abs(this.scale.y),this._topHeight=0,this.bottomHeight=this.texture.height-e/Math.abs(this.scale.y),this.offsetY=e/Math.abs(this.scale.y),this._updateY())}get y(){return this.setY}set y(e){this.setY=e,this._updateY()}_updateY(){super.y=this.setY+this.offsetY*Math.abs(this.scale.y)}refresh(){this._lastTop?this.cropTop(this._last,!0):this.cropBottom(this._last,!0)}}class od extends Mg{constructor(e,t=64){super(e),this.scale.set(t/this.texture.width),this.pivot.x=t/2/this.scale.x,this.texture.on("update",()=>{this.width=this.texture.width,this.height=this.texture.height,this.scale.set(t/this.texture.width),this.pivot.x=t/2/this.scale.x,this.refresh()})}}class Jg extends od{_playing=!1;_autoUpdate=!1;_isConnectedToTicker=!1;_tickerUpdate=this.update.bind(this);_currentTime=0;_textures;_previousFrame=null;onComplete=null;onLoop=null;onFrameChange=null;animationSpeed=1;loop=!1;updateAnchor=!1;constructor(e,t){super(e[0],t),this.textures=e}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(xt.shared.remove(this._tickerUpdate),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(xt.shared.add(this._tickerUpdate,this,qc.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(e){this.stop(),this.currentFrame=e}gotoAndPlay(e){this.currentFrame=e,this.play()}update(e){if(!this._playing)return;const t=this.animationSpeed*e,n=this.currentFrame;this._currentTime+=t,this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete?.()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete?.()):n!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<n||this.animationSpeed<0&&this.currentFrame>n)&&this.onLoop(),this.updateTexture())}updateTexture(){const e=this.currentFrame;this._previousFrame!==e&&(this._previousFrame=e,this.texture=this._textures[e],this.onFrameChange?.(this.currentFrame))}destroy(e){this.stop(),super.destroy(e),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}get totalFrames(){return this._textures?.length??0}get textures(){return this._textures??[]}set textures(e){this._textures=e,this._previousFrame=null,this.gotoAndStop(0),this.updateTexture()}get currentFrame(){let e=Math.floor(this._currentTime)%this._textures.length;return e<0&&(e+=this._textures.length),e}set currentFrame(e){if(e<0||e>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${e}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const t=this.currentFrame;this._currentTime=e,t!==this.currentFrame&&this.updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(xt.shared.remove(this._tickerUpdate),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(xt.shared.add(this._tickerUpdate),this._isConnectedToTicker=!0))}}const Lg={Fake:xe.from(Tg),Lift:xe.from(Sg)};class Fc extends he{object;icon;constructor(e){super(),this.object=e,this.icon=new ye(Lg[e.note.type]),this.icon.anchor.set(.5),this.icon.scale.set(.3),this.icon.alpha=.8,this.icon.visible=!1,this.addChild(e,this.icon),e.nf.noteskin===void 0?ee.on("noteskinLoaded",()=>this.loadEventHandler()):this.loadEventHandler()}loadEventHandler(){this.object.nf.noteskin.onUpdate(this,e=>{if(!b.chart.drawIcons){this.icon.visible=!1;return}if(this.object.nf.noteskinOptions?.hideIcons?.includes(this.object.note.type)){this.icon.visible=!1;return}this.icon.visible=!0,this.object.note.type=="Fake"&&(this.icon.visible=e.chartManager.getMode()!=U.Play)})}}class Dg extends he{type="note";note;nf;constructor(e,t){super(),this.note=t,this.nf=e,this.on("destroyed",()=>{this.removeAllListeners()}),this.nf.noteskin===void 0?ee.on("noteskinLoaded",()=>{this.loadElement(t)}):this.loadElement(t)}loadElement(e){const t=this.nf.noteskin.getElement({element:e.type,columnName:this.nf.getColumnName(e.col),columnNumber:e.col},{note:e});this.addChild(t)}}function Bg(i){return i.cropTop!==void 0}class Fg extends he{type="hold";note;active;inactive;wasActive=!1;lastLength=null;elements;metrics;ns;nf;loaded=!1;constructor(e,t){super();const n=new he,r=new he;this.note=t,this.ns=e.noteskin,this.nf=e,this.metrics=this.ns.metrics,n.visible=!1,this.active=n,this.inactive=r,this.addChild(r,n),e.noteskin===void 0?ee.on("noteskinLoaded",()=>{this.loadElements()}):this.loadElements()}loadElements(){if(!this.loaded){this.elements={};for(const e of["Active","Inactive"]){this.elements[e]={};for(const t of["BottomCap","Body","TopCap","Head"]){const n=this.getNoteskinElement(`${e} ${t}`);t=="BottomCap"?Bg(n)?this.elements[e][t]=n:(b.debug.showNoteskinErrors&&ue.createFormatted(`Noteskin Error: invalid tail found for ${e} ${t}!`,"error"),this.elements[e][t]=new od(sd,64)):this.elements[e][t]=n,(e=="Active"?this.active:this.inactive).addChild(this.elements[e][t])}}this.loaded=!0}}getNoteskinElement(e){return this.ns.getElement({element:`${this.note.type} ${e}`,columnName:this.nf.getColumnName(this.note.col),columnNumber:this.note.col},{note:this.note})}setActive(e){this.wasActive!=e&&(this.wasActive=e,this.active.visible=e,this.inactive.visible=!e)}setBrightness(e){if(!this.loaded)return;const t=["Active","Inactive"],n=["Body","TopCap","BottomCap"];for(const r of t)for(const a of n)"tint"in this.elements[r][a]&&(this.elements[r][a].tint=go(e*255,e*255,e*255))}setLength(e){if(!this.loaded||this.lastLength==e)return;this.lastLength=e;const t=this.metrics[`${this.note.type}BodyBottomOffset`],n=this.metrics[`${this.note.type}BodyTopOffset`],r=["Active","Inactive"],a=e>=0?1:-1,s=Math.abs(e);for(const o of r){this.elements[o].Body.height=Math.max(0,s+t-n),this.elements[o].Body.y=s+t,this.elements[o].BottomCap.y=s+t,this.elements[o].BottomCap.y<0?(this.elements[o].BottomCap.cropTop(-this.elements[o].BottomCap.y),e<0&&(this.elements[o].BottomCap.y-=this.elements[o].BottomCap.y/Math.abs(this.elements[o].BottomCap.scale.y))):this.elements[o].BottomCap.cropTop(0),this.elements[o].TopCap.y=n;const l=Math.abs(this.elements[o].BottomCap.scale.y);this.elements[o].BottomCap.scale.y=e<0?-l:l;const u=Math.abs(this.elements[o].TopCap.scale.y);this.elements[o].TopCap.scale.y=e<0?-u:u,this.elements[o].Body.height*=a,this.elements[o].Body.y*=a,this.elements[o].BottomCap.y*=a,this.elements[o].TopCap.y*=a}}}class Ic extends he{isEditGUI=!1;noteskinOptions;noteskin;gameType;renderer;receptors;notes;selectionNotes;flashes;holdJudges;ghostNote;ghostNoteEntry;columnX=[];constructor(e){super(),this.renderer=e,this.gameType=e.chart.gameType,nt.getNoteskin(this.gameType,b.chart.noteskin.name).then(t=>{if(!t){ue.createFormatted("Couldn't find an available noteskin!","error");return}let n=0;for(let r=0;r<this.gameType.numCols;r++){const a=this.gameType.columnWidths[r];this.columnX.push(n-this.gameType.notefieldWidth/2+a/2),n+=a}this.noteskinOptions=t,this.noteskin=new xg(this.renderer,t),this.receptors=new Ag(this),this.flashes=new _g(this),this.notes=new Cg(this),this.selectionNotes=new kg(this),this.holdJudges=new Zi(this),this.addChild(this.receptors,this.notes,this.selectionNotes,this.flashes,this.holdJudges),ee.emit("noteskinLoaded")})}setGhostNote(e){this.ghostNote?.destroy(),this.ghostNote=void 0,this.ghostNoteEntry=e,e&&(this.ghostNote=this.createNote(e),this.addChildAt(this.ghostNote,1),this.ghostNote.alpha=.4,this.ghostNote.x=this.getColumnX(e.col),this.ghostNote.y=this.renderer.getYPosFromBeat(e.beat))}getElement(e,t={}){return this.noteskin.getElement(e,t)}update(e,t){this.noteskin!==void 0&&(this.noteskin.update(this.renderer),this.receptors.update(),this.flashes.update(),this.notes.update(e,t),this.selectionNotes.update(e,t),this.holdJudges.update(),this.ghostNote&&(this.ghostNote.y=this.renderer.getYPosFromBeat(this.ghostNoteEntry.beat),this.ghostNote.visible=b.chart.mousePlacement&&this.renderer.chartManager.getMode()==U.Edit&&this.renderer.chartManager.editTimingMode==Te.Off&&this.ghostNoteEntry.beat>=e&&this.ghostNoteEntry.beat<=t&&this.ghostNoteEntry.beat>=0))}onJudgement(e,t){this.noteskin!==void 0&&(this.renderer.chartManager.getMode()==U.Play&&this.holdJudges.addJudge(e,t),xi(t)&&this.noteskin.broadcast({type:"hit",judgement:t,columnName:this.getColumnName(e),columnNumber:e}),yn(t)&&this.noteskin.broadcast({type:"held",columnName:this.getColumnName(e),columnNumber:e}),Xn(t)&&this.noteskin.broadcast({type:"letgo",columnName:this.getColumnName(e),columnNumber:e}),mi(t)&&this.noteskin.broadcast({type:"miss",judgement:t,columnName:this.getColumnName(e),columnNumber:e}),eo(t)&&this.noteskin.broadcast({type:"hitmine",columnName:this.getColumnName(e),columnNumber:e}))}startPlay(){}endPlay(){if(this.noteskin!==void 0)for(let e=0;e<this.gameType.numCols;e++)this.noteskin.broadcast({type:"holdoff",columnName:this.getColumnName(e),columnNumber:e}),this.noteskin.broadcast({type:"rolloff",columnName:this.getColumnName(e),columnNumber:e}),this.noteskin.broadcast({type:"lift",columnName:this.getColumnName(e),columnNumber:e})}press(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"press",columnName:this.getColumnName(e),columnNumber:e})}lift(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"lift",columnName:this.getColumnName(e),columnNumber:e})}ghostTap(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"ghosttap",columnName:this.getColumnName(e),columnNumber:e})}activateHold(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"holdon",columnName:this.getColumnName(e),columnNumber:e})}releaseHold(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"holdoff",columnName:this.getColumnName(e),columnNumber:e})}activateRoll(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"rollon",columnName:this.getColumnName(e),columnNumber:e})}releaseRoll(e){this.noteskin!==void 0&&this.noteskin.broadcast({type:"rolloff",columnName:this.getColumnName(e),columnNumber:e})}getColumnX(e){return this.columnX[e]??0}getColumnWidth(e){return this.gameType.columnWidths[e]}getColumnName(e){return this.gameType.columnNames[e]}createNote(e){return Oe(e)?new Fc(new Fg(this,e)):new Fc(new Dg(this,e))}}class Ig extends ge{isEditGUI=!1;renderer;constructor(e){super("",{fontName:"Fancy"}),this.anchor.set(.5),this.renderer=e}update(){this.y=b.chart.reverse?-50:50;const e=this.renderer.chartManager.gameStats;if(this.visible=this.renderer.chartManager.getMode()==U.Play,!e)return;const t=e.getCombo()==0?e.getMissCombo():e.getCombo();t<4?this.text="":this.text=t+"",e.getCombo()==0?this.tint=kt.getCollection(b.play.timingCollection).getMissJudgement().color:e.getBestJudge()?this.tint=bo(e.getBestJudge().color,Math.sin(Date.now()/225)*.2+1.2):this.tint=16777215}}const Pg=1,Pc=15,Rg={fontName:"Fancy",fontSize:12};class Og extends he{isEditGUI=!1;barlines=new he;barline;currentMedian;errorText=new ge("",Rg);errorTextTime=-1;renderer;target=0;constructor(e){super(),this.renderer=e,this.barline=new ye(xe.WHITE),this.barline.anchor.set(.5),this.barline.height=1,this.barline.alpha=.5,Ue(this.barline,"text-color");const t=new ye(xe.WHITE);t.width=2,t.height=Pc,t.anchor.set(.5),Ue(t,"text-color"),this.currentMedian=new Hi,this.currentMedian.beginFill(16777215),this.currentMedian.moveTo(0,-10),this.currentMedian.lineTo(5,-15),this.currentMedian.lineTo(-5,-15),this.currentMedian.lineTo(0,-10),Ue(this.currentMedian,"text-color"),this.errorText.y=-25,this.errorText.anchor.set(.5),this.addChild(this.barline,t,this.barlines,this.currentMedian,this.errorText)}update(){this.y=b.chart.reverse?-10:10,this.errorText.y=b.chart.reverse?25:-25,this.visible=this.renderer.chartManager.getMode()==U.Play;for(const e of this.barlines.children){const t=(Date.now()-e.createTime)/5e3;t<.05?e.alpha=1:t<.3?e.alpha=Qe(1,.2,(t-.05)/.25):t<.9?e.alpha=.2:e.alpha=(1-t)*3}this.errorText.alpha=Se((2e3-(Date.now()-this.errorTextTime))/1e3,0,1),this.barline.width=kt.getCollection(b.play.timingCollection).maxWindowMS()/1e3*2*400,Zt(this.barlines.children,e=>Date.now()-e.createTime>5e3),b.general.smoothAnimations?this.currentMedian.x=(this.currentMedian.x-this.target)*.8+this.target:this.currentMedian.x=this.target}addBar(e,t){if(e==null||!mi(t)&&!xi(t))return;const n=new ye(xe.WHITE);n.width=Pg,n.height=Pc,n.anchor.set(.5),n.x=e*400,n.tint=t.color,n.createTime=Date.now(),n.miss=mi(t),n.ms=Math.round(e*1e3),this.errorText.tint=t.color,this.errorText.text=(e*1e3).toFixed(1)+"ms",this.errorTextTime=Date.now(),this.barlines.addChild(n),this.target=jr(this.barlines.children.filter(r=>!r.miss).map(r=>r.ms))*.4}reset(){this.currentMedian.x=0,this.target=0,Zt(this.barlines.children,()=>!0)}}class Ng extends ye{isEditGUI=!1;createTime=-1;active=!1;type=Js;constructor(){super(),this.anchor.set(.5)}update(){if(this.y=b.chart.reverse?40:-40,this.visible=this.active,this.active){const e=(Date.now()-this.createTime)/1e3;let t=1.2;if(kt.getCollection(b.play.timingCollection).shouldHideNote(this.type)||(t=.8),e<.1){const n=1-(1-e/.1)*(1-e/.1),r=(1-t)*n+t;this.scale.x=.4*r,this.scale.y=.4*r}else if(e>.6&&e<.8){const n=(e-.6)/.2*(e-.6)/.2;this.scale.x=.4*(1-n),this.scale.y=.4*(1-n)}else e>.8&&(this.active=!1)}}async doJudge(e,t){if(e==null&&(e=0),!xi(t)&&!mi(t))return;const n=await t.judgementTexture.getTexture(e,t);n&&(this.texture=n,this.texture.updateUvs(),this.active=!0,this.type=t,this.createTime=Date.now(),b.play.judgementTilt?this.rotation=Se(e,-.05,.05)*300/180*Math.PI:this.rotation=0)}reset(){this.active=!1}}class wi extends Ui{static options;static convertText;static convertBtnOne;static convertBtnTwo;static onTimingChange=this.updateValues.bind(this);onConfirm=()=>{};persistent=!1;static open(e){super._open({...e,title:"Column",description:"",width:255,editable:!0,cancelableOnOpen:!1}),ee.on("timingModified",this.onTimingChange),this.updateValues()}static buildContent(){const e=document.createElement("div");e.style.display="flex",e.style.gap="0.25rem",e.style.alignItems="center",e.style.flexDirection="column",e.style.marginTop="0.6rem",e.style.fontSize="0.75rem";const t=document.createElement("div"),n=document.createElement("button"),r=document.createElement("button");this.convertBtnOne=n,this.convertBtnTwo=r,this.convertText=t,e.replaceChildren(t,n,r),this.view.appendChild(e)}static close(){!this.popup||!this.active||(super.close(),ee.off("timingModified",this.onTimingChange))}static updateValues(){const e=this.options.timingData.isPropertyChartSpecific(this.options.type),t=e?"chart":"song";this.title.innerText=Ye[t].title,this.desc.innerText=Ye[t].desc,this.convertText.innerText=Ye[t].convertText,this.convertBtnOne.innerText=Ye[t].buttonOne.text,this.convertBtnTwo.innerText=Ye[t].buttonTwo.text,this.convertBtnTwo.classList.toggle("delete",e),Ze(this.convertBtnOne,{content:Ye[t].buttonOne.tooltip}),Ze(this.convertBtnTwo,{content:Ye[t].buttonTwo.tooltip}),this.convertBtnOne.onclick=()=>{Ye[t].buttonOne.action(this.options.timingData,this.options.type),this.close()},this.convertBtnTwo.onclick=()=>{Ye[t].buttonTwo.action(this.options.timingData,this.options.type),this.close()}}}const Cr={BPMS:{title:"BPM Event",rows:[{label:"Tempo",key:"value",input:{type:"spinner"}}]},STOPS:{title:"Stop Event",description:"Stops for a number of seconds. Notes on this beat are hit before the stop occurs.",rows:[{label:"Seconds",key:"value",input:{type:"spinner"}}]},WARPS:{title:"Warp Event",description:"Warps ahead a number of beats. Warped notes do not count towards score.",rows:[{label:"Beats",key:"value",input:{type:"spinner",min:0,step:1/48}}]},DELAYS:{title:"Delay Event",description:"Stops for a number of seconds. Notes on this beat are hit after the delay occurs.",rows:[{label:"Seconds",key:"value",input:{type:"spinner"}}]},SCROLLS:{title:"Scroll Event",description:"Notes after this event will scroll at the specified speed.",rows:[{label:"Multiplier",key:"value",input:{type:"spinner"}}]},TICKCOUNTS:{title:"Tickcount Event",description:"Number of ticks per beat in a hold. Only applies to pump gamemodes.",rows:[{label:"Ticks",key:"value",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:0}}]},FAKES:{title:"Fake Event",description:"Creates an area of notes that cannot be hit and do not count towards score.",rows:[{label:"Beats",key:"value",input:{type:"spinner",min:0,step:1/48}}]},LABELS:{title:"Label Event",rows:[{label:"Label",key:"value",input:{type:"text"}}]},SPEEDS:{title:"Speed Event",width:200,description:"The entire playfield scrolls at the specified speed. Can slowly ease over a certain amount of time.",rows:[{label:"Multiplier",key:"value",input:{type:"spinner"}},{label:"Ease time",key:"delay",input:{type:"spinner",min:0}},{label:"Ease unit",key:"unit",input:{type:"dropdown",items:["Beats","Seconds"],transformers:{serialize:i=>i=="B"?"Beats":"Seconds",deserialize:i=>i=="Beats"?"B":"T"}}}]},TIMESIGNATURES:{title:"Time Signature Event",width:200,rows:[{label:"Upper",key:"upper",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:1}},{label:"Lower",key:"lower",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:1}}]},COMBOS:{title:"Combo Event",width:200,description:"Multiplies the combo gained from hitting/missing notes after this event.",rows:[{label:"Hit multiplier",key:"hitMult",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:0}},{label:"Miss multiplier",key:"missMult",input:{type:"spinner",step:1,precision:0,minPrecision:null,min:0}}]},ATTACKS:{title:"Attack Event",width:200,description:"Applies a modifier to the playfield. Can specify the length of the applied attack in seconds or the end time of the attack.",rows:[{label:"Timing type",key:"endType",input:{type:"dropdown",items:["Length","End"],transformers:{serialize:i=>i=="LEN"?"Length":"End",deserialize:i=>i=="Length"?"LEN":"END"}}},{label:"Seconds",key:"value",input:{type:"spinner"}},{label:"Mods",key:"mods",input:{type:"text"}}]},BGCHANGES:{title:"BG Change Event",width:250,rows:[{label:"File",key:"file",input:{type:"text"}},{label:"Update rate",key:"updateRate",input:{type:"spinner",precision:3,min:0}},{label:"Crossfade",key:"crossfade",input:{type:"checkbox"}},{label:"StretchRewind",key:"stretchRewind",input:{type:"checkbox"}},{label:"StretchNoLoop",key:"StretchNoLoop",input:{type:"checkbox"}},{label:"Effect",key:"effect",input:{type:"text"}},{label:"File2",key:"file2",input:{type:"text"}},{label:"Transition",key:"transition",input:{type:"text"}},{label:"Color1",key:"color1",input:{type:"text"}},{label:"Color2",key:"color2",input:{type:"text"}}]},FGCHANGES:{title:"FG Change Event",width:250,rows:[{label:"File",key:"file",input:{type:"text"}},{label:"Update rate",key:"updateRate",input:{type:"spinner",precision:3,min:0}},{label:"Crossfade",key:"crossfade",input:{type:"checkbox"}},{label:"StretchRewind",key:"stretchRewind",input:{type:"checkbox"}},{label:"StretchNoLoop",key:"StretchNoLoop",input:{type:"checkbox"}},{label:"Effect",key:"effect",input:{type:"text"}},{label:"File2",key:"file2",input:{type:"text"}},{label:"Transition",key:"transition",input:{type:"text"}},{label:"Color1",key:"color1",input:{type:"text"}},{label:"Color2",key:"color2",input:{type:"text"}}]}};class Xe extends Ui{static options;static cachedEvent;static rows=[];static onTimingChange;static open(e){this.active||(super._open({...e,attach:e.box.backgroundObj,title:Cr[e.box.event.type].title,description:Cr[e.box.event.type].description,width:Cr[e.box.event.type].width??150,editable:!0,cancelableOnOpen:!1,background:En(Ei[e.box.event.type].toString(16).padStart(6,"0"),"#333333",.75),textColor:"#ffffff",options:[{label:"Ok",type:"confirm",callback:()=>{this.close(),this.options.onConfirm(this.cachedEvent)}},{label:"Delete",type:"delete",callback:()=>{this.options.modifyBox||this.options.timingData.delete([{type:this.cachedEvent.type,[this.cachedEvent.type=="ATTACKS"?"second":"beat"]:this.cachedEvent.type=="ATTACKS"?this.cachedEvent.second:this.cachedEvent.beat}]),this.close()}}]}),this.cachedEvent=structuredClone(e.box.event),this.onTimingChange=this.updateValues.bind(this),ee.on("timingModified",this.onTimingChange))}static buildContent(){const e=Cr[this.options.box.event.type],t=document.createElement("div");t.classList.add("popup-grid"),this.view.appendChild(t),e.rows.forEach(n=>t.append(...this.buildRow(n)))}static buildRow(e){const t=structuredClone(this.options.box.event),n=document.createElement("div");n.innerText=e.label,n.classList.add("popup-label");const r=[];switch(r.push(n),e.input.type){case"spinner":{const a=pt.create({value:t[e.key],precision:Vc,minPrecision:Si,...e.input});a.onchange=s=>{s!==void 0&&this.modifyEvent(e.key,s)},this.rows.push({data:e,el:a}),r.push(a.view);break}case"text":{const a=document.createElement("input");a.type="text",a.autocomplete="off",a.spellcheck=!1,a.onkeydown=s=>{s.key=="Enter"&&a.blur()},a.onblur=()=>{this.modifyEvent(e.key,a.value)},a.value=t[e.key],this.rows.push({data:e,el:a}),r.push(a);break}case"dropdown":{if(e.input.transformers){const a=e.input.transformers.deserialize,s=e.input.transformers.serialize,o=gi.create(e.input.items,s(t[e.key]));o.onChange(l=>{this.modifyEvent(e.key,a(l))}),this.rows.push({data:e,el:o}),r.push(o.view)}else{const a=gi.create(e.input.items,t[e.key]);a.onChange(s=>{this.modifyEvent(e.key,s)}),this.rows.push({data:e,el:a}),r.push(a.view)}break}case"checkbox":{const a=document.createElement("input");a.type="checkbox",a.checked=t[e.key],a.onchange=()=>{this.modifyEvent(e.key,a.checked)},this.rows.push({data:e,el:a}),r.push(a);break}}return r}static modifyEvent(e,t){this.options.modifyBox?Object.assign(this.options.box.event,{[e]:t}):this.options.timingData.modify([[structuredClone(this.options.box.event),Object.assign(this.options.box.event,{[e]:t})]]),this.cachedEvent=structuredClone(this.options.box.event)}static updateValues(){const e=this.options.timingData.getEventAtBeat(this.options.box.event.type,this.options.box.event.beat,!1);if(!this.options.box||!e||e.beat!=this.options.box.event.beat){this.close();return}this.rows.forEach(t=>{switch(t.data.input.type){case"spinner":{t.el.value=e[t.data.key];break}case"text":{t.el.value=e[t.data.key];break}case"dropdown":{const n=t.el;t.data.input.transformers?n.setSelected(t.data.input.transformers.serialize(e[t.data.key])):n.setSelected(e[t.data.key]);break}case"checkbox":{t.el.checked=e[t.data.key];break}}})}static close(){this.active&&(super.close(),ee.off("timingModified",this.onTimingChange))}static getEvent(){return this.cachedEvent}static attach(e){super.attach(e.backgroundObj),this.options.box=e,this.cachedEvent=e.event}}const Fr={fontName:"Main",fontSize:15},qt={BPMS:55,STOPS:55,DELAYS:55,WARPS:55,FAKES:55,COMBOS:40,SPEEDS:80,LABELS:80,SCROLLS:55,TIMESIGNATURES:40,TICKCOUNTS:40,BGCHANGES:55,FGCHANGES:55,ATTACKS:55};class Hg extends he{isEditGUI=!0;tracks=new he;renderer;timingBoxMap=new Map;wasEditingTiming=!1;boxPool=new Ht({create:()=>{const e=new he;return e.textObj=new ge("",Fr),e.backgroundObj=new dt,e.selection=new dt("onlyBorder"),e.selection.tint=3841008,e.addChild(e.backgroundObj,e.textObj,e.selection),e}});ghostBox;timingDirty=!1;tracksDirty=!0;constructor(e){super(),this.renderer=e,this.boxPool.sortableChildren=!0,this.sortableChildren=!0,this.addChild(this.tracks,this.boxPool);const t=()=>{this.timingDirty=!0,this.tracksDirty=!0},n=r=>{r.startsWith("chart.timingEventOrder")&&(this.tracksDirty=!0)};ee.on("timingModified",t),ee.on("userOptionUpdated",n),this.on("destroyed",()=>{ee.off("timingModified",t),ee.off("userOptionUpdated",n)})}update(e,t){this.renderer.chartManager.editTimingMode!=Te.Add&&(this.ghostBox?.removeFromParent(),this.ghostBox?.destroy(),this.ghostBox=void 0);const n=this.wasEditingTiming!=(this.renderer.chartManager.editTimingMode!=Te.Off&&this.renderer.chartManager.getMode()==U.Edit);this.updateTracks(),this.updateBoxes(e,t,n)}createTrack(e,t){const n=Object.assign(new he,{alpha:0,name:e,x:t,type:e,timingMode:"song",background:new ye(xe.WHITE),btns:new he});n.background=new ye(xe.WHITE),n.background.width=qt[e],n.background.height=5e3,n.background.tint=2503250,n.background.anchor.y=.5,n.background.alpha=0,n.btns.y=this.renderer.getActualReceptorYPos()+(b.chart.reverse?50:-50);const r=new he,a=new dt,s=new ge(e,Fr);return a.width=20,a.height=20,Ue(a,"widget-bg"),a.pivot.set(10,10),s.anchor.set(.5,.55),s.text="S",Ue(s,"text-color"),r.alpha=.4,r.name="timingTypeBtn",r.eventMode="static",r.on("mouseenter",()=>{wi.persistent||wi.open({attach:r,type:e,timingData:this.renderer.chart.timingData})}),r.on("mouseleave",()=>{wi.persistent||wi.close()}),r.on("pointerdown",()=>{wi.persistent&&wi.open({attach:r,type:e,timingData:this.renderer.chart.timingData}),wi.select()}),r.addChild(a,s),n.btns.addChild(r),n.addChild(n.background,n.btns),this.tracks.addChild(n),n}initializeBox(e,t){if(lt.stop(e.animationId),Object.assign(e,{event:t,lastX:void 0,lastAnchor:void 0,animationId:void 0,zIndex:t.beat,eventMode:"static"}),e.textObj.text=this.getLabelFromEvent(t),e.textObj.anchor.set(.5,.55),e.backgroundObj.width=e.textObj.width+10,e.backgroundObj.height=25,e.backgroundObj.position.x=-e.backgroundObj.width/2,e.backgroundObj.position.y=-25/2,e.selection.width=e.textObj.width+10,e.selection.height=25,e.selection.position=e.backgroundObj.position,Xe.active){const n=Xe.getEvent();n.type=="ATTACKS"&&t.type=="ATTACKS"&&n.second==t.second&&Xe.attach(e),n.type!="ATTACKS"&&t.type!="ATTACKS"&&n.type==t.type&&n.beat==t.beat&&Xe.attach(e)}}addDragListeners(e,t){e.cursor="pointer",e.on("mouseenter",()=>{Xe.persistent||this.renderer.chartManager.eventSelection.timingEvents.length>0||this.renderer.isDragSelecting()||(Xe.active&&Xe.close(),this.renderer.chartManager.getMode()==U.Edit&&Xe.open({box:e,timingData:this.getTargetTimingData(e.event),modifyBox:!1,onConfirm:()=>{this.renderer.chartManager.removeEventFromSelection(t)}}))}),e.on("mouseleave",()=>{Xe.persistent||Xe.close()});let n=0,r;const a=s=>{const o=r,l=this.toLocal(s.global);if(Math.abs(l.y-n)<32){this.renderer.chartManager.eventSelection.shift&&(this.renderer.chartManager.eventSelection.shift={beatShift:0});return}Xe.close();const u=this.renderer.getBeatFromYPos(l.y),f=b.chart.snap==0?1/48:b.chart.snap;let c=Math.round(u/f)*f;Math.abs(c-u)>Math.abs(u-o.beat)&&(c=o.beat),this.renderer.chartManager.eventSelection.shift||={beatShift:0},this.renderer.chartManager.eventSelection.shift.beatShift=Math.max(-Math.min(...this.renderer.chartManager.eventSelection.timingEvents.map(d=>d.beat)),c-o.beat)};e.on("pointerdown",s=>{if(qr(s)){this.renderer.chartManager.clearSelections(),this.renderer.chartManager.addEventToSelection(t),Xe.close();return}if(s.stopImmediatePropagation(),this.renderer.chartManager.isEventInSelection(t)?(s.getModifierState("Control")||s.getModifierState("Meta"))&&this.renderer.chartManager.removeEventFromSelection(t):(!s.getModifierState("Control")&&!s.getModifierState("Meta")&&!s.getModifierState("Shift")&&this.renderer.chartManager.clearSelections(),this.renderer.chartManager.addEventToSelection(t)),this.renderer.chartManager.getMode()==U.Edit&&this.renderer.chartManager.eventSelection.timingEvents.length==1&&Xe.options?.box!=e&&(Xe.close(),Xe.open({box:e,timingData:this.getTargetTimingData(e.event),modifyBox:!1,onConfirm:()=>{this.renderer.chartManager.removeEventFromSelection(t)}})),Xe.active&&!s.getModifierState("Control")&&!s.getModifierState("Meta")&&!s.getModifierState("Shift")?Xe.select():Xe.close(),n=e.y,r=t,this.renderer.chartManager.editTimingMode==Te.Add)return;this.renderer.on("pointermove",a);const o=()=>{this.renderer.off("pointermove",a),this.renderer.off("pointerup",o),(this.renderer.chartManager.eventSelection.shift?.beatShift??0)!=0&&this.renderer.chartManager.modifyEventSelection(l=>(l.type=="ATTACKS"&&(l.second=this.renderer.chart.timingData.getSecondsFromBeat(l.beat+this.renderer.chartManager.eventSelection.shift.beatShift)),l.beat+=this.renderer.chartManager.eventSelection.shift.beatShift,l)),this.renderer.chartManager.eventSelection.shift=void 0};this.renderer.on("pointerup",o)})}updateTracks(){const e=this.renderer.chartManager.editTimingMode!=Te.Off&&this.renderer.chartManager.getMode()==U.Edit;if(e&&this.tracks.children.forEach(s=>{s.btns.y=this.renderer.getActualReceptorYPos()+(b.chart.reverse?50:-50)}),!this.tracksDirty&&this.wasEditingTiming==e)return;this.wasEditingTiming=e,this.tracksDirty=!1;const t=b.chart.timingEventOrder.left,n=b.chart.timingEventOrder.right;this.tracks.children.forEach(s=>{s.visible=!1});let r=-this.renderer.chart.gameType.notefieldWidth*.5-128;const a=(s,o,l,u,f)=>{lt.animate(s,{0:{[o]:"inherit"},1:{[o]:l}},b.general.smoothAnimations?u:0,mt(0,0,.16,1.01),()=>{},f)};for(let s=t.length-1;s>=0;s--){const o=t[s],l=this.tracks.getChildByName(o)??this.createTrack(o,r);l.visible=!0;const u=s%2==0?.1:0;a(l,"x",r,.3,`track-${o}-x`),a(l.btns,"x",-qt[o]/2,.3,`track-${o}-btn-x`),a(l.background,"anchor.x",1,.3,`track-${o}-anchor-x`),a(l.background,"alpha",e?u:0,.3,`track-${o}-bg-alpha`),r-=qt[o]}r=this.renderer.chart.gameType.notefieldWidth*.5+128;for(let s=0;s<n.length;s++){const o=n[s],l=this.tracks.getChildByName(o)??this.createTrack(o,r);l.visible=!0;const u=s%2==0?.1:0;a(l,"x",r,.3,`track-${o}-x`),a(l.btns,"x",qt[o]/2,.3,`track-${o}-btn-x`),a(l.background,"anchor.x",0,.3,`track-${o}-anchor-x`),a(l.background,"alpha",e?u:0,.3,`track-${o}-bg-alpha`),r+=qt[o]}for(const s of this.tracks.children)a(s,"alpha",e?1:0,.3,`track-${s.type}-alpha`);e||wi.close(),this.tracks.children.forEach(s=>{const o=s.btns.getChildByName("timingTypeBtn"),l=o?.children[1];o&&(o.eventMode=e?"static":"none"),l&&(l.text=this.renderer.chart.timingData.isPropertyChartSpecific(s.type)?"C":"S")})}updateBoxes(e,t,n){this.timingDirty&&(this.timingBoxMap.clear(),this.boxPool.destroyAll(),this.timingDirty=!1);const r=this.renderer.chartManager.editTimingMode!=Te.Off&&this.renderer.chartManager.getMode()==U.Edit;this.ghostBox&&(this.ghostBox.visible=this.renderer.shouldDisplayEditGUI()&&r);for(const a of this.renderer.chart.timingData.getTimingData()){if(t<a.beat)break;if(!(!b.chart.timingEventOrder.left.includes(a.type)&&!b.chart.timingEventOrder.right.includes(a.type))&&!(e>a.beat)&&!this.timingBoxMap.has(a)){const s=this.boxPool.createChild(),o=b.chart.timingEventOrder.right.includes(a.type)?"right":"left";if(!s)break;if(this.initializeBox(s,a),this.addDragListeners(s,a),this.timingBoxMap.set(a,s),r){let l=this.tracks.getChildByName(a.type)?.x??s.x;l+=qt[a.type]/2*(l>0?1:-1),s.x=l,s.pivot.x=0}else{const l=o=="left"?-b.chart.timingEventOrder.left.indexOf(a.type):b.chart.timingEventOrder.right.indexOf(a.type);Xt.instance.register(s,a.beat,a.second,o,l,!1)}}}for(const[a,s]of this.timingBoxMap.entries()){if(a.beat<e||a.beat>t||!b.chart.timingEventOrder.left.includes(a.type)&&!b.chart.timingEventOrder.right.includes(a.type)){this.timingBoxMap.delete(a),Xe.options?.box==s?Xe.detach():Xe.persistent||Xe.close(),this.boxPool.destroyChild(s);continue}const o=b.chart.timingEventOrder.right.includes(a.type)?"right":"left",l=o=="left"?-b.chart.timingEventOrder.left.indexOf(a.type):b.chart.timingEventOrder.right.indexOf(a.type);if(Xt.instance.updatePriority(s,l),Xt.instance.updateAlign(s,o),n)if(r){Xt.instance.deregister(s);let f=this.tracks.getChildByName(a.type)?.x??s.x;f+=qt[a.type]/2*(f>0?1:-1),s.animationId=lt.animate(s,{0:{x:"inherit","pivot.x":"inherit"},1:{x:f,"pivot.x":0}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},s.animationId),s.lastX=f}else lt.stop(s.animationId),Xt.instance.register(s,a.beat,a.second,o,l,!0);if(r){s.y=b.chart.CMod?this.renderer.getYPosFromSecond(a.second):this.renderer.getYPosFromBeat(a.beat);let f=this.tracks.getChildByName(a.type)?.x??s.x;f+=qt[a.type]/2*(f>0?1:-1),s.lastX!=f&&(s.animationId=lt.animate(s,{0:{x:"inherit","pivot.x":"inherit"},1:{x:f,"pivot.x":0}},b.general.smoothAnimations?.3:0,mt(0,0,.16,1.01),()=>{},s.animationId),s.lastX=f)}const u=this.renderer.shouldDisplayEventSelection(a);if(s.backgroundObj.tint=u?bo(Ei[a.type]??0,Math.sin(Date.now()/320)*.4+1.5):Ei[a.type]??0,s.selection.alpha=u?1:0,s.visible=!u||!this.renderer.chartManager.eventSelection.shift,this.renderer.chartManager.editTimingMode!=Te.Off){const f=this.renderer.selectionTest(s);!u&&f&&this.renderer.chartManager.addEventToDragSelection(a),u&&!f&&this.renderer.chartManager.removeEventFromDragSelection(a)}}}updateGhostEvent(e){const t=b.chart.snap==0?.020833333333333332:b.chart.snap,n=Math.round(this.renderer.getBeatFromYPos(e.y)/t)*t,r=Xe.active&&Xe.options?.box==this.ghostBox,a=r?this.ghostBox.event.type:this.getClosestTrack(e.x)?.name;if(!a){this.ghostBox?.removeFromParent(),this.ghostBox?.destroy(),this.ghostBox=void 0;return}if(!this.ghostBox){const l=new he;l.textObj=new ge("",Fr),l.backgroundObj=new dt,l.selection=new dt("onlyBorder"),l.guideLine=new ye(xe.WHITE),l.selection.tint=3841008,l.selection.alpha=0,l.addChild(l.guideLine,l.backgroundObj,l.textObj,l.selection),this.addChild(l),l.visible=this.renderer.shouldDisplayEditGUI(),l.textObj.anchor.set(.5,.55),l.backgroundObj.height=25,l.selection.height=25,l.guideLine.height=1,l.guideLine.anchor.y=.5,this.ghostBox=l}!r&&(this.ghostBox.event?.beat!=n||this.ghostBox.event?.type!=a)&&(this.ghostBox.event=structuredClone(this.renderer.chart.timingData.getEventAtBeat(a,n))??this.renderer.chart.timingData.getDefaultEvent(a,n),this.ghostBox.event.beat=n,a=="ATTACKS"&&(this.ghostBox.event.second=this.renderer.chart.getSecondsFromBeat(n)),this.ghostBox.textObj.text=this.getLabelFromEvent(this.ghostBox.event),this.ghostBox.backgroundObj.width=this.ghostBox.textObj.width+10,this.ghostBox.selection.width=this.ghostBox.textObj.width+10),this.ghostBox.alpha=r?1:.4,this.ghostBox.selection.alpha=r?1:0,this.ghostBox.name=a;const s=this.renderer.getYPosFromBeat(r?this.ghostBox.event.beat:n);let o=this.tracks.getChildByName(a).x;o+=qt[a]/2*(o>0?1:-1),this.ghostBox.position.x=o,this.ghostBox.backgroundObj.tint=Ei[a]??0,this.ghostBox.backgroundObj.position.x=-this.ghostBox.backgroundObj.width/2,this.ghostBox.backgroundObj.position.y=-25/2,this.ghostBox.guideLine.anchor.x=o<0?0:1,this.ghostBox.guideLine.width=Math.abs(this.ghostBox.position.x)+192-this.ghostBox.backgroundObj.width/2,this.ghostBox.guideLine.position.x=(o<0?1:-1)*this.ghostBox.backgroundObj.width/2,this.ghostBox.y=s,this.ghostBox.selection.position=this.ghostBox.backgroundObj.position}placeGhostEvent(){if(!this.ghostBox)return;const e=this.renderer.chart.timingData.getEventAtBeat(this.ghostBox.event.type,this.ghostBox.event.beat,!1);this.ghostBox.event.type=="ATTACKS"&&this.ghostBox.event.second==e?.second||this.ghostBox.event.type!="ATTACKS"&&this.ghostBox.event.beat==e?.beat||(this.renderer.chartManager.clearSelections(),Xe.open({box:this.ghostBox,timingData:this.getTargetTimingData(this.ghostBox.event),modifyBox:!0,onConfirm:t=>{this.getTargetTimingData(this.ghostBox.event).insert([t])}}),Xe.select())}getClosestTrack(e){let t=Number.MAX_SAFE_INTEGER,n=this.tracks.children[0];for(const r of this.tracks.children){const a=Math.abs(r.x+(.5-r.background.anchor.x)*r.width-e);a<t&&(n=r,t=a)}if(!(t>n.width))return n}getLabelFromEvent(e){let t="";switch(e.type){case"BPMS":case"STOPS":case"WARPS":case"DELAYS":case"TICKCOUNTS":case"FAKES":case"SCROLLS":t=fe(e.value,Si).toString();break;case"SPEEDS":t=`${fe(e.value,Si)}/${fe(e.delay,Si)}/${e.unit}`;break;case"LABELS":t=e.value;break;case"TIMESIGNATURES":t=`${fe(e.upper,Si)}/${fe(e.lower,Si)}`;break;case"COMBOS":t=`${fe(e.hitMult,Si)}/${fe(e.missMult,3)}`;break;case"BGCHANGES":case"FGCHANGES":t=e.file;break;case"ATTACKS":t=`${e.mods}`}return t}getTargetTimingData(e){return this.renderer.chart.timingData.isPropertyChartSpecific(e.type)?this.renderer.chart.timingData:this.renderer.chart.timingData.songTimingData}}class zg extends he{isEditGUI=!0;children=[];renderer;timingBoxMap=new Map;trackPosCache=new Map;timingBoxPool=new Ht({create:()=>{const e=new he;return e.guideLine=new ye(xe.WHITE),e.textObj=new ge("",Fr),e.backgroundObj=new dt,e.addChild(e.guideLine,e.backgroundObj,e.textObj),e}});constructor(e){super(),this.renderer=e,this.timingBoxPool.sortableChildren=!0,this.addChild(this.timingBoxPool)}update(e,t){if(!this.renderer.chartManager.eventSelection.shift){this.timingBoxPool.destroyAll(),this.timingBoxMap.clear(),this.trackPosCache.clear();return}const n=this.renderer.chartManager.eventSelection.shift.beatShift;for(const r of this.renderer.chartManager.eventSelection.timingEvents)if(!(t<r.beat+n)&&!(e>r.beat+n)&&!this.timingBoxMap.has(r)){const a=this.timingBoxPool.createChild();if(!a)continue;this.timingBoxMap.set(r,a);let s="";switch(r.type){case"BPMS":case"STOPS":case"WARPS":case"DELAYS":case"TICKCOUNTS":case"FAKES":case"SCROLLS":s=fe(r.value,3).toString();break;case"SPEEDS":s=`${fe(r.value,3)}/${fe(r.delay,3)}/${r.unit}`;break;case"LABELS":s=r.value;break;case"TIMESIGNATURES":s=`${fe(r.upper,3)}/${fe(r.lower,3)}`;break;case"COMBOS":s=`${fe(r.hitMult,3)}/${fe(r.missMult,3)}`;break;case"BGCHANGES":case"FGCHANGES":s=r.file;break;case"ATTACKS":s=`${r.mods} (${r.endType}=${r.value})`}const o=b.chart.timingEventOrder.right.includes(r.type)?"right":"left";if(Object.assign(a,{alpha:.4,zIndex:r.beat}),a.textObj.text=s,a.textObj.anchor.set(.5,.55),a.backgroundObj.width=a.textObj.width+10,a.backgroundObj.height=25,a.backgroundObj.tint=Ei[r.type]??0,a.backgroundObj.position.x=-a.backgroundObj.width/2,a.backgroundObj.position.y=-a.backgroundObj.height/2,a.guideLine.height=1,a.guideLine.anchor.set(o=="left"?0:1,.5),a.guideLine.width=Math.abs(a.position.x)+192-a.backgroundObj.width/2,a.guideLine.position.x=(o=="left"?1:-1)*a.backgroundObj.width/2,this.renderer.chartManager.editTimingMode!=Te.Off){let l=this.getTrackPos(r.type);l+=qt[r.type]/2*(l>0?1:-1),a.position.x=l,a.pivot.x=0}else{let l=(o=="right"?1:-1)*(this.renderer.chart.gameType.notefieldWidth*.5+80);o=="left"&&(l-=30),a.position.x=l,a.pivot.x=o=="right"?-a.backgroundObj.width/2:a.backgroundObj.width/2}}for(const[r,a]of this.timingBoxMap.entries()){if(t<r.beat+n||e>r.beat+n){this.timingBoxPool.destroyChild(a),this.timingBoxMap.delete(r);continue}a.y=b.chart.CMod&&r.second?this.renderer.getYPosFromSecond(r.second):this.renderer.getYPosFromBeat(r.beat+n)}}getTrackPos(e){if(this.trackPosCache.has(e))return this.trackPosCache.get(e);const t=b.chart.timingEventOrder.left,n=b.chart.timingEventOrder.right;let r=-this.renderer.chart.gameType.notefieldWidth*.5-128;for(let a=t.length-1;a>=0;a--){const s=t[a];this.trackPosCache.set(s,r),r-=qt[s]}r=this.renderer.chart.gameType.notefieldWidth*.5+128;for(let a=0;a<n.length;a++){const s=n[a];this.trackPosCache.set(s,r),r+=qt[s]}return this.trackPosCache.get(e)??0}}class Vg extends he{chartManager;chart;speedMult=1;lastMousePos;lastMouseBeat=-1;lastMouseCol=-1;lastNoteType=null;lastHoldBeat=null;editingCol=-1;cachedBeat=0;cachedTime=0;waveform;barlines;timingAreas;timingTracks;techIndicators;techErrors;candleIndicator;selectedEvents;timingBar;notefield;snapDisplay;judgement;combo;selectionBoundary;selectionArea;previewArea;scrollDebug;parityDebug;selectionBounds;constructor(e){super(),this.chartManager=e,this.chart=e.loadedChart,this.waveform=new yg(this),this.barlines=new lg(this),this.timingAreas=new zm(this),this.timingTracks=new Hg(this),this.techIndicators=new gg(this),this.techErrors=new mg(this),this.candleIndicator=new cg(this),this.selectedEvents=new zg(this),this.timingBar=new Og(this),this.notefield=new Ic(this),this.snapDisplay=new qm(this),this.previewArea=new dg(this),this.selectionArea=new fg(this),this.judgement=new Ng,this.combo=new Ig(this),this.selectionBoundary=new pg(this),this.scrollDebug=new hg(this),this.parityDebug=new ug(this),this.addChild(this.waveform,this.barlines,this.timingAreas,this.previewArea,this.selectionArea,this.timingTracks,this.candleIndicator,this.techIndicators,this.techErrors,this.selectedEvents,this.timingBar,this.combo,this.notefield,this.snapDisplay,this.judgement,this.selectionBoundary,this.scrollDebug,this.parityDebug),new Xt(this),this.chartManager.app.stage.addChild(this),this.eventMode="static",this.hitArea=new Kn(-1e5,-1e5,2e5,2e5);const t=a=>{if(this.editingCol!=-1){const s=b.chart.snap==0?.020833333333333332:b.chart.snap,o=Math.round(this.getBeatFromYPos(this.lastMousePos.y)/s)*s;this.chartManager.editHoldBeat(this.editingCol,o,a.shiftKey)}};let n=0;const r=()=>{this.selectionBounds&&(this.selectionBounds.lastKnownBeat!=this.cachedBeat&&(this.selectionBounds.endBeat+=this.cachedBeat-this.selectionBounds.lastKnownBeat,this.selectionBounds.lastKnownBeat=this.cachedBeat,this.selectionBoundary.update()),n!=0&&(this.chartManager.beat=Math.max(0,this.chartManager.beat+n),this.selectionBounds.endBeat+=n,this.selectionBoundary.update()))};xt.shared.add(r),window.addEventListener("keydown",t),this.on("destroyed",()=>{window.removeEventListener("keydown",t),this.removeAllListeners(),xt.shared.remove(r)}),this.on("pointerdown",a=>{qr(a)||this.chartManager.getMode()==U.Play||this.chartManager.getMode()==U.View||(this.chartManager.editTimingMode==Te.Add&&this.lastMousePos?this.timingTracks.placeGhostEvent():this.chartManager.editTimingMode==Te.Off&&b.chart.mousePlacement&&this.lastMouseBeat!=-1&&this.lastMouseCol!=-1&&!a.getModifierState("Shift")?(this.chartManager.clearSelections(),this.editingCol=this.lastMouseCol,this.lastHoldBeat=null,this.chartManager.setNote(this.lastMouseCol,"mouse",this.lastMouseBeat)):(!a.getModifierState("Control")&&!a.getModifierState("Meta")&&!a.getModifierState("Shift")&&this.chartManager.clearSelections(),this.chartManager[this.chartManager.editTimingMode==Te.Off?"startDragSelection":"startDragEventSelection"](),this.selectionBounds={startX:this.toLocal(a.global).x,startBeat:this.getBeatFromYPos(this.toLocal(a.global).y),endX:this.toLocal(a.global).x,endBeat:this.getBeatFromYPos(this.toLocal(a.global).y),lastKnownBeat:this.cachedBeat},this.selectionBoundary.update()))}),this.on("mousemove",a=>{if(this.lastMousePos=this.toLocal(a.global),this.editingCol!=-1){const s=b.chart.snap==0?.020833333333333332:b.chart.snap,o=Math.round(this.getBeatFromYPos(this.lastMousePos.y)/s)*s;this.lastHoldBeat!=o&&(this.lastHoldBeat=o,this.chartManager.editHoldBeat(this.editingCol,o,a.shiftKey))}this.selectionBounds&&(this.selectionBounds.endBeat=this.getBeatFromYPos(this.toLocal(a.global).y),this.selectionBounds.endX=this.toLocal(a.global).x,this.selectionBounds.lastKnownBeat=this.cachedBeat,this.selectionBoundary.update()),n=Math.max(0,this.lastMousePos.y-this.getLowerBound()+100)/600,this.lastMousePos.y<0&&(n=Math.min(0,this.lastMousePos.y-this.getUpperBound()-100)/600),b.chart.reverse&&(n=Math.max(0,this.getUpperBound()-this.lastMousePos.y+100)/600,this.lastMousePos.y>0&&(n=Math.min(0,this.getLowerBound()-this.lastMousePos.y-100)/600))}),this.on("pointerup",()=>{this.editingCol!=-1&&(this.chartManager.endEditing(this.editingCol),this.editingCol=-1),this.chartManager[this.chartManager.editTimingMode==Te.Off?"endDragSelection":"endDragEventSelection"](),this.selectionBounds=void 0,this.selectionBoundary.update(),n=0})}isDragSelecting(){return!!this.selectionBounds}doJudgement(e,t,n){this.chartManager.getMode()==U.Play&&(this.judgement.doJudge(t,n),this.timingBar.addBar(t,n)),this.notefield.onJudgement(e.col,n)}startPlay(){this.notefield.startPlay()}endPlay(){this.notefield.endPlay(),this.timingBar.reset(),this.judgement.reset()}update(){if(this.destroyed)return;this.cachedBeat=this.chartManager.beat,this.cachedTime=this.chartManager.time,this.x=b.chart.receptorXPos,this.speedMult=b.chart.doSpeedChanges?this.getCurrentSpeedMult():1;const e=this.getTopOnScreenBeat(),t=this.getBottomOnScreenBeat(),n=Math.min(e,t),r=Math.max(e,t);if(this.scale.x=b.chart.zoom,this.scale.y=b.chart.zoom,this.children.forEach(a=>{if(a.isEditGUI&&!this.shouldDisplayEditGUI()){a.visible=!1;return}a.visible=!0,a.update(n,r)}),Xt.instance.update(),this.notefield.alpha=this.chartManager.editTimingMode==Te.Off||this.chartManager.getMode()==U.Play?1:.3,b.chart.mousePlacement&&this.lastMousePos&&this.chartManager.getMode()!=U.Play){const a=b.chart.snap==0?.020833333333333332:b.chart.snap,s=Math.round(this.getBeatFromYPos(this.lastMousePos.y)/a)*a;let o=-1;for(let l=0;l<this.chart.gameType.numCols;l++){const u=this.chart.gameType.columnWidths[l],f=this.getXPosFromColumn(l);if(this.lastMousePos.x<f+u/2&&this.lastMousePos.x>f-u/2){o=l;break}}(s!=this.lastMouseBeat||o!=this.lastMouseCol||this.chartManager.getEditingNoteType()!=this.lastNoteType)&&(this.lastMouseBeat=s,this.lastMouseCol=o,this.lastNoteType=this.chartManager.getEditingNoteType(),this.editingCol!=-1&&this.chartManager.editHoldBeat(this.editingCol,s,!1),o===-1?(this.lastMouseBeat=-1,this.lastMouseCol=-1,this.notefield.setGhostNote()):this.notefield.setGhostNote(this.chart.computeNote({beat:s,col:this.lastMouseCol,type:this.chartManager.getEditingNoteType()})))}this.lastMousePos&&this.chartManager.editTimingMode==Te.Add&&this.timingTracks.updateGhostEvent(this.lastMousePos)}getTimeWithOffset(){let e=this.cachedTime;return(this.chartManager.getMode()==U.Play||this.chartManager.getMode()==U.Record)&&(e+=b.play.offset*b.audio.rate),e}getBeatWithOffset(){let e=this.cachedBeat;return(this.chartManager.getMode()==U.Play||this.chartManager.getMode()==U.Record)&&(e=this.chart.getBeatFromSeconds(this.getTimeWithOffset())),e}getVisualTime(){let e=this.cachedTime;return(this.chartManager.getMode()==U.Play||this.chartManager.getMode()==U.Record)&&(e+=(b.play.offset+b.play.visualOffset)*b.audio.rate),e}getVisualBeat(){let e=this.cachedBeat;return(this.chartManager.getMode()==U.Play||this.chartManager.getMode()==U.Record)&&(e=this.chart.getBeatFromSeconds(this.getVisualTime())),e}getXPosFromColumn(e){return this.notefield.getColumnX(e)}getYPosFromBeat(e){const t=this.getVisualTime(),n=this.getVisualBeat(),r=b.chart.reverse?-1:1;return b.chart.CMod?(this.chart.getSecondsFromBeat(e)-t)*this.getSecondsToPixelsRatio()*r+this.getActualReceptorYPos():n==e?this.getActualReceptorYPos():(b.chart.doSpeedChanges?this.chart.timingData.getEffectiveBeat(e)-this.chart.timingData.getEffectiveBeat(n):e-n)*this.getEffectiveBeatsToPixelsRatio()*r+this.getActualReceptorYPos()}getYPosFromSecond(e){const t=this.getVisualTime(),n=b.chart.reverse?-1:1;return b.chart.CMod?(e-t)*this.getSecondsToPixelsRatio()*n+this.getActualReceptorYPos():this.getYPosFromBeat(this.chart.timingData.getBeatFromSeconds(e))}getSecondFromYPos(e){const t=b.chart.reverse?-1:1;if(b.chart.CMod){const n=this.getPixelsToSecondsRatio(),r=this.getVisualTime(),s=(e-this.getActualReceptorYPos())*n*t;return r+s}return this.chart.getSecondsFromBeat(this.getBeatFromYPos(e))}getBeatFromYPos(e,t){const n=this.getVisualBeat(),r=b.chart.reverse?-1:1;if(b.chart.CMod)return this.chart.getBeatFromSeconds(this.getSecondFromYPos(e));const s=(e-this.getActualReceptorYPos())*this.getPixelsToEffectiveBeatsRatio()*r;if(b.chart.doSpeedChanges&&!t){const o=this.chart.timingData.getEffectiveBeat(n)+s;return this.chart.getBeatFromEffectiveBeat(o)}return n+s}getColumnFromXPos(e){const t=this.chart.gameType;let n=null;for(let r=0;r<t.numCols;r++){const a=Math.abs(this.getXPosFromColumn(r)-e);if(n!==null&&a>n)return r-1;n=a}return t.numCols-1}getActualReceptorYPos(){return b.chart.receptorYPos/b.chart.zoom*(b.chart.reverse?-1:1)}getEffectiveBeatsToPixelsRatio(){return b.chart.speed/100*64*this.speedMult}getPixelsToEffectiveBeatsRatio(){return 1/this.getEffectiveBeatsToPixelsRatio()}getSecondsToPixelsRatio(){return b.chart.speed/100*64*4}getPixelsToSecondsRatio(){return 1/this.getSecondsToPixelsRatio()}isNegScroll(e){return b.chart.doSpeedChanges&&(this.speedMult<0||(this.chart.timingData.getEventAtBeat("SCROLLS",e)?.value??1)<0||(this.chart.timingData.getEventAtBeat("BPMS",e)?.value??120)<0)}getUpperBound(){return-this.chartManager.app.STAGE_HEIGHT/2/b.chart.zoom-64}getLowerBound(){return this.chartManager.app.STAGE_HEIGHT/2/b.chart.zoom+64}findFirstOnScreenScroll(){const e=[...this.chart.timingData.getTimingData("SCROLLS")];e[0]?.beat!=0&&e.splice(0,0,{beat:0,value:e[0]?.value??1,type:"SCROLLS"});let t=hi(e,this.getVisualBeat()-b.chart.maxDrawBeatsBack,n=>n.beat);for(;t<e.length&&(e[t].beat??0)<this.getVisualBeat()+b.chart.maxDrawBeats;){const n=e[t];t++;const r=n===void 0?-1/0*this.getScrollDirection(e[0]?.value??1):this.getYPosFromBeat(n.beat??0),a=e[t]===void 0?1/0*this.getScrollDirection(n.value):this.getYPosFromBeat(e[t].beat);if(this.isAreaOnScreen(r,a))return n}return e.at(-1)??{beat:0,value:1,type:"SCROLLS"}}findLastOnScreenScroll(){const e=[...this.chart.timingData.getTimingData("SCROLLS")];e[0]?.beat!=0&&e.splice(0,0,{beat:0,value:e[0]?.value??1,type:"SCROLLS"});let t=hi(e,this.getVisualBeat()+b.chart.maxDrawBeats,r=>r.beat);const n=hi(e,this.getVisualBeat()-b.chart.maxDrawBeatsBack,r=>r.beat);for(;t>=n;){const r=e[t];t--;const a=r===void 0?-1/0*this.getScrollDirection(e[0]?.value??1):this.getYPosFromBeat(r.beat??0),s=e[t+2]===void 0?1/0*this.getScrollDirection(r.value):this.getYPosFromBeat(e[t+2].beat);if(this.isAreaOnScreen(a,s))return r}return{beat:0,value:1,type:"SCROLLS"}}getTopOnScreenBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=this.findFirstOnScreenScroll(),t=1/Math.abs(this.getEffectiveBeatsToPixelsRatio()),n=this.getYPosFromBeat(e.beat),r=t/Math.abs(e.value),a=this.getScrollDirection(e.value),s=a==1?this.getUpperBound():this.getLowerBound(),o=a*(s-n)*r+e.beat;return Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,o)}return b.chart.CMod?this.getBeatFromYPos(this.getUpperBound()):Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,this.getBeatFromYPos(this.getUpperBound()))}getBottomOnScreenBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=this.findLastOnScreenScroll(),t=1/Math.abs(this.getEffectiveBeatsToPixelsRatio()),n=this.getYPosFromBeat(e.beat),r=t/Math.abs(e.value),a=this.getScrollDirection(e.value),s=a==1?this.getLowerBound():this.getUpperBound(),o=a*(s-n)*r+e.beat;return Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,o)}return b.chart.CMod?this.getBeatFromYPos(this.getLowerBound()):Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,this.getBeatFromYPos(this.getLowerBound()))}isAreaOnScreen(e,t){t<e&&([e,t]=[t,e]);const n=this.getUpperBound(),r=this.getLowerBound();return e<r&&t>n}getCurrentSpeedMult(){return this.chart.timingData.getSpeedMult(this.getVisualBeat(),this.getVisualTime())}getScrollDirection(e){let t=1;return this.getCurrentSpeedMult()<0&&(t*=-1),b.chart.reverse&&(t*=-1),e<0&&(t*=-1),t}getUpperBoundBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=b.chart.speed,t=this.chart.timingData.getSpeedMult(this.getVisualBeat(),this.getVisualTime()),n=t>=0!=b.chart.reverse?1:-1,r=this.chart.timingData.getTimingData("SCROLLS"),a=100/e/Math.abs(t)/64/b.chart.zoom,s=this.getUpperBound(),o=this.getLowerBound();let l=hi(r,this.getVisualBeat()-b.chart.maxDrawBeatsBack,m=>m.beat);for(this.getVisualBeat()-b.chart.maxDrawBeatsBack<r[0]?.beat&&(l=-1);l<r.length&&(r[l]?.beat??0)<this.getVisualBeat()+b.chart.maxDrawBeats;){const m=r[l],g=this.getYPosFromBeat(m?.beat??0),y=r[l+1]?.beat??this.getVisualBeat()+b.chart.maxDrawBeats,x=this.getYPosFromBeat(y);if((m?.value??1)*n>0&&x>s&&(g<s||!r[l-1]||r[l-1].beat<this.getVisualBeat()-b.chart.maxDrawBeatsBack||r[l-1].value==0)||(m?.value??1)*n<0&&x<s&&(g>s||!r[l-1]||r[l-1].beat<this.getVisualBeat()-b.chart.maxDrawBeatsBack||r[l-1].value==0))break;l++}const u=r[l]?.beat??0,f=this.getYPosFromBeat(u),c=r[l]?.value??1,d=a/Math.abs(c)*b.chart.zoom,h=b.chart.reverse?s:o,p=b.chart.reverse?o:s;return c*n>0?r[l-1]?.value==0&&this.getYPosFromBeat(r[l-1].beat)>p?this.getVisualBeat()-b.chart.maxDrawBeatsBack:Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,u+d*(p-f)):r[l-1]?.value==0&&this.getYPosFromBeat(r[l-1].beat)<h?this.getVisualBeat()-b.chart.maxDrawBeatsBack:Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,u+d*(f-h))}return b.chart.CMod?this.getBeatFromYPos(this.getUpperBound()):Math.max(this.getVisualBeat()-b.chart.maxDrawBeatsBack,this.getBeatFromYPos(this.getUpperBound()))}getLowerBoundBeat(){if(b.chart.waveform.speedChanges&&!b.chart.CMod&&b.chart.doSpeedChanges){const e=b.chart.speed,t=this.chart.timingData.getSpeedMult(this.getVisualBeat(),this.getVisualTime()),n=t>=0!=b.chart.reverse?1:-1,r=this.chart.timingData.getTimingData("SCROLLS"),a=100/e/Math.abs(t)/64/b.chart.zoom,s=this.getUpperBound(),o=this.getLowerBound();let l=hi(r,this.getVisualBeat()+b.chart.maxDrawBeats,m=>m.beat);for(;l<r.length&&l>=0&&(r[l].beat??0)>this.getVisualBeat()-b.chart.maxDrawBeatsBack;){const m=r[l],g=this.getYPosFromBeat(m?.beat??0),y=r[l+1]?.beat??this.getVisualBeat()+b.chart.maxDrawBeats,x=this.getYPosFromBeat(y);if((m?.value??1)*n>0&&g<o&&(x>o||!r[l+1]||r[l+1].beat>this.getVisualBeat()+b.chart.maxDrawBeatsBack||r[l+1].value==0)||(m?.value??1)*n<0&&g>o&&(x<o||!r[l+1]||r[l+1].beat>this.getVisualBeat()+b.chart.maxDrawBeatsBack||r[l+1].value==0))break;l--}const u=r[l]?.beat??0,f=this.getYPosFromBeat(u),c=r[l]?.value??1,d=a/Math.abs(c)*b.chart.zoom,h=b.chart.reverse?o:s,p=b.chart.reverse?s:o;return c*n>0?r[l+1]?.value==0&&this.getYPosFromBeat(r[l+1].beat)<p?this.getVisualBeat()+b.chart.maxDrawBeats:Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,u+d*(p-f)):r[l+1]?.value==0&&this.getYPosFromBeat(r[l+1].beat)>h?this.getVisualBeat()+b.chart.maxDrawBeats:Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,u+d*(f-h))}return b.chart.CMod?this.getBeatFromYPos(this.getLowerBound()):Math.min(this.getVisualBeat()+b.chart.maxDrawBeats,this.getBeatFromYPos(this.getLowerBound()))}selectionTest(e){if(!this.selectionBounds)return!1;const t=this.selectionBoundary.getBounds(),n=e.getBounds(),r=16*b.chart.zoom;return t.x+t.width>n.x+r&&t.x<n.x+n.width-r&&t.y+t.height>n.y+r&&t.y<n.y+n.height-r}registerDragNote(e,t){e.eventMode="static",e.removeAllListeners();let n=0,r=0,a=0,s=0,o;const l=u=>{const f=o,c=this.toLocal(u.global);if(Math.abs(c.y-s-a)**2+Math.abs(c.x-r)**2<32*32){this.chartManager.selection.shift&&(this.chartManager.selection.shift={columnShift:0,beatShift:0});return}const d=this.getBeatFromYPos(c.y-s),h=b.chart.snap==0?1/48:b.chart.snap;let p=Math.round(d/h)*h;Math.abs(p-d)>Math.abs(d-f.beat)&&(p=f.beat);const m=this.getColumnFromXPos(c.x);this.chartManager.selection.shift||={columnShift:0,beatShift:0},n!=m-f.col&&(n=m-f.col,this.chartManager.selection.notes.every(g=>{const y=g.col+n;return y>=0&&y<this.chartManager.loadedChart.gameType.numCols})&&(this.chartManager.selection.shift.columnShift=m-f.col)),this.chartManager.selection.shift.beatShift=Math.max(-Math.min(...this.chartManager.selection.notes.map(g=>g.beat)),p-f.beat)};e.on("pointerdown",u=>{if(this.chartManager.getMode()==U.View)return;if(qr(u)){this.chartManager.isNoteInSelection(t)||(this.chartManager.clearSelections(),this.chartManager.addNoteToSelection(t)),Qs.open(this.chartManager.app,u),u.preventDefault();return}if(b.chart.mousePlacement&&!u.getModifierState("Meta")&&!u.getModifierState("Control")&&!u.getModifierState("Shift")&&!this.chartManager.isNoteInSelection(t))return;u.stopImmediatePropagation(),this.chartManager.isNoteInSelection(t)?(u.getModifierState("Control")||u.getModifierState("Meta"))&&this.chartManager.removeNoteFromSelection(t):(!u.getModifierState("Control")&&!u.getModifierState("Meta")&&!u.getModifierState("Shift")&&this.chartManager.clearSelections(),this.chartManager.addNoteToSelection(t)),r=e.x,a=e.y,s=this.toLocal(u.global).y-e.y,o=t,this.on("pointermove",l);const f=()=>{this.off("pointermove",l),this.off("pointerup",f),((this.chartManager.selection.shift?.beatShift??0)!=0||(this.chartManager.selection.shift?.columnShift??0)!=0)&&this.chartManager.modifySelection(c=>(c.beat+=this.chartManager.selection.shift.beatShift,c.col+=this.chartManager.selection.shift.columnShift,c)),this.chartManager.selection.shift=void 0};this.on("pointerup",f)}),e.on("destroyed",()=>{e?.removeAllListeners()})}getNotefield(){return this.notefield}swapNoteskin(e){b.chart.noteskin.name=e,b.chart.lastNoteskins[this.chart.gameType.id]=e,this.reloadNotefield()}reloadNotefield(){const e=new Ic(this);this.addChildAt(e,this.children.indexOf(this.notefield)),this.notefield.destroy(),this.notefield=e}getSelectionBounds(){return this.selectionBounds}shouldDisplayEditGUI(){return(this.chartManager.getMode()!=U.Play||!b.play.hideBarlines)&&pe.barlines}shouldDisplayNoteSelection(e){return this.chartManager.getMode()!=U.Play&&!this.chartManager.app.capturing&&this.chartManager.isNoteInSelection(e)}shouldDisplayEventSelection(e){return this.chartManager.getMode()!=U.Play&&!this.chartManager.app.capturing&&this.chartManager.isEventInSelection(e)}}class Io extends AudioBufferSourceNode{started=!1;start(e,t,n){this.started||super.start(e,t,n),this.started=!0}stop(e){this.started&&super.stop(e),this.started=!1}static create(e){const t=e;return t.started=!1,Object.setPrototypeOf(t,Io.prototype),t}}class Ug extends BiquadFilterNode{enabled=!1;static create(e){const t=e;return t.enabled=!1,t}}class _r{_audioAnalyzer;_filteredAudioAnalyzer;_freqData;_filteredFreqData;_gainNode;type;_audioContext=new AudioContext;_source;_playbackTime=0;_startTimestamp=0;_rate=1;_isPlaying=!1;_buffer;_filteredBuffer;_loadedBuffer;_delay;_loadListeners=[];_updateListeners=[];_volume=1;_destroyed=!1;_renderTimeout;_filters=[this.createFilter({type:"highpass",frequency:20,Q:.71}),this.createFilter({type:"lowshelf",frequency:75,gain:0}),this.createFilter({type:"peaking",frequency:100,gain:0,Q:.6}),this.createFilter({type:"peaking",frequency:250,gain:0,Q:.3}),this.createFilter({type:"peaking",frequency:1040,gain:0,Q:.41}),this.createFilter({type:"peaking",frequency:2500,gain:0,Q:.2}),this.createFilter({type:"highshelf",frequency:7500,gain:0}),this.createFilter({type:"lowpass",frequency:2e4,Q:.71})];_filtersEnabled=!1;onStop;loaded;constructor(e,t){this.type=t??"",this._filters[0].gain.value=-25,this._audioAnalyzer=this._audioContext.createAnalyser(),this._audioAnalyzer.fftSize=4096,this._audioAnalyzer.maxDecibels=0,this._freqData=new Uint8Array(this._audioAnalyzer.frequencyBinCount),this._filteredAudioAnalyzer=this._audioContext.createAnalyser(),this._filteredAudioAnalyzer.fftSize=4096,this._filteredAudioAnalyzer.maxDecibels=0,this._filteredFreqData=new Uint8Array(this._filteredAudioAnalyzer.frequencyBinCount),this._gainNode=this._audioContext.createGain(),this._buffer=this._audioContext.createBuffer(2,1,44100),this._filteredBuffer=this._audioContext.createBuffer(2,1,44100),this._loadedBuffer=this._audioContext.createBuffer(2,1,44100),this.initSource(),this.loaded=new Promise(n=>{this.decodeData(e).then(r=>{if(r)return this._loadedBuffer=r,r}).then(async r=>(await this.renderBuffer(r),await this.renderFilteredBuffer(r),r)).catch(r=>{r.name=="EncodingError"?ue.createFormatted("Failed to load audio: file format not supported","error"):ue.createFormatted("Failed to load audio: "+r.message,"error")}).finally(()=>{this.initSource(),this.callLoadListeners(),this.callUpdateListeners(),n()})})}async renderBuffer(e){if(!e)return;const t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=t.createBufferSource();return n.buffer=e,n.connect(t.destination),n.start(),await t.startRendering().then(r=>{this._buffer=r}).catch(()=>{ue.createFormatted("Failed to load audio: audio rendering failed","error")})}async renderFilteredBuffer(e){if(!e)return;const t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=t.createBufferSource();n.buffer=e;let r=n;for(const a of this._filters){if(!a.enabled)continue;const s=t.createBiquadFilter();s.type=a.type,s.Q.setValueAtTime(a.Q.value,0),s.frequency.setValueAtTime(a.frequency.value,0),s.gain.setValueAtTime(a.gain.value,0),r.connect(s),r=s}return r.connect(t.destination),n.start(),await t.startRendering().then(a=>{this._filteredBuffer=a}).catch(()=>{ue.createFormatted("Failed to load audio: audio rendering failed","error")})}createFilter(e){const t=Ug.create(this._audioContext.createBiquadFilter());return t.type=e.type,e.Q!==void 0&&(t.Q.value=e.Q),e.gain!==void 0&&(t.gain.value=e.gain),e.frequency!==void 0&&(t.frequency.value=e.frequency),t}getFilters(){return this._filters}getFilter(e){return this._filters[e]}updateFilter(e,t){this._filters[e]&&(t.Q!==void 0&&(this._filters[e].Q.value=t.Q),t.frequency!==void 0&&(this._filters[e].frequency.value=t.frequency),t.gain!==void 0&&(this._filters[e].gain.value=t.gain),clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout(()=>this.renderFilteredBuffer(this._loadedBuffer).then(()=>this.callUpdateListeners()),500))}enableFilter(e){this._filters[e].enabled=!0,this.initSource(),clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout(()=>this.renderFilteredBuffer(this._loadedBuffer).then(()=>this.callUpdateListeners()),500),this._filtersEnabled=!0}disableFilter(e){this._filters[e].enabled=!1,this.initSource(),clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout(()=>this.renderFilteredBuffer(this._loadedBuffer).then(()=>this.callUpdateListeners()),500),this._filtersEnabled=this._filters.some(t=>t.enabled)}hasFilters(){return this._filtersEnabled}onLoad(e){this._loadListeners.push(e)}offLoad(e){this._loadListeners=this._loadListeners.filter(t=>t!=e)}onUpdate(e){this._updateListeners.push(e)}offUpdate(e){this._updateListeners=this._updateListeners.filter(t=>t!=e)}getSongLength(){return this._buffer.length/this._buffer.sampleRate}getFrequencyData(){return this._destroyed?new Uint8Array:(this._audioAnalyzer.getByteFrequencyData(this._freqData),this._freqData)}getFilteredFrequencyData(){return this._destroyed?new Uint8Array:(this._filteredAudioAnalyzer.getByteFrequencyData(this._filteredFreqData),this._filteredFreqData)}getSampleRate(){return this._buffer.sampleRate}getFFTSize(){return this._audioAnalyzer.fftSize}getRawData(){if(this._destroyed)return[];const e=[];for(let t=0;t<this._buffer.numberOfChannels;t++){const n=new Float32Array(this._buffer.length);this._buffer.copyFromChannel(n,t),e.push(n)}return e}getFilteredRawData(){if(this._destroyed)return[];const e=[];for(let t=0;t<this._filteredBuffer.numberOfChannels;t++){const n=new Float32Array(this._filteredBuffer.length);this._filteredBuffer.copyFromChannel(n,t),e.push(n)}return e}getBuffer(){return this._loadedBuffer}isPlaying(){return this._destroyed?!1:this._isPlaying}reload(){this.initSource()}destroy(){this._destroyed||(this.stop(),this._buffer=this._audioContext.createBuffer(2,1,44100),this._updateListeners=[],clearTimeout(this._delay),this._destroyed=!0)}getFrequencyResponse(e){const t=new Float32Array(e);return this._filters.some(n=>n.enabled)?this._filters.filter(n=>n.enabled).map(n=>{const r=new Float32Array(e.length);return n.getFrequencyResponse(t,r,new Float32Array(e.length)),[...r]}).reduce((n,r)=>n.map((a,s)=>a*r[s])):new Array(e.length).fill(1)}callLoadListeners(){this._loadListeners.forEach(e=>e())}callUpdateListeners(){this._updateListeners.forEach(e=>e())}async decodeData(e){return new Promise((t,n)=>{if(!e){t();return}(async()=>{try{t(await this._audioContext.decodeAudioData(e))}catch(r){if(this.type==".ogg"){const a=(await qe(async()=>{const{default:s}=await import("./OggDec-BmLxerny.js");return{default:s}},[])).default;try{t(await a.decodeOggData(e))}catch(s){n(s)}return}n(r)}})()})}initSource(){for(const t of this._filters)t.disconnect();this._audioAnalyzer.disconnect(),this._filteredAudioAnalyzer.disconnect(),this._gainNode.disconnect(),this._audioContext.destination.disconnect(),this._source?.stop(),this._source=Io.create(this._audioContext.createBufferSource()),this._source.buffer=this._buffer,this._source.connect(this._audioAnalyzer);let e=this._audioAnalyzer;for(const t of this._filters)t.enabled&&(e.connect(t),e=t);e.connect(this._filteredAudioAnalyzer),b.audio.allowFilter?this._filteredAudioAnalyzer.connect(this._gainNode):this._audioAnalyzer.connect(this._gainNode),this._gainNode.connect(this._audioContext.destination),this._source.playbackRate.value=this._rate,this._isPlaying&&(this.pause(),this.play())}volume(e){this._destroyed||this._volume!=e&&(this._volume=e,this._gainNode.gain.setValueAtTime(e,this._audioContext.currentTime))}rate(e){this._destroyed||this._rate!=e&&(this._rate=e,this._source&&(this._isPlaying&&(this._playbackTime+=(this._audioContext.currentTime-this._startTimestamp)*this._source.playbackRate.value),this._startTimestamp=this._audioContext.currentTime,this._source.playbackRate.value=e))}play(){this._destroyed||this._source&&(this._isPlaying||(this.initSource(),this._playbackTime<=this._buffer.duration&&this._source.start(Math.max(0,this._audioContext.currentTime-this._playbackTime/b.audio.rate),Math.max(0,this._playbackTime)),this._startTimestamp=this._audioContext.currentTime,this._isPlaying=!0))}seek(e){if(e===void 0)return this._destroyed?this._playbackTime:this._source?this._isPlaying?(this._audioContext.currentTime-this._startTimestamp)*this._source.playbackRate.value+this._playbackTime:this._playbackTime:this._playbackTime;this._isPlaying?(this.stop(),this._playbackTime=e,this.play()):this._playbackTime=e}pause(){this._destroyed||this.stop(!0)}stop(e){this._destroyed||this._source&&this._isPlaying&&(this.onStop?.(),clearTimeout(this._delay),this._isPlaying=!1,this._playbackTime<=this._buffer.duration&&this._source.stop(),this._playbackTime=e?(this._audioContext.currentTime-this._startTimestamp)*this._source.playbackRate.value+this._playbackTime:0)}}class Wg{judgementCounts=new Map;holdJudgementCounts=new Map;dancePoints=0;maxCumulativeDancePoints=0;maxDancePoints=0;chartManager;notedata;dataPoints=[];handlers=[];combo=0;missCombo=0;maxCombo=0;bestJudge;constructor(e){this.notedata=e.loadedChart.getNotedata(),this.chartManager=e,this.bestJudge=kt.getCollection(b.play.timingCollection).getStandardWindows()[0],this.calculateMaxDP()}onJudge(e){this.handlers.push(e)}applyOffset(e){this.dataPoints=this.dataPoints.map(t=>mi(t.judgement)||!xi(t.judgement)?t:{...t,error:t.error!==null?t.error+e:null})}addDataPoint(e,t,n){this.judgementCounts.has(t)||this.judgementCounts.set(t,0),this.judgementCounts.set(t,this.judgementCounts.get(t)+1),this.dancePoints+=t.dancePoints;const r=this.chartManager.loadedChart.timingData.getEventAtBeat("COMBOS",e[0].beat),a=r?.hitMult??1,s=r?.missMult??1;eo(t)||(this.maxCumulativeDancePoints+=kt.getCollection(b.play.timingCollection).getMaxDancePoints()),mi(t)?(this.chartManager.loadedChart.gameType.gameLogic.usesHoldTicks||(this.maxCumulativeDancePoints+=e.filter(Oe).reduce((o,l)=>o+kt.getCollection(b.play.timingCollection).getMaxHoldDancePoints(l.type),0)),this.combo=0,this.chartManager.loadedChart.gameType.gameLogic.missComboIsPerRow?this.missCombo+=e.length*s:this.missCombo+=s,this.bestJudge=void 0):xi(t)&&(kt.getCollection(b.play.timingCollection).shouldHideNote(t)?(this.chartManager.loadedChart.gameType.gameLogic.comboIsPerRow?this.combo+=e.length*a:this.combo+=a,this.combo>this.maxCombo&&(this.maxCombo=this.combo),this.missCombo=0,this.bestJudge&&t.getTimingWindowMS()>this.bestJudge.getTimingWindowMS()&&(this.bestJudge=t)):(this.bestJudge=void 0,this.combo=0)),this.handlers.forEach(o=>o(n,t)),this.dataPoints.push({second:e[0].second,error:n,judgement:t,notes:e})}addHoldDataPoint(e,t){this.judgementCounts.has(t)||this.judgementCounts.set(t,0),this.judgementCounts.set(t,this.judgementCounts.get(t)+1);const n=kt.getCollection(b.play.timingCollection).getHeldJudgement(e);this.holdJudgementCounts.has(n)||this.holdJudgementCounts.set(n,[0,0]);const r=this.holdJudgementCounts.get(n);yn(t)?r[0]++:r[1]++,this.holdJudgementCounts.set(n,r),this.dancePoints+=t.dancePoints,this.maxCumulativeDancePoints+=kt.getCollection(b.play.timingCollection).getMaxHoldDancePoints(e.type),this.handlers.forEach(a=>a(0,t)),Xn(t)&&(this.bestJudge=void 0)}getScore(){return this.maxDancePoints==0?0:this.dancePoints/this.maxDancePoints}getCumulativeScore(){return this.maxCumulativeDancePoints==0?0:this.dancePoints/this.maxCumulativeDancePoints}getDataPoints(){return this.dataPoints}getMedian(){return jr(this.dataPoints.filter(e=>!mi(e.judgement)&&xi(e.judgement)&&e.error!=null).map(e=>e.error))}getMaxCombo(){return this.maxCombo}calculateMaxDP(){this.maxDancePoints=this.chartManager.loadedChart.gameType.gameLogic.calculateMaxDP(this.notedata,this.chartManager.loadedChart.timingData)}getCount(e){return this.judgementCounts.get(e)??0}getCombo(){return this.combo}getMissCombo(){return this.missCombo}getBestJudge(){return this.bestJudge}}const Gt=[1,2,3,4,6,8,12,16,24,48,-1],Rc=.2;var U=(i=>(i.View="View Mode",i.Edit="Edit Mode",i.Play="Play Mode",i.Record="Record Mode",i))(U||{}),Te=(i=>(i[i.Off=0]="Off",i[i.Edit=1]="Edit",i[i.Add=2]="Add",i))(Te||{});class Gg{app;chartAudio=new _r;chartView;widgetManager;assistTick=new Ds({src:lh,volume:.5});me_high=new Ds({src:Qc,volume:.5});me_low=new Ds({src:Jc,volume:.5});mine=new Ps.Howl({src:ch,volume:.5});loadedSM;smPath="";loadedChart;selection={notes:[],inProgressNotes:[]};eventSelection={timingEvents:[],inProgressTimingEvents:[]};editTimingMode=0;holdEditing=[];editNoteTypeIndex=0;partialScroll=0;noteFlashIndex=0;assistTickIndex=0;lastMetronomeDivision=-1;lastMetronomeMeasure=-1;holdFlashes=[];lastSong=null;mode="Edit Mode";lastMode="Edit Mode";_beat=0;cachedSecond=0;cachedBeat=0;noChartTextA;noChartTextB;loadingText;shiftPressed=0;virtualClipboard="";lastAutoSave=0;startRegion;endRegion;gameStats;constructor(e){this.app=e,document.addEventListener("keydown",t=>{t.key=="Shift"&&this.shiftPressed++}),document.addEventListener("keyup",t=>{t.key=="Shift"&&(this.shiftPressed=Math.max(this.shiftPressed-1,0))}),document.addEventListener("cut",t=>{if(t.target.classList.contains("inlineEdit")||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement||this.mode!="Edit Mode")return;const n=this.copy();n&&t.clipboardData?.setData("text/plain",n),this.eventSelection.timingEvents.length>0?this.deleteEventSelection():this.deleteSelection(),t.preventDefault()},!0),document.addEventListener("copy",t=>{if(t.target.classList.contains("inlineEdit")||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement||this.mode!="Edit Mode")return;const n=this.copy();n&&t.clipboardData?.setData("text/plain",n),t.preventDefault(),t.stopImmediatePropagation()},!0),document.addEventListener("paste",t=>{if(t.target.classList.contains("inlineEdit")||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement||this.mode!="Edit Mode")return;const n=t.clipboardData?.getData("text/plain");n&&this.paste(n,this.shiftPressed>0),t.preventDefault(),t.stopImmediatePropagation()},!0),e.view.addEventListener?.("wheel",t=>{if(!(this.loadedSM==null||this.loadedChart==null||this.chartView==null))if(t.preventDefault(),ii&&t.metaKey||!ii&&t.ctrlKey){const n=t.deltaY/5*b.chart.scroll.scrollSensitivity*(b.chart.scroll.invertZoomScroll?-1:1);b.chart.speed=Se(b.chart.speed*Math.pow(1.01,n),10,35e3)}else{if(this.mode=="Play Mode"||this.mode=="Record Mode")return;let n=this.beat;const r=b.chart.snap;let a=t.deltaY/b.chart.speed*b.chart.scroll.scrollSensitivity;if(b.chart.reverse&&b.chart.scroll.invertReverseScroll&&(a*=-1),b.chart.scroll.invertScroll&&(a*=-1),r==0?(this.partialScroll=0,n=this.beat+a):b.chart.scroll.scrollSnapEveryScroll?a<0?n=Math.round((this.beat-r)/r)*r:n=Math.round((this.beat+r)/r)*r:(this.partialScroll+=a,Math.abs(this.partialScroll)>r&&(this.partialScroll<0?n=Math.round((this.beat+Math.ceil(this.partialScroll/r)*r)/r)*r:n=Math.round((this.beat+Math.floor(this.partialScroll/r)*r)/r)*r,this.partialScroll%=r)),n=Math.max(0,n),n!=this.beat&&(this.beat=n),!this.holdEditing.every(s=>s==null))for(let s=0;s<this.holdEditing.length;s++)!this.holdEditing[s]||this.holdEditing[s].type=="mouse"||this.editHoldBeat(s,this.beat,t.shiftKey)}}),this.widgetManager=new $m(this),this.app.stage.addChild(this.widgetManager),this.noChartTextA=new ge("No Chart",{fontName:"Main",fontSize:30}),this.noChartTextA.anchor.set(.5),this.noChartTextA.tint=5592405,this.app.stage.addChild(this.noChartTextA),this.noChartTextB=new ge("Create a new chart",{fontName:"Main",fontSize:15}),this.noChartTextB.anchor.set(.5),this.noChartTextB.tint=5596791,this.noChartTextB.eventMode="static",this.noChartTextB.on("mouseover",()=>{this.noChartTextB.tint=8952234}),this.noChartTextB.on("mouseleave",()=>{this.noChartTextB.tint=5596791}),this.noChartTextB.on("mousedown",()=>{this.app.windowManager.openWindow(new $u(e,wt.getGameType("dance-single")))}),this.noChartTextA.visible=!1,this.noChartTextB.visible=!1,this.app.stage.addChild(this.noChartTextB),this.loadingText=new ge("Loading simfile...",{fontName:"Main",fontSize:20}),this.loadingText.anchor.set(.5),this.loadingText.tint=5592405,this.app.stage.addChild(this.loadingText),this.loadingText.visible=!1,this.noChartTextA.x=0,this.noChartTextA.y=-20,this.noChartTextB.x=0,this.noChartTextB.y=10,this.loadingText.x=0,this.loadingText.y=0,setInterval(()=>{if(!this.loadedSM||!this.loadedChart||!this.chartView)return;const t=performance.now(),n=this.chartAudio.seek();if(this.chartAudio.isPlaying()&&!this.holdEditing.every(a=>!a))for(let a=0;a<this.holdEditing.length;a++){if(!this.holdEditing[a]||this.holdEditing[a].type=="mouse")continue;let s=this.beat;this.mode=="Record Mode"&&(s=this.loadedChart.getBeatFromSeconds(this.time+b.play.offset));const o=b.chart.snap==0?1/48:b.chart.snap,l=Math.round(s/o)*o,u=this.holdEditing[a];(Math.max(0,Math.round(Math.max(this.beat,u.endBeat)*48)/48)-Math.max(0,Math.round(Math.min(this.beat,u.startBeat)*48)/48))*60/(this.loadedChart.timingData.getEventAtBeat("BPMS",this.beat)?.value??120)>.3&&this.editHoldBeat(a,l,!1)}const r=this.loadedChart.getNotedata();if(this.chartAudio.isPlaying()){this._beat=this.loadedChart?.getBeatFromSeconds(this.time)??0;let a=r[this.noteFlashIndex];for(;this.noteFlashIndex<r.length&&n>a.second;)this.mode!="Record Mode"&&this.loadedChart.gameType.gameLogic.shouldAssistTick(a)&&this.mode!="Play Mode"&&(this.chartView.doJudgement(a,0,Js),Oe(a)&&(a.type=="Hold"&&this.chartView.getNotefield().activateHold(a.col),a.type=="Roll"&&this.chartView.getNotefield().activateRoll(a.col),this.holdFlashes.push(a))),this.noteFlashIndex++,a=r[this.noteFlashIndex];this.holdFlashes=this.holdFlashes.filter(o=>this._beat<o.beat+o.hold?!0:(this.chartView&&(o.type=="Hold"&&this.chartView.getNotefield().releaseHold(o.col),o.type=="Roll"&&this.chartView.getNotefield().releaseRoll(o.col),this.chartView.doJudgement(o,null,kt.getCollection(b.play.timingCollection).getHeldJudgement(o))),!1));const s=new Set;for(;this.assistTickIndex<r.length&&n>r[this.assistTickIndex].second+b.play.effectOffset-Rc;){if(s.has(r[this.assistTickIndex].second)||r[this.assistTickIndex].second+b.play.effectOffset-n<0){this.assistTickIndex++;continue}this.mode!="Record Mode"&&this.loadedChart.gameType.gameLogic.shouldAssistTick(r[this.assistTickIndex])&&(b.audio.assistTick&&pe.assist&&this.assistTick.play((r[this.assistTickIndex].second+b.play.effectOffset-n)/b.audio.rate),s.add(r[this.assistTickIndex].second)),this.assistTickIndex++}}if(this.chartAudio.isPlaying()&&b.audio.metronome&&pe.assist){const a=this.loadedChart.timingData,s=this.loadedChart.getBeatFromSeconds(this.time+b.play.effectOffset+Rc),o=new Set,l=a.getBeatFromMeasure(this.lastMetronomeMeasure),u=a.getDivisionLength(l),f=l+u*this.lastMetronomeDivision,c=[...a.getMeasureBeats(f,s)].slice(1);for(const[d,h]of c){if(this.beat>d)continue;const p=a.getSecondsFromBeat(d);if(o.has(p))continue;o.add(p);const m=(p+b.play.effectOffset-this.time)/b.audio.rate;h?this.me_high.play(m):this.me_low.play(m)}if(c.length>0){const d=c.at(-1)[0];this.lastMetronomeMeasure=Math.floor(a.getMeasure(d)),this.lastMetronomeDivision=Math.round(a.getDivisionOfMeasure(d))}}this.mode=="Play Mode"&&this.loadedChart.gameType.gameLogic.update(this),this.lastAutoSave+b.general.autosaveInterval*1e3<Date.now()&&(this.lastAutoSave=Date.now(),Dt.instance.isDirty()&&this.autosave()),this.updateSoundProperties(),Bm(),tn.instance?.addUpdateTimeValue(performance.now()-t)},5),ee.on("chartModified",()=>{this.loadedChart&&(this.setNoteIndex(),ee.emit("chartModifiedAfter"))}),ee.on("userOptionUpdated",t=>{t!="audio.rate"&&t!="play.effectOffset"&&t!="audio.assistTick"&&t!="audio.metronome"||(this.assistTick.stop(),this.me_low.stop(),this.me_high.stop(),this.setNoteIndex())}),window.addEventListener("keyup",t=>{if(this.mode=="Edit Mode"&&t.code.startsWith("Digit")){let n=parseInt(t.code.slice(5))-1;n==-1&&(n=9),this.endEditing(n)}},!0),window.addEventListener("keydown",t=>{const n=Ae.getKeyNameFromEvent(t);if(this.mode=="Edit Mode"&&!t.target.classList.contains("inlineEdit")&&!(t.target instanceof HTMLTextAreaElement)&&!(t.target instanceof HTMLInputElement)&&!An.active){if(t.code.startsWith("Digit")&&!t.repeat&&!t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.ctrlKey){let r=parseInt(t.code.slice(5))-1;r==-1&&(r=9),r<(this.loadedChart?.gameType.numCols??4)&&(this.setNote(r,"key"),t.preventDefault(),t.stopImmediatePropagation())}if(!this.holdEditing.every(r=>r==null)){const r=["cursorUp","cursorDown","previousNote","nextNote","previousMeasure","nextMeasure","jumpChartStart","jumpChartEnd","jumpSongStart","jumpSongEnd"];for(const a of r)if(Ae.getCombosForKeybind(a).map(s=>s.key).includes(n)){t.preventDefault(),t.stopImmediatePropagation(),Ne[a].callback(this.app);for(let s=0;s<this.holdEditing.length;s++)!this.holdEditing[s]||this.holdEditing[s].type=="mouse"||this.editHoldBeat(s,this.beat,t.shiftKey);return}for(const a of["undo","redo"])if(Ae.getCombosForKeybind(a).map(s=>s.key).includes(n)){this.holdEditing=[];return}}}},!0),window.addEventListener("keydown",t=>{this.mode!="Play Mode"&&this.mode!="Record Mode"||t.key=="Escape"&&(this.setMode(this.lastMode),this.chartAudio.pause())},!0)}get beat(){if(!this.loadedChart)return 0;if(!this.chartAudio.isPlaying())return this._beat;if(this.cachedSecond==this.time)return this.cachedBeat;const e=this.loadedChart.getBeatFromSeconds(this.time);return this.cachedBeat=e,this.cachedSecond=this.time,e}set beat(e){this.loadedChart&&(this.chartAudio.seek(this.loadedChart.getSecondsFromBeat(e)),this._beat=e,this.setNoteIndex(),this.lastMetronomeMeasure=Math.floor(this.loadedChart.timingData.getMeasure(this.beat)),this.lastMetronomeDivision=Math.floor(this.loadedChart.timingData.getDivisionOfMeasure(this.beat)))}get time(){return this.chartAudio.seek()}set time(e){this.loadedChart&&(this.chartAudio.seek(e),this._beat=this.loadedChart.getBeatFromSeconds(e),this.setNoteIndex())}async loadSM(e){if(td.close(),id.close(),Lm.close(),Dt.instance.isDirty()){const l=new vn(this.app,"Save","Do you wish to save the current file?",[{label:"Cancel",type:"default"},{label:"No",type:"default"},{label:"Yes",type:"confirm"}]);this.app.windowManager.openWindow(l);const u=await l.resolved;if(u=="Cancel")return;u=="Yes"&&this.save(),u=="No"&&await this.removeAutosaves()}if(!e){this.smPath="",this.loadedSM?.destroy(),this.loadedSM=void 0,this.chartAudio.stop(),this.noChartTextA.visible=!1,this.noChartTextB.visible=!1,this.chartView?.destroy({children:!0});return}if(this.chartAudio.stop(),this.chartAudio.seek(0),this.lastSong=null,this.smPath=e,this.loadingText.visible=!0,Tt(this.smPath)==".sm"&&b.general.loadSSC!="Never"){const l=this.getSMPath(".ssc");if(await Ce.hasFile(l))if(b.general.loadSSC=="Prompt"){const u=new vn(this.app,"Use SSC File","An SSC file was found. Do you wish to use the SSC file instead?",[{label:"No",type:"default"},{label:"Yes",type:"confirm"}],"You can change the default behavior in settings");this.app.windowManager.openWindow(u),await u.resolved=="Yes"&&(this.smPath=l)}else b.general.loadSSC=="Always"&&(ue.create("Loading available SSC file"),this.smPath=l)}let t=this.smPath;const n=this.getSMPath(".smebak");if(await Ce.hasFile(n)){const l=new vn(this.app,"Autosave","An autosave was found. Do you wish to load the autosave?",[{label:"No",type:"default"},{label:"Yes",type:"confirm"}]);this.app.windowManager.openWindow(l),await l.resolved=="Yes"&&(t=n)}const r=await Ce.getFileHandle(t);if(!r){ue.createFormatted("Couldn't load the file at "+t,"error"),this.app.windowManager.openWindow(new Lo(this.app)),this.loadingText.visible=!1;return}const a=await r.getFile(),s=await Ce.getFileHandle(this.getDataPath()),o=s?await s.getFile():void 0;this.loadedSM?.destroy(),this.loadedSM=new Hc(a,o),await this.loadedSM.loaded,this.loadingText.visible=!1,this.noChartTextA.visible=!0,this.noChartTextB.visible=!0,this.editTimingMode=0,ee.emit("smLoaded"),await this.loadChart(),ee.emit("smLoadedAfter"),this.beat=0,Yu.addSM(this.smPath,this.loadedSM)}async loadChart(e){if(this.loadedSM==null)return;if(e==null){if(this.loadedChart){const r=this.loadedSM.getChartsByGameType(this.loadedChart.gameType.id);r&&r.length>0&&(e=r.at(-1))}if(!e)for(const r of wt.getPriority()){const a=this.loadedSM.getChartsByGameType(r.id);if(a&&a.length>0){e=a.at(-1);break}}if(!e){this.chartView?.destroy({children:!0}),this.chartView?.removeChildren(),this.beat=0,this.loadedChart=void 0,this.chartView=void 0,this.noChartTextA.visible=!0,this.noChartTextB.visible=!0,ee.emit("chartLoaded",null),ee.emit("chartModified");return}}if(e==this.loadedChart)return;this.chartView?.destroy({children:!0}),this.chartView?.removeChildren(),this.clearSelections(),this.loadedChart=e,this.beat=this.loadedChart.getBeatFromSeconds(this.time),Dt.instance.reset(),b.play.timingCollection="ITG";for(const[r,a]of Object.entries(b.play.defaultTimingCollections))if(e.gameType.id.startsWith(r)){b.play.timingCollection=a;break}const t=wt.getGameType(b.chart.noteskin.type),n={type:e.gameType.id,name:b.chart.lastNoteskins[e.gameType.id]??"default"};if(t){const r=nt.getNoteskinData(t,b.chart.noteskin.name);r?.gameTypes.includes(e.gameType.id)&&(n.name=r.id)}if(b.chart.noteskin=n,b.chart.lastNoteskins[e.gameType.id]=n.name,this.setNoteIndex(),this.chartView=new Vg(this),(this.mode=="Play Mode"||this.mode=="Record Mode")&&this.setMode(this.lastMode),pe.viewMode&&this.setMode("View Mode"),this.noChartTextA.visible=!1,this.noChartTextB.visible=!1,this.loadedChart.getMusicPath()!=this.lastSong){this.lastSong=this.loadedChart.getMusicPath();const r=this.chartAudio.isPlaying();await this.loadAudio(),r&&this.chartAudio.play()}ue.create("Loaded chart "+e.difficulty+" "+e.meter+" "+e.gameType.id),ee.emit("chartLoaded",e),ee.emit("chartModified"),pe.autoPlay&&this.playPause()}async loadAudio(){if(!this.loadedSM||!this.loadedChart)return;this.chartAudio.stop(),this.chartAudio?.destroy();const e=this.loadedChart.getMusicPath();if(ue.create("Loading audio..."),e==""){ue.createFormatted("Failed to load audio: no audio file","error");const a=Math.max(0,this.beat);this.chartAudio=new _r(void 0),this.beat=a,ee.emit("audioLoaded");return}const t=await this.getAudioHandle(e);if(t==null){ue.createFormatted("Failed to load audio: couldn't find audio file "+e,"error");const a=Math.max(0,this.beat);this.chartAudio=new _r(void 0),this.beat=a,ee.emit("audioLoaded");return}const n=await t.getFile(),r=Math.max(0,this.beat);this.chartAudio=new _r(await n.arrayBuffer(),Tt(n.name)),this.chartAudio.onLoad(()=>{ue.create("Loaded audio")}),this.beat=r,this.chartAudio.onStop=()=>{this.assistTick.stop(),this.me_high.stop(),this.me_low.stop()},this.setNoteIndex(),ee.emit("audioLoaded")}async getAudioHandle(e){let t=await Ce.getFileHandleRelativeTo(this.smPath,e);if(t)return t;try{const n=await Ce.getDirectoryFiles(ot(this.smPath));if(t=n.filter(r=>r.name.toLowerCase()==Lt(e).toLowerCase())[0],t)return ue.createFormatted("Failed to locate audio file "+e+", using file "+t.name+" instead","warn"),t;t=n.filter(r=>ea.includes(Tt(r.name)))[0],t&&ue.createFormatted("Failed to locate audio file "+e+", using file "+t.name+" instead","warn")}catch{return}return t}getAudio(){return this.chartAudio}updateSoundProperties(){this.setEffectVolume(b.audio.soundEffectVolume*b.audio.masterVolume),this.setVolume(b.audio.songVolume*b.audio.masterVolume),this.setRate(b.audio.rate)}setRate(e){this.chartAudio.rate(e)}setVolume(e){this.chartAudio.volume(e)}setEffectVolume(e){this.assistTick.volume(e),this.me_high.volume(e),this.me_low.volume(e),this.mine.volume()!=e&&this.mine.volume(e)}setNoteIndex(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null||this.loadedChart.getNotedata().length==0){this.noteFlashIndex=0,this.assistTickIndex=0;return}this.assistTick.stop(),this.noteFlashIndex=hi(this.loadedChart.getNotedata(),this.time,e=>e.second)+1,this.noteFlashIndex>=1&&this.time<=this.loadedChart.getNotedata()[this.noteFlashIndex-1].second&&this.noteFlashIndex--,this.assistTickIndex=this.noteFlashIndex;for(const e of this.holdFlashes)e.type=="Hold"?this.chartView.getNotefield().releaseHold(e.col):e.type=="Roll"&&this.chartView.getNotefield().releaseRoll(e.col);this.holdFlashes=[]}playPause(){this.setNoteIndex(),this.chartAudio.isPlaying()?(this.chartAudio.pause(),this._beat=this.loadedChart?.getBeatFromSeconds(this.time)??0):this.chartAudio.play()}getClosestTick(e,t){if(!this.loadedChart)return 0;const n=Math.max(.001,4/t),r=this.loadedChart.timingData.getBeatOfMeasure(e),a=e-r,s=Math.round(r/n)*n;return Math.max(0,a+s)}snapToNearestTick(e){this.beat=Math.max(0,this.getClosestTick(e,4/b.chart.snap))}snapToPreviousTick(){if(!this.loadedChart)return;const e=Math.max(.001,b.chart.snap),t=Math.floor(this.loadedChart.timingData.getMeasure(this.beat)),n=this.loadedChart.timingData.getBeatFromMeasure(t),r=Math.floor((this.beat-n)/e)*e,a=Math.abs(r-(this.beat-n))<5e-4?r-e:r,s=a+n;if(a<0){const o=this.loadedChart.timingData.getBeatFromMeasure(t-1),l=Math.round((s-o)/e)*e;this.beat=Math.max(0,o+l);return}this.beat=Math.max(0,s)}snapToNextTick(){if(!this.loadedChart)return;const e=Math.max(.001,b.chart.snap),t=Math.floor(this.loadedChart.timingData.getMeasure(this.beat)),n=this.loadedChart.timingData.getBeatFromMeasure(t),s=Math.floor((this.beat-n+5e-4)/e)*e+e+n,o=this.loadedChart.timingData.getBeatFromMeasure(t+1);if(s>o){this.beat=o;return}this.beat=s}previousSnap(){let e=this.getSnapIndex()-1;e=(e+Gt.length)%Gt.length,b.chart.snap=Gt[e]==-1?0:1/Gt[e],ee.emit("snapChanged")}nextSnap(){let e=this.getSnapIndex();(e==Gt.length-1||Math.abs(1/b.chart.snap-Gt[e])<=5e-4)&&e++,e=(e+Gt.length)%Gt.length,b.chart.snap=Gt[e]==-1?0:1/Gt[e],ee.emit("snapChanged")}getSnapIndex(){return b.chart.snap==0?Gt.length-1:Gt.findIndex(e=>1/e<=b.chart.snap)}removeDuplicateBeats(e){if(e.length===0)return e;const t=[e[0]];for(let n=1;n<e.length;n++)e[n-1]!==e[n]&&t.push(e[n]);return t}getRows(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return[];if(this.loadedChart.getNotedata().length==0)return[];const e=this.loadedChart.getNotedata().filter(Oe).map(n=>n.beat+n.hold),t=this.loadedChart.getNotedata().map(n=>n.beat).concat(e).sort((n,r)=>n-r);return this.removeDuplicateBeats(t)}previousNote(){const e=this.getRows();if(e.length==0)return;let t=hi(e,this.beat);this.beat==e[t]&&t--,this.beat=e[Math.max(0,t)]}nextNote(){const e=this.getRows();if(e.length==0)return;let t=hi(e,this.beat);this.beat>=e[t]&&t++,this.beat=e[Math.min(e.length-1,t)]}firstNote(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;const e=this.loadedChart.getNotedata();e.length!=0&&(this.beat=e[0].beat)}lastNote(){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;const e=this.loadedChart.getNotedata();if(e.length==0)return;const t=e[e.length-1];this.beat=Ni(t)}truncateHold(e,t){const n=Se(Math.round((t-Math.max(.020833333333333332,b.chart.snap))*48)/48,e.beat,e.beat+e.hold-.020833333333333332);return n==e.beat?{beat:e.beat,col:e.col,type:"Tap"}:{beat:e.beat,col:e.col,type:e.type,hold:n-e.beat}}setNote(e,t,n=this.beat){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;if(b.chart.forceSnapNotes){const o=b.chart.snap==0?.020833333333333332:b.chart.snap;n=Math.round(n/o)*o}n=Math.max(0,Math.round(n*48)/48);const r=this.loadedChart.getNotedata().filter(o=>o.col!=e?!1:Math.abs(o.beat-n)<.003?!0:Oe(o)&&o.beat==n),a=this.loadedChart.getNotedata().filter(o=>Oe(o)&&o.col==e&&n>o.beat&&n<=Math.round((o.beat+o.hold)*48)/48).map(o=>({oldNote:o,newNote:this.truncateHold(o,n)})),s={startBeat:n,endBeat:n,roll:!1,originalNote:void 0,type:t,removedNotes:r,truncatedHolds:a,direction:null};this.holdEditing[e]=s,r.length==0&&(s.originalNote={beat:n,col:e,type:this.getEditingNoteType()}),this.setNoteIndex(),this.app.actionHistory.run({action:()=>{s.removedNotes.forEach(o=>{this.loadedChart.removeNote(o),this.removeNoteFromSelection(o)}),s.truncatedHolds.forEach(o=>this.loadedChart.modifyNote(o.oldNote,o.newNote)),s.originalNote&&this.loadedChart.addNote(s.originalNote)},undo:()=>{s.originalNote&&this.loadedChart.removeNote(s.originalNote),s.truncatedHolds.forEach(o=>this.loadedChart.modifyNote(o.newNote,o.oldNote)),s.removedNotes.forEach(o=>this.loadedChart.addNote(o))}})}editHoldBeat(e,t,n){if(this.loadedSM==null||this.loadedChart==null||this.chartView==null)return;const r=this.holdEditing[e];if(r==null||(t=Math.round(t*48)/48,t==r.startBeat&&t==r.endBeat))return;if(r.direction===null&&(t<r.startBeat?r.direction="up":r.direction="down"),b.chart.defaultHoldPlacement?r.direction=="up"?r.startBeat=Math.min(r.endBeat,Math.round(t*48)/48):r.endBeat=Math.max(r.startBeat,Math.round(t*48)/48):(r.startBeat=Math.min(r.startBeat,Math.round(t*48)/48),r.endBeat=Math.max(r.endBeat,Math.round(t*48)/48)),r.roll||=n,r.originalNote){const s={beat:r.startBeat,type:r.roll?"Roll":"Hold",hold:r.endBeat-r.startBeat};r.endBeat-r.startBeat==0&&(s.hold=void 0,s.type="Tap"),(s.beat!=r.originalNote.beat||s.type!=r.originalNote.type||Oe(r.originalNote)&&s.hold!=r.originalNote.hold)&&this.loadedChart.modifyNote(r.originalNote,s)}else{const s={beat:r.startBeat,col:e,type:r.roll?"Roll":"Hold",hold:r.endBeat-r.startBeat};r.endBeat-r.startBeat==0&&(s.type="Tap",Object.assign(s,{hold:void 0})),this.loadedChart.addNote(s)}r.originalNote={beat:r.startBeat,col:e,type:r.endBeat-r.startBeat==0?"Tap":r.roll?"Roll":"Hold",hold:r.endBeat-r.startBeat==0?void 0:r.endBeat-r.startBeat};const a=this.loadedChart.getNotedata().filter(s=>s.beat==r.originalNote.beat&&s.col==r.originalNote.col||s.col!=e?!1:s.beat>=r.startBeat&&s.beat<=r.endBeat?!0:Oe(s)&&s.beat+s.hold>=r.startBeat&&s.beat+s.hold<=r.endBeat);r.removedNotes=r.removedNotes.concat(a),a.forEach(s=>this.loadedChart.removeNote(s)),this.setNoteIndex()}endEditing(e){this.holdEditing[e]=void 0}previousNoteType(){const e=this.loadedChart?.gameType.editNoteTypes.length??0;this.editNoteTypeIndex=(this.editNoteTypeIndex-1+e)%e}nextNoteType(){const e=this.loadedChart?.gameType.editNoteTypes.length??0;this.editNoteTypeIndex=(this.editNoteTypeIndex+1+e)%e}getEditingNoteType(){return this.loadedChart?.gameType.editNoteTypes[this.editNoteTypeIndex]??null}setEditingNoteType(e){if(!this.loadedChart)return;const n=(this.loadedChart?.gameType.editNoteTypes).indexOf(e);n!=-1&&(this.editNoteTypeIndex=n)}getMode(){return this.mode}setMode(e){if(!this.loadedChart||!this.chartView)return;if(this.mode==e){(e=="Play Mode"||e=="Record Mode")&&(this.setMode(this.lastMode),this.setNoteIndex(),this.chartAudio.pause());return}(this.mode=="View Mode"||this.mode=="Edit Mode")&&(this.lastMode=this.mode),this.mode=e;const t=this.loadedChart.getNotedata();if(this.mode=="Play Mode"){t.forEach(n=>{n.gameplay={hideNote:!1,hasHit:!1}}),this.holdFlashes=[];for(let n=0;n<this.loadedChart.gameType.numCols;n++)this.chartView.getNotefield().releaseHold(n),this.chartView.getNotefield().releaseRoll(n);for(const n of t)if(n.second<this.time)n.gameplay.hasHit=!0;else break;this.gameStats=new Wg(this),this.widgetManager.startPlay(),this.chartAudio.seek(Math.max(0,this.time)-1),this.loadedChart.gameType.gameLogic.startPlay(this),this.chartAudio.play(),this.chartView.startPlay()}else this.mode=="Record Mode"?(this.chartAudio.seek(Math.max(0,this.time)-1),this.chartAudio.play()):(this.chartView.endPlay(),t.forEach(n=>n.gameplay=void 0))}judgeCol(e){if(!(!this.loadedChart||!this.chartView)){if(this.mode=="Play Mode")this.loadedChart.gameType.gameLogic.keyDown(this,e);else if(this.mode=="Record Mode"){const t=this.loadedChart.getBeatFromSeconds(this.time+b.play.offset),n=b.chart.snap==0?1/48:b.chart.snap,r=Math.round(t/n)*n;this.setNote(e,"key",r)}}}judgeColUp(e){!this.loadedChart||!this.chartView||(this.mode=="Play Mode"?this.loadedChart.gameType.gameLogic.keyUp(this,e):this.mode=="Record Mode"&&this.endEditing(e))}async save(){if(!this.loadedSM||this.smPath.startsWith("https://")||this.smPath.startsWith("http://"))return;const e=this.getSMPath(".sm"),t=this.getSMPath(".ssc");let n=null;!this.loadedSM.usesChartTiming()&&await Ce.getFileHandle(this.getSMPath(".sm"))&&await Ce.writeFile(e,this.loadedSM.serialize("sm")).catch(r=>{const a=r.message;a.includes(gn.GONE[0])||(n=a)}),(this.loadedSM.requiresSSC()||await Ce.getFileHandle(t))&&await Ce.writeFile(t,this.loadedSM.serialize("ssc")).catch(r=>{const a=r.message;a.includes(gn.GONE[0])||(n=a)}),await Ce.writeFile(this.getDataPath(),wd(this.loadedSM)).catch(r=>{const a=r.message;a.includes(gn.GONE[0])||(n=a)}),n==null?(this.loadedSM.usesChartTiming()?ue.create("Saved. No SM file since split timing was used."):ue.create("Saved"),await this.removeAutosaves()):ue.createFormatted("Failed to save file: "+n,"error"),Dt.instance.setLimit()}getDataPath(){if(window.nw){const e=window.nw.require("path"),t=e.parse(this.smPath);return e.resolve(t.dir,"data.sme")}else return ot(this.smPath)+"/data.sme"}getSMPath(e){if(window.nw){const t=window.nw.require("path"),n=t.parse(this.smPath);return t.resolve(n.dir,n.name+e)}else{const t=ot(this.smPath),n=Lt(this.smPath),r=n.includes(".")?n.split(".").slice(0,-1).join("."):n;return t+"/"+r+e}}async removeAutosaves(){await Ce.removeFile(this.getSMPath(".smebak")).catch(()=>{})}async autosave(){if(!this.loadedSM||this.smPath.startsWith("https://")||this.smPath.startsWith("http://"))return;let e=null;await Ce.writeFile(this.getSMPath(".smebak"),this.loadedSM.serialize("smebak")).catch(t=>{const n=t.message;n.includes(gn.GONE[0])||(e=n)}),e==null?ue.create("Autosaved"):ue.createFormatted("Failed to autosave file: "+e,"error")}hasSelection(){return this.hasNoteSelection()||this.hasEventSelection()}hasNoteSelection(){return this.selection.notes.length>0||this.startRegion!==void 0&&this.endRegion!==void 0}hasEventSelection(){return this.eventSelection.timingEvents.length>0}hasRange(){return this.selection.notes.length>1||this.eventSelection.timingEvents.length>1||this.startRegion!==void 0&&this.endRegion!==void 0}clearSelections(){this.selection={notes:[],inProgressNotes:[]},this.eventSelection={timingEvents:[],inProgressTimingEvents:[]}}startDragSelection(){this.selection.inProgressNotes=[]}endDragSelection(){let e=0,t=0;const n=[],r=this.selection.inProgressNotes,a=this.selection.notes,s=(o,l)=>o.beat==l.beat?o.col-l.col:o.beat-l.beat;if(r.length==0||a.length==0){this.selection.notes=r.concat(a),this.selection.inProgressNotes=[];return}for(;;)if(s(r[e],a[t])<0){if(n.push(r[e]),e++,e>=r.length){this.selection.notes=n.concat(a.slice(t));break}}else if(n.push(a[t]),t++,t>=a.length){this.selection.notes=n.concat(r.slice(e));break}this.selection.inProgressNotes=[]}startDragEventSelection(){this.eventSelection.inProgressTimingEvents=[]}endDragEventSelection(){let e=0,t=0;const n=[],r=this.eventSelection.inProgressTimingEvents,a=this.eventSelection.timingEvents,s=(o,l)=>o.beat-l.beat;if(r.length==0||a.length==0){this.eventSelection.timingEvents=r.concat(a),this.eventSelection.inProgressTimingEvents=[];return}for(;;)if(s(r[e],a[t])<0){if(n.push(r[e]),e++,e>=r.length){this.eventSelection.timingEvents=n.concat(a.slice(t));break}}else if(n.push(a[t]),t++,t>=a.length){this.eventSelection.timingEvents=n.concat(r.slice(e));break}this.eventSelection.inProgressTimingEvents=[]}addNoteToDragSelection(e){this.addNoteSelection(this.selection.inProgressNotes,e)}removeNoteFromDragSelection(e){this.removeNoteSelection(this.selection.inProgressNotes,e)}addEventToDragSelection(e){this.addEventSelection(this.eventSelection.inProgressTimingEvents,e)}removeEventFromDragSelection(e){this.removeEventSelection(this.eventSelection.inProgressTimingEvents,e)}addNoteToSelection(e){this.addNoteSelection(this.selection.notes,e)}removeNoteFromSelection(e){this.removeNoteSelection(this.selection.notes,e)}setNoteSelection(e){this.selection.inProgressNotes=[],this.selection.notes=[...e].sort((t,n)=>t.beat==n.beat?t.col-n.col:t.beat-n.beat)}addEventToSelection(e){this.addEventSelection(this.eventSelection.timingEvents,e)}removeEventFromSelection(e){this.removeEventSelection(this.eventSelection.timingEvents,e)}setEventSelection(e){this.eventSelection.inProgressTimingEvents=[],this.eventSelection.timingEvents=e.sort((t,n)=>t.beat-n.beat)}isNoteInSelection(e){return this.getNoteSelectionIndex(this.selection.notes,e)!=-1||this.getNoteSelectionIndex(this.selection.inProgressNotes,e)!=-1}isEventInSelection(e){return this.getEventSelectionIndex(this.eventSelection.timingEvents,e)!=-1||this.getEventSelectionIndex(this.eventSelection.inProgressTimingEvents,e)!=-1}addNoteSelection(e,t){let n=Fn(e,t.beat,r=>r.beat);for(;e[n]&&(e[n].beat<t.beat||e[n].beat==t.beat&&e[n].col<t.col);)n++;e.splice(n,0,t)}removeNoteSelection(e,t){const n=this.getNoteSelectionIndex(e,t);n!=-1&&e.splice(n,1)}getNoteSelectionIndex(e,t){let n=Fn(e,t.beat,r=>r.beat);for(;e[n]&&e[n].beat==t.beat;){if(Uo(e[n],t))return n;n++}return-1}addEventSelection(e,t){let n=Fn(e,t.beat,r=>r.beat);for(;e[n]&&e[n].beat<=t.beat;)n++;e.splice(n,0,t)}removeEventSelection(e,t){const n=this.getEventSelectionIndex(e,t);n!=-1&&e.splice(n,1)}getEventSelectionIndex(e,t){let n=Fn(e,t.beat,r=>r.beat);for(;e[n]&&e[n].beat==t.beat;){if(Uo(e[n],t))return n;n++}return-1}selectRegion(){if(this.loadedChart){if(this.endRegion!==void 0&&(this.startRegion=void 0,this.endRegion=void 0),this.startRegion===void 0){this.clearSelections(),this.startRegion=this.beat;return}this.endRegion=this.beat,this.endRegion<this.startRegion&&(this.endRegion=this.startRegion,this.startRegion=this.beat),ee.emit("regionChanged",this.startRegion,this.endRegion),this.editTimingMode==0?this.setNoteSelection(this.loadedChart.getNotedataInRange(this.startRegion,this.endRegion)):this.setEventSelection(Ir.flatMap(e=>this.loadedChart.timingData.getColumn(e).events).filter(e=>e.beat>=this.startRegion&&e.beat<=this.endRegion))}}modifySelection(e,t=!1){if(!this.loadedChart)return;const n=this.selection.notes,r=structuredClone(this.selection.notes).map(e).sort((l,u)=>l.beat==u.beat?l.col-u.col:l.beat-u.beat);if(r.length==0)return;const a=[];for(const l of r){const u=a.at(-1);u!==void 0&&u.beat==l.beat&&u.col==l.col||a.push(l)}if(a.length==0)return;const{removedNotes:s,truncatedHolds:o}=this.checkConflicts(a,n);if(t){const l=a.map(h=>Ni(h));let u=0;for(const h of l)h>u&&(u=h);const f=new Array(this.loadedChart.gameType.numCols).fill(0).map((h,p)=>({type:"Hold",hold:u-a[0].beat,col:p,beat:a[0].beat})),{removedNotes:c,truncatedHolds:d}=this.checkConflicts(f,n);c.forEach(h=>{s.includes(h)||s.push(h)}),d.forEach(h=>{const p=o.find(m=>m.oldNote==h.oldNote);if(p){const m=Oe(p.newNote)?p.newNote.hold:0,g=Oe(p.newNote)?p.newNote.hold:0,y=Math.min(m,g);y==0?p.newNote={beat:p.newNote.beat,col:p.newNote.col,type:"Tap"}:p.newNote={beat:p.newNote.beat,col:p.newNote.col,type:p.newNote.type,hold:y}}}),s.sort((h,p)=>h.beat==p.beat?h.col-p.col:h.beat-p.beat),o.sort((h,p)=>h.newNote.beat==p.newNote.beat?h.newNote.col-p.newNote.col:h.newNote.beat-p.newNote.beat)}this.app.actionHistory.run({action:()=>{this.loadedChart.removeNotes(n.concat(s),!1),o.forEach(l=>this.loadedChart.modifyNote(l.oldNote,l.newNote,!1)),this.clearSelections(),this.setNoteSelection(this.loadedChart.addNotes(a))},undo:()=>{this.loadedChart.removeNotes(a,!1),o.forEach(l=>this.loadedChart.modifyNote(l.newNote,l.oldNote,!1)),this.loadedChart.addNotes(s,!1),this.clearSelections(),this.setNoteSelection(this.loadedChart.addNotes(n))}})}checkConflicts(e,t=[]){if(e.length==0)return{removedNotes:[],truncatedHolds:[]};const n=this.loadedChart.getNotedata(),r=this.loadedChart.gameType.numCols,a=new Array(r).fill(0).map(f=>[]);for(const f of n)a[f.col].push(f);const s=new Array(r).fill(0).map(f=>[]);for(const f of e)f.col>r||s[f.col].push(f);const o=[],l=[],u=[];for(let f=0;f<r;f++){if(s[f].length==0)continue;let c=a[f].findIndex(d=>s[f][0].beat<=(Oe(d)?d.beat+d.hold:d.beat));for(const d of s[f])for(;a[f][c];){const h=a[f][c],p=Oe(d)?d.beat+d.hold:d.beat;if(!t.includes(h)&&!u.includes(h)&&(d.beat<=h.beat&&p>=h.beat?(u.push(h),o.push(h)):Oe(h)&&h.beat+h.hold>=d.beat&&h.beat<d.beat&&(u.push(h),l.push({oldNote:h,newNote:this.truncateHold(h,d.beat)}))),a[f][c+1]?.beat>p)break;c++}}return o.sort((f,c)=>f.beat==c.beat?f.col-c.col:f.beat-c.beat),l.sort((f,c)=>f.newNote.beat==c.newNote.beat?f.newNote.col-c.newNote.col:f.newNote.beat-c.newNote.beat),{removedNotes:o,truncatedHolds:l}}modifyEventSelection(e){if(!this.loadedChart||!this.loadedSM)return;const t=this.eventSelection.timingEvents.map(n=>[n,e(structuredClone(n))]);this.loadedChart.timingData.modifyColumnEvents(t)}deleteSelection(){if(this.selection.notes.length==0)return;const e=this.selection.notes;this.app.actionHistory.run({action:()=>{this.loadedChart.removeNotes(e),this.clearSelections()},undo:()=>{this.selection.notes=this.loadedChart.addNotes(e)}})}deleteEventSelection(){this.eventSelection.timingEvents.length!=0&&(!this.loadedChart||!this.loadedSM||this.loadedChart.timingData.deleteColumnEvents(this.eventSelection.timingEvents))}paste(e,t=!1){if(this.loadedChart&&(e.startsWith("ArrowVortex:notes:")&&(this.pasteNotes(e,t)||this.pasteNotes(this.virtualClipboard,t)),e.startsWith("ArrowVortex:tempo:")||e.startsWith("SMEditor:tempo:"))){this.pasteTempo(e)||this.pasteTempo(this.virtualClipboard);return}}pasteNotes(e,t=!1){if(!this.loadedChart)return!0;const n=Xm(e);return!n||n.length==0?!1:(this.insertNotes(n.map(r=>(r.beat+=this.beat,r.beat=Math.round(r.beat*48)/48,r)),t),!0)}insertNotes(e,t=!1){e.sort((a,s)=>a.beat==s.beat?a.col-s.col:a.beat-s.beat);const{removedNotes:n,truncatedHolds:r}=this.checkConflicts(e);if(t){const a=e.map(f=>Ni(f));let s=0;for(const f of a)f>s&&(s=f);const o=new Array(this.loadedChart.gameType.numCols).fill(0).map((f,c)=>({type:"Hold",hold:s-e[0].beat,col:c,beat:e[0].beat})),{removedNotes:l,truncatedHolds:u}=this.checkConflicts(o);l.forEach(f=>{n.includes(f)||n.push(f)}),u.forEach(f=>{const c=r.find(d=>d.oldNote==f.oldNote);if(c){const d=Oe(c.newNote)?c.newNote.hold:0,h=Oe(c.newNote)?c.newNote.hold:0,p=Math.min(d,h);p==0?c.newNote={beat:c.newNote.beat,col:c.newNote.col,type:"Tap"}:c.newNote={beat:c.newNote.beat,col:c.newNote.col,type:c.newNote.type,hold:p}}}),n.sort((f,c)=>f.beat==c.beat?f.col-c.col:f.beat-c.beat),r.sort((f,c)=>f.newNote.beat==c.newNote.beat?f.newNote.col-c.newNote.col:f.newNote.beat-c.newNote.beat)}this.app.actionHistory.run({action:()=>{this.loadedChart.removeNotes(n,!1),r.forEach(a=>{this.loadedChart.modifyNote(a.oldNote,a.newNote,!1)}),this.clearSelections(),this.setNoteSelection(this.loadedChart.addNotes(e))},undo:()=>{this.loadedChart.removeNotes(e,!1),r.forEach(a=>{this.loadedChart.modifyNote(a.newNote,a.oldNote,!1)}),this.setNoteSelection(this.loadedChart.addNotes(n)),this.clearSelections()}})}pasteTempo(e){if(!this.loadedChart||!this.loadedSM)return!0;const t=ng(e);return!t||t.length==0?!1:(t.forEach(n=>{n.type=="ATTACKS"?n.second+=this.time:n.beat+=this.beat}),this.loadedChart.timingData.insertColumnEvents(t),!0)}copy(){if(this.selection.notes.length!=0){const e=Math.min(...this.selection.notes.map(r=>r.beat)),t=structuredClone(this.selection.notes).map(r=>(r.beat-=e,r)).sort((r,a)=>r.beat==a.beat?r.col-a.col:r.beat-a.beat),n=Zm(t);return this.virtualClipboard=n,n}else if(this.eventSelection.timingEvents.length!=0){const e=Math.min(...this.eventSelection.timingEvents.map(a=>a.beat)),t=this.loadedChart.timingData.getSecondsFromBeat(e),n=structuredClone(this.eventSelection.timingEvents).map(a=>a.type=="ATTACKS"?(a.second-=t,a):(a.beat-=e,a)).sort((a,s)=>a.type!=s.type?a.type.localeCompare(s.type):a.type=="ATTACKS"?a.second-s.second:a.beat-s.beat),r=eg(n);return this.virtualClipboard=r,r}}}class qg{app;view;clicked=!1;constructor(e,t){if(this.app=e,this.view=t,!pe.menuBar)return;const n=Object.values(Qi).map(r=>this.createElement(r));t.replaceChildren(...n),document.addEventListener("pointerdown",r=>{this.view.contains(r.target)||(this.clicked=!1,n.forEach(a=>{a.classList.remove("selected");const s=a.querySelector(".menubar-dropdown");s&&(s.replaceChildren(),s.classList.remove("selected"))}))})}createElement(e){if(e.type=="separator"){const t=document.createElement("div");return t.classList.add("separator"),t}if(e.type=="selection"||e.type=="checkbox"||e.type=="dropdown"){const t=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");let a;if(e.type=="selection"||e.type=="checkbox"){const s=Ne[e.id]??{label:e.id,combos:[],callback:()=>{}};a=document.createElement("div"),a.innerText=Ae.getKeybindString(e.id),a.classList.add("keybind","unselectable"),r.innerText=s.label;let o=s.disabled;typeof o=="function"&&(o=o(this.app)),o&&t.classList.add("disabled");let l=s.visible;if(l===void 0&&(l=!0),typeof l=="function"&&(l=l(this.app)),!l)return document.createElement("div");t.addEventListener("click",u=>{let f=s.disabled;typeof f=="function"&&(f=f(this.app)),f||s.callback(this.app),u.stopImmediatePropagation();const c=t.closest(".menu-main").querySelector(".menubar-dropdown");c.replaceChildren(),c.classList.remove("selected"),this.clicked=!1})}else a=be.getIcon("CHEVRON",16),a.style.transform="rotate(-90deg)",r.innerText=typeof e.title=="function"?e.title(this.app):e.title;if(n.appendChild(r),n.appendChild(a),t.appendChild(n),t.classList.add("menu-item"),n.classList.add("menu-item-title","menu-hover"),r.classList.add("title","unselectable"),n.onmouseenter=()=>{t.parentElement.querySelectorAll(".menu-item").forEach(s=>{s!=t&&s.classList.remove("selected")})},e.type=="dropdown"){const s=document.createElement("div");t.appendChild(s),s.classList.add("menubar-dropdown"),e.options.map(o=>this.createElement(o)).forEach(o=>s.appendChild(o)),n.onmouseenter=()=>{t.parentElement.querySelectorAll(".menu-item").forEach(o=>{o!=t&&o.classList.remove("selected")}),t.classList.add("selected")}}if(e.type=="checkbox"){let s=e.checked;typeof s=="function"&&(s=s(this.app)),s&&(r.innerText="✓ "+r.innerText)}return t}if(e.type=="menu"){const t=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");return t.appendChild(n),n.innerText=e.title,t.appendChild(r),n.classList.add("title","unselectable"),t.classList.add("menu-item","menu-main"),n.classList.add("menu-hover"),r.classList.add("menubar-dropdown","unselectable"),t.onclick=()=>{if(this.clicked=!0,r.childElementCount>0){r.replaceChildren(),this.clicked=!1,t.classList.add("selected");return}if(r.replaceChildren(...e.options.map(a=>this.createElement(a))),e.title=="Help"){const a=this.createSearchBar();r.insertBefore(a,r.firstElementChild)}t.classList.add("selected")},n.onmouseenter=()=>{if(this.clicked){if(r.replaceChildren(...e.options.map(a=>this.createElement(a))),e.title=="Help"){const a=this.createSearchBar();r.insertBefore(a,r.firstElementChild)}t.parentElement.querySelectorAll(".menu-item").forEach(a=>{a!=t&&a.classList.remove("selected")}),t.classList.add("selected")}},t.onmouseleave=()=>{this.clicked||(r.replaceChildren(),t.classList.remove("selected"))},t}return document.createElement("div")}createSearchBar(){const e=document.createElement("div");e.classList.add("menu-search");const t=document.createElement("input");t.type="text",t.placeholder="Search the menus...";const n=document.createElement("div");return n.classList.add("menu-search-dropdown"),t.oninput=()=>{const r=t.value.trim().toLowerCase();if(r==""){n.replaceChildren();return}let s=Object.values(Qi).map(o=>this.traverseOptions(o,[o.title])).flat().filter(o=>{if(!o.path.some(u=>u.toLowerCase().includes(r)))return!1;const l=Ne[o.option.id];return!(l.visible!==void 0&&!this.evaluateDynamicProperty(l.visible))});if(s.length>15&&(s=s.filter(o=>{const l=Ne[o.option.id];return!this.evaluateDynamicProperty(l.disabled)})),s=s.slice(0,15),n.replaceChildren(...s.map(o=>{const l=this.createElement(o.option),u=l.querySelector(".title");return u&&(u.innerText=o.path.join(" > ")),l})),s.length==0){const o=document.createElement("div"),l=document.createElement("div"),u=document.createElement("div");o.classList.add("disabled"),u.innerText="No results found",l.appendChild(u),o.appendChild(l),o.classList.add("menu-item"),l.classList.add("menu-item-title","menu-hover"),u.classList.add("title","unselectable"),n.appendChild(o)}},t.autofocus=!0,t.onclick=r=>{r.stopImmediatePropagation()},e.appendChild(t),e.appendChild(n),e}traverseOptions(e,t=[]){let n=[];for(const r of e.options)switch(r.type){case"dropdown":case"menu":n=n.concat(this.traverseOptions(r,[...t,this.evaluateDynamicProperty(r.title)]));break;case"selection":case"checkbox":n.push({path:[...t,Ne[r.id].label],option:r});break}return n}evaluateDynamicProperty(e){return typeof e=="function"?e(this.app):e}}class jg{view;windows=[];app;constructor(e,t){this.app=e,this.view=t}unfocusAll(){for(const e of this.view.querySelectorAll(".focused"))e.classList.remove("focused")}getFocusedWindow(){for(const e of this.windows)if(e.windowElement.classList.contains("focused"))return e;return null}isBlocked(){return!this.windows.every(e=>!e.options.blocking)}openWindow(e){if(e.options.win_id){const t=this.getWindowById(e.options.win_id);if(t){t.focus();return}}e.addToManager(this),this.windows.push(e)}removeWindow(e){this.windows.splice(this.windows.indexOf(e),1)}getWindowById(e){for(const t of this.windows)if(t.options.win_id==e)return t}}const Bs=960;class $g{VERSION="1.4.2";options=b;events=ee;themes=Fe;renderer;stage;view;chartManager;windowManager;menubarManager;actionHistory;capturing=!1;STAGE_HEIGHT=Bs;STAGE_WIDTH=Bs;lastWidth=-1;lastHeight=-1;constructor(){if(Ze.setDefaultProps({duration:[200,100],theme:"sm"}),b.loadOptions(),vd(),Ae.load(this),window.nw){const e=nw.Window.get();b.app.fullscreen?e.enterFullscreen():e.resizeTo(b.app.width,b.app.height)}if(setInterval(()=>{this.capturing||b.saveOptions()},1e4),b.general.smoothAnimations&&document.body.classList.add("animated"),document.body.parentElement.style.fontSize=`${b.general.uiScale*100}%`,this.registerFonts(),this.view=document.getElementById("pixi"),document.oncontextmenu=e=>{e.preventDefault(),this.chartManager.loadedChart&&e.target==this.view&&Qs.open(this,e)},this.view.onmousedown=()=>{Qs.close()},this.stage=new he,this.stage.sortableChildren=!0,this.renderer=new xd({backgroundColor:1579292,antialias:b.performance.antialiasing,width:this.view.clientWidth,height:this.view.clientHeight,resolution:b.performance.resolution,autoDensity:!0,view:this.view,powerPreference:"low-power"}),xt.shared.maxFPS=0,xt.shared.add(()=>{const e=performance.now();this.chartManager.widgetManager.update(),this.chartManager.loadedSM&&this.chartManager.loadedChart&&this.chartManager.chartView&&this.chartManager.chartView.update(),tn.instance?.addDrawUpdateTimeValue(performance.now()-e);const t=performance.now();this.renderer.render(this.stage),tn.instance?.addFrameTimeValue(performance.now()-t),performance.memory?.usedJSHeapSize&&tn.instance?.addMemoryTimeValue(performance.memory.usedJSHeapSize),Dm()},qc.HIGH),dt.init(this.renderer),this.chartManager=new Gg(this),this.menubarManager=new qg(this,document.getElementById("menubar")),this.windowManager=new jg(this,document.getElementById("windows")),this.actionHistory=new Dt(this),this.registerListeners(),!pe.hidePoweredByText&&Ed()){const e=document.getElementById("embed");e.appendChild(document.createTextNode("Powered by "));const t=document.createElement("a");if(t.href="https://tillvit.github.io/smeditor/",t.innerText="SMEditor",t.target="_blank",e.appendChild(t),pe.url!=null){e.appendChild(document.createTextNode(" | Open this chart in a "));const n=document.createElement("a"),r=new URL(location.origin+"/smeditor/app/");n.innerText="new tab",n.target="_blank",r.searchParams.append("url",pe.url),pe.chartType!==null&&r.searchParams.append("chartType",pe.chartType),pe.chartIndex!==null&&r.searchParams.append("chartIndex",pe.chartIndex+""),n.href=r.toString(),e.appendChild(n)}}Ce.initFileSystem().then(()=>{if(pe.url){this.chartManager.loadSM(pe.url).then(()=>{const e=this.chartManager.loadedSM;if(!e)return;let t;if(pe.chartType!=null&&(t=e.getChartsByGameType(pe.chartType),t===void 0)){ue.createFormatted(`Couldn't find chart with type ${pe.chartType}`,"warn");return}if(t===void 0){const r=Object.keys(e.charts);if(r.length==0||(t=e.getChartsByGameType(r[0]),t.length==0))return}let n;if(pe.chartIndex!=null&&(n=t.at(pe.chartIndex),n===void 0)){ue.createFormatted(`Couldn't find chart with index ${pe.chartIndex}`,"warn");return}n===void 0&&(n=t.at(-1),!n)||this.chartManager.loadChart(n)});return}if(this.windowManager.openWindow(new Lo(this)),window.nw){const e=nw.Window.get();nw.App.on("open",t=>{if(!t||t?.length===0){nw.Window.open(window.location.href);return}let n="";for(let r of t)if(r.startsWith("file://")&&(r=r.substring(7)),Tt(r)==".ssc"){n=r;break}else n==""&&Tt(r)==".sm"&&(n=r);n!=""&&(this.chartManager.loadSM(n),this.windowManager.getWindowById("select_sm_initial")?.closeWindow())}),window.addEventListener("keydown",t=>{t.key=="r"&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),e.reload()),t.code=="KeyW"&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),e.close()),process.versions["nw-flavor"]=="sdk"&&t.code=="KeyI"&&t.metaKey&&t.altKey&&(t.preventDefault(),e.showDevTools())}),e.on("enter-fullscreen",()=>{b.app.fullscreen=e.isFullscreen}),e.on("resize",(t,n)=>{e.isFullscreen||(b.app.width=t,b.app.height=n)}),e.on("restore",()=>{b.app.fullscreen=e.isFullscreen}),this.checkAppVersion()}this.checkCoreVersion()}),window.onbeforeunload=e=>{if(Dt.instance.isDirty()&&b.general.warnBeforeExit)return e.preventDefault(),e.returnValue="Are you sure you want to exit?"},window.onpagehide=()=>{this.capturing||b.saveOptions()},Fe.loadTheme(b.general.theme),xt.shared.start()}registerFonts(){ua.from("Main",{fontFamily:"Assistant",fontSize:20,fill:"white"},{chars:[["a","z"],["A","Z"],"!@#$%^&*()~{}[]:.-?=,_|","0123456789/"," "],resolution:window.devicePixelRatio}),ua.from("Mono",{fontFamily:"monospace",fontSize:20,fill:"white"},{chars:[["a","z"],["A","Z"],"!@#$%^&*()~{}[]:.-?=,_|","0123456789/"," "],resolution:window.devicePixelRatio}),ua.from("Fancy",{fontFamily:"Assistant",fontSize:40,fontWeight:"700",fill:["#dddddd","#ffffff"],fillGradientType:Cd.LINEAR_VERTICAL,stroke:11184810,strokeThickness:3},{chars:[["a","z"],["A","Z"],"!@#$%^&*()~{}[]:.-?=,_|","0123456789/"," "],resolution:window.devicePixelRatio})}registerListeners(){this.view.addEventListener("mousedown",()=>{this.windowManager.unfocusAll()});const e=this.renderer.events.onPointerMove;document.removeEventListener("pointermove",e,!0);const t=n=>{n.target==this.view&&e.call(this.renderer.events,n)};document.addEventListener("pointermove",t,!0),ee.on("themeChanged",()=>{this.renderer.background.color=new B(Fe.getCurrentTheme()["editor-bg"]).toNumber()}),ee.on("userOptionUpdated",n=>{n=="general.uiScale"&&this.updateSize()}),window.addEventListener("keydown",function(n){n.code=="Enter"&&n.target instanceof HTMLButtonElement&&n.preventDefault()}),window.addEventListener("dragstart",function(n){n.target instanceof HTMLImageElement&&n.preventDefault()}),setInterval(()=>{if(this.capturing)return;const n=window.innerWidth,r=this.getCanvasHeight();(this.lastHeight!=r||this.lastWidth!=n)&&(this.lastHeight=r,this.lastWidth=n,this.onResize(n,r),ee.emit("resize"))},100),window.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="copy"}),window.addEventListener("drop",n=>{if(window.nw){n.stopPropagation(),n.preventDefault();let r="";for(const a of n.dataTransfer.files)if(a.path)if(Tt(a.path)==".ssc"){r=a.path;break}else r==""&&Tt(a.path)==".sm"&&(r=a.path);r!=""&&(this.chartManager.loadSM(r),this.windowManager.getWindowById("select_sm_initial")?.closeWindow())}else Ce.handleDropEvent(n).then(r=>{const a=new oa(this,{title:"Select an sm/ssc file...",accepted_file_types:[".sm",".ssc"],disableClose:!0,callback:s=>{this.chartManager.loadSM(s),this.windowManager.getWindowById("select_sm_initial")?.closeWindow()},onload:()=>{a.getAcceptableFile(r??"").then(s=>a.selectPath(s))}});this.windowManager.openWindow(a)})})}onResize(e,t){this.renderer.screen.width=e,this.renderer.screen.height=t,this.view.width=e*this.renderer.resolution,this.view.height=t*this.renderer.resolution,this.view.style.width=`${e}px`,this.view.style.height=`${t}px`,this.STAGE_HEIGHT=Bs/b.general.uiScale;const n=t/this.STAGE_HEIGHT;this.stage.scale.set(n),this.stage.position.set(e/2,t/2),this.STAGE_WIDTH=e/n}updateSize(){const e=window.innerWidth,t=this.getCanvasHeight();this.lastHeight=t,this.lastWidth=e,this.onResize(e,t),ee.emit("resize")}getCanvasHeight(){return window.innerHeight-(document.getElementById("menubar")?.clientHeight??0)-(document.getElementById("playback-options")?.clientHeight??0)}checkAppVersion(){if(!window.nw)return;const e=nw.require("nw.gui"),t={stable:3,beta:2,alpha:1,nightly:0};let n="win";process.platform=="darwin"?n=nw.require("os").arch()=="arm64"?"mac-arm":"mac-x64":process.platform=="linux"&&(n="linux"),fetch("/smeditor/assets/app/versions.json").then(r=>r.json()).then(r=>{r=r.sort((s,o)=>t[s.type]!=t[o.type]?t[o.type]-t[s.type]:o.date-s.date);const a=r[0];Il.lt(e.App.manifest.version,a.version)&&localStorage.getItem("downloadedVersion")!==a.version&&td.open(a.version,a.downloads[n])})}checkCoreVersion(){const e=eh({});navigator.serviceWorker.addEventListener("controllerchange",()=>{id.open(e),console.log("Found new version")});const t=localStorage.getItem("coreVersion");t!==null&&Il.lt(t,this.VERSION)&&this.windowManager.openWindow(new Uu(this)),localStorage.setItem("coreVersion",this.VERSION)}}document.querySelector("body").innerHTML=`<div id="popups"></div>
          <div id="view-wrapper">
            <div id="menubar"></div>
            <div id="waterfall"><div id="waterfall-container"></div></div>
            <canvas id="pixi"></canvas>
          </div>
          <div id="context-menu"></div>
          <div id="blocker" style="display: none"></div>
          <div id="windows"></div>
          <div id="embed"></div>
        `;nh.load({custom:{families:["Assistant"]},active:Oc,inactive:Oc,classes:!1});function Oc(){const i=document.createElement("canvas");i.getContext("webgl")||i.getContext("experimental-webgl")?(window.app=new $g,window.GameTypeRegistry=wt,window.NoteskinRegistry=nt):document.querySelector("body").innerHTML=`<div class='browser-unsupported'>
      <div class='browser-unsupported-item'>
      <h1>WebGL is not enabled</h1>
      <div>Please visit your browser settings and enable WebGL.</div>
      </div>
    </div>`}export{Jg as A,lt as B,rn as F,od as H,qe as _,ar as a,mt as b,gn as e,rh as i,Qg as l,go as r,Zg as s};
